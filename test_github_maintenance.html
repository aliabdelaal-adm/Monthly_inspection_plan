<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار وضع الصيانة المتزامن</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .test-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        
        .status-box {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-box.active {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .status-box.inactive {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .status-title {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        .status-details {
            color: #666;
            line-height: 1.6;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        button {
            flex: 1;
            min-width: 200px;
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-enable {
            background: #ffc107;
            color: #000;
        }
        
        .btn-disable {
            background: #28a745;
            color: white;
        }
        
        .btn-check {
            background: #007bff;
            color: white;
        }
        
        .btn-toggle-dev {
            background: #6c757d;
            color: white;
        }
        
        .log-box {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .dev-status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .dev-status.is-dev {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }
        
        .dev-status.not-dev {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }
        
        .note {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🛡️ اختبار وضع الصيانة المتزامن</h1>
        <p class="subtitle">اختبار التزامن عبر GitHub لجميع الأجهزة والمتصفحات</p>
        
        <div class="dev-status not-dev" id="devStatus">
            الحالة: مستخدم عادي 👤
        </div>
        
        <div class="status-box" id="statusBox">
            <div class="status-title">حالة وضع الصيانة</div>
            <div class="status-details" id="statusDetails">جاري التحميل...</div>
        </div>
        
        <div class="button-group">
            <button class="btn-toggle-dev" onclick="toggleDevMode()">👨‍💻 تبديل وضع المطور</button>
            <button class="btn-check" onclick="checkStatus()">🔄 تحديث الحالة</button>
        </div>
        
        <div class="button-group">
            <button class="btn-enable" onclick="enableMaintenance()">🔒 تفعيل وضع الصيانة</button>
            <button class="btn-disable" onclick="disableMaintenance()">✅ إلغاء وضع الصيانة</button>
        </div>
        
        <div class="note">
            <strong>📝 ملاحظات الاختبار:</strong>
            <ul style="margin-top: 10px; padding-right: 20px; line-height: 1.8;">
                <li>افتح هذه الصفحة في متصفحات/أجهزة مختلفة</li>
                <li>قم بتبديل وضع المطور في أحد المتصفحات</li>
                <li>قم بتفعيل وضع الصيانة من المتصفح الأول</li>
                <li>انتظر 10 ثوان أو قم بتحديث الحالة في المتصفح الآخر</li>
                <li>يجب أن تظهر حالة الصيانة في جميع المتصفحات</li>
            </ul>
        </div>
        
        <h3 style="margin-top: 30px; margin-bottom: 10px;">📊 سجل الأحداث:</h3>
        <div class="log-box" id="logBox">جاري التهيئة...</div>
    </div>

    <script>
        let isDev = false;
        let checkInterval = null;
        
        function log(message) {
            const logBox = document.getElementById('logBox');
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            logBox.textContent += `[${timestamp}] ${message}\n`;
            logBox.scrollTop = logBox.scrollHeight;
            console.log(message);
        }
        
        function updateDevStatus() {
            const statusDiv = document.getElementById('devStatus');
            if (isDev) {
                statusDiv.textContent = 'الحالة: مطور 👨‍💻 (يمكن التحكم في وضع الصيانة)';
                statusDiv.classList.remove('not-dev');
                statusDiv.classList.add('is-dev');
            } else {
                statusDiv.textContent = 'الحالة: مستخدم عادي 👤 (لا يمكن التحكم في وضع الصيانة)';
                statusDiv.classList.remove('is-dev');
                statusDiv.classList.add('not-dev');
            }
        }
        
        function toggleDevMode() {
            isDev = !isDev;
            updateDevStatus();
            log(isDev ? '✅ تم تفعيل وضع المطور' : '⚠️ تم تعطيل وضع المطور');
        }
        
        async function loadMaintenanceStatus() {
            try {
                log('📥 جاري تحميل حالة الصيانة من GitHub...');
                const response = await fetch(`https://raw.githubusercontent.com/aliabdelaal-adm/Monthly_inspection_plan/main/maintenance-status.json?t=${Date.now()}`);
                
                if (!response.ok) {
                    log(`⚠️ لم يتم العثور على ملف حالة الصيانة (${response.status})`);
                    return null;
                }
                
                const status = await response.json();
                log('✅ تم تحميل حالة الصيانة بنجاح');
                return status;
            } catch (error) {
                log(`❌ خطأ في تحميل حالة الصيانة: ${error.message}`);
                return null;
            }
        }
        
        async function saveMaintenanceStatus(isEnabled, messages = []) {
            if (!isDev) {
                log('❌ يجب تفعيل وضع المطور أولاً');
                alert('❌ يجب تفعيل وضع المطور أولاً');
                return false;
            }
            
            const repo = "aliabdelaal-adm/Monthly_inspection_plan";
            const token = "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";
            
            try {
                log(`💾 جاري حفظ حالة الصيانة إلى GitHub (${isEnabled ? 'مفعّل' : 'معطّل'})...`);
                
                const status = {
                    isMaintenanceMode: isEnabled,
                    lastUpdated: new Date().toISOString(),
                    updatedBy: "المطور (اختبار)",
                    messages: messages
                };
                
                // Get current file SHA
                const getResponse = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });
                
                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                    log('✅ تم العثور على ملف موجود');
                } else {
                    log('📝 سيتم إنشاء ملف جديد');
                }
                
                // Create or update the file
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(status, null, 2))));
                const body = {
                    message: isEnabled ? 'تفعيل وضع الصيانة للجميع (اختبار)' : 'إلغاء وضع الصيانة للجميع (اختبار)',
                    content: content
                };
                
                if (sha) {
                    body.sha = sha;
                }
                
                const updateResponse = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    log(`❌ فشل الحفظ: ${updateResponse.status} - ${errorData.message || 'خطأ غير معروف'}`);
                    return false;
                }
                
                log('✅ تم حفظ حالة الصيانة بنجاح على GitHub');
                log('⏳ انتظر 10-30 ثانية حتى يتم تحديث الملف على GitHub CDN');
                return true;
            } catch (error) {
                log(`❌ خطأ في حفظ حالة الصيانة: ${error.message}`);
                return false;
            }
        }
        
        async function checkStatus() {
            const status = await loadMaintenanceStatus();
            const statusBox = document.getElementById('statusBox');
            const statusDetails = document.getElementById('statusDetails');
            
            if (status) {
                if (status.isMaintenanceMode) {
                    statusBox.classList.remove('inactive');
                    statusBox.classList.add('active');
                    let details = `🔒 <strong>وضع الصيانة مفعّل</strong><br><br>`;
                    details += `⏰ آخر تحديث: ${new Date(status.lastUpdated).toLocaleString('ar-EG')}<br>`;
                    details += `👤 تم التحديث بواسطة: ${status.updatedBy}<br><br>`;
                    if (status.messages && status.messages.length > 0) {
                        details += `📝 <strong>الرسائل:</strong><br>`;
                        details += `<ul style="margin: 5px 0; padding-right: 20px;">`;
                        status.messages.forEach(msg => {
                            details += `<li>${msg}</li>`;
                        });
                        details += `</ul>`;
                    }
                    statusDetails.innerHTML = details;
                    log('⚠️ وضع الصيانة مفعّل حالياً');
                } else {
                    statusBox.classList.remove('active');
                    statusBox.classList.add('inactive');
                    let details = `✅ <strong>وضع الصيانة غير مفعّل</strong><br><br>`;
                    details += `⏰ آخر تحديث: ${new Date(status.lastUpdated).toLocaleString('ar-EG')}<br>`;
                    details += `👤 تم التحديث بواسطة: ${status.updatedBy}`;
                    statusDetails.innerHTML = details;
                    log('✅ وضع الصيانة غير مفعّل حالياً');
                }
            } else {
                statusBox.classList.remove('active', 'inactive');
                statusDetails.innerHTML = '❓ لم يتم العثور على بيانات وضع الصيانة<br>قد يكون الملف غير موجود بعد';
                log('❓ لم يتم العثور على بيانات وضع الصيانة');
            }
        }
        
        async function enableMaintenance() {
            const messages = [
                'جاري تحديث النظام',
                'يقوم المطور بإجراء تعديلات',
                'شكراً على الانتظار'
            ];
            
            const success = await saveMaintenanceStatus(true, messages);
            if (success) {
                alert('✅ تم تفعيل وضع الصيانة للجميع\n\nانتظر 10-30 ثانية ثم قم بتحديث الحالة في المتصفحات الأخرى');
                await checkStatus();
            } else {
                alert('❌ فشل تفعيل وضع الصيانة\nتحقق من السجل للمزيد من التفاصيل');
            }
        }
        
        async function disableMaintenance() {
            const success = await saveMaintenanceStatus(false, []);
            if (success) {
                alert('✅ تم إلغاء وضع الصيانة للجميع\n\nانتظر 10-30 ثانية ثم قم بتحديث الحالة في المتصفحات الأخرى');
                await checkStatus();
            } else {
                alert('❌ فشل إلغاء وضع الصيانة\nتحقق من السجل للمزيد من التفاصيل');
            }
        }
        
        // Initialize
        log('🚀 تم تهيئة صفحة الاختبار');
        log('📝 يمكنك الآن اختبار وضع الصيانة المتزامن');
        updateDevStatus();
        checkStatus();
        
        // Auto-check every 10 seconds
        checkInterval = setInterval(() => {
            log('🔄 فحص تلقائي للحالة...');
            checkStatus();
        }, 10000);
        
        log('⏰ تم تفعيل الفحص التلقائي كل 10 ثوان');
    </script>
</body>
</html>
