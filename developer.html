<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لوحة إدارة خطة التفتيش الشهرية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- مكتبات التصدير -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {font-family:'Cairo',Tahoma,Arial,sans-serif;background:#f7f8fa;margin:0;padding:0;}
        .container {max-width:1100px;margin:40px auto 24px auto;background:#fff;border-radius:18px;box-shadow:0 4px 32px #0002;padding:32px 24px 24px 24px;direction:rtl;}
        .main-title {background:#234093;color:#fff;border-radius:10px;padding:18px 0;text-align:center;font-size:2em;margin-bottom:24px;letter-spacing:1px;}
        .top-bar {display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:18px;gap:1.5rem;}
        .top-bar label,.top-bar .user-type-label {font-size:1.1em;margin-left:8px;}
        .top-bar select,.top-bar button {font-size:1em;border-radius:7px;border:1px solid #ccc;padding:8px 14px;margin-right:8px;}
        .top-bar button {background:#234093;color:#fff;border:none;margin:0 4px;cursor:pointer;transition:0.2s;}
        .top-bar button:hover {background:#1a2c67;}
        .api-token-bar {margin-bottom:18px;text-align:left;direction:ltr;padding:8px 12px;background:#e6eeff;border-radius:10px;display:flex;align-items:center;gap:10px;font-size:1em;}
        .api-token-bar label {font-size:1.06em;color:#234093;margin-left:8px;}
        .api-token-bar input[type="password"],.api-token-bar input[type="text"] {border:1px solid #bbb;border-radius:5px;padding:6px 10px;font-size:1em;width:240px;}
        .api-token-bar button {background:#234093;color:#fff;border:none;border-radius:6px;padding:6px 18px;font-size:1em;cursor:pointer;}
        .api-token-bar .api-token-saved {color:#388e3c;margin-right:8px;}
        .api-token-bar .api-token-warning {color:#d32f2f;margin-right:8px;}
        .admin-panel {margin:32px 0;display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:28px;}
        .admin-section {background:#f3f6fe;border:1px solid #e0e7f7;border-radius:14px;padding:24px 18px 18px 18px;box-shadow:0px 1.5px 6px #23409311;margin-bottom:24px;}
        .admin-section h3 {color:#1a2c67;margin:0 0 18px 0;font-size:1.13em;}
        .add-row-form {display:flex;gap:8px;margin-bottom:18px;align-items:center;}
        .add-row-form input[type="text"],.add-row-form select,.add-row-form input[type="date"] {flex:1;font-size:1em;padding:6px 10px;border-radius:6px;border:1px solid #bbb;}
        .add-row-form button {background:#198754;color:#fff;border:none;padding:8px 22px;border-radius:7px;font-size:1em;cursor:pointer;}
        .table-wrapper {overflow:auto;}
        table {width:100%;border-collapse:collapse;margin-bottom:15px;}
        th,td {padding:9px 12px;text-align:right;}
        th {background:#234093;color:#fff;font-weight:600;}
        tr:nth-child(even) {background:#f7f8fa;}
        tr:hover {background:#e6eeff;}
        .action-btn {background:#234093;color:#fff;border:none;border-radius:5px;padding:5px 16px;font-size:0.97em;cursor:pointer;margin-left:5px;}
        .action-btn.edit {background:#0288d1;}
        .action-btn.delete {background:#b71c1c;}
        .action-btn.export {background:#388e3c;}
        .action-btn.import {background:#ffa000;}
        .action-btn:disabled {opacity:0.6;cursor:not-allowed;}
        .warning {color:#b71c1c;font-size:1.02em;margin-bottom:5px;}
        .success {color:#198754;font-size:1.01em;}
        .info {color:#1976d2;font-size:1em;}
        .flex-between {display:flex;align-items:center;justify-content:space-between;}
        @media (max-width: 700px) {
            .container {padding:14px 5px;}
            .admin-panel {grid-template-columns:1fr;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-title">لوحة إدارة خطة التفتيش الشهرية</div>
        
        <!-- شريط توكن GitHub للمطور -->
        <div class="api-token-bar" id="tokenBar">
            <label for="githubTokenInput">GitHub Token:</label>
            <input id="githubTokenInput" type="password" placeholder="ghp_xxxxxx..." />
            <button onclick="setGithubToken()">حفظ التوكن</button>
            <span id="tokenResultMsg"></span>
            <div style="color:#b71c1c;font-size:0.98em;margin-top:3px;">
                <b>تحذير:</b> التوكن سرّي وخاص بك فقط.<br>
                لا تشارك التوكن مع أي شخص أو تضعه في أي مكان عام.<br>
                التوكن يُخزن في متصفحك فقط ويمكنك مسحه من الإعدادات في أي وقت.
            </div>
        </div>

        <!-- لوحة الأدوات الرئيسية -->
        <div class="admin-panel">
            <!-- إدارة المفتشين -->
            <div class="admin-section">
                <h3>إدارة المفتشين</h3>
                <form class="add-row-form" id="inspectorForm">
                    <input type="text" id="inspectorName" placeholder="اسم المفتش" required>
                    <button type="submit">إضافة</button>
                </form>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr><th>اسم المفتش</th><th>الإجراءات</th></tr>
                        </thead>
                        <tbody id="inspectorTable"></tbody>
                    </table>
                </div>
            </div>
            <!-- إدارة المناطق -->
            <div class="admin-section">
                <h3>إدارة المناطق</h3>
                <form class="add-row-form" id="areaForm">
                    <input type="text" id="areaName" placeholder="اسم المنطقة" required>
                    <button type="submit">إضافة</button>
                </form>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr><th>اسم المنطقة</th><th>الإجراءات</th></tr>
                        </thead>
                        <tbody id="areaTable"></tbody>
                    </table>
                </div>
            </div>
            <!-- إدارة المحلات -->
            <div class="admin-section">
                <h3>إدارة المحلات</h3>
                <form class="add-row-form" id="shopForm">
                    <input type="text" id="shopName" placeholder="اسم المحل" required>
                    <button type="submit">إضافة</button>
                </form>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr><th>اسم المحل</th><th>الإجراءات</th></tr>
                        </thead>
                        <tbody id="shopTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- إدارة جدول خطة التفتيش -->
        <div class="admin-section">
            <h3>جدول خطة التفتيش</h3>
            <form class="add-row-form" id="planForm">
                <select id="planInspector" required>
                    <option value="">اختر المفتش</option>
                </select>
                <input type="date" id="planDate" required>
                <select id="planShift" required>
                    <option value="">وقت المناوبة</option>
                    <option value="صباحية">صباحية</option>
                    <option value="مسائية">مسائية</option>
                </select>
                <select id="planArea" required>
                    <option value="">اختر المنطقة</option>
                </select>
                <input type="text" id="planShops" placeholder="المحلات (افصل بفاصلة ,)" required>
                <button type="submit">إضافة / تحديث</button>
                <input type="hidden" id="planEditingIndex" value="">
            </form>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>اسم المفتش</th>
                            <th>اليوم</th>
                            <th>وقت المناوبة</th>
                            <th>المنطقة</th>
                            <th>المحلات</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="planTable"></tbody>
                </table>
            </div>
        </div>

        <!-- أدوات التصدير والاستيراد -->
        <div class="flex-between" style="margin-top:20px;">
            <div>
                <button class="action-btn export" onclick="exportToExcel()">تصدير Excel</button>
                <button class="action-btn export" onclick="exportToPDF()">تصدير PDF</button>
                <label style="margin-right:15px;">
                    <input type="file" id="importFile" style="display:none;" onchange="importFromFile(this)">
                    <button class="action-btn import" onclick="document.getElementById('importFile').click();return false;">استيراد ملف</button>
                </label>
            </div>
            <button class="action-btn delete" onclick="resetAllData()" style="margin-left:12px;">إعادة ضبط جميع البيانات</button>
        </div>

        <div style="margin-top:22px;color:#888;font-size:1.05em;text-align:center;">
            <span id="lastUpdate"></span>
        </div>
    </div>
<script>
/* ================== إعدادات الريبو ================== */
const GITHUB_OWNER = "aliabdelaal-adm";
const GITHUB_REPO = "Monthly_inspection_plan";
const PLAN_JSON_FILE = "inspection_plan.json";

/* ================== تخزين التوكن ================== */
let GITHUB_TOKEN = localStorage.getItem('github_token') || "";
document.getElementById('githubTokenInput').value = GITHUB_TOKEN;

function setGithubToken() {
    let val = document.getElementById('githubTokenInput').value.trim();
    if (val.startsWith("ghp_") && val.length > 20) {
        GITHUB_TOKEN = val;
        localStorage.setItem('github_token', GITHUB_TOKEN);
        document.getElementById('tokenResultMsg').textContent = "✔ تم حفظ التوكن (لن تحتاج إدخاله إلا إذا مسحت الكاش)";
        document.getElementById('tokenResultMsg').className = "api-token-saved";
    } else {
        document.getElementById('tokenResultMsg').textContent = "توكن غير صحيح!";
        document.getElementById('tokenResultMsg').className = "api-token-warning";
    }
}

/* ================== تحميل وحفظ البيانات ================== */
let inspectionData = { inspectors:[], areas:[], shops:[], plan:[] };

function loadLocalData() {
    let d = localStorage.getItem('inspectionData');
    if(d) try { inspectionData = JSON.parse(d); } catch(e){}
}

function saveLocalData() {
    localStorage.setItem('inspectionData', JSON.stringify(inspectionData));
}

async function fetchPlanFromGitHub() {
    try {
        const url = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${PLAN_JSON_FILE}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("فشل تحميل بيانات الخطة من GitHub");
        const data = await res.json();
        inspectionData = data;
        saveLocalData();
        renderAll();
        setLastUpdateDate();
    } catch (e) {
        alert("تعذر تحميل خطة التفتيش من GitHub: " + e.message);
        loadLocalData();
        renderAll();
    }
}

async function pushPlanToGitHub() {
    if (!GITHUB_TOKEN || !GITHUB_TOKEN.startsWith("ghp_")) {
        alert("يرجى إدخال GitHub Token أولاً!");
        return false;
    }
    try {
        const apiUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${PLAN_JSON_FILE}`;
        let getRes = await fetch(apiUrl, {headers:{"Accept":"application/vnd.github.v3+json"}});
        if (!getRes.ok) throw new Error("فشل جلب sha الملف من GitHub");
        let meta = await getRes.json();
        let sha = meta.sha;
        let content = btoa(unescape(encodeURIComponent(JSON.stringify(inspectionData, null, 2))));
        let body = {
            message: "تحديث خطة التفتيش من خلال لوحة المطور",
            content: content,
            sha: sha
        };
        let res = await fetch(apiUrl, {
            method: "PUT",
            headers: {
                "Authorization": "token " + GITHUB_TOKEN,
                "Accept":"application/vnd.github.v3+json"
            },
            body: JSON.stringify(body)
        });
        if (!res.ok) {
            let err = await res.json();
            throw new Error(err.message || "فشل رفع التغييرات!");
        }
        alert("تم رفع التغييرات بنجاح إلى GitHub!");
        setLastUpdateDate();
        return true;
    } catch (e) {
        alert("فشل رفع التغييرات:\n" + e.message);
        return false;
    }
}

function setLastUpdateDate() {
    const now = new Date();
    const dateString = now.getFullYear() + "-" + 
        ("0"+(now.getMonth()+1)).slice(-2) + "-" + 
        ("0"+now.getDate()).slice(-2) + " " +
        ("0"+now.getHours()).slice(-2) + ":" +
        ("0"+now.getMinutes()).slice(-2);
    document.getElementById("lastUpdate").textContent = "آخر تعديل للبيانات: " + dateString;
}

/* ================== واجهات إدارة المفتشين ================== */
function renderInspectors() {
    let tbody = document.getElementById('inspectorTable');
    tbody.innerHTML = '';
    inspectionData.inspectors.forEach((inspector,i)=>{
        let tr = document.createElement('tr');
        tr.innerHTML = `<td>${inspector}</td>
            <td>
                <button class="action-btn edit" onclick="editInspector(${i})">تعديل</button>
                <button class="action-btn delete" onclick="deleteInspector(${i})">حذف</button>
            </td>`;
        tbody.appendChild(tr);
    });
    // تحديث قائمة المفتشين في خطة التفتيش
    let sel = document.getElementById('planInspector');
    sel.innerHTML = '<option value="">اختر المفتش</option>';
    inspectionData.inspectors.forEach(i=>{
        let opt = document.createElement('option');
        opt.value = i; opt.textContent = i;
        sel.appendChild(opt);
    });
}
document.getElementById('inspectorForm').onsubmit = function(e){
    e.preventDefault();
    let val = document.getElementById('inspectorName').value.trim();
    if(val && !inspectionData.inspectors.includes(val)){
        inspectionData.inspectors.push(val);
        saveLocalData(); renderInspectors(); pushPlanToGitHub();
        this.reset();
    }
};
window.editInspector = function(idx){
    let name = inspectionData.inspectors[idx];
    let newName = prompt("تعديل اسم المفتش:", name);
    if(newName && newName.trim() && !inspectionData.inspectors.includes(newName.trim())){
        inspectionData.inspectors[idx] = newName.trim();
        saveLocalData(); renderInspectors(); pushPlanToGitHub();
    }
};
window.deleteInspector = function(idx){
    if(confirm("تأكيد حذف المفتش؟")){
        inspectionData.inspectors.splice(idx,1);
        saveLocalData(); renderInspectors(); pushPlanToGitHub();
    }
};

/* ================== واجهات إدارة المناطق ================== */
function renderAreas() {
    let tbody = document.getElementById('areaTable');
    tbody.innerHTML = '';
    inspectionData.areas.forEach((area,i)=>{
        let tr = document.createElement('tr');
        tr.innerHTML = `<td>${area}</td>
            <td>
                <button class="action-btn edit" onclick="editArea(${i})">تعديل</button>
                <button class="action-btn delete" onclick="deleteArea(${i})">حذف</button>
            </td>`;
        tbody.appendChild(tr);
    });
    // تحديث قائمة المناطق في خطة التفتيش
    let sel = document.getElementById('planArea');
    sel.innerHTML = '<option value="">اختر المنطقة</option>';
    inspectionData.areas.forEach(i=>{
        let opt = document.createElement('option');
        opt.value = i; opt.textContent = i;
        sel.appendChild(opt);
    });
}
document.getElementById('areaForm').onsubmit = function(e){
    e.preventDefault();
    let val = document.getElementById('areaName').value.trim();
    if(val && !inspectionData.areas.includes(val)){
        inspectionData.areas.push(val);
        saveLocalData(); renderAreas(); pushPlanToGitHub();
        this.reset();
    }
};
window.editArea = function(idx){
    let name = inspectionData.areas[idx];
    let newName = prompt("تعديل اسم المنطقة:", name);
    if(newName && newName.trim() && !inspectionData.areas.includes(newName.trim())){
        inspectionData.areas[idx] = newName.trim();
        saveLocalData(); renderAreas(); pushPlanToGitHub();
    }
};
window.deleteArea = function(idx){
    if(confirm("تأكيد حذف المنطقة؟")){
        inspectionData.areas.splice(idx,1);
        saveLocalData(); renderAreas(); pushPlanToGitHub();
    }
};

/* ================== واجهات إدارة المحلات ================== */
function renderShops() {
    let tbody = document.getElementById('shopTable');
    tbody.innerHTML = '';
    inspectionData.shops.forEach((shop,i)=>{
        let tr = document.createElement('tr');
        tr.innerHTML = `<td>${shop}</td>
            <td>
                <button class="action-btn edit" onclick="editShop(${i})">تعديل</button>
                <button class="action-btn delete" onclick="deleteShop(${i})">حذف</button>
            </td>`;
        tbody.appendChild(tr);
    });
}
document.getElementById('shopForm').onsubmit = function(e){
    e.preventDefault();
    let val = document.getElementById('shopName').value.trim();
    if(val && !inspectionData.shops.includes(val)){
        inspectionData.shops.push(val);
        saveLocalData(); renderShops(); pushPlanToGitHub();
        this.reset();
    }
};
window.editShop = function(idx){
    let name = inspectionData.shops[idx];
    let newName = prompt("تعديل اسم المحل:", name);
    if(newName && newName.trim() && !inspectionData.shops.includes(newName.trim())){
        inspectionData.shops[idx] = newName.trim();
        saveLocalData(); renderShops(); pushPlanToGitHub();
    }
};
window.deleteShop = function(idx){
    if(confirm("تأكيد حذف المحل؟")){
        inspectionData.shops.splice(idx,1);
        saveLocalData(); renderShops(); pushPlanToGitHub();
    }
};

/* ================== إدارة خطة التفتيش ================== */
function renderPlanTable() {
    let tbody = document.getElementById('planTable');
    tbody.innerHTML = '';
    inspectionData.plan.forEach((row,i)=>{
        let shops = (Array.isArray(row.shops) ? row.shops.join(", ") : row.shops);
        let tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.inspector}</td>
            <td>${row.day}</td>
            <td>${row.shift}</td>
            <td>${row.area}</td>
            <td>${shops}</td>
            <td>
                <button class="action-btn edit" onclick="editPlan(${i})">تعديل</button>
                <button class="action-btn delete" onclick="deletePlan(${i})">حذف</button>
            </td>`;
        tbody.appendChild(tr);
    });
}
document.getElementById('planForm').onsubmit = function(e){
    e.preventDefault();
    let idx = document.getElementById('planEditingIndex').value;
    let planObj = {
        inspector: document.getElementById('planInspector').value,
        day: document.getElementById('planDate').value,
        shift: document.getElementById('planShift').value,
        area: document.getElementById('planArea').value,
        shops: document.getElementById('planShops').value.split(',').map(s=>s.trim()).filter(Boolean)
    };
    if(idx===""){
        inspectionData.plan.push(planObj);
    } else {
        inspectionData.plan[+idx] = planObj;
    }
    saveLocalData(); renderPlanTable(); pushPlanToGitHub();
    this.reset();
    document.getElementById('planEditingIndex').value = "";
};
window.editPlan = function(idx){
    let row = inspectionData.plan[idx];
    document.getElementById('planInspector').value = row.inspector;
    document.getElementById('planDate').value = row.day;
    document.getElementById('planShift').value = row.shift;
    document.getElementById('planArea').value = row.area;
    document.getElementById('planShops').value = (Array.isArray(row.shops) ? row.shops.join(", ") : row.shops);
    document.getElementById('planEditingIndex').value = idx;
};
window.deletePlan = function(idx){
    if(confirm("تأكيد حذف صف الخطة؟")){
        inspectionData.plan.splice(idx,1);
        saveLocalData(); renderPlanTable(); pushPlanToGitHub();
    }
};

/* ================== تصدير واستيراد ================== */
window.exportToExcel = function(){
    let ws = XLSX.utils.json_to_sheet(inspectionData.plan.map(row=>({
        "اسم المفتش": row.inspector,
        "اليوم": row.day,
        "وقت المناوبة": row.shift,
        "المنطقة": row.area,
        "المحلات": Array.isArray(row.shops) ? row.shops.join(", ") : row.shops
    })));
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "خطة التفتيش");
    XLSX.writeFile(wb, "inspection_plan.xlsx");
};
window.exportToPDF = function(){
    html2canvas(document.querySelector('.admin-section:last-child .table-wrapper')).then(canvas => {
        const pdf = new window.jspdf.jsPDF({
            orientation: "landscape",
            unit: "pt",
            format: "a4"
        });
        pdf.addImage(canvas, 'PNG', 10, 10, 800, 0);
        pdf.save("inspection_plan.pdf");
    });
};
window.importFromFile = function(input){
    let file = input.files[0];
    if(!file) return;
    let reader = new FileReader();
    reader.onload = function(e){
        try {
            let d = JSON.parse(e.target.result);
            if(d.inspectors && d.areas && d.shops && d.plan) {
                inspectionData = d;
                saveLocalData(); renderAll(); pushPlanToGitHub();
            } else {
                alert("صيغة الملف غير صحيحة!");
            }
        } catch(e) {
            alert("فشل قراءة الملف!");
        }
    };
    reader.readAsText(file);
};

/* ================== إعادة ضبط البيانات ================== */
window.resetAllData = function(){
    if(confirm("هل أنت متأكد أنك تريد حذف جميع البيانات؟")){
        inspectionData = { inspectors:[], areas:[], shops:[], plan:[] };
        saveLocalData(); renderAll(); pushPlanToGitHub();
    }
};

/* ================== عرض جميع الجداول ================== */
function renderAll(){
    renderInspectors();
    renderAreas();
    renderShops();
    renderPlanTable();
}

/* ================== تحميل البيانات عند بداية الصفحة ================== */
window.addEventListener('DOMContentLoaded', fetchPlanFromGitHub);
</script>
</body>
</html>
