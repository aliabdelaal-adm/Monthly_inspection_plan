<!DOCTYPE html>
<!-- Version 2.0.0 - ABSOLUTE ZERO-CACHE STRATEGY for instant updates -->
<!-- Last Updated: 2025-10-19 - Complete cache prevention for Safari, Chrome, Firefox (mobile/desktop) -->
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>أداة التخطيط الذكية للتفتيش الشهري</title>
    
    <!-- ABSOLUTE CACHE PREVENTION - Works on ALL browsers including Safari, Chrome and Firefox -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, max-stale=0, post-check=0, pre-check=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Safari-specific cache prevention -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Chrome mobile-specific cache prevention -->
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Additional cache control for aggressive browsers -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="cleartype" content="on">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .features {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
        }
        
        .features-title {
            color: #2d3561;
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
        }
        
        .feature-item {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            border-right: 4px solid #667eea;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .feature-item:hover {
            transform: translateX(-3px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        
        .feature-bullet {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .feature-content {
            flex: 1;
        }
        
        .feature-content h4 {
            color: #2d3561;
            font-size: 0.95em;
            margin: 0 0 3px 0;
            font-weight: 600;
        }
        
        .feature-content p {
            color: #666;
            font-size: 0.8em;
            margin: 0;
            line-height: 1.3;
        }
        
        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.8em;
            color: #2d3561;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #2d3561;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102,126,234,0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(17,153,142,0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(17,153,142,0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(250,112,154,0.3);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(250,112,154,0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 600;
            display: none;
        }
        
        .status-message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .status-message.warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
        }
        
        .shops-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .shop-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .shop-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.2);
        }
        
        .shop-card.selected {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .shop-card.very-high-priority {
            border-left: 5px solid #8b0000;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
        }
        
        .shop-card.high-priority {
            border-left: 5px solid #dc3545;
        }
        
        .shop-card.medium-priority {
            border-left: 5px solid #ffc107;
        }
        
        .shop-card.low-priority {
            border-left: 5px solid #28a745;
        }
        
        .shop-card .priority-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .shop-card .priority-badge.very-high {
            background: #8b0000;
            color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .shop-card .priority-badge.high {
            background: #dc3545;
            color: white;
        }
        
        .shop-card .priority-badge.medium {
            background: #ffc107;
            color: #212529;
        }
        
        .shop-card .priority-badge.low {
            background: #28a745;
            color: white;
        }
        
        .shop-card .shop-name {
            font-weight: 600;
            color: #2d3561;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .shop-card .shop-info {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .shop-card .last-inspection {
            font-size: 0.85em;
            color: #999;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }
        
        .selected-shops {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .selected-shops h3 {
            color: #1565c0;
            margin-bottom: 15px;
        }
        
        .selected-shops-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .selected-shop-tag {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .selected-shop-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .selected-shop-tag .remove:hover {
            color: #ffcccc;
        }
        
        .filter-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        
        .stat-box .value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-box .label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .inspection-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }
        
        .inspection-preview h3 {
            color: #2d3561;
            margin-bottom: 15px;
        }
        
        .inspection-preview .preview-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .inspection-preview .preview-item strong {
            color: #667eea;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* New styles for enhanced features */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 12px 24px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            background: #f0f0ff;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .inspections-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .inspections-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .inspections-table th,
        .inspections-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .inspections-table tbody tr:hover {
            background: #f5f5f5;
        }
        
        .action-icon {
            cursor: pointer;
            font-size: 1.3em;
            margin: 0 5px;
            transition: transform 0.2s;
        }
        
        .action-icon:hover {
            transform: scale(1.2);
        }
        
        .edit-icon { color: #ffc107; }
        .delete-icon { color: #dc3545; }
        .copy-icon { color: #17a2b8; }
        
        /* Professional Action Buttons for Shops and Areas Management */
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 14px;
            border: 2px solid transparent;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .action-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .action-btn span:first-child {
            font-size: 1.2em;
        }
        
        .action-btn-text {
            font-size: 0.85em;
        }
        
        .action-btn-view {
            border-color: #3498db;
            color: #3498db;
        }
        
        .action-btn-view:hover {
            background: #3498db;
            color: white;
        }
        
        .action-btn-edit {
            border-color: #f39c12;
            color: #f39c12;
        }
        
        .action-btn-edit:hover {
            background: #f39c12;
            color: white;
        }
        
        .action-btn-delete {
            border-color: #e74c3c;
            color: #e74c3c;
        }
        
        .action-btn-delete:hover {
            background: #e74c3c;
            color: white;
        }
        
        .action-btn-copy {
            border-color: #1abc9c;
            color: #1abc9c;
        }
        
        .action-btn-copy:hover {
            background: #1abc9c;
            color: white;
        }
        
        .action-btn-map {
            border-color: #27ae60;
            color: #27ae60;
        }
        
        .action-btn-map:hover {
            background: #27ae60;
            color: white;
        }
        
        /* Responsive for smaller screens */
        @media (max-width: 768px) {
            .action-btn-text {
                display: none;
            }
            
            .action-btn {
                padding: 8px 10px;
            }
        }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        
        .inspector-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-card .stat-label {
            font-size: 1em;
            color: #2d3561;
            margin-top: 5px;
        }
        
        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .calendar-day {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            min-height: 100px;
            position: relative;
        }
        
        .calendar-day .day-number {
            font-weight: 700;
            color: #2d3561;
            margin-bottom: 10px;
        }
        
        .calendar-day .inspection-badge {
            background: #667eea;
            color: white;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            margin-bottom: 5px;
            display: block;
        }
        
        .calendar-day.has-inspection {
            border-color: #667eea;
            background: #f0f0ff;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        /* Smart shop list modal should be below shop edit modal */
        #smartShopListModal {
            z-index: 1500;
        }
        
        /* Shop edit/add modal should appear on top of other modals */
        #shopModal {
            z-index: 2000;
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #2d3561;
        }
        
        .modal-close {
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
        }
        
        .search-box .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(231,76,60,0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(231,76,60,0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(52,152,219,0.3);
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52,152,219,0.4);
        }
        
        /* Bell Notification Control Styles */
        .bell-control-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .bell-control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5);
        }
        
        .bell-control-btn:active {
            transform: translateY(-1px);
        }
        
        /* Hand Gesture Control Styles */
        .gesture-control-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .gesture-control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.5);
        }
        
        .gesture-control-btn:active {
            transform: translateY(-1px);
        }
        
        .gesture-control-btn.active {
            background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
            }
            50% {
                box-shadow: 0 5px 30px rgba(56, 239, 125, 0.6);
            }
        }
        
        /* Background Music Volume Control Styles */
        .volume-control-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .volume-control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.5);
        }
        
        .volume-control-btn:active {
            transform: translateY(-1px);
        }
        
        .volume-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .volume-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .volume-modal-content {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            margin: auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            color: white;
            position: relative;
        }
        
        .volume-close {
            color: white;
            float: left;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .volume-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .volume-slider-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .volume-slider {
            width: 100%;
            height: 12px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .volume-slider::-moz-range-thumb {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: none;
        }
        
        .volume-display-big {
            font-size: 3em;
            font-weight: 900;
            text-align: center;
            margin: 20px 0;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .volume-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .volume-preset-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.4);
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .volume-preset-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
        }
        
        .volume-preset-btn:active {
            transform: translateY(0);
        }
        
        .gesture-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .gesture-modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 50px auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            color: white;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .gesture-close {
            color: white;
            float: left;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .gesture-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .gesture-video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .gesture-video {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1);
        }
        
        .gesture-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }
        
        .gesture-status {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .gesture-status h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .gesture-detected {
            font-size: 2em;
            font-weight: bold;
            color: #38ef7d;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(56, 239, 125, 0.5);
        }
        
        .gesture-guide {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .gesture-guide h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .gesture-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .gesture-icon {
            font-size: 2em;
            min-width: 50px;
            text-align: center;
        }
        
        .gesture-description {
            flex: 1;
        }
        
        .gesture-description strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .gesture-description span {
            opacity: 0.9;
            font-size: 0.95em;
        }
        
        .bell-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        
        .bell-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .bell-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }
        
        .bell-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        
        .bell-modal-header h2 {
            color: #2d3561;
            font-size: 2em;
            margin: 0;
        }
        
        .bell-modal-close {
            background: #e74c3c;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bell-modal-close:hover {
            transform: rotate(90deg);
            background: #c0392b;
        }
        
        .notification-add-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #dee2e6;
        }
        
        .notification-add-section h3 {
            color: #2d3561;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        .notification-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.3s ease;
        }
        
        .notification-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .notification-author-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ced4da;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            margin-top: 10px;
        }
        
        .notification-author-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .notification-add-btn {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s ease;
        }
        
        .notification-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .notifications-list {
            margin-top: 25px;
        }
        
        .notification-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .notification-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .notification-text {
            color: #2d3561;
            font-size: 1.05em;
            line-height: 1.6;
            margin-bottom: 12px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }
        
        .notification-text:hover {
            background: #f8f9fa;
        }
        
        .notification-edit-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            resize: vertical;
            min-height: 80px;
            display: none;
        }
        
        .notification-meta {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 12px;
        }
        
        .notification-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .notification-action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .notification-save-btn {
            background: #28a745;
            color: white;
            display: none;
        }
        
        .notification-save-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .notification-cancel-btn {
            background: #6c757d;
            color: white;
            display: none;
        }
        
        .notification-cancel-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .notification-delete-btn {
            background: #dc3545;
            color: white;
        }
        
        .notification-delete-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .notification-move-btn {
            background: #17a2b8;
            color: white;
        }
        
        .notification-move-btn:hover {
            background: #138496;
            transform: translateY(-2px);
        }
        
        .notification-priority-btn {
            background: #ffc107;
            color: #212529;
        }
        
        .notification-priority-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .notification-item.priority-high {
            border-left: 5px solid #dc3545;
            background: linear-gradient(to right, #fff5f5 0%, white 10%);
        }
        
        .notification-item.priority-medium {
            border-left: 5px solid #ffc107;
            background: linear-gradient(to right, #fffbf0 0%, white 10%);
        }
        
        .notification-item.priority-low {
            border-left: 5px solid #28a745;
            background: linear-gradient(to right, #f0fff4 0%, white 10%);
        }
        
        .notification-settings {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border: 1px solid #dee2e6;
        }
        
        .notification-settings label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .notification-settings input,
        .notification-settings select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            margin-bottom: 10px;
        }
        
        .notification-settings input:focus,
        .notification-settings select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .bell-control-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #dee2e6;
        }
        
        .bell-control-panel h3 {
            color: #2d3561;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        .bell-control-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .bell-control-item {
            flex: 1;
            min-width: 200px;
        }
        
        .bell-control-item label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .bell-control-item input,
        .bell-control-item select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
        }
        
        .bell-bulk-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .bell-bulk-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95em;
        }
        
        .bell-bulk-btn:hover {
            transform: translateY(-2px);
        }
        
        .bell-save-all-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }
        
        .bell-save-all-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }
        
        .bell-status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .bell-status-message.show {
            display: block;
        }
        
        .bell-status-message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .bell-status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Google Maps Modal Styles */
        .map-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            overflow-y: auto;
        }
        
        .map-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .map-modal-content {
            background: white;
            border-radius: 20px;
            padding: 0;
            width: 95%;
            max-width: 1400px;
            max-height: 95vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(50px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .map-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .map-modal-header h2 {
            margin: 0;
            font-size: 1.8em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .map-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .map-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .map-modal-body {
            padding: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .map-controls-panel {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 3px solid #667eea;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .map-control-group {
            display: flex;
            flex-direction: column;
        }
        
        .map-control-label {
            font-weight: 600;
            color: #2d3561;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .map-container {
            flex: 1;
            min-height: 500px;
            position: relative;
            background: #e5e5e5;
        }
        
        #googleMap {
            width: 100%;
            height: 100%;
            min-height: 500px;
        }
        
        .map-stats-bar {
            background: #2d3561;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .map-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .map-stat-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #38ef7d;
        }
        
        .map-stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .map-footer {
            background: #f8f9fa;
            padding: 20px;
            border-top: 3px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .map-actions {
            display: flex;
            gap: 10px;
            flex: 1;
        }
        
        .btn-map-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1em;
        }
        
        .btn-map-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-map-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 12px 24px;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1em;
        }
        
        .btn-map-secondary:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-add-from-map {
            background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 210, 255, 0.3);
            position: relative;
        }
        
        .btn-add-from-map:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 210, 255, 0.4);
        }
        
        .btn-add-from-map.loading {
            opacity: 0.7;
            cursor: wait;
            animation: pulse-loading 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse-loading {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        .btn-add-from-map .icon {
            font-size: 1.3em;
        }
        
        .maps-status-indicator {
            display: inline-block;
            margin-right: 10px;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 700;
            background: #e8f5e9;
            color: #2e7d32;
            border: 2px solid #4caf50;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .maps-status-indicator.loading {
            background: #fff3e0;
            color: #e65100;
            border-color: #ff9800;
            animation: pulse-status 1.5s ease-in-out infinite;
        }
        
        .maps-status-indicator.error {
            background: #ffebee;
            color: #c62828;
            border-color: #f44336;
            cursor: pointer;
            animation: shake 0.5s ease-in-out;
        }
        
        .maps-status-indicator.error:hover {
            background: #f44336;
            color: white;
            transform: scale(1.05);
        }
        
        @keyframes pulse-status {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .map-helper-tools {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 20px;
            border: 2px solid #e0e0e0;
        }
        
        .map-helper-tools h4 {
            margin: 0 0 10px 0;
            color: #2d3561;
            font-size: 1.1em;
        }
        
        .map-tools-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .map-tool-btn {
            background: #f8f9fa;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .map-tool-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .map-tool-btn.active {
            background: #667eea;
            color: white;
        }
        
        .map-accuracy-legend {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 20px;
            border: 2px solid #e0e0e0;
        }
        
        .map-accuracy-legend h4 {
            margin: 0 0 10px 0;
            color: #2d3561;
            font-size: 1.1em;
        }
        
        .accuracy-legend-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .accuracy-legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .accuracy-indicator-high,
        .accuracy-indicator-medium,
        .accuracy-indicator-low {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid;
            flex-shrink: 0;
        }
        
        .accuracy-indicator-high {
            background: white;
            border-color: #00ff00;
        }
        
        .accuracy-indicator-medium {
            background: white;
            border-color: #ffaa00;
        }
        
        .accuracy-indicator-low {
            background: white;
            border-color: #ff0000;
        }
        
        .accuracy-label {
            flex: 1;
            color: #2d3561;
            font-weight: 500;
        }
        
        .accuracy-count {
            background: #667eea;
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .selected-shops-on-map {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 0 20px 10px 20px;
            border: 2px solid #28a745;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .selected-shops-on-map h4 {
            margin: 0 0 10px 0;
            color: #28a745;
            font-size: 1.1em;
        }
        
        .selected-shop-tag {
            display: inline-block;
            background: #d4edda;
            color: #155724;
            padding: 5px 12px;
            margin: 5px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            border: 1px solid #c3e6cb;
        }
        
        .selected-shop-tag .remove {
            margin-right: 5px;
            cursor: pointer;
            color: #dc3545;
            font-weight: bold;
        }
        
        .selected-shop-tag .remove:hover {
            color: #c82333;
        }
        
        /* Responsive design for map modal */
        @media (max-width: 768px) {
            .map-modal-content {
                width: 98%;
                max-height: 98vh;
            }
            
            .map-controls-panel {
                grid-template-columns: 1fr;
            }
            
            .map-footer {
                flex-direction: column;
            }
            
            .map-actions {
                width: 100%;
                flex-direction: column;
            }
            
            #googleMap {
                min-height: 400px;
            }
            
            /* Mobile responsive styles for group inspection table */
            #smartGroupInspectionTableContainer table {
                font-size: 0.85em;
            }
            
            #smartGroupInspectionTableContainer th,
            #smartGroupInspectionTableContainer td {
                padding: 8px !important;
            }
            
            #smartGroupInspectionTableContainer th {
                font-size: 0.9em;
            }
            
            /* Stack inspector badges vertically on mobile */
            #smartGroupInspectionTableContainer td > div {
                flex-direction: column;
                align-items: flex-start;
            }
            
            /* Reduce button sizes on mobile */
            #smartGroupInspectionTableContainer button {
                padding: 4px 8px !important;
                font-size: 0.85em !important;
            }
            
            /* Mobile responsive styles for inspections-table - ensure single-line text */
            .inspections-table th,
            .inspections-table td {
                padding: 8px 4px;
                font-size: 0.7em;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .inspections-table {
                font-size: 0.85em;
            }
        }
    </style>
    
    <!-- SheetJS library for Excel import/export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- jsPDF library for PDF export with Arabic support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.1/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Google Maps API Configuration and Loader -->
    <!-- تكوين ومحمل Google Maps API -->
    <!-- 
        IMPORTANT: To use Google Maps, you need to configure your API key in google-maps-config.js
        هام: لاستخدام خرائط جوجل، تحتاج إلى تكوين مفتاح API الخاص بك في google-maps-config.js
        
        Steps to set up:
        1. Get API key from: https://console.cloud.google.com/
        2. Enable Maps JavaScript API, Places API, and Geocoding API
        3. Set up billing (required by Google)
        4. Update the apiKey in google-maps-config.js
        5. Restrict the API key to your domain
        
        خطوات الإعداد:
        1. احصل على مفتاح API من: https://console.cloud.google.com/
        2. فعّل Maps JavaScript API و Places API و Geocoding API
        3. أعد إعداد الفوترة (مطلوب من جوجل)
        4. حدّث apiKey في google-maps-config.js
        5. قيّد مفتاح API لنطاقك
    -->
    <!-- Load local API key configuration first (if exists, gitignored) -->
    <script src="google-maps-config.local.js" onerror="console.log('⚠️ No local API key config found. Using default config.')"></script>
    <script src="google-maps-config.js"></script>
    <script src="google-maps-loader.js"></script>
    <!-- Ensure Google Maps components are initialized -->
    <script src="google-maps-init-checker.js"></script>
    
    <!-- Preconnect to Google Maps for faster loading -->
    <link rel="preconnect" href="https://maps.googleapis.com">
    <link rel="preconnect" href="https://maps.gstatic.com" crossorigin>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 أداة التخطيط الذكية للتفتيش الشهري</h1>
            <p>نظام ذكي ومرن لتحديث خطة التفتيش مباشرة وفوراً مع فلترة المحلات ذات الأولوية</p>
        </div>
        
        <div class="features">
            <h3 class="features-title">المميزات والخدمات المتوفرة</h3>
            <div class="features-grid">
                <div class="feature-item">
                    <div class="feature-bullet"></div>
                    <div class="feature-content">
                        <h4>تحديث فوري</h4>
                        <p>التحديثات تظهر مباشرة دون رفع ملفات</p>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-bullet"></div>
                    <div class="feature-content">
                        <h4>الأولوية الذكية</h4>
                        <p>المحلات ذات الأولوية العالية تظهر أولاً</p>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-bullet"></div>
                    <div class="feature-content">
                        <h4>منع التكرار</h4>
                        <p>تجنب المحلات المكررة في نفس اليوم</p>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-bullet"></div>
                    <div class="feature-content">
                        <h4>فترة الانتظار</h4>
                        <p>منع التكرار في نفس اليوم فقط (مناسب للتخطيط الأسبوعي)</p>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-bullet"></div>
                    <div class="feature-content">
                        <h4>تحرير التفتيشات</h4>
                        <p>إمكانية تعديل التفتيشات السابقة</p>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-bullet"></div>
                    <div class="feature-content">
                        <h4>عرض التفتيشات</h4>
                        <p>مشاهدة جميع التفتيشات لكل مفتش</p>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-bullet"></div>
                    <div class="feature-content">
                        <h4>حذف تلقائي</h4>
                        <p>حذف التفتيشات المكررة تلقائياً</p>
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-bullet"></div>
                    <div class="feature-content">
                        <h4>إحصائيات شاملة</h4>
                        <p>تقارير تفصيلية لكل مفتش</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Links & Smart Actions Toolbar -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
            <h3 style="color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <span>⚡</span>
                <span>الإجراءات السريعة والذكية</span>
            </h3>
            
            <!-- Navigation Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <a href="admin-dashboard.html" style="text-decoration: none;">
                    <button class="btn btn-warning" style="background: white; color: #667eea;">
                        <span>📊</span>
                        <span>لوحة التحكم الرئيسية</span>
                    </button>
                </a>
                <a href="index.html" style="text-decoration: none;">
                    <button class="btn btn-info" style="background: white; color: #3498db;">
                        <span>🏠</span>
                        <span>الصفحة الرئيسية</span>
                    </button>
                </a>
                <button class="btn btn-success" onclick="openQuickAddInspection()" style="background: white; color: #11998e;">
                    <span>⚡</span>
                    <span>إضافة تفتيش سريع</span>
                </button>
            </div>
            
            <!-- Data Management Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="importFromExcel()" style="background: white; color: #667eea;">
                    <span>📥</span>
                    <span>استيراد من Excel</span>
                </button>
                <button class="btn btn-primary" onclick="exportAllData()" style="background: white; color: #667eea;">
                    <span>📤</span>
                    <span>تصدير جميع البيانات</span>
                </button>
                <button class="btn btn-primary" onclick="syncWithGitHub()" style="background: white; color: #667eea;">
                    <span>🔄</span>
                    <span>مزامنة مع GitHub</span>
                </button>
                <button class="btn btn-danger" onclick="createBackup()" style="background: white; color: #e74c3c;">
                    <span>💾</span>
                    <span>نسخة احتياطية</span>
                </button>
            </div>
            
            <!-- Analysis & Reports Buttons -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="generateFullReport()" style="background: white; color: #11998e;">
                    <span>📈</span>
                    <span>تقرير شامل</span>
                </button>
                <button class="btn btn-warning" onclick="checkDataQuality()" style="background: white; color: #fa709a;">
                    <span>🔍</span>
                    <span>فحص جودة البيانات</span>
                </button>
                <button class="btn btn-info" onclick="viewSystemLogs()" style="background: white; color: #3498db;">
                    <span>📋</span>
                    <span>سجل النظام</span>
                </button>
                <button class="btn btn-success" onclick="bulkOperations()" style="background: white; color: #11998e;">
                    <span>⚙️</span>
                    <span>عمليات جماعية</span>
                </button>
                <button class="btn btn-danger" onclick="openDuplicateShopsManager()" style="background: white; color: #e74c3c;">
                    <span>🔄</span>
                    <span>المحلات المكررة والمتشابهة</span>
                </button>
                <button class="btn btn-primary" onclick="viewGroupInspectionReports()" style="background: white; color: #ff9800;">
                    <span>👥</span>
                    <span>تقارير التفتيش الجماعي</span>
                </button>
                <button class="btn btn-success" onclick="uploadGroupInspectionReport()" style="background: white; color: #28a745;">
                    <span>📤</span>
                    <span>رفع تقرير التفتيش الجماعي</span>
                </button>
                <button class="btn btn-info" onclick="loadAndEditGroupInspectionReport()" style="background: white; color: #2196f3;">
                    <span>📝</span>
                    <span>تحميل وتحرير تقرير التفتيش الجماعي</span>
                </button>
                <button class="btn btn-warning" onclick="switchTab('fileManager', event)" style="background: white; color: #ff6b6b; font-weight: bold; border: 2px solid #ff6b6b;">
                    <span>📂</span>
                    <span>إدارة ملفات التقارير الجماعية (للمطور فقط)</span>
                </button>
                <button class="btn btn-primary" onclick="switchTab('shelterInspection', event)" style="background: white; color: #9c27b0;">
                    <span>🏘️</span>
                    <span>تخطيط تفتيش الملاجئ</span>
                </button>
            </div>
            
            <!-- Bell Notifications Control Button -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(255, 255, 255, 0.3);">
                <button class="bell-control-btn" onclick="openBellNotificationsControl()">
                    <span style="font-size: 1.3em;">🔔</span>
                    <span>التحكم في إشعارات الجرس</span>
                    <span style="font-size: 0.85em; opacity: 0.9;">(إدارة إشعارات الموقع)</span>
                </button>
            </div>
            
            <!-- Hand Gesture Control Button -->
            <div style="margin-top: 15px;">
                <button class="gesture-control-btn" id="gestureControlBtn" onclick="toggleGestureControl()">
                    <span style="font-size: 1.3em;">✋</span>
                    <span>التحكم بحركة اليد</span>
                    <span style="font-size: 0.85em; opacity: 0.9;">(تحكم ذكي بدون لمس)</span>
                </button>
            </div>
            
            <!-- Background Music Volume Control Button -->
            <div style="margin-top: 15px;">
                <button class="volume-control-btn" id="volumeControlBtn" onclick="openVolumeControl()">
                    <span style="font-size: 1.3em;">🔊</span>
                    <span>التحكم في صوت الموسيقى الخلفية</span>
                    <span style="font-size: 0.85em; opacity: 0.9;">(ضبط شدة الصوت)</span>
                </button>
            </div>
        </div>
        
        <!-- Login Section -->
        <div class="section" id="loginSection">
            <h2 class="section-title">🔐 تسجيل الدخول كمطور</h2>
            <div class="form-group">
                <label class="form-label">GitHub Token (للحفظ المباشر)</label>
                <input type="password" id="githubToken" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <small style="color: #666; display: block; margin-top: 5px;">
                    احصل على التوكن من: GitHub Settings → Developer Settings → Personal Access Tokens
                </small>
                <small id="oldTokenWarning" style="color: #ff6b6b; display: none; margin-top: 5px; font-weight: bold;">
                    ⚠️ يوجد توكن قديم محفوظ. إذا قمت بإنشاء توكن جديد، يرجى تحديث الحقل أعلاه ثم الضغط على "تسجيل الدخول"
                </small>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="loginDeveloper()" style="flex: 1; min-width: 150px;">
                    <span>✓</span>
                    <span>تسجيل الدخول</span>
                </button>
                <button class="btn" onclick="clearOldToken()" style="flex: 1; min-width: 150px; background: #ff6b6b; color: white;">
                    <span>🗑️</span>
                    <span>مسح التوكن القديم</span>
                </button>
            </div>
            <div class="status-message" id="loginStatus"></div>
        </div>
        
        <!-- Main Interface with Tabs -->
        <div id="mainInterface" style="display: none;">
            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('add', event)">
                    <span>➕</span> إضافة تفتيش جديد
                </button>
                <button class="tab-button" onclick="switchTab('view', event)">
                    <span>👁️</span> عرض التفتيشات
                </button>
                <button class="tab-button" onclick="switchTab('stats', event)">
                    <span>📊</span> إحصائيات المفتشين
                </button>
                <button class="tab-button" onclick="switchTab('calendar', event)">
                    <span>📅</span> التقويم الشهري
                </button>
                <button class="tab-button" onclick="switchTab('shops', event)">
                    <span>🏪</span> إدارة المحلات
                </button>
                <button class="tab-button" onclick="switchTab('areas', event)">
                    <span>🗺️</span> إدارة المناطق
                </button>
                <button class="tab-button" onclick="switchTab('maintenance', event)">
                    <span>🔧</span> التحكم الذكي في رسالة التحديث
                </button>
                <button class="tab-button" onclick="switchTab('groupInspection', event)">
                    <span>👥</span> التفتيش الجماعي
                </button>
                <button class="tab-button" onclick="switchTab('shelterInspection', event)">
                    <span>🏘️</span> تفتيش الملاجئ
                </button>
                <button class="tab-button" onclick="switchTab('fileManager', event)">
                    <span>📂</span> إدارة ملفات التقارير
                </button>
            </div>
            
            <!-- Tab Content: Add Inspection -->
            <div id="addTab" class="tab-content active">
                <div class="section">
            <h2 class="section-title">📝 إضافة تفتيش جديد</h2>
            
            <div class="form-group">
                <label class="form-label">المفتش</label>
                <select id="inspectorSelect" class="form-control" onchange="updateAvailableShops()">
                    <option value="">اختر المفتش...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">التاريخ</label>
                <input type="date" id="inspectionDate" class="form-control" onchange="updateAvailableShops()">
            </div>
            
            <div class="form-group">
                <label class="form-label">المناوبة</label>
                <select id="shiftSelect" class="form-control">
                    <option value="صباحية">صباحية</option>
                    <option value="مسائية">مسائية</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">المنطقة</label>
                <select id="areaSelect" class="form-control" onchange="updateAvailableShops()">
                    <option value="">اختر المنطقة...</option>
                </select>
            </div>
            
            <!-- Filter Statistics -->
            <div class="filter-stats">
                <div class="stat-box">
                    <div class="value" id="totalShopsCount">0</div>
                    <div class="label">إجمالي المحلات</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="availableShopsCount">0</div>
                    <div class="label">المحلات المتاحة</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="highPriorityCount">0</div>
                    <div class="label">أولوية عالية</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="selectedShopsCount">0</div>
                    <div class="label">المحلات المختارة</div>
                </div>
            </div>
            
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                    <label class="form-label" style="margin-bottom: 0;">المحلات المتاحة (مرتبة حسب الأولوية)</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="showAllShopsBtn" class="btn btn-info btn-sm" onclick="toggleShowAllShops()" style="display: none; padding: 8px 16px;">
                            <span id="showAllShopsBtnIcon">🌍</span>
                            <span id="showAllShopsBtnText">عرض جميع المحلات في هذه المنطقة</span>
                        </button>
                        <button id="showHighPriorityBtn" class="btn btn-warning btn-sm" onclick="toggleHighPriorityShops()" style="display: none; padding: 8px 16px;">
                            <span id="highPriorityBtnIcon">👁️</span>
                            <span id="highPriorityBtnText">عرض المحلات ذات الأولوية العالية</span>
                        </button>
                    </div>
                </div>
                
                <!-- NEW: Alternative Shop Selection Options -->
                <div class="btn-group" style="margin-bottom: 15px; gap: 10px;">
                    <button class="btn btn-info btn-sm" onclick="selectFromAllShops()" title="اختيار من قائمة جميع المحلات">
                        <span>📋</span>
                        <span>اختيار من قائمة المحلات</span>
                    </button>
                    <button id="selectAllAreaShopsBtn" class="btn btn-success btn-sm" onclick="selectAllShopsInCurrentArea()" style="display: none;" title="اختيار جميع المحلات في المنطقة المحددة">
                        <span>✅</span>
                        <span>جميع المحلات في هذه المنطقة</span>
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="selectFromOtherAreas()" title="اختيار محلات من مناطق أخرى">
                        <span>🗺️</span>
                        <span>اختيار من مناطق أخرى</span>
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="displayShopsBySpecificArea()" title="عرض محلات منطقة معينة">
                        <span>🏘️</span>
                        <span>عرض محلات منطقة معينة</span>
                    </button>
                </div>
                
                <!-- Search box for shops in new inspection -->
                <div class="search-box" id="inspectionShopSearchBox" style="display: none; margin-bottom: 15px;">
                    <input type="text" id="inspectionShopSearch" class="form-control" 
                           placeholder="🔍 ابحث عن محل معين (بالاسم، رقم الترخيص، كود ADM...)" 
                           oninput="filterInspectionShops()">
                    <span class="search-icon">🔍</span>
                </div>
                
                <div id="shopsListContainer">
                    <p style="text-align: center; color: #999; padding: 20px;">
                        اختر المفتش والتاريخ والمنطقة لعرض المحلات المتاحة
                    </p>
                </div>
            </div>
            
            <!-- Selected Shops -->
            <div class="selected-shops" id="selectedShopsContainer" style="display: none;">
                <h3>المحلات المختارة للتفتيش</h3>
                <div class="selected-shops-list" id="selectedShopsList"></div>
            </div>
            
            <!-- Inspection Preview -->
            <div class="inspection-preview" id="inspectionPreview" style="display: none;">
                <h3>معاينة التفتيش</h3>
                <div class="preview-item">
                    <strong>المفتش:</strong> <span id="previewInspector">-</span>
                </div>
                <div class="preview-item">
                    <strong>التاريخ:</strong> <span id="previewDate">-</span>
                </div>
                <div class="preview-item">
                    <strong>المناوبة:</strong> <span id="previewShift">-</span>
                </div>
                <div class="preview-item">
                    <strong>المنطقة:</strong> <span id="previewArea">-</span>
                </div>
                <div class="preview-item">
                    <strong>عدد المحلات:</strong> <span id="previewShopsCount">0</span>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <span id="mapsStatusIndicator" class="maps-status-indicator loading">
                        ⏳ جاري تحميل خرائط جوجل...
                    </span>
                    <button class="btn-add-from-map" onclick="openMapModal()" id="mapButton">
                        <span class="icon">🗺️</span>
                        <span>إضافة تفتيش من الخريطة</span>
                    </button>
                    <button class="btn" onclick="openGoogleMapsDiagnostics()" style="background: #3498db; color: white; padding: 12px 20px;">
                        <span>🔍</span>
                        <span>تشخيص الخرائط</span>
                    </button>
                    <button class="btn" onclick="openSmartPetShopDiscovery()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; padding: 12px 20px; box-shadow: 0 5px 15px rgba(255,107,107,0.3);">
                        <span>🐾</span>
                        <span>اكتشاف محلات ذكية</span>
                    </button>
                </div>
                <button class="btn btn-success" onclick="saveInspection()" id="saveBtn" disabled>
                    <span>💾</span>
                    <span>حفظ التفتيش فوراً</span>
                </button>
                <button class="btn btn-warning" onclick="resetForm()">
                    <span>🔄</span>
                    <span>إعادة تعيين</span>
                </button>
            </div>
            
            <div class="status-message" id="planningStatus"></div>
                </div>
            </div>
            
            <!-- Tab Content: View Inspections -->
            <div id="viewTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">👁️ عرض وإدارة التفتيشات</h2>
                    
                    <!-- Filter Bar -->
                    <div class="filter-bar">
                        <div class="filter-item">
                            <label class="form-label">فلترة حسب المفتش</label>
                            <select id="filterInspector" class="form-control" onchange="filterInspections()">
                                <option value="">جميع المفتشين</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">فلترة حسب المنطقة</label>
                            <select id="filterArea" class="form-control" onchange="filterInspections()">
                                <option value="">جميع المناطق</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">من تاريخ</label>
                            <input type="date" id="filterDateFrom" class="form-control" onchange="filterInspections()">
                        </div>
                        <div class="filter-item">
                            <label class="form-label">إلى تاريخ</label>
                            <input type="date" id="filterDateTo" class="form-control" onchange="filterInspections()">
                        </div>
                    </div>
                    
                    <!-- Search Box -->
                    <div class="search-box">
                        <input type="text" id="searchBox" class="form-control" 
                               placeholder="بحث في التفتيشات (اسم المفتش، المنطقة، المحلات...)" 
                               oninput="filterInspections()">
                        <span class="search-icon">🔍</span>
                    </div>
                    
                    <!-- Inspections Table -->
                    <div id="inspectionsTableContainer">
                        <p style="text-align: center; color: #999; padding: 40px;">جاري تحميل التفتيشات...</p>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-danger btn-sm" onclick="deleteSelectedInspections()">
                            <span>🗑️</span> حذف المحدد
                        </button>
                        <button class="btn btn-info btn-sm" onclick="exportInspections()">
                            <span>📥</span> تصدير البيانات
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Statistics -->
            <div id="statsTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">📊 إحصائيات المفتشين</h2>
                    
                    <div class="form-group">
                        <label class="form-label">اختر المفتش</label>
                        <select id="statsInspector" class="form-control" onchange="loadInspectorStats()">
                            <option value="">اختر المفتش...</option>
                        </select>
                    </div>
                    
                    <div id="statsContainer">
                        <div class="empty-state">
                            <div class="icon">📊</div>
                            <p>اختر مفتشاً لعرض الإحصائيات</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Calendar -->
            <div id="calendarTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">📅 التقويم الشهري</h2>
                    
                    <div class="form-group">
                        <label class="form-label">اختر الشهر</label>
                        <input type="month" id="calendarMonth" class="form-control" onchange="loadCalendar()">
                    </div>
                    
                    <div id="calendarContainer">
                        <div class="empty-state">
                            <div class="icon">📅</div>
                            <p>اختر الشهر لعرض التقويم</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Shops Management -->
            <div id="shopsTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">🏪 إدارة المحلات الكاملة</h2>
                    
                    <!-- Smart Action Buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="openAddShopModal()">
                            <span>➕</span> إضافة محل جديد
                        </button>
                        <button class="btn btn-primary" onclick="refreshShopsList()">
                            <span>🔄</span> تحديث القائمة
                        </button>
                        <button class="btn btn-primary" onclick="reloadShopsFromExcel()">
                            <span>📥</span> تحميل من Excel
                        </button>
                        <button class="btn btn-warning" onclick="exportShopsData()">
                            <span>📤</span> تصدير JSON
                        </button>
                        <button class="btn btn-info" onclick="exportShopsToExcel()">
                            <span>📊</span> تصدير Excel
                        </button>
                        <button class="btn btn-danger" onclick="bulkEditShops()">
                            <span>✏️</span> تعديل جماعي
                        </button>
                        <button class="btn btn-danger" onclick="bulkDeleteShops()">
                            <span>🗑️</span> حذف جماعي
                        </button>
                        <button class="btn btn-success" onclick="mergeShopsData()">
                            <span>🔗</span> دمج بيانات
                        </button>
                        <button class="btn btn-info" onclick="validateShopsData()">
                            <span>✅</span> التحقق من البيانات
                        </button>
                        <button class="btn btn-secondary" onclick="findOrphanShops()" style="background: #6c757d; border: none;">
                            <span>🔍</span> عرض المحلات المعزولة
                        </button>
                        <button class="btn btn-warning" onclick="viewShopsOnMap()">
                            <span>🗺️</span> عرض على الخريطة
                        </button>
                        <button class="btn btn-success" onclick="openSmartShopListModal()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; font-weight: bold;">
                            <span>📋</span> قائمة المحلات الذكية
                        </button>
                        <button class="btn btn-success" onclick="openShopsByAreaModal()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; font-weight: bold;">
                            <span>🏘️</span> عرض المحلات مرتبة حسب المنطقة
                        </button>
                        <button class="btn btn-warning" onclick="openMoveShopsModal()" style="border: none; font-weight: bold;">
                            <span>↔️</span> نقل محلات بين المناطق
                        </button>
                    </div>
                    
                    <!-- Filter and Search -->
                    <div class="filter-bar">
                        <div class="filter-item">
                            <label class="form-label">البحث عن محل</label>
                            <input type="text" id="searchShop" class="form-control" 
                                   placeholder="ابحث بالاسم..." oninput="filterShopsList()">
                        </div>
                        <div class="filter-item">
                            <label class="form-label">فلترة حسب المنطقة</label>
                            <select id="filterShopArea" class="form-control" onchange="filterShopsList()">
                                <option value="">جميع المناطق</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Shops Stats -->
                    <div class="inspector-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalShopsManagement">0</div>
                            <div class="stat-label">إجمالي المحلات</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="filteredShopsCount">0</div>
                            <div class="stat-label">المحلات المعروضة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalAreasInShops">0</div>
                            <div class="stat-label">عدد المناطق</div>
                        </div>
                    </div>
                    
                    <!-- Shops List Table -->
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table class="inspections-table" id="shopsManagementTable">
                            <thead>
                                <tr>
                                    <th>اسم المحل</th>
                                    <th>المنطقة</th>
                                    <th>رقم التعريف</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="shopsManagementBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 40px;">
                                        جاري تحميل البيانات...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="status-message" id="shopsManagementStatus"></div>
                </div>
            </div>
            
            <!-- Tab Content: Maintenance Control -->
            <div id="maintenanceTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">🔧 التحكم الذكي المطلق في رسالة التحديث والكاش</h2>
                    
                    <!-- Cache Control Section -->
                    <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>🚀</span>
                            <span>التحديث الفوري ومسح الكاش والذاكرة</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            زر قوي لمسح كل الكاش والذاكرة المؤقتة فوراً في GitHub والمتصفحات (Safari, Chrome, Firefox)
                        </p>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button id="clearCacheBtn" class="btn btn-danger" onclick="forceCacheClear()" style="background: white; color: #ff6b6b; font-weight: bold;">
                                <span id="clearCacheIcon">🚀</span>
                                <span id="clearCacheText">مسح قوي وفوري للكاش (Safari + Chrome + Firefox)</span>
                            </button>
                            <button id="updateSWBtn" class="btn btn-warning" onclick="updateServiceWorker()" style="background: white; color: #ee5a6f;">
                                <span id="updateSWIcon">🔄</span>
                                <span id="updateSWText">تحديث Service Worker فوراً</span>
                            </button>
                        </div>
                        <div class="status-message" id="cacheControlStatus"></div>
                    </div>
                    
                    <!-- Maintenance Message Control Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>📺</span>
                            <span>التحكم الذكي في شاشة التحديث المؤقتة</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            تحكم كامل ومباشر 100% في ظهور وإخفاء وتفعيل وإغلاق رسالة "جاري التحديث الآن"
                        </p>
                        
                        <!-- Enable/Disable Toggle -->
                        <div class="form-group">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>🔘</span> حالة رسالة التحديث
                            </label>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <button id="enableMaintenanceBtn" class="btn btn-success" onclick="toggleMaintenanceMessage(true)" style="flex: 1;">
                                    <span>✅</span>
                                    <span>تفعيل رسالة التحديث</span>
                                </button>
                                <button id="disableMaintenanceBtn" class="btn btn-danger" onclick="toggleMaintenanceMessage(false)" style="flex: 1;">
                                    <span>❌</span>
                                    <span>إيقاف رسالة التحديث</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Current Status Display -->
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">الحالة الحالية:</span>
                                <span id="maintenanceStatusLabel" style="font-size: 1.1em; font-weight: 700;">⏳ جاري التحميل...</span>
                            </div>
                        </div>
                        
                        <div class="status-message" id="maintenanceToggleStatus"></div>
                    </div>
                    
                    <!-- Music Control Section -->
                    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>🎵</span>
                            <span>التحكم الذكي المطلق في الموسيقى</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            تحكم فوري ومباشر 100% في صوت الموسيقى وتمكينها/تعطيلها مع الانعكاس المباشر في GitHub
                        </p>
                        
                        <!-- Music Enable/Disable -->
                        <div class="form-group">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>🔊</span> حالة الموسيقى
                            </label>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <button id="enableMusicBtn" class="btn btn-success" onclick="toggleMusic(true)" style="flex: 1;">
                                    <span>🔊</span>
                                    <span>تفعيل الموسيقى</span>
                                </button>
                                <button id="disableMusicBtn" class="btn btn-danger" onclick="toggleMusic(false)" style="flex: 1;">
                                    <span>🔇</span>
                                    <span>إيقاف الموسيقى</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Volume Control -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>🎚️</span> مستوى الصوت (حجم الموسيقى)
                            </label>
                            <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin-top: 10px;">
                                <input type="range" id="volumeSlider" min="0" max="100" value="10" 
                                       style="width: 100%; height: 8px; border-radius: 5px; cursor: pointer;"
                                       oninput="updateVolumeDisplay(this.value)"
                                       onchange="saveVolumeChange(this.value)">
                                <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9em;">
                                    <span>🔇 0%</span>
                                    <span id="volumeDisplay" style="font-size: 1.3em; font-weight: 700;">🔊 10%</span>
                                    <span>🔊 100%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Volume Presets -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" style="color: white; font-size: 1.1em;">
                                <span>⚡</span> إعدادات سريعة للصوت
                            </label>
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <button class="btn btn-sm" onclick="setVolumePreset(0)" style="background: white; color: #11998e;">
                                    <span>🔇</span> كتم الصوت
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(1)" style="background: white; color: #11998e;">
                                    <span>🔉</span> 1% (خافت جداً)
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(5)" style="background: white; color: #11998e;">
                                    <span>🔉</span> 5% (خافت)
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(10)" style="background: white; color: #11998e;">
                                    <span>🔉</span> 10%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(25)" style="background: white; color: #11998e;">
                                    <span>🔉</span> 25%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(40)" style="background: white; color: #11998e;">
                                    <span>🔊</span> 40%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(50)" style="background: white; color: #11998e;">
                                    <span>🔊</span> 50%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(75)" style="background: white; color: #11998e;">
                                    <span>🔊</span> 75%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(100)" style="background: white; color: #11998e;">
                                    <span>🔊</span> 100%
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tap to Stop Feature -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" style="color: white; font-size: 1.1em;">
                                <span>👆</span> ميزة إيقاف الموسيقى عند النقر
                            </label>
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 10px;">
                                <p style="margin-bottom: 10px; font-size: 0.95em;">
                                    تفعيل هذه الميزة يجعل الموسيقى تتوقف تلقائياً عند النقر على أي مكان في الشاشة
                                </p>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-sm" onclick="setTapToStop(true)" style="background: white; color: #11998e; flex: 1;">
                                        <span>✅</span> تفعيل النقر للإيقاف
                                    </button>
                                    <button class="btn btn-sm" onclick="setTapToStop(false)" style="background: white; color: #e74c3c; flex: 1;">
                                        <span>❌</span> تعطيل النقر للإيقاف
                                    </button>
                                </div>
                                <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.15); border-radius: 5px;">
                                    <span style="font-weight: 600;">الحالة:</span>
                                    <span id="tapToStopStatus" style="font-weight: 700; margin-right: 10px;">⏳ جاري التحميل...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Music Duration Control -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>⏱️</span> مدة تشغيل الموسيقى
                            </label>
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <button class="btn btn-sm" onclick="setMusicDuration(60)" style="background: white; color: #11998e;">
                                    <span>⏱️</span> دقيقة واحدة
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(300)" style="background: white; color: #11998e;">
                                    <span>⏱️</span> 5 دقائق
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(600)" style="background: white; color: #11998e;">
                                    <span>⏱️</span> 10 دقائق
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(1800)" style="background: white; color: #11998e;">
                                    <span>⏱️</span> 30 دقيقة
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(-1)" style="background: white; color: #11998e;">
                                    <span>♾️</span> مستمر (غير محدود)
                                </button>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; margin-top: 10px;">
                                <span style="font-weight: 600;">المدة الحالية:</span>
                                <span id="musicDurationLabel" style="font-weight: 700; margin-right: 10px;">⏳ جاري التحميل...</span>
                            </div>
                        </div>
                        
                        <!-- Current Music Status -->
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">حالة الموسيقى:</span>
                                <span id="musicStatusLabel" style="font-size: 1.1em; font-weight: 700;">⏳ جاري التحميل...</span>
                            </div>
                        </div>
                        
                        <div class="status-message" id="musicControlStatus"></div>
                    </div>
                    
                    <!-- Live Preview Section -->
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 25px; border-radius: 15px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>👁️</span>
                            <span>معاينة مباشرة وحية 100%</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            جميع التغييرات تنعكس فوراً ومباشرة في GitHub وعلى جميع الأجهزة والمتصفحات
                        </p>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="margin-bottom: 10px;">
                                <span style="font-weight: 600;">آخر تحديث:</span>
                                <span id="lastUpdateLabel" style="font-weight: 700; margin-right: 10px;">⏳ جاري التحميل...</span>
                            </div>
                            <div>
                                <span style="font-weight: 600;">تم التحديث بواسطة:</span>
                                <span id="updatedByLabel" style="font-weight: 700; margin-right: 10px;">⏳ جاري التحميل...</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="loadMaintenanceConfig()" style="margin-top: 15px; background: white; color: #fa709a;">
                            <span>🔄</span>
                            <span>تحديث البيانات المباشرة</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Areas Management -->
            <div id="areasTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">🗺️ إدارة المناطق الكاملة</h2>
                    
                    <!-- Smart Action Buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="openAddAreaModal()">
                            <span>➕</span> إضافة منطقة جديدة
                        </button>
                        <button class="btn btn-primary" onclick="refreshAreasList()">
                            <span>🔄</span> تحديث القائمة
                        </button>
                        <button class="btn btn-warning" onclick="sortAreasBySmartPriority()">
                            <span>⭐</span> ترتيب ذكي بالأولوية
                        </button>
                        <button class="btn btn-warning" onclick="sortAreasByName()">
                            <span>🔤</span> ترتيب أبجدياً
                        </button>
                        <button class="btn btn-warning" onclick="sortAreasByShopCount()">
                            <span>🏪</span> ترتيب بعدد المحلات
                        </button>
                        <button class="btn btn-info" onclick="mergeAreas()">
                            <span>🔗</span> دمج مناطق
                        </button>
                        <button class="btn btn-success" onclick="assignShopsToAreas()">
                            <span>📍</span> تعيين المحلات
                        </button>
                        <button class="btn btn-warning" onclick="exportAreasData()">
                            <span>📤</span> تصدير البيانات
                        </button>
                        <button class="btn btn-info" onclick="importAreasFromFile()">
                            <span>📥</span> استيراد مناطق
                        </button>
                        <button class="btn btn-danger" onclick="bulkEditAreas()">
                            <span>✏️</span> تعديل جماعي
                        </button>
                        <button class="btn btn-success" onclick="generateAreasReport()">
                            <span>📊</span> تقرير المناطق
                        </button>
                        <button class="btn btn-danger" onclick="openAreaShopsViewModal()" style="border: none; font-weight: bold;">
                            <span>🏪</span> عرض محلات منطقة معينة
                        </button>
                    </div>
                    
                    <!-- Search -->
                    <div class="search-box">
                        <input type="text" id="searchArea" placeholder="ابحث عن منطقة..." oninput="filterAreasList()">
                        <span class="search-icon">🔍</span>
                    </div>
                    
                    <!-- Areas Stats -->
                    <div class="inspector-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalAreasManagement">0</div>
                            <div class="stat-label">إجمالي المناطق</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="filteredAreasCount">0</div>
                            <div class="stat-label">المناطق المعروضة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalShopsInAreas">0</div>
                            <div class="stat-label">إجمالي المحلات</div>
                        </div>
                    </div>
                    
                    <!-- Areas List Table -->
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table class="inspections-table" id="areasManagementTable">
                            <thead>
                                <tr>
                                    <th>اسم المنطقة</th>
                                    <th>رقم التعريف</th>
                                    <th>عدد المحلات</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="areasManagementBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 40px;">
                                        جاري تحميل البيانات...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="status-message" id="areasManagementStatus"></div>
                </div>
            </div>
        </div>
        
        <!-- Tab Content: Group Inspection -->
        <div id="groupInspectionTab" class="tab-content">
            <div class="section">
                <h2 class="section-title">👥 إدارة التفتيش الجماعي</h2>
                <p style="color: #666; margin-bottom: 20px; text-align: center;">
                    إضافة وإدارة التفتيشات التي تحتاج إلى فريق من المفتشين
                </p>
                
                <!-- Group Inspection Form -->
                <div style="background: linear-gradient(135deg, #fff5e6 0%, #ffe8cc 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid #ff9800; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);">
                    <h3 style="margin: 0 0 20px 0; color: #e65100; text-align: center; font-size: 1.3em;">➕ إضافة تفتيش جماعي جديد</h3>
                    <p style="margin: 0 0 15px 0; color: #666; font-size: 0.95em; text-align: center;">
                        للتفتيشات التي تحتاج إلى أكثر من مفتش في نفس الوقت
                    </p>
                    
                    <form id="smartGroupInspectionForm" style="max-width: 900px; margin: 0 auto;">
                        <div class="form-group">
                            <label class="form-label" style="color: #e65100; font-weight: bold;">👥 اختر المفتشين (متعدد - 2 على الأقل)</label>
                            <div id="smartGroupInspectorsCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #ff9800; max-height: 250px; overflow-y: auto;">
                                <!-- Checkboxes will be populated here -->
                            </div>
                            <small style="color: #666; font-size: 0.9em; margin-top: 5px; display: block;">💡 يجب اختيار مفتشين اثنين على الأقل</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: #e65100; font-weight: bold;">📅 التاريخ</label>
                            <input type="date" id="smartGroupFormDay" required class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: #e65100; font-weight: bold;">🕐 المناوبة</label>
                            <select id="smartGroupFormShift" required class="form-control">
                                <option value="">اختر المناوبة</option>
                                <option value="صباحية">صباحية</option>
                                <option value="مسائية">مسائية</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: #e65100; font-weight: bold;">🗺️ المنطقة</label>
                            <select id="smartGroupFormArea" required class="form-control" onchange="updateGroupFormShops()">
                                <option value="">اختر المنطقة</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: #e65100; font-weight: bold;">🏪 اسم المحل</label>
                            <select id="smartGroupFormShopName" required class="form-control">
                                <option value="">اختر المحل</option>
                            </select>
                            <small style="color: #666; font-size: 0.9em; margin-top: 5px; display: block;">💡 سيتم عرض محلات المنطقة المختارة فقط</small>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 12px 30px; font-size: 1.1em; border: none;">
                                <span>➕</span>
                                <span id="smartGroupFormSubmitText">إضافة تفتيش جماعي</span>
                            </button>
                            <button type="button" id="smartGroupFormCancelBtn" onclick="cancelGroupInspectionEdit()" class="btn" style="display: none; background: #6c757d; color: white; padding: 12px 30px; font-size: 1.1em; margin-right: 10px;">
                                <span>❌</span>
                                <span>إلغاء التعديل</span>
                            </button>
                        </div>
                        <input type="hidden" id="smartGroupFormEditingIndex" value="">
                    </form>
                </div>
                
                <!-- Group Inspections List -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; border: 2px solid #e0e0e0;">
                    <h3 style="margin: 0 0 20px 0; color: #2d3561; text-align: center; font-size: 1.3em;">📋 التفتيشات الجماعية المجدولة</h3>
                    <div id="smartGroupInspectionTableContainer">
                        <p style="text-align: center; color: #999; padding: 40px 20px;">
                            لا توجد تفتيشات جماعية حالياً. قم بإضافة تفتيش جماعي جديد باستخدام النموذج أعلاه.
                        </p>
                    </div>
                </div>
                
                <div class="status-message" id="groupInspectionStatus"></div>
            </div>
        </div>
        
        <!-- Shelter Inspection Tab -->
        <div id="shelterInspectionTab" class="tab-content">
            <div class="section">
                <h2 class="section-title">🏘️ إدارة تفتيش الملاجئ</h2>
                <p style="color: #666; margin-bottom: 20px; text-align: center;">
                    إضافة وإدارة خطط تفتيش الملاجئ بفريق من المفتشين
                </p>
                
                <!-- Shelter Visit Report -->
                <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid #9c27b0; box-shadow: 0 4px 12px rgba(156, 39, 176, 0.2);">
                    <h3 style="margin: 0 0 20px 0; color: #6a1b9a; text-align: center; font-size: 1.3em;">➕ إضافة خطة تفتيش ملجأ جديدة</h3>
                    <p style="margin: 0 0 15px 0; color: #666; font-size: 0.95em; text-align: center;">
                        للتفتيشات التي تحتاج إلى فريق متخصص لتفتيش الملاجئ
                    </p>
                    
                    <form id="smartShelterInspectionForm" style="max-width: 900px; margin: 0 auto;">
                        <div class="form-group">
                            <label class="form-label" style="color: #6a1b9a; font-weight: bold;">👥 اختر المفتشين (متعدد - 2 على الأقل)</label>
                            <div id="smartShelterInspectorsCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #9c27b0; max-height: 250px; overflow-y: auto;">
                                <!-- Checkboxes will be populated here -->
                            </div>
                            <small style="color: #666; font-size: 0.9em; margin-top: 5px; display: block;">💡 يجب اختيار مفتشين اثنين على الأقل</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: #6a1b9a; font-weight: bold;">📅 التاريخ</label>
                            <input type="date" id="smartShelterFormDay" required class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: #6a1b9a; font-weight: bold;">🕐 المناوبة</label>
                            <select id="smartShelterFormShift" required class="form-control">
                                <option value="">اختر المناوبة</option>
                                <option value="صباحية">صباحية</option>
                                <option value="مسائية">مسائية</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: #6a1b9a; font-weight: bold;">🗺️ المنطقة</label>
                            <select id="smartShelterFormArea" required class="form-control" onchange="updateShelterFormShelters()">
                                <option value="">اختر المنطقة</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: #6a1b9a; font-weight: bold;">🏘️ اسم الملجأ</label>
                            <select id="smartShelterFormShelterName" required class="form-control">
                                <option value="">اختر الملجأ</option>
                            </select>
                            <small style="color: #666; font-size: 0.9em; margin-top: 5px; display: block;">💡 سيتم عرض الملاجئ للمنطقة المختارة فقط</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: #6a1b9a; font-weight: bold;">📝 ملاحظات إضافية (اختياري)</label>
                            <textarea id="smartShelterFormNotes" class="form-control" rows="3" placeholder="أضف أي ملاحظات خاصة بالتفتيش"></textarea>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; padding: 12px 30px; font-size: 1.1em; border: none;">
                                <span>➕</span>
                                <span id="smartShelterFormSubmitText">إضافة خطة تفتيش</span>
                            </button>
                            <button type="button" id="smartShelterFormCancelBtn" onclick="cancelShelterInspectionEdit()" class="btn" style="display: none; background: #6c757d; color: white; padding: 12px 30px; font-size: 1.1em; margin-right: 10px;">
                                <span>❌</span>
                                <span>إلغاء التعديل</span>
                            </button>
                        </div>
                        <input type="hidden" id="smartShelterFormEditingIndex" value="">
                    </form>
                </div>
                
                <!-- Shelter Inspections List -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; border: 2px solid #e0e0e0;">
                    <h3 style="margin: 0 0 20px 0; color: #2d3561; text-align: center; font-size: 1.3em;">📋 خطط تفتيش الملاجئ المجدولة</h3>
                    <div id="smartShelterInspectionTableContainer">
                        <p style="text-align: center; color: #999; padding: 40px 20px;">
                            لا توجد خطط تفتيش ملاجئ حالياً. قم بإضافة خطة جديدة باستخدام النموذج أعلاه.
                        </p>
                    </div>
                </div>
                
                <div class="status-message" id="shelterInspectionStatus"></div>
            </div>
        </div>
        
        <!-- Tab Content: File Manager for Group Inspection Reports -->
        <div id="fileManagerTab" class="tab-content">
            <div class="section">
                <h2 class="section-title">📂 تقارير التفتيش الجماعي وزيارة الملاجئ</h2>
                
                <!-- Developer Warning Banner - Only visible to developers -->
                <div id="developerWarningBanner" style="background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; display: none;">
                    <p style="margin: 0; font-size: 1.1em; font-weight: bold;">🔐 وضع المطور - صلاحيات كاملة</p>
                    <p style="margin: 5px 0 0 0; font-size: 0.95em; opacity: 0.9;">إدارة كاملة لملفات التقارير: رفع، تعديل، حذف</p>
                </div>
                
                <!-- Viewer Info Banner - Only visible to non-developers -->
                <div id="viewerInfoBanner" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; display: none;">
                    <p style="margin: 0; font-size: 1.1em; font-weight: bold;">👁️ وضع العرض - للقراءة فقط</p>
                    <p style="margin: 5px 0 0 0; font-size: 0.95em; opacity: 0.9;">يمكنك عرض وتحميل التقارير المتاحة</p>
                </div>
                
                <!-- Upload New Report Section - Only visible to developers -->
                <div id="developerUploadSection" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid #2196f3; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2); display: none;">
                    <h3 style="margin: 0 0 20px 0; color: #1565c0; text-align: center; font-size: 1.3em;">📤 رفع تقرير جديد</h3>
                    
                    <form id="fileManagerUploadForm" style="max-width: 900px; margin: 0 auto;">
                        <div class="form-group">
                            <label class="form-label" style="color: #1565c0; font-weight: bold;">📎 اختر ملف التقرير</label>
                            <input type="file" id="fileManagerFileInput" accept=".pdf,.xlsx,.xls,.docx,.doc,.pptx,.ppt" class="form-control">
                            <small style="color: #666; font-size: 0.9em; margin-top: 5px; display: block;">الملفات المدعومة: PDF, Excel (.xlsx, .xls), Word (.docx, .doc), PowerPoint (.pptx, .ppt) - الحد الأقصى 25 ميجابايت</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: #1565c0; font-weight: bold;">📝 عنوان التقرير</label>
                            <input type="text" id="fileManagerTitle" class="form-control" placeholder="مثال: تقرير التفتيش الجماعي - يناير 2025" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: #1565c0; font-weight: bold;">📄 وصف التقرير</label>
                            <textarea id="fileManagerDescription" class="form-control" rows="3" placeholder="وصف مختصر للتقرير..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color: #1565c0; font-weight: bold;">👤 اسم الرافع</label>
                            <input type="text" id="fileManagerUploader" class="form-control" placeholder="د. علي عبدالعال" value="د. علي عبدالعال">
                        </div>
                        
                        <div class="btn-group">
                            <button type="button" class="btn btn-success" onclick="uploadReportFile()">
                                <span>📤</span> رفع التقرير
                            </button>
                            <button type="button" class="btn btn-warning" onclick="clearUploadForm()">
                                <span>🔄</span> إعادة تعيين
                            </button>
                        </div>
                        <div class="status-message" id="fileManagerUploadStatus"></div>
                    </form>
                </div>
                
                <!-- Files List Section - Visible to all, but with different buttons -->
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; border: 2px solid #e0e0e0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #2d3561; font-size: 1.3em;">📋 التقارير المتاحة</h3>
                        <button class="btn btn-primary" onclick="loadGroupReportFiles()">
                            <span>🔄</span> تحديث القائمة
                        </button>
                    </div>
                    
                    <div id="fileManagerFilesList" style="min-height: 300px;">
                        <p style="text-align: center; color: #999; padding: 60px 20px;">
                            <span style="font-size: 3em; display: block; margin-bottom: 10px;">📑</span>
                            جاري تحميل قائمة التقارير...
                        </p>
                    </div>
                </div>
                
                <div class="status-message" id="fileManagerStatus"></div>
            </div>
        </div>
        
        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>✏️ تحرير التفتيش</h2>
                    <span class="modal-close" onclick="closeEditModal()">&times;</span>
                </div>
                <input type="hidden" id="editInspectionIndex">
                <div class="form-group">
                    <label class="form-label">المفتش</label>
                    <select id="editInspector" class="form-control">
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">التاريخ</label>
                    <input type="date" id="editDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">المناوبة</label>
                    <select id="editShift" class="form-control">
                        <option value="صباحية">صباحية</option>
                        <option value="مسائية">مسائية</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">المنطقة</label>
                    <select id="editArea" class="form-control">
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">المحلات (مفصولة بفواصل)</label>
                    <textarea id="editShops" class="form-control" rows="6" 
                              placeholder="محل 1، محل 2، محل 3..."></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveEditedInspection()">
                        <span>💾</span> حفظ التغييرات
                    </button>
                    <button class="btn btn-warning" onclick="closeEditModal()">
                        <span>✕</span> إلغاء
                    </button>
                </div>
                <div class="status-message" id="editStatus"></div>
            </div>
        </div>
        
        <!-- Add/Edit Shop Modal -->
        <div id="shopModal" class="modal">
            <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 id="shopModalTitle">➕ إضافة محل جديد</h2>
                    <span class="modal-close" onclick="closeShopModal()">&times;</span>
                </div>
                <input type="hidden" id="shopModalId">
                
                <!-- Required Fields Section -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #2d3561; font-size: 1.1em; margin-bottom: 15px;">📋 المعلومات الأساسية (إجبارية)</h3>
                    <div class="form-group">
                        <label class="form-label">اسم المحل <span style="color: red;">*</span></label>
                        <input type="text" id="shopModalName" class="form-control" placeholder="أدخل اسم المحل">
                    </div>
                    <div class="form-group">
                        <label class="form-label">المنطقة <span style="color: red;">*</span></label>
                        <select id="shopModalArea" class="form-control">
                            <option value="">اختر المنطقة...</option>
                        </select>
                    </div>
                </div>
                
                <!-- Optional Details Section -->
                <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #2d3561; font-size: 1.1em; margin-bottom: 15px;">📝 التفاصيل الإضافية (اختيارية)</h3>
                    
                    <div class="form-group">
                        <label class="form-label">اسم المحل بالإنجليزية</label>
                        <input type="text" id="shopModalNameEn" class="form-control" placeholder="Shop Name in English">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">رقم الترخيص</label>
                        <input type="text" id="shopModalLicense" class="form-control" placeholder="مثال: CN-1234567">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">العنوان</label>
                        <input type="text" id="shopModalAddress" class="form-control" placeholder="العنوان الكامل للمحل">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">رقم الهاتف</label>
                        <input type="tel" id="shopModalPhone" class="form-control" placeholder="مثال: 0501234567">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">البريد الإلكتروني</label>
                        <input type="email" id="shopModalEmail" class="form-control" placeholder="example@email.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">🗺️ موقع المحل على خرائط جوجل</label>
                        <!-- ⚠️ CRITICAL: Manual Google Maps link ONLY - NO auto-generation -->
                        <!-- ⚠️ حرج: رابط خرائط جوجل يدوي فقط - لا توليد تلقائي -->
                        <input type="url" id="shopModalGoogleMaps" class="form-control" placeholder="https://maps.google.com/...">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            💡 نسخ رابط الموقع من خرائط جوجل لتسهيل الوصول إلى المحل
                        </small>
                        <small style="color: #d9534f; display: block; margin-top: 3px; font-weight: 500;">
                            ⚠️ يجب نسخ الرابط يدوياً من خرائط جوجل - لا توليد تلقائي
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">طبيعة نشاط المحل</label>
                        <textarea id="shopModalActivity" class="form-control" rows="3" placeholder="مثال: بيع الحيوانات الأليفة، بيع أسماك الزينة، بيع الطيور..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">رمز ADM</label>
                        <input type="text" id="shopModalAdmCode" class="form-control" placeholder="مثال: ADM0001">
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveShop()">
                        <span>💾</span> حفظ فوراً
                    </button>
                    <button class="btn btn-warning" onclick="closeShopModal()">
                        <span>✕</span> إلغاء
                    </button>
                </div>
                <div class="status-message" id="shopModalStatus"></div>
            </div>
        </div>
        
        <!-- Add/Edit Area Modal -->
        <div id="areaModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="areaModalTitle">➕ إضافة منطقة جديدة</h2>
                    <span class="modal-close" onclick="closeAreaModal()">&times;</span>
                </div>
                <input type="hidden" id="areaModalId">
                <div class="form-group">
                    <label class="form-label">اسم المنطقة <span style="color: red;">*</span></label>
                    <input type="text" id="areaModalName" class="form-control" placeholder="أدخل اسم المنطقة">
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveArea()">
                        <span>💾</span> حفظ
                    </button>
                    <button class="btn btn-warning" onclick="closeAreaModal()">
                        <span>✕</span> إلغاء
                    </button>
                </div>
                <div class="status-message" id="areaModalStatus"></div>
            </div>
        </div>
        
        <!-- Merge Areas Modal -->
        <div id="mergeAreasModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2>🔗 دمج المناطق</h2>
                    <span class="modal-close" onclick="closeMergeAreasModal()">&times;</span>
                </div>
                
                <p style="color: #666; margin-bottom: 20px;">
                    اختر منطقتين أو أكثر لدمجها في منطقة واحدة. سيتم نقل جميع المحلات تلقائياً إلى المنطقة الرئيسية.
                </p>
                
                <div class="form-group">
                    <label class="form-label">المنطقة الرئيسية (سيتم الدمج فيها) <span style="color: red;">*</span></label>
                    <select id="mergeTargetArea" class="form-control">
                        <option value="">-- اختر المنطقة الرئيسية --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">المناطق المراد دمجها (حدد واحدة أو أكثر) <span style="color: red;">*</span></label>
                    <div id="mergeSourceAreasContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px;">
                        <!-- Checkboxes will be added here dynamically -->
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>⚠️ ملاحظة هامة:</strong>
                    <ul style="margin: 10px 0; padding-right: 20px;">
                        <li>سيتم نقل جميع المحلات من المناطق المحددة إلى المنطقة الرئيسية</li>
                        <li>سيتم تحديث جميع التفتيشات للمحلات المنقولة</li>
                        <li>سيتم حذف المناطق المدمجة بعد نقل المحلات</li>
                        <li>لا يمكن التراجع عن هذه العملية</li>
                    </ul>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="executeMergeAreas()">
                        <span>🔗</span> تنفيذ الدمج
                    </button>
                    <button class="btn btn-warning" onclick="closeMergeAreasModal()">
                        <span>✕</span> إلغاء
                    </button>
                </div>
                
                <div class="status-message" id="mergeAreasStatus"></div>
            </div>
        </div>
        
        <!-- Assign Shops to Areas Modal -->
        <div id="assignShopsModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2>📍 تعيين المحلات للمناطق</h2>
                    <span class="modal-close" onclick="closeAssignShopsModal()">&times;</span>
                </div>
                
                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-right: 4px solid #2196F3;">
                    <p style="color: #0d47a1; margin: 0; font-weight: 500;">
                        📝 <strong>كيفية الاستخدام:</strong><br>
                        1️⃣ اختر منطقة من القائمة المنسدلة للفلترة (اختياري)<br>
                        2️⃣ ستظهر المحلات مجمعة حسب المنطقة أدناه<br>
                        3️⃣ حدد المحلات التي تريد نقلها باستخدام مربعات الاختيار<br>
                        4️⃣ اختر المنطقة الجديدة من القائمة المنسدلة<br>
                        5️⃣ اضغط "تعيين المحلات" لحفظ التغييرات
                    </p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        🔍 فلترة المحلات حسب المنطقة (اختياري)
                    </label>
                    <select id="assignShopsCurrentArea" class="form-control" onchange="loadShopsForAssignment()">
                        <option value="">-- عرض جميع المحلات من كل المناطق --</option>
                    </select>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        💡 اختر منطقة معينة لعرض محلاتها فقط، أو اترك "جميع المحلات" لعرض الكل
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">المنطقة الجديدة <span style="color: red;">*</span></label>
                    <select id="assignShopsTargetArea" class="form-control">
                        <option value="">-- اختر المنطقة الجديدة --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        ☑️ المحلات المراد نقلها (اختر واحد أو أكثر) <span style="color: red;">*</span>
                    </label>
                    <small style="color: #666; display: block; margin-bottom: 10px;">
                        ℹ️ المحلات مجمعة حسب المنطقة الحالية لسهولة الاختيار
                    </small>
                    <div style="margin-bottom: 10px;">
                        <input type="text" id="searchShopsForAssignment" class="form-control" placeholder="🔍 ابحث عن محل بالاسم..." oninput="filterShopsForAssignment()">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-info" onclick="selectAllShopsForAssignment()">
                            ✓ تحديد الكل
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="deselectAllShopsForAssignment()">
                            ✕ إلغاء التحديد
                        </button>
                    </div>
                    <div id="assignShopsContainer" style="max-height: 400px; overflow-y: auto; border: 2px solid #667eea; padding: 15px; border-radius: 8px; background: #fafafa;">
                        <p style="text-align: center; color: #999; padding: 40px;">
                            ⏳ جاري تحميل المحلات...
                        </p>
                    </div>
                </div>
                
                <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>ℹ️ معلومات:</strong>
                    <ul style="margin: 10px 0; padding-right: 20px;">
                        <li>سيتم تحديث منطقة المحلات المحددة إلى المنطقة الجديدة</li>
                        <li>سيتم تحديث جميع التفتيشات المرتبطة بالمحلات</li>
                        <li>يمكن إعادة تعيين المحلات في أي وقت</li>
                    </ul>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="executeAssignShops()">
                        <span>📍</span> تعيين المحلات
                    </button>
                    <button class="btn btn-warning" onclick="closeAssignShopsModal()">
                        <span>✕</span> إلغاء
                    </button>
                </div>
                
                <div class="status-message" id="assignShopsStatus"></div>
            </div>
        </div>
        
        <!-- Bulk Edit Areas Modal -->
        <div id="bulkEditModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2>✏️ التعديل الجماعي للمناطق</h2>
                    <span class="modal-close" onclick="closeBulkEditModal()">&times;</span>
                </div>
                
                <p style="color: #666; margin-bottom: 20px;">
                    قم بتعديل عدة مناطق في نفس الوقت. يمكنك إضافة بادئة أو لاحقة لأسماء المناطق أو استبدال نص معين.
                </p>
                
                <div class="form-group">
                    <label class="form-label">المناطق المراد تعديلها (حدد واحدة أو أكثر) <span style="color: red;">*</span></label>
                    <div style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-info" onclick="selectAllAreasForBulkEdit()">
                            ✓ تحديد الكل
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="deselectAllAreasForBulkEdit()">
                            ✕ إلغاء التحديد
                        </button>
                    </div>
                    <div id="bulkEditAreasContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px;">
                        <!-- Checkboxes will be added here dynamically -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">نوع التعديل</label>
                    <select id="bulkEditType" class="form-control" onchange="toggleBulkEditOptions()">
                        <option value="prefix">إضافة بادئة للأسماء</option>
                        <option value="suffix">إضافة لاحقة للأسماء</option>
                        <option value="replace">استبدال نص في الأسماء</option>
                    </select>
                </div>
                
                <div id="bulkEditPrefixSuffix" style="display: block;">
                    <div class="form-group">
                        <label class="form-label">النص المراد إضافته</label>
                        <input type="text" id="bulkEditText" class="form-control" placeholder="مثال: منطقة">
                    </div>
                </div>
                
                <div id="bulkEditReplace" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">النص المراد استبداله</label>
                        <input type="text" id="bulkEditFindText" class="form-control" placeholder="النص القديم">
                    </div>
                    <div class="form-group">
                        <label class="form-label">النص الجديد</label>
                        <input type="text" id="bulkEditReplaceText" class="form-control" placeholder="النص الجديد">
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>⚠️ ملاحظة:</strong>
                    <ul style="margin: 10px 0; padding-right: 20px;">
                        <li>سيتم تحديث أسماء المناطق المحددة فقط</li>
                        <li>تأكد من المعاينة قبل التنفيذ</li>
                        <li>سيتم حفظ التغييرات تلقائياً</li>
                    </ul>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-info" onclick="previewBulkEdit()">
                        <span>👁️</span> معاينة التغييرات
                    </button>
                    <button class="btn btn-success" onclick="executeBulkEdit()">
                        <span>✏️</span> تنفيذ التعديل
                    </button>
                    <button class="btn btn-warning" onclick="closeBulkEditModal()">
                        <span>✕</span> إلغاء
                    </button>
                </div>
                
                <div id="bulkEditPreview" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="color: #2d3561; margin-bottom: 10px;">👁️ معاينة التغييرات:</h3>
                    <div id="bulkEditPreviewContent"></div>
                </div>
                
                <div class="status-message" id="bulkEditStatus"></div>
            </div>
        </div>
        
        <!-- Smart Shop List Modal -->
        <div id="smartShopListModal" class="modal">
            <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>📋 قائمة المحلات الذكية</h2>
                    <span class="modal-close" onclick="closeSmartShopListModal()">&times;</span>
                </div>
                
                <!-- Filters and Controls -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                    <h3 style="margin-bottom: 15px;">⚙️ خيارات التنظيم والترتيب</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">الترتيب الرئيسي:</label>
                            <select id="primarySort" class="form-control" onchange="updateSmartShopList()">
                                <option value="smartPriority">⭐ ترتيب ذكي بالأولوية</option>
                                <option value="areaProximity">📍 ترتيب بالقرب الجغرافي</option>
                                <option value="rating">حسب التقييم (الأعلى أولاً)</option>
                                <option value="area">حسب المنطقة</option>
                                <option value="activity">حسب النشاط</option>
                                <option value="alphabetical">أبجدي (أ-ي)</option>
                                <option value="lastInspection">حسب آخر تفتيش</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">فلترة حسب المنطقة:</label>
                            <select id="smartListAreaFilter" class="form-control" onchange="updateSmartShopList()">
                                <option value="">جميع المناطق</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">فلترة حسب التقييم:</label>
                            <select id="ratingFilter" class="form-control" onchange="updateSmartShopList()">
                                <option value="">جميع التقييمات</option>
                                <option value="excellent">ممتاز (90+)</option>
                                <option value="good">جيد (70-89)</option>
                                <option value="fair">مقبول (50-69)</option>
                                <option value="poor">ضعيف (أقل من 50)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">عرض الجداول:</label>
                            <select id="tableView" class="form-control" onchange="updateSmartShopList()">
                                <option value="unified">جدول موحد</option>
                                <option value="byArea">جدول لكل منطقة</option>
                                <option value="byActivity">جدول حسب النشاط</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Smart Management Buttons Section -->
                    <div style="margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.15); border-radius: 10px;">
                        <h4 style="color: white; margin-bottom: 15px; font-size: 1.2em;">🎯 إدارة المحلات الذكية</h4>
                        
                        <!-- Row 1: Core Management Actions -->
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="openAddShopFromSmartList()" style="background: white; color: #28a745; font-weight: bold;">
                                <span>➕</span> إضافة محل جديد
                            </button>
                            <button class="btn btn-primary" onclick="openBulkEditShops()" style="background: white; color: #007bff;">
                                <span>✏️</span> تعديل محلات متعددة
                            </button>
                            <button class="btn btn-danger" onclick="openBulkDeleteShops()" style="background: white; color: #dc3545;">
                                <span>🗑️</span> حذف محلات متعددة
                            </button>
                            <button class="btn btn-warning" onclick="openImportShopsFromExcel()" style="background: white; color: #ffc107;">
                                <span>📥</span> استيراد من Excel
                            </button>
                        </div>
                        
                        <!-- Row 2: Advanced Management Actions -->
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <button class="btn btn-danger" onclick="mergeDuplicateShops()" style="background: white; color: #dc3545;">
                                <span>🗑️</span> حذف المحلات المكررة
                            </button>
                            <button class="btn btn-success" onclick="syncShopsWithGitHub()" style="background: white; color: #11998e;">
                                <span>☁️</span> مزامنة مع GitHub
                            </button>
                            <button class="btn btn-primary" onclick="refreshSmartShopData()" style="background: white; color: #3498db;">
                                <span>🔄</span> تحديث البيانات
                            </button>
                            <button class="btn btn-warning" onclick="openAdvancedShopSearch()" style="background: white; color: #f39c12;">
                                <span>🔍</span> بحث متقدم
                            </button>
                        </div>
                        
                        <!-- Row 3: Backup and Export Actions -->
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="createShopsBackup()" style="background: white; color: #6c757d;">
                                <span>💾</span> نسخة احتياطية
                            </button>
                            <button class="btn btn-success" onclick="exportSmartShopList('excel')" style="background: white; color: #667eea;">
                                <span>📊</span> تصدير Excel
                            </button>
                            <button class="btn btn-primary" onclick="exportSmartShopList('pdf')" style="background: white; color: #667eea;">
                                <span>📄</span> تصدير PDF
                            </button>
                            <button class="btn btn-info" onclick="exportSmartShopList('json')" style="background: white; color: #667eea;">
                                <span>💾</span> تصدير JSON
                            </button>
                            <button class="btn btn-warning" onclick="printSmartShopList()" style="background: white; color: #667eea;">
                                <span>🖨️</span> طباعة
                            </button>
                        </div>
                        
                        <!-- Row 4: Batch Selection Actions -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-sm" onclick="selectAllShopsInList()" style="background: white; color: #28a745; padding: 8px 16px;">
                                <span>☑️</span> تحديد الكل
                            </button>
                            <button class="btn btn-sm" onclick="deselectAllShopsInList()" style="background: white; color: #dc3545; padding: 8px 16px;">
                                <span>⬜</span> إلغاء التحديد
                            </button>
                            <button class="btn btn-sm" onclick="selectHighPriorityShopsInList()" style="background: white; color: #ffc107; padding: 8px 16px;">
                                <span>⭐</span> تحديد الأولوية العالية
                            </button>
                            <button class="btn btn-sm" onclick="exportSelectedShops()" style="background: white; color: #17a2b8; padding: 8px 16px;">
                                <span>📤</span> تصدير المحدد
                            </button>
                            <button class="btn btn-sm" onclick="applyBatchOperation()" style="background: white; color: #6f42c1; padding: 8px 16px;">
                                <span>⚙️</span> عملية جماعية
                            </button>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- Statistics Summary -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div style="background: #667eea; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListTotalShops">0</div>
                        <div>إجمالي المحلات</div>
                    </div>
                    <div style="background: #11998e; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListAvgRating">0</div>
                        <div>متوسط التقييم</div>
                    </div>
                    <div style="background: #3498db; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListAreas">0</div>
                        <div>عدد المناطق</div>
                    </div>
                    <div style="background: #e74c3c; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListHighPriority">0</div>
                        <div>أولوية عالية</div>
                    </div>
                    <div id="selectedShopsCounter" style="background: #28a745; color: white; padding: 15px; border-radius: 10px; text-align: center; display: none;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListSelectedCount">0</div>
                        <div>محلات محددة</div>
                    </div>
                </div>
                
                <!-- Shop List Content -->
                <div id="smartShopListContent" style="margin-top: 20px;">
                    <p style="text-align: center; padding: 40px; color: #999;">
                        جاري تحميل القائمة الذكية...
                    </p>
                </div>
                
                <div class="status-message" id="smartShopListStatus"></div>
            </div>
        </div>
        
        <!-- Shops By Area View Modal -->
        <div id="shopsByAreaModal" class="modal">
            <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>🏘️ عرض المحلات مرتبة حسب المنطقة</h2>
                    <span class="modal-close" onclick="closeShopsByAreaModal()">&times;</span>
                </div>
                
                <!-- Search and Filter -->
                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">بحث عن محل:</label>
                            <input type="text" id="shopsByAreaSearch" class="form-control" placeholder="ابحث بالاسم..." oninput="updateShopsByAreaView()">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">فلترة حسب المنطقة:</label>
                            <select id="shopsByAreaFilter" class="form-control" onchange="updateShopsByAreaView()">
                                <option value="">جميع المناطق</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">عرض:</label>
                            <select id="shopsByAreaViewType" class="form-control" onchange="updateShopsByAreaView()">
                                <option value="grouped">مجموعة حسب المنطقة</option>
                                <option value="list">قائمة كاملة</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Statistics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div style="background: #e74c3c; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="shopsByAreaTotalShops">0</div>
                        <div>إجمالي المحلات</div>
                    </div>
                    <div style="background: #3498db; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="shopsByAreaTotalAreas">0</div>
                        <div>عدد المناطق</div>
                    </div>
                    <div style="background: #11998e; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="shopsByAreaDisplayed">0</div>
                        <div>محلات معروضة</div>
                    </div>
                </div>
                
                <!-- Content -->
                <div id="shopsByAreaContent" style="margin-top: 20px;">
                    <p style="text-align: center; padding: 40px; color: #999;">
                        جاري تحميل البيانات...
                    </p>
                </div>
                
                <div class="status-message" id="shopsByAreaStatus"></div>
            </div>
        </div>
        
        <!-- Area Shops View Modal (for viewing shops of a specific area) -->
        <div id="areaShopsViewModal" class="modal">
            <div class="modal-content" style="max-width: 90%; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>🏪 عرض محلات منطقة معينة</h2>
                    <span class="modal-close" onclick="closeAreaShopsViewModal()">&times;</span>
                </div>
                
                <!-- Area Selection -->
                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                    <h3 style="margin-bottom: 15px;">اختر المنطقة</h3>
                    <select id="areaShopsViewSelect" class="form-control" onchange="loadShopsForSelectedArea()" style="font-size: 1.1em; padding: 12px;">
                        <option value="">-- اختر منطقة --</option>
                    </select>
                </div>
                
                <!-- Selected Area Info -->
                <div id="selectedAreaInfo" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">
                        <span>📍</span> المنطقة: <span id="selectedAreaName" style="color: #e74c3c;">-</span>
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div style="background: #3498db; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2em; font-weight: bold;" id="selectedAreaShopsCount">0</div>
                            <div>عدد المحلات</div>
                        </div>
                        <div style="background: #11998e; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2em; font-weight: bold;" id="selectedAreaInspections">0</div>
                            <div>التفتيشات المقررة</div>
                        </div>
                    </div>
                </div>
                
                <!-- Shops List -->
                <div id="areaShopsViewContent" style="margin-top: 20px;">
                    <p style="text-align: center; padding: 40px; color: #999;">
                        اختر منطقة لعرض المحلات التابعة لها
                    </p>
                </div>
                
                <div class="status-message" id="areaShopsViewStatus"></div>
            </div>
        </div>
        
        <!-- Move Shops Between Areas Modal -->
        <div id="moveShopsModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2>↔️ نقل محلات بين المناطق</h2>
                    <span class="modal-close" onclick="closeMoveShopsModal()">&times;</span>
                </div>
                
                <!-- Source Area Selection -->
                <div class="form-group">
                    <label class="form-label" style="font-size: 1.1em;">
                        <span>📍</span> المنطقة المصدر (نقل من):
                    </label>
                    <select id="moveShopsSourceArea" class="form-control" onchange="loadShopsForMove()" style="font-size: 1.05em; padding: 12px;">
                        <option value="">-- اختر المنطقة المصدر --</option>
                    </select>
                </div>
                
                <!-- Shops Selection -->
                <div id="moveShopsSelection" style="display: none; margin: 20px 0;">
                    <label class="form-label" style="font-size: 1.1em;">
                        <span>🏪</span> اختر المحلات المراد نقلها:
                    </label>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; max-height: 300px; overflow-y: auto; border: 2px solid #dee2e6;">
                        <div style="margin-bottom: 10px;">
                            <button class="btn btn-sm btn-primary" onclick="selectAllShopsForMove()">
                                <span>☑️</span> تحديد الكل
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="deselectAllShopsForMove()">
                                <span>⬜</span> إلغاء التحديد
                            </button>
                            <span id="moveShopsSelectedCount" style="margin-right: 15px; font-weight: bold; color: #28a745;"></span>
                        </div>
                        <div id="moveShopsList"></div>
                    </div>
                </div>
                
                <!-- Destination Area Selection -->
                <div id="moveShopsDestination" style="display: none; margin: 20px 0;">
                    <label class="form-label" style="font-size: 1.1em;">
                        <span>🎯</span> المنطقة المستهدفة (نقل إلى):
                    </label>
                    <select id="moveShopsTargetArea" class="form-control" style="font-size: 1.05em; padding: 12px;">
                        <option value="">-- اختر المنطقة المستهدفة --</option>
                    </select>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="executeMoveShops()" style="flex: 1;">
                        <span>✅</span> تنفيذ عملية النقل
                    </button>
                    <button class="btn btn-secondary" onclick="closeMoveShopsModal()" style="flex: 1;">
                        <span>❌</span> إلغاء
                    </button>
                </div>
                
                <div class="status-message" id="moveShopsStatus"></div>
            </div>
        </div>
        
        <!-- Shop Selection Modal for Adding Inspection -->
        <div id="shopSelectionModal" class="modal">
            <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>🏪 اختيار المحلات للتفتيش</h2>
                    <span class="modal-close" onclick="closeShopSelectionModal()">&times;</span>
                </div>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                    <h3 style="margin-bottom: 10px;">ℹ️ معلومات</h3>
                    <p style="margin: 0; line-height: 1.6;">
                        يمكنك اختيار المحلات من أي منطقة لإضافتها للتفتيش الجديد.<br>
                        حدد المحلات المطلوبة ثم اضغط "إضافة المحلات المحددة" في الأسفل.
                    </p>
                </div>
                
                <!-- Filters -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label class="form-label">فلترة حسب المنطقة:</label>
                        <select id="shopSelectionAreaFilter" class="form-control" onchange="filterShopsInSelectionModal()">
                            <option value="">جميع المناطق</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">البحث:</label>
                        <input type="text" id="shopSelectionSearch" class="form-control" 
                               placeholder="🔍 ابحث عن محل..." 
                               oninput="filterShopsInSelectionModal()">
                    </div>
                </div>
                
                <!-- Batch Selection Actions -->
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-sm btn-success" onclick="selectAllInSelectionModal()">
                        <span>☑️</span> تحديد الكل
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="deselectAllInSelectionModal()">
                        <span>⬜</span> إلغاء التحديد
                    </button>
                    <button class="btn btn-sm btn-info" onclick="selectHighPriorityInSelectionModal()">
                        <span>⭐</span> تحديد الأولوية العالية
                    </button>
                </div>
                
                <!-- Shop List Container -->
                <div id="shopSelectionListContainer" style="max-height: 500px; overflow-y: auto; border: 2px solid #667eea; padding: 15px; border-radius: 10px; background: #fafafa;">
                    <p style="text-align: center; color: #999; padding: 40px;">
                        ⏳ جاري تحميل المحلات...
                    </p>
                </div>
                
                <!-- Selected Count -->
                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-top: 20px; text-align: center;">
                    <strong>عدد المحلات المحددة: <span id="selectionModalCount">0</span></strong>
                </div>
                
                <!-- Action Buttons -->
                <div class="btn-group" style="margin-top: 20px; justify-content: center;">
                    <button class="btn btn-success" onclick="addSelectedShopsToInspection()">
                        <span>✅</span> إضافة المحلات المحددة
                    </button>
                    <button class="btn btn-danger" onclick="closeShopSelectionModal()">
                        <span>✖️</span> إلغاء
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Bell Notifications Control Modal -->
        <div id="bellNotificationsModal" class="bell-modal">
            <div class="bell-modal-content">
                <div class="bell-modal-header">
                    <h2>🔔 التحكم الكامل في إشعارات الجرس</h2>
                    <button class="bell-modal-close" onclick="closeBellNotificationsControl()">&times;</button>
                </div>
                
                <div class="bell-status-message" id="bellStatusMessage"></div>
                
                <!-- Add New Notification Section -->
                <!-- Global Bell Settings Control Panel -->
                <div class="bell-control-panel">
                    <h3>⚙️ الإعدادات العامة للإشعارات</h3>
                    <div class="bell-control-row">
                        <div class="bell-control-item">
                            <label>⏱️ مدة ظهور فقاعة الإشعار (بالثواني):</label>
                            <input type="number" id="bellBubbleDuration" value="24" min="5" max="120" 
                                   onchange="updateBellBubbleDuration()" 
                                   style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 8px;">
                            <small style="color: #6c757d; display: block; margin-top: 5px;">
                                💡 القيمة الافتراضية: 24 ثانية (يمكن التعديل من 5 إلى 120 ثانية)
                            </small>
                        </div>
                        <div class="bell-control-item">
                            <label>🔔 تفعيل صوت الإشعارات:</label>
                            <select id="bellSoundEnabled" onchange="updateBellSoundSetting()" 
                                    style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 8px;">
                                <option value="true">مفعّل ✅</option>
                                <option value="false">معطّل ❌</option>
                            </select>
                        </div>
                        <div class="bell-control-item">
                            <label>🎨 نمط العرض:</label>
                            <select id="bellDisplayStyle" onchange="updateBellDisplayStyle()" 
                                    style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 8px;">
                                <option value="modern">عصري ✨</option>
                                <option value="classic">كلاسيكي 📜</option>
                                <option value="minimal">بسيط 🎯</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="notification-add-section">
                    <h3>➕ إضافة إشعار جديد</h3>
                    <p style="color: #6c757d; margin-bottom: 15px; font-size: 0.95em;">
                        سيظهر الإشعار فوراً في الجرس 🔔 على الشاشة الرئيسية لجميع المستخدمين
                    </p>
                    <textarea 
                        id="newBellNotificationText" 
                        class="notification-input" 
                        placeholder="اكتب نص الإشعار هنا... (مثال: تم تحديث خطة التفتيش لشهر نوفمبر)"
                        dir="rtl"
                    ></textarea>
                    <input 
                        type="text" 
                        id="newBellNotificationAuthor" 
                        class="notification-author-input" 
                        placeholder="اسم المؤلف/المرسل (مثال: د. علي عبدالعال)"
                        value="د. علي عبدالعال"
                        dir="rtl"
                    />
                    
                    <!-- Enhanced notification settings -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 600;">📌 أولوية الإشعار:</label>
                            <select id="newBellNotificationPriority" style="width: 100%; padding: 8px; border: 2px solid #ced4da; border-radius: 8px;">
                                <option value="high">عالية 🔴</option>
                                <option value="medium" selected>متوسطة 🟡</option>
                                <option value="low">منخفضة 🟢</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 600;">⏱️ مدة العرض (بالأيام):</label>
                            <input type="number" id="newBellNotificationDuration" value="7" min="1" max="365" 
                                   style="width: 100%; padding: 8px; border: 2px solid #ced4da; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <button class="notification-add-btn" onclick="addBellNotification()">
                        ➕ إضافة إشعار
                    </button>
                </div>
                
                <!-- Existing Notifications List -->
                <div class="notifications-list">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #2d3561; font-size: 1.4em; margin: 0;">📋 الإشعارات الحالية</h3>
                        <div class="bell-bulk-actions">
                            <button class="bell-bulk-btn" onclick="sortBellNotificationsByPriority()" 
                                    style="background: #17a2b8; color: white;">
                                🔽 ترتيب حسب الأولوية
                            </button>
                            <button class="bell-bulk-btn" onclick="sortBellNotificationsByDate()" 
                                    style="background: #6c757d; color: white;">
                                📅 ترتيب حسب التاريخ
                            </button>
                            <button class="bell-bulk-btn" onclick="deleteExpiredNotifications()" 
                                    style="background: #dc3545; color: white;">
                                🗑️ حذف المنتهية
                            </button>
                        </div>
                    </div>
                    <div id="bellNotificationsList">
                        <p style="text-align: center; padding: 40px; color: #999;">
                            جاري تحميل الإشعارات...
                        </p>
                    </div>
                </div>
                
                <!-- Save All Button -->
                <button class="bell-save-all-btn" onclick="saveAllBellNotifications()">
                    💾 حفظ جميع التغييرات والمزامنة مع GitHub
                </button>
            </div>
        </div>
    </div>
    
    <!-- Google Maps Modal for Smart Shop Selection -->
    <div id="mapModal" class="map-modal">
        <div class="map-modal-content">
            <div class="map-modal-header">
                <h2>🗺️ اختيار المحلات الذكي من الخريطة</h2>
                <button class="map-modal-close" onclick="closeMapModal()">✖ إغلاق</button>
            </div>
            
            <div class="map-modal-body">
                <!-- Controls Panel -->
                <div class="map-controls-panel">
                    <div class="map-control-group">
                        <label class="map-control-label">👤 المفتش</label>
                        <select id="mapInspectorSelect" class="form-control" onchange="updateMapControls()">
                            <option value="">اختر المفتش...</option>
                        </select>
                    </div>
                    
                    <div class="map-control-group">
                        <label class="map-control-label">📅 التاريخ</label>
                        <input type="date" id="mapInspectionDate" class="form-control" onchange="updateMapControls()">
                    </div>
                    
                    <div class="map-control-group">
                        <label class="map-control-label">🕐 المناوبة</label>
                        <select id="mapShiftSelect" class="form-control">
                            <option value="صباحية">صباحية</option>
                            <option value="مسائية">مسائية</option>
                        </select>
                    </div>
                    
                    <div class="map-control-group">
                        <label class="map-control-label">🗺️ المنطقة (اختياري)</label>
                        <select id="mapAreaSelect" class="form-control" onchange="filterShopsByArea()">
                            <option value="">جميع المناطق</option>
                        </select>
                    </div>
                </div>
                
                <!-- Helper Tools -->
                <div class="map-helper-tools">
                    <h4>🛠️ أدوات مساعدة</h4>
                    <div class="map-tools-buttons">
                        <button class="map-tool-btn" onclick="selectNearbyShops()">
                            📍 اختيار المحلات المتقاربة
                        </button>
                        <button class="map-tool-btn" onclick="selectHighPriorityShops()">
                            ⭐ اختيار الأولوية العالية
                        </button>
                        <button class="map-tool-btn" onclick="clearMapSelection()">
                            🗑️ مسح الاختيار
                        </button>
                        <button class="map-tool-btn" onclick="zoomToSelectedShops()">
                            🔍 تكبير على المختارة
                        </button>
                        <button class="map-tool-btn" onclick="showAllShops()">
                            🌍 عرض جميع المحلات
                        </button>
                    </div>
                </div>
                
                <!-- Location Accuracy Legend -->
                <div class="map-accuracy-legend">
                    <h4>🎯 دقة مواقع المحلات</h4>
                    <div class="accuracy-legend-items">
                        <div class="accuracy-legend-item">
                            <span class="accuracy-indicator-high"></span>
                            <span class="accuracy-label">🎯 دقة عالية - رابط خرائط مباشر</span>
                            <span class="accuracy-count" id="accuracyHighCount">0</span>
                        </div>
                        <div class="accuracy-legend-item">
                            <span class="accuracy-indicator-medium"></span>
                            <span class="accuracy-label">📍 دقة متوسطة - من العنوان</span>
                            <span class="accuracy-count" id="accuracyMediumCount">0</span>
                        </div>
                        <div class="accuracy-legend-item">
                            <span class="accuracy-indicator-low"></span>
                            <span class="accuracy-label">⚠️ دقة منخفضة - من المنطقة</span>
                            <span class="accuracy-count" id="accuracyLowCount">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Selected Shops Display -->
                <div id="selectedShopsOnMap" class="selected-shops-on-map" style="display: none;">
                    <h4>✅ المحلات المختارة (<span id="mapSelectedCount">0</span>)</h4>
                    <div id="selectedShopTags"></div>
                </div>
                
                <!-- Map Container -->
                <div class="map-container">
                    <div id="googleMap"></div>
                </div>
                
                <!-- Statistics Bar -->
                <div class="map-stats-bar">
                    <div class="map-stat-item">
                        <div class="map-stat-value" id="mapTotalShops">0</div>
                        <div class="map-stat-label">إجمالي المحلات</div>
                    </div>
                    <div class="map-stat-item">
                        <div class="map-stat-value" id="mapAvailableShops">0</div>
                        <div class="map-stat-label">المحلات المتاحة</div>
                    </div>
                    <div class="map-stat-item">
                        <div class="map-stat-value" id="mapSelectedShops">0</div>
                        <div class="map-stat-label">المحلات المختارة</div>
                    </div>
                    <div class="map-stat-item">
                        <div class="map-stat-value" id="mapHighPriorityShops">0</div>
                        <div class="map-stat-label">أولوية عالية</div>
                    </div>
                </div>
            </div>
            
            <!-- Footer with Actions -->
            <div class="map-footer">
                <div class="map-actions">
                    <button class="btn-map-primary" onclick="applyMapSelection()" id="applyMapBtn" disabled>
                        ✅ تطبيق الاختيار
                    </button>
                    <button class="btn-map-primary" onclick="saveFromMap()" id="saveFromMapBtn" disabled>
                        💾 حفظ التفتيش مباشرة
                    </button>
                    <button class="btn-map-secondary" onclick="closeMapModal()">
                        ❌ إلغاء
                    </button>
                </div>
                <div style="color: #666; font-size: 0.9em;">
                    💡 انقر على المحلات في الخريطة لاختيارها
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let planData = null;
        let shopsDetails = null;
        let selectedShops = [];
        let githubToken = null;
        const repo = "aliabdelaal-adm/Monthly_inspection_plan";
        let currentEditingIndex = -1;
        let selectedInspectionsForDelete = [];
        let showingHighPriority = false;
        let showingAllShops = false; // NEW: Toggle to show all shops bypassing filters
        let currentAvailableShops = [];
        let currentHighPriorityShops = [];
        let currentAllAreaShops = []; // NEW: Store all shops in the area
        
        // Error message constants for token validation
        const TOKEN_ERROR_MESSAGES = {
            invalidToken: 'التوكن غير صالح أو منتهي الصلاحية',
            invalidTokenHelp: `الحل:
1. تأكد من أن التوكن صحيح ولم تنته صلاحيته
2. إذا قمت بإنشاء توكن جديد، انقر "مسح التوكن القديم" ثم أدخل التوكن الجديد
3. تأكد من أن التوكن لديه صلاحية "repo" في GitHub`,
            dataLoadFailed: 'فشل تحميل البيانات',
            dataLoadFailedHelp: `قد يكون السبب:
1. التوكن ليس لديه صلاحية "repo"
2. مشكلة في الاتصال بـ GitHub
3. الملفات المطلوبة غير موجودة في المستودع`
        };
        
        // Google Maps variables
        let map = null;
        let markers = [];
        let mapSelectedShops = [];
        let infoWindow = null;
        let isMapInitialized = false;
        let newShopsAddedFromMap = []; // Track new shops added from map clicks
        
        // Get map configuration from loaded config
        const MAP_CONFIG = window.GOOGLE_MAPS_CONFIG ? window.GOOGLE_MAPS_CONFIG.mapConfig : {
            defaultCenter: { lat: 24.4539, lng: 54.3773 },
            defaultZoom: 12,
            maxZoom: 18,
            minZoom: 10
        };
        
        // Get feature configuration
        const FEATURE_CONFIG = window.GOOGLE_MAPS_CONFIG ? window.GOOGLE_MAPS_CONFIG.features : {
            nearbyRadius: 2000,
            geocodingBatchSize: 10,
            geocodingDelay: 100,
            areaOverlapOffset: 0.005
        };
        
        // Update Maps Status Indicator
        function updateMapsStatusIndicator(status, message) {
            const indicator = document.getElementById('mapsStatusIndicator');
            const button = document.getElementById('mapButton');
            
            if (!indicator) return;
            
            // Remove all classes
            indicator.className = 'maps-status-indicator';
            
            switch(status) {
                case 'loading':
                    indicator.classList.add('loading');
                    indicator.innerHTML = '⏳ ' + message;
                    if (button) button.classList.add('loading');
                    break;
                case 'ready':
                    indicator.innerHTML = '✅ ' + message;
                    if (button) button.classList.remove('loading');
                    break;
                case 'error':
                    indicator.classList.add('error');
                    indicator.innerHTML = '❌ ' + message;
                    if (button) button.classList.remove('loading');
                    break;
            }
        }
        
        // Initialize Google Maps using the new loader
        function initGoogleMaps() {
            console.log('🔍 Initializing Google Maps for store selection...');
            console.log('🔍 تهيئة خرائط جوجل لاختيار المحلات...');
            
            // Check if loader is available
            if (!window.googleMapsLoader) {
                console.error('❌ Google Maps Loader not available');
                console.error('❌ محمل خرائط جوجل غير متاح');
                updateMapsStatusIndicator('error', 'خطأ في النظام');
                return;
            }
            
            updateMapsStatusIndicator('loading', 'جاري تحميل خرائط جوجل...');
            
            // Set up event listeners for successful load
            window.googleMapsLoader.on('onLoad', () => {
                console.log('✅ Google Maps loaded successfully!');
                console.log('✅ تم تحميل خرائط جوجل بنجاح!');
                isMapInitialized = true;
                updateMapsStatusIndicator('ready', 'خرائط جوجل جاهزة ✓');
            });
            
            // Set up error handler
            window.googleMapsLoader.on('onError', (error) => {
                console.error('❌ Failed to load Google Maps:', error.message);
                console.error('❌ فشل تحميل خرائط جوجل:', error.message);
                isMapInitialized = false;
                updateMapsStatusIndicator('error', 'فشل التحميل');
            });
            
            // Set up retry handler
            window.googleMapsLoader.on('onRetry', (data) => {
                console.log(`🔄 Retrying... Attempt ${data.attempt}`);
                updateMapsStatusIndicator('loading', `محاولة ${data.attempt}...`);
            });
            
            // Start loading
            window.googleMapsLoader.init().catch(error => {
                console.error('💥 Critical error:', error);
            });
        }
        
        // Show Google Maps error dialog with troubleshooting
        function showGoogleMapsErrorDialog(error) {
            const errorType = getErrorType(error);
            let message = '❌ فشل تحميل خرائط جوجل\n\n';
            
            // Security: Only show if API key exists, not the actual value
            const apiKey = window.GOOGLE_MAPS_CONFIG ? window.GOOGLE_MAPS_CONFIG.apiKey : 'NOT SET';
            const apiKeyStatus = apiKey !== 'NOT SET' ? 'مُعيَّن (****)' : 'NOT SET';
            message += `🔑 مفتاح API: ${apiKeyStatus}\n\n`;
            
            switch (errorType) {
                case 'no-api-key':
                    message += '🔑 المشكلة: لم يتم تعيين مفتاح API صالح\n\n';
                    message += 'الحل:\n';
                    message += '1. افتح ملف google-maps-config.js\n';
                    message += '2. احصل على مفتاح API من:\n';
                    message += '   https://console.cloud.google.com/\n';
                    message += '3. فعّل Maps JavaScript API\n';
                    message += '4. فعّل Places API\n';
                    message += '5. فعّل Geocoding API\n';
                    message += '6. أعد إعداد الفوترة (مطلوب)\n';
                    message += '7. حدّث apiKey في الملف\n';
                    message += '8. تأكد من عدم وجود قيود على النطاق\n\n';
                    message += '💡 نصيحة: يمكنك استخدام المفتاح بدون قيود\n';
                    message += 'في مرحلة التطوير والتجربة\n';
                    break;
                    
                case 'auth-failure':
                    message += '🔒 المشكلة: خطأ في المصادقة\n\n';
                    message += 'الأسباب المحتملة:\n';
                    message += '• مفتاح API غير صالح أو منتهي\n';
                    message += '• لم يتم تفعيل الفوترة في Google Cloud\n';
                    message += '• لم يتم تفعيل الخدمات المطلوبة:\n';
                    message += '  - Maps JavaScript API\n';
                    message += '  - Places API\n';
                    message += '  - Geocoding API\n';
                    message += '• تم تجاوز الحد المسموح (Quota)\n';
                    message += '• قيود النطاق (Domain restrictions) غير صحيحة\n';
                    message += '  النطاق الحالي: ' + window.location.hostname + '\n\n';
                    message += 'الحلول:\n';
                    message += '1. تحقق من صحة مفتاح API في Google Cloud Console\n';
                    message += '2. تأكد من تفعيل الفوترة (Billing)\n';
                    message += '3. تأكد من تفعيل جميع الخدمات المطلوبة\n';
                    message += '4. راجع قيود API:\n';
                    message += '   - أزل قيود النطاق مؤقتاً للتجربة\n';
                    message += '   - أو أضف النطاق: ' + window.location.hostname + '\n';
                    message += '5. راجع حصة الاستخدام (Quotas)\n';
                    break;
                    
                case 'network-error':
                    message += '🌐 المشكلة: خطأ في الاتصال\n\n';
                    message += 'الحلول:\n';
                    message += '1. تحقق من اتصالك بالإنترنت\n';
                    message += '2. جرّب إعادة تحميل الصفحة (F5)\n';
                    message += '3. تأكد من عدم حظر خرائط جوجل\n';
                    message += '4. جرّب متصفحاً آخر\n';
                    message += '5. تحقق من جدار الحماية/Firewall\n';
                    message += '6. جرّب تعطيل مانع الإعلانات (AdBlock)\n';
                    break;
                    
                default:
                    message += '⚠️ المشكلة: ' + (error.message || 'خطأ غير معروف') + '\n\n';
                    message += 'الحلول المقترحة:\n';
                    message += '1. أعد تحميل الصفحة (F5)\n';
                    message += '2. امسح ذاكرة التخزين المؤقت (Ctrl+Shift+Delete)\n';
                    message += '3. افتح Console (F12) للمزيد من التفاصيل\n';
                    message += '4. تحقق من:\n';
                    message += '   - مفتاح API صالح\n';
                    message += '   - تفعيل الفوترة\n';
                    message += '   - تفعيل الخدمات المطلوبة\n';
                    message += '   - إزالة قيود النطاق\n';
                    message += '5. تواصل مع المطور\n';
            }
            
            message += '\n📚 للمزيد من المساعدة، راجع الملفات:\n';
            message += '• GOOGLE_MAPS_FIX_COMPLETE_SOLUTION_AR.md (✨ جديد! الحل الكامل)\n';
            message += '• GOOGLE_MAPS_RADICAL_FIX_SOLUTION.md\n';
            message += '• GOOGLE_MAPS_USER_GUIDE_AR.md\n';
            message += '• test-google-maps-fix.html (صفحة اختبار محدثة)\n';
            
            alert(message);
        }
        
        // Determine error type
        function getErrorType(error) {
            const message = error.message || '';
            
            if (message.includes('API key') || message.includes('apiKey')) {
                return 'no-api-key';
            } else if (message.includes('authentication') || message.includes('auth')) {
                return 'auth-failure';
            } else if (message.includes('network') || message.includes('timeout') || message.includes('load')) {
                return 'network-error';
            }
            
            return 'unknown';
        }
        
        // Google Maps Diagnostics Tool
        function openGoogleMapsDiagnostics() {
            let report = '🔍 تشخيص خرائط جوجل - Google Maps Diagnostics\n';
            report += '═══════════════════════════════════════════════════\n\n';
            
            // 1. Configuration Check
            report += '📋 التكوين - Configuration:\n';
            report += '─────────────────────────────────\n';
            
            const configLoaded = typeof window.GOOGLE_MAPS_CONFIG !== 'undefined';
            report += `✓ GOOGLE_MAPS_CONFIG: ${configLoaded ? '✅ محمّل' : '❌ غير محمّل'}\n`;
            
            const loaderLoaded = typeof window.googleMapsLoader !== 'undefined';
            report += `✓ googleMapsLoader: ${loaderLoaded ? '✅ محمّل' : '❌ غير محمّل'}\n`;
            
            if (configLoaded && window.GOOGLE_MAPS_CONFIG) {
                const apiKey = window.GOOGLE_MAPS_CONFIG.apiKey;
                const placeholder = window.API_KEY_PLACEHOLDER || 'REPLACE_WITH_YOUR_GOOGLE_MAPS_API_KEY';
                const apiKeySet = apiKey && apiKey !== placeholder;
                
                report += `✓ API Key: ${apiKeySet ? '✅ مُعيَّن' : '❌ غير مُعيَّن'}\n`;
                
                // Security: Don't show any part of the actual key
                if (apiKeySet) {
                    report += `  الحالة: مُعيَّن بشكل صحيح (****)\n`;
                }
                
                report += `✓ Libraries: ${window.GOOGLE_MAPS_CONFIG.libraries.join(', ')}\n`;
                report += `✓ Language: ${window.GOOGLE_MAPS_CONFIG.language}\n`;
                report += `✓ Region: ${window.GOOGLE_MAPS_CONFIG.region}\n`;
            }
            
            report += '\n';
            
            // 2. API Status
            report += '🌐 حالة API - API Status:\n';
            report += '─────────────────────────────────\n';
            
            const googleAvailable = typeof google !== 'undefined';
            report += `✓ google object: ${googleAvailable ? '✅ متاح' : '❌ غير متاح'}\n`;
            
            if (googleAvailable) {
                const mapsAvailable = typeof google.maps !== 'undefined';
                report += `✓ google.maps: ${mapsAvailable ? '✅ متاح' : '❌ غير متاح'}\n`;
                
                if (mapsAvailable) {
                    report += `✓ google.maps.Map: ${typeof google.maps.Map !== 'undefined' ? '✅ متاح' : '❌ غير متاح'}\n`;
                    report += `✓ google.maps.Marker: ${typeof google.maps.Marker !== 'undefined' ? '✅ متاح' : '❌ غير متاح'}\n`;
                    report += `✓ google.maps.InfoWindow: ${typeof google.maps.InfoWindow !== 'undefined' ? '✅ متاح' : '❌ غير متاح'}\n`;
                }
            }
            
            report += '\n';
            
            // 3. Loader Status
            report += '📦 حالة المحمّل - Loader Status:\n';
            report += '─────────────────────────────────\n';
            
            if (loaderLoaded && window.googleMapsLoader) {
                const status = window.googleMapsLoader.getStatus();
                report += `✓ Status: ${status}\n`;
                report += `✓ isLoaded: ${window.googleMapsLoader.isLoaded ? '✅ نعم' : '❌ لا'}\n`;
                report += `✓ isLoading: ${window.googleMapsLoader.isLoading ? '⏳ نعم' : '❌ لا'}\n`;
                report += `✓ loadAttempts: ${window.googleMapsLoader.loadAttempts}\n`;
            }
            
            report += '\n';
            
            // 4. Environment
            report += '🌍 البيئة - Environment:\n';
            report += '─────────────────────────────────\n';
            report += `✓ Domain: ${window.location.hostname}\n`;
            report += `✓ Protocol: ${window.location.protocol}\n`;
            report += `✓ URL: ${window.location.href}\n`;
            
            report += '\n';
            
            // 5. Recommendations
            report += '💡 التوصيات - Recommendations:\n';
            report += '─────────────────────────────────\n';
            
            if (!configLoaded) {
                report += '❌ تحميل google-maps-config.js فشل\n';
                report += '   → تحقق من مسار الملف\n\n';
            }
            
            if (!loaderLoaded) {
                report += '❌ تحميل google-maps-loader.js فشل\n';
                report += '   → تحقق من مسار الملف\n\n';
            }
            
            if (configLoaded && window.GOOGLE_MAPS_CONFIG) {
                const apiKey = window.GOOGLE_MAPS_CONFIG.apiKey;
                const placeholder = window.API_KEY_PLACEHOLDER || 'REPLACE_WITH_YOUR_GOOGLE_MAPS_API_KEY';
                const apiKeySet = apiKey && apiKey !== placeholder;
                
                if (!apiKeySet) {
                    report += '❌ مفتاح API غير مُعيَّن\n';
                    report += '   → افتح google-maps-config.js\n';
                    report += '   → ضع مفتاح API الصحيح في apiKey\n\n';
                }
            }
            
            if (!googleAvailable) {
                report += '❌ Google Maps API غير محمّل\n';
                report += '   → قد يكون مفتاح API غير صالح\n';
                report += '   → تحقق من تفعيل الفوترة\n';
                report += '   → تحقق من تفعيل الخدمات:\n';
                report += '     • Maps JavaScript API\n';
                report += '     • Places API\n';
                report += '     • Geocoding API\n';
                report += '   → راجع قيود النطاق في Google Console\n\n';
            }
            
            report += '\n📄 للمزيد من التفاصيل:\n';
            report += '   → افتح test_google_maps_integration.html\n';
            report += '   → راجع GOOGLE_MAPS_RADICAL_FIX_SOLUTION.md\n';
            report += '   → افتح Console (F12) للتفاصيل التقنية\n';
            
            alert(report);
            
            // Also log to console
            console.log('='.repeat(60));
            console.log('Google Maps Diagnostics Report');
            console.log('='.repeat(60));
            console.log(report);
            console.log('='.repeat(60));
        }
        
        // Legacy initMap function for backward compatibility
        function initMap() {
            console.log('✅ Google Maps API callback triggered');
            isMapInitialized = true;
            updateMapsStatusIndicator('ready', 'خرائط جوجل جاهزة');
        }
        
        // Auto-initialize Google Maps on page load
        window.addEventListener('load', function() {
            console.log('🔍 Page loaded, initializing Google Maps...');
            initGoogleMaps();
        });
        
        // Create the map when modal is opened (async version)
        async function createMap() {
            if (!document.getElementById('googleMap')) return;
            
            try {
                map = new google.maps.Map(document.getElementById('googleMap'), {
                    center: MAP_CONFIG.defaultCenter,
                    zoom: MAP_CONFIG.defaultZoom,
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                        position: google.maps.ControlPosition.TOP_RIGHT
                    },
                    zoomControl: true,
                    zoomControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_CENTER
                    },
                    streetViewControl: true,
                    fullscreenControl: true,
                    styles: [
                        {
                            featureType: "poi",
                            elementType: "labels",
                            stylers: [{ visibility: "on" }]
                        }
                    ]
                });
                
                infoWindow = new google.maps.InfoWindow();
                
                // Initialize Places Service for discovering new shops
                window.placesService = new google.maps.places.PlacesService(map);
                
                // Add click listener to map for direct shop addition
                map.addListener('click', async (event) => {
                    await handleMapClickForShopAddition(event);
                });
                
                // Load shop markers (async)
                await loadShopMarkers();
            } catch (error) {
                console.error('Error creating map:', error);
                alert('⚠️ حدث خطأ في إنشاء الخريطة. يرجى المحاولة مرة أخرى.');
            }
        }
        
        // Handle map click for direct shop addition
        async function handleMapClickForShopAddition(event) {
            const latLng = event.latLng;
            
            // Show loading indicator
            const loadingMarker = new google.maps.Marker({
                position: latLng,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#667eea',
                    fillOpacity: 0.6,
                    strokeColor: 'white',
                    strokeWeight: 2
                },
                animation: google.maps.Animation.BOUNCE
            });
            
            try {
                // Search for nearby places (pet shops, stores, etc.)
                const request = {
                    location: latLng,
                    radius: 50, // Search within 50 meters
                    type: ['pet_store', 'store', 'establishment']
                };
                
                const nearbyPlaces = await new Promise((resolve, reject) => {
                    window.placesService.nearbySearch(request, (results, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                            resolve(results);
                        } else {
                            resolve([]);
                        }
                    });
                });
                
                // Remove loading marker
                loadingMarker.setMap(null);
                
                if (nearbyPlaces.length === 0) {
                    // No shops found, show option to add custom shop
                    showAddCustomShopDialog(latLng);
                } else if (nearbyPlaces.length === 1) {
                    // Single shop found, get details and show
                    await showShopDetailsForAddition(nearbyPlaces[0], latLng);
                } else {
                    // Multiple shops found, let user choose
                    showShopSelectionDialog(nearbyPlaces, latLng);
                }
            } catch (error) {
                loadingMarker.setMap(null);
                console.error('Error handling map click:', error);
                alert('⚠️ حدث خطأ في البحث عن المحلات. حاول النقر مرة أخرى.');
            }
        }
        
        // Show dialog to select from multiple shops
        function showShopSelectionDialog(places, latLng) {
            // Validate coordinates
            const lat = parseFloat(latLng.lat());
            const lng = parseFloat(latLng.lng());
            
            if (isNaN(lat) || isNaN(lng)) {
                console.error('Invalid coordinates:', lat, lng);
                alert('⚠️ إحداثيات غير صالحة');
                return;
            }
            
            const content = `
                <div style="font-family: Cairo, Arial; direction: rtl; text-align: right; padding: 15px; min-width: 300px; max-width: 400px;">
                    <h3 style="margin: 0 0 15px 0; color: #2d3561;">🏪 اختر المحل المطلوب</h3>
                    <p style="margin-bottom: 10px; color: #666;">تم العثور على ${places.length} محلات في هذا الموقع:</p>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${places.map((place, index) => `
                            <div onclick="selectPlaceForAddition('${escapeJs(place.place_id)}', ${lat}, ${lng})" 
                                 style="padding: 12px; margin: 8px 0; background: #f8f9fa; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                                 onmouseover="this.style.borderColor='#667eea'; this.style.background='#e8eaf6';"
                                 onmouseout="this.style.borderColor='transparent'; this.style.background='#f8f9fa';">
                                <div style="font-weight: 600; color: #2d3561; margin-bottom: 4px;">
                                    ${escapeHtml(place.name)}
                                </div>
                                <div style="font-size: 0.85em; color: #666;">
                                    ${escapeHtml(place.vicinity || 'لا يوجد عنوان')}
                                </div>
                                ${place.rating ? `
                                    <div style="font-size: 0.8em; color: #ffc107; margin-top: 4px;">
                                        ⭐ ${parseFloat(place.rating).toFixed(1)} ${place.user_ratings_total ? `(${parseInt(place.user_ratings_total)})` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="closeInfoWindow()" style="margin-top: 15px; padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: Cairo; font-weight: 600;">
                        ❌ إلغاء
                    </button>
                </div>
            `;
            
            infoWindow.setContent(content);
            infoWindow.setPosition(latLng);
            infoWindow.open(map);
        }
        
        // Close info window helper
        function closeInfoWindow() {
            if (infoWindow) {
                infoWindow.close();
            }
        }
        
        // Select a place and show details
        async function selectPlaceForAddition(placeId, lat, lng) {
            closeInfoWindow();
            
            // Show loading
            const loadingContent = `
                <div style="font-family: Cairo, Arial; direction: rtl; text-align: center; padding: 20px;">
                    <div style="font-size: 2em; margin-bottom: 10px;">⏳</div>
                    <div>جاري تحميل تفاصيل المحل...</div>
                </div>
            `;
            infoWindow.setContent(loadingContent);
            infoWindow.setPosition({lat, lng});
            infoWindow.open(map);
            
            try {
                const request = {
                    placeId: placeId,
                    fields: ['name', 'formatted_address', 'formatted_phone_number', 'website', 'url', 'geometry', 'types', 'rating', 'user_ratings_total']
                };
                
                const placeDetails = await new Promise((resolve, reject) => {
                    window.placesService.getDetails(request, (place, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK && place) {
                            resolve(place);
                        } else {
                            reject(new Error('Failed to get place details'));
                        }
                    });
                });
                
                showShopDetailsForAddition(placeDetails, {lat, lng});
            } catch (error) {
                console.error('Error getting place details:', error);
                alert('⚠️ فشل تحميل تفاصيل المحل. حاول مرة أخرى.');
                closeInfoWindow();
            }
        }
        
        // Show shop details and allow direct addition
        async function showShopDetailsForAddition(place, latLng) {
            const position = place.geometry ? place.geometry.location : latLng;
            let lat = typeof position.lat === 'function' ? position.lat() : position.lat;
            let lng = typeof position.lng === 'function' ? position.lng() : position.lng;
            
            // Validate and sanitize coordinates
            lat = parseFloat(lat);
            lng = parseFloat(lng);
            
            if (isNaN(lat) || isNaN(lng)) {
                console.error('Invalid coordinates:', lat, lng);
                alert('⚠️ إحداثيات غير صالحة');
                return;
            }
            
            const googleMapsLink = place.url || `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
            
            const content = `
                <div style="font-family: Cairo, Arial; direction: rtl; text-align: right; padding: 15px; min-width: 350px; max-width: 450px;">
                    <h3 style="margin: 0 0 15px 0; color: #2d3561; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                        🏪 إضافة محل جديد
                    </h3>
                    
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #2d3561;">الاسم:</strong>
                            <div style="margin-top: 5px;">
                                <input type="text" id="newShopName" value="${escapeHtml(place.name || '')}" 
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: Cairo;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #2d3561;">العنوان:</strong>
                            <div style="margin-top: 5px;">
                                <input type="text" id="newShopAddress" value="${escapeHtml(place.formatted_address || place.vicinity || '')}" 
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: Cairo;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #2d3561;">رقم الهاتف:</strong>
                            <div style="margin-top: 5px;">
                                <input type="text" id="newShopPhone" value="${escapeHtml(place.formatted_phone_number || '')}" 
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: Cairo;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #2d3561;">المنطقة:</strong>
                            <div style="margin-top: 5px;">
                                <select id="newShopArea" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: Cairo;">
                                    <option value="">اختر المنطقة...</option>
                                    ${getAreasForDropdown()}
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #2d3561;">رقم الترخيص:</strong>
                            <div style="margin-top: 5px;">
                                <input type="text" id="newShopLicense" value="" placeholder="اختياري" 
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: Cairo;">
                            </div>
                        </div>
                        
                        ${place.rating ? `
                            <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 5px;">
                                <strong style="color: #2d3561;">التقييم:</strong>
                                <span style="color: #ffc107;">⭐ ${parseFloat(place.rating).toFixed(1)}</span>
                                ${place.user_ratings_total ? `<span style="color: #666; font-size: 0.9em;"> (${parseInt(place.user_ratings_total)} تقييم)</span>` : ''}
                            </div>
                        ` : ''}
                        
                        <div style="font-size: 0.85em; color: #666; margin-top: 8px;">
                            📍 الإحداثيات: ${lat.toFixed(6)}, ${lng.toFixed(6)}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="addNewShopDirectly('${lat}', '${lng}', '${googleMapsLink.replace(/'/g, "\\'")}')" 
                                style="flex: 1; padding: 12px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: Cairo; font-weight: 600; font-size: 1em;">
                            ✅ إضافة للتفتيش مباشرة
                        </button>
                        <button onclick="closeInfoWindow()" 
                                style="padding: 12px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: Cairo; font-weight: 600;">
                            ❌ إلغاء
                        </button>
                    </div>
                </div>
            `;
            
            infoWindow.setContent(content);
            infoWindow.setPosition({lat, lng});
            infoWindow.open(map);
        }
        
        // Get areas for dropdown
        function getAreasForDropdown() {
            if (!shopsDetails) return '<option value="">لا توجد مناطق</option>';
            
            const areas = [...new Set(Object.values(shopsDetails)
                .filter(shop => shop && shop.area)
                .map(shop => shop.area))].sort();
            
            return areas.map(area => `<option value="${escapeHtml(area)}">${escapeHtml(area)}</option>`).join('');
        }
        
        // Add new shop directly to inspection
        async function addNewShopDirectly(lat, lng, googleMapsLink) {
            const name = document.getElementById('newShopName')?.value?.trim();
            const address = document.getElementById('newShopAddress')?.value?.trim();
            const phone = document.getElementById('newShopPhone')?.value?.trim();
            const area = document.getElementById('newShopArea')?.value;
            const license = document.getElementById('newShopLicense')?.value?.trim();
            
            if (!name) {
                alert('⚠️ يرجى إدخال اسم المحل');
                return;
            }
            
            if (!area) {
                alert('⚠️ يرجى اختيار المنطقة');
                return;
            }
            
            const inspector = document.getElementById('mapInspectorSelect')?.value;
            const date = document.getElementById('mapInspectionDate')?.value;
            
            if (!inspector || !date) {
                alert('⚠️ يرجى اختيار المفتش والتاريخ أولاً من الأعلى');
                closeInfoWindow();
                return;
            }
            
            try {
                // Generate unique shop ID
                const timestamp = Date.now();
                const shopId = `shop_${timestamp}`;
                
                // Generate ADM code (auto-increment from existing)
                const existingCodes = Object.values(shopsDetails || {})
                    .map(s => s.admCode)
                    .filter(code => code && code.startsWith('ADM'))
                    .map(code => parseInt(code.replace('ADM', '')))
                    .filter(num => !isNaN(num));
                
                const nextCodeNum = existingCodes.length > 0 ? Math.max(...existingCodes) + 1 : 1;
                const admCode = `ADM${String(nextCodeNum).padStart(4, '0')}`;
                
                // Create new shop object
                const newShop = {
                    nameAr: name,
                    nameEn: '',
                    licenseNo: license || '',
                    locationMap: googleMapsLink,
                    admCode: admCode,
                    address: address || '',
                    contact: phone || '',
                    activity: '',
                    area: area,
                    areaId: findAreaId(area)
                };
                
                // Add to shops details
                shopsDetails[name] = newShop;
                
                // Track new shop for saving
                if (!newShopsAddedFromMap.includes(name)) {
                    newShopsAddedFromMap.push(name);
                }
                
                // Add to map selection
                if (!mapSelectedShops.includes(name)) {
                    mapSelectedShops.push(name);
                }
                
                // Close info window
                closeInfoWindow();
                
                // Reload map markers to show the new shop
                await loadShopMarkers();
                
                // Update UI
                updateMapSelection();
                
                // Show success message
                alert(`✅ تمت إضافة المحل "${name}" بنجاح!\n\nكود ADM: ${admCode}\nالمنطقة: ${area}\n\nالمحل مختار ومجهز للحفظ.\n\nملاحظة: سيتم حفظ بيانات المحل الجديد عند النقر على "حفظ التفتيش مباشرة" أو "تطبيق الاختيار".`);
                
                console.log('✅ New shop added:', newShop);
            } catch (error) {
                console.error('Error adding new shop:', error);
                alert('⚠️ حدث خطأ أثناء إضافة المحل. حاول مرة أخرى.');
            }
        }
        
        // Find area ID by area name
        function findAreaId(areaName) {
            if (!shopsDetails) return '';
            
            const shop = Object.values(shopsDetails).find(s => s && s.area === areaName);
            return shop?.areaId || '';
        }
        
        // Show dialog to add custom shop (when no shop found at click location)
        function showAddCustomShopDialog(latLng) {
            const lat = latLng.lat();
            const lng = latLng.lng();
            const googleMapsLink = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
            
            // Create a simple place object for the custom location
            const customPlace = {
                name: '',
                formatted_address: '',
                formatted_phone_number: '',
                url: googleMapsLink,
                geometry: { location: latLng }
            };
            
            showShopDetailsForAddition(customPlace, latLng);
        }
        
        // Load shop markers on the map (async version with geocoding support and batch processing)
        async function loadShopMarkers() {
            if (!map || !shopsDetails) return;
            
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            const bounds = new google.maps.LatLngBounds();
            let hasValidCoordinates = false;
            let pendingGeocodingCount = 0;
            let geocodedCount = 0;
            
            // Get available shops based on current filters
            const availableShopNames = getAvailableShopsForMap();
            
            // Show loading message
            console.log('Loading shop markers...');
            
            // Prepare shops for processing
            const shopsToProcess = Object.keys(shopsDetails).map(shopName => ({
                shopName,
                shop: shopsDetails[shopName]
            })).filter(({ shop }) => shop && (shop.locationMap || shop.address));
            
            // Process shops in batches to avoid rate limiting
            const batchSize = FEATURE_CONFIG.geocodingBatchSize;
            const allResults = [];
            
            for (let i = 0; i < shopsToProcess.length; i += batchSize) {
                const batch = shopsToProcess.slice(i, i + batchSize);
                
                const batchPromises = batch.map(async ({ shopName, shop }) => {
                    // Extract coordinates from Google Maps link
                    let locationData = extractCoordinatesFromLink(shop.locationMap);
                    let accuracy = 'none';
                    let coords = null;
                    
                    // If we have location data from link
                    if (locationData) {
                        coords = locationData.coords;
                        accuracy = locationData.accuracy;
                    }
                    
                    // If coordinates not found and we have a location link or address, try geocoding
                    if (!coords && (shop.locationMap || shop.address)) {
                        pendingGeocodingCount++;
                        const geocodedData = await geocodeShopLocation(shop, shopName);
                        if (geocodedData) {
                            coords = geocodedData.coords;
                            accuracy = geocodedData.accuracy;
                            geocodedCount++;
                            // Cache the coordinates for this shop
                            if (shop.locationMap) {
                                coordinatesCache[shop.locationMap] = geocodedData;
                            }
                        }
                    }
                    
                    if (coords) {
                        const isAvailable = availableShopNames.includes(shopName);
                        const isSelected = mapSelectedShops.includes(shopName);
                        const priority = getShopPriority(shopName);
                        
                        // Determine marker color based on status
                        let markerColor = '#999999'; // Gray for unavailable
                        if (isSelected) {
                            markerColor = '#28a745'; // Green for selected
                        } else if (isAvailable) {
                            if (priority === 'very-high') markerColor = '#8b0000';
                            else if (priority === 'high') markerColor = '#dc3545';
                            else if (priority === 'medium') markerColor = '#ffc107';
                            else markerColor = '#667eea';
                        }
                        
                        // Determine stroke color based on accuracy level
                        let strokeColor = 'white';
                        let strokeWeight = 2;
                        if (accuracy === 'high') {
                            strokeColor = '#00ff00'; // Bright green for high accuracy
                            strokeWeight = 3;
                        } else if (accuracy === 'medium') {
                            strokeColor = '#ffaa00'; // Orange for medium accuracy
                            strokeWeight = 3;
                        } else if (accuracy === 'low') {
                            strokeColor = '#ff0000'; // Red for low accuracy
                            strokeWeight = 3;
                        }
                        
                        const marker = new google.maps.Marker({
                            position: coords,
                            map: map,
                            title: shop.nameAr || shopName,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: isSelected ? 12 : 8,
                                fillColor: markerColor,
                                fillOpacity: isSelected ? 1 : 0.8,
                                strokeColor: strokeColor,
                                strokeWeight: strokeWeight
                            },
                            shopName: shopName,
                            shopData: shop,
                            isAvailable: isAvailable,
                            locationAccuracy: accuracy
                        });
                        
                        // Add click event to marker
                        marker.addListener('click', () => {
                            if (!marker.isAvailable) {
                                showInfoWindow(marker, 'هذا المحل غير متاح للاختيار حالياً');
                                return;
                            }
                            
                            toggleShopSelection(marker);
                        });
                        
                        // Add hover event
                        marker.addListener('mouseover', () => {
                            showInfoWindow(marker, null);
                        });
                        
                        return { marker, coords, accuracy };
                    }
                    
                    return null;
                });
                
                // Wait for current batch to complete
                const batchResults = await Promise.all(batchPromises);
                allResults.push(...batchResults);
                
                // Add delay between batches to avoid rate limiting
                if (i + batchSize < shopsToProcess.length) {
                    await new Promise(resolve => setTimeout(resolve, FEATURE_CONFIG.geocodingDelay));
                }
            }
            
            // Add markers to map and bounds
            allResults.forEach(result => {
                if (result) {
                    markers.push(result.marker);
                    bounds.extend(result.coords);
                    hasValidCoordinates = true;
                }
            });
            
            console.log(`Loaded ${markers.length} shop markers (${geocodedCount} geocoded from ${pendingGeocodingCount} attempts)`);
            
            // Fit map to show all markers
            if (hasValidCoordinates) {
                map.fitBounds(bounds);
                // Don't zoom in too much if only one marker
                google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
                    if (map.getZoom() > MAP_CONFIG.maxZoom) {
                        map.setZoom(MAP_CONFIG.maxZoom);
                    }
                });
            } else {
                // If no valid coordinates, center on Abu Dhabi
                map.setCenter(MAP_CONFIG.defaultCenter);
                map.setZoom(MAP_CONFIG.defaultZoom);
            }
            
            updateMapStats();
        }
        
        // Geocode shop location using Google Maps Geocoding API
        // Returns: { coords: {lat, lng}, accuracy: 'high'|'medium'|'low' }
        async function geocodeShopLocation(shop, shopName) {
            // Create a geocoder instance
            if (!window.geocoder) {
                window.geocoder = new google.maps.Geocoder();
            }
            
            try {
                // Try geocoding by address first
                if (shop.address) {
                    const fullAddress = shop.address + ', Abu Dhabi, UAE';
                    const request = {
                        address: fullAddress,
                        region: 'AE'
                    };
                    
                    const result = await new Promise((resolve, reject) => {
                        window.geocoder.geocode(request, (results, status) => {
                            if (status === 'OK' && results && results[0]) {
                                resolve(results[0]);
                            } else {
                                reject(new Error(`Geocoding failed for '${fullAddress}': ${status}`));
                            }
                        });
                    });
                    
                    if (result && result.geometry && result.geometry.location) {
                        return {
                            coords: {
                                lat: result.geometry.location.lat(),
                                lng: result.geometry.location.lng()
                            },
                            accuracy: 'medium' // Geocoded from address
                        };
                    }
                }
                
                // If address geocoding failed and we have an area, try geocoding by area
                if (shop.area) {
                    const fullAddress = shop.area + ', Abu Dhabi, UAE';
                    const request = {
                        address: fullAddress,
                        region: 'AE'
                    };
                    
                    const result = await new Promise((resolve, reject) => {
                        window.geocoder.geocode(request, (results, status) => {
                            if (status === 'OK' && results && results[0]) {
                                resolve(results[0]);
                            } else {
                                reject(new Error(`Geocoding failed for '${fullAddress}': ${status}`));
                            }
                        });
                    });
                    
                    if (result && result.geometry && result.geometry.location) {
                        // Add small random offset to avoid overlapping markers in same area
                        const randomOffset = () => (Math.random() - 0.5) * MAP_CONFIG.areaOverlapOffset;
                        return {
                            coords: {
                                lat: result.geometry.location.lat() + randomOffset(),
                                lng: result.geometry.location.lng() + randomOffset()
                            },
                            accuracy: 'low' // Geocoded from area only
                        };
                    }
                }
                
                return null;
            } catch (error) {
                console.warn(`Geocoding failed for shop '${shopName}' (${shop.nameAr || 'Unknown'}):`, error.message);
                return null;
            }
        }
        
        // Cache for resolved coordinates to avoid repeated API calls
        const coordinatesCache = {};
        
        // Synchronous version that returns null for short links (to be resolved via geocoding)
        // Returns: { coords: {lat, lng}, accuracy: 'high' } or null
        function extractCoordinatesFromLink(link) {
            if (!link) return null;
            
            // Check cache first
            if (coordinatesCache[link]) {
                return coordinatesCache[link];
            }
            
            try {
                // Only handle links that can be processed synchronously
                // Format 1: google.com/maps with @lat,lng
                if (link.includes('@')) {
                    const match = link.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
                    if (match) {
                        const result = {
                            coords: {
                                lat: parseFloat(match[1]),
                                lng: parseFloat(match[2])
                            },
                            accuracy: 'high' // Direct coordinates from Google Maps link
                        };
                        coordinatesCache[link] = result;
                        return result;
                    }
                }
                
                // Format 2: Try to extract from query parameters (?q=lat,lng)
                try {
                    const url = new URL(link);
                    if (url.searchParams.has('q')) {
                        const q = url.searchParams.get('q');
                        const match = q.match(/(-?\d+\.\d+),\s*(-?\d+\.\d+)/);
                        if (match) {
                            const result = {
                                coords: {
                                    lat: parseFloat(match[1]),
                                    lng: parseFloat(match[2])
                                },
                                accuracy: 'high' // Direct coordinates from Google Maps link
                            };
                            coordinatesCache[link] = result;
                            return result;
                        }
                    }
                } catch (urlError) {
                    // Not a valid URL, continue
                }
                
                // For short links (maps.app.goo.gl, goo.gl), return null
                // These will be resolved via geocoding using the shop's address
                if (link.includes('maps.app.goo.gl') || link.includes('goo.gl')) {
                    console.log('Short link detected, will use geocoding:', link);
                    return null;
                }
                
                return null;
            } catch (e) {
                console.error('Error extracting coordinates from link:', link, e);
                return null;
            }
        }
        
        // Get available shops for map based on filters
        function getAvailableShopsForMap() {
            const inspector = document.getElementById('mapInspectorSelect').value;
            const date = document.getElementById('mapInspectionDate').value;
            const area = document.getElementById('mapAreaSelect').value;
            
            if (!inspector || !date) {
                return []; // Return empty if inspector or date not selected
            }
            
            // Get all shops
            let availableShops = Object.keys(shopsDetails).filter(shopName => {
                const shop = shopsDetails[shopName];
                return shop && shop.nameAr;
            });
            
            // Filter by area if selected
            if (area) {
                availableShops = availableShops.filter(shopName => {
                    const shop = shopsDetails[shopName];
                    return shop.area === area;
                });
            }
            
            // Filter out shops already inspected on this date
            const inspectedShops = getInspectedShopsOnDate(date);
            availableShops = availableShops.filter(shop => !inspectedShops.includes(shop));
            
            return availableShops;
        }
        
        // Get inspected shops on a specific date
        function getInspectedShopsOnDate(date) {
            if (!planData || !planData.inspectionData) return [];
            
            const inspected = [];
            planData.inspectionData.forEach(inspection => {
                if (inspection.day === date) {
                    inspected.push(...inspection.shops);
                }
            });
            
            return inspected;
        }
        
        // Toggle shop selection on map
        function toggleShopSelection(marker) {
            const shopName = marker.shopName;
            const index = mapSelectedShops.indexOf(shopName);
            const accuracy = marker.locationAccuracy || 'none';
            
            // Determine stroke color based on accuracy level
            let strokeColor = 'white';
            let strokeWeight = 2;
            if (accuracy === 'high') {
                strokeColor = '#00ff00'; // Bright green for high accuracy
                strokeWeight = 3;
            } else if (accuracy === 'medium') {
                strokeColor = '#ffaa00'; // Orange for medium accuracy
                strokeWeight = 3;
            } else if (accuracy === 'low') {
                strokeColor = '#ff0000'; // Red for low accuracy
                strokeWeight = 3;
            }
            
            if (index > -1) {
                // Deselect
                mapSelectedShops.splice(index, 1);
                marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: getPriorityColor(shopName),
                    fillOpacity: 0.8,
                    strokeColor: strokeColor,
                    strokeWeight: strokeWeight
                });
            } else {
                // Select
                mapSelectedShops.push(shopName);
                marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#28a745',
                    fillOpacity: 1,
                    strokeColor: strokeColor,
                    strokeWeight: strokeWeight
                });
            }
            
            updateMapSelection();
        }
        
        // Get priority color for a shop
        function getPriorityColor(shopName) {
            const priority = getShopPriority(shopName);
            if (priority === 'very-high') return '#8b0000';
            if (priority === 'high') return '#dc3545';
            if (priority === 'medium') return '#ffc107';
            return '#667eea';
        }
        
        // Show info window for marker
        function showInfoWindow(marker, customMessage) {
            const shop = marker.shopData;
            const shopName = marker.shopName;
            const priority = getShopPriority(shopName);
            const accuracy = marker.locationAccuracy || 'none';
            
            let priorityText = '';
            if (priority === 'very-high') priorityText = '🔴 أولوية عالية جداً';
            else if (priority === 'high') priorityText = '🔴 أولوية عالية';
            else if (priority === 'medium') priorityText = '🟡 أولوية متوسطة';
            else priorityText = '🟢 أولوية منخفضة';
            
            // Accuracy indicator
            let accuracyText = '';
            let accuracyColor = '#999';
            let accuracyIcon = '❓';
            if (accuracy === 'high') {
                accuracyText = 'دقة عالية - من رابط الموقع المباشر';
                accuracyColor = '#00c853';
                accuracyIcon = '🎯';
            } else if (accuracy === 'medium') {
                accuracyText = 'دقة متوسطة - من العنوان';
                accuracyColor = '#ff9800';
                accuracyIcon = '📍';
            } else if (accuracy === 'low') {
                accuracyText = 'دقة منخفضة - من المنطقة فقط';
                accuracyColor = '#f44336';
                accuracyIcon = '⚠️';
            } else {
                accuracyText = 'موقع غير محدد';
                accuracyColor = '#999';
                accuracyIcon = '❓';
            }
            
            const content = customMessage || `
                <div style="font-family: Cairo, Arial; direction: rtl; text-align: right; padding: 10px; min-width: 250px;">
                    <h3 style="margin: 0 0 10px 0; color: #2d3561;">${shop.nameAr || shopName}</h3>
                    ${shop.nameEn ? `<p style="margin: 5px 0; color: #666;"><strong>English:</strong> ${shop.nameEn}</p>` : ''}
                    ${shop.admCode ? `<p style="margin: 5px 0;"><strong>كود ADM:</strong> ${shop.admCode}</p>` : ''}
                    ${shop.licenseNo ? `<p style="margin: 5px 0;"><strong>رقم الترخيص:</strong> ${shop.licenseNo}</p>` : ''}
                    ${shop.address ? `<p style="margin: 5px 0;"><strong>العنوان:</strong> ${shop.address}</p>` : ''}
                    ${shop.area ? `<p style="margin: 5px 0;"><strong>المنطقة:</strong> ${shop.area}</p>` : ''}
                    <p style="margin: 5px 0;"><strong>الأولوية:</strong> ${priorityText}</p>
                    <div style="margin: 10px 0; padding: 8px; background: #f5f5f5; border-radius: 5px; border-right: 4px solid ${accuracyColor};">
                        <strong style="color: ${accuracyColor};">${accuracyIcon} دقة الموقع:</strong><br>
                        <span style="font-size: 0.9em; color: #666;">${accuracyText}</span>
                    </div>
                    ${marker.isAvailable ? 
                        `<p style="margin: 10px 0 0 0; color: #28a745; font-weight: 600;">✅ متاح للاختيار</p>` : 
                        `<p style="margin: 10px 0 0 0; color: #dc3545; font-weight: 600;">❌ غير متاح</p>`
                    }
                </div>
            `;
            
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
        }
        
        // Update map selection display
        function updateMapSelection() {
            const container = document.getElementById('selectedShopsOnMap');
            const tagsContainer = document.getElementById('selectedShopTags');
            const countElement = document.getElementById('mapSelectedCount');
            
            countElement.textContent = mapSelectedShops.length;
            
            if (mapSelectedShops.length > 0) {
                container.style.display = 'block';
                tagsContainer.innerHTML = mapSelectedShops.map(shopName => {
                    const shop = shopsDetails[shopName];
                    return `
                        <span class="selected-shop-tag">
                            <span class="remove" onclick="removeShopFromMapSelection('${shopName}')">✖</span>
                            ${shop?.nameAr || shopName}
                        </span>
                    `;
                }).join('');
            } else {
                container.style.display = 'none';
            }
            
            // Update buttons
            const applyBtn = document.getElementById('applyMapBtn');
            const saveBtn = document.getElementById('saveFromMapBtn');
            const inspector = document.getElementById('mapInspectorSelect').value;
            const date = document.getElementById('mapInspectionDate').value;
            
            const canProceed = mapSelectedShops.length > 0 && inspector && date;
            applyBtn.disabled = !canProceed;
            saveBtn.disabled = !canProceed;
            
            updateMapStats();
        }
        
        // Remove shop from map selection
        function removeShopFromMapSelection(shopName) {
            const index = mapSelectedShops.indexOf(shopName);
            if (index > -1) {
                mapSelectedShops.splice(index, 1);
                
                // Update marker
                const marker = markers.find(m => m.shopName === shopName);
                if (marker) {
                    const accuracy = marker.locationAccuracy || 'none';
                    
                    // Determine stroke color based on accuracy level
                    let strokeColor = 'white';
                    let strokeWeight = 2;
                    if (accuracy === 'high') {
                        strokeColor = '#00ff00'; // Bright green for high accuracy
                        strokeWeight = 3;
                    } else if (accuracy === 'medium') {
                        strokeColor = '#ffaa00'; // Orange for medium accuracy
                        strokeWeight = 3;
                    } else if (accuracy === 'low') {
                        strokeColor = '#ff0000'; // Red for low accuracy
                        strokeWeight = 3;
                    }
                    
                    marker.setIcon({
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: getPriorityColor(shopName),
                        fillOpacity: 0.8,
                        strokeColor: strokeColor,
                        strokeWeight: strokeWeight
                    });
                }
                
                updateMapSelection();
            }
        }
        
        // Update map statistics
        function updateMapStats() {
            const totalShops = Object.keys(shopsDetails).length;
            const availableShops = getAvailableShopsForMap().length;
            const selectedShops = mapSelectedShops.length;
            const highPriorityShops = getAvailableShopsForMap().filter(shop => {
                const priority = getShopPriority(shop);
                return priority === 'high' || priority === 'very-high';
            }).length;
            
            // Count accuracy levels
            let highAccuracyCount = 0;
            let mediumAccuracyCount = 0;
            let lowAccuracyCount = 0;
            
            markers.forEach(marker => {
                const accuracy = marker.locationAccuracy || 'none';
                if (accuracy === 'high') highAccuracyCount++;
                else if (accuracy === 'medium') mediumAccuracyCount++;
                else if (accuracy === 'low') lowAccuracyCount++;
            });
            
            document.getElementById('mapTotalShops').textContent = totalShops;
            document.getElementById('mapAvailableShops').textContent = availableShops;
            document.getElementById('mapSelectedShops').textContent = selectedShops;
            document.getElementById('mapHighPriorityShops').textContent = highPriorityShops;
            
            // Update accuracy counts
            document.getElementById('accuracyHighCount').textContent = highAccuracyCount;
            document.getElementById('accuracyMediumCount').textContent = mediumAccuracyCount;
            document.getElementById('accuracyLowCount').textContent = lowAccuracyCount;
        }
        
        // Helper functions for map tools
        function selectNearbyShops() {
            if (mapSelectedShops.length === 0) {
                showMapNotification('⚠️ اختر محل واحد على الأقل أولاً لاختيار المحلات القريبة منه', 'warning');
                return;
            }
            
            // Get the center of currently selected shops
            const selectedMarkers = markers.filter(m => mapSelectedShops.includes(m.shopName));
            if (selectedMarkers.length === 0) return;
            
            let centerLat = 0, centerLng = 0;
            selectedMarkers.forEach(marker => {
                centerLat += marker.getPosition().lat();
                centerLng += marker.getPosition().lng();
            });
            centerLat /= selectedMarkers.length;
            centerLng /= selectedMarkers.length;
            
            // Find nearby shops using configurable radius
            const radius = FEATURE_CONFIG.nearbyRadius;
            const availableShops = getAvailableShopsForMap();
            
            let addedCount = 0;
            markers.forEach(marker => {
                if (!marker.isAvailable || mapSelectedShops.includes(marker.shopName)) return;
                
                const distance = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(centerLat, centerLng),
                    marker.getPosition()
                );
                
                if (distance <= radius) {
                    mapSelectedShops.push(marker.shopName);
                    marker.setIcon({
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: '#28a745',
                        fillOpacity: 1,
                        strokeColor: 'white',
                        strokeWeight: 2
                    });
                    addedCount++;
                }
            });
            
            updateMapSelection();
            showMapNotification(`✅ تم إضافة ${addedCount} محل قريب`, 'success');
        }
        
        // Show notification in map modal
        function showMapNotification(message, type) {
            // For now, use console and simple UI feedback
            console.log(`[${type}] ${message}`);
            // Could be enhanced with a custom notification system later
            if (type === 'error' || type === 'warning') {
                alert(message);
            }
        }
        
        function selectHighPriorityShops() {
            const availableShops = getAvailableShopsForMap();
            
            markers.forEach(marker => {
                if (!marker.isAvailable || mapSelectedShops.includes(marker.shopName)) return;
                
                const priority = getShopPriority(marker.shopName);
                if (priority === 'high' || priority === 'very-high') {
                    mapSelectedShops.push(marker.shopName);
                    marker.setIcon({
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: '#28a745',
                        fillOpacity: 1,
                        strokeColor: 'white',
                        strokeWeight: 2
                    });
                }
            });
            
            updateMapSelection();
        }
        
        function clearMapSelection() {
            mapSelectedShops = [];
            markers.forEach(marker => {
                if (marker.isAvailable) {
                    marker.setIcon({
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: getPriorityColor(marker.shopName),
                        fillOpacity: 0.8,
                        strokeColor: 'white',
                        strokeWeight: 2
                    });
                }
            });
            updateMapSelection();
        }
        
        function zoomToSelectedShops() {
            if (mapSelectedShops.length === 0) {
                showMapNotification('⚠️ لم يتم اختيار أي محلات', 'warning');
                return;
            }
            
            const bounds = new google.maps.LatLngBounds();
            markers.forEach(marker => {
                if (mapSelectedShops.includes(marker.shopName)) {
                    bounds.extend(marker.getPosition());
                }
            });
            
            map.fitBounds(bounds);
        }
        
        function showAllShops() {
            const bounds = new google.maps.LatLngBounds();
            markers.forEach(marker => {
                bounds.extend(marker.getPosition());
            });
            map.fitBounds(bounds);
        }
        
        // Open map modal
        async function openMapModal() {
            // Check if Google Maps API is available
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.error('❌ Google Maps API not loaded');
                
                // Check if loader is still trying
                if (window.googleMapsLoader && window.googleMapsLoader.isLoading) {
                    alert(
                        '⏳ جاري تحميل خرائط جوجل...\n\n' +
                        'الرجاء الانتظار قليلاً ثم المحاولة مرة أخرى.\n' +
                        'يمكنك مراقبة حالة التحميل من المؤشر في الأعلى.'
                    );
                    return;
                }
                
                const action = confirm(
                    '⚠️ خرائط جوجل غير محملة حالياً\n\n' +
                    'هذا قد يحدث بسبب:\n' +
                    '• لم يتم تعيين مفتاح API صالح\n' +
                    '• بطء في الاتصال بالإنترنت\n' +
                    '• مشكلة في مفتاح API أو الفوترة\n' +
                    '• حظر الوصول لخرائط جوجل\n\n' +
                    'انقر OK لإعادة محاولة التحميل\n' +
                    'انقر Cancel لإعادة تحميل الصفحة'
                );
                
                if (action) {
                    // Try to reinitialize
                    if (window.googleMapsLoader) {
                        updateMapsStatusIndicator('loading', 'إعادة المحاولة...');
                        window.googleMapsLoader.init().catch(error => {
                            showGoogleMapsErrorDialog(error);
                        });
                    }
                } else {
                    window.location.reload();
                }
                return;
            }
            
            // Force initialization if not done yet
            if (!isMapInitialized) {
                console.log('🔧 Marking Google Maps as initialized...');
                isMapInitialized = true;
                updateMapsStatusIndicator('ready', 'خرائط جوجل جاهزة');
            }
            
            if (!planData || !shopsDetails) {
                alert('⚠️ يرجى تحميل البيانات أولاً');
                return;
            }
            
            // Show modal
            document.getElementById('mapModal').classList.add('show');
            
            // Populate inspector dropdown
            populateMapInspectorDropdown();
            
            // Populate area dropdown
            populateMapAreaDropdown();
            
            // Initialize map if not already done (async)
            setTimeout(async () => {
                if (!map) {
                    await createMap();
                } else {
                    await loadShopMarkers();
                }
            }, 300);
        }
        
        // Close map modal
        function closeMapModal() {
            document.getElementById('mapModal').classList.remove('show');
            mapSelectedShops = [];
        }
        
        // Populate inspector dropdown for map
        function populateMapInspectorDropdown() {
            const select = document.getElementById('mapInspectorSelect');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">اختر المفتش...</option>';
            
            if (!planData || !planData.inspectionData) return;
            
            const inspectors = [...new Set(planData.inspectionData.map(i => i.inspector))].sort();
            
            inspectors.forEach(inspector => {
                const option = document.createElement('option');
                option.value = inspector;
                option.textContent = inspector;
                if (inspector === currentValue) option.selected = true;
                select.appendChild(option);
            });
        }
        
        // Populate area dropdown for map
        function populateMapAreaDropdown() {
            const select = document.getElementById('mapAreaSelect');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">جميع المناطق</option>';
            
            if (!shopsDetails) return;
            
            const areas = [...new Set(Object.values(shopsDetails)
                .filter(shop => shop && shop.area)
                .map(shop => shop.area))].sort();
            
            areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                if (area === currentValue) option.selected = true;
                select.appendChild(option);
            });
        }
        
        // Update map controls
        async function updateMapControls() {
            if (map) {
                await loadShopMarkers();
            }
        }
        
        // Filter shops by area on map
        async function filterShopsByArea() {
            if (map) {
                await loadShopMarkers();
            }
        }
        
        // Apply map selection to main form
        async function applyMapSelection() {
            if (mapSelectedShops.length === 0) {
                alert('⚠️ يرجى اختيار محل واحد على الأقل');
                return;
            }
            
            const inspector = document.getElementById('mapInspectorSelect').value;
            const date = document.getElementById('mapInspectionDate').value;
            const shift = document.getElementById('mapShiftSelect').value;
            
            if (!inspector || !date) {
                alert('⚠️ يرجى اختيار المفتش والتاريخ');
                return;
            }
            
            // If new shops were added, save them first
            if (newShopsAddedFromMap.length > 0) {
                try {
                    const shopNames = newShopsAddedFromMap.join(', ');
                    await saveShopsDetailsToGitHub(`إضافة محلات جديدة من الخريطة: ${shopNames}`);
                    alert(`✅ تم حفظ ${newShopsAddedFromMap.length} محل جديد بنجاح!`);
                    console.log('✅ Saved new shops to shops_details.json:', newShopsAddedFromMap);
                    newShopsAddedFromMap = [];
                } catch (error) {
                    alert('❌ حدث خطأ في حفظ المحلات الجديدة: ' + error.message + '\n\nسيتم تطبيق الاختيار لكن المحلات الجديدة لن يتم حفظها بشكل دائم.');
                }
            }
            
            // Fill the main form
            document.getElementById('inspectorSelect').value = inspector;
            document.getElementById('inspectionDate').value = date;
            document.getElementById('shiftSelect').value = shift;
            
            // Set selected shops
            selectedShops = [...mapSelectedShops];
            
            // Update the main form display
            updateAvailableShops();
            updateSelectedShopsDisplay();
            updatePreview();
            
            // Close modal
            closeMapModal();
            
            // Show success message
            showStatus('✅ تم نقل الاختيار من الخريطة بنجاح! يمكنك الآن حفظ التفتيش', 'success');
            
            // Switch to add tab if not already there
            switchTab('add');
        }
        
        // Save inspection directly from map
        async function saveFromMap() {
            if (mapSelectedShops.length === 0) {
                alert('⚠️ يرجى اختيار محل واحد على الأقل');
                return;
            }
            
            const inspector = document.getElementById('mapInspectorSelect').value;
            const date = document.getElementById('mapInspectionDate').value;
            const shift = document.getElementById('mapShiftSelect').value;
            const area = document.getElementById('mapAreaSelect').value || 'متعدد';
            
            if (!inspector || !date) {
                alert('⚠️ يرجى اختيار المفتش والتاريخ');
                return;
            }
            
            if (!confirm(`هل أنت متأكد من حفظ هذا التفتيش؟\n\nالمفتش: ${inspector}\nالتاريخ: ${date}\nالمناوبة: ${shift}\nعدد المحلات: ${mapSelectedShops.length}`)) {
                return;
            }
            
            // Create inspection object
            const inspection = {
                inspector: inspector,
                day: date,
                shift: shift,
                area: area,
                shops: [...mapSelectedShops]
            };
            
            // Add to plan data
            planData.inspectionData.push(inspection);
            
            // Save to GitHub
            try {
                // First, save shops_details.json if new shops were added
                if (newShopsAddedFromMap.length > 0) {
                    const shopNames = newShopsAddedFromMap.join(', ');
                    await saveShopsDetailsToGitHub(`إضافة محلات جديدة من الخريطة: ${shopNames}`);
                    console.log('✅ Saved new shops to shops_details.json:', newShopsAddedFromMap);
                }
                
                // Then save the inspection plan
                await savePlanDataToGitHub(`إضافة تفتيش جديد من الخريطة - ${inspector} - ${date}`);
                
                // Show success and close modal
                alert('✅ تم حفظ التفتيش بنجاح من الخريطة!' + 
                      (newShopsAddedFromMap.length > 0 ? `\n\n✅ تم حفظ ${newShopsAddedFromMap.length} محل جديد أيضاً` : ''));
                closeMapModal();
                
                // Refresh displays
                displayInspections();
                updateCalendar();
                updateInspectorStats();
                
                // Clear map selection and new shops tracking
                mapSelectedShops = [];
                newShopsAddedFromMap = [];
            } catch (error) {
                alert('❌ حدث خطأ في حفظ التفتيش: ' + error.message);
            }
        }
        
        // Tab switching
        function switchTab(tabName, event) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Load data for specific tabs
            if (tabName === 'view') {
                loadInspectionsView();
            } else if (tabName === 'stats') {
                populateStatsInspector();
            } else if (tabName === 'fileManager') {
                // Load group report files when file manager tab is opened
                if (typeof loadGroupReportFiles === 'function') {
                    loadGroupReportFiles();
                }
            } else if (tabName === 'calendar') {
                // Set default month to current month
                const now = new Date();
                document.getElementById('calendarMonth').value = 
                    `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                loadCalendar();
            } else if (tabName === 'shops') {
                // Load planData if not already loaded
                if (!planData) {
                    loadPlanData().then(() => {
                        loadShopsManagement();
                    }).catch(error => {
                        console.error('Error loading plan data:', error);
                        // Initialize empty planData for read-only mode
                        if (!planData) {
                            planData = {
                                shops: [],
                                areas: [],
                                inspectionData: [],
                                inspectors: []
                            };
                        }
                        // Still try to load shops from shops_details.json
                        loadShopsManagement();
                    });
                } else {
                    loadShopsManagement();
                }
            } else if (tabName === 'areas') {
                // Load planData if not already loaded
                if (!planData) {
                    loadPlanData().then(() => {
                        loadAreasManagement();
                    }).catch(error => {
                        console.error('Error loading plan data:', error);
                        // Initialize empty planData for read-only mode
                        if (!planData) {
                            planData = {
                                shops: [],
                                areas: [],
                                inspectionData: [],
                                inspectors: []
                            };
                        }
                        loadAreasManagement();
                    });
                } else {
                    loadAreasManagement();
                }
            } else if (tabName === 'groupInspection') {
                // Load planData if not already loaded
                if (!planData) {
                    loadPlanData().then(() => {
                        initializeGroupInspection();
                    }).catch(error => {
                        console.error('Error loading plan data:', error);
                        // Initialize empty planData for read-only mode
                        if (!planData) {
                            planData = {
                                shops: [],
                                areas: [],
                                inspectionData: [],
                                inspectors: [],
                                groupInspectionData: []
                            };
                        }
                        initializeGroupInspection();
                    });
                } else {
                    initializeGroupInspection();
                }
            } else if (tabName === 'shelterInspection') {
                // Load planData if not already loaded
                if (!planData) {
                    loadPlanData().then(() => {
                        initializeShelterInspection();
                    }).catch(error => {
                        console.error('Error loading plan data:', error);
                        // Initialize empty planData for read-only mode
                        if (!planData) {
                            planData = {
                                shops: [],
                                areas: [],
                                inspectionData: [],
                                inspectors: [],
                                groupInspectionData: [],
                                shelterInspectionData: []
                            };
                        }
                        initializeShelterInspection();
                    });
                } else {
                    initializeShelterInspection();
                }
            }
        }
        
        // Validate GitHub Token
        async function validateGitHubToken(token) {
            try {
                const res = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!res.ok) {
                    if (res.status === 401) {
                        return { valid: false, error: 'التوكن غير صالح أو منتهي الصلاحية' };
                    } else if (res.status === 403) {
                        return { valid: false, error: 'التوكن صالح ولكن لا يمكن الوصول لمعلومات المستخدم' };
                    } else {
                        return { valid: false, error: `خطأ في التحقق: ${res.status}` };
                    }
                }
                
                return { valid: true };
            } catch (error) {
                return { valid: false, error: 'خطأ في الاتصال بـ GitHub: ' + error.message };
            }
        }
        
        // Clear old token
        function clearOldToken() {
            localStorage.removeItem('devToken');
            document.getElementById('githubToken').value = '';
            document.getElementById('oldTokenWarning').style.display = 'none';
            githubToken = null;
            showMessage('loginStatus', 'success', '✅ تم مسح التوكن القديم. يمكنك الآن إدخال التوكن الجديد.');
        }
        
        // Login developer
        async function loginDeveloper() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                showMessage('loginStatus', 'error', '❌ يرجى إدخال GitHub Token');
                return;
            }
            
            showMessage('loginStatus', 'info', '⏳ جاري التحقق من صلاحية التوكن...');
            
            // First, validate the token
            const validation = await validateGitHubToken(token);
            if (!validation.valid) {
                showMessage('loginStatus', 'error', `❌ ${validation.error}\n\n${TOKEN_ERROR_MESSAGES.invalidTokenHelp}`);
                return;
            }
            
            githubToken = token;
            localStorage.setItem('devToken', token);
            
            showMessage('loginStatus', 'info', '✅ التوكن صالح! جاري تحميل البيانات...');
            
            try {
                // Load data from GitHub
                await loadPlanData();
                await loadShopsDetails();
                
                // Initialize UI
                populateInspectors();
                populateAreas();
                populateFilterDropdowns();
                
                // Set default date to today
                document.getElementById('inspectionDate').valueAsDate = new Date();
                
                // Hide login section and show main interface
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainInterface').style.display = 'block';
                
                showMessage('loginStatus', 'success', '✅ تم تسجيل الدخول بنجاح!');
                
            } catch (error) {
                showMessage('loginStatus', 'error', `❌ ${TOKEN_ERROR_MESSAGES.dataLoadFailed}: ${error.message}\n\n${TOKEN_ERROR_MESSAGES.dataLoadFailedHelp}`);
                githubToken = null;
                localStorage.removeItem('devToken');
            }
        }
        
        // Load plan data from GitHub
        async function loadPlanData() {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!res.ok) {
                throw new Error('فشل تحميل plan-data.json');
            }
            
            const file = await res.json();
            planData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
        }
        
        // Load shops details from GitHub
        async function loadShopsDetails() {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!res.ok) {
                throw new Error('فشل تحميل shops_details.json');
            }
            
            const file = await res.json();
            shopsDetails = JSON.parse(decodeURIComponent(escape(atob(file.content))));
        }
        
        // Populate inspectors dropdown
        function populateInspectors() {
            const select = document.getElementById('inspectorSelect');
            select.innerHTML = '<option value="">اختر المفتش...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const option = document.createElement('option');
                    option.value = inspector.name;
                    option.textContent = inspector.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Populate areas dropdown
        function populateAreas() {
            const select = document.getElementById('areaSelect');
            select.innerHTML = '<option value="">اختر المنطقة...</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.name;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Update available shops based on selection
        function updateAvailableShops() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const area = document.getElementById('areaSelect').value;
            const searchBox = document.getElementById('inspectionShopSearchBox');
            const searchInput = document.getElementById('inspectionShopSearch');
            const selectAllAreaBtn = document.getElementById('selectAllAreaShopsBtn');
            
            // Clear search when filters change
            if (searchInput) {
                searchInput.value = '';
            }
            
            // NEW FEATURE: Show monthly shops when only inspector is selected
            if (inspector && !date && !area) {
                displayMonthlyShopsForInspector(inspector);
                if (selectAllAreaBtn) selectAllAreaBtn.style.display = 'none';
                return;
            }
            
            // NEW FEATURE: Show all shops in area when inspector and area are selected (without date)
            if (inspector && area && !date) {
                displayAllShopsInArea(inspector, area);
                if (selectAllAreaBtn) selectAllAreaBtn.style.display = 'inline-flex';
                return;
            }
            
            if (!inspector || !area) {
                document.getElementById('shopsListContainer').innerHTML = 
                    '<p style="text-align: center; color: #999; padding: 20px;">اختر المفتش والمنطقة لعرض جميع المحلات</p>';
                document.getElementById('showHighPriorityBtn').style.display = 'none';
                document.getElementById('showAllShopsBtn').style.display = 'none';
                if (selectAllAreaBtn) selectAllAreaBtn.style.display = 'none';
                // ALWAYS show search box when inspector is selected (for wide-scale search)
                if (searchBox) {
                    searchBox.style.display = inspector ? 'block' : 'none';
                }
                return;
            }
            
            // Get all shops for the selected area
            const allShops = getAllShopsInArea(area);
            
            // Filter shops based on smart rules (only if date is selected)
            const availableShops = date ? filterSmartShops(allShops, inspector, date) : allShops;
            
            // Sort shops by priority
            const sortedShops = sortShopsByPriority(availableShops, inspector, date || new Date().toISOString().split('T')[0]);
            const sortedAllShops = sortShopsByPriority(allShops, inspector, date || new Date().toISOString().split('T')[0]);
            
            // Get high-priority shops that were filtered out
            const unavailableShops = allShops.filter(shop => !availableShops.includes(shop));
            const highPriorityUnavailable = sortShopsByPriority(unavailableShops, inspector, date || new Date().toISOString().split('T')[0])
                .filter(shop => shop.priority === 'very-high' || shop.priority === 'high');
            
            // Store for later use
            currentAvailableShops = sortedShops;
            currentHighPriorityShops = highPriorityUnavailable;
            currentAllAreaShops = sortedAllShops;
            
            // Show/hide the high priority button based on availability
            const highPriorityBtn = document.getElementById('showHighPriorityBtn');
            if (currentHighPriorityShops.length > 0 && date) {
                highPriorityBtn.style.display = 'inline-flex';
            } else {
                highPriorityBtn.style.display = 'none';
            }
            
            // NEW: Show/hide the "Show All Shops" button when area is selected (not affected by filters)
            const showAllShopsBtn = document.getElementById('showAllShopsBtn');
            if (area && allShops.length > 0) {
                showAllShopsBtn.style.display = 'inline-flex';
            } else {
                showAllShopsBtn.style.display = 'none';
            }
            
            // Show/hide the "Select All Shops in Area" button
            if (selectAllAreaBtn && area && allShops.length > 0) {
                selectAllAreaBtn.style.display = 'inline-flex';
            } else if (selectAllAreaBtn) {
                selectAllAreaBtn.style.display = 'none';
            }
            
            // Reset showing state
            showingHighPriority = false;
            showingAllShops = false;
            document.getElementById('highPriorityBtnText').textContent = 'عرض المحلات ذات الأولوية العالية';
            document.getElementById('highPriorityBtnIcon').textContent = '👁️';
            document.getElementById('showAllShopsBtnText').textContent = 'عرض جميع المحلات في هذه المنطقة';
            document.getElementById('showAllShopsBtnIcon').textContent = '🌍';
            
            // Update statistics
            updateStatistics(allShops.length, availableShops.length, sortedShops);
            
            // Display shops
            displayShops(sortedShops);
            
            // ALWAYS show search box when inspector and area are selected (for wide-scale search)
            if (searchBox && inspector) {
                searchBox.style.display = 'block';
            }
        }
        
        // NEW FEATURE: Display monthly shops for selected inspector
        function displayMonthlyShopsForInspector(inspector) {
            const container = document.getElementById('shopsListContainer');
            const searchBox = document.getElementById('inspectionShopSearchBox');
            const highPriorityBtn = document.getElementById('showHighPriorityBtn');
            
            // Hide high priority button in monthly view
            highPriorityBtn.style.display = 'none';
            
            if (!planData || !planData.shops || !planData.areas) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">لا توجد بيانات متاحة</p>';
                searchBox.style.display = 'none';
                return;
            }
            
            // Get all shops grouped by area
            const shopsByArea = {};
            let totalShops = 0;
            
            planData.areas.forEach(area => {
                const areaShops = planData.shops
                    .filter(shop => shop.areaId === area.id)
                    .map(shop => shop.name);
                
                if (areaShops.length > 0) {
                    shopsByArea[area.name] = areaShops;
                    totalShops += areaShops.length;
                }
            });
            
            // Get current month for date filtering context
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // Calculate priority for each shop for the inspector (using current date as reference)
            const todayStr = currentDate.toISOString().split('T')[0];
            
            // Build HTML for monthly view
            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 1.3em;">📋 عرض شهري لجميع المحلات - ${escapeHtml(inspector)}</h3>
                    <p style="margin: 0; opacity: 0.9;">إجمالي المحلات: ${totalShops} محل موزعة على ${Object.keys(shopsByArea).length} منطقة</p>
                    <p style="margin: 5px 0 0 0; opacity: 0.85; font-size: 0.9em;">💡 اختر التاريخ والمنطقة للحصول على قائمة محلات دقيقة حسب الأولوية والتوفر</p>
                </div>
            `;
            
            // Show search box
            searchBox.style.display = 'block';
            
            // Sort areas alphabetically
            const sortedAreas = Object.keys(shopsByArea).sort();
            
            // Track high priority shops for statistics
            let highPriorityCount = 0;
            
            sortedAreas.forEach(areaName => {
                const shops = shopsByArea[areaName];
                
                // Calculate priorities for shops in this area (for display purposes)
                const shopsWithPriority = shops.map(shopName => {
                    const priority = calculateShopPriority(shopName, inspector, todayStr);
                    return { name: shopName, priority: priority.level, score: priority.score, reason: priority.reason };
                }).sort((a, b) => b.score - a.score);
                
                // Count high priority shops
                shopsWithPriority.forEach(shop => {
                    if (shop.priority === 'very-high' || shop.priority === 'high') {
                        highPriorityCount++;
                    }
                });
                
                html += `
                    <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-right: 4px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="margin: 0; color: #2d3561; font-size: 1.1em;">📍 ${escapeHtml(areaName)}</h4>
                            <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9em;">
                                ${shops.length} محل
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
                `;
                
                shopsWithPriority.forEach(shop => {
                    const priorityColor = shop.priority === 'very-high' ? '#ff6b6b' : 
                                         shop.priority === 'high' ? '#ffa500' : 
                                         shop.priority === 'medium' ? '#4ecdc4' : '#95e1d3';
                    
                    const priorityText = shop.priority === 'very-high' ? '🔴 أولوية قصوى' : 
                                        shop.priority === 'high' ? '🟠 أولوية عالية' : 
                                        shop.priority === 'medium' ? '🟡 أولوية متوسطة' : '🟢 أولوية عادية';
                    
                    html += `
                        <div class="shop-card monthly-view-shop" data-shop-name="${escapeHtml(shop.name)}" style="background: white; padding: 10px; border-radius: 8px; border-right: 3px solid ${priorityColor}; font-size: 0.9em;">
                            <div style="font-weight: 600; color: #2d3561; margin-bottom: 4px;">${escapeHtml(shop.name)}</div>
                            <div style="font-size: 0.85em; color: #666;">${priorityText}</div>
                            ${shop.reason ? `<div style="font-size: 0.8em; color: #999; margin-top: 2px;">${escapeHtml(shop.reason)}</div>` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Update statistics
            document.getElementById('totalShopsCount').textContent = totalShops;
            document.getElementById('availableShopsCount').textContent = totalShops;
            document.getElementById('highPriorityCount').textContent = highPriorityCount;
            document.getElementById('selectedShopsCount').textContent = selectedShops.length;
        }
        
        // NEW FEATURE: Display all shops in area when inspector and area selected (without date)
        function displayAllShopsInArea(inspector, area) {
            const container = document.getElementById('shopsListContainer');
            const searchBox = document.getElementById('inspectionShopSearchBox');
            const highPriorityBtn = document.getElementById('showHighPriorityBtn');
            
            // Hide high priority button in this view
            highPriorityBtn.style.display = 'none';
            
            if (!planData || !planData.shops || !planData.areas) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">لا توجد بيانات متاحة</p>';
                searchBox.style.display = 'none';
                return;
            }
            
            // Get all shops for the selected area
            const allShops = getAllShopsInArea(area);
            
            if (allShops.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">لا توجد محلات في هذه المنطقة</p>';
                searchBox.style.display = 'none';
                return;
            }
            
            // Show search box
            searchBox.style.display = 'block';
            
            // Use current date for priority calculation
            const todayStr = new Date().toISOString().split('T')[0];
            
            // Calculate priority for each shop
            const shopsWithPriority = allShops.map(shopName => {
                const priority = calculateShopPriority(shopName, inspector, todayStr);
                return { name: shopName, priority: priority.level, score: priority.score, reason: priority.reason };
            }).sort((a, b) => b.score - a.score);
            
            // Store for later use
            currentAvailableShops = shopsWithPriority;
            currentHighPriorityShops = [];
            
            // Build HTML for area view
            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 1.3em;">📍 جميع محلات منطقة ${escapeHtml(area)}</h3>
                    <p style="margin: 0; opacity: 0.9;">المفتش: ${escapeHtml(inspector)} | إجمالي المحلات: ${allShops.length}</p>
                    <p style="margin: 5px 0 0 0; opacity: 0.85; font-size: 0.9em;">💡 اختر التاريخ للحصول على القائمة المفلترة حسب قواعد التوزيع الذكي</p>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Create shops list container
            const shopsListDiv = document.createElement('div');
            shopsListDiv.className = 'shops-list';
            
            // Display each shop
            shopsWithPriority.forEach(shop => {
                const isSelected = selectedShops.includes(shop.name);
                const lastInspection = getLastInspectionDate(shop.name);
                
                // Create shop card element
                const shopCard = document.createElement('div');
                shopCard.className = `shop-card ${shop.priority}-priority ${isSelected ? 'selected' : ''}`;
                shopCard.onclick = function() { toggleShop(shop.name); };
                
                // Priority badge
                const priorityBadge = document.createElement('div');
                priorityBadge.className = `priority-badge ${shop.priority}`;
                priorityBadge.textContent = shop.priority === 'very-high' ? 'أولوية عالية جداً' :
                                            shop.priority === 'high' ? 'أولوية عالية' : 
                                            shop.priority === 'medium' ? 'أولوية متوسطة' : 'أولوية منخفضة';
                
                // Shop name
                const shopName = document.createElement('div');
                shopName.className = 'shop-name';
                shopName.textContent = shop.name;
                
                // Shop info - score
                const shopScore = document.createElement('div');
                shopScore.className = 'shop-info';
                shopScore.textContent = '📊 النقاط: ' + shop.score;
                
                // Shop info - reason
                const shopReason = document.createElement('div');
                shopReason.className = 'shop-info';
                shopReason.textContent = '📝 ' + shop.reason;
                
                // Last inspection
                const lastInspectionDiv = document.createElement('div');
                lastInspectionDiv.className = 'last-inspection';
                lastInspectionDiv.textContent = '📅 آخر تفتيش: ' + (lastInspection || 'لم يتم التفتيش بعد');
                
                // Append all elements
                shopCard.appendChild(priorityBadge);
                shopCard.appendChild(shopName);
                shopCard.appendChild(shopScore);
                shopCard.appendChild(shopReason);
                shopCard.appendChild(lastInspectionDiv);
                
                shopsListDiv.appendChild(shopCard);
            });
            
            container.appendChild(shopsListDiv);
            
            // Update statistics
            const highPriorityCount = shopsWithPriority.filter(s => s.priority === 'very-high' || s.priority === 'high').length;
            document.getElementById('totalShopsCount').textContent = allShops.length;
            document.getElementById('availableShopsCount').textContent = allShops.length;
            document.getElementById('highPriorityCount').textContent = highPriorityCount;
            document.getElementById('selectedShopsCount').textContent = selectedShops.length;
        }
        
        // Get all shops in an area
        function getAllShopsInArea(area) {
            const shops = [];
            
            if (!planData) return shops;
            
            // First, try to get shops from the planData.shops array (primary source)
            if (planData.shops && planData.areas) {
                // Find the area ID for the given area name
                const areaObj = planData.areas.find(a => a.name === area);
                
                if (areaObj) {
                    // Get all shops that belong to this area
                    const shopsInArea = planData.shops
                        .filter(shop => shop.areaId === areaObj.id)
                        .map(shop => shop.name);
                    
                    if (shopsInArea.length > 0) {
                        return shopsInArea;
                    }
                }
            }
            
            // Fallback: Collect all unique shops from inspection history
            // This ensures backward compatibility if shops array is not available
            if (planData.inspectionData) {
                const shopSet = new Set();
                planData.inspectionData.forEach(inspection => {
                    if (inspection.area === area && inspection.shops) {
                        inspection.shops.forEach(shop => shopSet.add(shop));
                    }
                });
                
                return Array.from(shopSet);
            }
            
            return shops;
        }
        
        // Filter shops based on smart rules
        function filterSmartShops(shops, inspector, date) {
            const available = [];
            
            shops.forEach(shop => {
                // Rule 1: Check if shop is already assigned to ANY inspector on the same day
                const assignedToday = isShopAssignedToday(shop, date);
                
                // Rule 2: Check if shop was inspected by THIS inspector on the same day (for weekly planning)
                const recentlyInspected = wasShopRecentlyInspected(shop, inspector, date);
                
                // If shop passes both rules, it's available
                if (!assignedToday && !recentlyInspected) {
                    available.push(shop);
                }
            });
            
            return available;
        }
        
        // Check if shop is already assigned to any inspector on the same day
        function isShopAssignedToday(shop, date) {
            if (!planData || !planData.inspectionData) return false;
            
            return planData.inspectionData.some(inspection => {
                return inspection.day === date && 
                       inspection.shops && 
                       inspection.shops.includes(shop);
            });
        }
        
        // Check if shop was recently inspected by the same inspector (same day only for weekly planning)
        // Changed from 7-day restriction to same-day only restriction to support weekly inspection planning
        function wasShopRecentlyInspected(shop, inspector, date) {
            if (!planData || !planData.inspectionData) return false;
            
            // Only check if the shop is already assigned to this inspector on the same day
            // This allows shops to be redistributed weekly (changed from 7-day restriction)
            return planData.inspectionData.some(inspection => {
                if (inspection.inspector !== inspector) return false;
                if (!inspection.shops || !inspection.shops.includes(shop)) return false;
                
                // Only prevent if it's the exact same day
                return inspection.day === date;
            });
        }
        
        // Sort shops by priority
        function sortShopsByPriority(shops, inspector, date) {
            return shops.map(shop => {
                const priority = calculateShopPriority(shop, inspector, date);
                return { name: shop, priority: priority.level, score: priority.score, reason: priority.reason };
            }).sort((a, b) => b.score - a.score);
        }
        
        // Calculate shop priority
        function calculateShopPriority(shop, inspector, date) {
            let score = 0;
            let reasons = [];
            
            // Find last inspection date for this shop (by any inspector)
            const lastInspection = getLastInspectionDate(shop);
            
            if (!lastInspection) {
                score += 100; // Never inspected = highest priority
                reasons.push('لم يتم تفتيشه من قبل');
            } else {
                const targetDate = new Date(date);
                const lastDate = new Date(lastInspection);
                const daysSince = Math.floor((targetDate - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysSince > 30) {
                    score += 80;
                    reasons.push(`آخر تفتيش قبل ${daysSince} يوم`);
                } else if (daysSince > 21) {
                    score += 60;
                    reasons.push(`آخر تفتيش قبل ${daysSince} يوم`);
                } else if (daysSince > 14) {
                    score += 40;
                    reasons.push(`آخر تفتيش قبل ${daysSince} يوم`);
                } else {
                    score += 20;
                    reasons.push(`آخر تفتيش قبل ${daysSince} يوم`);
                }
            }
            
            // Priority based on shop type (if available in shops_details)
            if (shopsDetails && shopsDetails[shop]) {
                const activity = shopsDetails[shop].activity || '';
                if (activity.includes('يجب تسجيلها')) {
                    score += 30;
                    reasons.push('نشاط يتطلب التسجيل');
                }
            }
            
            // Check if we're in the second half of the month (from 15th onwards)
            // Boost priority for high-priority shops to ensure they're inspected before month end
            const targetDate = new Date(date);
            const dayOfMonth = targetDate.getDate();
            if (dayOfMonth >= 15) {
                // From the 15th onwards, boost high priority shops to "very high"
                if (score >= 80) {
                    score += 50; // Boost very high priority shops even more
                    reasons.push('أولوية النصف الثاني من الشهر');
                } else if (score >= 50) {
                    score += 20; // Moderate boost for medium priority
                }
            }
            
            // Determine priority level
            let level = 'low';
            if (score >= 130) level = 'very-high'; // Very high priority (from 15th onwards)
            else if (score >= 80) level = 'high';
            else if (score >= 50) level = 'medium';
            
            return { level, score, reason: reasons.join(' - ') };
        }
        
        // Get last inspection date for a shop
        function getLastInspectionDate(shop) {
            if (!planData || !planData.inspectionData) return null;
            
            let lastDate = null;
            
            planData.inspectionData.forEach(inspection => {
                if (inspection.shops && inspection.shops.includes(shop)) {
                    if (!lastDate || inspection.day > lastDate) {
                        lastDate = inspection.day;
                    }
                }
            });
            
            return lastDate;
        }
        
        // Update statistics
        function updateStatistics(total, available, sortedShops) {
            document.getElementById('totalShopsCount').textContent = total;
            document.getElementById('availableShopsCount').textContent = available;
            
            const veryHighPriority = sortedShops.filter(s => s.priority === 'very-high').length;
            const highPriority = sortedShops.filter(s => s.priority === 'high').length;
            document.getElementById('highPriorityCount').textContent = veryHighPriority + highPriority;
            
            document.getElementById('selectedShopsCount').textContent = selectedShops.length;
        }
        
        // HTML escape function to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Escape string for use in JavaScript (single-quoted strings)
        function escapeJs(text) {
            if (!text) return '';
            return text
                .replace(/\\/g, '\\\\')  // Escape backslashes first
                .replace(/'/g, "\\'")     // Escape single quotes
                .replace(/"/g, '\\"')     // Escape double quotes
                .replace(/\n/g, '\\n')    // Escape newlines
                .replace(/\r/g, '\\r');   // Escape carriage returns
        }
        
        // Display shops
        function displayShops(shops, showingHighPriority = false, showingAll = false) {
            const container = document.getElementById('shopsListContainer');
            const searchBox = document.getElementById('inspectionShopSearchBox');
            
            // Show search box when there are shops to display
            if (shops.length > 0) {
                searchBox.style.display = 'block';
            } else {
                searchBox.style.display = 'none';
            }
            
            if (shops.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">لا توجد محلات متاحة حسب المعايير المحددة</p>';
                return;
            }
            
            // Clear container (except info message if it exists)
            const highPriorityInfo = document.getElementById('highPriorityInfo');
            const allShopsInfo = document.getElementById('allShopsInfo');
            container.innerHTML = '';
            if (highPriorityInfo && showingHighPriority) {
                container.appendChild(highPriorityInfo);
            }
            if (allShopsInfo && showingAll) {
                container.appendChild(allShopsInfo);
            }
            
            // Create shops list container
            const shopsListDiv = document.createElement('div');
            shopsListDiv.className = 'shops-list';
            
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            
            shops.forEach(shop => {
                const isSelected = selectedShops.includes(shop.name);
                const lastInspection = getLastInspectionDate(shop.name);
                
                // Check if this shop is from the high-priority unavailable list
                const isHighPriorityUnavailable = currentHighPriorityShops.some(s => s.name === shop.name);
                
                // Create shop card element
                const shopCard = document.createElement('div');
                shopCard.className = `shop-card ${shop.priority}-priority ${isSelected ? 'selected' : ''}`;
                
                // Add visual indicator for high-priority unavailable shops
                if (isHighPriorityUnavailable) {
                    shopCard.style.border = '3px solid #ff6b6b';
                    shopCard.style.opacity = '0.85';
                }
                
                shopCard.onclick = function() { toggleShop(shop.name); };
                
                // Priority badge
                const priorityBadge = document.createElement('div');
                priorityBadge.className = `priority-badge ${shop.priority}`;
                priorityBadge.textContent = shop.priority === 'very-high' ? 'أولوية عالية جداً' :
                                            shop.priority === 'high' ? 'أولوية عالية' : 
                                            shop.priority === 'medium' ? 'أولوية متوسطة' : 'أولوية منخفضة';
                
                // Shop name
                const shopName = document.createElement('div');
                shopName.className = 'shop-name';
                shopName.textContent = shop.name;
                
                // Shop info - score
                const shopScore = document.createElement('div');
                shopScore.className = 'shop-info';
                shopScore.textContent = '📊 النقاط: ' + shop.score;
                
                // Shop info - reason
                const shopReason = document.createElement('div');
                shopReason.className = 'shop-info';
                shopReason.textContent = '📝 ' + shop.reason;
                
                // Warning for high-priority unavailable shops
                let warningDiv = null;
                if (isHighPriorityUnavailable) {
                    warningDiv = document.createElement('div');
                    warningDiv.style.cssText = 'background: #fff3cd; color: #856404; padding: 8px; border-radius: 5px; font-size: 0.85em; margin-top: 8px;';
                    
                    // Check why it's unavailable
                    const assignedToday = isShopAssignedToday(shop.name, date);
                    const recentlyInspected = wasShopRecentlyInspected(shop.name, inspector, date);
                    
                    if (assignedToday) {
                        warningDiv.textContent = '⚠️ مكرر: تم تعيينه لمفتش آخر اليوم';
                    } else if (recentlyInspected) {
                        warningDiv.textContent = '⚠️ تم التفتيش: آخر 7 أيام';
                    }
                }
                
                // Last inspection
                const lastInspectionDiv = document.createElement('div');
                lastInspectionDiv.className = 'last-inspection';
                lastInspectionDiv.textContent = '📅 آخر تفتيش: ' + (lastInspection || 'لم يتم التفتيش بعد');
                
                // Append all elements
                shopCard.appendChild(priorityBadge);
                shopCard.appendChild(shopName);
                shopCard.appendChild(shopScore);
                shopCard.appendChild(shopReason);
                if (warningDiv) {
                    shopCard.appendChild(warningDiv);
                }
                shopCard.appendChild(lastInspectionDiv);
                
                shopsListDiv.appendChild(shopCard);
            });
            
            container.appendChild(shopsListDiv);
        }
        
        // Toggle shop selection
        function toggleShop(shopName) {
            const index = selectedShops.indexOf(shopName);
            
            if (index > -1) {
                selectedShops.splice(index, 1);
            } else {
                selectedShops.push(shopName);
            }
            
            updateSelectedShopsDisplay();
            updateAvailableShops();
            updatePreview();
        }
        
        // Filter shops in new inspection based on search term
        function filterInspectionShops() {
            const searchTerm = document.getElementById('inspectionShopSearch').value.toLowerCase().trim();
            const inspector = document.getElementById('inspectorSelect').value;
            const container = document.getElementById('shopsListContainer');
            
            if (!searchTerm) {
                // If search is empty, restore the default view
                updateAvailableShops();
                return;
            }
            
            if (!inspector) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">يرجى اختيار المفتش أولاً</p>';
                return;
            }
            
            // WIDE-SCALE SEARCH: Search across ALL shops in ALL areas without restrictions
            if (!planData || !planData.shops || !planData.areas) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">لا توجد بيانات متاحة</p>';
                return;
            }
            
            // Get ALL shops from ALL areas
            const allShops = planData.shops.map(shop => ({
                name: shop.name,
                areaId: shop.areaId,
                areaName: planData.areas.find(a => a.id === shop.areaId)?.name || 'غير محدد'
            }));
            
            // Filter shops based on search term
            const matchedShops = allShops.filter(shop => {
                const shopName = shop.name.toLowerCase();
                
                // Try to get additional details from shopsDetails if available
                let shopDetails = '';
                if (shopsDetails && shopsDetails[shop.name]) {
                    const details = shopsDetails[shop.name];
                    shopDetails = [
                        details.nameEn || '',
                        details.licenseNo || '',
                        details.admCode || '',
                        details.activity || '',
                        details.address || ''
                    ].join(' ').toLowerCase();
                }
                
                // Check if search term matches shop name, details, or area name
                const searchableText = shopName + ' ' + shopDetails + ' ' + shop.areaName.toLowerCase();
                return searchableText.includes(searchTerm);
            });
            
            // Display the matched shops
            if (matchedShops.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #fff3cd; border-radius: 10px; border: 2px solid #ffc107;">
                        <p style="font-size: 1.2em; margin-bottom: 10px;">🔍 لم يتم العثور على محلات</p>
                        <p style="color: #856404;">حاول البحث بكلمات مختلفة أو تأكد من كتابة الاسم بشكل صحيح</p>
                    </div>
                `;
                return;
            }
            
            // Display search results grouped by area
            const todayStr = new Date().toISOString().split('T')[0];
            const shopsByArea = {};
            
            matchedShops.forEach(shop => {
                if (!shopsByArea[shop.areaName]) {
                    shopsByArea[shop.areaName] = [];
                }
                shopsByArea[shop.areaName].push(shop.name);
            });
            
            let html = `
                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-right: 4px solid #4caf50;">
                    <p style="margin: 0; color: #2e7d32; font-weight: 600;">
                        ✅ تم العثور على ${matchedShops.length} محل في ${Object.keys(shopsByArea).length} منطقة
                    </p>
                    <p style="margin: 5px 0 0 0; color: #558b2f; font-size: 0.9em;">
                        📌 البحث شامل لجميع المحلات في جميع المناطق بدون أي قيود
                    </p>
                </div>
            `;
            
            const sortedAreas = Object.keys(shopsByArea).sort();
            
            sortedAreas.forEach(areaName => {
                const shops = shopsByArea[areaName];
                
                html += `
                    <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-right: 4px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="margin: 0; color: #2d3561; font-size: 1.1em;">📍 ${escapeHtml(areaName)}</h4>
                            <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9em;">
                                ${shops.length} محل
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;">
                `;
                
                shops.forEach(shopName => {
                    const priority = calculateShopPriority(shopName, inspector, todayStr);
                    const priorityColor = priority.level === 'very-high' ? '#ff6b6b' : 
                                         priority.level === 'high' ? '#ffa500' : 
                                         priority.level === 'medium' ? '#4ecdc4' : '#95e1d3';
                    
                    const priorityText = priority.level === 'very-high' ? '🔴 قصوى' : 
                                        priority.level === 'high' ? '🟠 عالية' : 
                                        priority.level === 'medium' ? '🟡 متوسطة' : '🟢 عادية';
                    
                    const isSelected = selectedShops.includes(shopName);
                    const selectedClass = isSelected ? 'selected' : '';
                    const checkIcon = isSelected ? '✅' : '';
                    
                    html += `
                        <div class="shop-card ${selectedClass}" 
                             style="background: white; padding: 12px; border-radius: 8px; 
                                    border-right: 3px solid ${priorityColor}; cursor: pointer; 
                                    transition: all 0.3s ease;"
                             onclick="toggleShop('${escapeHtml(shopName)}')">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                <div class="shop-name" style="font-weight: 600; color: #2d3561; flex: 1;">${escapeHtml(shopName)}</div>
                                ${checkIcon ? `<span style="font-size: 1.2em;">${checkIcon}</span>` : ''}
                            </div>
                            <div style="font-size: 0.85em; color: #666; margin-bottom: 4px;">${priorityText}</div>
                            <div style="font-size: 0.8em; color: #999;">📍 ${escapeHtml(areaName)}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Update selected shops display
        function updateSelectedShopsDisplay() {
            const container = document.getElementById('selectedShopsContainer');
            const list = document.getElementById('selectedShopsList');
            
            if (selectedShops.length === 0) {
                container.style.display = 'none';
                document.getElementById('saveBtn').disabled = true;
                return;
            }
            
            container.style.display = 'block';
            document.getElementById('saveBtn').disabled = false;
            
            // Clear list
            list.innerHTML = '';
            
            // Create shop tags safely
            selectedShops.forEach(shop => {
                const tag = document.createElement('div');
                tag.className = 'selected-shop-tag';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = shop;
                
                const removeSpan = document.createElement('span');
                removeSpan.className = 'remove';
                removeSpan.textContent = '×';
                removeSpan.onclick = function() { toggleShop(shop); };
                
                tag.appendChild(nameSpan);
                tag.appendChild(removeSpan);
                list.appendChild(tag);
            });
            
            document.getElementById('selectedShopsCount').textContent = selectedShops.length;
        }
        
        // Update preview
        function updatePreview() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const shift = document.getElementById('shiftSelect').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector || !date || !area || selectedShops.length === 0) {
                document.getElementById('inspectionPreview').style.display = 'none';
                return;
            }
            
            document.getElementById('inspectionPreview').style.display = 'block';
            document.getElementById('previewInspector').textContent = inspector;
            document.getElementById('previewDate').textContent = date;
            document.getElementById('previewShift').textContent = shift;
            document.getElementById('previewArea').textContent = area;
            document.getElementById('previewShopsCount').textContent = selectedShops.length;
        }
        
        // Toggle high priority shops display
        function toggleHighPriorityShops() {
            showingHighPriority = !showingHighPriority;
            
            if (showingHighPriority) {
                // Show both available and high-priority shops
                const combinedShops = [...currentAvailableShops, ...currentHighPriorityShops];
                displayShops(combinedShops, true);
                
                // Update button text
                document.getElementById('highPriorityBtnText').textContent = 'إخفاء المحلات ذات الأولوية العالية';
                document.getElementById('highPriorityBtnIcon').textContent = '🚫';
                
                // Show info message
                const container = document.getElementById('shopsListContainer');
                const infoDiv = document.createElement('div');
                infoDiv.id = 'highPriorityInfo';
                infoDiv.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;';
                infoDiv.innerHTML = `
                    <strong>⚠️ تنبيه:</strong> يتم عرض المحلات ذات الأولوية العالية بجانب المحلات المتاحة.
                    <br>
                    <small style="color: #856404;">هذه المحلات قد لا تتوافق مع قواعد التوزيع الذكي (تم تفتيشها مؤخراً أو مكررة في نفس اليوم)</small>
                `;
                container.insertBefore(infoDiv, container.firstChild);
            } else {
                // Show only available shops
                displayShops(currentAvailableShops);
                
                // Update button text
                document.getElementById('highPriorityBtnText').textContent = 'عرض المحلات ذات الأولوية العالية';
                document.getElementById('highPriorityBtnIcon').textContent = '👁️';
                
                // Remove info message
                const infoDiv = document.getElementById('highPriorityInfo');
                if (infoDiv) {
                    infoDiv.remove();
                }
            }
        }
        
        // NEW: Toggle showing all shops in the area (bypass all filters)
        function toggleShowAllShops() {
            showingAllShops = !showingAllShops;
            
            if (showingAllShops) {
                // Show ALL shops in the area, bypassing filters
                displayShops(currentAllAreaShops, false, true);
                
                // Update button text
                document.getElementById('showAllShopsBtnText').textContent = 'إخفاء المحلات المفلترة';
                document.getElementById('showAllShopsBtnIcon').textContent = '🚫';
                
                // Show info message
                const container = document.getElementById('shopsListContainer');
                const infoDiv = document.createElement('div');
                infoDiv.id = 'allShopsInfo';
                infoDiv.style.cssText = 'background: #d1ecf1; border: 2px solid #17a2b8; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;';
                infoDiv.innerHTML = `
                    <strong>ℹ️ ملاحظة:</strong> يتم عرض جميع المحلات في هذه المنطقة بدون تصفية.
                    <br>
                    <small style="color: #0c5460;">هذا يشمل المحلات التي تم تفتيشها مؤخراً. مناسب للتخطيط الأسبوعي وإعادة توزيع المحلات.</small>
                `;
                container.insertBefore(infoDiv, container.firstChild);
                
                // Hide high priority button when showing all shops
                showingHighPriority = false;
                document.getElementById('highPriorityBtnText').textContent = 'عرض المحلات ذات الأولوية العالية';
                document.getElementById('highPriorityBtnIcon').textContent = '👁️';
                const highPriorityInfo = document.getElementById('highPriorityInfo');
                if (highPriorityInfo) {
                    highPriorityInfo.remove();
                }
            } else {
                // Show only available shops (filtered)
                displayShops(currentAvailableShops);
                
                // Update button text
                document.getElementById('showAllShopsBtnText').textContent = 'عرض جميع المحلات في هذه المنطقة';
                document.getElementById('showAllShopsBtnIcon').textContent = '🌍';
                
                // Remove info message
                const infoDiv = document.getElementById('allShopsInfo');
                if (infoDiv) {
                    infoDiv.remove();
                }
            }
        }
        
        // =========================================================================
        // NEW: Alternative Shop Selection Functions for Adding Inspections
        // =========================================================================
        
        /**
         * Open modal to select shops from the complete list (all shops, all areas)
         */
        function selectFromAllShops() {
            const inspector = document.getElementById('inspectorSelect').value;
            
            if (!inspector) {
                alert('⚠️ يرجى اختيار المفتش أولاً');
                return;
            }
            
            if (!planData || !planData.shops) {
                alert('⚠️ لا توجد بيانات محلات متاحة');
                return;
            }
            
            // Open the shop selection modal
            openShopSelectionModal('all');
        }
        
        /**
         * Select all shops in the currently selected area
         */
        function selectAllShopsInCurrentArea() {
            const inspector = document.getElementById('inspectorSelect').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector) {
                alert('⚠️ يرجى اختيار المفتش أولاً');
                return;
            }
            
            if (!area) {
                alert('⚠️ يرجى اختيار المنطقة أولاً');
                return;
            }
            
            // Get all shops in the area
            const allShops = getAllShopsInArea(area);
            
            if (allShops.length === 0) {
                alert('⚠️ لا توجد محلات في هذه المنطقة');
                return;
            }
            
            // Add all shops to selected shops
            allShops.forEach(shopName => {
                if (!selectedShops.includes(shopName)) {
                    selectedShops.push(shopName);
                }
            });
            
            // Update display
            updateSelectedShops();
            updateStatistics(allShops.length, allShops.length, currentAvailableShops);
            
            // Show confirmation
            alert(`✅ تم اختيار جميع المحلات في المنطقة "${area}"\n\nعدد المحلات: ${allShops.length} محل`);
        }
        
        /**
         * Open modal to select shops from other areas
         */
        function selectFromOtherAreas() {
            const inspector = document.getElementById('inspectorSelect').value;
            
            if (!inspector) {
                alert('⚠️ يرجى اختيار المفتش أولاً');
                return;
            }
            
            if (!planData || !planData.shops || !planData.areas) {
                alert('⚠️ لا توجد بيانات متاحة');
                return;
            }
            
            // Open the shop selection modal with area filter
            openShopSelectionModal('other-areas');
        }
        
        /**
         * Display shops by specific area - Opens modal with area filter emphasized
         */
        function displayShopsBySpecificArea() {
            const inspector = document.getElementById('inspectorSelect').value;
            
            if (!inspector) {
                alert('⚠️ يرجى اختيار المفتش أولاً');
                return;
            }
            
            if (!planData || !planData.shops || !planData.areas) {
                alert('⚠️ لا توجد بيانات متاحة');
                return;
            }
            
            // Open the shop selection modal with all areas
            openShopSelectionModal('specific-area');
        }
        
        /**
         * Open the shop selection modal - displays all shops from all areas
         * @param {string} mode - Mode parameter (kept for backward compatibility, no longer affects filtering)
         */
        function openShopSelectionModal(mode = 'all') {
            const modal = document.getElementById('shopSelectionModal');
            const areaFilter = document.getElementById('shopSelectionAreaFilter');
            
            // Populate area filter - show all areas without any filtering
            areaFilter.innerHTML = '<option value="">جميع المناطق</option>';
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.name;
                    option.textContent = area.name;
                    areaFilter.appendChild(option);
                });
            }
            
            // Load shops into the modal
            loadShopsIntoSelectionModal();
            
            // Show modal
            modal.style.display = 'block';
        }
        
        /**
         * Close shop selection modal
         */
        function closeShopSelectionModal() {
            const modal = document.getElementById('shopSelectionModal');
            modal.style.display = 'none';
        }
        
        /**
         * Load shops into the selection modal
         */
        function loadShopsIntoSelectionModal() {
            const container = document.getElementById('shopSelectionListContainer');
            const inspector = document.getElementById('inspectorSelect').value;
            const todayStr = new Date().toISOString().split('T')[0];
            
            if (!planData || !planData.shops) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">لا توجد بيانات متاحة</p>';
                return;
            }
            
            // Get all shops grouped by area
            const shopsByArea = {};
            planData.areas.forEach(area => {
                const areaShops = planData.shops
                    .filter(shop => shop.areaId === area.id)
                    .map(shop => shop.name);
                
                if (areaShops.length > 0) {
                    shopsByArea[area.name] = areaShops;
                }
            });
            
            // Build HTML
            let html = '';
            const sortedAreas = Object.keys(shopsByArea).sort();
            
            sortedAreas.forEach(areaName => {
                const shops = shopsByArea[areaName];
                
                html += `
                    <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-right: 4px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="margin: 0; color: #2d3561; font-size: 1.1em;">📍 ${escapeHtml(areaName)}</h4>
                            <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9em;">
                                ${shops.length} محل
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
                `;
                
                shops.forEach(shopName => {
                    const priority = calculateShopPriority(shopName, inspector, todayStr);
                    const priorityColor = priority.level === 'very-high' ? '#ff6b6b' : 
                                         priority.level === 'high' ? '#ffa500' : 
                                         priority.level === 'medium' ? '#4ecdc4' : '#95e1d3';
                    
                    const priorityText = priority.level === 'very-high' ? '🔴 قصوى' : 
                                        priority.level === 'high' ? '🟠 عالية' : 
                                        priority.level === 'medium' ? '🟡 متوسطة' : '🟢 عادية';
                    
                    const isSelected = selectedShops.includes(shopName);
                    const selectedClass = isSelected ? 'selected' : '';
                    const checkIcon = isSelected ? '✅' : '☐';
                    
                    html += `
                        <div class="shop-card ${selectedClass}" data-shop-name="${escapeHtml(shopName)}" 
                             style="background: white; padding: 10px; border-radius: 8px; border-right: 3px solid ${priorityColor}; 
                                    font-size: 0.9em; cursor: pointer;"
                             onclick="toggleShopSelectionInModal('${escapeHtml(shopName)}')">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                                <div style="font-weight: 600; color: #2d3561; flex: 1;">${escapeHtml(shopName)}</div>
                                <span style="font-size: 1.3em; margin-right: 5px;">${checkIcon}</span>
                            </div>
                            <div style="font-size: 0.85em; color: #666;">${priorityText}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateSelectionModalCount();
        }
        
        /**
         * Filter shops in selection modal
         */
        function filterShopsInSelectionModal() {
            const areaFilter = document.getElementById('shopSelectionAreaFilter').value;
            const searchText = document.getElementById('shopSelectionSearch').value.toLowerCase();
            const allCards = document.querySelectorAll('#shopSelectionListContainer .shop-card');
            
            allCards.forEach(card => {
                const shopName = card.dataset.shopName;
                const areaDiv = card.closest('div[style*="border-right: 4px solid"]');
                const areaName = areaDiv ? areaDiv.querySelector('h4').textContent.replace('📍 ', '').trim() : '';
                
                const matchesArea = !areaFilter || areaName === areaFilter;
                const matchesSearch = !searchText || shopName.toLowerCase().includes(searchText);
                
                if (matchesArea && matchesSearch) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show/hide area divs based on visible shops
            const areaDivs = document.querySelectorAll('#shopSelectionListContainer > div');
            areaDivs.forEach(areaDiv => {
                const visibleShops = areaDiv.querySelectorAll('.shop-card[style*="display: block"], .shop-card:not([style*="display: none"])');
                if (visibleShops.length > 0) {
                    areaDiv.style.display = 'block';
                } else {
                    areaDiv.style.display = 'none';
                }
            });
        }
        
        /**
         * Toggle shop selection in modal (optimized to update only the specific card)
         */
        function toggleShopSelectionInModal(shopName) {
            const index = selectedShops.indexOf(shopName);
            
            if (index > -1) {
                selectedShops.splice(index, 1);
            } else {
                selectedShops.push(shopName);
            }
            
            // Update only the specific card instead of rebuilding entire modal
            const cards = document.querySelectorAll(`#shopSelectionListContainer .shop-card[data-shop-name="${shopName}"]`);
            cards.forEach(card => {
                const isSelected = selectedShops.includes(shopName);
                if (isSelected) {
                    card.classList.add('selected');
                    const checkIcon = card.querySelector('span:last-child');
                    if (checkIcon) checkIcon.textContent = '✅';
                } else {
                    card.classList.remove('selected');
                    const checkIcon = card.querySelector('span:last-child');
                    if (checkIcon) checkIcon.textContent = '☐';
                }
            });
            
            // Update counter
            updateSelectionModalCount();
        }
        
        /**
         * Select all shops in selection modal
         */
        function selectAllInSelectionModal() {
            const visibleCards = document.querySelectorAll('#shopSelectionListContainer .shop-card:not([style*="display: none"])');
            
            visibleCards.forEach(card => {
                const shopName = card.dataset.shopName;
                if (!selectedShops.includes(shopName)) {
                    selectedShops.push(shopName);
                }
            });
            
            loadShopsIntoSelectionModal();
        }
        
        /**
         * Deselect all shops in selection modal
         */
        function deselectAllInSelectionModal() {
            const visibleCards = document.querySelectorAll('#shopSelectionListContainer .shop-card:not([style*="display: none"])');
            
            visibleCards.forEach(card => {
                const shopName = card.dataset.shopName;
                const index = selectedShops.indexOf(shopName);
                if (index > -1) {
                    selectedShops.splice(index, 1);
                }
            });
            
            loadShopsIntoSelectionModal();
        }
        
        /**
         * Select high priority shops in selection modal
         */
        function selectHighPriorityInSelectionModal() {
            const inspector = document.getElementById('inspectorSelect').value;
            const todayStr = new Date().toISOString().split('T')[0];
            const visibleCards = document.querySelectorAll('#shopSelectionListContainer .shop-card:not([style*="display: none"])');
            
            visibleCards.forEach(card => {
                const shopName = card.dataset.shopName;
                const priority = calculateShopPriority(shopName, inspector, todayStr);
                
                if ((priority.level === 'very-high' || priority.level === 'high') && !selectedShops.includes(shopName)) {
                    selectedShops.push(shopName);
                }
            });
            
            loadShopsIntoSelectionModal();
        }
        
        /**
         * Update selection count in modal
         */
        function updateSelectionModalCount() {
            const countElement = document.getElementById('selectionModalCount');
            if (countElement) {
                countElement.textContent = selectedShops.length;
            }
        }
        
        /**
         * Add selected shops to inspection and close modal
         */
        function addSelectedShopsToInspection() {
            if (selectedShops.length === 0) {
                alert('⚠️ لم تقم باختيار أي محلات');
                return;
            }
            
            // Close modal
            closeShopSelectionModal();
            
            // Update the main display
            updateSelectedShops();
            updatePreview();
            
            // Show confirmation
            alert(`✅ تم إضافة ${selectedShops.length} محل للتفتيش`);
        }
        
        // =========================================================================
        // End of Alternative Shop Selection Functions
        // =========================================================================
        
        // Populate filter dropdowns
        function populateFilterDropdowns() {
            // Populate inspector filter
            const filterInspector = document.getElementById('filterInspector');
            const statsInspector = document.getElementById('statsInspector');
            const editInspector = document.getElementById('editInspector');
            
            filterInspector.innerHTML = '<option value="">جميع المفتشين</option>';
            statsInspector.innerHTML = '<option value="">اختر المفتش...</option>';
            editInspector.innerHTML = '<option value="">اختر المفتش...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const opt1 = document.createElement('option');
                    opt1.value = inspector.name;
                    opt1.textContent = inspector.name;
                    filterInspector.appendChild(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = inspector.name;
                    opt2.textContent = inspector.name;
                    statsInspector.appendChild(opt2);
                    
                    const opt3 = document.createElement('option');
                    opt3.value = inspector.name;
                    opt3.textContent = inspector.name;
                    editInspector.appendChild(opt3);
                });
            }
            
            // Populate area filter
            const filterArea = document.getElementById('filterArea');
            const editArea = document.getElementById('editArea');
            
            filterArea.innerHTML = '<option value="">جميع المناطق</option>';
            editArea.innerHTML = '<option value="">اختر المنطقة...</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const opt1 = document.createElement('option');
                    opt1.value = area.name;
                    opt1.textContent = area.name;
                    filterArea.appendChild(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = area.name;
                    opt2.textContent = area.name;
                    editArea.appendChild(opt2);
                });
            }
        }
        
        // Load inspections view
        function loadInspectionsView() {
            filterInspections();
        }
        
        // Filter inspections
        function filterInspections() {
            if (!planData || !planData.inspectionData) {
                document.getElementById('inspectionsTableContainer').innerHTML = 
                    '<div class="empty-state"><div class="icon">📭</div><p>لا توجد تفتيشات متاحة</p></div>';
                return;
            }
            
            const filterInspector = document.getElementById('filterInspector').value;
            const filterArea = document.getElementById('filterArea').value;
            const filterDateFrom = document.getElementById('filterDateFrom').value;
            const filterDateTo = document.getElementById('filterDateTo').value;
            const searchText = document.getElementById('searchBox').value.toLowerCase();
            
            let filtered = planData.inspectionData.filter(inspection => {
                // Filter by inspector
                if (filterInspector && inspection.inspector !== filterInspector) return false;
                
                // Filter by area
                if (filterArea && inspection.area !== filterArea) return false;
                
                // Filter by date range
                if (filterDateFrom && inspection.day < filterDateFrom) return false;
                if (filterDateTo && inspection.day > filterDateTo) return false;
                
                // Filter by search text
                if (searchText) {
                    const searchIn = `${inspection.inspector} ${inspection.area} ${inspection.shops.join(' ')}`.toLowerCase();
                    if (!searchIn.includes(searchText)) return false;
                }
                
                return true;
            });
            
            // Sort by date (newest first)
            filtered.sort((a, b) => b.day.localeCompare(a.day));
            
            displayInspectionsTable(filtered);
        }
        
        // Display inspections table
        function displayInspectionsTable(inspections) {
            const container = document.getElementById('inspectionsTableContainer');
            
            if (inspections.length === 0) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">🔍</div><p>لا توجد نتائج مطابقة للفلترة</p></div>';
                return;
            }
            
            let html = '<table class="inspections-table">';
            html += '<thead><tr>';
            html += '<th><input type="checkbox" onchange="toggleAllCheckboxes(this)"></th>';
            html += '<th>المفتش</th>';
            html += '<th>التاريخ</th>';
            html += '<th>المناوبة</th>';
            html += '<th>المنطقة</th>';
            html += '<th>عدد المحلات</th>';
            html += '<th>الإجراءات</th>';
            html += '</tr></thead><tbody>';
            
            inspections.forEach((inspection, index) => {
                // Find original index in planData
                const originalIndex = planData.inspectionData.indexOf(inspection);
                
                html += '<tr>';
                html += `<td><input type="checkbox" class="inspection-checkbox" value="${originalIndex}"></td>`;
                html += `<td>${escapeHtml(inspection.inspector)}</td>`;
                html += `<td>${inspection.day}</td>`;
                html += `<td>${escapeHtml(inspection.shift || 'صباحية')}</td>`;
                html += `<td>${escapeHtml(inspection.area)}</td>`;
                html += `<td>${inspection.shops ? inspection.shops.length : 0}</td>`;
                html += `<td>
                    <span class="action-icon edit-icon" onclick="openEditModal(${originalIndex})" title="تحرير">✏️</span>
                    <span class="action-icon delete-icon" onclick="deleteInspection(${originalIndex})" title="حذف">🗑️</span>
                    <span class="action-icon copy-icon" onclick="copyInspection(${originalIndex})" title="نسخ">📋</span>
                </td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Toggle all checkboxes
        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('.inspection-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = source.checked;
            });
        }
        
        // Open edit modal
        function openEditModal(index) {
            const inspection = planData.inspectionData[index];
            
            document.getElementById('editInspectionIndex').value = index;
            document.getElementById('editInspector').value = inspection.inspector;
            document.getElementById('editDate').value = inspection.day;
            document.getElementById('editShift').value = inspection.shift || 'صباحية';
            document.getElementById('editArea').value = inspection.area;
            document.getElementById('editShops').value = inspection.shops.join('، ');
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editStatus').className = 'status-message';
        }
        
        // Save edited inspection
        async function saveEditedInspection() {
            const index = parseInt(document.getElementById('editInspectionIndex').value);
            const inspector = document.getElementById('editInspector').value;
            const date = document.getElementById('editDate').value;
            const shift = document.getElementById('editShift').value;
            const area = document.getElementById('editArea').value;
            const shopsText = document.getElementById('editShops').value;
            
            if (!inspector || !date || !area || !shopsText) {
                showMessage('editStatus', 'error', '❌ يرجى ملء جميع الحقول');
                return;
            }
            
            // Parse shops
            const shops = shopsText.split('،').map(s => s.trim()).filter(s => s);
            
            if (shops.length === 0) {
                showMessage('editStatus', 'error', '❌ يرجى إضافة محل واحد على الأقل');
                return;
            }
            
            // Check for duplicate shops assigned to other inspectors on the same day
            // التحقق من وجود محلات مكررة مخصصة لمفتشين آخرين في نفس اليوم
            const duplicateShops = [];
            for (let i = 0; i < planData.inspectionData.length; i++) {
                const inspection = planData.inspectionData[i];
                
                // Skip the current inspection being edited
                if (i === index) {
                    continue;
                }
                
                // Skip if it's the same inspector (will be handled separately)
                if (inspection.inspector === inspector && inspection.day === date) {
                    continue;
                }
                
                // Check if it's the same day but different inspector
                if (inspection.day === date) {
                    const inspectionShops = inspection.shops || [];
                    for (const shop of shops) {
                        if (inspectionShops.includes(shop)) {
                            duplicateShops.push({
                                shop: shop,
                                inspector: inspection.inspector
                            });
                        }
                    }
                }
            }
            
            // If duplicate shops found with other inspectors, prevent saving
            if (duplicateShops.length > 0) {
                let errorMessage = '❌ خطأ: لا يمكن حفظ التعديلات!\n\n';
                errorMessage += 'المحلات التالية مخصصة بالفعل لمفتشين آخرين في نفس اليوم:\n\n';
                
                const shopsByInspector = {};
                duplicateShops.forEach(dup => {
                    if (!shopsByInspector[dup.inspector]) {
                        shopsByInspector[dup.inspector] = [];
                    }
                    shopsByInspector[dup.inspector].push(dup.shop);
                });
                
                for (const [otherInspector, shopsList] of Object.entries(shopsByInspector)) {
                    errorMessage += `\n🔸 ${otherInspector}:\n`;
                    shopsList.forEach(shop => {
                        errorMessage += `   • ${shop}\n`;
                    });
                }
                
                errorMessage += '\n⚠️ يرجى إزالة هذه المحلات من القائمة أو اختيار يوم آخر.';
                errorMessage += '\n\n💡 ملاحظة: يمكن تخصيص نفس المحل لمفتشين مختلفين في أيام مختلفة.';
                
                showMessage('editStatus', 'error', errorMessage);
                return;
            }
            
            showMessage('editStatus', 'info', '⏳ جاري حفظ التعديلات...');
            
            try {
                // Check for duplicates (excluding current inspection)
                const duplicateIndex = planData.inspectionData.findIndex((insp, idx) => 
                    idx !== index && 
                    insp.inspector === inspector && 
                    insp.day === date
                );
                
                if (duplicateIndex !== -1) {
                    if (confirm('يوجد تفتيش مكرر لنفس المفتش في نفس اليوم. هل تريد حذف التفتيش القديم؟')) {
                        // Delete the duplicate
                        planData.inspectionData.splice(duplicateIndex, 1);
                        // Adjust index if needed
                        if (duplicateIndex < index) {
                            index--;
                        }
                    } else {
                        showMessage('editStatus', 'error', '❌ تم إلغاء الحفظ لتجنب التكرار');
                        return;
                    }
                }
                
                // Update inspection
                planData.inspectionData[index] = {
                    inspector: inspector,
                    day: date,
                    shift: shift,
                    area: area,
                    shops: shops
                };
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`تحديث تفتيش - ${inspector} - ${date}`);
                
                showMessage('editStatus', 'success', '✅ تم حفظ التعديلات بنجاح!');
                
                setTimeout(() => {
                    closeEditModal();
                    filterInspections();
                }, 2000);
                
            } catch (error) {
                showMessage('editStatus', 'error', '❌ فشل حفظ التعديلات: ' + error.message);
            }
        }
        
        // Delete inspection
        async function deleteInspection(index) {
            const inspection = planData.inspectionData[index];
            
            if (!confirm(`هل أنت متأكد من حذف هذا التفتيش؟\n\nالمفتش: ${inspection.inspector}\nالتاريخ: ${inspection.day}\nالمحلات: ${inspection.shops.length}`)) {
                return;
            }
            
            try {
                // Remove inspection
                planData.inspectionData.splice(index, 1);
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`حذف تفتيش - ${inspection.inspector} - ${inspection.day}`);
                
                alert('✅ تم حذف التفتيش بنجاح!');
                filterInspections();
                
            } catch (error) {
                alert('❌ فشل حذف التفتيش: ' + error.message);
            }
        }
        
        // Copy inspection
        function copyInspection(index) {
            const inspection = planData.inspectionData[index];
            
            // Switch to add tab
            document.querySelectorAll('.tab-button')[0].click();
            
            // Fill form with copied data
            document.getElementById('inspectorSelect').value = inspection.inspector;
            document.getElementById('areaSelect').value = inspection.area;
            document.getElementById('shiftSelect').value = inspection.shift || 'صباحية';
            
            // Set date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('inspectionDate').valueAsDate = tomorrow;
            
            // Pre-select shops (if they're available)
            selectedShops = [...inspection.shops];
            
            updateAvailableShops();
            
            alert('✅ تم نسخ بيانات التفتيش! يمكنك الآن تعديل التاريخ والمحلات وحفظ التفتيش الجديد.');
        }
        
        // Delete selected inspections
        async function deleteSelectedInspections() {
            const checkboxes = document.querySelectorAll('.inspection-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('⚠️ يرجى تحديد التفتيشات المراد حذفها');
                return;
            }
            
            if (!confirm(`هل أنت متأكد من حذف ${checkboxes.length} تفتيش؟`)) {
                return;
            }
            
            try {
                // Get indices and sort in descending order (to delete from end to start)
                const indices = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => b - a);
                
                // Delete inspections
                indices.forEach(index => {
                    planData.inspectionData.splice(index, 1);
                });
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`حذف ${indices.length} تفتيش`);
                
                alert(`✅ تم حذف ${indices.length} تفتيش بنجاح!`);
                filterInspections();
                
            } catch (error) {
                alert('❌ فشل حذف التفتيشات: ' + error.message);
            }
        }
        
        // Export inspections
        function exportInspections() {
            const filterInspector = document.getElementById('filterInspector').value;
            const dataToExport = filterInspector ? 
                planData.inspectionData.filter(i => i.inspector === filterInspector) : 
                planData.inspectionData;
            
            const jsonStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inspections-${filterInspector || 'all'}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Load inspector statistics
        function loadInspectorStats() {
            const inspector = document.getElementById('statsInspector').value;
            const container = document.getElementById('statsContainer');
            
            if (!inspector) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">📊</div><p>اختر مفتشاً لعرض الإحصائيات</p></div>';
                return;
            }
            
            // Calculate statistics
            const inspections = planData.inspectionData.filter(i => i.inspector === inspector);
            const totalInspections = inspections.length;
            const totalShops = inspections.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0);
            const areas = new Set(inspections.map(i => i.area)).size;
            const uniqueShops = new Set();
            inspections.forEach(i => i.shops && i.shops.forEach(s => uniqueShops.add(s)));
            
            // Get date range
            const dates = inspections.map(i => new Date(i.day)).sort((a, b) => a - b);
            const firstDate = dates.length > 0 ? dates[0].toLocaleDateString('ar-EG') : '-';
            const lastDate = dates.length > 0 ? dates[dates.length - 1].toLocaleDateString('ar-EG') : '-';
            
            // Calculate inspections per area
            const areaCount = {};
            inspections.forEach(i => {
                areaCount[i.area] = (areaCount[i.area] || 0) + 1;
            });
            
            let html = '<div class="inspector-stats">';
            html += `<div class="stat-card"><div class="stat-value">${totalInspections}</div><div class="stat-label">إجمالي التفتيشات</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${totalShops}</div><div class="stat-label">إجمالي المحلات</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${uniqueShops.size}</div><div class="stat-label">محلات فريدة</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${areas}</div><div class="stat-label">المناطق المغطاة</div></div>`;
            html += '</div>';
            
            html += '<div style="margin-top: 30px;">';
            html += '<h3 style="color: #2d3561; margin-bottom: 15px;">📅 الفترة الزمنية</h3>';
            html += `<p><strong>أول تفتيش:</strong> ${firstDate}</p>`;
            html += `<p><strong>آخر تفتيش:</strong> ${lastDate}</p>`;
            html += '</div>';
            
            html += '<div style="margin-top: 30px;">';
            html += '<h3 style="color: #2d3561; margin-bottom: 15px;">🗺️ توزيع التفتيشات حسب المنطقة</h3>';
            for (const [area, count] of Object.entries(areaCount).sort((a, b) => b[1] - a[1])) {
                html += `<div style="padding: 10px; background: #f8f9fa; margin-bottom: 5px; border-radius: 8px;">`;
                html += `<strong>${escapeHtml(area)}:</strong> ${count} تفتيش`;
                html += `</div>`;
            }
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Populate stats inspector dropdown
        function populateStatsInspector() {
            const select = document.getElementById('statsInspector');
            select.innerHTML = '<option value="">اختر المفتش...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const option = document.createElement('option');
                    option.value = inspector.name;
                    option.textContent = inspector.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load calendar
        function loadCalendar() {
            const monthInput = document.getElementById('calendarMonth').value;
            const container = document.getElementById('calendarContainer');
            
            if (!monthInput) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">📅</div><p>اختر الشهر لعرض التقويم</p></div>';
                return;
            }
            
            const [year, month] = monthInput.split('-').map(Number);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const daysInMonth = lastDay.getDate();
            
            // Get inspections for this month
            const monthStr = monthInput;
            const monthInspections = planData.inspectionData.filter(i => 
                i.day.startsWith(monthStr)
            );
            
            // Group by date
            const inspectionsByDate = {};
            monthInspections.forEach(i => {
                if (!inspectionsByDate[i.day]) {
                    inspectionsByDate[i.day] = [];
                }
                inspectionsByDate[i.day].push(i);
            });
            
            let html = '<div style="margin-bottom: 20px;">';
            html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; font-weight: bold; text-align: center; color: #667eea;">';
            const daysOfWeek = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            daysOfWeek.forEach(day => {
                html += `<div style="padding: 10px;">${day}</div>`;
            });
            html += '</div>';
            html += '<div class="calendar-view">';
            
            // Add empty cells for days before first day of month
            const startDay = firstDay.getDay();
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day" style="opacity: 0.3;"></div>';
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayInspections = inspectionsByDate[dateStr] || [];
                const hasInspection = dayInspections.length > 0;
                
                html += `<div class="calendar-day ${hasInspection ? 'has-inspection' : ''}">`;
                html += `<div class="day-number">${day}</div>`;
                
                dayInspections.forEach(insp => {
                    html += `<div class="inspection-badge" title="${escapeHtml(insp.inspector)} - ${escapeHtml(insp.area)}">`;
                    html += `${escapeHtml(insp.inspector.split(' ')[1] || insp.inspector)}`;
                    html += `</div>`;
                });
                
                html += '</div>';
            }
            
            html += '</div></div>';
            
            // Add summary
            html += '<div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">';
            html += `<h3 style="color: #2d3561; margin-bottom: 15px;">📊 ملخص الشهر</h3>`;
            html += `<p><strong>إجمالي التفتيشات:</strong> ${monthInspections.length}</p>`;
            html += `<p><strong>إجمالي المحلات:</strong> ${monthInspections.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0)}</p>`;
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Save inspection to GitHub
        async function saveInspection() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const shift = document.getElementById('shiftSelect').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector || !date || !area || selectedShops.length === 0) {
                showMessage('planningStatus', 'error', '❌ يرجى ملء جميع الحقول واختيار المحلات');
                return;
            }
            
            // Check for duplicate shops assigned to other inspectors on the same day
            // التحقق من وجود محلات مكررة مخصصة لمفتشين آخرين في نفس اليوم
            const duplicateShops = [];
            for (const inspection of planData.inspectionData) {
                // Skip if it's the same inspector (will be handled separately)
                if (inspection.inspector === inspector && inspection.day === date) {
                    continue;
                }
                
                // Check if it's the same day but different inspector
                if (inspection.day === date) {
                    const inspectionShops = inspection.shops || [];
                    for (const shop of selectedShops) {
                        if (inspectionShops.includes(shop)) {
                            duplicateShops.push({
                                shop: shop,
                                inspector: inspection.inspector
                            });
                        }
                    }
                }
            }
            
            // If duplicate shops found with other inspectors, prevent saving
            if (duplicateShops.length > 0) {
                let errorMessage = '❌ خطأ: لا يمكن حفظ التفتيش!\n\n';
                errorMessage += 'المحلات التالية مخصصة بالفعل لمفتشين آخرين في نفس اليوم:\n\n';
                
                const shopsByInspector = {};
                duplicateShops.forEach(dup => {
                    if (!shopsByInspector[dup.inspector]) {
                        shopsByInspector[dup.inspector] = [];
                    }
                    shopsByInspector[dup.inspector].push(dup.shop);
                });
                
                for (const [otherInspector, shops] of Object.entries(shopsByInspector)) {
                    errorMessage += `\n🔸 ${otherInspector}:\n`;
                    shops.forEach(shop => {
                        errorMessage += `   • ${shop}\n`;
                    });
                }
                
                errorMessage += '\n⚠️ يرجى إزالة هذه المحلات من القائمة أو اختيار يوم آخر.';
                errorMessage += '\n\n💡 ملاحظة: يمكن تخصيص نفس المحل لمفتشين مختلفين في أيام مختلفة.';
                
                showMessage('planningStatus', 'error', errorMessage);
                document.getElementById('saveBtn').disabled = false;
                return;
            }
            
            // Check for duplicate inspection (same inspector and date)
            const duplicateIndex = planData.inspectionData.findIndex(insp => 
                insp.inspector === inspector && insp.day === date
            );
            
            let confirmMessage = `هل أنت متأكد من إضافة هذا التفتيش؟\n\nالمفتش: ${inspector}\nالتاريخ: ${date}\nالمحلات: ${selectedShops.length}`;
            
            if (duplicateIndex !== -1) {
                confirmMessage = `⚠️ تنبيه: يوجد تفتيش مكرر لنفس المفتش في نفس اليوم!\n\nهل تريد حذف التفتيش القديم وإضافة التفتيش الجديد؟\n\nالمفتش: ${inspector}\nالتاريخ: ${date}\nالمحلات الجديدة: ${selectedShops.length}`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            showMessage('planningStatus', 'info', '⏳ جاري حفظ التفتيش...');
            document.getElementById('saveBtn').disabled = true;
            
            try {
                // Delete duplicate if exists
                if (duplicateIndex !== -1) {
                    planData.inspectionData.splice(duplicateIndex, 1);
                    showMessage('planningStatus', 'info', '⏳ تم حذف التفتيش المكرر... جاري حفظ التفتيش الجديد...');
                }
                
                // Create new inspection entry
                const newInspection = {
                    inspector: inspector,
                    day: date,
                    shift: shift,
                    area: area,
                    shops: [...selectedShops]
                };
                
                // Add to plan data
                planData.inspectionData.push(newInspection);
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`إضافة تفتيش جديد - ${inspector} - ${date}`);
                
                let successMsg = `✅ تم حفظ التفتيش بنجاح!\n\n📊 المفتش: ${inspector}\n📅 التاريخ: ${date}\n🏪 عدد المحلات: ${selectedShops.length}`;
                
                if (duplicateIndex !== -1) {
                    successMsg += '\n\n🗑️ تم حذف التفتيش المكرر تلقائياً';
                }
                
                successMsg += '\n\n✨ التحديثات ستظهر فوراً في الموقع!';
                
                showMessage('planningStatus', 'success', successMsg);
                
                // Reset form
                setTimeout(() => {
                    resetForm();
                }, 3000);
                
            } catch (error) {
                showMessage('planningStatus', 'error', '❌ فشل حفظ التفتيش: ' + error.message);
                document.getElementById('saveBtn').disabled = false;
            }
        }
        
        // Save plan data to GitHub
        async function savePlanDataToGitHub(commitMessage = null) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('فشل الحصول على ملف plan-data.json');
            }
            
            const file = await getRes.json();
            const sha = file.sha;
            
            // Prepare content
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(planData, null, 2))));
            
            // Default commit message if not provided
            if (!commitMessage) {
                const inspector = document.getElementById('inspectorSelect').value;
                const date = document.getElementById('inspectionDate').value;
                commitMessage = `إضافة تفتيش جديد - ${inspector} - ${date}`;
            }
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateRes.ok) {
                throw new Error('فشل تحديث ملف plan-data.json');
            }
        }
        
        // Save shops details to GitHub
        async function saveShopsDetailsToGitHub(commitMessage = null) {
            if (!shopsDetails) {
                throw new Error('لا توجد بيانات محلات للحفظ');
            }
            
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('فشل الحصول على ملف shops_details.json');
            }
            
            const file = await getRes.json();
            const sha = file.sha;
            
            // Prepare content
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(shopsDetails, null, 2))));
            
            // Default commit message if not provided
            if (!commitMessage) {
                commitMessage = 'تحديث بيانات المحلات - إضافة محل جديد من الخريطة';
            }
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateRes.ok) {
                throw new Error('فشل تحديث ملف shops_details.json');
            }
        }
        
        // Reset form
        function resetForm() {
            document.getElementById('inspectorSelect').value = '';
            document.getElementById('inspectionDate').valueAsDate = new Date();
            document.getElementById('shiftSelect').value = 'صباحية';
            document.getElementById('areaSelect').value = '';
            selectedShops = [];
            
            // Clear search input and hide search box
            const searchInput = document.getElementById('inspectionShopSearch');
            const searchBox = document.getElementById('inspectionShopSearchBox');
            if (searchInput) {
                searchInput.value = '';
            }
            if (searchBox) {
                searchBox.style.display = 'none';
            }
            
            document.getElementById('shopsListContainer').innerHTML = 
                '<p style="text-align: center; color: #999; padding: 20px;">اختر المفتش والتاريخ والمنطقة لعرض المحلات المتاحة</p>';
            
            document.getElementById('selectedShopsContainer').style.display = 'none';
            document.getElementById('inspectionPreview').style.display = 'none';
            document.getElementById('saveBtn').disabled = true;
            
            updateStatistics(0, 0, []);
        }
        
        // Show message
        function showMessage(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.className = `status-message ${type} show`;
            // Preserve line breaks by setting white-space: pre-line
            el.style.whiteSpace = 'pre-line';
            el.textContent = message;
            
            setTimeout(() => {
                el.classList.remove('show');
            }, type === 'success' ? 5000 : 10000);
        }
        
        // Check if user is already logged in
        window.onload = async function() {
            // Check if we should open file manager tab
            const openFileManager = sessionStorage.getItem('openFileManager');
            if (openFileManager === 'true') {
                sessionStorage.removeItem('openFileManager');
                // Wait a bit for the page to fully load, then switch to file manager
                setTimeout(() => {
                    switchTab('fileManager');
                }, 500);
            }
            const savedToken = localStorage.getItem('devToken');
            if (savedToken) {
                document.getElementById('githubToken').value = savedToken;
                
                // Auto-login with saved token
                showMessage('loginStatus', 'info', '🔄 جاري تسجيل الدخول تلقائياً...');
                
                // Validate the saved token
                const validation = await validateGitHubToken(savedToken);
                if (!validation.valid) {
                    // Token is invalid or expired
                    showMessage('loginStatus', 'error', `❌ التوكن المحفوظ غير صالح أو منتهي الصلاحية.\n\n${validation.error}\n\nيرجى إدخال توكن جديد والضغط على "تسجيل الدخول".`);
                    localStorage.removeItem('devToken');
                    document.getElementById('githubToken').value = '';
                    githubToken = null;
                    return;
                }
                
                // Token is valid, proceed with auto-login
                githubToken = savedToken;
                
                try {
                    showMessage('loginStatus', 'info', '✅ التوكن صالح! جاري تحميل البيانات...');
                    
                    // Load data from GitHub
                    await loadPlanData();
                    await loadShopsDetails();
                    
                    // Initialize UI
                    populateInspectors();
                    populateAreas();
                    populateFilterDropdowns();
                    
                    // Set default date to today
                    document.getElementById('inspectionDate').valueAsDate = new Date();
                    
                    // Hide login section and show main interface
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('mainInterface').style.display = 'block';
                    
                    showMessage('loginStatus', 'success', '✅ تم تسجيل الدخول بنجاح تلقائياً!');
                    
                    // Load maintenance config
                    loadMaintenanceConfig();
                    
                } catch (error) {
                    showMessage('loginStatus', 'error', `❌ فشل في تحميل البيانات: ${error.message}\n\nيرجى المحاولة مرة أخرى أو إدخال توكن جديد.`);
                    githubToken = null;
                    localStorage.removeItem('devToken');
                    document.getElementById('loginSection').style.display = 'block';
                    document.getElementById('mainInterface').style.display = 'none';
                }
            }
        };
        
        // ============================================
        // SHOPS MANAGEMENT FUNCTIONS
        // ============================================
        
        // Load shops management tab
        function loadShopsManagement() {
            populateShopAreaFilter();
            displayShopsList();
        }
        
        // Populate area filter for shops
        function populateShopAreaFilter() {
            const select = document.getElementById('filterShopArea');
            select.innerHTML = '<option value="">جميع المناطق</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Display shops list with full details from shops_details.json
        async function displayShopsList() {
            const tbody = document.getElementById('shopsManagementBody');
            const searchTerm = document.getElementById('searchShop').value.toLowerCase();
            const filterAreaId = document.getElementById('filterShopArea').value;
            
            // Use global shopsDetails for consistency with Smart Shop List
            // This ensures all 306 shops are visible to developers
            let currentShopsDetails = shopsDetails || {};
            
            // If global shopsDetails is not loaded (e.g., not logged in), try loading from local file
            if (!shopsDetails || Object.keys(shopsDetails).length === 0) {
                try {
                    const response = await fetch('shops_details.json?' + new Date().getTime());
                    if (response.ok) {
                        currentShopsDetails = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading shops_details.json:', error);
                }
            }
            
            const totalShopsInDetails = Object.keys(currentShopsDetails).length;
            
            // Create combined shop list from both sources
            const allShops = [];
            
            // Add ALL shops from shops_details.json for developer access
            Object.entries(currentShopsDetails).forEach(([shopName, shopInfo]) => {
                allShops.push({
                    name: shopInfo.nameAr || shopName,
                    nameEn: shopInfo.nameEn || '',
                    licenseNo: shopInfo.licenseNo || '',
                    admCode: shopInfo.admCode || '',
                    address: shopInfo.address || '',
                    contact: shopInfo.contact || '',
                    locationMap: shopInfo.locationMap || '',
                    activity: shopInfo.activity || '',
                    area: shopInfo.area || '',
                    areaId: shopInfo.areaId || '',
                    source: 'shops_details'
                });
            });
            
            // Add shops from plan-data.json if not already in list
            if (planData && planData.shops) {
                planData.shops.forEach(shop => {
                    if (!allShops.find(s => s.name === shop.name)) {
                        allShops.push({
                            ...shop,
                            source: 'plan_data'
                        });
                    }
                });
            }
            
            // Filter shops
            let filteredShops = allShops.filter(shop => {
                const matchesSearch = shop.name.toLowerCase().includes(searchTerm) ||
                                    (shop.nameEn && shop.nameEn.toLowerCase().includes(searchTerm)) ||
                                    (shop.licenseNo && shop.licenseNo.toLowerCase().includes(searchTerm)) ||
                                    (shop.admCode && shop.admCode.toLowerCase().includes(searchTerm));
                const matchesArea = !filterAreaId || shop.areaId === filterAreaId || shop.area === filterAreaId;
                return matchesSearch && matchesArea;
            });
            
            // Update statistics
            document.getElementById('totalShopsManagement').textContent = allShops.length;
            document.getElementById('filteredShopsCount').textContent = filteredShops.length;
            document.getElementById('totalAreasInShops').textContent = planData?.areas ? planData.areas.length : 0;
            
            if (filteredShops.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">لا توجد محلات مطابقة</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            filteredShops.forEach((shop, idx) => {
                const area = planData?.areas?.find(a => a.id === shop.areaId || a.name === shop.area);
                const tr = document.createElement('tr');
                
                // Create detailed shop info popup
                let shopDetails = `<strong>${shop.name}</strong>`;
                if (shop.nameEn) shopDetails += `<br><small style="color: #666;">${shop.nameEn}</small>`;
                if (shop.licenseNo) shopDetails += `<br><small>🔖 رخصة: ${shop.licenseNo}</small>`;
                if (shop.admCode) shopDetails += `<br><small>🔢 كود ADM: ${shop.admCode}</small>`;
                if (shop.address) shopDetails += `<br><small>📍 ${shop.address}</small>`;
                if (shop.contact) shopDetails += `<br><small>📞 ${shop.contact}</small>`;
                if (shop.activity) shopDetails += `<br><small>💼 ${shop.activity}</small>`;
                if (shop.locationMap) shopDetails += `<br><small><a href="${shop.locationMap}" target="_blank">🗺️ عرض على الخريطة</a></small>`;
                
                tr.innerHTML = `
                    <td>
                        <div style="cursor: help;" title="${shop.nameEn || ''}">${shop.name}</div>
                        ${shop.licenseNo ? `<small style="color: #999; display: block;">🔖 ${shop.licenseNo}</small>` : ''}
                        ${shop.admCode ? `<small style="color: #999; display: block;">🔢 ${shop.admCode}</small>` : ''}
                    </td>
                    <td>${area ? area.name : (shop.area || 'غير محدد')}</td>
                    <td style="font-family: monospace; font-size: 0.85em;">${shop.id || shop.admCode || idx}</td>
                    <td>
                        <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                            <button class="action-btn action-btn-view" onclick="viewShopDetails('${escapeJs(shop.name)}')" title="عرض التفاصيل">
                                <span>👁️</span>
                                <span class="action-btn-text">عرض</span>
                            </button>
                            <button class="action-btn action-btn-edit" onclick="openEditShopModal('${escapeJs(shop.name)}')" title="تعديل المحل">
                                <span>✏️</span>
                                <span class="action-btn-text">تعديل</span>
                            </button>
                            <button class="action-btn action-btn-delete" onclick="deleteShop('${escapeJs(shop.name)}')" title="حذف المحل">
                                <span>🗑️</span>
                                <span class="action-btn-text">حذف</span>
                            </button>
                            <button class="action-btn action-btn-copy" onclick="copyShopInfo('${escapeJs(shop.name)}')" title="نسخ المعلومات">
                                <span>📋</span>
                                <span class="action-btn-text">نسخ</span>
                            </button>
                            ${shop.locationMap ? `<button class="action-btn action-btn-map" onclick="window.open('${shop.locationMap}', '_blank')" title="موقع على الخريطة">
                                <span>🗺️</span>
                                <span class="action-btn-text">خريطة</span>
                            </button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Show success message if we loaded shops from details
            if (totalShopsInDetails > 0) {
                console.log(`✅ تم تحميل ${totalShopsInDetails} محل من shops_details.json`);
            }
        }
        
        // View shop full details
        function viewShopDetails(shopName) {
            fetch('shops_details.json?' + new Date().getTime())
                .then(response => response.json())
                .then(shopsDetails => {
                    const shop = shopsDetails[shopName];
                    
                    // Find shop in planData to get area information
                    let planShop = null;
                    if (planData && planData.shops) {
                        planShop = planData.shops.find(s => s.name === shopName);
                    }
                    
                    let details = `🏪 تفاصيل المحل الكاملة\n`;
                    details += `${'='.repeat(50)}\n\n`;
                    details += `📝 الاسم بالعربي: ${shop?.nameAr || shopName}\n`;
                    
                    if (shop?.nameEn) details += `📝 الاسم بالإنجليزي: ${shop.nameEn}\n`;
                    if (shop?.licenseNo) details += `🔖 رقم الرخصة: ${shop.licenseNo}\n`;
                    if (shop?.admCode) details += `🔢 كود ADM: ${shop.admCode}\n`;
                    if (shop?.address) details += `📍 العنوان: ${shop.address}\n`;
                    if (shop?.contact) details += `📞 الهاتف: ${shop.contact}\n`;
                    if (shop?.activity) details += `💼 النشاط: ${shop.activity}\n`;
                    if (shop?.locationMap) details += `🗺️ الموقع: متوفر على الخريطة\n`;
                    
                    // Add area information from planData if available
                    if (planShop) {
                        if (planShop.id) details += `🆔 المعرف: ${planShop.id}\n`;
                        if (planShop.area) details += `🗺️ المنطقة: ${planShop.area}\n`;
                    }
                    
                    // If no detailed info found, show basic info
                    if (!shop && !planShop) {
                        details += `\n⚠️ لا توجد تفاصيل إضافية متوفرة لهذا المحل\n`;
                        details += `ℹ️ يظهر المحل في جداول التفتيش فقط\n`;
                    }
                    
                    alert(details);
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Show basic shop info even on error
                    let details = `🏪 تفاصيل المحل الأساسية\n`;
                    details += `${'='.repeat(50)}\n\n`;
                    details += `📝 الاسم: ${shopName}\n`;
                    details += `\n⚠️ فشل تحميل التفاصيل الكاملة من الخادم\n`;
                    details += `ℹ️ يرجى المحاولة مرة أخرى\n`;
                    alert(details);
                });
        }
        
        // Copy shop info
        function copyShopInfo(shopName) {
            fetch('shops_details.json?' + new Date().getTime())
                .then(response => response.json())
                .then(shopsDetails => {
                    const shop = shopsDetails[shopName];
                    if (!shop) {
                        navigator.clipboard.writeText(shopName).then(() => {
                            alert('✅ تم نسخ اسم المحل');
                        });
                        return;
                    }
                    
                    let info = `${shop.nameAr || shopName}`;
                    if (shop.nameEn) info += ` | ${shop.nameEn}`;
                    if (shop.licenseNo) info += ` | رخصة: ${shop.licenseNo}`;
                    if (shop.admCode) info += ` | ADM: ${shop.admCode}`;
                    
                    navigator.clipboard.writeText(info).then(() => {
                        alert('✅ تم نسخ معلومات المحل');
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    navigator.clipboard.writeText(shopName).then(() => {
                        alert('✅ تم نسخ اسم المحل');
                    });
                });
        }
        
        // Filter shops list
        function filterShopsList() {
            displayShopsList();
        }
        
        // Refresh shops list
        async function refreshShopsList() {
            showMessage('shopsManagementStatus', 'info', '⏳ جاري تحديث البيانات...');
            try {
                await loadPlanData();
                displayShopsList();
                showMessage('shopsManagementStatus', 'success', '✅ تم تحديث القائمة بنجاح');
            } catch (error) {
                showMessage('shopsManagementStatus', 'error', '❌ فشل تحديث البيانات: ' + error.message);
            }
        }
        
        // Open add shop modal
        function openAddShopModal() {
            document.getElementById('shopModalTitle').innerHTML = '➕ إضافة محل جديد';
            document.getElementById('shopModalId').value = '';
            document.getElementById('shopModalName').value = '';
            document.getElementById('shopModalArea').value = '';
            
            // Clear optional fields
            document.getElementById('shopModalNameEn').value = '';
            document.getElementById('shopModalLicense').value = '';
            document.getElementById('shopModalAddress').value = '';
            document.getElementById('shopModalPhone').value = '';
            document.getElementById('shopModalEmail').value = '';
            document.getElementById('shopModalGoogleMaps').value = '';
            document.getElementById('shopModalActivity').value = '';
            document.getElementById('shopModalAdmCode').value = '';
            
            // Populate areas dropdown
            const select = document.getElementById('shopModalArea');
            select.innerHTML = '<option value="">اختر المنطقة...</option>';
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
            
            document.getElementById('shopModal').style.display = 'block';
        }
        
        // Helper function to clear shop modal optional fields
        function clearShopModalOptionalFields() {
            document.getElementById('shopModalNameEn').value = '';
            document.getElementById('shopModalLicense').value = '';
            document.getElementById('shopModalAddress').value = '';
            document.getElementById('shopModalPhone').value = '';
            document.getElementById('shopModalEmail').value = '';
            document.getElementById('shopModalGoogleMaps').value = '';
            document.getElementById('shopModalActivity').value = '';
            document.getElementById('shopModalAdmCode').value = '';
        }
        
        // Helper function to hide status message after delay
        function hideStatusMessageAfterDelay(elementId, delayMs) {
            setTimeout(() => {
                const statusDiv = document.getElementById(elementId);
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }
            }, delayMs);
        }
        
        // Open edit shop modal - accepts shop ID or shop name
        async function openEditShopModal(shopIdOrName) {
            // Check if planData is loaded
            if (!planData) {
                alert('⚠️ يرجى الانتظار حتى يتم تحميل البيانات');
                return;
            }
            
            // Initialize shops array if it doesn't exist
            if (!planData.shops) {
                planData.shops = [];
            }
            
            // Try to find shop by ID first, then by name
            let shop = planData.shops.find(s => s.id === shopIdOrName);
            if (!shop) {
                // Try finding by name
                shop = planData.shops.find(s => s.name === shopIdOrName);
            }
            
            // Store whether this is an existing shop in plan-data
            const isExistingShop = !!shop;
            
            // If still not found, create a temporary shop entry for the modal
            if (!shop) {
                // This might be a shop from shops_details.json not yet in plan-data
                console.log('Shop not found in plan-data, loading from shops_details.json. Shop name:', shopIdOrName);
                shop = {
                    id: '',  // Will be found or generated when saving
                    name: shopIdOrName,
                    areaId: '',
                    area: ''
                };
            }
            
            document.getElementById('shopModalTitle').innerHTML = '✏️ تعديل محل';
            document.getElementById('shopModalId').value = shop.id || '';
            document.getElementById('shopModalName').value = shop.name;
            
            // Populate areas dropdown
            const select = document.getElementById('shopModalArea');
            select.innerHTML = '<option value="">اختر المنطقة...</option>';
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
            
            // Set initial area value if available
            if (shop.areaId) {
                select.value = shop.areaId;
            }
            
            // Clear all optional fields before loading
            clearShopModalOptionalFields();
            
            // Show modal first with basic info
            document.getElementById('shopModal').style.display = 'block';
            
            // Show loading message
            showMessage('shopModalStatus', 'info', '⏳ جاري تحميل تفاصيل المحل...');
            
            // Load additional details from shops_details.json
            try {
                const response = await fetch('shops_details.json?' + new Date().getTime());
                // Check if response is OK before parsing JSON
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const shopsDetails = await response.json();
                const details = shopsDetails[shop.name];
                
                if (details) {
                    // Always populate all fields from shops_details.json
                    document.getElementById('shopModalNameEn').value = details.nameEn || '';
                    document.getElementById('shopModalLicense').value = details.licenseNo || '';
                    document.getElementById('shopModalAddress').value = details.address || '';
                    document.getElementById('shopModalPhone').value = details.contact || '';
                    document.getElementById('shopModalEmail').value = details.email || '';
                    document.getElementById('shopModalGoogleMaps').value = details.locationMap || '';
                    document.getElementById('shopModalActivity').value = details.activity || '';
                    document.getElementById('shopModalAdmCode').value = details.admCode || '';
                    
                    // Update area from shops_details if not already set
                    // This handles both cases: shop not in planData.shops, or shop in planData but area changed
                    if (details.areaId) {
                        select.value = details.areaId;
                        // Update the shop object's areaId for proper saving
                        shop.areaId = details.areaId;
                        if (details.area) {
                            shop.area = details.area;
                        }
                    }
                    
                    // If shop doesn't have an ID yet but exists in shops_details, find or create the ID
                    if (!shop.id && !isExistingShop) {
                        // Look for an existing shop in planData.shops by name
                        const existingShop = planData.shops.find(s => s.name === shop.name);
                        if (existingShop) {
                            // Shop exists in planData, use its ID
                            shop.id = existingShop.id;
                            document.getElementById('shopModalId').value = shop.id;
                        }
                    }
                    
                    // Hide loading message and show success
                    showMessage('shopModalStatus', 'success', '✅ تم تحميل جميع تفاصيل المحل بنجاح');
                    hideStatusMessageAfterDelay('shopModalStatus', 2000);
                } else {
                    // Shop not in shops_details.json
                    console.log('Shop not found in shops_details.json:', shop.name);
                    showMessage('shopModalStatus', 'warning', '⚠️ لم يتم العثور على تفاصيل إضافية لهذا المحل');
                    hideStatusMessageAfterDelay('shopModalStatus', 2000);
                }
            } catch (error) {
                console.error('Error loading shop details from shops_details.json:', error);
                showMessage('shopModalStatus', 'error', '❌ خطأ في تحميل التفاصيل: ' + error.message);
                hideStatusMessageAfterDelay('shopModalStatus', 3000);
            }
        }
        
        // Close shop modal
        function closeShopModal() {
            document.getElementById('shopModal').style.display = 'none';
        }
        
        // Save shop (add or edit)
        async function saveShop() {
            let shopId = document.getElementById('shopModalId').value.trim();
            const shopName = document.getElementById('shopModalName').value.trim();
            const areaId = document.getElementById('shopModalArea').value;
            
            // Get optional fields
            const shopNameEn = document.getElementById('shopModalNameEn').value.trim();
            const licenseNo = document.getElementById('shopModalLicense').value.trim();
            const address = document.getElementById('shopModalAddress').value.trim();
            const contact = document.getElementById('shopModalPhone').value.trim();
            const email = document.getElementById('shopModalEmail').value.trim();
            
            // ⚠️ CRITICAL: locationMap MUST be manually provided - NO AUTO-GENERATION
            // ⚠️ حرج: locationMap يجب أن يتم توفيره يدوياً - لا توليد تلقائي
            // DO NOT auto-generate Google Maps links from address or coordinates
            // لا تقم بتوليد روابط خرائط جوجل تلقائياً من العنوان أو الإحداثيات
            // Requirement: Manual Google Maps links ONLY for 100% accuracy
            // متطلب: روابط خرائط جوجل يدوية فقط لضمان دقة 100%
            const locationMap = document.getElementById('shopModalGoogleMaps').value.trim();
            
            const activity = document.getElementById('shopModalActivity').value.trim();
            const admCode = document.getElementById('shopModalAdmCode').value.trim();
            
            if (!shopName) {
                showMessage('shopModalStatus', 'error', '❌ يرجى إدخال اسم المحل');
                return;
            }
            
            if (!areaId) {
                showMessage('shopModalStatus', 'error', '❌ يرجى اختيار المنطقة');
                return;
            }
            
            showMessage('shopModalStatus', 'info', '⏳ جاري الحفظ...');
            
            try {
                let oldShopName = null;
                let isUpdate = false;
                
                // If shopId is empty, try to find existing shop by name to prevent duplicates
                if (!shopId) {
                    const existingShop = planData.shops.find(s => s.name === shopName);
                    if (existingShop) {
                        // Shop exists, this is an update operation
                        shopId = existingShop.id;
                        isUpdate = true;
                        console.log('Found existing shop by name, updating instead of creating duplicate:', shopName);
                    }
                }
                
                // Update or add shop in plan-data.json
                if (shopId) {
                    // Edit existing shop
                    const shopIndex = planData.shops.findIndex(s => s.id === shopId);
                    if (shopIndex !== -1) {
                        oldShopName = planData.shops[shopIndex].name;
                        planData.shops[shopIndex].name = shopName;
                        planData.shops[shopIndex].areaId = areaId;
                        
                        // Get area name for display
                        const area = planData.areas.find(a => a.id === areaId);
                        if (area) {
                            planData.shops[shopIndex].area = area.name;
                        }
                        console.log('Updated existing shop:', shopName);
                        isUpdate = true;
                    } else {
                        // Shop ID was provided but not found - this shouldn't happen
                        console.error('Shop ID provided but not found:', shopId);
                        showMessage('shopModalStatus', 'error', '❌ خطأ: لم يتم العثور على المحل في البيانات');
                        return;
                    }
                } else {
                    // Add new shop only if it doesn't exist
                    const area = planData.areas.find(a => a.id === areaId);
                    const newShop = {
                        id: 'shop_' + Date.now(),
                        name: shopName,
                        areaId: areaId,
                        area: area ? area.name : ''
                    };
                    planData.shops.push(newShop);
                    shopId = newShop.id; // Store the new shop ID for reference
                    console.log('Added new shop:', shopName, 'with ID:', shopId);
                }
                
                // If shop name changed, update it in all inspection data
                if (oldShopName && oldShopName !== shopName) {
                    if (planData.inspectionData) {
                        for (const inspection of planData.inspectionData) {
                            if (inspection.shops) {
                                inspection.shops = inspection.shops.map(s => 
                                    s === oldShopName ? shopName : s
                                );
                            }
                        }
                    }
                }
                
                // Save to plan-data.json on GitHub
                await savePlanDataToGitHub(`تحديث محل: ${shopName}`);
                
                // Get area name for saving to shops_details
                const area = planData.areas.find(a => a.id === areaId);
                const areaName = area ? area.name : '';
                
                // Save additional details to shops_details.json if any optional field is filled
                // Always save area and areaId to keep shops_details.json in sync
                if (shopNameEn || licenseNo || address || contact || email || locationMap || activity || admCode || areaId) {
                    await saveShopDetailsToGitHub(shopName, {
                        nameAr: shopName,
                        nameEn: shopNameEn,
                        licenseNo: licenseNo,
                        address: address,
                        contact: contact,
                        email: email,
                        locationMap: locationMap,
                        activity: activity,
                        admCode: admCode,
                        area: areaName,
                        areaId: areaId
                    });
                }
                
                // Reload plan data from GitHub to ensure we have the latest data
                await loadPlanData();
                
                // Show appropriate success message based on whether this was an update or addition
                const successMessage = isUpdate 
                    ? '✅ تم تحديث بيانات المحل بنجاح - جميع التفاصيل محفوظة' 
                    : '✅ تم إضافة المحل بنجاح - المحل ظاهر الآن في القائمة';
                showMessage('shopModalStatus', 'success', successMessage);
                setTimeout(() => {
                    closeShopModal();
                    displayShopsList();
                    populateAreas(); // Refresh main form areas
                    // Only refresh smart shop list if the modal is currently visible
                    const smartShopModal = document.getElementById('smartShopListModal');
                    if (smartShopModal && smartShopModal.style.display === 'block') {
                        updateSmartShopList(); // Refresh smart shop list if visible
                    }
                }, 1500);
                
            } catch (error) {
                showMessage('shopModalStatus', 'error', '❌ فشل الحفظ: ' + error.message);
            }
        }
        
        // Save shop details to shops_details.json on GitHub
        async function saveShopDetailsToGitHub(shopName, details) {
            try {
                // Get current shops_details.json file
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getRes.ok) {
                    throw new Error('فشل الحصول على ملف shops_details.json');
                }
                
                const file = await getRes.json();
                const sha = file.sha;
                
                // Decode and parse current content
                const currentContent = JSON.parse(decodeURIComponent(escape(atob(file.content))));
                
                // Update or add shop details - remove empty fields
                const cleanDetails = {};
                if (details.nameAr) cleanDetails.nameAr = details.nameAr;
                if (details.nameEn) cleanDetails.nameEn = details.nameEn;
                if (details.licenseNo) cleanDetails.licenseNo = details.licenseNo;
                if (details.address) cleanDetails.address = details.address;
                if (details.contact) cleanDetails.contact = details.contact;
                if (details.email) cleanDetails.email = details.email;
                if (details.locationMap) cleanDetails.locationMap = details.locationMap;
                if (details.activity) cleanDetails.activity = details.activity;
                if (details.admCode) cleanDetails.admCode = details.admCode;
                if (details.area) cleanDetails.area = details.area;
                if (details.areaId) cleanDetails.areaId = details.areaId;
                
                currentContent[shopName] = cleanDetails;
                
                // Prepare content
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(currentContent, null, 2))));
                
                // Update file
                const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `تحديث تفاصيل المحل: ${shopName}`,
                        content: content,
                        sha: sha
                    })
                });
                
                if (!updateRes.ok) {
                    throw new Error('فشل تحديث ملف shops_details.json');
                }
            } catch (error) {
                console.error('Error saving shop details:', error);
                // Don't throw - optional details save failure shouldn't block main save
            }
        }
        
        // Delete shop from shops_details.json on GitHub
        async function deleteShopDetailsFromGitHub(shopName) {
            try {
                // Get current shops_details.json file
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getRes.ok) {
                    throw new Error('فشل الحصول على ملف shops_details.json');
                }
                
                const file = await getRes.json();
                const sha = file.sha;
                
                // Decode and parse current content
                const currentContent = JSON.parse(decodeURIComponent(escape(atob(file.content))));
                
                // Check if shop exists in shops_details.json
                if (!currentContent[shopName]) {
                    return false; // Shop not found in shops_details
                }
                
                // Delete shop from shops_details
                delete currentContent[shopName];
                
                // Update global shopsDetails if it exists
                if (shopsDetails && shopsDetails[shopName]) {
                    delete shopsDetails[shopName];
                }
                
                // Prepare content
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(currentContent, null, 2))));
                
                // Update file
                const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `حذف تفاصيل المحل: ${shopName}`,
                        content: content,
                        sha: sha
                    })
                });
                
                if (!updateRes.ok) {
                    throw new Error('فشل حذف المحل من shops_details.json');
                }
                
                return true; // Successfully deleted
            } catch (error) {
                console.error('Error deleting shop from shops_details:', error);
                throw error;
            }
        }
        
        // Delete shop
        async function deleteShop(shopIdOrName) {
            // Check authentication first
            if (!githubToken) {
                alert('⚠️ يجب تسجيل الدخول أولاً لحذف المحلات');
                return;
            }
            
            // Check if planData is loaded
            if (!planData) {
                alert('⚠️ يرجى الانتظار حتى يتم تحميل البيانات');
                return;
            }
            
            // Initialize shops array if it doesn't exist
            if (!planData.shops) {
                planData.shops = [];
            }
            
            // Try to find shop by ID first, then by name in shops array
            let shop = planData.shops.find(s => s.id === shopIdOrName);
            if (!shop) {
                shop = planData.shops.find(s => s.name === shopIdOrName);
            }
            
            // Determine the shop name to delete
            let shopNameToDelete = shop ? shop.name : shopIdOrName;
            
            // Check if shop exists in inspection data
            let foundInInspections = false;
            let inspectionCount = 0;
            if (planData.inspectionData) {
                for (const inspection of planData.inspectionData) {
                    if (inspection.shops && inspection.shops.includes(shopNameToDelete)) {
                        foundInInspections = true;
                        inspectionCount++;
                    }
                }
            }
            
            // Check if shop exists in shops_details.json
            let foundInShopsDetails = false;
            if (shopsDetails && shopsDetails[shopNameToDelete]) {
                foundInShopsDetails = true;
            }
            
            // If shop not found in any source (shops array, inspection data, or shops_details)
            if (!shop && !foundInInspections && !foundInShopsDetails) {
                showMessage('shopsManagementStatus', 'error', '❌ المحل غير موجود في قاعدة البيانات');
                alert('❌ المحل غير موجود في قاعدة البيانات');
                return;
            }
            
            // Build confirmation message
            let confirmMsg = `هل أنت متأكد من حذف المحل "${shopNameToDelete}"؟\n\n`;
            if (shop) {
                confirmMsg += `📍 موجود في قائمة المحلات الرئيسية\n`;
            }
            if (foundInInspections) {
                confirmMsg += `📋 موجود في ${inspectionCount} جدول تفتيش\n`;
            }
            if (foundInShopsDetails) {
                confirmMsg += `📝 موجود في قاعدة تفاصيل المحلات\n`;
            }
            confirmMsg += `\n⚠️ هذا الإجراء لا يمكن التراجع عنه`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            showMessage('shopsManagementStatus', 'info', '⏳ جاري الحذف...');
            
            try {
                let changesCount = 0;
                
                // Remove shop from shops array if it exists there
                if (shop) {
                    const beforeCount = planData.shops.length;
                    planData.shops = planData.shops.filter(s => s.id !== shop.id && s.name !== shop.name);
                    changesCount += (beforeCount - planData.shops.length);
                }
                
                // Remove shop from all inspection data
                if (planData.inspectionData) {
                    for (const inspection of planData.inspectionData) {
                        if (inspection.shops) {
                            const beforeCount = inspection.shops.length;
                            inspection.shops = inspection.shops.filter(s => s !== shopNameToDelete);
                            changesCount += (beforeCount - inspection.shops.length);
                        }
                    }
                }
                
                // Save plan-data.json changes to GitHub if there were any changes
                let planDataChanges = changesCount;
                if (planDataChanges > 0) {
                    await savePlanDataToGitHub(`حذف محل: ${shopNameToDelete} (${planDataChanges} تعديل)`);
                }
                
                // Delete shop from shops_details.json if it exists there
                let shopsDetailsDeleted = false;
                if (foundInShopsDetails) {
                    try {
                        await deleteShopDetailsFromGitHub(shopNameToDelete);
                        shopsDetailsDeleted = true;
                    } catch (error) {
                        console.error('Error deleting from shops_details:', error);
                        // Continue even if shops_details deletion fails
                    }
                }
                
                // Build success message
                let successMsg = '✅ تم حذف المحل بنجاح';
                if (planDataChanges > 0 && shopsDetailsDeleted) {
                    successMsg += ` (${planDataChanges} تعديل في plan-data + حذف من shops_details)`;
                } else if (planDataChanges > 0) {
                    successMsg += ` (${planDataChanges} تعديل في plan-data)`;
                } else if (shopsDetailsDeleted) {
                    successMsg += ` (حذف من shops_details فقط)`;
                }
                
                showMessage('shopsManagementStatus', 'success', successMsg);
                displayShopsList();
                populateAreas(); // Refresh main form areas
                
                // If the area shops view modal is open, refresh it
                const areaShopsModal = document.getElementById('areaShopsViewModal');
                if (areaShopsModal && areaShopsModal.style.display === 'block') {
                    loadShopsForSelectedArea();
                }
                
            } catch (error) {
                console.error('Error deleting shop:', error);
                showMessage('shopsManagementStatus', 'error', '❌ فشل الحذف: ' + error.message);
                alert('❌ فشل الحذف: ' + error.message);
            }
        }
        
        // Copy shop ID
        function copyShopId(shopId) {
            navigator.clipboard.writeText(shopId).then(() => {
                showMessage('shopsManagementStatus', 'success', '✅ تم نسخ المعرف');
            });
        }
        
        // Export shops data
        function exportShopsData() {
            if (!planData || !planData.shops) return;
            
            const dataStr = JSON.stringify(planData.shops, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'shops-export-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
            
            showMessage('shopsManagementStatus', 'success', '✅ تم تصدير البيانات');
        }
        
        // Find orphan shops (shops in inspection data but not in shops array)
        function findOrphanShops() {
            if (!planData || !planData.inspectionData) {
                alert('❌ لا توجد بيانات متاحة');
                return;
            }
            
            // Get all shops from shops array
            const shopsInArray = new Set(planData.shops.map(s => s.name));
            
            // Get all unique shops from inspection data
            const shopsInInspections = new Set();
            planData.inspectionData.forEach(inspection => {
                if (inspection.shops) {
                    inspection.shops.forEach(shop => shopsInInspections.add(shop));
                }
            });
            
            // Find orphan shops
            const orphanShops = Array.from(shopsInInspections).filter(shop => !shopsInArray.has(shop));
            
            if (orphanShops.length === 0) {
                alert(`✅ لا توجد محلات معزولة!\n\nجميع المحلات في جداول التفتيش (${shopsInInspections.size}) موجودة في قائمة المحلات الرئيسية (${shopsInArray.size})`);
                return;
            }
            
            // Show report
            let report = `📊 تقرير المحلات المعزولة\n`;
            report += `${'='.repeat(50)}\n\n`;
            report += `إجمالي المحلات في جداول التفتيش: ${shopsInInspections.size}\n`;
            report += `إجمالي المحلات في القائمة الرئيسية: ${shopsInArray.size}\n`;
            report += `المحلات المعزولة (موجودة في التفتيش فقط): ${orphanShops.length}\n\n`;
            report += `قائمة المحلات المعزولة:\n`;
            report += `${'='.repeat(50)}\n`;
            
            orphanShops.sort().forEach((shop, idx) => {
                report += `${idx + 1}. ${shop}\n`;
            });
            
            report += `\n${'='.repeat(50)}\n`;
            report += `💡 نصيحة: يمكنك إضافة هذه المحلات إلى القائمة الرئيسية\n`;
            report += `من خلال زر "إضافة محل جديد" في إدارة المحلات`;
            
            // Create a modal to show the report
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                max-width: 90%;
                max-height: 90%;
                overflow: auto;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            `;
            
            const pre = document.createElement('pre');
            pre.textContent = report;
            pre.style.cssText = `
                white-space: pre-wrap;
                font-family: 'Cairo', monospace;
                font-size: 14px;
                line-height: 1.6;
                direction: rtl;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '✖ إغلاق';
            closeBtn.className = 'btn btn-secondary';
            closeBtn.style.cssText = 'margin-top: 20px; width: 100%; padding: 10px;';
            closeBtn.onclick = () => document.body.removeChild(modal);
            
            content.appendChild(pre);
            content.appendChild(closeBtn);
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Also log to console for developers
            console.log('Orphan Shops Report:', orphanShops);
        }
        
        // ============================================
        // AREAS MANAGEMENT FUNCTIONS
        // ============================================
        
        // Load areas management tab
        function loadAreasManagement() {
            displayAreasList();
        }
        
        // Display areas list
        function displayAreasList() {
            const tbody = document.getElementById('areasManagementBody');
            const searchTerm = document.getElementById('searchArea').value.toLowerCase();
            
            if (!planData || !planData.areas) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">لا توجد بيانات</td></tr>';
                return;
            }
            
            let filteredAreas = planData.areas.filter(area => {
                return area.name.toLowerCase().includes(searchTerm);
            });
            
            // Update statistics
            const totalShops = planData.shops ? planData.shops.length : 0;
            document.getElementById('totalAreasManagement').textContent = planData.areas.length;
            document.getElementById('filteredAreasCount').textContent = filteredAreas.length;
            document.getElementById('totalShopsInAreas').textContent = totalShops;
            
            if (filteredAreas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">لا توجد مناطق مطابقة</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            filteredAreas.forEach(area => {
                const shopsCount = planData.shops.filter(s => s.areaId === area.id).length;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${area.name}</td>
                    <td style="font-family: monospace; font-size: 0.85em;">${area.id}</td>
                    <td>${shopsCount} محل</td>
                    <td>
                        <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                            <button class="action-btn action-btn-view" onclick="viewAreaShops('${area.id}')" title="عرض المحلات" role="button" aria-label="عرض محلات المنطقة">
                                <span>🏪</span>
                                <span class="action-btn-text">محلات</span>
                            </button>
                            <button class="action-btn action-btn-edit" onclick="openEditAreaModal('${area.id}')" title="تعديل المنطقة">
                                <span>✏️</span>
                                <span class="action-btn-text">تعديل</span>
                            </button>
                            <button class="action-btn action-btn-delete" onclick="deleteArea('${area.id}')" title="حذف المنطقة">
                                <span>🗑️</span>
                                <span class="action-btn-text">حذف</span>
                            </button>
                            <button class="action-btn action-btn-copy" onclick="copyAreaId('${area.id}')" title="نسخ المعرف">
                                <span>📋</span>
                                <span class="action-btn-text">نسخ</span>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Filter areas list
        function filterAreasList() {
            displayAreasList();
        }
        
        // Refresh areas list
        async function refreshAreasList() {
            showMessage('areasManagementStatus', 'info', '⏳ جاري تحديث البيانات...');
            try {
                await loadPlanData();
                displayAreasList();
                showMessage('areasManagementStatus', 'success', '✅ تم تحديث القائمة بنجاح');
            } catch (error) {
                showMessage('areasManagementStatus', 'error', '❌ فشل تحديث البيانات: ' + error.message);
            }
        }
        
        // Sort areas by name
        function sortAreasByName() {
            if (!planData || !planData.areas) return;
            
            planData.areas.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            displayAreasList();
            showMessage('areasManagementStatus', 'success', '✅ تم ترتيب المناطق أبجدياً');
        }
        
        // Sort areas by smart priority (areas with more shops and lower ratings get priority)
        function sortAreasBySmartPriority() {
            if (!planData || !planData.areas) return;
            
            planData.areas.sort((a, b) => {
                // Calculate priority score for each area
                const scoreA = calculateAreaPriorityScore(a);
                const scoreB = calculateAreaPriorityScore(b);
                return scoreB - scoreA; // Higher priority first
            });
            
            displayAreasList();
            showMessage('areasManagementStatus', 'success', '✅ تم ترتيب المناطق حسب الأولوية الذكية');
        }
        
        // Sort areas by shop count (descending)
        function sortAreasByShopCount() {
            if (!planData || !planData.areas) return;
            
            planData.areas.sort((a, b) => {
                const countA = planData.shops.filter(s => s.areaId === a.id).length;
                const countB = planData.shops.filter(s => s.areaId === b.id).length;
                return countB - countA; // More shops first
            });
            
            displayAreasList();
            showMessage('areasManagementStatus', 'success', '✅ تم ترتيب المناطق حسب عدد المحلات');
        }
        
        // Calculate area priority score
        function calculateAreaPriorityScore(area) {
            let score = 0;
            
            // Get shops in this area
            const shopsInArea = planData.shops.filter(s => s.areaId === area.id);
            const shopCount = shopsInArea.length;
            
            // 1. Shop count factor (0-40 points) - More shops = higher priority
            score += Math.min(shopCount * 4, 40);
            
            // 2. Average rating factor (0-40 points) - Lower average rating = higher priority
            if (shopCount > 0 && shopsDetails) {
                let totalRating = 0;
                let ratedShops = 0;
                
                shopsInArea.forEach(shop => {
                    const shopDetail = shopsDetails[shop.name];
                    if (shopDetail) {
                        const ratingData = calculateShopRating(shop.name);
                        totalRating += ratingData.rating;
                        ratedShops++;
                    }
                });
                
                if (ratedShops > 0) {
                    const avgRating = totalRating / ratedShops;
                    // Invert: 0% avg rating = 40 points, 100% avg rating = 0 points
                    score += (100 - avgRating) * 0.4;
                }
            }
            
            // 3. Inspection coverage factor (0-20 points) - Fewer inspected shops = higher priority
            if (shopCount > 0) {
                const inspectedShops = shopsInArea.filter(shop => {
                    const lastInsp = getLastInspectionForShop(shop.name);
                    return lastInsp !== null;
                }).length;
                const coveragePercent = (inspectedShops / shopCount) * 100;
                // Lower coverage = higher priority
                score += (100 - coveragePercent) * 0.2;
            }
            
            return score;
        }
        
        // Open add area modal
        function openAddAreaModal() {
            document.getElementById('areaModalTitle').innerHTML = '➕ إضافة منطقة جديدة';
            document.getElementById('areaModalId').value = '';
            document.getElementById('areaModalName').value = '';
            document.getElementById('areaModal').style.display = 'block';
        }
        
        // Open edit area modal
        function openEditAreaModal(areaId) {
            // Check if planData is loaded
            if (!planData) {
                alert('⚠️ يرجى الانتظار حتى يتم تحميل البيانات');
                return;
            }
            
            // Initialize areas array if it doesn't exist
            if (!planData.areas) {
                planData.areas = [];
            }
            
            const area = planData.areas.find(a => a.id === areaId);
            if (!area) return;
            
            document.getElementById('areaModalTitle').innerHTML = '✏️ تعديل منطقة';
            document.getElementById('areaModalId').value = area.id;
            document.getElementById('areaModalName').value = area.name;
            document.getElementById('areaModal').style.display = 'block';
        }
        
        // Close area modal
        function closeAreaModal() {
            document.getElementById('areaModal').style.display = 'none';
        }
        
        // Save area (add or edit)
        async function saveArea() {
            const areaId = document.getElementById('areaModalId').value;
            const areaName = document.getElementById('areaModalName').value.trim();
            
            if (!areaName) {
                showMessage('areaModalStatus', 'error', '❌ يرجى إدخال اسم المنطقة');
                return;
            }
            
            showMessage('areaModalStatus', 'info', '⏳ جاري الحفظ...');
            
            try {
                if (areaId) {
                    // Edit existing area
                    const areaIndex = planData.areas.findIndex(a => a.id === areaId);
                    if (areaIndex !== -1) {
                        planData.areas[areaIndex].name = areaName;
                    }
                } else {
                    // Add new area
                    const newArea = {
                        id: 'area_' + Date.now(),
                        name: areaName
                    };
                    planData.areas.push(newArea);
                }
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('areaModalStatus', 'success', '✅ تم الحفظ بنجاح');
                setTimeout(() => {
                    closeAreaModal();
                    displayAreasList();
                    populateAreas(); // Refresh main form areas
                    populateShopAreaFilter(); // Refresh shops filter
                }, 1000);
                
            } catch (error) {
                showMessage('areaModalStatus', 'error', '❌ فشل الحفظ: ' + error.message);
            }
        }
        
        // Delete area
        async function deleteArea(areaId) {
            // Check authentication first
            if (!githubToken) {
                alert('⚠️ يجب تسجيل الدخول أولاً لحذف المناطق');
                return;
            }
            
            // Check if planData is loaded
            if (!planData) {
                alert('⚠️ يرجى الانتظار حتى يتم تحميل البيانات');
                return;
            }
            
            // Initialize arrays if they don't exist
            if (!planData.areas) {
                planData.areas = [];
            }
            if (!planData.shops) {
                planData.shops = [];
            }
            
            const area = planData.areas.find(a => a.id === areaId);
            if (!area) return;
            
            // Check if area has shops
            const shopsInArea = planData.shops.filter(s => s.areaId === areaId).length;
            if (shopsInArea > 0) {
                if (!confirm(`المنطقة "${area.name}" تحتوي على ${shopsInArea} محل. هل أنت متأكد من الحذف؟\nسيتم نقل المحلات إلى "غير محدد".`)) {
                    return;
                }
            } else {
                if (!confirm(`هل أنت متأكد من حذف المنطقة "${area.name}"؟`)) {
                    return;
                }
            }
            
            showMessage('areasManagementStatus', 'info', '⏳ جاري الحذف...');
            
            try {
                // Remove area from array
                planData.areas = planData.areas.filter(a => a.id !== areaId);
                
                // Update shops that belong to this area (set to null or empty)
                planData.shops.forEach(shop => {
                    if (shop.areaId === areaId) {
                        shop.areaId = '';
                    }
                });
                
                // Save to GitHub
                await savePlanDataToGitHub(`حذف منطقة: ${area.name}`);
                
                showMessage('areasManagementStatus', 'success', '✅ تم حذف المنطقة بنجاح');
                displayAreasList();
                populateAreas(); // Refresh main form areas
                
            } catch (error) {
                showMessage('areasManagementStatus', 'error', '❌ فشل الحذف: ' + error.message);
            }
        }
        
        // Copy area ID
        function copyAreaId(areaId) {
            navigator.clipboard.writeText(areaId).then(() => {
                showMessage('areasManagementStatus', 'success', '✅ تم نسخ المعرف');
            });
        }
        
        // ============================================
        // SHOPS BY AREA VIEW FUNCTIONS
        // ============================================
        
        // Open shops by area modal
        function openShopsByAreaModal() {
            document.getElementById('shopsByAreaModal').style.display = 'block';
            populateShopsByAreaFilter();
            updateShopsByAreaView();
        }
        
        // Close shops by area modal
        function closeShopsByAreaModal() {
            document.getElementById('shopsByAreaModal').style.display = 'none';
        }
        
        // Populate area filter for shops by area view
        function populateShopsByAreaFilter() {
            const select = document.getElementById('shopsByAreaFilter');
            select.innerHTML = '<option value="">جميع المناطق</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Update shops by area view
        async function updateShopsByAreaView() {
            const searchTerm = document.getElementById('shopsByAreaSearch').value.toLowerCase();
            const filterAreaId = document.getElementById('shopsByAreaFilter').value;
            const viewType = document.getElementById('shopsByAreaViewType').value;
            const contentDiv = document.getElementById('shopsByAreaContent');
            
            // Use global shopsDetails for consistency, ensuring all shops are visible
            let currentShopsDetails = shopsDetails || {};
            
            // If global shopsDetails is not loaded, try loading from local file
            if (!shopsDetails || Object.keys(shopsDetails).length === 0) {
                try {
                    const response = await fetch('shops_details.json?' + new Date().getTime());
                    if (response.ok) {
                        currentShopsDetails = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading shops_details.json:', error);
                }
            }
            
            // Create combined shop list
            const allShops = [];
            
            // Add ALL shops from shops_details.json
            Object.entries(currentShopsDetails).forEach(([shopName, shopInfo]) => {
                allShops.push({
                    name: shopInfo.nameAr || shopName,
                    nameEn: shopInfo.nameEn || '',
                    licenseNo: shopInfo.licenseNo || '',
                    admCode: shopInfo.admCode || '',
                    address: shopInfo.address || '',
                    contact: shopInfo.contact || '',
                    locationMap: shopInfo.locationMap || '',
                    activity: shopInfo.activity || '',
                    area: shopInfo.area || '',
                    areaId: shopInfo.areaId || '',
                });
            });
            
            // Add shops from plan-data.json if not already in list
            if (planData && planData.shops) {
                planData.shops.forEach(shop => {
                    if (!allShops.find(s => s.name === shop.name)) {
                        allShops.push(shop);
                    }
                });
            }
            
            // Filter shops
            let filteredShops = allShops.filter(shop => {
                const matchesSearch = shop.name.toLowerCase().includes(searchTerm) ||
                                    (shop.nameEn && shop.nameEn.toLowerCase().includes(searchTerm)) ||
                                    (shop.licenseNo && shop.licenseNo.toLowerCase().includes(searchTerm));
                const matchesArea = !filterAreaId || shop.areaId === filterAreaId;
                return matchesSearch && matchesArea;
            });
            
            // Update statistics
            const uniqueAreas = new Set(allShops.map(s => s.areaId).filter(id => id));
            document.getElementById('shopsByAreaTotalShops').textContent = allShops.length;
            document.getElementById('shopsByAreaTotalAreas').textContent = uniqueAreas.size;
            document.getElementById('shopsByAreaDisplayed').textContent = filteredShops.length;
            
            // Display based on view type
            if (viewType === 'grouped') {
                displayShopsGroupedByArea(filteredShops, contentDiv);
            } else {
                displayShopsAsList(filteredShops, contentDiv);
            }
        }
        
        // Display shops grouped by area
        function displayShopsGroupedByArea(shops, contentDiv) {
            const shopsByArea = {};
            
            // Group shops by area
            shops.forEach(shop => {
                const area = planData?.areas?.find(a => a.id === shop.areaId);
                const areaName = area ? area.name : (shop.area || 'غير محدد');
                const areaId = shop.areaId || 'unknown';
                
                if (!shopsByArea[areaId]) {
                    shopsByArea[areaId] = {
                        name: areaName,
                        shops: []
                    };
                }
                shopsByArea[areaId].shops.push(shop);
            });
            
            let html = '';
            
            // Sort areas alphabetically
            const sortedAreas = Object.entries(shopsByArea).sort((a, b) => 
                a[1].name.localeCompare(b[1].name, 'ar')
            );
            
            sortedAreas.forEach(([areaId, areaData]) => {
                html += `
                    <div style="margin-bottom: 30px; background: #f8f9fa; padding: 20px; border-radius: 10px; border-right: 5px solid #e74c3c;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
                            <span>
                                <span style="color: #e74c3c;">📍</span> ${areaData.name}
                                <span style="background: #e74c3c; color: white; padding: 3px 12px; border-radius: 15px; font-size: 0.85em; margin-right: 10px;">
                                    ${areaData.shops.length} محل
                                </span>
                            </span>
                            <button class="btn btn-sm btn-primary" onclick="viewAreaShops('${areaId}')" style="padding: 5px 15px;">
                                <span>🔍</span> عرض التفاصيل
                            </button>
                        </h3>
                        <div style="overflow-x: auto;">
                            <table class="inspections-table">
                                <thead>
                                    <tr>
                                        <th>اسم المحل</th>
                                        <th>رقم الرخصة</th>
                                        <th>كود ADM</th>
                                        <th>العنوان</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                areaData.shops.forEach(shop => {
                    html += `
                        <tr>
                            <td>
                                <strong>${shop.name}</strong>
                                ${shop.nameEn ? `<br><small style="color: #666;">${shop.nameEn}</small>` : ''}
                            </td>
                            <td>${shop.licenseNo || '-'}</td>
                            <td style="font-family: monospace;">${shop.admCode || '-'}</td>
                            <td>${shop.address || '-'}</td>
                            <td>
                                <span class="action-icon" onclick="viewShopDetails('${escapeJs(shop.name)}')" title="عرض التفاصيل" style="color: #3498db;">👁️</span>
                                ${shop.locationMap ? `<span class="action-icon" onclick="window.open('${shop.locationMap}', '_blank')" title="موقع على الخريطة" style="color: #27ae60;">🗺️</span>` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<p style="text-align: center; padding: 40px; color: #999;">لا توجد محلات مطابقة</p>';
            }
            
            contentDiv.innerHTML = html;
        }
        
        // Display shops as a list
        function displayShopsAsList(shops, contentDiv) {
            let html = `
                <div style="overflow-x: auto;">
                    <table class="inspections-table">
                        <thead>
                            <tr>
                                <th>اسم المحل</th>
                                <th>المنطقة</th>
                                <th>رقم الرخصة</th>
                                <th>كود ADM</th>
                                <th>العنوان</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            shops.forEach(shop => {
                const area = planData?.areas?.find(a => a.id === shop.areaId);
                const areaName = area ? area.name : (shop.area || 'غير محدد');
                
                html += `
                    <tr>
                        <td>
                            <strong>${shop.name}</strong>
                            ${shop.nameEn ? `<br><small style="color: #666;">${shop.nameEn}</small>` : ''}
                        </td>
                        <td><span style="background: #e74c3c; color: white; padding: 3px 10px; border-radius: 5px; font-size: 0.9em;">${areaName}</span></td>
                        <td>${shop.licenseNo || '-'}</td>
                        <td style="font-family: monospace;">${shop.admCode || '-'}</td>
                        <td>${shop.address || '-'}</td>
                        <td>
                            <span class="action-icon" onclick="viewShopDetails('${escapeJs(shop.name)}')" title="عرض التفاصيل" style="color: #3498db;">👁️</span>
                            ${shop.locationMap ? `<span class="action-icon" onclick="window.open('${shop.locationMap}', '_blank')" title="موقع على الخريطة" style="color: #27ae60;">🗺️</span>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            if (shops.length === 0) {
                html = '<p style="text-align: center; padding: 40px; color: #999;">لا توجد محلات مطابقة</p>';
            }
            
            contentDiv.innerHTML = html;
        }
        
        // ============================================
        // AREA SHOPS VIEW FUNCTIONS (View shops of specific area)
        // ============================================
        
        // Open area shops view modal
        function openAreaShopsViewModal() {
            document.getElementById('areaShopsViewModal').style.display = 'block';
            populateAreaShopsViewSelect();
        }
        
        // Close area shops view modal
        function closeAreaShopsViewModal() {
            document.getElementById('areaShopsViewModal').style.display = 'none';
            document.getElementById('selectedAreaInfo').style.display = 'none';
            document.getElementById('areaShopsViewContent').innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">اختر منطقة لعرض المحلات التابعة لها</p>';
        }
        
        // Populate area select for area shops view
        function populateAreaShopsViewSelect() {
            const select = document.getElementById('areaShopsViewSelect');
            select.innerHTML = '<option value="">-- اختر منطقة --</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load shops for selected area
        async function loadShopsForSelectedArea() {
            const areaId = document.getElementById('areaShopsViewSelect').value;
            const contentDiv = document.getElementById('areaShopsViewContent');
            const infoDiv = document.getElementById('selectedAreaInfo');
            
            if (!areaId) {
                infoDiv.style.display = 'none';
                contentDiv.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">اختر منطقة لعرض المحلات التابعة لها</p>';
                return;
            }
            
            const area = planData?.areas?.find(a => a.id === areaId);
            if (!area) {
                showMessage('areaShopsViewStatus', 'error', '❌ المنطقة غير موجودة');
                return;
            }
            
            // Show area info
            infoDiv.style.display = 'block';
            document.getElementById('selectedAreaName').textContent = area.name;
            
            // Use global shopsDetails for consistency
            let currentShopsDetails = shopsDetails || {};
            
            // If global shopsDetails is not loaded, try loading from local file
            if (!shopsDetails || Object.keys(shopsDetails).length === 0) {
                try {
                    const response = await fetch('shops_details.json?' + new Date().getTime());
                    if (response.ok) {
                        currentShopsDetails = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading shops_details.json:', error);
                }
            }
            
            // Get shops for this area
            const areaShops = [];
            
            // From shops_details.json
            Object.entries(currentShopsDetails).forEach(([shopName, shopInfo]) => {
                if (shopInfo.areaId === areaId) {
                    areaShops.push({
                        name: shopInfo.nameAr || shopName,
                        nameEn: shopInfo.nameEn || '',
                        licenseNo: shopInfo.licenseNo || '',
                        admCode: shopInfo.admCode || '',
                        address: shopInfo.address || '',
                        contact: shopInfo.contact || '',
                        locationMap: shopInfo.locationMap || '',
                        activity: shopInfo.activity || '',
                    });
                }
            });
            
            // From plan-data.json
            if (planData && planData.shops) {
                planData.shops.forEach(shop => {
                    if (shop.areaId === areaId && !areaShops.find(s => s.name === shop.name)) {
                        areaShops.push(shop);
                    }
                });
            }
            
            // Count inspections for this area
            const inspectionsCount = planData?.inspectionData?.filter(insp => insp.area === area.name).length || 0;
            
            // Update statistics
            document.getElementById('selectedAreaShopsCount').textContent = areaShops.length;
            document.getElementById('selectedAreaInspections').textContent = inspectionsCount;
            
            // Display shops
            if (areaShops.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #fff3cd; border-radius: 10px; color: #856404;">
                        <h3>⚠️ لا توجد محلات في هذه المنطقة</h3>
                        <p style="margin-top: 10px;">يمكنك إضافة محلات جديدة أو نقل محلات من مناطق أخرى</p>
                        <button class="btn btn-success" onclick="closeAreaShopsViewModal(); openAddShopModal();" style="margin-top: 15px;">
                            <span>➕</span> إضافة محل جديد
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50;">📋 قائمة المحلات (${areaShops.length} محل)</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="closeAreaShopsViewModal(); openAddShopModal();">
                                <span>➕</span> إضافة محل
                            </button>
                            <button class="btn btn-warning" onclick="openMoveShopsFromArea('${areaId}')">
                                <span>↔️</span> نقل محلات
                            </button>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="inspections-table">
                            <thead>
                                <tr>
                                    <th>اسم المحل</th>
                                    <th>رقم الرخصة</th>
                                    <th>كود ADM</th>
                                    <th>العنوان</th>
                                    <th>الهاتف</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            areaShops.forEach((shop, idx) => {
                html += `
                    <tr>
                        <td>
                            <strong>${shop.name}</strong>
                            ${shop.nameEn ? `<br><small style="color: #666;">${shop.nameEn}</small>` : ''}
                        </td>
                        <td>${shop.licenseNo || '-'}</td>
                        <td style="font-family: monospace;">${shop.admCode || '-'}</td>
                        <td>${shop.address || '-'}</td>
                        <td>${shop.contact || '-'}</td>
                        <td>
                            <span class="action-icon" onclick="viewShopDetails('${escapeJs(shop.name)}')" title="عرض التفاصيل" style="color: #3498db;">👁️</span>
                            <span class="action-icon edit-icon" onclick="openEditShopModal('${escapeJs(shop.name)}')" title="تعديل">✏️</span>
                            <span class="action-icon delete-icon" onclick="deleteShop('${escapeJs(shop.name)}')" title="حذف">🗑️</span>
                            ${shop.locationMap ? `<span class="action-icon" onclick="window.open('${shop.locationMap}', '_blank')" title="موقع على الخريطة" style="color: #27ae60;">🗺️</span>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = html;
        }
        
        // View shops for a specific area (called from areas table)
        function viewAreaShops(areaId) {
            openAreaShopsViewModal();
            document.getElementById('areaShopsViewSelect').value = areaId;
            loadShopsForSelectedArea();
        }
        
        // ============================================
        // MOVE SHOPS BETWEEN AREAS FUNCTIONS
        // ============================================
        
        let selectedShopsForMove = [];
        
        // Open move shops modal
        function openMoveShopsModal() {
            document.getElementById('moveShopsModal').style.display = 'block';
            populateMoveShopsAreas();
            selectedShopsForMove = [];
            document.getElementById('moveShopsSelection').style.display = 'none';
            document.getElementById('moveShopsDestination').style.display = 'none';
        }
        
        // Open move shops modal from a specific area
        function openMoveShopsFromArea(areaId) {
            closeAreaShopsViewModal();
            openMoveShopsModal();
            document.getElementById('moveShopsSourceArea').value = areaId;
            loadShopsForMove();
        }
        
        // Close move shops modal
        function closeMoveShopsModal() {
            document.getElementById('moveShopsModal').style.display = 'none';
            selectedShopsForMove = [];
        }
        
        // Populate area selects for move shops
        function populateMoveShopsAreas() {
            const sourceSelect = document.getElementById('moveShopsSourceArea');
            const targetSelect = document.getElementById('moveShopsTargetArea');
            
            sourceSelect.innerHTML = '<option value="">-- اختر المنطقة المصدر --</option>';
            targetSelect.innerHTML = '<option value="">-- اختر المنطقة المستهدفة --</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option1 = document.createElement('option');
                    option1.value = area.id;
                    option1.textContent = area.name;
                    sourceSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = area.id;
                    option2.textContent = area.name;
                    targetSelect.appendChild(option2);
                });
            }
        }
        
        // Load shops for move
        async function loadShopsForMove() {
            const areaId = document.getElementById('moveShopsSourceArea').value;
            const listDiv = document.getElementById('moveShopsList');
            
            if (!areaId) {
                document.getElementById('moveShopsSelection').style.display = 'none';
                document.getElementById('moveShopsDestination').style.display = 'none';
                return;
            }
            
            // Use global shopsDetails for consistency
            let currentShopsDetails = shopsDetails || {};
            
            // If global shopsDetails is not loaded, try loading from local file
            if (!shopsDetails || Object.keys(shopsDetails).length === 0) {
                try {
                    const response = await fetch('shops_details.json?' + new Date().getTime());
                    if (response.ok) {
                        currentShopsDetails = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading shops_details.json:', error);
                }
            }
            
            // Get shops for this area
            const areaShops = [];
            
            // From shops_details.json
            Object.entries(currentShopsDetails).forEach(([shopName, shopInfo]) => {
                if (shopInfo.areaId === areaId) {
                    areaShops.push({
                        name: shopInfo.nameAr || shopName,
                        originalName: shopName,
                        areaId: areaId
                    });
                }
            });
            
            // From plan-data.json
            if (planData && planData.shops) {
                planData.shops.forEach(shop => {
                    if (shop.areaId === areaId && !areaShops.find(s => s.name === shop.name)) {
                        areaShops.push({
                            name: shop.name,
                            originalName: shop.name,
                            areaId: areaId
                        });
                    }
                });
            }
            
            if (areaShops.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">لا توجد محلات في هذه المنطقة</p>';
                document.getElementById('moveShopsSelection').style.display = 'block';
                document.getElementById('moveShopsDestination').style.display = 'none';
                return;
            }
            
            // Display shops as checkboxes
            let html = '';
            areaShops.forEach((shop, idx) => {
                html += `
                    <div style="padding: 8px; border-bottom: 1px solid #dee2e6;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" class="move-shop-checkbox" value="${idx}" data-shop-name="${escapeHtml(shop.originalName)}" onchange="updateMoveShopsCount()" style="margin-left: 10px; transform: scale(1.3);">
                            <span style="font-weight: 500;">${shop.name}</span>
                        </label>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
            document.getElementById('moveShopsSelection').style.display = 'block';
            document.getElementById('moveShopsDestination').style.display = 'block';
            updateMoveShopsCount();
        }
        
        // Select all shops for move
        function selectAllShopsForMove() {
            document.querySelectorAll('.move-shop-checkbox').forEach(cb => {
                cb.checked = true;
            });
            updateMoveShopsCount();
        }
        
        // Deselect all shops for move
        function deselectAllShopsForMove() {
            document.querySelectorAll('.move-shop-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateMoveShopsCount();
        }
        
        // Update move shops count
        function updateMoveShopsCount() {
            const checkedBoxes = document.querySelectorAll('.move-shop-checkbox:checked');
            const count = checkedBoxes.length;
            const countSpan = document.getElementById('moveShopsSelectedCount');
            
            if (count > 0) {
                countSpan.textContent = `تم تحديد ${count} محل`;
                countSpan.style.color = '#28a745';
            } else {
                countSpan.textContent = 'لم يتم تحديد أي محل';
                countSpan.style.color = '#dc3545';
            }
        }
        
        // Execute move shops
        async function executeMoveShops() {
            const sourceAreaId = document.getElementById('moveShopsSourceArea').value;
            const targetAreaId = document.getElementById('moveShopsTargetArea').value;
            const checkedBoxes = document.querySelectorAll('.move-shop-checkbox:checked');
            
            if (!sourceAreaId) {
                showMessage('moveShopsStatus', 'error', '❌ يرجى اختيار المنطقة المصدر');
                return;
            }
            
            if (checkedBoxes.length === 0) {
                showMessage('moveShopsStatus', 'error', '❌ يرجى تحديد محل واحد على الأقل');
                return;
            }
            
            if (!targetAreaId) {
                showMessage('moveShopsStatus', 'error', '❌ يرجى اختيار المنطقة المستهدفة');
                return;
            }
            
            const sourceArea = planData.areas.find(a => a.id === sourceAreaId);
            const targetArea = planData.areas.find(a => a.id === targetAreaId);
            
            if (!sourceArea || !targetArea) {
                showMessage('moveShopsStatus', 'error', '❌ المنطقة غير موجودة');
                return;
            }
            
            // Get selected shop names
            const shopNames = Array.from(checkedBoxes).map(cb => cb.getAttribute('data-shop-name'));
            
            if (!confirm(`هل أنت متأكد من نقل ${shopNames.length} محل من "${sourceArea.name}" إلى "${targetArea.name}"؟`)) {
                return;
            }
            
            showMessage('moveShopsStatus', 'info', '⏳ جاري نقل المحلات...');
            
            try {
                // Use global shopsDetails for consistency
                let currentShopsDetails = shopsDetails || {};
                
                // If global shopsDetails is not loaded, try loading from local file
                if (!shopsDetails || Object.keys(shopsDetails).length === 0) {
                    try {
                        const response = await fetch('shops_details.json?' + new Date().getTime());
                        if (response.ok) {
                            currentShopsDetails = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading shops_details.json:', error);
                    }
                }
                
                // Update shops in shops_details.json
                let updatedCount = 0;
                shopNames.forEach(shopName => {
                    if (currentShopsDetails[shopName]) {
                        currentShopsDetails[shopName].areaId = targetAreaId;
                        currentShopsDetails[shopName].area = targetArea.name;
                        updatedCount++;
                    }
                });
                
                // Update shops in plan-data.json
                if (planData && planData.shops) {
                    planData.shops.forEach(shop => {
                        if (shopNames.includes(shop.name)) {
                            shop.areaId = targetAreaId;
                            shop.area = targetArea.name;
                            updatedCount++;
                        }
                    });
                }
                
                // Note: Currently only updating plan-data.json
                // shops_details.json is maintained separately and loaded read-only for display purposes
                planData.lastUpdate = new Date().toISOString();
                await savePlanDataToGitHub(`نقل ${shopNames.length} محل من ${sourceArea.name} إلى ${targetArea.name}`);
                
                showMessage('moveShopsStatus', 'success', `✅ تم نقل ${shopNames.length} محل بنجاح إلى "${targetArea.name}"`);
                
                setTimeout(() => {
                    closeMoveShopsModal();
                    // Refresh displays
                    if (document.getElementById('shopsByAreaModal').style.display === 'block') {
                        updateShopsByAreaView();
                    }
                    if (document.getElementById('shopsTab').classList.contains('active')) {
                        displayShopsList();
                    }
                    if (document.getElementById('areasTab').classList.contains('active')) {
                        displayAreasList();
                    }
                }, 2000);
                
            } catch (error) {
                showMessage('moveShopsStatus', 'error', '❌ فشل نقل المحلات: ' + error.message);
            }
        }
        
        // ============================================
        // MAINTENANCE CONTROL FUNCTIONS
        // ============================================
        
        let maintenanceConfigData = null;
        let maintenanceStatusData = null;
        
        // Load maintenance configuration
        async function loadMaintenanceConfig() {
            try {
                // Load maintenance-config.json
                const configRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-config.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (configRes.ok) {
                    const configFile = await configRes.json();
                    maintenanceConfigData = JSON.parse(decodeURIComponent(escape(atob(configFile.content))));
                }
                
                // Load maintenance-status.json
                const statusRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (statusRes.ok) {
                    const statusFile = await statusRes.json();
                    maintenanceStatusData = JSON.parse(decodeURIComponent(escape(atob(statusFile.content))));
                }
                
                // Update UI with loaded data
                updateMaintenanceUI();
                
            } catch (error) {
                console.error('Error loading maintenance config:', error);
            }
        }
        
        // Update maintenance UI with current values
        function updateMaintenanceUI() {
            if (!maintenanceConfigData || !maintenanceStatusData) return;
            
            // Update maintenance status
            const isEnabled = maintenanceStatusData.enabled === true;
            document.getElementById('maintenanceStatusLabel').textContent = isEnabled ? '🟢 مفعلة' : '🔴 متوقفة';
            document.getElementById('maintenanceStatusLabel').style.color = isEnabled ? '#38ef7d' : '#ff6b6b';
            
            // Update buttons
            if (isEnabled) {
                document.getElementById('enableMaintenanceBtn').style.opacity = '0.5';
                document.getElementById('disableMaintenanceBtn').style.opacity = '1';
            } else {
                document.getElementById('enableMaintenanceBtn').style.opacity = '1';
                document.getElementById('disableMaintenanceBtn').style.opacity = '0.5';
            }
            
            // Update music status
            const musicEnabled = maintenanceConfigData.musicEnabled === true;
            document.getElementById('musicStatusLabel').textContent = musicEnabled ? '🔊 مفعلة' : '🔇 متوقفة';
            document.getElementById('musicStatusLabel').style.color = musicEnabled ? '#38ef7d' : '#ff6b6b';
            
            // Update buttons
            if (musicEnabled) {
                document.getElementById('enableMusicBtn').style.opacity = '0.5';
                document.getElementById('disableMusicBtn').style.opacity = '1';
            } else {
                document.getElementById('enableMusicBtn').style.opacity = '1';
                document.getElementById('disableMusicBtn').style.opacity = '0.5';
            }
            
            // Update volume slider
            const volume = Math.round((maintenanceConfigData.musicVolume || 0.1) * 100);
            document.getElementById('volumeSlider').value = volume;
            document.getElementById('volumeDisplay').textContent = `🔊 ${volume}%`;
            
            // Update music duration
            const duration = maintenanceConfigData.musicDuration || 600000;
            let durationText = '';
            if (duration === -1) {
                durationText = '♾️ مستمر (غير محدود)';
            } else {
                const minutes = Math.floor(duration / 60000);
                if (minutes === 1) {
                    durationText = '⏱️ دقيقة واحدة';
                } else {
                    durationText = `⏱️ ${minutes} دقيقة`;
                }
            }
            document.getElementById('musicDurationLabel').textContent = durationText;
            
            // Load and update tap to stop status
            loadTapToStopStatus();
            
            // Update last update info
            const lastUpdate = maintenanceConfigData.lastUpdated || 'غير محدد';
            const updatedBy = maintenanceConfigData.updatedBy || 'غير محدد';
            document.getElementById('lastUpdateLabel').textContent = new Date(lastUpdate).toLocaleString('ar-EG');
            document.getElementById('updatedByLabel').textContent = updatedBy;
        }
        
        // Load tap to stop status
        async function loadTapToStopStatus() {
            try {
                const audioConfigData = await loadAudioConfig();
                const tapToStopEnabled = audioConfigData.backgroundMusic?.tapToStop || false;
                updateTapToStopUI(tapToStopEnabled);
            } catch (error) {
                console.error('Error loading tap to stop status:', error);
                // Default to disabled
                updateTapToStopUI(false);
            }
        }
        
        // Toggle maintenance message on/off
        async function toggleMaintenanceMessage(enable) {
            if (!githubToken) {
                showMessage('maintenanceToggleStatus', 'error', '❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            // Disable buttons and show immediate feedback
            const enableBtn = document.getElementById('enableMaintenanceBtn');
            const disableBtn = document.getElementById('disableMaintenanceBtn');
            
            if (enableBtn) enableBtn.disabled = true;
            if (disableBtn) disableBtn.disabled = true;
            
            showMessage('maintenanceToggleStatus', 'info', '⏳ جاري التحديث...');
            
            try {
                // Update maintenance-status.json
                maintenanceStatusData.enabled = enable;
                maintenanceStatusData.disabledAt = new Date().toISOString();
                maintenanceStatusData.disabledBy = 'المطور - Smart Planner';
                
                await saveMaintenanceStatus(`${enable ? 'تفعيل' : 'إيقاف'} رسالة التحديث من Smart Planner`);
                
                // Re-enable buttons
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('maintenanceToggleStatus', 'success', 
                    `✅ تم ${enable ? 'تفعيل' : 'إيقاف'} رسالة التحديث بنجاح! التغييرات انعكست فوراً في GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                // Re-enable buttons on error
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('maintenanceToggleStatus', 'error', '❌ فشل التحديث: ' + error.message);
            }
        }
        
        // Toggle music on/off
        async function toggleMusic(enable) {
            if (!githubToken) {
                showMessage('musicControlStatus', 'error', '❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            // Disable buttons and show immediate feedback
            const enableBtn = document.getElementById('enableMusicBtn');
            const disableBtn = document.getElementById('disableMusicBtn');
            
            if (enableBtn) enableBtn.disabled = true;
            if (disableBtn) disableBtn.disabled = true;
            
            showMessage('musicControlStatus', 'info', '⏳ جاري التحديث...');
            
            try {
                // Update maintenance-config.json
                maintenanceConfigData.musicEnabled = enable;
                maintenanceConfigData.lastUpdated = new Date().toISOString();
                maintenanceConfigData.updatedBy = 'المطور - Smart Planner';
                
                await saveMaintenanceConfig(`${enable ? 'تفعيل' : 'إيقاف'} الموسيقى من Smart Planner`);
                
                // Re-enable buttons
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('musicControlStatus', 'success', 
                    `✅ تم ${enable ? 'تفعيل' : 'إيقاف'} الموسيقى بنجاح! التغييرات انعكست فوراً في GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                // Re-enable buttons on error
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('musicControlStatus', 'error', '❌ فشل التحديث: ' + error.message);
            }
        }
        
        // Update volume display
        function updateVolumeDisplay(value) {
            document.getElementById('volumeDisplay').textContent = `🔊 ${value}%`;
        }
        
        // Save volume change
        async function saveVolumeChange(value) {
            if (!githubToken) {
                showMessage('musicControlStatus', 'error', '❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            showMessage('musicControlStatus', 'info', '⏳ جاري حفظ مستوى الصوت...');
            
            try {
                // Update maintenance-config.json
                maintenanceConfigData.musicVolume = parseInt(value) / 100;
                maintenanceConfigData.lastUpdated = new Date().toISOString();
                maintenanceConfigData.updatedBy = 'المطور - Smart Planner';
                
                await saveMaintenanceConfig(`تحديث مستوى الصوت إلى ${value}% من Smart Planner`);
                
                showMessage('musicControlStatus', 'success', 
                    `✅ تم تحديث مستوى الصوت إلى ${value}% بنجاح! التغييرات انعكست فوراً في GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                showMessage('musicControlStatus', 'error', '❌ فشل التحديث: ' + error.message);
            }
        }
        
        // Set volume preset
        function setVolumePreset(value) {
            document.getElementById('volumeSlider').value = value;
            updateVolumeDisplay(value);
            saveVolumeChange(value);
        }
        
        // Set music duration
        async function setMusicDuration(seconds) {
            if (!githubToken) {
                showMessage('musicControlStatus', 'error', '❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            showMessage('musicControlStatus', 'info', '⏳ جاري تحديث مدة الموسيقى...');
            
            try {
                // Update maintenance-config.json
                const duration = seconds === -1 ? -1 : seconds * 1000;
                maintenanceConfigData.musicDuration = duration;
                maintenanceConfigData.lastUpdated = new Date().toISOString();
                maintenanceConfigData.updatedBy = 'المطور - Smart Planner';
                
                let durationLabel = '';
                if (seconds === -1) {
                    durationLabel = 'غير محدود';
                    maintenanceConfigData.musicDurationLabel = 'مستمر (غير محدود)';
                } else {
                    const minutes = Math.floor(seconds / 60);
                    durationLabel = minutes === 1 ? 'دقيقة واحدة' : `${minutes} دقيقة`;
                    maintenanceConfigData.musicDurationLabel = durationLabel;
                }
                
                await saveMaintenanceConfig(`تحديث مدة الموسيقى إلى ${durationLabel} من Smart Planner`);
                
                showMessage('musicControlStatus', 'success', 
                    `✅ تم تحديث مدة الموسيقى إلى ${durationLabel} بنجاح! التغييرات انعكست فوراً في GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                showMessage('musicControlStatus', 'error', '❌ فشل التحديث: ' + error.message);
            }
        }
        
        // Set tap to stop feature
        async function setTapToStop(enabled) {
            if (!githubToken) {
                showMessage('musicControlStatus', 'error', '❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            showMessage('musicControlStatus', 'info', '⏳ جاري تحديث ميزة النقر للإيقاف...');
            
            try {
                // Update audio-config.json
                const audioConfigData = await loadAudioConfig();
                
                if (!audioConfigData.backgroundMusic) {
                    audioConfigData.backgroundMusic = {};
                }
                
                audioConfigData.backgroundMusic.tapToStop = enabled;
                audioConfigData.lastUpdated = new Date().toISOString();
                audioConfigData.updatedBy = 'المطور - Smart Planner';
                
                await saveAudioConfig(audioConfigData, `تحديث ميزة النقر للإيقاف: ${enabled ? 'مفعلة' : 'معطلة'}`);
                
                showMessage('musicControlStatus', 'success', 
                    `✅ تم ${enabled ? 'تفعيل' : 'تعطيل'} ميزة النقر للإيقاف بنجاح! التغييرات انعكست فوراً في GitHub`);
                
                // Update UI
                updateTapToStopUI(enabled);
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                showMessage('musicControlStatus', 'error', '❌ فشل التحديث: ' + error.message);
            }
        }
        
        // Load audio config from GitHub
        async function loadAudioConfig() {
            const response = await fetch(`https://api.github.com/repos/${repo}/contents/audio-config.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!response.ok) {
                throw new Error('فشل الحصول على ملف audio-config.json');
            }
            
            const file = await response.json();
            const content = atob(file.content);
            return JSON.parse(content);
        }
        
        // Save audio config to GitHub
        async function saveAudioConfig(audioConfigData, commitMessage) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/audio-config.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('فشل الحصول على ملف audio-config.json');
            }
            
            const file = await getRes.json();
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/audio-config.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(audioConfigData, null, 2)))),
                    sha: file.sha
                })
            });
            
            if (!updateRes.ok) {
                const errorData = await updateRes.json();
                throw new Error(errorData.message || 'فشل تحديث ملف audio-config.json');
            }
        }
        
        // Update tap to stop UI
        function updateTapToStopUI(enabled) {
            const statusElement = document.getElementById('tapToStopStatus');
            if (statusElement) {
                statusElement.textContent = enabled ? '✅ مفعلة' : '❌ معطلة';
                statusElement.style.color = enabled ? '#38ef7d' : '#ff6b6b';
            }
        }
        
        // Save maintenance config to GitHub
        async function saveMaintenanceConfig(commitMessage) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-config.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('فشل الحصول على ملف maintenance-config.json');
            }
            
            const file = await getRes.json();
            const sha = file.sha;
            
            // Prepare content
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(maintenanceConfigData, null, 2))));
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-config.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateRes.ok) {
                throw new Error('فشل تحديث ملف maintenance-config.json');
            }
        }
        
        // Save maintenance status to GitHub
        async function saveMaintenanceStatus(commitMessage) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('فشل الحصول على ملف maintenance-status.json');
            }
            
            const file = await getRes.json();
            const sha = file.sha;
            
            // Prepare content
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(maintenanceStatusData, null, 2))));
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateRes.ok) {
                throw new Error('فشل تحديث ملف maintenance-status.json');
            }
        }
        
        // Force cache clear - AGGRESSIVE IMPLEMENTATION for all browsers
        async function forceCacheClear() {
            // Disable button and show immediate feedback
            const btn = document.getElementById('clearCacheBtn');
            const icon = document.getElementById('clearCacheIcon');
            const text = document.getElementById('clearCacheText');
            
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            }
            if (icon) icon.textContent = '⏳';
            if (text) text.textContent = 'جاري المسح الفوري...';
            
            showMessage('cacheControlStatus', 'info', '⏳ جاري مسح الكاش والذاكرة بشكل فوري وقوي...');
            
            try {
                let clearedItems = [];
                
                // 1. Clear local storage (preserve devToken)
                const keysToKeep = ['devToken'];
                const allKeys = Object.keys(localStorage);
                let localStorageCount = 0;
                allKeys.forEach(key => {
                    if (!keysToKeep.includes(key)) {
                        localStorage.removeItem(key);
                        localStorageCount++;
                    }
                });
                clearedItems.push(`💾 LocalStorage: تم مسح ${localStorageCount} عنصر`);
                
                // 2. Clear session storage
                const sessionStorageCount = sessionStorage.length;
                sessionStorage.clear();
                clearedItems.push(`📦 SessionStorage: تم مسح ${sessionStorageCount} عنصر`);
                
                // 3. Unregister all service workers
                let swCount = 0;
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        swCount++;
                        console.log('✅ Service Worker unregistered:', registration);
                    }
                }
                clearedItems.push(`🔄 Service Workers: تم إلغاء تسجيل ${swCount} خدمة`);
                
                // 4. Clear all caches
                let cacheCount = 0;
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        cacheCount++;
                        console.log('✅ Cache deleted:', cacheName);
                    }
                }
                clearedItems.push(`🗑️ Caches: تم مسح ${cacheCount} كاش`);
                
                // 5. Clear cookies (if possible)
                try {
                    document.cookie.split(";").forEach(function(c) { 
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                    });
                    clearedItems.push(`🍪 Cookies: تم المسح`);
                } catch (e) {
                    console.warn('Could not clear cookies:', e);
                }
                
                // 6. Clear IndexedDB (if exists)
                if ('indexedDB' in window) {
                    try {
                        const databases = await indexedDB.databases();
                        for (const db of databases) {
                            indexedDB.deleteDatabase(db.name);
                        }
                        clearedItems.push(`📊 IndexedDB: تم المسح`);
                    } catch (e) {
                        console.warn('Could not clear IndexedDB:', e);
                    }
                }
                
                // Re-enable button with success state
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                if (icon) icon.textContent = '✅';
                if (text) text.textContent = 'تم المسح بنجاح!';
                
                // Show success message
                showMessage('cacheControlStatus', 'success', 
                    '✅ تم مسح جميع الكاش والذاكرة بنجاح!\n\n' +
                    clearedItems.join('\n') + '\n\n' +
                    '✨ التحديثات ستنعكس فوراً في جميع المتصفحات (Safari, Chrome, Firefox)\n' +
                    '🔄 سيتم إعادة تحميل الصفحة بشكل قوي خلال 3 ثوانٍ...');
                
                // Reset button text after a moment
                setTimeout(() => {
                    if (icon) icon.textContent = '🚀';
                    if (text) text.textContent = 'مسح قوي وفوري للكاش (Safari + Chrome + Firefox)';
                }, 2000);
                
                // 7. Force hard reload after 3 seconds
                setTimeout(() => {
                    console.log('🔄 Performing hard reload...');
                    // Try multiple reload methods for maximum compatibility
                    if (window.location.reload) {
                        // Hard reload with cache bypass
                        window.location.reload(true);
                    }
                    // Fallback: Force reload by changing URL
                    setTimeout(() => {
                        window.location.href = window.location.href.split('?')[0] + '?t=' + new Date().getTime();
                    }, 500);
                }, 3000);
                
            } catch (error) {
                // Re-enable button on error
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                if (icon) icon.textContent = '❌';
                if (text) text.textContent = 'فشل المسح - حاول مرة أخرى';
                
                showMessage('cacheControlStatus', 'error', '❌ فشل مسح الكاش: ' + error.message);
                console.error('Cache clear error:', error);
                
                // Reset button text after a moment
                setTimeout(() => {
                    if (icon) icon.textContent = '🚀';
                    if (text) text.textContent = 'مسح قوي وفوري للكاش (Safari + Chrome + Firefox)';
                }, 3000);
            }
        }
        
        // Update service worker
        async function updateServiceWorker() {
            // Disable button and show immediate feedback
            const btn = document.getElementById('updateSWBtn');
            const icon = document.getElementById('updateSWIcon');
            const text = document.getElementById('updateSWText');
            
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            }
            if (icon) icon.textContent = '⏳';
            if (text) text.textContent = 'جاري التحديث...';
            
            showMessage('cacheControlStatus', 'info', '⏳ جاري تحديث Service Worker...');
            
            try {
                if ('serviceWorker' in navigator) {
                    // Get all registrations
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    
                    if (registrations.length === 0) {
                        // Re-enable button
                        if (btn) {
                            btn.disabled = false;
                            btn.style.opacity = '1';
                        }
                        if (icon) icon.textContent = '⚠️';
                        if (text) text.textContent = 'لا توجد Service Workers';
                        
                        showMessage('cacheControlStatus', 'warning', '⚠️ لا توجد Service Workers مسجلة');
                        
                        // Reset button text
                        setTimeout(() => {
                            if (icon) icon.textContent = '🔄';
                            if (text) text.textContent = 'تحديث Service Worker فوراً';
                        }, 2000);
                        return;
                    }
                    
                    // Update all service workers
                    for (let registration of registrations) {
                        await registration.update();
                        console.log('✅ Service Worker updated:', registration);
                    }
                    
                    // Re-enable button with success state
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    }
                    if (icon) icon.textContent = '✅';
                    if (text) text.textContent = 'تم التحديث بنجاح!';
                    
                    showMessage('cacheControlStatus', 'success', 
                        `✅ تم تحديث ${registrations.length} Service Worker بنجاح!\n` +
                        '🔄 التحديثات ستنعكس فوراً في جميع علامات التبويب');
                    
                    // Reset button text after a moment
                    setTimeout(() => {
                        if (icon) icon.textContent = '🔄';
                        if (text) text.textContent = 'تحديث Service Worker فوراً';
                    }, 2000);
                    
                } else {
                    // Re-enable button
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    }
                    if (icon) icon.textContent = '❌';
                    if (text) text.textContent = 'المتصفح لا يدعم SW';
                    
                    showMessage('cacheControlStatus', 'error', '❌ المتصفح لا يدعم Service Workers');
                    
                    // Reset button text
                    setTimeout(() => {
                        if (icon) icon.textContent = '🔄';
                        if (text) text.textContent = 'تحديث Service Worker فوراً';
                    }, 2000);
                }
                
            } catch (error) {
                // Re-enable button on error
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                if (icon) icon.textContent = '❌';
                if (text) text.textContent = 'فشل التحديث';
                
                showMessage('cacheControlStatus', 'error', '❌ فشل تحديث Service Worker: ' + error.message);
                
                // Reset button text after a moment
                setTimeout(() => {
                    if (icon) icon.textContent = '🔄';
                    if (text) text.textContent = 'تحديث Service Worker فوراً';
                }, 3000);
            }
        }
        
        // Update switchTab function to load maintenance config when switching to maintenance tab
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab.call(this, tabName);
            
            if (tabName === 'maintenance') {
                loadMaintenanceConfig();
            }
        };
        
        // ============================================
        // NEW SMART PLANNER ENHANCED FUNCTIONS
        // ============================================
        
        // Quick Add Inspection
        function openQuickAddInspection() {
            // Switch to add tab and focus on first field
            document.querySelectorAll('.tab-button')[0].click();
            setTimeout(() => {
                document.getElementById('inspectorSelect').focus();
            }, 300);
            alert('✨ اختصار: اختر المفتش والتاريخ والمنطقة بسرعة لإضافة تفتيش جديد');
        }
        
        // Import from Excel - REAL IMPLEMENTATION
        function importFromExcel() {
            if (!window.XLSX) {
                alert('⚠️ مكتبة Excel غير محملة. يرجى إعادة تحميل الصفحة.');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    
                    // Create import preview modal
                    const modal = document.createElement('div');
                    modal.id = 'importExcelModal';
                    modal.style.cssText = `
                        display: block;
                        position: fixed;
                        z-index: 10000;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.8);
                        overflow: auto;
                    `;
                    
                    let sheetsHTML = '<div style="margin-bottom: 20px;">';
                    sheetsHTML += '<h3 style="color: #2d3561; margin-bottom: 15px;">📋 أوراق العمل المتاحة:</h3>';
                    sheetsHTML += '<div style="display: flex; flex-direction: column; gap: 10px;">';
                    
                    workbook.SheetNames.forEach((sheetName, idx) => {
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        sheetsHTML += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border: 2px solid #e0e0e0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="color: #667eea; font-size: 1.1em;">${sheetName}</strong>
                                        <span style="color: #666; margin-right: 10px;">(${jsonData.length} صف)</span>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button onclick="importExcelSheet('${sheetName}', 'inspections')" class="btn btn-primary btn-sm">
                                            استيراد كتفتيشات
                                        </button>
                                        <button onclick="importExcelSheet('${sheetName}', 'shops')" class="btn btn-success btn-sm">
                                            استيراد كمحلات
                                        </button>
                                    </div>
                                </div>
                                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                    معاينة الأعمدة: ${Object.keys(jsonData[0] || {}).slice(0, 5).join(', ')}${Object.keys(jsonData[0] || {}).length > 5 ? '...' : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    sheetsHTML += '</div></div>';
                    
                    modal.innerHTML = `
                        <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 900px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="color: #2d3561;">📥 استيراد من Excel</h2>
                                <button onclick="document.getElementById('importExcelModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">×</button>
                            </div>
                            ${sheetsHTML}
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-top: 20px; border: 2px solid #90caf9;">
                                <strong style="color: #1976d2;">💡 نصائح:</strong>
                                <ul style="margin: 10px 0 0 20px; color: #666;">
                                    <li>تأكد من تطابق أسماء الأعمدة مع البيانات المطلوبة</li>
                                    <li>استيراد كتفتيشات: يتطلب أعمدة (المفتش، التاريخ، المنطقة، المحلات)</li>
                                    <li>استيراد كمحلات: يتطلب أعمدة (اسم المحل، المنطقة)</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Store workbook for later use
                    window.excelWorkbook = workbook;
                    
                } catch (error) {
                    alert('❌ فشل قراءة ملف Excel: ' + error.message);
                }
            };
            input.click();
        }
        
        // Import Excel Sheet
        window.importExcelSheet = async function(sheetName, type) {
            if (!window.excelWorkbook) {
                alert('⚠️ لم يتم تحميل ملف Excel');
                return;
            }
            
            const sheet = window.excelWorkbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet);
            
            if (type === 'inspections') {
                let importedCount = 0;
                let errors = [];
                
                jsonData.forEach((row, idx) => {
                    try {
                        // Try to extract inspection data with flexible column names
                        const inspector = row['المفتش'] || row['Inspector'] || row['inspector'] || '';
                        const day = row['التاريخ'] || row['Date'] || row['date'] || row['day'] || '';
                        const area = row['المنطقة'] || row['Area'] || row['area'] || '';
                        const shopsStr = row['المحلات'] || row['Shops'] || row['shops'] || '';
                        
                        if (!inspector || !day || !area) {
                            errors.push(`الصف ${idx + 1}: بيانات ناقصة`);
                            return;
                        }
                        
                        const shops = shopsStr.split(',').map(s => s.trim()).filter(s => s);
                        
                        const newInspection = {
                            id: 'insp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            inspector: inspector,
                            day: day,
                            area: area,
                            shops: shops,
                            shift: row['المناوبة'] || row['Shift'] || 'صباحية'
                        };
                        
                        planData.inspectionData.push(newInspection);
                        importedCount++;
                    } catch (error) {
                        errors.push(`الصف ${idx + 1}: ${error.message}`);
                    }
                });
                
                if (errors.length > 0 && errors.length < 10) {
                    alert(`⚠️ تحذيرات:\n\n` + errors.join('\n'));
                }
                
                alert(`✅ تم استيراد ${importedCount} تفتيش من ${jsonData.length} صف!\n\n⚠️ لا تنسَ حفظ التغييرات`);
                
            } else if (type === 'shops') {
                let importedCount = 0;
                let errors = [];
                
                jsonData.forEach((row, idx) => {
                    try {
                        const shopName = row['اسم المحل'] || row['Shop Name'] || row['name'] || row['Name'] || '';
                        const areaName = row['المنطقة'] || row['Area'] || row['area'] || '';
                        
                        if (!shopName) {
                            errors.push(`الصف ${idx + 1}: اسم المحل مفقود`);
                            return;
                        }
                        
                        // Find or create area
                        let areaId = '';
                        if (areaName && planData.areas) {
                            const area = planData.areas.find(a => a.name === areaName);
                            if (area) {
                                areaId = area.id;
                            } else {
                                // Create new area
                                areaId = 'area_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                planData.areas.push({
                                    id: areaId,
                                    name: areaName
                                });
                            }
                        }
                        
                        // Check if shop already exists
                        const exists = planData.shops.some(s => s.name.toLowerCase().trim() === shopName.toLowerCase().trim());
                        if (exists) {
                            return;
                        }
                        
                        const newShop = {
                            id: 'shop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            name: shopName,
                            areaId: areaId
                        };
                        
                        planData.shops.push(newShop);
                        importedCount++;
                    } catch (error) {
                        errors.push(`الصف ${idx + 1}: ${error.message}`);
                    }
                });
                
                if (errors.length > 0 && errors.length < 10) {
                    alert(`⚠️ تحذيرات:\n\n` + errors.join('\n'));
                }
                
                alert(`✅ تم استيراد ${importedCount} محل من ${jsonData.length} صف!\n\n⚠️ لا تنسَ حفظ التغييرات`);
            }
            
            document.getElementById('importExcelModal').remove();
        };
        
        // Export All Data - ENHANCED WITH MULTIPLE FORMATS
        function exportAllData() {
            if (!planData) {
                alert('⚠️ لا توجد بيانات للتصدير');
                return;
            }
            
            // Create export format selection modal
            const modal = document.createElement('div');
            modal.id = 'exportModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 5% auto; padding: 30px; border-radius: 20px; max-width: 700px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561;">📤 تصدير جميع البيانات</h2>
                        <button onclick="document.getElementById('exportModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">×</button>
                    </div>
                    
                    <!-- Data Summary -->
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">📊 ملخص البيانات</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <div style="font-size: 2em; font-weight: 700; color: #667eea;">${planData.inspectionData?.length || 0}</div>
                                <div style="color: #666;">التفتيشات</div>
                            </div>
                            <div>
                                <div style="font-size: 2em; font-weight: 700; color: #11998e;">${planData.inspectors?.length || 0}</div>
                                <div style="color: #666;">المفتشون</div>
                            </div>
                            <div>
                                <div style="font-size: 2em; font-weight: 700; color: #fa709a;">${planData.areas?.length || 0}</div>
                                <div style="color: #666;">المناطق</div>
                            </div>
                            <div>
                                <div style="font-size: 2em; font-weight: 700; color: #ffc107;">${planData.shops?.length || 0}</div>
                                <div style="color: #666;">المحلات</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export Format Selection -->
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">📋 اختر صيغة التصدير:</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <button onclick="exportDataFormat('json')" class="btn btn-primary" style="padding: 20px; flex-direction: column; gap: 10px;">
                                <span style="font-size: 2em;">📄</span>
                                <span>JSON</span>
                                <small style="font-size: 0.85em; opacity: 0.8;">للمطورين والتطبيقات</small>
                            </button>
                            <button onclick="exportDataFormat('excel')" class="btn btn-success" style="padding: 20px; flex-direction: column; gap: 10px;">
                                <span style="font-size: 2em;">📊</span>
                                <span>Excel</span>
                                <small style="font-size: 0.85em; opacity: 0.8;">للتحليل والمشاركة</small>
                            </button>
                            <button onclick="exportDataFormat('csv')" class="btn btn-info" style="padding: 20px; flex-direction: column; gap: 10px;">
                                <span style="font-size: 2em;">📋</span>
                                <span>CSV</span>
                                <small style="font-size: 0.85em; opacity: 0.8;">للقواعد والأنظمة</small>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Export Options -->
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; border: 2px solid #ffc107;">
                        <strong style="color: #856404;">⚙️ خيارات التصدير:</strong>
                        <div style="margin-top: 10px;">
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="checkbox" id="exportInspections" checked>
                                <span style="margin-right: 5px;">تضمين التفتيشات</span>
                            </label>
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="checkbox" id="exportInspectors" checked>
                                <span style="margin-right: 5px;">تضمين المفتشين</span>
                            </label>
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="checkbox" id="exportAreas" checked>
                                <span style="margin-right: 5px;">تضمين المناطق</span>
                            </label>
                            <label style="display: block;">
                                <input type="checkbox" id="exportShops" checked>
                                <span style="margin-right: 5px;">تضمين المحلات</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Export Data in Selected Format
        window.exportDataFormat = function(format) {
            const includeInspections = document.getElementById('exportInspections').checked;
            const includeInspectors = document.getElementById('exportInspectors').checked;
            const includeAreas = document.getElementById('exportAreas').checked;
            const includeShops = document.getElementById('exportShops').checked;
            
            const exportData = {
                exportDate: new Date().toISOString(),
                exportedBy: 'Smart Planner - أداة التخطيط الذكية',
                format: format
            };
            
            if (includeInspections) exportData.inspections = planData.inspectionData || [];
            if (includeInspectors) exportData.inspectors = planData.inspectors || [];
            if (includeAreas) exportData.areas = planData.areas || [];
            if (includeShops) exportData.shops = planData.shops || [];
            
            if (format === 'json') {
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `smart-planner-export-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                alert('✅ تم تصدير البيانات بصيغة JSON بنجاح!');
                
            } else if (format === 'excel') {
                if (!window.XLSX) {
                    alert('⚠️ مكتبة Excel غير محملة. جاري التصدير بصيغة JSON بديلة...');
                    exportDataFormat('json');
                    return;
                }
                
                const wb = XLSX.utils.book_new();
                
                // Add inspections sheet
                if (includeInspections && exportData.inspections) {
                    const inspectionsSheet = exportData.inspections.map(i => ({
                        'المفتش': i.inspector,
                        'التاريخ': i.day,
                        'المنطقة': i.area,
                        'المناوبة': i.shift || '',
                        'عدد المحلات': i.shops ? i.shops.length : 0,
                        'المحلات': i.shops ? i.shops.join(', ') : ''
                    }));
                    const ws = XLSX.utils.json_to_sheet(inspectionsSheet);
                    XLSX.utils.book_append_sheet(wb, ws, 'التفتيشات');
                }
                
                // Add inspectors sheet
                if (includeInspectors && exportData.inspectors) {
                    const inspectorsSheet = exportData.inspectors.map(i => ({
                        'الاسم': i.name,
                        'الأيام': i.days ? i.days.join(', ') : ''
                    }));
                    const ws = XLSX.utils.json_to_sheet(inspectorsSheet);
                    XLSX.utils.book_append_sheet(wb, ws, 'المفتشون');
                }
                
                // Add areas sheet
                if (includeAreas && exportData.areas) {
                    const areasSheet = exportData.areas.map(a => ({
                        'المعرف': a.id,
                        'الاسم': a.name
                    }));
                    const ws = XLSX.utils.json_to_sheet(areasSheet);
                    XLSX.utils.book_append_sheet(wb, ws, 'المناطق');
                }
                
                // Add shops sheet
                if (includeShops && exportData.shops) {
                    const shopsSheet = exportData.shops.map(s => {
                        const area = planData.areas?.find(a => a.id === s.areaId);
                        return {
                            'المعرف': s.id,
                            'الاسم': s.name,
                            'المنطقة': area ? area.name : ''
                        };
                    });
                    const ws = XLSX.utils.json_to_sheet(shopsSheet);
                    XLSX.utils.book_append_sheet(wb, ws, 'المحلات');
                }
                
                XLSX.writeFile(wb, `smart-planner-export-${new Date().toISOString().split('T')[0]}.xlsx`);
                alert('✅ تم تصدير البيانات بصيغة Excel بنجاح!');
                
            } else if (format === 'csv') {
                // Export inspections as CSV
                if (includeInspections && exportData.inspections) {
                    let csv = 'المفتش,التاريخ,المنطقة,المناوبة,عدد المحلات,المحلات\n';
                    exportData.inspections.forEach(i => {
                        csv += `"${i.inspector}","${i.day}","${i.area}","${i.shift || ''}","${i.shops ? i.shops.length : 0}","${i.shops ? i.shops.join('; ') : ''}"\n`;
                    });
                    
                    const dataBlob = new Blob(['\uFEFF' + csv], {type: 'text/csv;charset=utf-8;'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `smart-planner-inspections-${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    alert('✅ تم تصدير البيانات بصيغة CSV بنجاح!');
                } else {
                    alert('⚠️ لم يتم تحديد بيانات للتصدير');
                }
            }
            
            document.getElementById('exportModal').remove();
        };
        
        // Sync with GitHub
        async function syncWithGitHub() {
            if (!githubToken) {
                alert('❌ يرجى تسجيل الدخول أولاً للمزامنة مع GitHub');
                return;
            }
            
            if (confirm('🔄 هل تريد مزامنة البيانات مع GitHub؟\n\nسيتم تحميل أحدث البيانات من المستودع.')) {
                try {
                    await loadPlanData();
                    alert('✅ تمت المزامنة بنجاح! تم تحميل أحدث البيانات.');
                    
                    // Refresh current tab
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab && activeTab.id === 'shopsTab') {
                        displayShopsList();
                    } else if (activeTab && activeTab.id === 'areasTab') {
                        displayAreasList();
                    }
                } catch (error) {
                    alert('❌ فشلت المزامنة: ' + error.message);
                }
            }
        }
        
        // Create Backup
        function createBackup() {
            if (!planData) {
                alert('⚠️ لا توجد بيانات للنسخ الاحتياطي');
                return;
            }
            
            const backupData = {
                ...planData,
                backupDate: new Date().toISOString(),
                backupVersion: '1.0'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup-plan-data-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('✅ تم إنشاء النسخة الاحتياطية بنجاح!\n\n💾 احتفظ بهذا الملف في مكان آمن.');
        }
        
        // Generate Full Report - ENHANCED WITH VISUAL REPORT
        function generateFullReport() {
            if (!planData || !planData.inspectionData) {
                alert('⚠️ لا توجد بيانات لإنشاء التقرير');
                return;
            }
            
            const totalInspections = planData.inspectionData.length;
            const totalShops = planData.inspectionData.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0);
            const inspectorCounts = {};
            const areaCounts = {};
            const monthCounts = {};
            const shiftCounts = { 'صباحية': 0, 'مسائية': 0 };
            
            planData.inspectionData.forEach(insp => {
                inspectorCounts[insp.inspector] = (inspectorCounts[insp.inspector] || 0) + 1;
                areaCounts[insp.area] = (areaCounts[insp.area] || 0) + 1;
                
                const month = insp.day ? insp.day.substring(0, 7) : 'غير محدد';
                monthCounts[month] = (monthCounts[month] || 0) + 1;
                
                if (insp.shift) {
                    shiftCounts[insp.shift] = (shiftCounts[insp.shift] || 0) + 1;
                }
            });
            
            // Create visual report modal
            const modal = document.createElement('div');
            modal.id = 'reportModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            // Calculate top performers
            const topInspectors = Object.entries(inspectorCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const topAreas = Object.entries(areaCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 20px; max-width: 1200px; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #667eea;">
                        <h2 style="color: #2d3561; margin: 0;">📊 التقرير الشامل والتفصيلي</h2>
                        <button onclick="document.getElementById('reportModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">×</button>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 3em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">${totalInspections}</div>
                            <div style="font-size: 1.1em; margin-top: 5px;">إجمالي التفتيشات</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 3em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">${totalShops}</div>
                            <div style="font-size: 1.1em; margin-top: 5px;">المحلات المفتشة</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 3em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">${Object.keys(inspectorCounts).length}</div>
                            <div style="font-size: 1.1em; margin-top: 5px;">المفتشون النشطون</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 3em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">${Object.keys(areaCounts).length}</div>
                            <div style="font-size: 1.1em; margin-top: 5px;">المناطق المغطاة</div>
                        </div>
                    </div>
                    
                    <!-- Top Performers -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 15px;">
                            <h3 style="color: #2d3561; margin-bottom: 15px;">🏆 أفضل 5 مفتشين</h3>
                            ${topInspectors.map(([ inspector, count], idx) => {
                                const percentage = ((count / totalInspections) * 100).toFixed(1);
                                return `
                                    <div style="margin-bottom: 15px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span style="font-weight: 600;">${idx + 1}. ${inspector}</span>
                                            <span style="color: #667eea; font-weight: 600;">${count} (${percentage}%)</span>
                                        </div>
                                        <div style="background: #e0e0e0; border-radius: 10px; height: 10px; overflow: hidden;">
                                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${percentage}%; transition: width 1s ease;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 15px;">
                            <h3 style="color: #2d3561; margin-bottom: 15px;">📍 أكثر 5 مناطق تفتيشاً</h3>
                            ${topAreas.map(([area, count], idx) => {
                                const percentage = ((count / totalInspections) * 100).toFixed(1);
                                return `
                                    <div style="margin-bottom: 15px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span style="font-weight: 600;">${idx + 1}. ${area}</span>
                                            <span style="color: #11998e; font-weight: 600;">${count} (${percentage}%)</span>
                                        </div>
                                        <div style="background: #e0e0e0; border-radius: 10px; height: 10px; overflow: hidden;">
                                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); height: 100%; width: ${percentage}%; transition: width 1s ease;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Shift Distribution -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">🕐 توزيع المناوبات</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #ffc107;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #ffc107;">${shiftCounts['صباحية'] || 0}</div>
                                <div style="color: #666;">المناوبات الصباحية</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #3498db;">${shiftCounts['مسائية'] || 0}</div>
                                <div style="color: #666;">المناوبات المسائية</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Distribution -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">📅 التوزيع الشهري للتفتيشات</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            ${Object.entries(monthCounts).sort((a, b) => a[0].localeCompare(b[0])).map(([month, count]) => `
                                <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 2px solid #667eea;">
                                    <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">${month}</div>
                                    <div style="font-size: 1.8em; font-weight: 700; color: #2d3561;">${count}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                        <button onclick="downloadTextReport()" class="btn btn-primary">
                            <span>📄</span>
                            <span>تحميل التقرير النصي</span>
                        </button>
                        <button onclick="printReport()" class="btn btn-success">
                            <span>🖨️</span>
                            <span>طباعة التقرير</span>
                        </button>
                        <button onclick="shareReport()" class="btn btn-info">
                            <span>📤</span>
                            <span>مشاركة التقرير</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store report data globally for download functions
            window.currentReportData = {
                totalInspections,
                totalShops,
                inspectorCounts,
                areaCounts,
                monthCounts,
                shiftCounts
            };
        }
        
        // Download Text Report
        window.downloadTextReport = function() {
            const data = window.currentReportData;
            
            let report = '📊 التقرير الشامل لنظام التفتيش الذكي\n';
            report += '═'.repeat(60) + '\n\n';
            report += `📅 تاريخ التقرير: ${new Date().toLocaleString('ar-EG')}\n`;
            report += `🔗 النظام: Smart Planner - أداة التخطيط الذكية\n\n`;
            
            report += '📈 الإحصائيات العامة:\n';
            report += '─'.repeat(60) + '\n';
            report += `   • إجمالي التفتيشات: ${data.totalInspections}\n`;
            report += `   • إجمالي المحلات المفتشة: ${data.totalShops}\n`;
            report += `   • عدد المفتشين النشطين: ${Object.keys(data.inspectorCounts).length}\n`;
            report += `   • عدد المناطق المغطاة: ${Object.keys(data.areaCounts).length}\n`;
            report += `   • متوسط المحلات لكل تفتيش: ${(data.totalShops / data.totalInspections).toFixed(2)}\n\n`;
            
            report += '👥 تفتيشات المفتشين (مرتبة تنازلياً):\n';
            report += '─'.repeat(60) + '\n';
            Object.entries(data.inspectorCounts).sort((a, b) => b[1] - a[1]).forEach(([inspector, count], idx) => {
                const percentage = ((count / data.totalInspections) * 100).toFixed(1);
                report += `   ${idx + 1}. ${inspector}: ${count} تفتيش (${percentage}%)\n`;
            });
            
            report += '\n🗺️ تفتيشات المناطق (مرتبة تنازلياً):\n';
            report += '─'.repeat(60) + '\n';
            Object.entries(data.areaCounts).sort((a, b) => b[1] - a[1]).forEach(([area, count], idx) => {
                const percentage = ((count / data.totalInspections) * 100).toFixed(1);
                report += `   ${idx + 1}. ${area}: ${count} تفتيش (${percentage}%)\n`;
            });
            
            report += '\n🕐 توزيع المناوبات:\n';
            report += '─'.repeat(60) + '\n';
            report += `   • المناوبات الصباحية: ${data.shiftCounts['صباحية'] || 0}\n`;
            report += `   • المناوبات المسائية: ${data.shiftCounts['مسائية'] || 0}\n`;
            
            report += '\n📅 التوزيع الشهري:\n';
            report += '─'.repeat(60) + '\n';
            Object.entries(data.monthCounts).sort((a, b) => a[0].localeCompare(b[0])).forEach(([month, count]) => {
                report += `   • ${month}: ${count} تفتيش\n`;
            });
            
            report += '\n' + '═'.repeat(60) + '\n';
            report += 'تم إنشاء هذا التقرير بواسطة Smart Planner\n';
            report += '© 2025 جميع الحقوق محفوظة\n';
            
            const dataBlob = new Blob(['\uFEFF' + report], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `تقرير-شامل-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('✅ تم تحميل التقرير النصي بنجاح!');
        };
        
        // Print Report
        window.printReport = function() {
            window.print();
        };
        
        // Share Report
        window.shareReport = function() {
            const data = window.currentReportData;
            const summary = `📊 تقرير نظام التفتيش\n\n` +
                          `✅ التفتيشات: ${data.totalInspections}\n` +
                          `🏪 المحلات: ${data.totalShops}\n` +
                          `👥 المفتشون: ${Object.keys(data.inspectorCounts).length}\n` +
                          `🗺️ المناطق: ${Object.keys(data.areaCounts).length}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'تقرير نظام التفتيش الذكي',
                    text: summary
                }).catch(err => console.log('Error sharing:', err));
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(summary).then(() => {
                    alert('✅ تم نسخ ملخص التقرير إلى الحافظة!');
                }).catch(() => {
                    alert('📋 ملخص التقرير:\n\n' + summary);
                });
            }
        };
        
        // Check Data Quality - ENHANCED WITH AUTO-FIX
        function checkDataQuality() {
            if (!planData) {
                alert('⚠️ لا توجد بيانات للفحص');
                return;
            }
            
            const issues = {
                critical: [],
                warnings: [],
                suggestions: []
            };
            
            // Check inspections
            if (planData.inspectionData) {
                planData.inspectionData.forEach((insp, idx) => {
                    if (!insp.inspector) issues.critical.push({ type: 'missing_inspector', index: idx, message: `تفتيش ${idx + 1}: مفتش غير محدد` });
                    if (!insp.day) issues.critical.push({ type: 'missing_date', index: idx, message: `تفتيش ${idx + 1}: تاريخ غير محدد` });
                    if (!insp.area) issues.warnings.push({ type: 'missing_area', index: idx, message: `تفتيش ${idx + 1}: منطقة غير محددة` });
                    if (!insp.shops || insp.shops.length === 0) issues.warnings.push({ type: 'no_shops', index: idx, message: `تفتيش ${idx + 1}: لا توجد محلات` });
                    if (!insp.id) issues.suggestions.push({ type: 'missing_id', index: idx, message: `تفتيش ${idx + 1}: معرف غير موجود` });
                    if (!insp.shift) issues.suggestions.push({ type: 'missing_shift', index: idx, message: `تفتيش ${idx + 1}: مناوبة غير محددة` });
                    
                    // Check date format
                    if (insp.day && !/^\d{4}-\d{2}-\d{2}$/.test(insp.day)) {
                        issues.warnings.push({ type: 'invalid_date_format', index: idx, message: `تفتيش ${idx + 1}: صيغة تاريخ غير صحيحة (${insp.day})` });
                    }
                });
            }
            
            // Check duplicates
            const inspectionKeys = new Map();
            planData.inspectionData.forEach((insp, idx) => {
                const key = `${insp.inspector}-${insp.day}`;
                if (inspectionKeys.has(key)) {
                    issues.warnings.push({
                        type: 'duplicate',
                        index: idx,
                        originalIndex: inspectionKeys.get(key),
                        message: `تفتيش مكرر: ${insp.inspector} في ${insp.day}`,
                        fixable: true
                    });
                } else {
                    inspectionKeys.set(key, idx);
                }
            });
            
            // Check shops
            if (planData.shops) {
                planData.shops.forEach((shop, idx) => {
                    if (!shop.name) issues.critical.push({ type: 'missing_shop_name', index: idx, message: `محل ${idx + 1}: اسم غير محدد` });
                    if (!shop.id) issues.suggestions.push({ type: 'missing_shop_id', index: idx, message: `محل ${idx + 1}: معرف غير موجود`, fixable: true });
                    if (!shop.areaId) issues.warnings.push({ type: 'missing_shop_area', index: idx, message: `${shop.name || 'محل ' + (idx + 1)}: منطقة غير محددة` });
                });
                
                // Check for duplicate shop names
                const shopNames = new Map();
                planData.shops.forEach((shop, idx) => {
                    const name = shop.name?.toLowerCase().trim();
                    if (name) {
                        if (shopNames.has(name)) {
                            issues.warnings.push({
                                type: 'duplicate_shop',
                                index: idx,
                                originalIndex: shopNames.get(name),
                                message: `محل مكرر: ${shop.name}`,
                                fixable: true
                            });
                        } else {
                            shopNames.set(name, idx);
                        }
                    }
                });
            }
            
            // Check areas
            if (planData.areas) {
                planData.areas.forEach((area, idx) => {
                    if (!area.name) issues.critical.push({ type: 'missing_area_name', index: idx, message: `منطقة ${idx + 1}: اسم غير محدد` });
                    if (!area.id) issues.suggestions.push({ type: 'missing_area_id', index: idx, message: `منطقة ${idx + 1}: معرف غير موجود`, fixable: true });
                });
            }
            
            // Check inspectors
            if (planData.inspectors) {
                planData.inspectors.forEach((inspector, idx) => {
                    if (!inspector.name) issues.critical.push({ type: 'missing_inspector_name', index: idx, message: `مفتش ${idx + 1}: اسم غير محدد` });
                });
            }
            
            // Create quality report modal
            const totalIssues = issues.critical.length + issues.warnings.length + issues.suggestions.length;
            
            if (totalIssues === 0) {
                alert('✅ ممتاز! جودة البيانات عالية جداً!\n\nلا توجد مشاكل في البيانات.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'qualityModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 900px; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #667eea;">
                        <h2 style="color: #2d3561; margin: 0;">🔍 تقرير جودة البيانات</h2>
                        <button onclick="document.getElementById('qualityModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">×</button>
                    </div>
                    
                    <!-- Summary -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: ${issues.critical.length > 0 ? 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)' : 'linear-gradient(135deg, #27ae60 0%, #229954 100%)'}; padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 700;">${issues.critical.length}</div>
                            <div>مشاكل حرجة</div>
                        </div>
                        <div style="background: ${issues.warnings.length > 0 ? 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)' : 'linear-gradient(135deg, #27ae60 0%, #229954 100%)'}; padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 700;">${issues.warnings.length}</div>
                            <div>تحذيرات</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 700;">${issues.suggestions.length}</div>
                            <div>اقتراحات</div>
                        </div>
                    </div>
                    
                    <!-- Critical Issues -->
                    ${issues.critical.length > 0 ? `
                        <div style="background: #ffebee; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #e74c3c;">
                            <h3 style="color: #c0392b; margin-bottom: 15px;">🚨 مشاكل حرجة (يجب إصلاحها)</h3>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${issues.critical.slice(0, 20).map(issue => `
                                    <div style="padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px; border-right: 4px solid #e74c3c;">
                                        ${issue.message}
                                    </div>
                                `).join('')}
                                ${issues.critical.length > 20 ? `<div style="text-align: center; color: #666; padding: 10px;">... و ${issues.critical.length - 20} مشكلة أخرى</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Warnings -->
                    ${issues.warnings.length > 0 ? `
                        <div style="background: #fff3cd; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #ffc107;">
                            <h3 style="color: #856404; margin-bottom: 15px;">⚠️ تحذيرات (يُنصح بإصلاحها)</h3>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${issues.warnings.slice(0, 20).map(issue => `
                                    <div style="padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px; border-right: 4px solid #ffc107;">
                                        ${issue.message}
                                        ${issue.fixable ? '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 10px;">قابل للإصلاح</span>' : ''}
                                    </div>
                                `).join('')}
                                ${issues.warnings.length > 20 ? `<div style="text-align: center; color: #666; padding: 10px;">... و ${issues.warnings.length - 20} تحذير آخر</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Suggestions -->
                    ${issues.suggestions.length > 0 ? `
                        <div style="background: #d1ecf1; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #17a2b8;">
                            <h3 style="color: #0c5460; margin-bottom: 15px;">💡 اقتراحات تحسين</h3>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${issues.suggestions.slice(0, 20).map(issue => `
                                    <div style="padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px; border-right: 4px solid #17a2b8;">
                                        ${issue.message}
                                        ${issue.fixable ? '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 10px;">قابل للإصلاح</span>' : ''}
                                    </div>
                                `).join('')}
                                ${issues.suggestions.length > 20 ? `<div style="text-align: center; color: #666; padding: 10px;">... و ${issues.suggestions.length - 20} اقتراح آخر</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Auto-fix Options -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0;">🔧 الإصلاح التلقائي</h3>
                        <p style="margin-bottom: 15px; font-size: 0.95em;">يمكن للنظام إصلاح بعض المشاكل تلقائياً:</p>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="autoFixMissingIds()" class="btn btn-success" style="background: white; color: #667eea;">
                                إصلاح المعرفات المفقودة
                            </button>
                            <button onclick="autoFixDuplicates()" class="btn btn-warning" style="background: white; color: #667eea;">
                                دمج التفتيشات المكررة
                            </button>
                            <button onclick="autoFixMissingShifts()" class="btn btn-info" style="background: white; color: #667eea;">
                                إضافة المناوبات الافتراضية
                            </button>
                        </div>
                    </div>
                    
                    <!-- Export Report -->
                    <div style="text-align: center;">
                        <button onclick="exportQualityReport()" class="btn btn-primary">
                            <span>📄</span>
                            <span>تصدير تقرير الجودة</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store issues for auto-fix functions
            window.currentQualityIssues = issues;
        }
        
        // Auto-fix Missing IDs
        window.autoFixMissingIds = function() {
            let fixed = 0;
            
            // Fix inspection IDs
            planData.inspectionData?.forEach(insp => {
                if (!insp.id) {
                    insp.id = 'insp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    fixed++;
                }
            });
            
            // Fix shop IDs
            planData.shops?.forEach(shop => {
                if (!shop.id) {
                    shop.id = 'shop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    fixed++;
                }
            });
            
            // Fix area IDs
            planData.areas?.forEach(area => {
                if (!area.id) {
                    area.id = 'area_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    fixed++;
                }
            });
            
            alert(`✅ تم إصلاح ${fixed} معرف مفقود!\n\n⚠️ لا تنسَ حفظ التغييرات`);
            document.getElementById('qualityModal').remove();
            checkDataQuality(); // Re-check
        };
        
        // Auto-fix Duplicates
        window.autoFixDuplicates = async function() {
            const duplicates = window.currentQualityIssues.warnings.filter(i => i.type === 'duplicate');
            
            if (duplicates.length === 0) {
                alert('✅ لا توجد تفتيشات مكررة!');
                return;
            }
            
            if (!confirm(`⚠️ سيتم دمج ${duplicates.length} تفتيش مكرر\n\nهل تريد المتابعة؟`)) {
                return;
            }
            
            // Call bulk merge function
            await bulkMergeDuplicates();
        };
        
        // Auto-fix Missing Shifts
        window.autoFixMissingShifts = function() {
            let fixed = 0;
            
            planData.inspectionData?.forEach(insp => {
                if (!insp.shift) {
                    insp.shift = 'صباحية'; // Default to morning shift
                    fixed++;
                }
            });
            
            alert(`✅ تم إضافة ${fixed} مناوبة افتراضية (صباحية)!\n\n⚠️ لا تنسَ حفظ التغييرات`);
            document.getElementById('qualityModal').remove();
            checkDataQuality(); // Re-check
        };
        
        // Export Quality Report
        window.exportQualityReport = function() {
            const issues = window.currentQualityIssues;
            
            let report = '🔍 تقرير جودة البيانات - Smart Planner\n';
            report += '═'.repeat(60) + '\n\n';
            report += `📅 تاريخ الفحص: ${new Date().toLocaleString('ar-EG')}\n\n`;
            
            report += '📊 ملخص المشاكل:\n';
            report += '─'.repeat(60) + '\n';
            report += `   🚨 مشاكل حرجة: ${issues.critical.length}\n`;
            report += `   ⚠️ تحذيرات: ${issues.warnings.length}\n`;
            report += `   💡 اقتراحات: ${issues.suggestions.length}\n\n`;
            
            if (issues.critical.length > 0) {
                report += '🚨 المشاكل الحرجة:\n';
                report += '─'.repeat(60) + '\n';
                issues.critical.forEach((issue, idx) => {
                    report += `   ${idx + 1}. ${issue.message}\n`;
                });
                report += '\n';
            }
            
            if (issues.warnings.length > 0) {
                report += '⚠️ التحذيرات:\n';
                report += '─'.repeat(60) + '\n';
                issues.warnings.forEach((issue, idx) => {
                    report += `   ${idx + 1}. ${issue.message}${issue.fixable ? ' [قابل للإصلاح]' : ''}\n`;
                });
                report += '\n';
            }
            
            if (issues.suggestions.length > 0) {
                report += '💡 الاقتراحات:\n';
                report += '─'.repeat(60) + '\n';
                issues.suggestions.forEach((issue, idx) => {
                    report += `   ${idx + 1}. ${issue.message}${issue.fixable ? ' [قابل للإصلاح]' : ''}\n`;
                });
            }
            
            const dataBlob = new Blob(['\uFEFF' + report], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `تقرير-جودة-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('✅ تم تصدير تقرير الجودة بنجاح!');
        };
        
        // View System Logs - ENHANCED WITH DETAILED LOGS
        function viewSystemLogs() {
            // Initialize logs in sessionStorage if not exists
            if (!sessionStorage.getItem('smartPlannerLogs')) {
                sessionStorage.setItem('smartPlannerLogs', JSON.stringify([]));
            }
            
            const logs = JSON.parse(sessionStorage.getItem('smartPlannerLogs') || '[]');
            
            // Add current system status
            const currentStatus = {
                timestamp: new Date().toISOString(),
                type: 'info',
                message: 'عرض سجل النظام',
                details: {
                    inspections: planData?.inspectionData?.length || 0,
                    shops: planData?.shops?.length || 0,
                    areas: planData?.areas?.length || 0,
                    inspectors: planData?.inspectors?.length || 0
                }
            };
            
            // Create system logs modal
            const modal = document.createElement('div');
            modal.id = 'logsModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 1000px; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #667eea;">
                        <h2 style="color: #2d3561; margin: 0;">📋 سجل النظام المفصل</h2>
                        <button onclick="document.getElementById('logsModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">×</button>
                    </div>
                    
                    <!-- System Status -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0;">⚡ حالة النظام الحالية</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: 700;">${planData?.inspectionData?.length || 0}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">التفتيشات</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: 700;">${planData?.shops?.length || 0}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">المحلات</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: 700;">${planData?.areas?.length || 0}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">المناطق</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: 700;">${planData?.inspectors?.length || 0}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">المفتشون</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                            <div style="font-size: 0.9em;">
                                📅 آخر تحديث: ${planData?.lastUpdate ? new Date(planData.lastUpdate).toLocaleString('ar-EG') : 'غير محدد'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Log Controls -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button onclick="filterLogs('all')" class="btn btn-primary btn-sm">
                            جميع السجلات (${logs.length})
                        </button>
                        <button onclick="filterLogs('info')" class="btn btn-info btn-sm">
                            معلومات (${logs.filter(l => l.type === 'info').length})
                        </button>
                        <button onclick="filterLogs('success')" class="btn btn-success btn-sm">
                            نجاح (${logs.filter(l => l.type === 'success').length})
                        </button>
                        <button onclick="filterLogs('warning')" class="btn btn-warning btn-sm">
                            تحذيرات (${logs.filter(l => l.type === 'warning').length})
                        </button>
                        <button onclick="filterLogs('error')" class="btn btn-danger btn-sm">
                            أخطاء (${logs.filter(l => l.type === 'error').length})
                        </button>
                        <button onclick="clearSystemLogs()" class="btn btn-danger btn-sm">
                            مسح السجلات
                        </button>
                        <button onclick="exportSystemLogs()" class="btn btn-success btn-sm">
                            تصدير السجلات
                        </button>
                    </div>
                    
                    <!-- Logs Display -->
                    <div id="logsDisplay" style="background: #f8f9fa; padding: 20px; border-radius: 15px; max-height: 500px; overflow-y: auto;">
                        ${logs.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 3em; margin-bottom: 10px;">📋</div>
                                <p>لا توجد سجلات حتى الآن</p>
                                <p style="font-size: 0.9em;">سيتم تسجيل الأحداث هنا تلقائياً</p>
                            </div>
                        ` : logs.slice().reverse().map(log => {
                            const typeColors = {
                                info: { bg: '#d1ecf1', border: '#17a2b8', icon: 'ℹ️' },
                                success: { bg: '#d4edda', border: '#28a745', icon: '✅' },
                                warning: { bg: '#fff3cd', border: '#ffc107', icon: '⚠️' },
                                error: { bg: '#f8d7da', border: '#dc3545', icon: '❌' }
                            };
                            const style = typeColors[log.type] || typeColors.info;
                            
                            return `
                                <div class="log-entry" data-type="${log.type}" style="background: ${style.bg}; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-right: 4px solid ${style.border};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 1.2em;">${style.icon}</span>
                                            <strong>${log.message}</strong>
                                        </div>
                                        <small style="color: #666;">${new Date(log.timestamp).toLocaleString('ar-EG')}</small>
                                    </div>
                                    ${log.details ? `
                                        <div style="font-size: 0.9em; color: #666; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(0,0,0,0.1);">
                                            ${typeof log.details === 'object' ? 
                                                Object.entries(log.details).map(([k, v]) => `${k}: ${v}`).join(' • ') : 
                                                log.details
                                            }
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Filter Logs
        window.filterLogs = function(type) {
            const entries = document.querySelectorAll('.log-entry');
            entries.forEach(entry => {
                if (type === 'all' || entry.dataset.type === type) {
                    entry.style.display = 'block';
                } else {
                    entry.style.display = 'none';
                }
            });
        };
        
        // Clear System Logs
        window.clearSystemLogs = function() {
            if (!confirm('⚠️ هل أنت متأكد من حذف جميع السجلات؟\n\nلن يمكن استرجاعها!')) {
                return;
            }
            
            sessionStorage.setItem('smartPlannerLogs', JSON.stringify([]));
            document.getElementById('logsModal').remove();
            alert('✅ تم مسح جميع السجلات');
        };
        
        // Export System Logs
        window.exportSystemLogs = function() {
            const logs = JSON.parse(sessionStorage.getItem('smartPlannerLogs') || '[]');
            
            if (logs.length === 0) {
                alert('⚠️ لا توجد سجلات لتصديرها');
                return;
            }
            
            let report = '📋 سجل النظام - Smart Planner\n';
            report += '═'.repeat(60) + '\n\n';
            report += `📅 تاريخ التصدير: ${new Date().toLocaleString('ar-EG')}\n`;
            report += `📊 عدد السجلات: ${logs.length}\n\n`;
            
            logs.slice().reverse().forEach((log, idx) => {
                report += `[${idx + 1}] ${new Date(log.timestamp).toLocaleString('ar-EG')}\n`;
                report += `النوع: ${log.type.toUpperCase()}\n`;
                report += `الرسالة: ${log.message}\n`;
                if (log.details) {
                    report += `التفاصيل: ${typeof log.details === 'object' ? JSON.stringify(log.details, null, 2) : log.details}\n`;
                }
                report += '─'.repeat(60) + '\n\n';
            });
            
            const dataBlob = new Blob(['\uFEFF' + report], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `system-logs-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('✅ تم تصدير السجلات بنجاح!');
        };
        
        // Add System Log (utility function)
        window.addSystemLog = function(type, message, details = null) {
            const logs = JSON.parse(sessionStorage.getItem('smartPlannerLogs') || '[]');
            logs.push({
                timestamp: new Date().toISOString(),
                type: type,
                message: message,
                details: details
            });
            
            // Keep only last 100 logs
            if (logs.length > 100) {
                logs.splice(0, logs.length - 100);
            }
            
            sessionStorage.setItem('smartPlannerLogs', JSON.stringify(logs));
        };
        
        // Bulk Operations - REAL IMPLEMENTATION
        function bulkOperations() {
            if (!planData || !planData.inspectionData) {
                alert('⚠️ لا توجد بيانات للعمليات الجماعية');
                return;
            }
            
            // Create bulk operations modal
            const modal = document.createElement('div');
            modal.id = 'bulkOpsModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 900px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #667eea;">
                        <h2 style="color: #2d3561; margin: 0;">⚙️ العمليات الجماعية الذكية</h2>
                        <button onclick="document.getElementById('bulkOpsModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <!-- Operation Selection -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <button onclick="bulkEditInspections()" class="btn btn-primary" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">✏️</span>
                            <span>تعديل جماعي للتفتيشات</span>
                        </button>
                        <button onclick="bulkDeleteInspections()" class="btn btn-danger" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">🗑️</span>
                            <span>حذف جماعي للتفتيشات</span>
                        </button>
                        <button onclick="bulkCopyInspections()" class="btn btn-info" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">📋</span>
                            <span>نسخ جماعي للتفتيشات</span>
                        </button>
                        <button onclick="bulkReassignInspectors()" class="btn btn-warning" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">👥</span>
                            <span>إعادة تعيين المفتشين</span>
                        </button>
                        <button onclick="bulkReassignAreas()" class="btn btn-success" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">🗺️</span>
                            <span>إعادة تعيين المناطق</span>
                        </button>
                        <button onclick="bulkMergeDuplicates()" class="btn btn-primary" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">🔗</span>
                            <span>دمج التفتيشات المكررة</span>
                        </button>
                    </div>
                    
                    <!-- Statistics -->
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 15px; margin-top: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">📊 إحصائيات البيانات</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #667eea;">${planData.inspectionData.length}</div>
                                <div style="color: #666; font-size: 0.9em;">إجمالي التفتيشات</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #11998e;">${new Set(planData.inspectionData.map(i => i.inspector)).size}</div>
                                <div style="color: #666; font-size: 0.9em;">عدد المفتشين</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #fa709a;">${new Set(planData.inspectionData.map(i => i.area)).size}</div>
                                <div style="color: #666; font-size: 0.9em;">عدد المناطق</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #ffc107;">${planData.inspectionData.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0)}</div>
                                <div style="color: #666; font-size: 0.9em;">إجمالي المحلات</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // View Group Inspection Reports
        function viewGroupInspectionReports() {
            if (!planData || !planData.groupInspectionData || planData.groupInspectionData.length === 0) {
                alert('⚠️ لا توجد تفتيشات جماعية حالياً');
                return;
            }
            
            // Create reports modal
            const modal = document.createElement('div');
            modal.id = 'groupReportsModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
                animation: fadeIn 0.3s ease;
            `;
            
            // Group inspections by area
            const byArea = {};
            planData.groupInspectionData.forEach((item, idx) => {
                const area = item.area || 'غير محدد';
                if (!byArea[area]) {
                    byArea[area] = [];
                }
                byArea[area].push({...item, index: idx});
            });
            
            // Build area sections
            let areasHTML = '';
            Object.keys(byArea).sort().forEach(area => {
                const items = byArea[area];
                areasHTML += `
                    <div style="margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 12px; border: 2px solid #e0e0e0;">
                        <h3 style="color: #2d3561; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>🗺️</span>
                            <span>${area}</span>
                            <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.85em;">${items.length} تفتيش</span>
                        </h3>
                        <div style="display: grid; gap: 15px;">
                            ${items.map(item => {
                                const inspectorsList = item.inspectors.join('، ');
                                const hasReport = item.reportUrl && item.reportUrl.trim() !== '';
                                return `
                                    <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                            <div>
                                                <strong style="color: #666; font-size: 0.9em;">📅 التاريخ:</strong>
                                                <div style="margin-top: 5px;">${item.day}</div>
                                            </div>
                                            <div>
                                                <strong style="color: #666; font-size: 0.9em;">🕐 المناوبة:</strong>
                                                <div style="margin-top: 5px;">${item.shift || 'غير محدد'}</div>
                                            </div>
                                            <div>
                                                <strong style="color: #666; font-size: 0.9em;">🏪 المحل:</strong>
                                                <div style="margin-top: 5px; font-weight: 600;">${item.shopName}</div>
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 15px;">
                                            <strong style="color: #666; font-size: 0.9em;">👥 المفتشين:</strong>
                                            <div style="margin-top: 5px; display: flex; flex-wrap: wrap; gap: 5px;">
                                                ${item.inspectors.map(inspector => 
                                                    `<span style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.85em;">👤 ${inspector}</span>`
                                                ).join('')}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <strong style="color: #666; font-size: 0.9em;">📄 التقرير:</strong>
                                            ${hasReport ? 
                                                `<a href="${item.reportUrl}" target="_blank" style="background: #4caf50; color: white; padding: 8px 16px; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; gap: 5px;">
                                                    <span>📥</span>
                                                    <span>تحميل التقرير</span>
                                                </a>` :
                                                `<span style="color: #999; font-style: italic;">لا يوجد تقرير</span>`
                                            }
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 1000px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #ff9800;">
                        <h2 style="color: #2d3561; margin: 0; display: flex; align-items: center; gap: 10px;">
                            <span>👥</span>
                            <span>تقارير التفتيش الجماعي</span>
                            <span style="background: #ff9800; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.7em;">${planData.groupInspectionData.length} تفتيش</span>
                        </h2>
                        <button onclick="document.getElementById('groupReportsModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                        ${areasHTML}
                    </div>
                    
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e0e0e0; display: flex; gap: 10px; justify-content: center;">
                        <button onclick="exportGroupInspectionsToExcel()" class="btn btn-success" style="display: flex; align-items: center; gap: 8px;">
                            <span>📊</span>
                            <span>تصدير إلى Excel</span>
                        </button>
                        <button onclick="printGroupInspectionReports()" class="btn btn-primary" style="display: flex; align-items: center; gap: 8px;">
                            <span>🖨️</span>
                            <span>طباعة</span>
                        </button>
                        <button onclick="document.getElementById('groupReportsModal').remove()" class="btn btn-warning">
                            <span>✕</span>
                            <span>إغلاق</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Export group inspections to Excel
        window.exportGroupInspectionsToExcel = function() {
            if (!planData || !planData.groupInspectionData || planData.groupInspectionData.length === 0) {
                alert('⚠️ لا توجد بيانات لتصديرها');
                return;
            }
            
            // Prepare data for Excel
            const data = planData.groupInspectionData.map(item => ({
                'التاريخ': item.day,
                'المناوبة': item.shift || '',
                'المنطقة': item.area,
                'المحل': item.shopName,
                'المفتشين': item.inspectors.join('، '),
                'حالة التقرير': item.reportUrl ? 'متوفر' : 'غير متوفر'
            }));
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'التفتيش الجماعي');
            
            // Generate filename
            const filename = `تقارير_التفتيش_الجماعي_${new Date().toISOString().split('T')[0]}.xlsx`;
            
            // Download
            XLSX.writeFile(wb, filename);
            alert('✅ تم تصدير البيانات بنجاح!');
        };
        
        // Print group inspection reports
        window.printGroupInspectionReports = function() {
            window.print();
        };
        
        // Upload Group Inspection Report
        window.uploadGroupInspectionReport = function() {
            if (!planData || !planData.groupInspectionData || planData.groupInspectionData.length === 0) {
                alert('⚠️ لا توجد تفتيشات جماعية حالياً');
                return;
            }
            
            // Create upload modal
            const modal = document.createElement('div');
            modal.id = 'uploadReportModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
                animation: fadeIn 0.3s ease;
            `;
            
            // Build list of group inspections
            let inspectionsHTML = '';
            planData.groupInspectionData.forEach((item, idx) => {
                const hasReport = item.reportUrl && item.reportUrl.trim() !== '';
                const inspectorsList = item.inspectors.join('، ');
                
                inspectionsHTML += `
                    <div style="background: ${hasReport ? '#f0f8f0' : 'white'}; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 2px solid ${hasReport ? '#4caf50' : '#e0e0e0'};">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: center;">
                            <div>
                                <strong style="color: #666; font-size: 0.9em;">📅 التاريخ:</strong>
                                <div>${item.day}</div>
                            </div>
                            <div>
                                <strong style="color: #666; font-size: 0.9em;">🏪 المحل:</strong>
                                <div style="font-weight: 600;">${item.shopName}</div>
                            </div>
                            <div>
                                <strong style="color: #666; font-size: 0.9em;">👥 المفتشين:</strong>
                                <div style="font-size: 0.9em;">${inspectorsList}</div>
                            </div>
                            <div>
                                ${hasReport ? 
                                    `<div style="display: flex; flex-direction: column; gap: 5px;">
                                        <span style="color: #4caf50; font-weight: bold; font-size: 0.9em;">✅ يوجد تقرير</span>
                                        <button onclick="selectReportFile(${idx})" class="btn btn-sm btn-warning" style="padding: 5px 10px; font-size: 0.85em;">
                                            تغيير التقرير
                                        </button>
                                    </div>` :
                                    `<button onclick="selectReportFile(${idx})" class="btn btn-sm btn-success" style="padding: 5px 15px;">
                                        رفع تقرير
                                    </button>`
                                }
                            </div>
                        </div>
                        ${hasReport ? `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                                <a href="${item.reportUrl}" target="_blank" style="color: #667eea; text-decoration: none; font-size: 0.9em;">
                                    🔗 ${item.reportUrl}
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 1000px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #28a745;">
                        <h2 style="color: #2d3561; margin: 0; display: flex; align-items: center; gap: 10px;">
                            <span>📤</span>
                            <span>رفع تقارير التفتيش الجماعي</span>
                        </h2>
                        <button onclick="document.getElementById('uploadReportModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #90caf9;">
                        <strong style="color: #1976d2;">💡 ملاحظات هامة:</strong>
                        <ul style="margin: 10px 0 0 20px; color: #666;">
                            <li>يمكنك رفع التقارير كملفات (PDF, Word, Excel, صور) أو إدخال رابط مباشر</li>
                            <li>يتم حفظ رابط التقرير تلقائياً مع بيانات التفتيش</li>
                            <li>يمكن تغيير التقرير في أي وقت</li>
                        </ul>
                    </div>
                    
                    <div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                        ${inspectionsHTML}
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e0e0e0; display: flex; gap: 10px; justify-content: center;">
                        <button onclick="document.getElementById('uploadReportModal').remove()" class="btn btn-secondary">
                            <span>✕</span>
                            <span>إغلاق</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        // Select report file for upload
        window.selectReportFile = function(inspectionIndex) {
            // Ask user if they want to upload a file or provide a URL
            const choice = confirm('هل تريد رفع ملف؟\n\nاضغط "موافق" لرفع ملف\nاضغط "إلغاء" لإدخال رابط مباشر');
            
            if (choice) {
                // Upload file option
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // Since we can't actually upload to a server without backend,
                    // we'll create a local object URL and save it
                    // In a real scenario, this would upload to a server and get back a URL
                    const fileUrl = URL.createObjectURL(file);
                    
                    // Show confirmation with file info
                    const confirmUpload = confirm(
                        `📄 معلومات الملف:\n\n` +
                        `الاسم: ${file.name}\n` +
                        `الحجم: ${(file.size / 1024).toFixed(2)} KB\n` +
                        `النوع: ${file.type}\n\n` +
                        `ملاحظة: في بيئة الإنتاج، سيتم رفع الملف إلى خادم.\n` +
                        `حالياً، سيتم حفظ رابط محلي مؤقت.\n\n` +
                        `هل تريد المتابعة؟`
                    );
                    
                    if (confirmUpload) {
                        // Save the file URL to the inspection data
                        planData.groupInspectionData[inspectionIndex].reportUrl = fileUrl;
                        planData.groupInspectionData[inspectionIndex].reportFileName = file.name;
                        planData.groupInspectionData[inspectionIndex].reportUploadDate = new Date().toISOString();
                        
                        // Show success message
                        alert('✅ تم رفع التقرير بنجاح!\n\nملاحظة: في بيئة الإنتاج، سيتم رفع الملف إلى خادم دائم.');
                        
                        // Refresh the modal
                        document.getElementById('uploadReportModal').remove();
                        uploadGroupInspectionReport();
                        
                        // Mark data as modified
                        dataModified = true;
                    }
                };
                input.click();
            } else {
                // URL input option
                const reportUrl = prompt('📎 أدخل رابط التقرير:\n\nيمكنك إدخال رابط من Google Drive, Dropbox, أو أي خدمة تخزين سحابي');
                
                if (reportUrl && reportUrl.trim() !== '') {
                    // Validate URL format
                    try {
                        new URL(reportUrl);
                        
                        // Save the URL to the inspection data
                        planData.groupInspectionData[inspectionIndex].reportUrl = reportUrl.trim();
                        planData.groupInspectionData[inspectionIndex].reportUploadDate = new Date().toISOString();
                        
                        alert('✅ تم حفظ رابط التقرير بنجاح!');
                        
                        // Refresh the modal
                        document.getElementById('uploadReportModal').remove();
                        uploadGroupInspectionReport();
                        
                        // Mark data as modified
                        dataModified = true;
                    } catch (e) {
                        alert('⚠️ الرابط غير صحيح. يرجى التأكد من صحة الرابط والمحاولة مرة أخرى.');
                    }
                }
            }
        };
        
        // Load and Edit Group Inspection Report from GitHub
        window.loadAndEditGroupInspectionReport = async function() {
            // Show loading message
            const loadingDiv = document.createElement('div');
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
            `;
            loadingDiv.innerHTML = '<div style="font-size: 1.2em; color: #667eea;">⏳ جاري تحميل التقارير من GitHub...</div>';
            document.body.appendChild(loadingDiv);
            
            try {
                // Fetch group inspection reports from GitHub
                const GITHUB_REPO = 'aliabdelaal-adm/Monthly_inspection_plan';
                const GITHUB_TOKEN = localStorage.getItem('developerToken') || '';
                
                // Fetch files.json to get list of reports
                const filesResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/files.json?t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!filesResponse.ok) {
                    throw new Error('فشل تحميل قائمة الملفات من GitHub');
                }
                
                const filesData = await filesResponse.json();
                const filesContent = JSON.parse(atob(filesData.content));
                
                // Filter group inspection reports
                const groupReports = filesContent.files.filter(file => 
                    file.category === 'group_inspection_reports' && file.visible !== false
                );
                
                if (groupReports.length === 0) {
                    alert('⚠️ لا توجد تقارير تفتيش جماعي في GitHub حالياً');
                    document.body.removeChild(loadingDiv);
                    return;
                }
                
                // Remove loading message
                document.body.removeChild(loadingDiv);
                
                // Create selection modal
                const modal = document.createElement('div');
                modal.id = 'loadReportModal';
                modal.style.cssText = `
                    display: block;
                    position: fixed;
                    z-index: 10000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    overflow: auto;
                    animation: fadeIn 0.3s ease;
                `;
                
                // Build reports list
                let reportsHTML = '';
                groupReports.forEach((report, idx) => {
                    const uploadDate = new Date(report.uploadDate).toLocaleString('ar-EG');
                    reportsHTML += `
                        <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 2px solid #e0e0e0; cursor: pointer; transition: all 0.3s ease;" 
                             onmouseover="this.style.borderColor='#2196f3'; this.style.transform='translateY(-2px)'" 
                             onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='translateY(0)'"
                             onclick="loadReportForEditing('${report.path}', '${report.name}')">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3561; margin-bottom: 5px;">
                                        📄 ${report.name}
                                    </div>
                                    <div style="font-size: 0.9em; color: #666;">
                                        📝 ${report.description || 'تقرير تفتيش جماعي'}
                                    </div>
                                    <div style="font-size: 0.85em; color: #999; margin-top: 5px;">
                                        👤 ${report.uploader || 'غير محدد'} | 📅 ${uploadDate}
                                    </div>
                                </div>
                                <div>
                                    <button onclick="event.stopPropagation(); loadReportForEditing('${report.path}', '${report.name}')" 
                                            class="btn btn-sm btn-primary" 
                                            style="padding: 8px 20px; white-space: nowrap;">
                                        📝 تحرير
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                modal.innerHTML = `
                    <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 900px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #2196f3;">
                            <h2 style="color: #2d3561; margin: 0; display: flex; align-items: center; gap: 10px;">
                                <span>📝</span>
                                <span>تحميل وتحرير تقرير التفتيش الجماعي</span>
                                <span style="background: #2196f3; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.7em;">${groupReports.length} تقرير</span>
                            </h2>
                            <button onclick="document.getElementById('loadReportModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                        </div>
                        
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #90caf9;">
                            <strong style="color: #1976d2;">💡 تعليمات:</strong>
                            <ul style="margin: 10px 0 0 20px; color: #666;">
                                <li>اختر تقرير لتحميله وتحريره</li>
                                <li>يمكنك تعديل جميع بنود التقرير</li>
                                <li>يمكنك إضافة أو حذف بنود التفتيش</li>
                                <li>بعد التعديل، احفظ التقرير مرة أخرى في GitHub</li>
                            </ul>
                        </div>
                        
                        <div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                            ${reportsHTML}
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e0e0e0; text-align: center;">
                            <button onclick="document.getElementById('loadReportModal').remove()" class="btn btn-secondary">
                                <span>✕</span>
                                <span>إغلاق</span>
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error loading reports:', error);
                document.body.removeChild(loadingDiv);
                alert('❌ حدث خطأ أثناء تحميل التقارير من GitHub:\n\n' + error.message + '\n\nالرجاء التحقق من:\n1. اتصالك بالإنترنت\n2. إعدادات رمز الوصول في لوحة المطور');
            }
        };
        
        // Load specific report for editing
        window.loadReportForEditing = async function(reportPath, reportName) {
            // Close the selection modal
            const modal = document.getElementById('loadReportModal');
            if (modal) modal.remove();
            
            // Show loading message
            const loadingDiv = document.createElement('div');
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
            `;
            loadingDiv.innerHTML = '<div style="font-size: 1.2em; color: #667eea;">⏳ جاري تحميل التقرير...</div>';
            document.body.appendChild(loadingDiv);
            
            try {
                const GITHUB_REPO = 'aliabdelaal-adm/Monthly_inspection_plan';
                const GITHUB_TOKEN = localStorage.getItem('developerToken') || '';
                
                // Fetch the report content
                const reportResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${reportPath}?t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!reportResponse.ok) {
                    throw new Error('فشل تحميل التقرير');
                }
                
                const reportData = await reportResponse.json();
                const reportContent = JSON.parse(atob(reportData.content));
                
                // Remove loading message
                document.body.removeChild(loadingDiv);
                
                // Create editing modal
                const editModal = document.createElement('div');
                editModal.id = 'editReportModal';
                editModal.style.cssText = `
                    display: block;
                    position: fixed;
                    z-index: 10000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    overflow: auto;
                    animation: fadeIn 0.3s ease;
                `;
                
                // Build checklist items for editing
                let checklistHTML = '';
                if (reportContent.checklist && Array.isArray(reportContent.checklist)) {
                    reportContent.checklist.forEach((item, idx) => {
                        checklistHTML += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #e0e0e0;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">
                                            البند ${idx + 1}:
                                        </label>
                                        <input type="text" id="item_label_${idx}" value="${item.label || ''}" 
                                               style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                                    </div>
                                    <button onclick="removeChecklistItem(${idx})" 
                                            style="margin-right: 10px; padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                        🗑️ حذف
                                    </button>
                                </div>
                                
                                <div style="margin-top: 10px;">
                                    <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">
                                        الحالة:
                                    </label>
                                    <select id="item_value_${idx}" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                                        <option value="مستوفى" ${item.value === 'مستوفى' ? 'selected' : ''}>✅ مستوفى</option>
                                        <option value="غير مستوفى" ${item.value === 'غير مستوفى' ? 'selected' : ''}>❌ غير مستوفى</option>
                                        <option value="لم يتم التفتيش" ${item.value === 'لم يتم التفتيش' ? 'selected' : ''}>⏭️ لم يتم التفتيش</option>
                                        <option value="لا ينطبق" ${item.value === 'لا ينطبق' ? 'selected' : ''}>➖ لا ينطبق</option>
                                    </select>
                                </div>
                                
                                ${item.unfulfilledDetails ? `
                                    <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 8px;">
                                        <strong style="color: #856404;">تفاصيل عدم الاستيفاء:</strong>
                                        <div style="margin-top: 8px; padding: 8px; background: white; border: 2px solid #ddd; border-radius: 8px; font-size: 0.9em; color: #666;">
                                            ${typeof item.unfulfilledDetails === 'object' ? 
                                                (item.unfulfilledDetails.selectedSubItems && Array.isArray(item.unfulfilledDetails.selectedSubItems) ? 
                                                    '<div><strong>البنود المحددة:</strong> ' + item.unfulfilledDetails.selectedSubItems.map(s => String(s).replace(/</g, '&lt;').replace(/>/g, '&gt;')).join('، ') + '</div>' : '') +
                                                (item.unfulfilledDetails.manualItems ? 
                                                    '<div style="margin-top: 5px;"><strong>بنود إضافية:</strong> ' + String(item.unfulfilledDetails.manualItems).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>' : '') +
                                                (item.unfulfilledDetails.action ? 
                                                    '<div style="margin-top: 5px;"><strong>الإجراء:</strong> ' + String(item.unfulfilledDetails.action).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>' : '')
                                                : String(item.unfulfilledDetails).replace(/</g, '&lt;').replace(/>/g, '&gt;')
                                            }
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                }
                
                editModal.innerHTML = `
                    <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 20px; max-width: 1200px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #667eea; position: sticky; top: 0; background: white; z-index: 1;">
                            <h2 style="color: #2d3561; margin: 0; display: flex; align-items: center; gap: 10px;">
                                <span>✏️</span>
                                <span>تحرير التقرير: ${reportName}</span>
                            </h2>
                            <button onclick="closeEditReportModal()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                        </div>
                        
                        <!-- Report Basic Info -->
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="color: #1976d2; margin-bottom: 15px;">معلومات التقرير</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">التاريخ:</label>
                                    <input type="date" id="report_date" value="${reportContent.date || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">المناوبة:</label>
                                    <input type="text" id="report_shift" value="${reportContent.shift || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">المنطقة:</label>
                                    <input type="text" id="report_area" value="${reportContent.area || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">المفتش:</label>
                                    <input type="text" id="report_inspector" value="${reportContent.selectedInspector || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Checklist Items -->
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #2d3561; margin: 0;">بنود التفتيش</h3>
                                <button onclick="addNewChecklistItem()" class="btn btn-success" style="padding: 10px 20px;">
                                    ➕ إضافة بند جديد
                                </button>
                            </div>
                            <div id="checklistItemsContainer">
                                ${checklistHTML}
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="color: #e65100; margin-bottom: 15px;">ملاحظات التقرير</h3>
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">ملاحظات عامة:</label>
                                    <textarea id="report_general_notes" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;" rows="3">${reportContent.notes?.generalNotes || ''}</textarea>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">المخالفات المرصودة:</label>
                                    <textarea id="report_violations" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;" rows="3">${reportContent.notes?.violations || ''}</textarea>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">التوصيات:</label>
                                    <textarea id="report_recommendations" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;" rows="3">${reportContent.notes?.recommendations || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Save Buttons -->
                        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                            <button onclick="saveEditedReport('${reportPath}', '${reportName}')" class="btn btn-success" style="padding: 15px 40px; font-size: 1.1em;">
                                💾 حفظ التعديلات
                            </button>
                            <button onclick="closeEditReportModal()" class="btn btn-secondary" style="padding: 15px 40px; font-size: 1.1em;">
                                ✕ إلغاء
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(editModal);
                
                // Store original report data for editing
                window.currentEditingReport = {
                    path: reportPath,
                    name: reportName,
                    content: reportContent
                };
                
            } catch (error) {
                console.error('Error loading report for editing:', error);
                document.body.removeChild(loadingDiv);
                alert('❌ حدث خطأ أثناء تحميل التقرير:\n\n' + error.message);
            }
        };
        
        // Close edit report modal
        window.closeEditReportModal = function() {
            const modal = document.getElementById('editReportModal');
            if (modal) modal.remove();
            window.currentEditingReport = null;
        };
        
        // Add new checklist item
        window.addNewChecklistItem = function() {
            const container = document.getElementById('checklistItemsContainer');
            if (!container) return;
            
            const itemCount = container.children.length;
            const newItemHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #28a745;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">
                                البند ${itemCount + 1}:
                            </label>
                            <input type="text" id="item_label_${itemCount}" value="" placeholder="أدخل نص البند..." 
                                   style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                        </div>
                        <button onclick="removeChecklistItem(${itemCount})" 
                                style="margin-right: 10px; padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            🗑️ حذف
                        </button>
                    </div>
                    
                    <div style="margin-top: 10px;">
                        <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">
                            الحالة:
                        </label>
                        <select id="item_value_${itemCount}" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                            <option value="مستوفى">✅ مستوفى</option>
                            <option value="غير مستوفى">❌ غير مستوفى</option>
                            <option value="لم يتم التفتيش">⏭️ لم يتم التفتيش</option>
                            <option value="لا ينطبق">➖ لا ينطبق</option>
                        </select>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newItemHTML);
        };
        
        // Remove checklist item
        window.removeChecklistItem = function(index) {
            if (!confirm('هل أنت متأكد من حذف هذا البند؟')) return;
            
            const container = document.getElementById('checklistItemsContainer');
            if (!container) return;
            
            // Find the item by looking for the input with this index
            const itemToRemove = container.querySelector(`#item_label_${index}`)?.closest('div[style*="background: #f8f9fa"]');
            if (itemToRemove) {
                itemToRemove.remove();
            }
        };
        
        // Save edited report back to GitHub
        window.saveEditedReport = async function(reportPath, reportName) {
            if (!confirm('هل أنت متأكد من حفظ التعديلات؟')) return;
            
            // Show saving message
            const savingDiv = document.createElement('div');
            savingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10001;
                text-align: center;
            `;
            savingDiv.innerHTML = '<div style="font-size: 1.2em; color: #28a745;">⏳ جاري حفظ التعديلات...</div>';
            document.body.appendChild(savingDiv);
            
            try {
                // Collect edited data
                const reportDate = document.getElementById('report_date').value;
                const reportShift = document.getElementById('report_shift').value;
                const reportArea = document.getElementById('report_area').value;
                const reportInspector = document.getElementById('report_inspector').value;
                
                // Collect checklist items
                const container = document.getElementById('checklistItemsContainer');
                const checklist = [];
                const originalChecklist = window.currentEditingReport.content.checklist || [];
                
                for (let i = 0; i < container.children.length; i++) {
                    const labelInput = document.getElementById(`item_label_${i}`);
                    const valueSelect = document.getElementById(`item_value_${i}`);
                    
                    if (labelInput && valueSelect) {
                        const item = {
                            id: `item_${i}`,
                            label: labelInput.value,
                            value: valueSelect.value
                        };
                        
                        // Preserve original unfulfilled details from loaded report
                        // (they are displayed as read-only, so we keep the original structure)
                        if (originalChecklist[i] && originalChecklist[i].unfulfilledDetails) {
                            item.unfulfilledDetails = originalChecklist[i].unfulfilledDetails;
                        }
                        
                        checklist.push(item);
                    }
                }
                
                // Collect notes
                const notes = {
                    generalNotes: document.getElementById('report_general_notes').value,
                    violations: document.getElementById('report_violations').value,
                    recommendations: document.getElementById('report_recommendations').value
                };
                
                // Build updated report
                const updatedReport = {
                    ...window.currentEditingReport.content,
                    date: reportDate,
                    shift: reportShift,
                    area: reportArea,
                    selectedInspector: reportInspector,
                    checklist: checklist,
                    notes: notes,
                    lastModified: new Date().toISOString(),
                    modifiedBy: reportInspector
                };
                
                // Save to GitHub
                const GITHUB_REPO = 'aliabdelaal-adm/Monthly_inspection_plan';
                const GITHUB_TOKEN = localStorage.getItem('developerToken') || '';
                
                // Get current file SHA
                const currentFileResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${reportPath}`, {
                    headers: {
                        'Authorization': `Bearer ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!currentFileResponse.ok) {
                    throw new Error('فشل الحصول على معلومات الملف الحالي');
                }
                
                const currentFile = await currentFileResponse.json();
                const currentSha = currentFile.sha;
                
                // Encode updated content
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(updatedReport, null, 2))));
                
                // Update file in GitHub
                const updateResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${reportPath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: `Update group inspection report: ${reportArea} - ${reportDate}`,
                        content: content,
                        sha: currentSha,
                        branch: 'main'
                    })
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.message || 'فشل حفظ التعديلات');
                }
                
                // Success!
                document.body.removeChild(savingDiv);
                alert('✅ تم حفظ التعديلات بنجاح في GitHub!');
                closeEditReportModal();
                
            } catch (error) {
                console.error('Error saving edited report:', error);
                document.body.removeChild(savingDiv);
                alert('❌ حدث خطأ أثناء حفظ التعديلات:\n\n' + error.message + '\n\nالرجاء التحقق من:\n1. اتصالك بالإنترنت\n2. إعدادات رمز الوصول\n3. صلاحياتك على المستودع');
            }
        };
        
        // Bulk Edit Inspections
        window.bulkEditInspections = function() {
            const selectedRange = prompt('📅 أدخل نطاق التواريخ للتفتيشات المراد تعديلها:\n\nمثال: 2025-01-01 إلى 2025-01-31\n\nالصيغة: من-تاريخ إلى إلى-تاريخ', '2025-01-01 إلى 2025-01-31');
            if (!selectedRange) return;
            
            const parts = selectedRange.split(' إلى ');
            if (parts.length !== 2) {
                alert('⚠️ صيغة غير صحيحة. استخدم: من-تاريخ إلى إلى-تاريخ');
                return;
            }
            
            const fromDate = new Date(parts[0].trim());
            const toDate = new Date(parts[1].trim());
            
            const matchingInspections = planData.inspectionData.filter(insp => {
                const inspDate = new Date(insp.day);
                return inspDate >= fromDate && inspDate <= toDate;
            });
            
            if (matchingInspections.length === 0) {
                alert('⚠️ لا توجد تفتيشات في النطاق المحدد');
                return;
            }
            
            const action = confirm(`✏️ تم العثور على ${matchingInspections.length} تفتيش في النطاق المحدد.\n\nهل تريد:\nOK = تعديل المفتش\nCancel = تعديل المنطقة`);
            
            if (action) {
                // Edit inspector
                const newInspector = prompt('👤 أدخل اسم المفتش الجديد:', matchingInspections[0].inspector);
                if (!newInspector) return;
                
                matchingInspections.forEach(insp => {
                    insp.inspector = newInspector;
                });
                
                alert(`✅ تم تحديث ${matchingInspections.length} تفتيش!\n\nالمفتش الجديد: ${newInspector}\n\n⚠️ لا تنسَ حفظ التغييرات`);
            } else {
                // Edit area
                const newArea = prompt('🗺️ أدخل اسم المنطقة الجديدة:', matchingInspections[0].area);
                if (!newArea) return;
                
                matchingInspections.forEach(insp => {
                    insp.area = newArea;
                });
                
                alert(`✅ تم تحديث ${matchingInspections.length} تفتيش!\n\nالمنطقة الجديدة: ${newArea}\n\n⚠️ لا تنسَ حفظ التغييرات`);
            }
        };
        
        // Bulk Delete Inspections
        window.bulkDeleteInspections = async function() {
            const selectedRange = prompt('🗑️ أدخل نطاق التواريخ للتفتيشات المراد حذفها:\n\nمثال: 2025-01-01 إلى 2025-01-31\n\nالصيغة: من-تاريخ إلى إلى-تاريخ', '2025-01-01 إلى 2025-01-31');
            if (!selectedRange) return;
            
            const parts = selectedRange.split(' إلى ');
            if (parts.length !== 2) {
                alert('⚠️ صيغة غير صحيحة. استخدم: من-تاريخ إلى إلى-تاريخ');
                return;
            }
            
            const fromDate = new Date(parts[0].trim());
            const toDate = new Date(parts[1].trim());
            
            const beforeCount = planData.inspectionData.length;
            planData.inspectionData = planData.inspectionData.filter(insp => {
                const inspDate = new Date(insp.day);
                return !(inspDate >= fromDate && inspDate <= toDate);
            });
            
            const deletedCount = beforeCount - planData.inspectionData.length;
            
            if (deletedCount === 0) {
                alert('⚠️ لا توجد تفتيشات في النطاق المحدد');
                return;
            }
            
            if (!confirm(`⚠️ هل أنت متأكد من حذف ${deletedCount} تفتيش؟\n\nهذه العملية لا يمكن التراجع عنها!`)) {
                // Reload data to undo
                await loadPlanData();
                return;
            }
            
            try {
                await savePlanDataToGitHub();
                alert(`✅ تم حذف ${deletedCount} تفتيش بنجاح!`);
                document.getElementById('bulkOpsModal').remove();
            } catch (error) {
                alert('❌ فشل الحفظ: ' + error.message);
            }
        };
        
        // Bulk Copy Inspections
        window.bulkCopyInspections = function() {
            const sourceDate = prompt('📅 أدخل التاريخ المصدر (التفتيشات التي تريد نسخها):', '2025-01-01');
            if (!sourceDate) return;
            
            const targetDate = prompt('📅 أدخل التاريخ الهدف (حيث تريد نسخ التفتيشات):', '2025-02-01');
            if (!targetDate) return;
            
            const sourceInspections = planData.inspectionData.filter(i => i.day === sourceDate);
            
            if (sourceInspections.length === 0) {
                alert('⚠️ لا توجد تفتيشات في التاريخ المصدر');
                return;
            }
            
            // Check if target date already has inspections
            const targetInspections = planData.inspectionData.filter(i => i.day === targetDate);
            if (targetInspections.length > 0) {
                if (!confirm(`⚠️ التاريخ الهدف يحتوي على ${targetInspections.length} تفتيش.\n\nهل تريد الإضافة؟`)) {
                    return;
                }
            }
            
            // Copy inspections
            sourceInspections.forEach(insp => {
                const copiedInsp = {
                    ...insp,
                    day: targetDate,
                    id: 'insp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
                };
                planData.inspectionData.push(copiedInsp);
            });
            
            alert(`✅ تم نسخ ${sourceInspections.length} تفتيش من ${sourceDate} إلى ${targetDate}!\n\n⚠️ لا تنسَ حفظ التغييرات`);
        };
        
        // Bulk Reassign Inspectors
        window.bulkReassignInspectors = function() {
            const oldInspector = prompt('👤 أدخل اسم المفتش القديم:', planData.inspectors[0]?.name || '');
            if (!oldInspector) return;
            
            const newInspector = prompt('👤 أدخل اسم المفتش الجديد:');
            if (!newInspector) return;
            
            const matchingInspections = planData.inspectionData.filter(i => i.inspector === oldInspector);
            
            if (matchingInspections.length === 0) {
                alert('⚠️ لا توجد تفتيشات للمفتش المحدد');
                return;
            }
            
            if (!confirm(`🔄 سيتم تحديث ${matchingInspections.length} تفتيش\n\nمن: ${oldInspector}\nإلى: ${newInspector}\n\nهل تريد المتابعة؟`)) {
                return;
            }
            
            matchingInspections.forEach(insp => {
                insp.inspector = newInspector;
            });
            
            alert(`✅ تم تحديث ${matchingInspections.length} تفتيش!\n\n⚠️ لا تنسَ حفظ التغييرات`);
        };
        
        // Bulk Reassign Areas
        window.bulkReassignAreas = function() {
            const oldArea = prompt('🗺️ أدخل اسم المنطقة القديمة:', planData.areas[0]?.name || '');
            if (!oldArea) return;
            
            const newArea = prompt('🗺️ أدخل اسم المنطقة الجديدة:');
            if (!newArea) return;
            
            const matchingInspections = planData.inspectionData.filter(i => i.area === oldArea);
            
            if (matchingInspections.length === 0) {
                alert('⚠️ لا توجد تفتيشات للمنطقة المحددة');
                return;
            }
            
            if (!confirm(`🔄 سيتم تحديث ${matchingInspections.length} تفتيش\n\nمن: ${oldArea}\nإلى: ${newArea}\n\nهل تريد المتابعة؟`)) {
                return;
            }
            
            matchingInspections.forEach(insp => {
                insp.area = newArea;
            });
            
            alert(`✅ تم تحديث ${matchingInspections.length} تفتيش!\n\n⚠️ لا تنسَ حفظ التغييرات`);
        };
        
        // Bulk Merge Duplicates
        window.bulkMergeDuplicates = async function() {
            const duplicates = [];
            const seen = new Map();
            
            planData.inspectionData.forEach((insp, idx) => {
                const key = `${insp.inspector}-${insp.day}-${insp.area}`;
                if (seen.has(key)) {
                    duplicates.push({
                        original: seen.get(key),
                        duplicate: idx,
                        inspector: insp.inspector,
                        day: insp.day,
                        area: insp.area
                    });
                } else {
                    seen.set(key, idx);
                }
            });
            
            if (duplicates.length === 0) {
                alert('✅ رائع! لا توجد تفتيشات مكررة في البيانات');
                return;
            }
            
            if (!confirm(`⚠️ تم العثور على ${duplicates.length} تفتيش مكرر\n\nهل تريد دمجها ومحلاتها وحذف التكرارات؟`)) {
                return;
            }
            
            // Merge duplicates
            duplicates.forEach(dup => {
                const original = planData.inspectionData[dup.original];
                const duplicate = planData.inspectionData[dup.duplicate];
                
                // Merge shops
                if (duplicate.shops) {
                    if (!original.shops) original.shops = [];
                    duplicate.shops.forEach(shop => {
                        if (!original.shops.includes(shop)) {
                            original.shops.push(shop);
                        }
                    });
                }
            });
            
            // Remove duplicates
            const toRemove = new Set(duplicates.map(d => d.duplicate));
            planData.inspectionData = planData.inspectionData.filter((_, idx) => !toRemove.has(idx));
            
            try {
                await savePlanDataToGitHub();
                alert(`✅ تم دمج وحذف ${duplicates.length} تفتيش مكرر بنجاح!`);
                document.getElementById('bulkOpsModal').remove();
            } catch (error) {
                alert('❌ فشل الحفظ: ' + error.message);
            }
        };
        
        // NEW FEATURE: Duplicate & Similar Shops Manager
        function openDuplicateShopsManager() {
            if (!planData || !planData.shops) {
                alert('⚠️ لا توجد بيانات محلات متاحة');
                return;
            }
            
            // Analyze shops for duplicates and similar names
            const duplicateAnalysis = analyzeDuplicateShops();
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'duplicateShopsModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
                animation: fadeIn 0.3s ease;
            `;
            
            let modalContent = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 20px; max-width: 1200px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #e74c3c;">
                        <h2 style="color: #2d3561; margin: 0;">🔄 إدارة المحلات المكررة والمتشابهة</h2>
                        <button onclick="document.getElementById('duplicateShopsModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <!-- Summary Statistics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 700;">${planData.shops.length}</div>
                            <div style="opacity: 0.9;">إجمالي المحلات</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 700;">${duplicateAnalysis.exactDuplicates.length}</div>
                            <div style="opacity: 0.9;">محلات مكررة تماماً</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 700;">${duplicateAnalysis.similarShops.length}</div>
                            <div style="opacity: 0.9;">محلات متشابهة</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 700;">${duplicateAnalysis.sameAreaDuplicates.length}</div>
                            <div style="opacity: 0.9;">مكررات في نفس المنطقة</div>
                        </div>
                    </div>
                    
                    <!-- Search & Filter -->
                    <div style="margin-bottom: 20px;">
                        <input type="text" id="duplicateShopsSearch" placeholder="🔍 ابحث عن محل معين..." style="width: 100%; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; font-family: 'Cairo', Arial, sans-serif;" oninput="filterDuplicateShops()">
                    </div>
                    
                    <!-- Tabs for different views -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button onclick="showDuplicateTab('exact')" id="exactDupTab" class="dup-tab-btn active" style="flex: 1; padding: 12px 20px; border: none; border-radius: 10px; background: #e74c3c; color: white; cursor: pointer; font-family: 'Cairo', Arial, sans-serif; font-weight: 600;">
                            🔴 مكررة تماماً (${duplicateAnalysis.exactDuplicates.length})
                        </button>
                        <button onclick="showDuplicateTab('similar')" id="similarTab" class="dup-tab-btn" style="flex: 1; padding: 12px 20px; border: none; border-radius: 10px; background: #95a5a6; color: white; cursor: pointer; font-family: 'Cairo', Arial, sans-serif; font-weight: 600;">
                            🟠 متشابهة (${duplicateAnalysis.similarShops.length})
                        </button>
                        <button onclick="showDuplicateTab('sameArea')" id="sameAreaTab" class="dup-tab-btn" style="flex: 1; padding: 12px 20px; border: none; border-radius: 10px; background: #95a5a6; color: white; cursor: pointer; font-family: 'Cairo', Arial, sans-serif; font-weight: 600;">
                            🗺️ نفس المنطقة (${duplicateAnalysis.sameAreaDuplicates.length})
                        </button>
                        <button onclick="showDuplicateTab('all')" id="allShopsTab" class="dup-tab-btn" style="flex: 1; padding: 12px 20px; border: none; border-radius: 10px; background: #95a5a6; color: white; cursor: pointer; font-family: 'Cairo', Arial, sans-serif; font-weight: 600;">
                            📋 جميع المحلات (${planData.shops.length})
                        </button>
                    </div>
                    
                    <!-- Content Area -->
                    <div id="duplicateShopsContent" style="max-height: 500px; overflow-y: auto; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        ${renderDuplicateShops(duplicateAnalysis.exactDuplicates, 'exact')}
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="mergeSelectedDuplicates()" class="btn btn-success" style="flex: 1;">
                            <span>🔗</span> دمج المحلات المحددة
                        </button>
                        <button onclick="deleteSelectedDuplicates()" class="btn btn-danger" style="flex: 1;">
                            <span>🗑️</span> حذف المحلات المحددة
                        </button>
                        <button onclick="exportDuplicateReport()" class="btn btn-info" style="flex: 1;">
                            <span>📊</span> تصدير التقرير
                        </button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // Store analysis data globally for use in other functions
            window.currentDuplicateAnalysis = duplicateAnalysis;
            window.selectedDuplicateShops = new Set();
        }
        
        // Analyze shops for duplicates
        function analyzeDuplicateShops() {
            // Configuration constants
            const SIMILARITY_THRESHOLD = 0.7; // Threshold for detecting similar shop names (0-1)
            
            const exactDuplicates = [];
            const similarShops = [];
            const sameAreaDuplicates = [];
            const shopNames = new Map();
            const shopsByArea = new Map();
            
            // Group shops by name and area
            planData.shops.forEach((shop, index) => {
                const normalizedName = shop.name.trim().toLowerCase();
                
                // Track exact duplicates
                if (!shopNames.has(normalizedName)) {
                    shopNames.set(normalizedName, []);
                }
                shopNames.get(normalizedName).push({...shop, index});
                
                // Track shops by area
                if (!shopsByArea.has(shop.areaId)) {
                    shopsByArea.set(shop.areaId, []);
                }
                shopsByArea.get(shop.areaId).push({...shop, index});
            });
            
            // Find exact duplicates
            shopNames.forEach((shops, name) => {
                if (shops.length > 1) {
                    exactDuplicates.push({
                        name: shops[0].name,
                        count: shops.length,
                        shops: shops
                    });
                }
            });
            
            // Find similar shops (using basic similarity)
            const allShops = planData.shops.map((shop, index) => ({...shop, index}));
            for (let i = 0; i < allShops.length; i++) {
                for (let j = i + 1; j < allShops.length; j++) {
                    const shop1 = allShops[i];
                    const shop2 = allShops[j];
                    const similarity = calculateSimilarity(shop1.name, shop2.name);
                    
                    if (similarity > SIMILARITY_THRESHOLD && similarity < 1.0) {
                        similarShops.push({
                            shop1: shop1,
                            shop2: shop2,
                            similarity: (similarity * 100).toFixed(0)
                        });
                    }
                }
            }
            
            // Find duplicates in same area
            shopsByArea.forEach((shops, areaId) => {
                const nameCount = new Map();
                shops.forEach(shop => {
                    const normalizedName = shop.name.trim().toLowerCase();
                    if (!nameCount.has(normalizedName)) {
                        nameCount.set(normalizedName, []);
                    }
                    nameCount.get(normalizedName).push(shop);
                });
                
                nameCount.forEach((duplicates, name) => {
                    if (duplicates.length > 1) {
                        sameAreaDuplicates.push({
                            area: duplicates[0].area,
                            areaId: areaId,
                            name: duplicates[0].name,
                            count: duplicates.length,
                            shops: duplicates
                        });
                    }
                });
            });
            
            return { exactDuplicates, similarShops, sameAreaDuplicates };
        }
        
        // Calculate string similarity (Levenshtein distance based)
        function calculateSimilarity(str1, str2) {
            const s1 = str1.toLowerCase().trim();
            const s2 = str2.toLowerCase().trim();
            
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }
        
        // Levenshtein distance algorithm
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        // Render duplicate shops list
        function renderDuplicateShops(data, type) {
            if (!data || data.length === 0) {
                return '<p style="text-align: center; color: #999; padding: 40px;">لا توجد محلات مكررة أو متشابهة</p>';
            }
            
            let html = '';
            
            if (type === 'exact') {
                data.forEach((group, groupIndex) => {
                    html += `
                        <div class="duplicate-group" data-group-index="${groupIndex}" style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-right: 4px solid #e74c3c;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0; color: #2d3561;">🔴 ${escapeHtml(group.name)}</h4>
                                <span style="background: #e74c3c; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9em;">${group.count} مكررات</span>
                            </div>
                            <div style="display: grid; gap: 10px;">
                    `;
                    
                    group.shops.forEach((shop, shopIndex) => {
                        const areaName = planData.areas.find(a => a.id === shop.areaId)?.name || 'غير محدد';
                        html += `
                            <div class="duplicate-shop-item" data-shop-id="${shop.id}" style="background: #f8f9fa; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <input type="checkbox" class="duplicate-shop-checkbox" data-shop-id="${shop.id}" onchange="toggleDuplicateShopSelection('${shop.id}')" style="margin-left: 10px;">
                                    <strong>${escapeHtml(shop.name)}</strong>
                                    <div style="color: #666; font-size: 0.9em; margin-top: 4px;">
                                        📍 ${escapeHtml(areaName)} | 🆔 ${escapeHtml(shop.id)}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="editDuplicateShop('${shop.id}')" class="btn btn-sm btn-primary" style="padding: 6px 12px;">
                                        ✏️ تعديل
                                    </button>
                                    <button onclick="deleteDuplicateShop('${shop.id}')" class="btn btn-sm btn-danger" style="padding: 6px 12px;">
                                        🗑️ حذف
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            } else if (type === 'similar') {
                data.forEach((pair, index) => {
                    const area1 = planData.areas.find(a => a.id === pair.shop1.areaId)?.name || 'غير محدد';
                    const area2 = planData.areas.find(a => a.id === pair.shop2.areaId)?.name || 'غير محدد';
                    
                    html += `
                        <div class="similar-pair" data-pair-index="${index}" style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-right: 4px solid #f39c12;">
                            <div style="margin-bottom: 10px;">
                                <span style="background: #f39c12; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9em;">تشابه ${pair.similarity}%</span>
                            </div>
                            <div style="display: grid; gap: 10px;">
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <input type="checkbox" class="duplicate-shop-checkbox" data-shop-id="${pair.shop1.id}" onchange="toggleDuplicateShopSelection('${pair.shop1.id}')" style="margin-left: 10px;">
                                        <strong>${escapeHtml(pair.shop1.name)}</strong>
                                        <div style="color: #666; font-size: 0.9em; margin-top: 4px;">📍 ${escapeHtml(area1)}</div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="editDuplicateShop('${pair.shop1.id}')" class="btn btn-sm btn-primary" style="padding: 6px 12px;">✏️ تعديل</button>
                                        <button onclick="deleteDuplicateShop('${pair.shop1.id}')" class="btn btn-sm btn-danger" style="padding: 6px 12px;">🗑️ حذف</button>
                                    </div>
                                </div>
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <input type="checkbox" class="duplicate-shop-checkbox" data-shop-id="${pair.shop2.id}" onchange="toggleDuplicateShopSelection('${pair.shop2.id}')" style="margin-left: 10px;">
                                        <strong>${escapeHtml(pair.shop2.name)}</strong>
                                        <div style="color: #666; font-size: 0.9em; margin-top: 4px;">📍 ${escapeHtml(area2)}</div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="editDuplicateShop('${pair.shop2.id}')" class="btn btn-sm btn-primary" style="padding: 6px 12px;">✏️ تعديل</button>
                                        <button onclick="deleteDuplicateShop('${pair.shop2.id}')" class="btn btn-sm btn-danger" style="padding: 6px 12px;">🗑️ حذف</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else if (type === 'sameArea') {
                data.forEach((group, groupIndex) => {
                    html += `
                        <div class="duplicate-group" data-group-index="${groupIndex}" style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-right: 4px solid #3498db;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0; color: #2d3561;">🗺️ ${escapeHtml(group.name)} - ${escapeHtml(group.area)}</h4>
                                <span style="background: #3498db; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9em;">${group.count} مكررات</span>
                            </div>
                            <div style="display: grid; gap: 10px;">
                    `;
                    
                    group.shops.forEach((shop) => {
                        html += `
                            <div class="duplicate-shop-item" data-shop-id="${shop.id}" style="background: #f8f9fa; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <input type="checkbox" class="duplicate-shop-checkbox" data-shop-id="${shop.id}" onchange="toggleDuplicateShopSelection('${shop.id}')" style="margin-left: 10px;">
                                    <strong>${escapeHtml(shop.name)}</strong>
                                    <div style="color: #666; font-size: 0.9em; margin-top: 4px;">🆔 ${escapeHtml(shop.id)}</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="editDuplicateShop('${shop.id}')" class="btn btn-sm btn-primary" style="padding: 6px 12px;">✏️ تعديل</button>
                                    <button onclick="deleteDuplicateShop('${shop.id}')" class="btn btn-sm btn-danger" style="padding: 6px 12px;">🗑️ حذف</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            } else if (type === 'all') {
                planData.shops.forEach((shop) => {
                    const areaName = planData.areas.find(a => a.id === shop.areaId)?.name || 'غير محدد';
                    html += `
                        <div class="shop-item" data-shop-id="${shop.id}" style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <input type="checkbox" class="duplicate-shop-checkbox" data-shop-id="${shop.id}" onchange="toggleDuplicateShopSelection('${shop.id}')" style="margin-left: 10px;">
                                <strong>${escapeHtml(shop.name)}</strong>
                                <div style="color: #666; font-size: 0.9em; margin-top: 4px;">
                                    📍 ${escapeHtml(areaName)} | 🆔 ${escapeHtml(shop.id)}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="editDuplicateShop('${shop.id}')" class="btn btn-sm btn-primary" style="padding: 6px 12px;">✏️ تعديل</button>
                                <button onclick="deleteDuplicateShop('${shop.id}')" class="btn btn-sm btn-danger" style="padding: 6px 12px;">🗑️ حذف</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            return html;
        }
        
        // Show duplicate tab
        window.showDuplicateTab = function(tab) {
            const content = document.getElementById('duplicateShopsContent');
            const analysis = window.currentDuplicateAnalysis;
            
            // Update tab button styles
            document.querySelectorAll('.dup-tab-btn').forEach(btn => {
                btn.style.background = '#95a5a6';
            });
            
            if (tab === 'exact') {
                document.getElementById('exactDupTab').style.background = '#e74c3c';
                content.innerHTML = renderDuplicateShops(analysis.exactDuplicates, 'exact');
            } else if (tab === 'similar') {
                document.getElementById('similarTab').style.background = '#f39c12';
                content.innerHTML = renderDuplicateShops(analysis.similarShops, 'similar');
            } else if (tab === 'sameArea') {
                document.getElementById('sameAreaTab').style.background = '#3498db';
                content.innerHTML = renderDuplicateShops(analysis.sameAreaDuplicates, 'sameArea');
            } else if (tab === 'all') {
                document.getElementById('allShopsTab').style.background = '#667eea';
                content.innerHTML = renderDuplicateShops(null, 'all');
            }
        };
        
        // Toggle duplicate shop selection
        window.toggleDuplicateShopSelection = function(shopId) {
            if (window.selectedDuplicateShops.has(shopId)) {
                window.selectedDuplicateShops.delete(shopId);
            } else {
                window.selectedDuplicateShops.add(shopId);
            }
        };
        
        // Filter duplicate shops
        window.filterDuplicateShops = function() {
            const searchTerm = document.getElementById('duplicateShopsSearch').value.toLowerCase().trim();
            const items = document.querySelectorAll('.duplicate-shop-item, .shop-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        };
        
        // Edit duplicate shop
        window.editDuplicateShop = function(shopId) {
            const shop = planData.shops.find(s => s.id === shopId);
            if (!shop) {
                alert('❌ لم يتم العثور على المحل');
                return;
            }
            
            // Store old name before updating
            const oldName = shop.name;
            const newName = prompt('✏️ تعديل اسم المحل:', oldName);
            if (!newName || newName.trim() === '') return;
            
            // Update shop name
            shop.name = newName.trim();
            
            // Update in inspections
            if (planData.inspectionData) {
                planData.inspectionData.forEach(inspection => {
                    if (inspection.shops) {
                        const index = inspection.shops.indexOf(oldName);
                        if (index > -1) {
                            inspection.shops[index] = newName.trim();
                        }
                    }
                });
            }
            
            alert('✅ تم تحديث اسم المحل. لا تنسَ حفظ التغييرات!');
            
            // Refresh the modal
            document.getElementById('duplicateShopsModal').remove();
            openDuplicateShopsManager();
        };
        
        // Delete duplicate shop
        window.deleteDuplicateShop = async function(shopId) {
            const shop = planData.shops.find(s => s.id === shopId);
            if (!shop) {
                alert('❌ لم يتم العثور على المحل');
                return;
            }
            
            if (!confirm(`⚠️ هل أنت متأكد من حذف المحل؟\n\n${shop.name}\n\n⚠️ تحذير: سيتم حذفه من جميع التفتيشات أيضاً`)) {
                return;
            }
            
            // Remove from shops array
            planData.shops = planData.shops.filter(s => s.id !== shopId);
            
            // Remove from inspections
            if (planData.inspectionData) {
                planData.inspectionData.forEach(inspection => {
                    if (inspection.shops) {
                        inspection.shops = inspection.shops.filter(s => s !== shop.name);
                    }
                });
            }
            
            try {
                await savePlanDataToGitHub(`حذف محل مكرر: ${shop.name}`);
                alert('✅ تم حذف المحل بنجاح!');
                
                // Refresh the modal
                document.getElementById('duplicateShopsModal').remove();
                openDuplicateShopsManager();
            } catch (error) {
                alert('❌ فشل الحفظ: ' + error.message);
            }
        };
        
        // Merge selected duplicates
        window.mergeSelectedDuplicates = async function() {
            if (window.selectedDuplicateShops.size < 2) {
                alert('⚠️ يرجى اختيار محلين على الأقل للدمج');
                return;
            }
            
            const selectedIds = Array.from(window.selectedDuplicateShops);
            const shops = selectedIds.map(id => planData.shops.find(s => s.id === id)).filter(s => s);
            
            if (shops.length < 2) {
                alert('❌ خطأ في البيانات المحددة');
                return;
            }
            
            // Ask for the final name
            const finalName = prompt(`🔗 دمج ${shops.length} محلات\n\nأدخل الاسم النهائي للمحل المدمج:`, shops[0].name);
            if (!finalName || finalName.trim() === '') return;
            
            // Keep the first shop and update its name
            const primaryShop = shops[0];
            primaryShop.name = finalName.trim();
            
            // Get all shop names before deletion
            const shopNamesToMerge = shops.map(s => s.name);
            
            // Remove other shops
            const idsToRemove = new Set(selectedIds.slice(1));
            planData.shops = planData.shops.filter(s => !idsToRemove.has(s.id));
            
            // Update inspections - replace all old names with the new merged name
            if (planData.inspectionData) {
                planData.inspectionData.forEach(inspection => {
                    if (inspection.shops) {
                        inspection.shops = inspection.shops.map(shopName => {
                            return shopNamesToMerge.includes(shopName) ? finalName.trim() : shopName;
                        });
                        // Remove duplicates in the same inspection
                        inspection.shops = [...new Set(inspection.shops)];
                    }
                });
            }
            
            try {
                await savePlanDataToGitHub(`دمج ${shops.length} محلات مكررة في: ${finalName.trim()}`);
                alert(`✅ تم دمج ${shops.length} محلات بنجاح!`);
                
                // Clear selection and refresh
                window.selectedDuplicateShops.clear();
                document.getElementById('duplicateShopsModal').remove();
                openDuplicateShopsManager();
            } catch (error) {
                alert('❌ فشل الحفظ: ' + error.message);
            }
        };
        
        // Delete selected duplicates
        window.deleteSelectedDuplicates = async function() {
            if (window.selectedDuplicateShops.size === 0) {
                alert('⚠️ يرجى اختيار محل واحد على الأقل للحذف');
                return;
            }
            
            const selectedIds = Array.from(window.selectedDuplicateShops);
            const shops = selectedIds.map(id => planData.shops.find(s => s.id === id)).filter(s => s);
            
            if (!confirm(`⚠️ هل أنت متأكد من حذف ${shops.length} محل؟\n\n⚠️ تحذير: سيتم حذفها من جميع التفتيشات أيضاً`)) {
                return;
            }
            
            // Get shop names for removal from inspections
            const shopNamesToRemove = shops.map(s => s.name);
            
            // Remove from shops array
            planData.shops = planData.shops.filter(s => !selectedIds.includes(s.id));
            
            // Remove from inspections
            if (planData.inspectionData) {
                planData.inspectionData.forEach(inspection => {
                    if (inspection.shops) {
                        inspection.shops = inspection.shops.filter(s => !shopNamesToRemove.includes(s));
                    }
                });
            }
            
            try {
                await savePlanDataToGitHub(`حذف ${shops.length} محلات مكررة`);
                alert(`✅ تم حذف ${shops.length} محلات بنجاح!`);
                
                // Clear selection and refresh
                window.selectedDuplicateShops.clear();
                document.getElementById('duplicateShopsModal').remove();
                openDuplicateShopsManager();
            } catch (error) {
                alert('❌ فشل الحفظ: ' + error.message);
            }
        };
        
        // Export duplicate report
        window.exportDuplicateReport = function() {
            const analysis = window.currentDuplicateAnalysis;
            
            let report = '# تقرير المحلات المكررة والمتشابهة\n\n';
            report += `تاريخ التقرير: ${new Date().toLocaleString('ar-EG')}\n\n`;
            report += `## ملخص الإحصائيات\n`;
            report += `- إجمالي المحلات: ${planData.shops.length}\n`;
            report += `- محلات مكررة تماماً: ${analysis.exactDuplicates.length}\n`;
            report += `- محلات متشابهة: ${analysis.similarShops.length}\n`;
            report += `- مكررات في نفس المنطقة: ${analysis.sameAreaDuplicates.length}\n\n`;
            
            if (analysis.exactDuplicates.length > 0) {
                report += `## المحلات المكررة تماماً\n\n`;
                analysis.exactDuplicates.forEach((group, index) => {
                    report += `### ${index + 1}. ${group.name} (${group.count} مكررات)\n`;
                    group.shops.forEach(shop => {
                        const area = planData.areas.find(a => a.id === shop.areaId)?.name || 'غير محدد';
                        report += `- ${shop.name} | المنطقة: ${area} | ID: ${shop.id}\n`;
                    });
                    report += '\n';
                });
            }
            
            if (analysis.similarShops.length > 0) {
                report += `## المحلات المتشابهة\n\n`;
                analysis.similarShops.forEach((pair, index) => {
                    const area1 = planData.areas.find(a => a.id === pair.shop1.areaId)?.name || 'غير محدد';
                    const area2 = planData.areas.find(a => a.id === pair.shop2.areaId)?.name || 'غير محدد';
                    report += `### ${index + 1}. تشابه ${pair.similarity}%\n`;
                    report += `- ${pair.shop1.name} | ${area1}\n`;
                    report += `- ${pair.shop2.name} | ${area2}\n\n`;
                });
            }
            
            // Download report
            const blob = new Blob([report], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `duplicate-shops-report-${new Date().toISOString().split('T')[0]}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('✅ تم تصدير التقرير بنجاح!');
        };
        
        // Reload Shops from Excel - REAL IMPLEMENTATION
        async function reloadShopsFromExcel() {
            if (!githubToken) {
                alert('❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            // Create file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.multiple = false;
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    // Show merge options modal
                    showExcelImportModal(file);
                } catch (error) {
                    alert('❌ خطأ في قراءة الملف: ' + error.message);
                }
            };
            
            input.click();
        }
        
        // Show Excel Import Modal with merge options
        async function showExcelImportModal(file) {
            const modal = document.createElement('div');
            modal.id = 'excelImportModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 800px; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">📥 تحميل المحلات من Excel</h2>
                        <button onclick="document.getElementById('excelImportModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 10px 0;">📋 معلومات الملف</h3>
                        <p style="margin: 0;">📄 <strong>اسم الملف:</strong> ${file.name}</p>
                        <p style="margin: 5px 0 0 0;">📊 <strong>الحجم:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">⚙️ خيارات الدمج</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="add" checked style="width: 20px; height: 20px;">
                                <div>
                                    <strong>إضافة فقط</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">إضافة المحلات الجديدة فقط وتجاهل المكرر</p>
                                </div>
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="update" style="width: 20px; height: 20px;">
                                <div>
                                    <strong>تحديث الموجود</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">تحديث بيانات المحلات الموجودة بالبيانات الجديدة</p>
                                </div>
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="replace" style="width: 20px; height: 20px;">
                                <div>
                                    <strong>استبدال كامل</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">حذف جميع المحلات الحالية واستبدالها بالبيانات الجديدة</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ffc107;">
                        <h4 style="color: #856404; margin: 0 0 10px 0;">📌 متطلبات ملف Excel</h4>
                        <ul style="margin: 0; padding-right: 20px; color: #856404;">
                            <li>يجب أن يحتوي الملف على الأعمدة التالية: اسم المحل، المنطقة، رقم الترخيص</li>
                            <li>يمكن إضافة أعمدة اختيارية: رقم التعريف ADM، العنوان، جهة الاتصال، النشاط</li>
                            <li>يجب أن تكون البيانات في الصف الثاني وما بعده (الصف الأول للعناوين)</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="processExcelImport('${file.name}')" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ✅ بدء التحميل
                        </button>
                        <button onclick="document.getElementById('excelImportModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ❌ إلغاء
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store file data for processing
            window.excelImportFile = file;
        }
        
        // Process Excel Import
        async function processExcelImport(fileName) {
            const file = window.excelImportFile;
            if (!file) {
                alert('❌ خطأ: لم يتم العثور على الملف');
                return;
            }
            
            // Get merge mode
            const mergeMode = document.querySelector('input[name="mergeMode"]:checked').value;
            
            // Close modal
            document.getElementById('excelImportModal').remove();
            
            // Show loading message
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingExcelImport';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10001;
                text-align: center;
            `;
            loadingDiv.innerHTML = `
                <h3 style="color: #2d3561; margin-bottom: 15px;">⏳ جاري معالجة الملف...</h3>
                <p style="color: #666;">يرجى الانتظار</p>
            `;
            document.body.appendChild(loadingDiv);
            
            try {
                // Read file
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get first sheet
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                
                if (!jsonData || jsonData.length === 0) {
                    throw new Error('الملف فارغ أو لا يحتوي على بيانات صالحة');
                }
                
                // Process the data
                const result = await processShopsData(jsonData, mergeMode);
                
                // Remove loading
                document.getElementById('loadingExcelImport').remove();
                
                // Show result
                alert(`✅ تم معالجة الملف بنجاح!\n\n` +
                      `📊 المحلات المعالجة: ${result.processed}\n` +
                      `➕ المحلات المضافة: ${result.added}\n` +
                      `🔄 المحلات المحدثة: ${result.updated}\n` +
                      `⏭️  المحلات المتجاهلة: ${result.skipped}\n\n` +
                      `سيتم حفظ البيانات الآن...`);
                
                // Save to GitHub
                await savePlanData();
                
                // Refresh the list
                refreshShopsList();
                
            } catch (error) {
                document.getElementById('loadingExcelImport')?.remove();
                alert('❌ خطأ في معالجة الملف: ' + error.message);
                console.error('Excel import error:', error);
            }
        }
        
        // Process shops data from Excel
        async function processShopsData(jsonData, mergeMode) {
            let processed = 0;
            let added = 0;
            let updated = 0;
            let skipped = 0;
            
            // Ensure planData.shops exists
            if (!planData.shops) {
                planData.shops = [];
            }
            
            // If replace mode, clear existing shops
            if (mergeMode === 'replace') {
                planData.shops = [];
            }
            
            // Get existing shop names for duplicate checking
            const existingShops = new Set(planData.shops.map(shop => shop.name));
            
            // Process each row
            for (const row of jsonData) {
                processed++;
                
                // Extract shop data (try different possible column names)
                const shopName = row['اسم المحل'] || row['name'] || row['shopName'] || row['الاسم'];
                const area = row['المنطقة'] || row['area'] || row['المنطقة'];
                const licenseNo = row['رقم الترخيص'] || row['license'] || row['licenseNo'] || '';
                const admCode = row['رقم التعريف'] || row['admCode'] || row['ADM'] || '';
                const address = row['العنوان'] || row['address'] || '';
                const contact = row['جهة الاتصال'] || row['contact'] || '';
                const activity = row['النشاط'] || row['activity'] || '';
                
                if (!shopName) {
                    skipped++;
                    continue;
                }
                
                // Check if shop exists
                const existingIndex = planData.shops.findIndex(s => s.name === shopName);
                const exists = existingIndex !== -1;
                
                if (exists && mergeMode === 'add') {
                    // Skip existing shops in add mode
                    skipped++;
                    continue;
                }
                
                // Create shop object
                const shopData = {
                    name: shopName,
                    area: area || 'غير محدد',
                    id: admCode || licenseNo || `SHOP${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                };
                
                // Add optional fields if available
                if (licenseNo) shopData.licenseNo = licenseNo;
                if (address) shopData.address = address;
                if (contact) shopData.contact = contact;
                if (activity) shopData.activity = activity;
                
                if (exists && mergeMode === 'update') {
                    // Update existing shop
                    planData.shops[existingIndex] = { ...planData.shops[existingIndex], ...shopData };
                    updated++;
                } else {
                    // Add new shop
                    planData.shops.push(shopData);
                    added++;
                }
            }
            
            return { processed, added, updated, skipped };
        }
        
        // Export Shops to Excel - REAL IMPLEMENTATION
        function exportShopsToExcel() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('⚠️ لا توجد محلات للتصدير');
                return;
            }
            
            try {
                // Prepare data for export
                const exportData = planData.shops.map(shop => ({
                    'اسم المحل': shop.name,
                    'المنطقة': shop.area,
                    'رقم التعريف': shop.id || '',
                    'رقم الترخيص': shop.licenseNo || '',
                    'العنوان': shop.address || '',
                    'جهة الاتصال': shop.contact || '',
                    'النشاط': shop.activity || ''
                }));
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 30 }, // اسم المحل
                    { wch: 20 }, // المنطقة
                    { wch: 15 }, // رقم التعريف
                    { wch: 15 }, // رقم الترخيص
                    { wch: 25 }, // العنوان
                    { wch: 20 }, // جهة الاتصال
                    { wch: 25 }  // النشاط
                ];
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'المحلات');
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `محلات_${timestamp}.xlsx`;
                
                // Download file
                XLSX.writeFile(wb, filename);
                
                alert(`✅ تم تصدير ${exportData.length} محل إلى ملف Excel بنجاح!\n\n` +
                      `📄 اسم الملف: ${filename}`);
                
            } catch (error) {
                alert('❌ خطأ في تصدير البيانات: ' + error.message);
                console.error('Excel export error:', error);
            }
        }
        
        // Bulk Edit Shops - FULL IMPLEMENTATION
        async function bulkEditShops() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('⚠️ لا توجد محلات للتعديل');
                return;
            }
            
            // Create modal for bulk edit
            const modal = document.createElement('div');
            modal.id = 'bulkEditModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">✏️ التعديل الجماعي للمحلات</h2>
                        <button onclick="document.getElementById('bulkEditModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <!-- Selection Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 15px 0;">📋 تحديد المحلات للتعديل</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button onclick="selectAllShopsForEdit()" style="padding: 10px 20px; border: none; border-radius: 8px; background: white; color: #667eea; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                ☑️ تحديد الكل
                            </button>
                            <button onclick="deselectAllShopsForEdit()" style="padding: 10px 20px; border: none; border-radius: 8px; background: white; color: #667eea; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                ☐ إلغاء تحديد الكل
                            </button>
                            <select id="bulkEditAreaFilter" onchange="filterShopsForBulkEdit()" style="padding: 10px; border-radius: 8px; border: none; font-family: 'Cairo', sans-serif;">
                                <option value="">جميع المناطق</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Shops Selection List -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
                        <div id="bulkEditShopsList"></div>
                    </div>
                    
                    <!-- Edit Operations -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">⚙️ عمليات التعديل</h3>
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">نقل إلى منطقة:</label>
                                <select id="bulkEditNewArea" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                                    <option value="">-- اختر منطقة --</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">إضافة بادئة للأسماء:</label>
                                <input type="text" id="bulkEditPrefix" placeholder="مثال: محل -" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">إضافة لاحقة للأسماء:</label>
                                <input type="text" id="bulkEditSuffix" placeholder="مثال: - الفرع الرئيسي" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="bulkEditSelectedCount">0</div>
                            <div style="font-size: 0.9em;">المحلات المحددة</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="applyBulkEdit()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ✅ تطبيق التعديلات
                        </button>
                        <button onclick="document.getElementById('bulkEditModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ❌ إلغاء
                        </button>
                    </div>
                    
                    <div id="bulkEditStatus" style="margin-top: 20px;"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate area filters and dropdowns
            const areaFilter = document.getElementById('bulkEditAreaFilter');
            const newAreaSelect = document.getElementById('bulkEditNewArea');
            
            if (planData.areas) {
                planData.areas.forEach(area => {
                    const filterOption = document.createElement('option');
                    filterOption.value = area.id;
                    filterOption.textContent = area.name;
                    areaFilter.appendChild(filterOption);
                    
                    const editOption = document.createElement('option');
                    editOption.value = area.id;
                    editOption.textContent = area.name;
                    newAreaSelect.appendChild(editOption);
                });
            }
            
            // Initialize shops list
            filterShopsForBulkEdit();
        }
        
        // Filter shops for bulk edit
        window.filterShopsForBulkEdit = function() {
            const filterAreaId = document.getElementById('bulkEditAreaFilter').value;
            const shopsList = document.getElementById('bulkEditShopsList');
            
            let shopsToShow = planData.shops;
            if (filterAreaId) {
                shopsToShow = shopsToShow.filter(s => s.areaId === filterAreaId);
            }
            
            shopsList.innerHTML = shopsToShow.map((shop, index) => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #e0e0e0;">
                        <input type="checkbox" id="shop_${shop.id}" value="${shop.id}" onchange="updateBulkEditCount()" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="shop_${shop.id}" style="flex: 1; cursor: pointer;">
                            <strong>${shop.name}</strong>
                            <span style="color: #666; font-size: 0.9em;"> - ${area ? area.name : 'غير محدد'}</span>
                        </label>
                    </div>
                `;
            }).join('');
            
            updateBulkEditCount();
        };
        
        // Select all shops for edit
        window.selectAllShopsForEdit = function() {
            document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateBulkEditCount();
        };
        
        // Deselect all shops for edit
        window.deselectAllShopsForEdit = function() {
            document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateBulkEditCount();
        };
        
        // Update bulk edit count
        window.updateBulkEditCount = function() {
            const count = document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]:checked').length;
            document.getElementById('bulkEditSelectedCount').textContent = count;
        };
        
        // Apply bulk edit
        window.applyBulkEdit = async function() {
            const selectedShopIds = Array.from(document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedShopIds.length === 0) {
                alert('⚠️ يرجى تحديد محل واحد على الأقل');
                return;
            }
            
            const newAreaId = document.getElementById('bulkEditNewArea').value;
            const prefix = document.getElementById('bulkEditPrefix').value.trim();
            const suffix = document.getElementById('bulkEditSuffix').value.trim();
            
            if (!newAreaId && !prefix && !suffix) {
                alert('⚠️ يرجى تحديد عملية تعديل واحدة على الأقل');
                return;
            }
            
            if (!githubToken) {
                alert('❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            if (!confirm(`🔄 هل أنت متأكد من تعديل ${selectedShopIds.length} محل؟\n\nسيتم حفظ التغييرات مباشرة في GitHub.`)) {
                return;
            }
            
            const statusDiv = document.getElementById('bulkEditStatus');
            statusDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; border: 2px solid #bee5eb;">⏳ جاري التعديل...</div>';
            
            try {
                let editedCount = 0;
                
                planData.shops.forEach(shop => {
                    if (selectedShopIds.includes(shop.id)) {
                        if (newAreaId) {
                            shop.areaId = newAreaId;
                        }
                        if (prefix) {
                            shop.name = prefix + shop.name;
                        }
                        if (suffix) {
                            shop.name = shop.name + suffix;
                        }
                        editedCount++;
                    }
                });
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; border: 2px solid #c3e6cb;">
                        ✅ تم تعديل ${editedCount} محل بنجاح!
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('bulkEditModal').remove();
                    displayShopsList();
                    alert(`✅ تم تعديل ${editedCount} محل بنجاح!`);
                }, 2000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">❌ فشل التعديل: ${error.message}</div>`;
            }
        };
        
        // Bulk Delete Shops - FULL IMPLEMENTATION
        async function bulkDeleteShops() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('⚠️ لا توجد محلات للحذف');
                return;
            }
            
            // Create modal for bulk delete
            const modal = document.createElement('div');
            modal.id = 'bulkDeleteModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">🗑️ الحذف الجماعي للمحلات</h2>
                        <button onclick="document.getElementById('bulkDeleteModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <!-- Warning -->
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 10px 0;">⚠️ تحذير هام</h3>
                        <p style="margin: 0;">عملية الحذف نهائية ولا يمكن التراجع عنها. تأكد من اختيار المحلات الصحيحة قبل التأكيد.</p>
                    </div>
                    
                    <!-- Selection Section -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                            <button onclick="selectAllShopsForDelete()" style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                ☑️ تحديد الكل
                            </button>
                            <button onclick="deselectAllShopsForDelete()" style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                ☐ إلغاء تحديد الكل
                            </button>
                            <select id="bulkDeleteAreaFilter" onchange="filterShopsForBulkDelete()" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                                <option value="">جميع المناطق</option>
                            </select>
                        </div>
                        <div id="bulkDeleteShopsList" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    
                    <!-- Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #dc3545 0%, #c0392b 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="bulkDeleteSelectedCount">0</div>
                            <div style="font-size: 0.9em;">المحلات المحددة للحذف</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="applyBulkDelete()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            🗑️ حذف نهائي
                        </button>
                        <button onclick="document.getElementById('bulkDeleteModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ❌ إلغاء
                        </button>
                    </div>
                    
                    <div id="bulkDeleteStatus" style="margin-top: 20px;"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate area filter
            const areaFilter = document.getElementById('bulkDeleteAreaFilter');
            if (planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    areaFilter.appendChild(option);
                });
            }
            
            // Initialize shops list
            filterShopsForBulkDelete();
        }
        
        // Filter shops for bulk delete
        window.filterShopsForBulkDelete = function() {
            const filterAreaId = document.getElementById('bulkDeleteAreaFilter').value;
            const shopsList = document.getElementById('bulkDeleteShopsList');
            
            let shopsToShow = planData.shops;
            if (filterAreaId) {
                shopsToShow = shopsToShow.filter(s => s.areaId === filterAreaId);
            }
            
            shopsList.innerHTML = shopsToShow.map(shop => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #e0e0e0;">
                        <input type="checkbox" id="delshop_${shop.id}" value="${shop.id}" onchange="updateBulkDeleteCount()" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="delshop_${shop.id}" style="flex: 1; cursor: pointer;">
                            <strong>${shop.name}</strong>
                            <span style="color: #666; font-size: 0.9em;"> - ${area ? area.name : 'غير محدد'}</span>
                        </label>
                    </div>
                `;
            }).join('');
            
            updateBulkDeleteCount();
        };
        
        // Select all shops for delete
        window.selectAllShopsForDelete = function() {
            document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateBulkDeleteCount();
        };
        
        // Deselect all shops for delete
        window.deselectAllShopsForDelete = function() {
            document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateBulkDeleteCount();
        };
        
        // Update bulk delete count
        window.updateBulkDeleteCount = function() {
            const count = document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]:checked').length;
            document.getElementById('bulkDeleteSelectedCount').textContent = count;
        };
        
        // Apply bulk delete
        window.applyBulkDelete = async function() {
            const selectedShopIds = Array.from(document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedShopIds.length === 0) {
                alert('⚠️ يرجى تحديد محل واحد على الأقل للحذف');
                return;
            }
            
            if (!githubToken) {
                alert('❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            if (!confirm(`⚠️ هل أنت متأكد تماماً من حذف ${selectedShopIds.length} محل نهائياً؟\n\nهذه العملية لا يمكن التراجع عنها!\n\nسيتم حفظ التغييرات مباشرة في GitHub.`)) {
                return;
            }
            
            const statusDiv = document.getElementById('bulkDeleteStatus');
            statusDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; border: 2px solid #bee5eb;">⏳ جاري الحذف...</div>';
            
            try {
                const initialCount = planData.shops.length;
                planData.shops = planData.shops.filter(shop => !selectedShopIds.includes(shop.id));
                const deletedCount = initialCount - planData.shops.length;
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; border: 2px solid #c3e6cb;">
                        ✅ تم حذف ${deletedCount} محل بنجاح!
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('bulkDeleteModal').remove();
                    displayShopsList();
                    alert(`✅ تم حذف ${deletedCount} محل بنجاح!`);
                }, 2000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">❌ فشل الحذف: ${error.message}</div>`;
            }
        };
        
        
        // Merge Shops Data - FULL IMPLEMENTATION
        async function mergeShopsData() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('⚠️ لا توجد بيانات محلات للدمج');
                return;
            }
            
            // Create modal for merge operation
            const modal = document.createElement('div');
            modal.id = 'mergeModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">🔗 دمج بيانات المحلات</h2>
                        <button onclick="document.getElementById('mergeModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <!-- Merge Options -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 15px 0;">⚙️ خيارات الدمج</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="duplicates" checked onchange="updateMergePreview()">
                                <span>دمج المحلات المكررة فقط</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="similar" onchange="updateMergePreview()">
                                <span>دمج المحلات المتشابهة</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="fromFile" onchange="updateMergePreview()">
                                <span>دمج من ملف خارجي</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- File Upload for External Merge -->
                    <div id="fileUploadSection" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">📥 استيراد ملف للدمج</h3>
                        <input type="file" id="mergeFileInput" accept=".json" onchange="loadMergeFile(this)" style="padding: 10px; border: 2px solid #667eea; border-radius: 8px; width: 100%; font-family: 'Cairo', sans-serif;">
                        <p style="color: #666; margin-top: 10px; font-size: 0.9em;">قم برفع ملف JSON يحتوي على قائمة المحلات للدمج</p>
                    </div>
                    
                    <!-- Merge Preview -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">👁️ معاينة الدمج</h3>
                        <div id="mergePreviewContent">
                            <p style="text-align: center; color: #999;">جاري تحليل البيانات...</p>
                        </div>
                    </div>
                    
                    <!-- Merge Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mergeCurrentCount">0</div>
                            <div style="font-size: 0.9em;">المحلات الحالية</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mergeDuplicatesCount">0</div>
                            <div style="font-size: 0.9em;">المكررات المكتشفة</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mergeAfterCount">0</div>
                            <div style="font-size: 0.9em;">المحلات بعد الدمج</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="performMerge()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ✅ تنفيذ الدمج
                        </button>
                        <button onclick="document.getElementById('mergeModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ❌ إلغاء
                        </button>
                    </div>
                    
                    <div id="mergeStatus" style="margin-top: 20px;"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initial preview update
            setTimeout(() => updateMergePreview(), 100);
        }
        
        // Update merge preview based on selected mode
        window.updateMergePreview = function() {
            const mode = document.querySelector('input[name="mergeMode"]:checked').value;
            const fileUploadSection = document.getElementById('fileUploadSection');
            const previewContent = document.getElementById('mergePreviewContent');
            
            // Show/hide file upload section
            fileUploadSection.style.display = mode === 'fromFile' ? 'block' : 'none';
            
            // Update stats
            document.getElementById('mergeCurrentCount').textContent = planData.shops.length;
            
            if (mode === 'duplicates') {
                findDuplicates(previewContent);
            } else if (mode === 'similar') {
                findSimilar(previewContent);
            } else if (mode === 'fromFile') {
                previewContent.innerHTML = '<p style="text-align: center; color: #999;">قم برفع ملف JSON للمعاينة</p>';
                document.getElementById('mergeDuplicatesCount').textContent = '0';
                document.getElementById('mergeAfterCount').textContent = planData.shops.length;
            }
        };
        
        // Find duplicate shops
        function findDuplicates(container) {
            const duplicates = [];
            const nameMap = {};
            
            planData.shops.forEach((shop, index) => {
                const normalizedName = shop.name.trim().toLowerCase();
                if (nameMap[normalizedName]) {
                    duplicates.push({
                        original: nameMap[normalizedName],
                        duplicate: shop,
                        index: index
                    });
                } else {
                    nameMap[normalizedName] = shop;
                }
            });
            
            document.getElementById('mergeDuplicatesCount').textContent = duplicates.length;
            document.getElementById('mergeAfterCount').textContent = planData.shops.length - duplicates.length;
            
            if (duplicates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #11998e;">
                        <div style="font-size: 3em; margin-bottom: 10px;">✅</div>
                        <p style="font-size: 1.2em; font-weight: 600;">لا توجد محلات مكررة!</p>
                        <p style="color: #666;">جميع أسماء المحلات فريدة ومنظمة.</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea; color: white; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 10px; text-align: right;">المحل الأصلي</th>
                                    <th style="padding: 10px; text-align: right;">المحل المكرر</th>
                                    <th style="padding: 10px; text-align: right;">المنطقة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${duplicates.map(dup => {
                                    const origArea = planData.areas.find(a => a.id === dup.original.areaId);
                                    const dupArea = planData.areas.find(a => a.id === dup.duplicate.areaId);
                                    return `
                                        <tr style="border-bottom: 1px solid #e0e0e0;">
                                            <td style="padding: 10px;">${dup.original.name}</td>
                                            <td style="padding: 10px; color: #dc3545;">${dup.duplicate.name}</td>
                                            <td style="padding: 10px;">${origArea ? origArea.name : 'غير محدد'} / ${dupArea ? dupArea.name : 'غير محدد'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                        💡 سيتم الاحتفاظ بالمحل الأول وحذف النسخ المكررة
                    </p>
                `;
            }
            
            // Store duplicates for later use
            window.currentDuplicates = duplicates;
        }
        
        // Find similar shops (with fuzzy matching)
        function findSimilar(container) {
            const similar = [];
            const shops = planData.shops;
            
            for (let i = 0; i < shops.length; i++) {
                for (let j = i + 1; j < shops.length; j++) {
                    const similarity = calculateSimilarity(shops[i].name, shops[j].name);
                    if (similarity > 0.7) { // 70% similarity threshold
                        similar.push({
                            shop1: shops[i],
                            shop2: shops[j],
                            similarity: similarity
                        });
                    }
                }
            }
            
            document.getElementById('mergeDuplicatesCount').textContent = similar.length;
            document.getElementById('mergeAfterCount').textContent = planData.shops.length - similar.length;
            
            if (similar.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #11998e;">
                        <div style="font-size: 3em; margin-bottom: 10px;">✅</div>
                        <p style="font-size: 1.2em; font-weight: 600;">لا توجد محلات متشابهة!</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea; color: white; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 10px; text-align: right;">المحل 1</th>
                                    <th style="padding: 10px; text-align: right;">المحل 2</th>
                                    <th style="padding: 10px; text-align: right;">نسبة التشابه</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${similar.map(sim => `
                                    <tr style="border-bottom: 1px solid #e0e0e0;">
                                        <td style="padding: 10px;">${sim.shop1.name}</td>
                                        <td style="padding: 10px;">${sim.shop2.name}</td>
                                        <td style="padding: 10px; color: #ffc107;">${Math.round(sim.similarity * 100)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            window.currentSimilar = similar;
        }
        
        // Calculate string similarity (Levenshtein distance)
        function calculateSimilarity(str1, str2) {
            const s1 = str1.toLowerCase().trim();
            const s2 = str2.toLowerCase().trim();
            
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }
        
        // Levenshtein distance algorithm
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        // Load merge file
        window.loadMergeFile = function(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileData = JSON.parse(e.target.result);
                    
                    // Validate file format
                    if (!Array.isArray(fileData) && !fileData.shops) {
                        throw new Error('صيغة الملف غير صحيحة');
                    }
                    
                    const externalShops = Array.isArray(fileData) ? fileData : fileData.shops;
                    window.externalShopsToMerge = externalShops;
                    
                    // Update preview
                    const previewContent = document.getElementById('mergePreviewContent');
                    previewContent.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #11998e;">
                            <div style="font-size: 3em; margin-bottom: 10px;">📥</div>
                            <p style="font-size: 1.2em; font-weight: 600;">تم تحميل ${externalShops.length} محل من الملف</p>
                            <p style="color: #666;">سيتم دمج هذه المحلات مع القائمة الحالية</p>
                        </div>
                    `;
                    
                    document.getElementById('mergeDuplicatesCount').textContent = externalShops.length;
                    document.getElementById('mergeAfterCount').textContent = planData.shops.length + externalShops.length;
                    
                } catch (error) {
                    alert('❌ خطأ في قراءة الملف: ' + error.message);
                }
            };
            reader.readAsText(file);
        };
        
        // Perform merge operation
        window.performMerge = async function() {
            const mode = document.querySelector('input[name="mergeMode"]:checked').value;
            const statusDiv = document.getElementById('mergeStatus');
            
            if (!githubToken) {
                statusDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">❌ يرجى تسجيل الدخول أولاً</div>';
                return;
            }
            
            if (!confirm('🔗 هل أنت متأكد من تنفيذ عملية الدمج؟\n\nسيتم حفظ التغييرات مباشرة في GitHub.')) {
                return;
            }
            
            statusDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; border: 2px solid #bee5eb;">⏳ جاري تنفيذ عملية الدمج...</div>';
            
            try {
                let mergedShops = [...planData.shops];
                let removedCount = 0;
                let addedCount = 0;
                
                if (mode === 'duplicates') {
                    // Remove duplicates
                    if (window.currentDuplicates && window.currentDuplicates.length > 0) {
                        const duplicateIndices = window.currentDuplicates.map(d => d.index);
                        mergedShops = planData.shops.filter((shop, index) => !duplicateIndices.includes(index));
                        removedCount = window.currentDuplicates.length;
                    }
                } else if (mode === 'similar') {
                    // Remove similar shops (keep first occurrence)
                    if (window.currentSimilar && window.currentSimilar.length > 0) {
                        const toRemove = new Set();
                        window.currentSimilar.forEach(sim => {
                            const idx2 = planData.shops.indexOf(sim.shop2);
                            toRemove.add(idx2);
                        });
                        mergedShops = planData.shops.filter((shop, index) => !toRemove.has(index));
                        removedCount = toRemove.size;
                    }
                } else if (mode === 'fromFile') {
                    // Merge external shops
                    if (window.externalShopsToMerge && window.externalShopsToMerge.length > 0) {
                        window.externalShopsToMerge.forEach(extShop => {
                            // Check if shop already exists
                            const exists = mergedShops.some(s => 
                                s.name.toLowerCase().trim() === extShop.name.toLowerCase().trim()
                            );
                            
                            if (!exists) {
                                mergedShops.push({
                                    id: extShop.id || 'shop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                    name: extShop.name,
                                    areaId: extShop.areaId || ''
                                });
                                addedCount++;
                            }
                        });
                    }
                }
                
                // Update plan data
                planData.shops = mergedShops;
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; border: 2px solid #c3e6cb;">
                        ✅ تم الدمج بنجاح!<br>
                        ${removedCount > 0 ? `🗑️ تم حذف ${removedCount} محل مكرر<br>` : ''}
                        ${addedCount > 0 ? `➕ تم إضافة ${addedCount} محل جديد<br>` : ''}
                        📊 إجمالي المحلات الآن: ${mergedShops.length}
                    </div>
                `;
                
                // Refresh shops list
                setTimeout(() => {
                    document.getElementById('mergeModal').remove();
                    displayShopsList();
                    alert(`✅ تم دمج البيانات بنجاح!\n\n${removedCount > 0 ? `تم حذف ${removedCount} محل مكرر\n` : ''}${addedCount > 0 ? `تم إضافة ${addedCount} محل جديد\n` : ''}إجمالي المحلات: ${mergedShops.length}`);
                }, 2000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">❌ فشل الدمج: ${error.message}</div>`;
            }
        };
        
        
        // Validate Shops Data
        function validateShopsData() {
            if (!planData || !planData.shops) {
                alert('⚠️ لا توجد بيانات محلات للتحقق منها');
                return;
            }
            
            const issues = [];
            planData.shops.forEach((shop, idx) => {
                if (!shop.name) issues.push(`محل ${idx + 1}: اسم غير محدد`);
                if (!shop.areaId) issues.push(`${shop.name}: منطقة غير محددة`);
            });
            
            if (issues.length === 0) {
                alert('✅ جميع بيانات المحلات صحيحة!\n\n' +
                      `📊 إجمالي المحلات: ${planData.shops.length}`);
            } else {
                alert(`⚠️ تم العثور على ${issues.length} مشكلة:\n\n` + 
                      issues.slice(0, 10).join('\n') +
                      (issues.length > 10 ? `\n\n... و ${issues.length - 10} مشكلة أخرى` : ''));
            }
        }
        
        // View Shops on Map - INTERACTIVE AND HEATMAP IMPLEMENTATION
        async function viewShopsOnMap() {
            // Load shops details if not already loaded
            if (!shopsDetails) {
                try {
                    // Cache-busting parameter ensures users always get latest data after updates
                    const response = await fetch('shops_details.json?v=' + new Date().getTime());
                    shopsDetails = await response.json();
                } catch (error) {
                    console.error('Error loading shops_details.json:', error);
                }
            }
            
            // Clear cached array when reloading shopsDetails
            window.cachedAllShopsArray = null;
            window.cachedUniqueAreas = null;
            
            if (!shopsDetails || Object.keys(shopsDetails).length === 0) {
                alert('⚠️ لا توجد محلات لعرضها على الخريطة');
                return;
            }
            
            // Create modal for map
            const modal = document.createElement('div');
            modal.id = 'mapModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 95%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">🗺️ الخريطة التفاعلية والحرارية للمحلات</h2>
                        <button onclick="document.getElementById('mapModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <!-- Map Controls -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <select id="mapViewMode" onchange="updateMapView()" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            <option value="interactive">📍 عرض تفاعلي</option>
                            <option value="heatmap">🔥 خريطة حرارية</option>
                            <option value="cluster">🎯 عرض مجموعات</option>
                        </select>
                        <select id="mapFilterArea" onchange="updateMapView()" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            <option value="">جميع المناطق</option>
                        </select>
                        <button onclick="toggleHeatmapIntensity()" style="padding: 10px 20px; border-radius: 8px; border: none; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                            🌡️ تبديل كثافة الحرارة
                        </button>
                        <button onclick="exportMapData()" style="padding: 10px 20px; border-radius: 8px; border: none; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                            📥 تصدير بيانات الخريطة
                        </button>
                    </div>
                    
                    <!-- Map Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mapTotalShops">0</div>
                            <div style="font-size: 0.9em;">إجمالي المحلات</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mapVisibleShops">0</div>
                            <div style="font-size: 0.9em;">المحلات المعروضة</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mapAreasCount">0</div>
                            <div style="font-size: 0.9em;">عدد المناطق</div>
                        </div>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="shopsMapContainer" style="background: #f5f5f5; border-radius: 10px; padding: 20px; min-height: 500px; position: relative;">
                        <div id="mapLegend" style="position: absolute; top: 10px; right: 10px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100;">
                            <h4 style="margin: 0 0 10px 0; color: #2d3561;">مفتاح الخريطة</h4>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 20px; background: #667eea; border-radius: 50%;"></div>
                                    <span>محل عادي</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 20px; background: #dc3545; border-radius: 50%;"></div>
                                    <span>أولوية عالية</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 20px; background: #ffc107; border-radius: 50%;"></div>
                                    <span>أولوية متوسطة</span>
                                </div>
                            </div>
                        </div>
                        <div id="mapCanvas" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 20px;">
                            <!-- Map items will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Shop Details Panel -->
                    <div id="shopDetailsPanel" style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px; display: none;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">تفاصيل المحل المحدد</h3>
                        <div id="shopDetailsContent"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate area filter with all unique areas from shopsDetails
            const areaFilter = document.getElementById('mapFilterArea');
            const uniqueAreas = new Set();
            
            // Get areas from shopsDetails
            if (shopsDetails) {
                Object.values(shopsDetails).forEach(shop => {
                    if (shop.area && shop.area !== 'غير محدد') {
                        uniqueAreas.add(shop.area);
                    }
                });
            }
            
            // Add areas from planData if available
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    uniqueAreas.add(area.name);
                });
            }
            
            // Sort and add to filter
            Array.from(uniqueAreas).sort().forEach((areaName, index) => {
                const option = document.createElement('option');
                option.value = areaName; // Use area name instead of ID for filtering
                option.textContent = areaName;
                areaFilter.appendChild(option);
            });
            
            // Initial map render
            updateMapView();
        }
        
        // Update map view based on selected mode
        window.updateMapView = function() {
            const mode = document.getElementById('mapViewMode').value;
            const filterAreaName = document.getElementById('mapFilterArea').value;
            const mapCanvas = document.getElementById('mapCanvas');
            
            // Convert shopsDetails object to array format (cache this in a global variable)
            if (!window.cachedAllShopsArray) {
                window.cachedAllShopsArray = [];
                window.cachedUniqueAreas = new Set();
                
                if (shopsDetails) {
                    // Create area lookup map for better performance
                    const areaLookup = new Map();
                    if (planData && planData.areas) {
                        planData.areas.forEach(area => {
                            areaLookup.set(area.name, area);
                        });
                    }
                    
                    Object.entries(shopsDetails).forEach(([shopName, shopData]) => {
                        const area = areaLookup.get(shopData.area);
                        const areaName = shopData.area || 'غير محدد';
                        
                        window.cachedAllShopsArray.push({
                            name: shopName,
                            areaId: area ? area.id : null,
                            areaName: areaName,
                            ...shopData
                        });
                        
                        if (areaName && areaName !== 'غير محدد') {
                            window.cachedUniqueAreas.add(areaName);
                        }
                    });
                }
            }
            
            const allShopsArray = window.cachedAllShopsArray;
            const uniqueAreas = window.cachedUniqueAreas;
            
            // Filter shops by area name
            let shopsToDisplay = allShopsArray;
            if (filterAreaName) {
                shopsToDisplay = shopsToDisplay.filter(s => s.areaName === filterAreaName);
            }
            
            // Update stats
            document.getElementById('mapTotalShops').textContent = allShopsArray.length;
            document.getElementById('mapVisibleShops').textContent = shopsToDisplay.length;
            document.getElementById('mapAreasCount').textContent = uniqueAreas.size;
            
            // Clear canvas
            mapCanvas.innerHTML = '';
            
            if (mode === 'interactive') {
                renderInteractiveMap(shopsToDisplay, mapCanvas);
            } else if (mode === 'heatmap') {
                renderHeatmap(shopsToDisplay, mapCanvas);
            } else if (mode === 'cluster') {
                renderClusterMap(shopsToDisplay, mapCanvas);
            }
        };
        
        // Render interactive map
        function renderInteractiveMap(shops, container) {
            shops.forEach((shop, index) => {
                // Use areaName directly from shop data
                const areaName = shop.areaName || shop.area || 'غير محدد';
                
                // Calculate priority color
                let color = '#667eea';
                let priorityLabel = 'عادي';
                
                // Check if shop has high priority based on last inspection
                const lastInspection = planData.inspectionData ? 
                    planData.inspectionData.filter(i => i.shops && i.shops.includes(shop.name))
                    .sort((a, b) => new Date(b.day) - new Date(a.day))[0] : null;
                
                if (lastInspection) {
                    const daysSince = Math.floor((new Date() - new Date(lastInspection.day)) / (1000 * 60 * 60 * 24));
                    if (daysSince > 30) {
                        color = '#dc3545';
                        priorityLabel = 'عالية';
                    } else if (daysSince > 14) {
                        color = '#ffc107';
                        priorityLabel = 'متوسطة';
                    }
                }
                
                const shopCard = document.createElement('div');
                shopCard.style.cssText = `
                    background: white;
                    padding: 15px;
                    border-radius: 10px;
                    border: 3px solid ${color};
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                `;
                shopCard.onmouseover = function() {
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
                };
                shopCard.onmouseout = function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                };
                shopCard.onclick = function() {
                    showShopDetails(shop, lastInspection);
                };
                
                shopCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #2d3561; font-size: 1.1em;">${shop.name}</h4>
                        <span style="background: ${color}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75em;">${priorityLabel}</span>
                    </div>
                    <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">📍 ${areaName}</div>
                    <div style="color: #999; font-size: 0.85em;">
                        ${lastInspection ? `آخر تفتيش: ${new Date(lastInspection.day).toLocaleDateString('ar-EG')}` : 'لم يتم التفتيش بعد'}
                    </div>
                `;
                
                container.appendChild(shopCard);
            });
        }
        
        // Render heatmap
        function renderHeatmap(shops, container) {
            // Group shops by area
            const areaGroups = {};
            shops.forEach(shop => {
                // Use areaName directly from shop data
                const areaName = shop.areaName || shop.area || 'غير محدد';
                if (!areaGroups[areaName]) {
                    areaGroups[areaName] = [];
                }
                areaGroups[areaName].push(shop);
            });
            
            // Find max count for heat intensity
            const maxCount = Math.max(...Object.values(areaGroups).map(g => g.length));
            
            // Render heat blocks
            Object.entries(areaGroups).forEach(([areaName, areaShops]) => {
                const intensity = areaShops.length / maxCount;
                const heatColor = getHeatColor(intensity);
                
                const heatBlock = document.createElement('div');
                heatBlock.style.cssText = `
                    background: ${heatColor};
                    padding: 20px;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                    min-height: 150px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    text-align: center;
                `;
                heatBlock.onmouseover = function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
                };
                heatBlock.onmouseout = function() {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                };
                
                heatBlock.innerHTML = `
                    <h3 style="margin: 0 0 15px 0; color: white; font-size: 1.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">${areaName}</h3>
                    <div style="font-size: 3em; font-weight: 700; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">${areaShops.length}</div>
                    <div style="color: white; font-size: 1em; margin-top: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">محل</div>
                    <div style="margin-top: 10px; color: white; font-size: 0.9em;">🔥 كثافة: ${Math.round(intensity * 100)}%</div>
                `;
                
                container.appendChild(heatBlock);
            });
        }
        
        // Render cluster map
        function renderClusterMap(shops, container) {
            // Similar to heatmap but with different visualization
            const areaGroups = {};
            shops.forEach(shop => {
                // Use areaName directly from shop data
                const areaName = shop.areaName || shop.area || 'غير محدد';
                if (!areaGroups[areaName]) {
                    areaGroups[areaName] = [];
                }
                areaGroups[areaName].push(shop);
            });
            
            Object.entries(areaGroups).forEach(([areaName, areaShops]) => {
                const clusterDiv = document.createElement('div');
                clusterDiv.style.cssText = `
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 20px;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                `;
                
                clusterDiv.innerHTML = `
                    <h3 style="margin: 0 0 15px 0; color: white;">${areaName}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 5px;">
                        ${areaShops.map((shop, idx) => `
                            <div style="width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; color: #667eea; font-weight: 700;" title="${shop.name}">
                                ${idx + 1}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(clusterDiv);
            });
        }
        
        // Get heat color based on intensity
        function getHeatColor(intensity) {
            const colors = [
                '#38ef7d',  // Low (green)
                '#11998e',  // Medium-low (teal)
                '#ffc107',  // Medium (yellow)
                '#fa709a',  // Medium-high (pink)
                '#dc3545'   // High (red)
            ];
            const index = Math.min(Math.floor(intensity * colors.length), colors.length - 1);
            return colors[index];
        }
        
        // Show shop details
        window.showShopDetails = function(shop, lastInspection) {
            const panel = document.getElementById('shopDetailsPanel');
            const content = document.getElementById('shopDetailsContent');
            const area = planData.areas.find(a => a.id === shop.areaId);
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <strong style="color: #667eea;">اسم المحل:</strong><br>
                        <span>${shop.name}</span>
                    </div>
                    <div>
                        <strong style="color: #667eea;">المنطقة:</strong><br>
                        <span>${area ? area.name : 'غير محدد'}</span>
                    </div>
                    <div>
                        <strong style="color: #667eea;">المعرف:</strong><br>
                        <span style="font-family: monospace;">${shop.id}</span>
                    </div>
                    ${lastInspection ? `
                        <div>
                            <strong style="color: #667eea;">آخر تفتيش:</strong><br>
                            <span>${new Date(lastInspection.day).toLocaleDateString('ar-EG')}</span>
                        </div>
                        <div>
                            <strong style="color: #667eea;">المفتش:</strong><br>
                            <span>${lastInspection.inspector}</span>
                        </div>
                    ` : ''}
                </div>
            `;
            
            panel.style.display = 'block';
        };
        
        // Toggle heatmap intensity
        window.toggleHeatmapIntensity = function() {
            alert('🌡️ تم تبديل كثافة الحرارة!\n\nالخريطة الحرارية تعرض الآن كثافات مختلفة حسب عدد المحلات في كل منطقة.');
            updateMapView();
        };
        
        // Export map data
        window.exportMapData = function() {
            const mode = document.getElementById('mapViewMode').value;
            const filterAreaId = document.getElementById('mapFilterArea').value;
            
            let shopsToExport = planData.shops || [];
            if (filterAreaId) {
                shopsToExport = shopsToExport.filter(s => s.areaId === filterAreaId);
            }
            
            const exportData = {
                exportDate: new Date().toISOString(),
                mode: mode,
                totalShops: shopsToExport.length,
                shops: shopsToExport.map(shop => {
                    const area = planData.areas.find(a => a.id === shop.areaId);
                    return {
                        name: shop.name,
                        area: area ? area.name : 'غير محدد',
                        id: shop.id
                    };
                })
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `map-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert(`✅ تم تصدير ${shopsToExport.length} محل من الخريطة بنجاح!`);
        };
        
        
        // ============================================
        // MERGE AREAS FUNCTIONS
        // ============================================
        
        // Open merge areas modal
        function mergeAreas() {
            if (!planData || !planData.areas || planData.areas.length < 2) {
                alert('⚠️ يجب أن يكون لديك منطقتين على الأقل للدمج');
                return;
            }
            
            // Populate target area dropdown
            const targetSelect = document.getElementById('mergeTargetArea');
            targetSelect.innerHTML = '<option value="">-- اختر المنطقة الرئيسية --</option>';
            planData.areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.name;
                targetSelect.appendChild(option);
            });
            
            // Populate source areas checkboxes
            const container = document.getElementById('mergeSourceAreasContainer');
            container.innerHTML = '';
            planData.areas.forEach(area => {
                const shopsCount = planData.shops.filter(s => s.areaId === area.id).length;
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.padding = '8px';
                label.style.cursor = 'pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${area.id}" class="merge-source-checkbox" style="margin-left: 10px;">
                    ${area.name} (${shopsCount} محل)
                `;
                container.appendChild(label);
            });
            
            document.getElementById('mergeAreasModal').style.display = 'block';
            document.getElementById('mergeAreasStatus').innerHTML = '';
        }
        
        // Close merge areas modal
        function closeMergeAreasModal() {
            document.getElementById('mergeAreasModal').style.display = 'none';
        }
        
        // Execute merge areas
        async function executeMergeAreas() {
            const targetAreaId = document.getElementById('mergeTargetArea').value;
            const checkboxes = document.querySelectorAll('.merge-source-checkbox:checked');
            const sourceAreaIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (!targetAreaId) {
                showMessage('mergeAreasStatus', 'error', '❌ يرجى اختيار المنطقة الرئيسية');
                return;
            }
            
            if (sourceAreaIds.length === 0) {
                showMessage('mergeAreasStatus', 'error', '❌ يرجى اختيار منطقة واحدة على الأقل للدمج');
                return;
            }
            
            if (sourceAreaIds.includes(targetAreaId)) {
                showMessage('mergeAreasStatus', 'error', '❌ لا يمكن دمج المنطقة في نفسها');
                return;
            }
            
            const targetArea = planData.areas.find(a => a.id === targetAreaId);
            const sourceAreas = planData.areas.filter(a => sourceAreaIds.includes(a.id));
            const sourceAreasNames = sourceAreas.map(a => a.name).join('، ');
            
            if (!confirm(`هل أنت متأكد من دمج المناطق:\n${sourceAreasNames}\n\nفي المنطقة: ${targetArea.name}؟\n\nسيتم نقل جميع المحلات وحذف المناطق المدمجة.`)) {
                return;
            }
            
            showMessage('mergeAreasStatus', 'info', '⏳ جاري دمج المناطق...');
            
            try {
                // Move all shops from source areas to target area
                let movedShopsCount = 0;
                planData.shops.forEach(shop => {
                    if (sourceAreaIds.includes(shop.areaId)) {
                        shop.areaId = targetAreaId;
                        movedShopsCount++;
                    }
                });
                
                // Update inspections data
                let updatedInspections = 0;
                if (planData.inspectionData) {
                    planData.inspectionData.forEach(inspection => {
                        const sourceArea = sourceAreas.find(a => a.name === inspection.area);
                        if (sourceArea) {
                            inspection.area = targetArea.name;
                            updatedInspections++;
                        }
                    });
                }
                
                // Remove source areas
                planData.areas = planData.areas.filter(a => !sourceAreaIds.includes(a.id));
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('mergeAreasStatus', 'success', 
                    `✅ تم دمج ${sourceAreas.length} منطقة بنجاح!\n` +
                    `• تم نقل ${movedShopsCount} محل\n` +
                    `• تم تحديث ${updatedInspections} تفتيش`);
                
                setTimeout(() => {
                    closeMergeAreasModal();
                    displayAreasList();
                    populateAreas();
                    populateShopAreaFilter();
                }, 2000);
                
            } catch (error) {
                showMessage('mergeAreasStatus', 'error', '❌ فشل دمج المناطق: ' + error.message);
            }
        }
        
        // ============================================
        // ASSIGN SHOPS TO AREAS FUNCTIONS
        // ============================================
        
        // Open assign shops modal
        function assignShopsToAreas() {
            if (!planData || !planData.areas || planData.areas.length === 0) {
                alert('⚠️ لا توجد مناطق متاحة');
                return;
            }
            
            if (!planData.shops || planData.shops.length === 0) {
                alert('⚠️ لا توجد محلات متاحة');
                return;
            }
            
            // Populate current area filter
            const currentAreaSelect = document.getElementById('assignShopsCurrentArea');
            currentAreaSelect.innerHTML = '<option value="">-- جميع المناطق --</option>';
            planData.areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.name;
                currentAreaSelect.appendChild(option);
            });
            
            // Populate target area dropdown
            const targetSelect = document.getElementById('assignShopsTargetArea');
            targetSelect.innerHTML = '<option value="">-- اختر المنطقة الجديدة --</option>';
            planData.areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.name;
                targetSelect.appendChild(option);
            });
            
            // Load shops
            loadShopsForAssignment();
            
            document.getElementById('assignShopsModal').style.display = 'block';
            document.getElementById('assignShopsStatus').innerHTML = '';
        }
        
        // Close assign shops modal
        function closeAssignShopsModal() {
            document.getElementById('assignShopsModal').style.display = 'none';
        }
        
        // Load shops for assignment
        function loadShopsForAssignment() {
            const currentAreaId = document.getElementById('assignShopsCurrentArea').value;
            const container = document.getElementById('assignShopsContainer');
            
            let shopsToShow = planData.shops;
            if (currentAreaId) {
                shopsToShow = planData.shops.filter(s => s.areaId === currentAreaId);
            }
            
            container.innerHTML = '';
            if (shopsToShow.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">لا توجد محلات في هذه المنطقة</p>';
                return;
            }
            
            // Group shops by area for better visualization
            const shopsByArea = {};
            shopsToShow.forEach(shop => {
                const areaId = shop.areaId || 'unassigned';
                if (!shopsByArea[areaId]) {
                    shopsByArea[areaId] = [];
                }
                shopsByArea[areaId].push(shop);
            });
            
            // Display shops grouped by area
            Object.keys(shopsByArea).forEach(areaId => {
                const area = planData.areas.find(a => a.id === areaId);
                const areaName = area ? area.name : 'غير محدد';
                const shopsInArea = shopsByArea[areaId];
                
                // Create area header
                const areaHeader = document.createElement('div');
                areaHeader.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; margin: 10px 0 5px 0; border-radius: 8px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;';
                areaHeader.innerHTML = `
                    <span>📍 ${areaName}</span>
                    <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 15px; font-size: 0.9em;">${shopsInArea.length} محل</span>
                `;
                container.appendChild(areaHeader);
                
                // Create area container for shops
                const areaContainer = document.createElement('div');
                areaContainer.style.cssText = 'background: #f8f9fa; padding: 10px; margin-bottom: 15px; border-radius: 8px; border-right: 4px solid #667eea;';
                
                // Add shops in this area
                shopsInArea.forEach((shop, index) => {
                    const label = document.createElement('label');
                    label.style.cssText = 'display: block; padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #e0e0e0; background: white; margin: 2px 0; border-radius: 4px; transition: all 0.3s;';
                    label.className = 'shop-assignment-label';
                    label.onmouseover = function() { this.style.background = '#e3f2fd'; };
                    label.onmouseout = function() { this.style.background = 'white'; };
                    label.innerHTML = `
                        <input type="checkbox" value="${shop.id}" class="assign-shop-checkbox" style="margin-left: 10px;">
                        <span style="font-weight: 500;">${shop.name}</span>
                    `;
                    areaContainer.appendChild(label);
                });
                
                container.appendChild(areaContainer);
            });
            
            // Add summary at the bottom
            const summary = document.createElement('div');
            summary.style.cssText = 'background: #d1ecf1; padding: 12px; border-radius: 8px; margin-top: 10px; text-align: center; color: #0c5460; font-weight: bold;';
            summary.innerHTML = `✅ إجمالي المحلات المتاحة: ${shopsToShow.length} محل`;
            container.appendChild(summary);
        }
        
        // Filter shops for assignment
        function filterShopsForAssignment() {
            const searchTerm = document.getElementById('searchShopsForAssignment').value.toLowerCase();
            const labels = document.querySelectorAll('.shop-assignment-label');
            
            labels.forEach(label => {
                const text = label.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    label.style.display = 'block';
                } else {
                    label.style.display = 'none';
                }
            });
        }
        
        // Select all shops for assignment
        function selectAllShopsForAssignment() {
            const checkboxes = document.querySelectorAll('.assign-shop-checkbox');
            checkboxes.forEach(cb => {
                if (cb.parentElement.style.display !== 'none') {
                    cb.checked = true;
                }
            });
        }
        
        // Deselect all shops for assignment
        function deselectAllShopsForAssignment() {
            const checkboxes = document.querySelectorAll('.assign-shop-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        // Execute assign shops
        async function executeAssignShops() {
            const targetAreaId = document.getElementById('assignShopsTargetArea').value;
            const checkboxes = document.querySelectorAll('.assign-shop-checkbox:checked');
            const shopIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (!targetAreaId) {
                showMessage('assignShopsStatus', 'error', '❌ يرجى اختيار المنطقة الجديدة');
                return;
            }
            
            if (shopIds.length === 0) {
                showMessage('assignShopsStatus', 'error', '❌ يرجى اختيار محل واحد على الأقل');
                return;
            }
            
            const targetArea = planData.areas.find(a => a.id === targetAreaId);
            
            if (!confirm(`هل أنت متأكد من نقل ${shopIds.length} محل إلى المنطقة: ${targetArea.name}؟`)) {
                return;
            }
            
            showMessage('assignShopsStatus', 'info', '⏳ جاري تعيين المحلات...');
            
            try {
                // Update shops area
                const updatedShops = [];
                planData.shops.forEach(shop => {
                    if (shopIds.includes(shop.id)) {
                        const oldArea = planData.areas.find(a => a.id === shop.areaId);
                        shop.areaId = targetAreaId;
                        updatedShops.push({
                            name: shop.name,
                            oldArea: oldArea ? oldArea.name : 'غير محدد',
                            newArea: targetArea.name
                        });
                    }
                });
                
                // Update inspections
                let updatedInspections = 0;
                if (planData.inspectionData) {
                    updatedShops.forEach(shopInfo => {
                        planData.inspectionData.forEach(inspection => {
                            if (inspection.shops && inspection.shops.includes(shopInfo.name)) {
                                if (inspection.area === shopInfo.oldArea) {
                                    inspection.area = shopInfo.newArea;
                                    updatedInspections++;
                                }
                            }
                        });
                    });
                }
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('assignShopsStatus', 'success', 
                    `✅ تم تعيين ${shopIds.length} محل بنجاح!\n` +
                    `• المنطقة الجديدة: ${targetArea.name}\n` +
                    `• تم تحديث ${updatedInspections} تفتيش`);
                
                setTimeout(() => {
                    closeAssignShopsModal();
                    displayShopsList();
                    displayAreasList();
                }, 2000);
                
            } catch (error) {
                showMessage('assignShopsStatus', 'error', '❌ فشل تعيين المحلات: ' + error.message);
            }
        }
        
        // Export Areas Data
        function exportAreasData() {
            if (!planData || !planData.areas) {
                alert('⚠️ لا توجد بيانات مناطق للتصدير');
                return;
            }
            
            const dataStr = JSON.stringify(planData.areas, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `areas-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert(`✅ تم تصدير ${planData.areas.length} منطقة بنجاح!`);
        }
        
        // Import Areas from File
        function importAreasFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedAreas = JSON.parse(event.target.result);
                        if (!Array.isArray(importedAreas)) {
                            alert('❌ صيغة الملف غير صحيحة. يجب أن يكون مصفوفة من المناطق.');
                            return;
                        }
                        
                        alert(`📥 تم استيراد ${importedAreas.length} منطقة!\n\nسيتم إضافة ميزة الدمج قريباً.`);
                    } catch (error) {
                        alert('❌ فشل قراءة الملف: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // ============================================
        // BULK EDIT AREAS FUNCTIONS
        // ============================================
        
        // Open bulk edit modal
        function bulkEditAreas() {
            if (!planData || !planData.areas || planData.areas.length === 0) {
                alert('⚠️ لا توجد مناطق متاحة');
                return;
            }
            
            // Populate areas checkboxes
            const container = document.getElementById('bulkEditAreasContainer');
            container.innerHTML = '';
            planData.areas.forEach(area => {
                const shopsCount = planData.shops.filter(s => s.areaId === area.id).length;
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.padding = '8px';
                label.style.cursor = 'pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${area.id}" class="bulk-edit-checkbox" style="margin-left: 10px;">
                    ${area.name} (${shopsCount} محل)
                `;
                container.appendChild(label);
            });
            
            document.getElementById('bulkEditModal').style.display = 'block';
            document.getElementById('bulkEditStatus').innerHTML = '';
            document.getElementById('bulkEditPreview').style.display = 'none';
        }
        
        // Close bulk edit modal
        function closeBulkEditModal() {
            document.getElementById('bulkEditModal').style.display = 'none';
        }
        
        // Toggle bulk edit options
        function toggleBulkEditOptions() {
            const editType = document.getElementById('bulkEditType').value;
            const prefixSuffixDiv = document.getElementById('bulkEditPrefixSuffix');
            const replaceDiv = document.getElementById('bulkEditReplace');
            
            if (editType === 'replace') {
                prefixSuffixDiv.style.display = 'none';
                replaceDiv.style.display = 'block';
            } else {
                prefixSuffixDiv.style.display = 'block';
                replaceDiv.style.display = 'none';
            }
        }
        
        // Select all areas for bulk edit
        function selectAllAreasForBulkEdit() {
            const checkboxes = document.querySelectorAll('.bulk-edit-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
        }
        
        // Deselect all areas for bulk edit
        function deselectAllAreasForBulkEdit() {
            const checkboxes = document.querySelectorAll('.bulk-edit-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        // Preview bulk edit
        function previewBulkEdit() {
            const checkboxes = document.querySelectorAll('.bulk-edit-checkbox:checked');
            const areaIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (areaIds.length === 0) {
                showMessage('bulkEditStatus', 'error', '❌ يرجى اختيار منطقة واحدة على الأقل');
                return;
            }
            
            const editType = document.getElementById('bulkEditType').value;
            const changes = [];
            
            if (editType === 'prefix') {
                const prefix = document.getElementById('bulkEditText').value.trim();
                if (!prefix) {
                    showMessage('bulkEditStatus', 'error', '❌ يرجى إدخال البادئة');
                    return;
                }
                
                areaIds.forEach(areaId => {
                    const area = planData.areas.find(a => a.id === areaId);
                    if (area) {
                        changes.push({
                            old: area.name,
                            new: prefix + ' ' + area.name
                        });
                    }
                });
            } else if (editType === 'suffix') {
                const suffix = document.getElementById('bulkEditText').value.trim();
                if (!suffix) {
                    showMessage('bulkEditStatus', 'error', '❌ يرجى إدخال اللاحقة');
                    return;
                }
                
                areaIds.forEach(areaId => {
                    const area = planData.areas.find(a => a.id === areaId);
                    if (area) {
                        changes.push({
                            old: area.name,
                            new: area.name + ' ' + suffix
                        });
                    }
                });
            } else if (editType === 'replace') {
                const findText = document.getElementById('bulkEditFindText').value.trim();
                const replaceText = document.getElementById('bulkEditReplaceText').value.trim();
                
                if (!findText) {
                    showMessage('bulkEditStatus', 'error', '❌ يرجى إدخال النص المراد استبداله');
                    return;
                }
                
                areaIds.forEach(areaId => {
                    const area = planData.areas.find(a => a.id === areaId);
                    if (area && area.name.includes(findText)) {
                        changes.push({
                            old: area.name,
                            new: area.name.replace(new RegExp(findText, 'g'), replaceText)
                        });
                    }
                });
            }
            
            if (changes.length === 0) {
                showMessage('bulkEditStatus', 'warning', '⚠️ لا توجد تغييرات لتطبيقها');
                return;
            }
            
            // Display preview
            const previewDiv = document.getElementById('bulkEditPreview');
            const previewContent = document.getElementById('bulkEditPreviewContent');
            previewContent.innerHTML = '';
            
            changes.forEach(change => {
                const changeDiv = document.createElement('div');
                changeDiv.style.padding = '10px';
                changeDiv.style.borderBottom = '1px solid #e0e0e0';
                changeDiv.innerHTML = `
                    <div style="color: #dc3545;">القديم: ${change.old}</div>
                    <div style="color: #28a745;">الجديد: ${change.new}</div>
                `;
                previewContent.appendChild(changeDiv);
            });
            
            previewDiv.style.display = 'block';
            showMessage('bulkEditStatus', 'success', `✅ معاينة ${changes.length} تغيير`);
        }
        
        // Execute bulk edit
        async function executeBulkEdit() {
            const checkboxes = document.querySelectorAll('.bulk-edit-checkbox:checked');
            const areaIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (areaIds.length === 0) {
                showMessage('bulkEditStatus', 'error', '❌ يرجى اختيار منطقة واحدة على الأقل');
                return;
            }
            
            const editType = document.getElementById('bulkEditType').value;
            
            if (!confirm(`هل أنت متأكد من تطبيق التعديلات على ${areaIds.length} منطقة؟`)) {
                return;
            }
            
            showMessage('bulkEditStatus', 'info', '⏳ جاري تطبيق التعديلات...');
            
            try {
                let changesCount = 0;
                const updates = [];
                
                if (editType === 'prefix') {
                    const prefix = document.getElementById('bulkEditText').value.trim();
                    if (!prefix) {
                        showMessage('bulkEditStatus', 'error', '❌ يرجى إدخال البادئة');
                        return;
                    }
                    
                    areaIds.forEach(areaId => {
                        const area = planData.areas.find(a => a.id === areaId);
                        if (area) {
                            const oldName = area.name;
                            area.name = prefix + ' ' + area.name;
                            updates.push({ oldName, newName: area.name });
                            changesCount++;
                        }
                    });
                } else if (editType === 'suffix') {
                    const suffix = document.getElementById('bulkEditText').value.trim();
                    if (!suffix) {
                        showMessage('bulkEditStatus', 'error', '❌ يرجى إدخال اللاحقة');
                        return;
                    }
                    
                    areaIds.forEach(areaId => {
                        const area = planData.areas.find(a => a.id === areaId);
                        if (area) {
                            const oldName = area.name;
                            area.name = area.name + ' ' + suffix;
                            updates.push({ oldName, newName: area.name });
                            changesCount++;
                        }
                    });
                } else if (editType === 'replace') {
                    const findText = document.getElementById('bulkEditFindText').value.trim();
                    const replaceText = document.getElementById('bulkEditReplaceText').value.trim();
                    
                    if (!findText) {
                        showMessage('bulkEditStatus', 'error', '❌ يرجى إدخال النص المراد استبداله');
                        return;
                    }
                    
                    areaIds.forEach(areaId => {
                        const area = planData.areas.find(a => a.id === areaId);
                        if (area && area.name.includes(findText)) {
                            const oldName = area.name;
                            area.name = area.name.replace(new RegExp(findText, 'g'), replaceText);
                            updates.push({ oldName, newName: area.name });
                            changesCount++;
                        }
                    });
                }
                
                // Update inspections to match new area names
                let updatedInspections = 0;
                if (planData.inspectionData) {
                    updates.forEach(update => {
                        planData.inspectionData.forEach(inspection => {
                            if (inspection.area === update.oldName) {
                                inspection.area = update.newName;
                                updatedInspections++;
                            }
                        });
                    });
                }
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('bulkEditStatus', 'success', 
                    `✅ تم تطبيق ${changesCount} تعديل بنجاح!\n` +
                    `• تم تحديث ${updatedInspections} تفتيش`);
                
                setTimeout(() => {
                    closeBulkEditModal();
                    displayAreasList();
                    populateAreas();
                }, 2000);
                
            } catch (error) {
                showMessage('bulkEditStatus', 'error', '❌ فشل تطبيق التعديلات: ' + error.message);
            }
        }
        
        // Generate Areas Report
        function generateAreasReport() {
            if (!planData || !planData.areas || !planData.shops) {
                alert('⚠️ لا توجد بيانات كافية للتقرير');
                return;
            }
            
            let report = '📊 تقرير المناطق\n';
            report += '=' .repeat(50) + '\n\n';
            
            planData.areas.forEach(area => {
                const shopsInArea = planData.shops.filter(s => s.areaId === area.id).length;
                const inspectionsInArea = planData.inspectionData.filter(i => i.area === area.name).length;
                
                report += `🗺️ ${area.name}\n`;
                report += `   • المحلات: ${shopsInArea}\n`;
                report += `   • التفتيشات: ${inspectionsInArea}\n\n`;
            });
            
            const dataBlob = new Blob([report], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `areas-report-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('✅ تم إنشاء تقرير المناطق!');
        }
        
        // ==================== Smart Shop List Functions ====================
        
        /**
         * Calculate shop rating based on multiple criteria
         * Rating criteria:
         * 1. Compliance (الالتزام) - 30 points
         * 2. Last inspection date (آخر تفتيش) - 25 points
         * 3. Inspection frequency (تكرار التفتيش) - 20 points
         * 4. Data completeness (اكتمال البيانات) - 15 points
         * 5. Activity type priority (أولوية النشاط) - 10 points
         */
        function calculateShopRating(shopName) {
            let rating = 0;
            let details = {
                compliance: 0,
                lastInspection: 0,
                frequency: 0,
                dataCompleteness: 0,
                activityPriority: 0
            };
            
            // Get shop details
            const shopDetails = shopsDetails ? shopsDetails[shopName] : null;
            
            // 1. Data Completeness (15 points)
            if (shopDetails) {
                let completeness = 0;
                if (shopDetails.nameAr) completeness += 2;
                if (shopDetails.nameEn) completeness += 2;
                if (shopDetails.licenseNo) completeness += 3;
                if (shopDetails.admCode) completeness += 2;
                if (shopDetails.address) completeness += 2;
                if (shopDetails.contact) completeness += 2;
                if (shopDetails.activity) completeness += 2;
                details.dataCompleteness = completeness;
                rating += completeness;
            }
            
            // 2. Activity Type Priority (10 points)
            if (shopDetails && shopDetails.activity) {
                const activity = shopDetails.activity.toLowerCase();
                // High priority activities
                if (activity.includes('animal') || activity.includes('حيوان') || 
                    activity.includes('veterinar') || activity.includes('بيطر')) {
                    details.activityPriority = 10;
                    rating += 10;
                } else if (activity.includes('pet') || activity.includes('أليف')) {
                    details.activityPriority = 8;
                    rating += 8;
                } else if (activity.includes('bird') || activity.includes('طيور')) {
                    details.activityPriority = 7;
                    rating += 7;
                } else {
                    details.activityPriority = 5;
                    rating += 5;
                }
            }
            
            // 3. Last Inspection Date (25 points)
            const lastInspection = getLastInspectionForShop(shopName);
            if (lastInspection) {
                const daysSince = Math.floor((new Date() - new Date(lastInspection.day)) / (1000 * 60 * 60 * 24));
                if (daysSince <= 7) {
                    details.lastInspection = 25;
                    rating += 25;
                } else if (daysSince <= 14) {
                    details.lastInspection = 20;
                    rating += 20;
                } else if (daysSince <= 30) {
                    details.lastInspection = 15;
                    rating += 15;
                } else if (daysSince <= 60) {
                    details.lastInspection = 10;
                    rating += 10;
                } else {
                    details.lastInspection = 5;
                    rating += 5;
                }
            }
            
            // 4. Inspection Frequency (20 points)
            const inspectionCount = getInspectionCountForShop(shopName);
            if (inspectionCount >= 10) {
                details.frequency = 20;
                rating += 20;
            } else if (inspectionCount >= 7) {
                details.frequency = 16;
                rating += 16;
            } else if (inspectionCount >= 5) {
                details.frequency = 12;
                rating += 12;
            } else if (inspectionCount >= 3) {
                details.frequency = 8;
                rating += 8;
            } else if (inspectionCount >= 1) {
                details.frequency = 4;
                rating += 4;
            }
            
            // 5. Compliance Score (30 points) - Based on consistent inspections
            // Good compliance = regular inspections without long gaps
            if (inspectionCount > 0) {
                const inspections = getInspectionsForShop(shopName);
                if (inspections.length >= 2) {
                    // Calculate consistency
                    const dates = inspections.map(i => new Date(i.day)).sort((a, b) => b - a);
                    const gaps = [];
                    for (let i = 0; i < dates.length - 1; i++) {
                        gaps.push(Math.floor((dates[i] - dates[i + 1]) / (1000 * 60 * 60 * 24)));
                    }
                    const avgGap = gaps.reduce((a, b) => a + b, 0) / gaps.length;
                    
                    if (avgGap <= 14) {
                        details.compliance = 30;
                        rating += 30;
                    } else if (avgGap <= 21) {
                        details.compliance = 25;
                        rating += 25;
                    } else if (avgGap <= 30) {
                        details.compliance = 20;
                        rating += 20;
                    } else {
                        details.compliance = 15;
                        rating += 15;
                    }
                } else if (inspectionCount === 1) {
                    details.compliance = 10;
                    rating += 10;
                }
            }
            
            return { rating, details };
        }
        
        function getLastInspectionForShop(shopName) {
            if (!planData || !planData.inspectionData) return null;
            
            const inspections = planData.inspectionData
                .filter(i => i.shops && i.shops.includes(shopName))
                .sort((a, b) => new Date(b.day) - new Date(a.day));
            
            return inspections.length > 0 ? inspections[0] : null;
        }
        
        function getInspectionCountForShop(shopName) {
            if (!planData || !planData.inspectionData) return 0;
            
            return planData.inspectionData.filter(i => i.shops && i.shops.includes(shopName)).length;
        }
        
        function getInspectionsForShop(shopName) {
            if (!planData || !planData.inspectionData) return [];
            
            return planData.inspectionData.filter(i => i.shops && i.shops.includes(shopName));
        }
        
        // Open Smart Shop List Modal
        async function openSmartShopListModal() {
            // Load shops details if not loaded
            if (!shopsDetails) {
                try {
                    const response = await fetch('shops_details.json?' + new Date().getTime());
                    if (response.ok) {
                        shopsDetails = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading shops_details.json:', error);
                }
            }
            
            // Populate area filter
            const areaFilter = document.getElementById('smartListAreaFilter');
            areaFilter.innerHTML = '<option value="">جميع المناطق</option>';
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    areaFilter.appendChild(option);
                });
            }
            
            // Show modal
            document.getElementById('smartShopListModal').style.display = 'block';
            
            // Generate initial list
            updateSmartShopList();
        }
        
        // Close Smart Shop List Modal
        function closeSmartShopListModal() {
            document.getElementById('smartShopListModal').style.display = 'none';
        }
        
        // Update Smart Shop List based on filters
        // Calculate smart priority score for a shop
        // Higher score = higher priority (needs attention)
        function calculateSmartPriorityScore(shop) {
            let score = 0;
            
            // 1. Rating factor (0-40 points) - Lower rating = higher priority
            // Invert the rating: 0% rating gets 40 points, 100% rating gets 0 points
            score += (100 - shop.rating) * 0.4;
            
            // 2. Last inspection factor (0-40 points) - Older inspection = higher priority
            if (shop.lastInspection) {
                const daysSinceInspection = (new Date() - new Date(shop.lastInspection.day)) / (1000 * 60 * 60 * 24);
                // More than 60 days = max 40 points, recent inspection = fewer points
                score += Math.min(daysSinceInspection / 60 * 40, 40);
            } else {
                // Never inspected = maximum priority
                score += 40;
            }
            
            // 3. Inspection count factor (0-20 points) - Fewer inspections = higher priority
            // 0 inspections = 20 points, 10+ inspections = 0 points
            const inspectionBonus = Math.max(20 - (shop.inspectionCount * 2), 0);
            score += inspectionBonus;
            
            return score;
        }
        
        function updateSmartShopList() {
            const primarySort = document.getElementById('primarySort').value;
            const areaFilter = document.getElementById('smartListAreaFilter').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            const tableView = document.getElementById('tableView').value;
            
            // Collect all shops
            let allShops = [];
            
            if (shopsDetails) {
                Object.entries(shopsDetails).forEach(([shopName, shopInfo]) => {
                    const area = planData?.areas?.find(a => a.name === shopInfo.address || a.id === shopInfo.areaId);
                    const ratingData = calculateShopRating(shopName);
                    
                    allShops.push({
                        name: shopInfo.nameAr || shopName,
                        nameEn: shopInfo.nameEn || '',
                        licenseNo: shopInfo.licenseNo || '',
                        admCode: shopInfo.admCode || '',
                        address: shopInfo.address || '',
                        contact: shopInfo.contact || '',
                        activity: shopInfo.activity || '',
                        area: area ? area.name : shopInfo.address || 'غير محدد',
                        areaId: area ? area.id : '',
                        rating: ratingData.rating,
                        ratingDetails: ratingData.details,
                        lastInspection: getLastInspectionForShop(shopName),
                        inspectionCount: getInspectionCountForShop(shopName)
                    });
                });
            }
            
            // Apply filters
            if (areaFilter) {
                const selectedArea = planData?.areas?.find(a => a.id === areaFilter);
                if (selectedArea) {
                    allShops = allShops.filter(s => s.area === selectedArea.name || s.areaId === areaFilter);
                }
            }
            
            if (ratingFilter) {
                allShops = allShops.filter(shop => {
                    if (ratingFilter === 'excellent') return shop.rating >= 90;
                    if (ratingFilter === 'good') return shop.rating >= 70 && shop.rating < 90;
                    if (ratingFilter === 'fair') return shop.rating >= 50 && shop.rating < 70;
                    if (ratingFilter === 'poor') return shop.rating < 50;
                    return true;
                });
            }
            
            // Apply sorting
            if (primarySort === 'smartPriority') {
                // Smart priority sorting: combines rating, last inspection date, and inspection count
                allShops.sort((a, b) => {
                    // Calculate priority score (0-100, higher is more priority)
                    const scoreA = calculateSmartPriorityScore(a);
                    const scoreB = calculateSmartPriorityScore(b);
                    return scoreB - scoreA; // Higher priority first
                });
            } else if (primarySort === 'areaProximity') {
                // Area proximity sorting: groups by area and sorts by rating within each area
                allShops.sort((a, b) => {
                    // First sort by area
                    const areaCompare = a.area.localeCompare(b.area, 'ar');
                    if (areaCompare !== 0) return areaCompare;
                    // Then by rating within the same area (higher first)
                    return b.rating - a.rating;
                });
            } else if (primarySort === 'rating') {
                allShops.sort((a, b) => b.rating - a.rating);
            } else if (primarySort === 'area') {
                allShops.sort((a, b) => a.area.localeCompare(b.area, 'ar'));
            } else if (primarySort === 'activity') {
                allShops.sort((a, b) => (a.activity || '').localeCompare(b.activity || '', 'ar'));
            } else if (primarySort === 'alphabetical') {
                allShops.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            } else if (primarySort === 'lastInspection') {
                allShops.sort((a, b) => {
                    const dateA = a.lastInspection ? new Date(a.lastInspection.day) : new Date(0);
                    const dateB = b.lastInspection ? new Date(b.lastInspection.day) : new Date(0);
                    return dateB - dateA;
                });
            }
            
            // Update statistics
            const totalShops = allShops.length;
            const avgRating = totalShops > 0 ? (allShops.reduce((sum, s) => sum + s.rating, 0) / totalShops).toFixed(1) : 0;
            const uniqueAreas = new Set(allShops.map(s => s.area)).size;
            const highPriority = allShops.filter(s => s.rating >= 70).length;
            
            document.getElementById('smartListTotalShops').textContent = totalShops;
            document.getElementById('smartListAvgRating').textContent = avgRating;
            document.getElementById('smartListAreas').textContent = uniqueAreas;
            document.getElementById('smartListHighPriority').textContent = highPriority;
            
            // Update selected shops counter
            const selectedCounter = document.getElementById('selectedShopsCounter');
            const selectedCount = document.getElementById('smartListSelectedCount');
            if (selectedShopsForBatch.size > 0) {
                selectedCounter.style.display = 'block';
                selectedCount.textContent = selectedShopsForBatch.size;
            } else {
                selectedCounter.style.display = 'none';
            }
            
            // Generate tables based on view mode
            const content = document.getElementById('smartShopListContent');
            
            if (tableView === 'unified') {
                content.innerHTML = generateUnifiedTable(allShops);
            } else if (tableView === 'byArea') {
                content.innerHTML = generateTablesByArea(allShops);
            } else if (tableView === 'byActivity') {
                content.innerHTML = generateTablesByActivity(allShops);
            }
        }
        
        // Generate unified table
        function generateUnifiedTable(shops) {
            if (shops.length === 0) {
                return '<p style="text-align: center; padding: 40px; color: #999;">لا توجد محلات مطابقة للفلاتر المحددة</p>';
            }
            
            let html = '<div style="overflow-x: auto;">';
            html += '<table class="inspections-table" style="width: 100%;">';
            html += '<thead><tr>';
            html += '<th style="width: 50px;">☑️</th>';
            html += '<th>#</th>';
            html += '<th>اسم المحل</th>';
            html += '<th>المنطقة</th>';
            html += '<th>النشاط</th>';
            html += '<th>التقييم</th>';
            html += '<th>آخر تفتيش</th>';
            html += '<th>عدد التفتيشات</th>';
            html += '<th>الإجراءات</th>';
            html += '</tr></thead><tbody>';
            
            shops.forEach((shop, idx) => {
                const ratingClass = shop.rating >= 90 ? 'excellent' : 
                                   shop.rating >= 70 ? 'good' : 
                                   shop.rating >= 50 ? 'fair' : 'poor';
                const ratingColor = shop.rating >= 90 ? '#27ae60' : 
                                   shop.rating >= 70 ? '#3498db' : 
                                   shop.rating >= 50 ? '#f39c12' : '#e74c3c';
                
                const lastInspectionText = shop.lastInspection ? 
                    new Date(shop.lastInspection.day).toLocaleDateString('ar-EG') : 'لم يتم';
                
                const activityShort = shop.activity ? 
                    (shop.activity.length > 50 ? shop.activity.substring(0, 50) + '...' : shop.activity) : 
                    'غير محدد';
                
                const isSelected = selectedShopsForBatch.has(shop.name);
                const checkboxStyle = isSelected ? 'background: #28a745; color: white;' : 'background: white; color: #666;';
                
                html += `<tr style="${isSelected ? 'background: #e8f5e9;' : ''}">`;
                html += `<td style="text-align: center;">
                    <input type="checkbox" 
                           ${isSelected ? 'checked' : ''} 
                           onchange="toggleShopSelection('${escapeJs(shop.name)}')"
                           style="width: 20px; height: 20px; cursor: pointer;">
                </td>`;
                html += `<td>${idx + 1}</td>`;
                html += `<td><strong>${escapeHtml(shop.name)}</strong><br><small style="color: #999;">${escapeHtml(shop.nameEn || '')}</small></td>`;
                html += `<td>${escapeHtml(shop.area)}</td>`;
                html += `<td title="${escapeHtml(shop.activity || '')}">${escapeHtml(activityShort)}</td>`;
                html += `<td><div style="background: ${ratingColor}; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; text-align: center;">${shop.rating.toFixed(0)}</div></td>`;
                html += `<td>${lastInspectionText}</td>`;
                html += `<td style="text-align: center;">${shop.inspectionCount}</td>`;
                html += `<td>
                    <button onclick="showShopRatingDetails('${escapeJs(shop.name)}')" class="btn btn-sm btn-info" style="padding: 5px 10px; margin: 2px;" title="عرض التفاصيل">👁️</button>
                    <button onclick="editShopFromSmartList('${escapeJs(shop.name)}')" class="btn btn-sm btn-warning" style="padding: 5px 10px; margin: 2px;" title="تعديل">✏️</button>
                    <button onclick="deleteShopFromSmartList('${escapeJs(shop.name)}')" class="btn btn-sm btn-danger" style="padding: 5px 10px; margin: 2px;" title="حذف">🗑️</button>
                </td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        // Generate tables by area
        function generateTablesByArea(shops) {
            if (shops.length === 0) {
                return '<p style="text-align: center; padding: 40px; color: #999;">لا توجد محلات مطابقة للفلاتر المحددة</p>';
            }
            
            // Group shops by area
            const shopsByArea = {};
            shops.forEach(shop => {
                if (!shopsByArea[shop.area]) {
                    shopsByArea[shop.area] = [];
                }
                shopsByArea[shop.area].push(shop);
            });
            
            let html = '';
            Object.keys(shopsByArea).sort((a, b) => a.localeCompare(b, 'ar')).forEach(area => {
                const areaShops = shopsByArea[area];
                const avgRating = (areaShops.reduce((sum, s) => sum + s.rating, 0) / areaShops.length).toFixed(1);
                
                html += `<div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">`;
                html += `<h3 style="color: #667eea; margin-bottom: 15px;">🗺️ ${escapeHtml(area)} <span style="color: #999; font-size: 0.8em;">(${areaShops.length} محل - متوسط التقييم: ${avgRating})</span></h3>`;
                html += generateUnifiedTable(areaShops);
                html += '</div>';
            });
            
            return html;
        }
        
        // Generate tables by activity
        function generateTablesByActivity(shops) {
            if (shops.length === 0) {
                return '<p style="text-align: center; padding: 40px; color: #999;">لا توجد محلات مطابقة للفلاتر المحددة</p>';
            }
            
            // Group shops by main activity type
            const shopsByActivity = {};
            shops.forEach(shop => {
                let activityType = 'أخرى';
                const activity = (shop.activity || '').toLowerCase();
                
                if (activity.includes('animal') || activity.includes('حيوان')) {
                    activityType = 'تجارة الحيوانات';
                } else if (activity.includes('veterinar') || activity.includes('بيطر')) {
                    activityType = 'خدمات بيطرية';
                } else if (activity.includes('bird') || activity.includes('طيور')) {
                    activityType = 'تجارة الطيور';
                } else if (activity.includes('pet') || activity.includes('أليف')) {
                    activityType = 'حيوانات أليفة';
                } else if (activity.includes('fish') || activity.includes('أسماك')) {
                    activityType = 'أسماك الزينة';
                }
                
                if (!shopsByActivity[activityType]) {
                    shopsByActivity[activityType] = [];
                }
                shopsByActivity[activityType].push(shop);
            });
            
            let html = '';
            Object.keys(shopsByActivity).sort((a, b) => a.localeCompare(b, 'ar')).forEach(activityType => {
                const activityShops = shopsByActivity[activityType];
                const avgRating = (activityShops.reduce((sum, s) => sum + s.rating, 0) / activityShops.length).toFixed(1);
                
                html += `<div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">`;
                html += `<h3 style="color: #667eea; margin-bottom: 15px;">💼 ${escapeHtml(activityType)} <span style="color: #999; font-size: 0.8em;">(${activityShops.length} محل - متوسط التقييم: ${avgRating})</span></h3>`;
                html += generateUnifiedTable(activityShops);
                html += '</div>';
            });
            
            return html;
        }
        
        // Show shop rating details
        function showShopRatingDetails(shopName) {
            const ratingData = calculateShopRating(shopName);
            const shop = shopsDetails[shopName];
            
            let details = `📊 تفاصيل التقييم: ${shopName}\n`;
            details += `${'='.repeat(50)}\n\n`;
            details += `📈 التقييم الإجمالي: ${ratingData.rating.toFixed(0)}/100\n\n`;
            details += `تفاصيل المحاور:\n`;
            details += `• الالتزام: ${ratingData.details.compliance}/30\n`;
            details += `• آخر تفتيش: ${ratingData.details.lastInspection}/25\n`;
            details += `• تكرار التفتيش: ${ratingData.details.frequency}/20\n`;
            details += `• اكتمال البيانات: ${ratingData.details.dataCompleteness}/15\n`;
            details += `• أولوية النشاط: ${ratingData.details.activityPriority}/10\n\n`;
            
            const lastInspection = getLastInspectionForShop(shopName);
            if (lastInspection) {
                const daysSince = Math.floor((new Date() - new Date(lastInspection.day)) / (1000 * 60 * 60 * 24));
                details += `📅 آخر تفتيش: ${new Date(lastInspection.day).toLocaleDateString('ar-EG')} (منذ ${daysSince} يوم)\n`;
            } else {
                details += `📅 آخر تفتيش: لم يتم التفتيش بعد\n`;
            }
            
            details += `🔢 عدد التفتيشات الكلية: ${getInspectionCountForShop(shopName)}\n`;
            
            if (shop) {
                details += `\n📍 معلومات المحل:\n`;
                if (shop.licenseNo) details += `• رقم الرخصة: ${shop.licenseNo}\n`;
                if (shop.admCode) details += `• كود ADM: ${shop.admCode}\n`;
                if (shop.address) details += `• العنوان: ${shop.address}\n`;
                if (shop.contact) details += `• الهاتف: ${shop.contact}\n`;
            }
            
            alert(details);
        }
        
        // Export Smart Shop List
        function exportSmartShopList(format) {
            const primarySort = document.getElementById('primarySort').value;
            const areaFilter = document.getElementById('smartListAreaFilter').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            
            // Get current filtered shops
            let allShops = [];
            
            if (shopsDetails) {
                Object.entries(shopsDetails).forEach(([shopName, shopInfo]) => {
                    const area = planData?.areas?.find(a => a.name === shopInfo.address || a.id === shopInfo.areaId);
                    const ratingData = calculateShopRating(shopName);
                    
                    allShops.push({
                        name: shopInfo.nameAr || shopName,
                        nameEn: shopInfo.nameEn || '',
                        licenseNo: shopInfo.licenseNo || '',
                        admCode: shopInfo.admCode || '',
                        address: shopInfo.address || '',
                        contact: shopInfo.contact || '',
                        activity: shopInfo.activity || '',
                        area: area ? area.name : shopInfo.address || 'غير محدد',
                        rating: ratingData.rating,
                        lastInspection: getLastInspectionForShop(shopName),
                        inspectionCount: getInspectionCountForShop(shopName)
                    });
                });
            }
            
            // Apply same filters
            if (areaFilter) {
                const selectedArea = planData?.areas?.find(a => a.id === areaFilter);
                if (selectedArea) {
                    allShops = allShops.filter(s => s.area === selectedArea.name);
                }
            }
            
            if (ratingFilter) {
                allShops = allShops.filter(shop => {
                    if (ratingFilter === 'excellent') return shop.rating >= 90;
                    if (ratingFilter === 'good') return shop.rating >= 70 && shop.rating < 90;
                    if (ratingFilter === 'fair') return shop.rating >= 50 && shop.rating < 70;
                    if (ratingFilter === 'poor') return shop.rating < 50;
                    return true;
                });
            }
            
            // Check if there are shops to export
            if (allShops.length === 0) {
                alert('⚠️ لا توجد محلات للتصدير');
                return;
            }
            
            if (format === 'json') {
                try {
                    const dataStr = JSON.stringify(allShops, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `smart-shop-list-${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                    alert(`✅ تم تصدير ${allShops.length} محل بصيغة JSON بنجاح!`);
                } catch (error) {
                    alert('❌ خطأ في تصدير JSON: ' + error.message);
                    console.error('JSON export error:', error);
                }
            } else if (format === 'excel') {
                try {
                    // Prepare data for Excel export
                    const exportData = allShops.map((shop, index) => ({
                        'الرقم': index + 1,
                        'اسم المحل': shop.name,
                        'الاسم بالإنجليزية': shop.nameEn,
                        'المنطقة': shop.area,
                        'رقم الترخيص': shop.licenseNo,
                        'كود ADM': shop.admCode,
                        'العنوان': shop.address,
                        'جهة الاتصال': shop.contact,
                        'النشاط': shop.activity,
                        'التقييم': shop.rating ? shop.rating.toFixed(1) + '%' : 'لا يوجد',
                        'آخر تفتيش': shop.lastInspection || 'لم يتم التفتيش',
                        'عدد التفتيشات': shop.inspectionCount || 0
                    }));
                    
                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    
                    // Set column widths
                    ws['!cols'] = [
                        { wch: 8 },  // الرقم
                        { wch: 30 }, // اسم المحل
                        { wch: 25 }, // الاسم بالإنجليزية
                        { wch: 20 }, // المنطقة
                        { wch: 15 }, // رقم الترخيص
                        { wch: 12 }, // كود ADM
                        { wch: 30 }, // العنوان
                        { wch: 20 }, // جهة الاتصال
                        { wch: 25 }, // النشاط
                        { wch: 12 }, // التقييم
                        { wch: 18 }, // آخر تفتيش
                        { wch: 15 }  // عدد التفتيشات
                    ];
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'قائمة المحلات الذكية');
                    
                    // Generate filename with timestamp
                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `قائمة_المحلات_الذكية_${timestamp}.xlsx`;
                    
                    // Download file
                    XLSX.writeFile(wb, filename);
                    
                    alert(`✅ تم تصدير ${allShops.length} محل إلى Excel بنجاح!\n\n📄 اسم الملف: ${filename}`);
                } catch (error) {
                    alert('❌ خطأ في تصدير Excel: ' + error.message);
                    console.error('Excel export error:', error);
                }
            } else if (format === 'pdf') {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Set font for better Arabic support (using default font)
                    doc.setFont('helvetica');
                    doc.setFontSize(16);
                    
                    // Add title
                    const title = 'قائمة المحلات الذكية - Smart Shop List';
                    doc.text(title, doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                    
                    // Add date
                    doc.setFontSize(10);
                    const dateText = `تاريخ التصدير: ${new Date().toLocaleDateString('ar-EG')} - Export Date: ${new Date().toLocaleDateString('en-US')}`;
                    doc.text(dateText, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });
                    
                    // Prepare table data
                    const tableData = allShops.map((shop, index) => [
                        index + 1,
                        shop.name,
                        shop.area,
                        shop.licenseNo || '-',
                        shop.activity || '-',
                        shop.rating ? shop.rating.toFixed(1) + '%' : '-',
                        shop.inspectionCount || 0
                    ]);
                    
                    // Add table
                    doc.autoTable({
                        startY: 30,
                        head: [['#', 'اسم المحل / Shop Name', 'المنطقة / Area', 'الترخيص / License', 'النشاط / Activity', 'التقييم / Rating', 'التفتيشات / Inspections']],
                        body: tableData,
                        styles: {
                            font: 'helvetica',
                            fontSize: 9,
                            cellPadding: 3,
                            halign: 'center'
                        },
                        headStyles: {
                            fillColor: [102, 126, 234],
                            textColor: 255,
                            fontStyle: 'bold',
                            halign: 'center'
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        margin: { top: 30, left: 10, right: 10 }
                    });
                    
                    // Add footer with statistics
                    const finalY = doc.lastAutoTable.finalY || 30;
                    doc.setFontSize(10);
                    const stats = `إجمالي المحلات / Total Shops: ${allShops.length}`;
                    doc.text(stats, 15, finalY + 10);
                    
                    // Save PDF
                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `Smart_Shop_List_${timestamp}.pdf`;
                    doc.save(filename);
                    
                    alert(`✅ تم تصدير ${allShops.length} محل إلى PDF بنجاح!\n\n📄 اسم الملف: ${filename}`);
                } catch (error) {
                    alert('❌ خطأ في تصدير PDF: ' + error.message);
                    console.error('PDF export error:', error);
                }
            }
        }
        
        // Print Smart Shop List
        function printSmartShopList() {
            try {
                const content = document.getElementById('smartShopListContent').innerHTML;
                
                // Check if there's content to print
                if (!content || content.trim() === '') {
                    alert('⚠️ لا يوجد محتوى للطباعة');
                    return;
                }
                
                const printWindow = window.open('', '', 'height=800,width=1000');
                
                if (!printWindow) {
                    alert('⚠️ تم حظر نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة.');
                    return;
                }
                
                printWindow.document.write('<html><head><title>قائمة المحلات الذكية</title>');
                printWindow.document.write('<meta charset="UTF-8">');
                printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">');
                printWindow.document.write('<style>');
                printWindow.document.write('* { margin: 0; padding: 0; box-sizing: border-box; }');
                printWindow.document.write('body { font-family: "Cairo", Arial, sans-serif; direction: rtl; padding: 20px; }');
                printWindow.document.write('h1 { text-align: center; color: #667eea; margin-bottom: 10px; }');
                printWindow.document.write('p { text-align: center; color: #666; margin-bottom: 20px; }');
                printWindow.document.write('table { width: 100%; border-collapse: collapse; margin: 20px 0; }');
                printWindow.document.write('th, td { border: 1px solid #ddd; padding: 10px; text-align: right; font-size: 12px; }');
                printWindow.document.write('th { background-color: #667eea; color: white; font-weight: bold; }');
                printWindow.document.write('tr:nth-child(even) { background-color: #f8f9fa; }');
                printWindow.document.write('h3 { color: #667eea; margin-top: 30px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }');
                printWindow.document.write('.priority-high { background-color: #ffe6e6; }');
                printWindow.document.write('.rating-excellent { background-color: #d4edda; }');
                printWindow.document.write('.rating-good { background-color: #cce5ff; }');
                printWindow.document.write('.rating-fair { background-color: #fff3cd; }');
                printWindow.document.write('.rating-poor { background-color: #f8d7da; }');
                printWindow.document.write('@media print { body { padding: 10px; } }');
                printWindow.document.write('</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write('<h1>📋 قائمة المحلات الذكية</h1>');
                printWindow.document.write('<p>تاريخ الطباعة: ' + new Date().toLocaleDateString('ar-EG') + ' - ' + new Date().toLocaleTimeString('ar-EG') + '</p>');
                printWindow.document.write(content);
                printWindow.document.write('<div style="margin-top: 30px; text-align: center; color: #999; font-size: 11px; border-top: 1px solid #ddd; padding-top: 10px;">');
                printWindow.document.write('تم إنشاء هذا التقرير بواسطة أداة التخطيط الذكية للتفتيش الشهري');
                printWindow.document.write('</div>');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                
                // Wait for content to load then print
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                }, 250);
                
            } catch (error) {
                alert('❌ خطأ في الطباعة: ' + error.message);
                console.error('Print error:', error);
            }
        }
        
        // =========================================================================
        // Smart Shop Management Functions
        // =========================================================================
        
        // Track selected shops for batch operations
        let selectedShopsForBatch = new Set();
        
        // Open Add Shop modal from Smart List
        function openAddShopFromSmartList() {
            // Close smart list modal first
            closeSmartShopListModal();
            // Switch to shops tab
            switchTab('shops');
            // Open add shop modal
            setTimeout(() => {
                openAddShopModal();
            }, 300);
        }
        
        // Open Bulk Edit Shops
        function openBulkEditShops() {
            if (selectedShopsForBatch.size === 0) {
                alert('⚠️ يرجى تحديد محل واحد على الأقل للتعديل\n\nاستخدم أزرار "تحديد الكل" أو حدد المحلات يدوياً');
                return;
            }
            
            const shopNames = Array.from(selectedShopsForBatch).join('\n• ');
            const confirm = window.confirm(`📝 تعديل جماعي لـ ${selectedShopsForBatch.size} محل\n\nالمحلات المحددة:\n• ${shopNames}\n\nهل تريد المتابعة؟`);
            
            if (confirm) {
                // Open bulk edit interface
                showBulkEditInterface();
            }
        }
        
        // Show Bulk Edit Interface
        function showBulkEditInterface() {
            const operations = [
                '1. تحديث المنطقة لجميع المحلات',
                '2. تحديث النشاط لجميع المحلات',
                '3. إضافة نفس العنوان لجميع المحلات',
                '4. تحديث رقم الترخيص بشكل جماعي',
                '5. إضافة موقع خرائط جوجل لجميع المحلات'
            ].join('\n');
            
            const choice = prompt(`⚙️ عمليات التعديل الجماعي المتاحة:\n\n${operations}\n\nاختر رقم العملية (1-5):`);
            
            if (!choice) return;
            
            switch(choice) {
                case '1':
                    bulkUpdateArea();
                    break;
                case '2':
                    bulkUpdateActivity();
                    break;
                case '3':
                    bulkUpdateAddress();
                    break;
                case '4':
                    bulkUpdateLicense();
                    break;
                case '5':
                    bulkUpdateMapsLocation();
                    break;
                default:
                    alert('❌ اختيار غير صحيح');
            }
        }
        
        // Bulk update area
        function bulkUpdateArea() {
            if (!planData || !planData.areas) {
                alert('❌ لا توجد مناطق محددة');
                return;
            }
            
            const areasList = planData.areas.map((a, i) => `${i + 1}. ${a.name}`).join('\n');
            const areaChoice = prompt(`📍 اختر المنطقة الجديدة:\n\n${areasList}\n\nأدخل رقم المنطقة:`);
            
            if (!areaChoice) return;
            
            const areaIndex = parseInt(areaChoice) - 1;
            if (areaIndex >= 0 && areaIndex < planData.areas.length) {
                const newArea = planData.areas[areaIndex];
                
                if (confirm(`✅ تحديث ${selectedShopsForBatch.size} محل إلى المنطقة: ${newArea.name}\n\nهل أنت متأكد؟`)) {
                    // Update shops
                    selectedShopsForBatch.forEach(shopName => {
                        // Update in shops_details.json
                        if (shopsDetails[shopName]) {
                            shopsDetails[shopName].area = newArea.name;
                            shopsDetails[shopName].areaId = newArea.id;
                        }
                    });
                    
                    alert(`✅ تم تحديث ${selectedShopsForBatch.size} محل بنجاح!\n\n💾 لا تنسَ حفظ التغييرات والمزامنة مع GitHub`);
                    updateSmartShopList();
                }
            } else {
                alert('❌ اختيار غير صحيح');
            }
        }
        
        // Bulk update activity
        function bulkUpdateActivity() {
            const newActivity = prompt('💼 أدخل النشاط الجديد لجميع المحلات المحددة:\n\nمثال: بيع الحيوانات الأليفة وأسماك الزينة');
            
            if (!newActivity) return;
            
            if (confirm(`✅ تحديث نشاط ${selectedShopsForBatch.size} محل إلى:\n"${newActivity}"\n\nهل أنت متأكد؟`)) {
                selectedShopsForBatch.forEach(shopName => {
                    if (shopsDetails[shopName]) {
                        shopsDetails[shopName].activity = newActivity;
                    }
                });
                
                alert(`✅ تم تحديث ${selectedShopsForBatch.size} محل بنجاح!\n\n💾 لا تنسَ حفظ التغييرات والمزامنة مع GitHub`);
                updateSmartShopList();
            }
        }
        
        // Bulk update address
        function bulkUpdateAddress() {
            const newAddress = prompt('📍 أدخل العنوان الجديد لجميع المحلات المحددة:\n\nمثال: حي الورود، شارع الأمير محمد');
            
            if (!newAddress) return;
            
            if (confirm(`✅ تحديث عنوان ${selectedShopsForBatch.size} محل إلى:\n"${newAddress}"\n\nهل أنت متأكد؟`)) {
                selectedShopsForBatch.forEach(shopName => {
                    if (shopsDetails[shopName]) {
                        shopsDetails[shopName].address = newAddress;
                    }
                });
                
                alert(`✅ تم تحديث ${selectedShopsForBatch.size} محل بنجاح!\n\n💾 لا تنسَ حفظ التغييرات والمزامنة مع GitHub`);
                updateSmartShopList();
            }
        }
        
        // Bulk update license
        function bulkUpdateLicense() {
            alert('🔖 تحديث الترخيص الجماعي\n\nسيتم إضافة بادئة ورقم تسلسلي لكل محل');
            
            const prefix = prompt('أدخل بادئة الترخيص (مثال: CN):', 'CN');
            if (!prefix) return;
            
            const startNumber = prompt('أدخل رقم البداية (مثال: 1000):', '1000');
            if (!startNumber) return;
            
            if (confirm(`✅ سيتم ترقيم ${selectedShopsForBatch.size} محل بدءاً من ${prefix}-${startNumber}\n\nهل أنت متأكد؟`)) {
                let counter = parseInt(startNumber);
                selectedShopsForBatch.forEach(shopName => {
                    if (shopsDetails[shopName]) {
                        shopsDetails[shopName].licenseNo = `${prefix}-${counter}`;
                        counter++;
                    }
                });
                
                alert(`✅ تم تحديث ${selectedShopsForBatch.size} محل بنجاح!\n\n💾 لا تنسَ حفظ التغييرات والمزامنة مع GitHub`);
                updateSmartShopList();
            }
        }
        
        // Bulk update maps location
        function bulkUpdateMapsLocation() {
            const baseUrl = prompt('🗺️ أدخل رابط خرائط جوجل الأساسي:\n\nمثال: https://maps.google.com/...');
            
            if (!baseUrl) return;
            
            if (confirm(`✅ تحديث موقع ${selectedShopsForBatch.size} محل\n\nهل أنت متأكد؟`)) {
                selectedShopsForBatch.forEach(shopName => {
                    if (shopsDetails[shopName]) {
                        shopsDetails[shopName].locationMap = baseUrl;
                    }
                });
                
                alert(`✅ تم تحديث ${selectedShopsForBatch.size} محل بنجاح!\n\n💾 لا تنسَ حفظ التغييرات والمزامنة مع GitHub`);
                updateSmartShopList();
            }
        }
        
        // Open Bulk Delete Shops
        function openBulkDeleteShops() {
            if (selectedShopsForBatch.size === 0) {
                alert('⚠️ يرجى تحديد محل واحد على الأقل للحذف');
                return;
            }
            
            const shopNames = Array.from(selectedShopsForBatch).join('\n• ');
            const confirm = window.confirm(`⚠️ تحذير: حذف جماعي\n\nسيتم حذف ${selectedShopsForBatch.size} محل نهائياً:\n• ${shopNames}\n\nهذا الإجراء لا يمكن التراجع عنه!\n\nهل أنت متأكد تماماً؟`);
            
            if (confirm) {
                const doubleConfirm = window.confirm(`⚠️ تأكيد نهائي\n\nهل أنت متأكد 100% من حذف ${selectedShopsForBatch.size} محل؟\n\nسيتم الحذف فوراً!`);
                
                if (doubleConfirm) {
                    deleteBulkShops();
                }
            }
        }
        
        // Delete Bulk Shops
        async function deleteBulkShops() {
            try {
                let deletedCount = 0;
                
                selectedShopsForBatch.forEach(shopName => {
                    if (shopsDetails[shopName]) {
                        delete shopsDetails[shopName];
                        deletedCount++;
                    }
                });
                
                // Clear selection
                selectedShopsForBatch.clear();
                
                alert(`✅ تم حذف ${deletedCount} محل بنجاح!\n\n💾 لا تنسَ حفظ التغييرات والمزامنة مع GitHub`);
                updateSmartShopList();
                
            } catch (error) {
                console.error('Error deleting shops:', error);
                alert('❌ خطأ في حذف المحلات: ' + error.message);
            }
        }
        
        // Open Import Shops from Excel
        function openImportShopsFromExcel() {
            const instructions = `📥 استيراد محلات من Excel\n\n`;
            const details = `الخطوات:\n1. قم بتحضير ملف Excel يحتوي على أعمدة:\n   - اسم المحل (nameAr)\n   - الاسم بالإنجليزية (nameEn)\n   - المنطقة (area)\n   - رقم الترخيص (licenseNo)\n   - العنوان (address)\n   - الهاتف (contact)\n   - النشاط (activity)\n   - كود ADM (admCode)\n\n2. احفظ الملف بصيغة .xlsx\n\n3. اختر الملف للاستيراد\n\nهل تريد المتابعة؟`;
            
            if (confirm(instructions + details)) {
                // Create file input
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx,.xls';
                input.onchange = handleImportExcelFile;
                input.click();
            }
        }
        
        // Handle Import Excel File
        async function handleImportExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                if (jsonData.length === 0) {
                    alert('❌ الملف فارغ أو لا يحتوي على بيانات صحيحة');
                    return;
                }
                
                let importedCount = 0;
                let skippedCount = 0;
                
                jsonData.forEach(row => {
                    const shopName = row.nameAr || row['اسم المحل'] || row.name;
                    
                    if (!shopName) {
                        skippedCount++;
                        return;
                    }
                    
                    // Check if shop already exists
                    if (shopsDetails[shopName]) {
                        const overwrite = confirm(`⚠️ المحل "${shopName}" موجود بالفعل\n\nهل تريد استبدال البيانات؟`);
                        if (!overwrite) {
                            skippedCount++;
                            return;
                        }
                    }
                    
                    // Import shop
                    shopsDetails[shopName] = {
                        nameAr: shopName,
                        nameEn: row.nameEn || row['الاسم بالإنجليزية'] || '',
                        area: row.area || row['المنطقة'] || '',
                        licenseNo: row.licenseNo || row['رقم الترخيص'] || '',
                        address: row.address || row['العنوان'] || '',
                        contact: row.contact || row['الهاتف'] || '',
                        activity: row.activity || row['النشاط'] || '',
                        admCode: row.admCode || row['كود ADM'] || '',
                        locationMap: row.locationMap || row['موقع الخريطة'] || ''
                    };
                    
                    importedCount++;
                });
                
                alert(`✅ تم الاستيراد بنجاح!\n\n📊 الإحصائيات:\n• تم استيراد: ${importedCount} محل\n• تم تجاهل: ${skippedCount} محل\n\n💾 لا تنسَ حفظ التغييرات والمزامنة مع GitHub`);
                updateSmartShopList();
                
            } catch (error) {
                console.error('Error importing Excel:', error);
                alert('❌ خطأ في استيراد الملف: ' + error.message);
            }
        }
        
        // Merge Duplicate Shops
        async function mergeDuplicateShops() {
            if (!confirm('🔄 حذف المحلات المكررة والبيانات الناقصة\n\nسيتم البحث عن المحلات المكررة بناءً على:\n• رقم الترخيص\n• الإسم بالعربية والإنجليزية\n• رقم الهاتف\n• المحلات بدون بيانات\n\nهل تريد المتابعة؟')) {
                return;
            }
            
            try {
                const shopNames = Object.keys(shopsDetails);
                
                // Find duplicates based on license, name, phone, or empty data
                const seenLicenses = {};
                const seenNamesAr = {};
                const seenNamesEn = {};
                const seenPhones = {};
                const emptyDataShops = [];
                
                shopNames.forEach(shopName => {
                    const shop = shopsDetails[shopName];
                    
                    // Check if shop has empty/missing data
                    const hasEmptyData = !shop.licenseNo && !shop.contact && !shop.nameEn;
                    if (hasEmptyData) {
                        emptyDataShops.push(shopName);
                        return;
                    }
                    
                    // Find duplicates based on license number
                    if (shop.licenseNo && shop.licenseNo.trim() !== '') {
                        const license = shop.licenseNo.trim().toLowerCase();
                        if (seenLicenses[license]) {
                            seenLicenses[license].push(shopName);
                        } else {
                            seenLicenses[license] = [shopName];
                        }
                    }
                    
                    // Find duplicates based on Arabic name
                    if (shop.nameAr && shop.nameAr.trim() !== '') {
                        const nameAr = shop.nameAr.trim().toLowerCase();
                        if (seenNamesAr[nameAr]) {
                            seenNamesAr[nameAr].push(shopName);
                        } else {
                            seenNamesAr[nameAr] = [shopName];
                        }
                    }
                    
                    // Find duplicates based on English name
                    if (shop.nameEn && shop.nameEn.trim() !== '') {
                        const nameEn = shop.nameEn.trim().toLowerCase();
                        if (seenNamesEn[nameEn]) {
                            seenNamesEn[nameEn].push(shopName);
                        } else {
                            seenNamesEn[nameEn] = [shopName];
                        }
                    }
                    
                    // Find duplicates based on phone
                    if (shop.contact && shop.contact.trim() !== '') {
                        const phone = shop.contact.trim().replace(/\D/g, ''); // Remove non-digits
                        if (phone.length > 0) {
                            if (seenPhones[phone]) {
                                seenPhones[phone].push(shopName);
                            } else {
                                seenPhones[phone] = [shopName];
                            }
                        }
                    }
                });
                
                // Collect all duplicate groups
                const allDuplicates = [];
                
                // Add license duplicates
                Object.values(seenLicenses).forEach(group => {
                    if (group.length > 1) {
                        allDuplicates.push({
                            type: 'رقم الترخيص',
                            shops: group,
                            identifier: shopsDetails[group[0]].licenseNo
                        });
                    }
                });
                
                // Add Arabic name duplicates
                Object.entries(seenNamesAr).forEach(([name, group]) => {
                    if (group.length > 1) {
                        allDuplicates.push({
                            type: 'الإسم بالعربية',
                            shops: group,
                            identifier: shopsDetails[group[0]].nameAr
                        });
                    }
                });
                
                // Add English name duplicates
                Object.entries(seenNamesEn).forEach(([name, group]) => {
                    if (group.length > 1) {
                        allDuplicates.push({
                            type: 'الإسم بالإنجليزية',
                            shops: group,
                            identifier: shopsDetails[group[0]].nameEn
                        });
                    }
                });
                
                // Add phone duplicates
                Object.entries(seenPhones).forEach(([phone, group]) => {
                    if (group.length > 1) {
                        allDuplicates.push({
                            type: 'رقم الهاتف',
                            shops: group,
                            identifier: shopsDetails[group[0]].contact
                        });
                    }
                });
                
                // Show results
                if (allDuplicates.length === 0 && emptyDataShops.length === 0) {
                    alert('✅ لا توجد محلات مكررة أو بدون بيانات!\n\nجميع المحلات فريدة.');
                    return;
                }
                
                // Build report
                let report = '🔍 تقرير المحلات المكررة والبيانات الناقصة\n\n';
                report += '=' .repeat(60) + '\n\n';
                
                if (allDuplicates.length > 0) {
                    report += `📋 عدد مجموعات المحلات المكررة: ${allDuplicates.length}\n\n`;
                    
                    allDuplicates.forEach((group, index) => {
                        report += `المجموعة ${index + 1}: تكرار في ${group.type}\n`;
                        report += `القيمة المكررة: ${group.identifier}\n`;
                        report += `المحلات:\n`;
                        group.shops.forEach((shop, idx) => {
                            report += `  ${idx + 1}. ${shop}\n`;
                        });
                        report += '\n';
                    });
                }
                
                if (emptyDataShops.length > 0) {
                    report += `\n📝 محلات بدون بيانات كافية: ${emptyDataShops.length}\n`;
                    emptyDataShops.forEach((shop, idx) => {
                        report += `  ${idx + 1}. ${shop}\n`;
                    });
                }
                
                report += '\n' + '='.repeat(60) + '\n';
                report += 'هل تريد حذف المحلات المكررة والبيانات الناقصة؟\n';
                report += '⚠️ سيتم الاحتفاظ بأول محل من كل مجموعة وحذف الباقي.\n';
                
                if (!confirm(report)) {
                    alert('تم إلغاء العملية');
                    return;
                }
                
                // Remove duplicates - keep first shop in each group
                const shopsToDelete = new Set();
                
                allDuplicates.forEach(group => {
                    // Keep first, delete rest
                    for (let i = 1; i < group.shops.length; i++) {
                        shopsToDelete.add(group.shops[i]);
                    }
                });
                
                // Add empty data shops to deletion list
                emptyDataShops.forEach(shop => shopsToDelete.add(shop));
                
                // Delete from shopsDetails
                shopsToDelete.forEach(shopName => {
                    delete shopsDetails[shopName];
                });
                
                // Delete from planData if exists
                let deletedCount = 0;
                if (planData && planData.inspectionData) {
                    planData.inspectionData.forEach(inspection => {
                        if (inspection.shops && Array.isArray(inspection.shops)) {
                            const beforeLength = inspection.shops.length;
                            inspection.shops = inspection.shops.filter(shop => !shopsToDelete.has(shop));
                            deletedCount += (beforeLength - inspection.shops.length);
                        }
                    });
                }
                
                alert(`✅ تم حذف ${shopsToDelete.size} محلات مكررة وبدون بيانات بنجاح!\n\n💾 لا تنسَ حفظ التغييرات والمزامنة مع GitHub`);
                updateSmartShopList();
                
            } catch (error) {
                console.error('Error removing duplicates:', error);
                alert('❌ خطأ في حذف المحلات المكررة: ' + error.message);
            }
        }
        
        // Sync Shops with GitHub
        async function syncShopsWithGitHub() {
            if (!githubToken) {
                alert('⚠️ يجب تسجيل الدخول أولاً للمزامنة مع GitHub');
                return;
            }
            
            if (!confirm('☁️ مزامنة جميع المحلات مع GitHub\n\nسيتم حفظ جميع التغييرات في shops_details.json\n\nهل تريد المتابعة؟')) {
                return;
            }
            
            try {
                // Save shops_details.json
                const jsonContent = JSON.stringify(shopsDetails, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(jsonContent)));
                
                // Get current file SHA
                const getResponse = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }
                
                // Commit to GitHub
                const updateResponse = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `تحديث قائمة المحلات - ${new Date().toLocaleString('ar-EG')}`,
                        content: encodedContent,
                        sha: sha,
                        branch: 'main'
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('فشل في حفظ التغييرات');
                }
                
                alert('✅ تمت المزامنة مع GitHub بنجاح!\n\n☁️ جميع التغييرات محفوظة');
                
            } catch (error) {
                console.error('Error syncing with GitHub:', error);
                alert('❌ خطأ في المزامنة: ' + error.message);
            }
        }
        
        // Refresh Smart Shop Data
        async function refreshSmartShopData() {
            if (confirm('🔄 تحديث البيانات من الخادم\n\nسيتم تحميل آخر نسخة من البيانات\n\nهل تريد المتابعة؟')) {
                try {
                    // Reload shops_details.json
                    const response = await fetch('shops_details.json?' + new Date().getTime());
                    if (response.ok) {
                        shopsDetails = await response.json();
                    }
                    
                    // Reload plan-data.json
                    const planResponse = await fetch('plan-data.json?' + new Date().getTime());
                    if (planResponse.ok) {
                        planData = await planResponse.json();
                    }
                    
                    alert('✅ تم تحديث البيانات بنجاح!');
                    updateSmartShopList();
                    
                } catch (error) {
                    console.error('Error refreshing data:', error);
                    alert('❌ خطأ في تحديث البيانات: ' + error.message);
                }
            }
        }
        
        // Open Advanced Shop Search
        function openAdvancedShopSearch() {
            const searchOptions = [
                '🔍 بحث متقدم في المحلات',
                '',
                '1. البحث بالاسم (عربي/إنجليزي)',
                '2. البحث برقم الترخيص',
                '3. البحث بكود ADM',
                '4. البحث بالنشاط',
                '5. البحث بالعنوان',
                '6. البحث برقم الهاتف',
                '',
                'اختر نوع البحث (1-6):'
            ].join('\n');
            
            const choice = prompt(searchOptions);
            if (!choice) return;
            
            const searchTerm = prompt('🔍 أدخل كلمة البحث:');
            if (!searchTerm) return;
            
            performAdvancedSearch(parseInt(choice), searchTerm);
        }
        
        // Perform Advanced Search
        function performAdvancedSearch(searchType, searchTerm) {
            const results = [];
            const term = searchTerm.toLowerCase();
            
            Object.entries(shopsDetails).forEach(([shopName, shop]) => {
                let match = false;
                
                switch(searchType) {
                    case 1: // Name
                        match = shopName.toLowerCase().includes(term) || 
                               (shop.nameEn && shop.nameEn.toLowerCase().includes(term));
                        break;
                    case 2: // License
                        match = shop.licenseNo && shop.licenseNo.toLowerCase().includes(term);
                        break;
                    case 3: // ADM Code
                        match = shop.admCode && shop.admCode.toLowerCase().includes(term);
                        break;
                    case 4: // Activity
                        match = shop.activity && shop.activity.toLowerCase().includes(term);
                        break;
                    case 5: // Address
                        match = shop.address && shop.address.toLowerCase().includes(term);
                        break;
                    case 6: // Phone
                        match = shop.contact && shop.contact.includes(term);
                        break;
                }
                
                if (match) {
                    results.push(shopName);
                }
            });
            
            if (results.length === 0) {
                alert('🔍 لم يتم العثور على نتائج مطابقة');
            } else {
                const resultsList = results.slice(0, 20).join('\n• ');
                const more = results.length > 20 ? `\n\n... و ${results.length - 20} نتيجة أخرى` : '';
                alert(`✅ تم العثور على ${results.length} نتيجة:\n\n• ${resultsList}${more}`);
            }
        }
        
        // Create Shops Backup
        function createShopsBackup() {
            try {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `shops_backup_${timestamp}.json`;
                
                const dataStr = JSON.stringify(shopsDetails, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);
                
                alert(`✅ تم إنشاء نسخة احتياطية بنجاح!\n\n📄 اسم الملف:\n${filename}\n\n💾 تم حفظ ${Object.keys(shopsDetails).length} محل`);
                
            } catch (error) {
                console.error('Error creating backup:', error);
                alert('❌ خطأ في إنشاء النسخة الاحتياطية: ' + error.message);
            }
        }
        
        // Select All Shops in List
        function selectAllShopsInList() {
            Object.keys(shopsDetails).forEach(shopName => {
                selectedShopsForBatch.add(shopName);
            });
            
            alert(`✅ تم تحديد ${selectedShopsForBatch.size} محل\n\nيمكنك الآن استخدام أزرار العمليات الجماعية`);
            updateSmartShopList();
        }
        
        // Deselect All Shops in List
        function deselectAllShopsInList() {
            const count = selectedShopsForBatch.size;
            selectedShopsForBatch.clear();
            
            alert(`✅ تم إلغاء تحديد ${count} محل`);
            updateSmartShopList();
        }
        
        // Select High Priority Shops in List
        function selectHighPriorityShopsInList() {
            selectedShopsForBatch.clear();
            
            Object.keys(shopsDetails).forEach(shopName => {
                const ratingData = calculateShopRating(shopName);
                if (ratingData.rating < 70) { // High priority = low rating
                    selectedShopsForBatch.add(shopName);
                }
            });
            
            alert(`✅ تم تحديد ${selectedShopsForBatch.size} محل ذو أولوية عالية\n\n⚠️ المحلات ذات التقييم المنخفض (أقل من 70)`);
            updateSmartShopList();
        }
        
        // Export Selected Shops
        function exportSelectedShops() {
            if (selectedShopsForBatch.size === 0) {
                alert('⚠️ لم يتم تحديد أي محلات للتصدير');
                return;
            }
            
            try {
                const selectedData = {};
                selectedShopsForBatch.forEach(shopName => {
                    if (shopsDetails[shopName]) {
                        selectedData[shopName] = shopsDetails[shopName];
                    }
                });
                
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `selected_shops_${timestamp}.json`;
                
                const dataStr = JSON.stringify(selectedData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);
                
                alert(`✅ تم تصدير ${selectedShopsForBatch.size} محل محدد بنجاح!\n\n📄 اسم الملف:\n${filename}`);
                
            } catch (error) {
                console.error('Error exporting selected shops:', error);
                alert('❌ خطأ في التصدير: ' + error.message);
            }
        }
        
        // Apply Batch Operation
        function applyBatchOperation() {
            if (selectedShopsForBatch.size === 0) {
                alert('⚠️ يرجى تحديد محلات أولاً');
                return;
            }
            
            const operations = [
                '⚙️ العمليات الجماعية المتاحة:',
                '',
                '1. تصدير المحدد إلى Excel',
                '2. طباعة قائمة المحدد',
                '3. نسخ أسماء المحدد',
                '4. حساب إحصائيات المحدد',
                '5. تطبيق تعديل جماعي',
                '',
                'اختر رقم العملية (1-5):'
            ].join('\n');
            
            const choice = prompt(operations);
            if (!choice) return;
            
            switch(choice) {
                case '1':
                    exportSelectedToExcel();
                    break;
                case '2':
                    printSelectedShops();
                    break;
                case '3':
                    copySelectedShopNames();
                    break;
                case '4':
                    calculateSelectedStats();
                    break;
                case '5':
                    showBulkEditInterface();
                    break;
                default:
                    alert('❌ اختيار غير صحيح');
            }
        }
        
        // Export Selected to Excel
        function exportSelectedToExcel() {
            try {
                const exportData = [];
                
                selectedShopsForBatch.forEach(shopName => {
                    const shop = shopsDetails[shopName];
                    if (shop) {
                        exportData.push({
                            'اسم المحل': shopName,
                            'الاسم بالإنجليزية': shop.nameEn || '',
                            'المنطقة': shop.area || '',
                            'رقم الترخيص': shop.licenseNo || '',
                            'كود ADM': shop.admCode || '',
                            'العنوان': shop.address || '',
                            'الهاتف': shop.contact || '',
                            'النشاط': shop.activity || ''
                        });
                    }
                });
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                XLSX.utils.book_append_sheet(wb, ws, 'المحلات المحددة');
                
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `selected_shops_${timestamp}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                alert(`✅ تم تصدير ${selectedShopsForBatch.size} محل إلى Excel بنجاح!\n\n📄 ${filename}`);
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('❌ خطأ في التصدير: ' + error.message);
            }
        }
        
        // Print Selected Shops
        function printSelectedShops() {
            const shopsList = Array.from(selectedShopsForBatch).map((name, i) => {
                const shop = shopsDetails[name];
                return `${i + 1}. ${name}\n   المنطقة: ${shop.area || 'غير محدد'}\n   الترخيص: ${shop.licenseNo || 'غير محدد'}`;
            }).join('\n\n');
            
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`
                <html>
                <head>
                    <title>قائمة المحلات المحددة</title>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: Arial, sans-serif; direction: rtl; padding: 20px; }
                        h1 { color: #667eea; text-align: center; }
                        pre { white-space: pre-wrap; line-height: 1.6; }
                    </style>
                </head>
                <body>
                    <h1>قائمة المحلات المحددة (${selectedShopsForBatch.size} محل)</h1>
                    <p>تاريخ الطباعة: ${new Date().toLocaleString('ar-EG')}</p>
                    <hr>
                    <pre>${shopsList}</pre>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Copy Selected Shop Names
        function copySelectedShopNames() {
            const names = Array.from(selectedShopsForBatch).join('\n');
            
            navigator.clipboard.writeText(names).then(() => {
                alert(`✅ تم نسخ ${selectedShopsForBatch.size} اسم محل إلى الحافظة!\n\nيمكنك الآن لصقها في أي مكان`);
            }).catch(err => {
                alert('❌ فشل النسخ: ' + err.message);
            });
        }
        
        // Calculate Selected Stats
        function calculateSelectedStats() {
            const stats = {
                total: selectedShopsForBatch.size,
                withLicense: 0,
                withAdmCode: 0,
                withPhone: 0,
                withActivity: 0,
                withLocation: 0,
                avgRating: 0
            };
            
            let totalRating = 0;
            
            selectedShopsForBatch.forEach(shopName => {
                const shop = shopsDetails[shopName];
                if (!shop) return;
                
                if (shop.licenseNo) stats.withLicense++;
                if (shop.admCode) stats.withAdmCode++;
                if (shop.contact) stats.withPhone++;
                if (shop.activity) stats.withActivity++;
                if (shop.locationMap) stats.withLocation++;
                
                const ratingData = calculateShopRating(shopName);
                totalRating += ratingData.rating;
            });
            
            stats.avgRating = (totalRating / stats.total).toFixed(1);
            
            const report = `📊 إحصائيات المحلات المحددة\n\n` +
                          `📈 إجمالي المحلات: ${stats.total}\n` +
                          `🔖 لديها ترخيص: ${stats.withLicense}\n` +
                          `🔢 لديها كود ADM: ${stats.withAdmCode}\n` +
                          `📞 لديها هاتف: ${stats.withPhone}\n` +
                          `💼 لديها نشاط محدد: ${stats.withActivity}\n` +
                          `🗺️ لديها موقع خرائط: ${stats.withLocation}\n` +
                          `⭐ متوسط التقييم: ${stats.avgRating}%\n\n` +
                          `📝 نسبة الاكتمال:\n` +
                          `• الترخيص: ${((stats.withLicense / stats.total) * 100).toFixed(1)}%\n` +
                          `• كود ADM: ${((stats.withAdmCode / stats.total) * 100).toFixed(1)}%\n` +
                          `• الهاتف: ${((stats.withPhone / stats.total) * 100).toFixed(1)}%\n` +
                          `• النشاط: ${((stats.withActivity / stats.total) * 100).toFixed(1)}%\n` +
                          `• الموقع: ${((stats.withLocation / stats.total) * 100).toFixed(1)}%`;
            
            alert(report);
        }
        
        // Toggle Shop Selection for batch operations
        function toggleShopSelection(shopName) {
            if (selectedShopsForBatch.has(shopName)) {
                selectedShopsForBatch.delete(shopName);
            } else {
                selectedShopsForBatch.add(shopName);
            }
            updateSmartShopList();
        }
        
        // Edit Shop from Smart List
        function editShopFromSmartList(shopName) {
            // Check if planData is loaded
            if (!planData) {
                alert('⚠️ يرجى الانتظار حتى يتم تحميل البيانات');
                return;
            }
            
            // Initialize shops array if it doesn't exist
            if (!planData.shops) {
                planData.shops = [];
            }
            
            // Find the shop in planData.shops to get the ID
            const planShop = planData.shops.find(s => s.name === shopName);
            if (!planShop) {
                // Shop might be in shops_details.json but not in plan-data yet
                // Open edit modal with the shop name, it will create a new entry
                openEditShopModal(shopName);
                return;
            }
            
            // Open the edit modal using the existing openEditShopModal function
            openEditShopModal(planShop.id);
        }
        
        // Delete Shop from Smart List
        function deleteShopFromSmartList(shopName) {
            const shop = shopsDetails[shopName];
            if (!shop) {
                alert('❌ لم يتم العثور على بيانات المحل');
                return;
            }
            
            const details = [
                `⚠️ تأكيد حذف المحل`,
                '',
                `اسم المحل: ${shopName}`,
                `المنطقة: ${shop.area || 'غير محدد'}`,
                `الترخيص: ${shop.licenseNo || 'غير محدد'}`,
                '',
                `هذا الإجراء لا يمكن التراجع عنه!`,
                '',
                `هل أنت متأكد من الحذف؟`
            ].join('\n');
            
            if (confirm(details)) {
                delete shopsDetails[shopName];
                selectedShopsForBatch.delete(shopName);
                
                alert('✅ تم حذف المحل بنجاح!\n\n💾 لا تنسَ المزامنة مع GitHub');
                updateSmartShopList();
            }
        }
        
        // =========================================================================
        // Bell Notifications Control Functions
        // =========================================================================
        
        // Open Bell Notifications Control Modal
        async function openBellNotificationsControl() {
            if (!githubToken) {
                alert('⚠️ يجب تسجيل الدخول أولاً للتحكم في الإشعارات');
                return;
            }
            
            // Show modal
            document.getElementById('bellNotificationsModal').classList.add('show');
            
            // Load notifications from plan-data.json
            await loadBellNotifications();
        }
        
        // Close Bell Notifications Control Modal
        function closeBellNotificationsControl() {
            document.getElementById('bellNotificationsModal').classList.remove('show');
        }
        
        // Load Bell Notifications from plan-data.json
        async function loadBellNotifications() {
            try {
                showBellStatusMessage('جاري تحميل الإشعارات...', 'info');
                
                // If planData is already loaded, use it
                if (planData && planData.bellNotes) {
                    console.log('Using already loaded planData');
                    displayBellNotifications();
                    loadBellSettings();
                    showBellStatusMessage('تم تحميل الإشعارات بنجاح ✅', 'success');
                    setTimeout(() => hideBellStatusMessage(), 2000);
                    return;
                }
                
                // Otherwise, fetch from server
                const response = await fetch('plan-data.json?' + new Date().getTime());
                if (!response.ok) {
                    throw new Error('فشل في تحميل البيانات');
                }
                
                const data = await response.json();
                planData = data;
                
                // Display notifications
                displayBellNotifications();
                loadBellSettings();
                
                showBellStatusMessage('تم تحميل الإشعارات بنجاح ✅', 'success');
                setTimeout(() => hideBellStatusMessage(), 2000);
            } catch (error) {
                console.error('Error loading bell notifications:', error);
                showBellStatusMessage('خطأ في تحميل الإشعارات: ' + error.message + '\n\nسيتم المحاولة مرة أخرى...', 'error');
                
                // Retry with current planData if available
                if (planData) {
                    setTimeout(() => {
                        displayBellNotifications();
                        loadBellSettings();
                        showBellStatusMessage('تم استخدام البيانات المحملة مسبقاً ✅', 'success');
                    }, 1000);
                }
            }
        }
        
        // Display Bell Notifications
        function displayBellNotifications() {
            const container = document.getElementById('bellNotificationsList');
            
            // Initialize bellNotes if it doesn't exist
            if (!planData.bellNotes) {
                planData.bellNotes = { notifications: [] };
            }
            
            if (!planData.bellNotes.notifications) {
                planData.bellNotes.notifications = [];
            }
            
            // Check if there are no notifications
            if (planData.bellNotes.notifications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 3em; margin-bottom: 10px;">📭</div>
                        <p>لا توجد إشعارات حالياً</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">استخدم النموذج أعلاه لإضافة إشعار جديد</p>
                    </div>
                `;
                return;
            }
            
            // Display notifications
            let html = '';
            planData.bellNotes.notifications.forEach((notification, index) => {
                const timestamp = notification.timestamp ? new Date(notification.timestamp).toLocaleString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'غير محدد';
                
                const author = notification.author || 'د. علي عبدالعال';
                const priority = notification.priority || 'medium';
                const displayDuration = notification.displayDuration || 7;
                const expiryDate = notification.expiryDate || null;
                
                // Calculate if notification is expired
                const isExpired = expiryDate && new Date(expiryDate) < new Date();
                const expiredClass = isExpired ? 'opacity: 0.5; text-decoration: line-through;' : '';
                
                // Priority icons
                const priorityIcons = {
                    high: '🔴',
                    medium: '🟡',
                    low: '🟢'
                }; 
                
                html += `
                    <div class="notification-item priority-${priority}" style="${expiredClass}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div class="notification-text" id="bellNotifText_${index}" onclick="editBellNotification(${index})">
                                    ${notification.text}
                                </div>
                                <textarea 
                                    class="notification-edit-textarea" 
                                    id="bellNotifEdit_${index}"
                                    dir="rtl"
                                >${notification.text}</textarea>
                            </div>
                            <div style="display: flex; gap: 5px; margin-right: 10px;">
                                ${index > 0 ? `<button class="notification-action-btn notification-move-btn" onclick="moveBellNotificationUp(${index})" title="نقل لأعلى">⬆️</button>` : ''}
                                ${index < planData.bellNotes.notifications.length - 1 ? `<button class="notification-action-btn notification-move-btn" onclick="moveBellNotificationDown(${index})" title="نقل لأسفل">⬇️</button>` : ''}
                            </div>
                        </div>
                        
                        <div id="bellAuthorEditContainer_${index}" style="display: none; margin-top: 10px;">
                            <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 500; font-size: 0.9em;">👤 اسم المؤلف/المرسل:</label>
                            <input 
                                type="text" 
                                id="bellAuthorEdit_${index}" 
                                value="${author}"
                                class="notification-author-input"
                                dir="rtl"
                            />
                        </div>
                        
                        <div id="bellSettingsContainer_${index}" style="display: none;" class="notification-settings">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label>📌 الأولوية:</label>
                                    <select id="bellPriorityEdit_${index}" style="width: 100%; padding: 8px; border: 2px solid #ced4da; border-radius: 8px;">
                                        <option value="high" ${priority === 'high' ? 'selected' : ''}>عالية 🔴</option>
                                        <option value="medium" ${priority === 'medium' ? 'selected' : ''}>متوسطة 🟡</option>
                                        <option value="low" ${priority === 'low' ? 'selected' : ''}>منخفضة 🟢</option>
                                    </select>
                                </div>
                                <div>
                                    <label>⏱️ مدة العرض (بالأيام):</label>
                                    <input type="number" id="bellDurationEdit_${index}" value="${displayDuration}" min="1" max="365" 
                                           style="width: 100%; padding: 8px; border: 2px solid #ced4da; border-radius: 8px;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="notification-meta">
                            <span>📅 ${timestamp}</span>
                            <span>👤 ${author}</span>
                            <span>${priorityIcons[priority]} ${priority === 'high' ? 'أولوية عالية' : priority === 'medium' ? 'أولوية متوسطة' : 'أولوية منخفضة'}</span>
                            ${isExpired ? '<span style="color: #dc3545;">⏰ منتهي</span>' : `<span>⏱️ ${displayDuration} أيام</span>`}
                        </div>
                        
                        <div class="notification-actions">
                            <button class="notification-action-btn notification-save-btn" id="bellSaveBtn_${index}" onclick="saveBellNotificationEdit(${index})">
                                ✅ حفظ
                            </button>
                            <button class="notification-action-btn notification-cancel-btn" id="bellCancelBtn_${index}" onclick="cancelBellNotificationEdit(${index})">
                                ❌ إلغاء
                            </button>
                            <button class="notification-action-btn notification-priority-btn" onclick="toggleBellSettings(${index})">
                                ⚙️ إعدادات
                            </button>
                            <button class="notification-action-btn notification-delete-btn" onclick="deleteBellNotification(${index})">
                                🗑️ حذف
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Add Bell Notification
        function addBellNotification() {
            const textInput = document.getElementById('newBellNotificationText');
            const authorInput = document.getElementById('newBellNotificationAuthor');
            const priorityInput = document.getElementById('newBellNotificationPriority');
            const durationInput = document.getElementById('newBellNotificationDuration');
            
            const text = textInput.value.trim();
            const author = authorInput.value.trim();
            const priority = priorityInput.value;
            const displayDuration = parseInt(durationInput.value);
            
            if (!text) {
                alert('⚠️ يرجى كتابة نص الإشعار');
                return;
            }
            
            if (!author) {
                alert('⚠️ يرجى كتابة اسم المؤلف');
                return;
            }
            
            // Initialize bellNotes if needed
            if (!planData.bellNotes) {
                planData.bellNotes = { notifications: [], settings: {} };
            }
            
            if (!planData.bellNotes.notifications) {
                planData.bellNotes.notifications = [];
            }
            
            // Calculate expiry date
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + displayDuration);
            
            // Create new notification
            const newNotification = {
                id: Date.now().toString(),
                text: text,
                timestamp: new Date().toISOString(),
                author: author,
                priority: priority,
                displayDuration: displayDuration,
                expiryDate: expiryDate.toISOString()
            };
            
            // Add to beginning of array (most recent first)
            planData.bellNotes.notifications.unshift(newNotification);
            
            // Clear inputs
            textInput.value = '';
            // Keep author for convenience
            priorityInput.value = 'medium';
            durationInput.value = '7';
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('تم إضافة الإشعار بنجاح! ✅ لا تنسَ الضغط على "حفظ جميع التغييرات" للمزامنة', 'success');
        }
        
        // Edit Bell Notification
        function editBellNotification(index) {
            const textDiv = document.getElementById(`bellNotifText_${index}`);
            const editTextarea = document.getElementById(`bellNotifEdit_${index}`);
            const authorEditContainer = document.getElementById(`bellAuthorEditContainer_${index}`);
            const saveBtn = document.getElementById(`bellSaveBtn_${index}`);
            const cancelBtn = document.getElementById(`bellCancelBtn_${index}`);
            
            textDiv.style.display = 'none';
            editTextarea.style.display = 'block';
            authorEditContainer.style.display = 'block';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
            
            editTextarea.focus();
        }
        
        // Save Bell Notification Edit
        function saveBellNotificationEdit(index) {
            const textDiv = document.getElementById(`bellNotifText_${index}`);
            const editTextarea = document.getElementById(`bellNotifEdit_${index}`);
            const authorEditContainer = document.getElementById(`bellAuthorEditContainer_${index}`);
            const authorEdit = document.getElementById(`bellAuthorEdit_${index}`);
            const settingsContainer = document.getElementById(`bellSettingsContainer_${index}`);
            const priorityEdit = document.getElementById(`bellPriorityEdit_${index}`);
            const durationEdit = document.getElementById(`bellDurationEdit_${index}`);
            const saveBtn = document.getElementById(`bellSaveBtn_${index}`);
            const cancelBtn = document.getElementById(`bellCancelBtn_${index}`);
            
            const newText = editTextarea.value.trim();
            const newAuthor = authorEdit.value.trim();
            const newPriority = priorityEdit ? priorityEdit.value : (planData.bellNotes.notifications[index].priority || 'medium');
            const newDuration = durationEdit ? parseInt(durationEdit.value) : (planData.bellNotes.notifications[index].displayDuration || 7);
            
            if (!newText) {
                alert('⚠️ لا يمكن أن يكون الإشعار فارغاً');
                return;
            }
            
            if (!newAuthor) {
                alert('⚠️ لا يمكن أن يكون اسم المؤلف فارغاً');
                return;
            }
            
            // Calculate new expiry date
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + newDuration);
            
            // Update notification
            planData.bellNotes.notifications[index].text = newText;
            planData.bellNotes.notifications[index].author = newAuthor;
            planData.bellNotes.notifications[index].priority = newPriority;
            planData.bellNotes.notifications[index].displayDuration = newDuration;
            planData.bellNotes.notifications[index].expiryDate = expiryDate.toISOString();
            planData.bellNotes.notifications[index].lastModified = new Date().toISOString();
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('تم تحديث الإشعار بنجاح! ✅ لا تنسَ الضغط على "حفظ جميع التغييرات" للمزامنة', 'success');
        }
        
        // Cancel Bell Notification Edit
        function cancelBellNotificationEdit(index) {
            const textDiv = document.getElementById(`bellNotifText_${index}`);
            const editTextarea = document.getElementById(`bellNotifEdit_${index}`);
            const authorEditContainer = document.getElementById(`bellAuthorEditContainer_${index}`);
            const authorEdit = document.getElementById(`bellAuthorEdit_${index}`);
            const saveBtn = document.getElementById(`bellSaveBtn_${index}`);
            const cancelBtn = document.getElementById(`bellCancelBtn_${index}`);
            
            // Reset to original values
            editTextarea.value = planData.bellNotes.notifications[index].text;
            authorEdit.value = planData.bellNotes.notifications[index].author || 'د. علي عبدالعال';
            
            textDiv.style.display = 'block';
            editTextarea.style.display = 'none';
            authorEditContainer.style.display = 'none';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }
        
        // Delete Bell Notification
        function deleteBellNotification(index) {
            if (!confirm('⚠️ هل أنت متأكد من حذف هذا الإشعار؟\n\nسيتم حذفه نهائياً من جميع الأجهزة بعد المزامنة.')) {
                return;
            }
            
            // Remove notification
            planData.bellNotes.notifications.splice(index, 1);
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('تم حذف الإشعار بنجاح! ✅ لا تنسَ الضغط على "حفظ جميع التغييرات" للمزامنة', 'success');
        }
        
        // Save All Bell Notifications to GitHub
        async function saveAllBellNotifications() {
            if (!githubToken) {
                alert('⚠️ يجب تسجيل الدخول أولاً');
                return;
            }
            
            if (!confirm('⚠️ هل أنت متأكد من حفظ جميع التغييرات والمزامنة مع GitHub؟\n\nسيتم تحديث الإشعارات على جميع الأجهزة فوراً.')) {
                return;
            }
            
            try {
                showBellStatusMessage('جاري حفظ التغييرات والمزامنة مع GitHub...', 'info');
                
                // Get current file SHA
                const getResponse = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error('فشل في الحصول على بيانات الملف');
                }
                
                const fileData = await getResponse.json();
                const sha = fileData.sha;
                
                // Update lastUpdate
                planData.lastUpdate = new Date().toISOString();
                
                // Convert to JSON
                const jsonContent = JSON.stringify(planData, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(jsonContent)));
                
                // Commit to GitHub
                const updateResponse = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `تحديث إشعارات الجرس - ${new Date().toLocaleString('ar-EG')}`,
                        content: encodedContent,
                        sha: sha,
                        branch: 'main'
                    })
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.message || 'فشل في حفظ التغييرات');
                }
                
                showBellStatusMessage('✅ تم حفظ جميع التغييرات بنجاح!\n\nستظهر الإشعارات فوراً في الجرس 🔔 على الشاشة الرئيسية', 'success');
                
                // Reload notifications to confirm
                setTimeout(() => {
                    loadBellNotifications();
                }, 2000);
                
            } catch (error) {
                console.error('Error saving bell notifications:', error);
                showBellStatusMessage('❌ خطأ في حفظ التغييرات: ' + error.message, 'error');
            }
        }
        
        // Show Bell Status Message
        function showBellStatusMessage(message, type) {
            const messageDiv = document.getElementById('bellStatusMessage');
            messageDiv.textContent = message;
            messageDiv.className = 'bell-status-message show ' + type;
        }
        
        // Hide Bell Status Message
        function hideBellStatusMessage() {
            const messageDiv = document.getElementById('bellStatusMessage');
            messageDiv.classList.remove('show');
        }
        
        // =========================================================================
        // Enhanced Bell Notification Functions
        // =========================================================================
        
        // Toggle Bell Settings
        function toggleBellSettings(index) {
            const settingsContainer = document.getElementById(`bellSettingsContainer_${index}`);
            if (settingsContainer.style.display === 'none') {
                settingsContainer.style.display = 'block';
            } else {
                settingsContainer.style.display = 'none';
            }
        }
        
        // Move Bell Notification Up
        function moveBellNotificationUp(index) {
            if (index === 0) return;
            
            // Swap with previous
            const temp = planData.bellNotes.notifications[index];
            planData.bellNotes.notifications[index] = planData.bellNotes.notifications[index - 1];
            planData.bellNotes.notifications[index - 1] = temp;
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('تم نقل الإشعار لأعلى ⬆️ لا تنسَ حفظ التغييرات', 'success');
        }
        
        // Move Bell Notification Down
        function moveBellNotificationDown(index) {
            if (index >= planData.bellNotes.notifications.length - 1) return;
            
            // Swap with next
            const temp = planData.bellNotes.notifications[index];
            planData.bellNotes.notifications[index] = planData.bellNotes.notifications[index + 1];
            planData.bellNotes.notifications[index + 1] = temp;
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('تم نقل الإشعار لأسفل ⬇️ لا تنسَ حفظ التغييرات', 'success');
        }
        
        // Sort Bell Notifications by Priority
        function sortBellNotificationsByPriority() {
            const priorityOrder = { high: 0, medium: 1, low: 2 };
            
            planData.bellNotes.notifications.sort((a, b) => {
                const priorityA = priorityOrder[a.priority || 'medium'];
                const priorityB = priorityOrder[b.priority || 'medium'];
                return priorityA - priorityB;
            });
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('تم ترتيب الإشعارات حسب الأولوية 🔽 لا تنسَ حفظ التغييرات', 'success');
        }
        
        // Sort Bell Notifications by Date
        function sortBellNotificationsByDate() {
            planData.bellNotes.notifications.sort((a, b) => {
                const dateA = new Date(a.timestamp || 0);
                const dateB = new Date(b.timestamp || 0);
                return dateB - dateA; // Most recent first
            });
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('تم ترتيب الإشعارات حسب التاريخ 📅 لا تنسَ حفظ التغييرات', 'success');
        }
        
        // Delete Expired Notifications
        function deleteExpiredNotifications() {
            const now = new Date();
            const before = planData.bellNotes.notifications.length;
            
            planData.bellNotes.notifications = planData.bellNotes.notifications.filter(notification => {
                if (!notification.expiryDate) return true;
                return new Date(notification.expiryDate) >= now;
            });
            
            const after = planData.bellNotes.notifications.length;
            const deleted = before - after;
            
            if (deleted === 0) {
                showBellStatusMessage('لا توجد إشعارات منتهية للحذف ✅', 'success');
            } else {
                displayBellNotifications();
                showBellStatusMessage(`تم حذف ${deleted} إشعار منتهي 🗑️ لا تنسَ حفظ التغييرات`, 'success');
            }
        }
        
        // Load Bell Settings
        function loadBellSettings() {
            // Initialize settings if they don't exist
            if (!planData.bellNotes.settings) {
                planData.bellNotes.settings = {
                    bubbleDuration: 24,
                    soundEnabled: true,
                    displayStyle: 'modern'
                };
            }
            
            // Load settings into UI
            const bubbleDurationInput = document.getElementById('bellBubbleDuration');
            const soundEnabledSelect = document.getElementById('bellSoundEnabled');
            const displayStyleSelect = document.getElementById('bellDisplayStyle');
            
            if (bubbleDurationInput) {
                bubbleDurationInput.value = planData.bellNotes.settings.bubbleDuration || 24;
            }
            
            if (soundEnabledSelect) {
                soundEnabledSelect.value = planData.bellNotes.settings.soundEnabled !== false ? 'true' : 'false';
            }
            
            if (displayStyleSelect) {
                displayStyleSelect.value = planData.bellNotes.settings.displayStyle || 'modern';
            }
        }
        
        // Update Bell Bubble Duration
        function updateBellBubbleDuration() {
            const bubbleDurationInput = document.getElementById('bellBubbleDuration');
            const duration = parseInt(bubbleDurationInput.value);
            
            if (duration < 5 || duration > 120) {
                alert('⚠️ مدة الظهور يجب أن تكون بين 5 و 120 ثانية');
                bubbleDurationInput.value = planData.bellNotes.settings.bubbleDuration || 24;
                return;
            }
            
            if (!planData.bellNotes.settings) {
                planData.bellNotes.settings = {};
            }
            
            planData.bellNotes.settings.bubbleDuration = duration;
            showBellStatusMessage(`تم تحديث مدة ظهور الفقاعة إلى ${duration} ثانية ⏱️ لا تنسَ حفظ التغييرات`, 'success');
        }
        
        // Update Bell Sound Setting
        function updateBellSoundSetting() {
            const soundEnabledSelect = document.getElementById('bellSoundEnabled');
            const soundEnabled = soundEnabledSelect.value === 'true';
            
            if (!planData.bellNotes.settings) {
                planData.bellNotes.settings = {};
            }
            
            planData.bellNotes.settings.soundEnabled = soundEnabled;
            showBellStatusMessage(`تم ${soundEnabled ? 'تفعيل' : 'تعطيل'} صوت الإشعارات 🔔 لا تنسَ حفظ التغييرات`, 'success');
        }
        
        // Update Bell Display Style
        function updateBellDisplayStyle() {
            const displayStyleSelect = document.getElementById('bellDisplayStyle');
            const displayStyle = displayStyleSelect.value;
            
            if (!planData.bellNotes.settings) {
                planData.bellNotes.settings = {};
            }
            
            planData.bellNotes.settings.displayStyle = displayStyle;
            showBellStatusMessage(`تم تغيير نمط العرض إلى ${displayStyle === 'modern' ? 'عصري' : displayStyle === 'classic' ? 'كلاسيكي' : 'بسيط'} 🎨 لا تنسَ حفظ التغييرات`, 'success');
        }
    </script>
    
    <!-- Hand Gesture Control Modal -->
    <div id="gestureModal" class="gesture-modal">
        <div class="gesture-modal-content">
            <span class="gesture-close" onclick="closeGestureControl()">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px; font-size: 2em;">
                ✋ التحكم الذكي بحركة اليد
            </h2>
            
            <div class="gesture-video-container">
                <video id="gestureVideo" class="gesture-video" autoplay playsinline></video>
                <canvas id="gestureCanvas" class="gesture-canvas"></canvas>
            </div>
            
            <div class="gesture-status">
                <h3>الحالة: <span id="gestureStatusText">في انتظار بدء الكاميرا...</span></h3>
                <div class="gesture-detected" id="gestureDetected">---</div>
                <p id="gestureAction" style="font-size: 1.2em; margin-top: 10px;">لا يوجد إجراء</p>
            </div>
            
            <div class="gesture-guide">
                <h3>🎯 دليل حركات اليد</h3>
                
                <div class="gesture-item">
                    <div class="gesture-icon">👉</div>
                    <div class="gesture-description">
                        <strong>التمرير لليمين</strong>
                        <span>حرك يدك من اليسار إلى اليمين → الانتقال للتبويب التالي</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">👈</div>
                    <div class="gesture-description">
                        <strong>التمرير لليسار</strong>
                        <span>حرك يدك من اليمين إلى اليسار → الانتقال للتبويب السابق</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">👆</div>
                    <div class="gesture-description">
                        <strong>التمرير للأعلى</strong>
                        <span>حرك يدك من الأسفل إلى الأعلى → التمرير لأعلى الصفحة</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">👇</div>
                    <div class="gesture-description">
                        <strong>التمرير للأسفل</strong>
                        <span>حرك يدك من الأعلى إلى الأسفل → التمرير لأسفل الصفحة</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">✋</div>
                    <div class="gesture-description">
                        <strong>راحة اليد المفتوحة</strong>
                        <span>افتح كف يدك بالكامل → إيقاف التمرير مؤقتاً</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">✊</div>
                    <div class="gesture-description">
                        <strong>قبضة اليد المغلقة</strong>
                        <span>أغلق قبضة يدك → النقر أو التفعيل</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">☝️</div>
                    <div class="gesture-description">
                        <strong>الإشارة بالسبابة</strong>
                        <span>أشر بإصبع السبابة فقط → التحكم الدقيق والتنقل</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">✌️</div>
                    <div class="gesture-description">
                        <strong>علامة النصر (إصبعان)</strong>
                        <span>أشر بإصبعين → العودة للصفحة الرئيسية</span>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-danger" onclick="closeGestureControl()" style="padding: 15px 40px; font-size: 1.2em;">
                    إغلاق التحكم بحركة اليد
                </button>
            </div>
        </div>
    </div>
    
    <!-- Background Music Volume Control Modal -->
    <div id="volumeModal" class="volume-modal">
        <div class="volume-modal-content">
            <span class="volume-close" onclick="closeVolumeControl()">&times;</span>
            <h2 style="text-align: center; margin-bottom: 10px; font-size: 2em;">
                🎵 التحكم في صوت الموسيقى الخلفية
            </h2>
            <p style="text-align: center; font-size: 0.95em; opacity: 0.9; margin-bottom: 20px;">
                اضبط مستوى الصوت حسب تفضيلاتك
            </p>
            
            <div class="volume-slider-container">
                <div class="volume-display-big" id="volumeDisplayBig">
                    🔊 1%
                </div>
                
                <input type="range" id="mainVolumeSlider" class="volume-slider" 
                       min="0" max="100" value="1" 
                       oninput="updateMainVolumeDisplay(this.value)">
                
                <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 1.1em;">
                    <span>🔇 صامت</span>
                    <span>🔊 عالي</span>
                </div>
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px; margin: 20px 0;">
                <h3 style="margin: 0 0 15px 0; text-align: center; font-size: 1.3em;">إعدادات سريعة</h3>
                <div class="volume-presets">
                    <button class="volume-preset-btn" onclick="setVolumePreset(0)">
                        🔇<br>صامت<br>0%
                    </button>
                    <button class="volume-preset-btn" onclick="setVolumePreset(1)">
                        🔉<br>منخفض جداً<br>1%
                    </button>
                    <button class="volume-preset-btn" onclick="setVolumePreset(5)">
                        🔉<br>منخفض<br>5%
                    </button>
                    <button class="volume-preset-btn" onclick="setVolumePreset(10)">
                        🔊<br>متوسط<br>10%
                    </button>
                    <button class="volume-preset-btn" onclick="setVolumePreset(25)">
                        🔊<br>مرتفع<br>25%
                    </button>
                    <button class="volume-preset-btn" onclick="setVolumePreset(50)">
                        🔊<br>عالي<br>50%
                    </button>
                </div>
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin: 20px 0;">
                <h4 style="margin: 0 0 10px 0; font-size: 1.1em;">💡 معلومات مهمة:</h4>
                <ul style="margin: 0; padding-right: 20px; line-height: 1.8; font-size: 0.95em;">
                    <li>الإعداد الافتراضي: 1% (منخفض جداً - موصى به)</li>
                    <li>يتم حفظ إعداداتك تلقائياً في GitHub</li>
                    <li>التغييرات تطبق فوراً على الموسيقى في الصفحة الرئيسية</li>
                    <li>للتحكم الأمثل: استخدم نسبة بين 1-5%</li>
                </ul>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap; justify-content: center;">
                <button onclick="saveVolumeSettings()" 
                        style="background: white; color: #f5576c; border: none; padding: 15px 30px; 
                               border-radius: 10px; font-weight: bold; font-size: 1.1em; 
                               cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
                               font-family: 'Cairo', sans-serif; transition: all 0.3s ease;">
                    💾 حفظ الإعدادات
                </button>
                
                <button onclick="testBackgroundMusic()" 
                        style="background: rgba(255, 255, 255, 0.2); color: white; 
                               border: 2px solid white; padding: 15px 30px; 
                               border-radius: 10px; font-weight: bold; font-size: 1.1em; 
                               cursor: pointer; font-family: 'Cairo', sans-serif; 
                               transition: all 0.3s ease;">
                    ▶️ تجربة الصوت
                </button>
                
                <button onclick="closeVolumeControl()" 
                        style="background: rgba(255, 255, 255, 0.2); color: white; 
                               border: 2px solid white; padding: 15px 30px; 
                               border-radius: 10px; font-weight: bold; font-size: 1.1em; 
                               cursor: pointer; font-family: 'Cairo', sans-serif; 
                               transition: all 0.3s ease;">
                    ✖️ إغلاق
                </button>
            </div>
        </div>
    </div>
    
    <!-- Smart Pet Shop Discovery Modal -->
    <div id="smartPetShopModal" class="modal" style="display: none; z-index: 3000;">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>🐾 اكتشاف محلات الحيوانات الأليفة ذكياً</h2>
                <span class="modal-close" onclick="closeSmartPetShopModal()">&times;</span>
            </div>
            
            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #2d3561; margin-bottom: 15px;">📍 كيفية الاستخدام:</h3>
                <ol style="margin: 0; padding-right: 20px; line-height: 1.8;">
                    <li>انقر على زر "فتح خرائط جوجل" أدناه</li>
                    <li>سيتم فتح خرائط جوجل تلقائياً مع البحث عن محلات الحيوانات الأليفة</li>
                    <li>انسخ اسم المحل والموقع من خرائط جوجل</li>
                    <li>الصق المعلومات في النموذج أدناه</li>
                    <li>انقر على "إضافة إلى خطة التفتيش" لإضافة المحل تلقائياً</li>
                </ol>
            </div>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <button onclick="openGoogleMapsSearch()" class="btn btn-primary" style="font-size: 1.2em; padding: 18px 40px;">
                    <span>🗺️</span>
                    <span>فتح خرائط جوجل للبحث</span>
                </button>
            </div>
            
            <div style="background: white; padding: 25px; border-radius: 10px; border: 2px solid #667eea;">
                <h3 style="color: #2d3561; margin-bottom: 20px; text-align: center;">✏️ إضافة محل إلى خطة التفتيش</h3>
                
                <form id="smartPetShopForm" onsubmit="addPetShopToInspection(event)">
                    <div class="form-group">
                        <label class="form-label">اسم المحل *</label>
                        <input type="text" id="petShopName" class="form-control" required 
                               placeholder="مثال: محل الطيور الجميلة، متجر أسماك الزينة">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">المنطقة *</label>
                        <select id="petShopArea" class="form-control" required>
                            <option value="">اختر المنطقة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">العنوان / الموقع</label>
                        <input type="text" id="petShopAddress" class="form-control" 
                               placeholder="مثال: شارع الشيخ زايد، بالقرب من مول أبوظبي">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">رابط خرائط جوجل (اختياري)</label>
                        <input type="url" id="petShopMapLink" class="form-control" 
                               placeholder="https://maps.google.com/...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">رقم الهاتف (اختياري)</label>
                        <input type="tel" id="petShopPhone" class="form-control" 
                               placeholder="+971 2 123 4567">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">الأولوية</label>
                        <select id="petShopPriority" class="form-control">
                            <option value="normal">عادية</option>
                            <option value="medium">متوسطة</option>
                            <option value="high">عالية</option>
                            <option value="very-high">عالية جداً</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ملاحظات</label>
                        <textarea id="petShopNotes" class="form-control" rows="3" 
                                  placeholder="أي معلومات إضافية عن المحل"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
                        <button type="submit" class="btn btn-success" style="font-size: 1.1em; padding: 15px 30px;">
                            <span>✅</span>
                            <span>إضافة إلى خطة التفتيش</span>
                        </button>
                        <button type="button" onclick="resetPetShopForm()" class="btn btn-warning">
                            <span>🔄</span>
                            <span>إعادة تعيين</span>
                        </button>
                    </div>
                </form>
                
                <div id="petShopStatus" class="status-message" style="margin-top: 20px;"></div>
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
                <button onclick="closeSmartPetShopModal()" class="btn btn-danger">
                    <span>✖️</span>
                    <span>إغلاق</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Comprehensive Report Edit Modal - تعديل شامل للتقارير -->
    <div id="editReportModal" class="modal" style="display: none; z-index: 3500;">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0; margin: -30px -30px 20px -30px;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.3em;">✏️</span>
                    <span>تعديل شامل لبيانات التقرير</span>
                </h2>
                <span class="modal-close" onclick="closeEditReportModal()" style="position: absolute; top: 15px; left: 15px; font-size: 1.8em; cursor: pointer; color: white;">&times;</span>
            </div>
            
            <div style="background: #fff8e1; border: 2px solid #ffcc02; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em;">💡</span>
                    <div>
                        <strong style="color: #f57c00;">نصيحة:</strong>
                        <span style="color: #666;">يمكنك تعديل جميع بيانات التقرير من هنا بما في ذلك الاسم والوصف وتاريخ التفتيش والرافع ونوع التقرير</span>
                    </div>
                </div>
            </div>
            
            <form id="editReportForm" onsubmit="saveReportEdits(event)">
                <input type="hidden" id="editReportFileId">
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">
                        📝 اسم الملف (بالعربي أو الإنجليزي)
                    </label>
                    <input type="text" id="editReportName" class="form-control" required 
                           placeholder="مثال: تقرير التفتيش الجماعي - يناير 2025"
                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">
                        📄 الوصف (بالعربي)
                    </label>
                    <textarea id="editReportDescription" class="form-control" rows="3" 
                              placeholder="وصف مفصل للتقرير باللغة العربية..."
                              style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; resize: vertical;"></textarea>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">
                        📅 تاريخ التفتيش
                    </label>
                    <input type="date" id="editReportInspectionDate" class="form-control"
                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">
                        👤 اسم الرافع
                    </label>
                    <input type="text" id="editReportUploader" class="form-control" 
                           placeholder="مثال: د. علي عبدالعال"
                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">
                        📂 نوع التقرير
                    </label>
                    <select id="editReportCategory" class="form-control"
                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; background: white;">
                        <option value="group_inspection_reports">📋 تقرير تفتيش جماعي</option>
                        <option value="shelter_visit_reports">🏘️ تقرير زيارة ملاجئ</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">
                        👁️ إظهار التقرير
                    </label>
                    <select id="editReportVisible" class="form-control"
                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; background: white;">
                        <option value="true">✅ مرئي للجميع</option>
                        <option value="false">🔒 مخفي</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <button type="submit" class="btn btn-success" style="font-size: 1.1em; padding: 15px 30px; display: flex; align-items: center; gap: 8px;">
                        <span>💾</span>
                        <span>حفظ التعديلات</span>
                    </button>
                    <button type="button" onclick="closeEditReportModal()" class="btn btn-danger" style="font-size: 1.1em; padding: 15px 30px; display: flex; align-items: center; gap: 8px;">
                        <span>✖️</span>
                        <span>إلغاء</span>
                    </button>
                </div>
            </form>
            
            <div id="editReportStatus" class="status-message" style="margin-top: 15px; display: none;"></div>
        </div>
    </div>
    
    <!-- MediaPipe Hands Library -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <!-- Hand Gesture Control Script -->
    <script>
        // Global variables for gesture control
        let gestureControlActive = false;
        let camera = null;
        let hands = null;
        let lastGestureTime = 0;
        let gestureDebounceDelay = 800; // milliseconds between gestures
        let previousHandPosition = null;
        let gestureThreshold = 0.15; // Movement threshold for gesture detection
        
        // Tab management
        const tabs = ['add', 'view', 'stats', 'calendar', 'shops', 'areas', 'maintenance', 'groupInspection', 'shelterInspection'];
        let currentTabIndex = 0;
        
        // Toggle gesture control
        function toggleGestureControl() {
            const modal = document.getElementById('gestureModal');
            const btn = document.getElementById('gestureControlBtn');
            
            if (!gestureControlActive) {
                modal.style.display = 'block';
                btn.classList.add('active');
                initializeGestureControl();
            } else {
                closeGestureControl();
            }
        }
        
        // Close gesture control
        function closeGestureControl() {
            const modal = document.getElementById('gestureModal');
            const btn = document.getElementById('gestureControlBtn');
            
            modal.style.display = 'none';
            btn.classList.remove('active');
            gestureControlActive = false;
            
            // Stop camera and cleanup
            if (camera) {
                camera.stop();
                camera = null;
            }
            
            const video = document.getElementById('gestureVideo');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            updateGestureStatus('تم إيقاف التحكم بحركة اليد', '---', '');
        }
        
        // Initialize gesture control
        async function initializeGestureControl() {
            try {
                gestureControlActive = true;
                updateGestureStatus('جارِ تحميل نموذج الذكاء الاصطناعي...', '⏳', '');
                
                // Initialize MediaPipe Hands
                hands = new Hands({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    }
                });
                
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.7,
                    minTrackingConfidence: 0.7
                });
                
                hands.onResults(onHandsResults);
                
                // Setup camera
                const video = document.getElementById('gestureVideo');
                
                updateGestureStatus('جارِ تشغيل الكاميرا...', '📹', '');
                
                camera = new Camera(video, {
                    onFrame: async () => {
                        if (gestureControlActive) {
                            await hands.send({image: video});
                        }
                    },
                    width: 640,
                    height: 480
                });
                
                await camera.start();
                
                updateGestureStatus('جاهز! حرك يدك أمام الكاميرا', '✅', '');
                
            } catch (error) {
                console.error('Error initializing gesture control:', error);
                updateGestureStatus('خطأ في تشغيل الكاميرا', '❌', 'تأكد من السماح بالوصول إلى الكاميرا');
                
                // Show alert
                alert('فشل تشغيل الكاميرا. يرجى:\n1. السماح بالوصول إلى الكاميرا\n2. التأكد من عدم استخدام الكاميرا في تطبيق آخر\n3. التحقق من أن المتصفح يدعم هذه الميزة');
                
                closeGestureControl();
            }
        }
        
        // Process hand detection results
        function onHandsResults(results) {
            const canvas = document.getElementById('gestureCanvas');
            const canvasCtx = canvas.getContext('2d');
            
            // Set canvas size to match video
            canvas.width = results.image.width;
            canvas.height = results.image.height;
            
            // Clear canvas
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw hand landmarks
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                for (const landmarks of results.multiHandLandmarks) {
                    // Draw connections
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {
                        color: '#00FF00',
                        lineWidth: 3
                    });
                    
                    // Draw landmarks
                    drawLandmarks(canvasCtx, landmarks, {
                        color: '#FF0000',
                        lineWidth: 1,
                        radius: 4
                    });
                }
                
                // Detect gesture
                detectGesture(results.multiHandLandmarks[0]);
            } else {
                updateGestureStatus('جاهز! حرك يدك أمام الكاميرا', '✋', '');
                previousHandPosition = null;
            }
        }
        
        // Detect and process gestures
        function detectGesture(landmarks) {
            const now = Date.now();
            
            // Debounce gestures
            if (now - lastGestureTime < gestureDebounceDelay) {
                return;
            }
            
            // Get key landmarks
            const wrist = landmarks[0];
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const thumbTip = landmarks[4];
            const pinkyTip = landmarks[20];
            
            // Calculate hand center (wrist position)
            const currentPosition = {
                x: wrist.x,
                y: wrist.y,
                z: wrist.z
            };
            
            // Detect gestures based on movement and hand shape
            if (previousHandPosition) {
                const deltaX = currentPosition.x - previousHandPosition.x;
                const deltaY = currentPosition.y - previousHandPosition.y;
                
                // Swipe Right (Hand moves right)
                if (deltaX > gestureThreshold) {
                    executeGesture('swipe-right', 'التمرير لليمين 👉', 'الانتقال للتبويب التالي');
                    lastGestureTime = now;
                }
                // Swipe Left (Hand moves left)
                else if (deltaX < -gestureThreshold) {
                    executeGesture('swipe-left', 'التمرير لليسار 👈', 'الانتقال للتبويب السابق');
                    lastGestureTime = now;
                }
                // Swipe Up (Hand moves up)
                else if (deltaY < -gestureThreshold) {
                    executeGesture('swipe-up', 'التمرير للأعلى 👆', 'التمرير لأعلى الصفحة');
                    lastGestureTime = now;
                }
                // Swipe Down (Hand moves down)
                else if (deltaY > gestureThreshold) {
                    executeGesture('swipe-down', 'التمرير للأسفل 👇', 'التمرير لأسفل الصفحة');
                    lastGestureTime = now;
                }
            }
            
            // Detect hand shapes
            const fingersExtended = countExtendedFingers(landmarks);
            
            // Open palm (all 5 fingers extended)
            if (fingersExtended === 5) {
                if (now - lastGestureTime > gestureDebounceDelay * 2) {
                    updateGestureStatus('جاهز للتحكم', 'راحة اليد المفتوحة ✋', 'جاهز لاستقبال الحركة');
                }
            }
            // Closed fist (no fingers extended)
            else if (fingersExtended === 0) {
                executeGesture('fist', 'قبضة اليد ✊', 'النقر/التفعيل');
                lastGestureTime = now;
            }
            // Index finger pointing (only index extended)
            else if (fingersExtended === 1 && isFingerExtended(landmarks, 8)) {
                if (now - lastGestureTime > gestureDebounceDelay * 2) {
                    updateGestureStatus('تحكم دقيق', 'الإشارة بالسبابة ☝️', 'جاهز للتنقل الدقيق');
                }
            }
            // Peace sign (index and middle extended)
            else if (fingersExtended === 2 && isFingerExtended(landmarks, 8) && isFingerExtended(landmarks, 12)) {
                executeGesture('peace', 'علامة النصر ✌️', 'العودة للصفحة الرئيسية');
                lastGestureTime = now;
            }
            
            // Update previous position
            previousHandPosition = currentPosition;
        }
        
        // Count extended fingers
        function countExtendedFingers(landmarks) {
            let count = 0;
            
            // Thumb (different calculation)
            if (landmarks[4].x < landmarks[3].x) count++;
            
            // Other fingers (8, 12, 16, 20 are tips; 6, 10, 14, 18 are middle joints)
            const fingerIndices = [
                [8, 6],   // Index
                [12, 10], // Middle
                [16, 14], // Ring
                [20, 18]  // Pinky
            ];
            
            for (const [tip, middle] of fingerIndices) {
                if (landmarks[tip].y < landmarks[middle].y) {
                    count++;
                }
            }
            
            return count;
        }
        
        // Check if specific finger is extended
        function isFingerExtended(landmarks, tipIndex) {
            const middleIndex = tipIndex - 2;
            return landmarks[tipIndex].y < landmarks[middleIndex].y;
        }
        
        // Execute gesture action
        function executeGesture(gestureType, gestureName, actionDescription) {
            updateGestureStatus('تم الكشف عن الحركة!', gestureName, actionDescription);
            
            // Perform action based on gesture
            switch(gestureType) {
                case 'swipe-right':
                    navigateToNextTab();
                    break;
                case 'swipe-left':
                    navigateToPreviousTab();
                    break;
                case 'swipe-up':
                    scrollPage(-300);
                    break;
                case 'swipe-down':
                    scrollPage(300);
                    break;
                case 'fist':
                    // Simulate click action
                    playClickSound();
                    break;
                case 'peace':
                    navigateToHome();
                    break;
            }
        }
        
        // Navigate to next tab
        function navigateToNextTab() {
            currentTabIndex = (currentTabIndex + 1) % tabs.length;
            switchTab(tabs[currentTabIndex]);
            playClickSound();
        }
        
        // Navigate to previous tab
        function navigateToPreviousTab() {
            currentTabIndex = (currentTabIndex - 1 + tabs.length) % tabs.length;
            switchTab(tabs[currentTabIndex]);
            playClickSound();
        }
        
        // Scroll page
        function scrollPage(amount) {
            window.scrollBy({
                top: amount,
                behavior: 'smooth'
            });
        }
        
        // Navigate to home
        function navigateToHome() {
            window.location.href = 'index.html';
        }
        
        // Play click sound (if available)
        function playClickSound() {
            try {
                const audio = new Audio();
                audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFA==';
                audio.volume = 0.05; // Very low volume (5%) - comfortable and non-annoying
                audio.play().catch(() => {});
            } catch (error) {
                // Ignore audio errors
            }
        }
        
        // Update gesture status display
        function updateGestureStatus(status, gesture, action) {
            document.getElementById('gestureStatusText').textContent = status;
            document.getElementById('gestureDetected').textContent = gesture;
            document.getElementById('gestureAction').textContent = action;
        }
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('gestureModal');
            if (event.target === modal) {
                closeGestureControl();
            }
        });
        
        // Find current tab index on page load
        function updateCurrentTabIndex() {
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab) {
                const tabText = activeTab.textContent;
                if (tabText.includes('إضافة')) currentTabIndex = 0;
                else if (tabText.includes('عرض')) currentTabIndex = 1;
                else if (tabText.includes('إحصائيات')) currentTabIndex = 2;
                else if (tabText.includes('التقويم')) currentTabIndex = 3;
                else if (tabText.includes('المحلات')) currentTabIndex = 4;
                else if (tabText.includes('المناطق')) currentTabIndex = 5;
                else if (tabText.includes('الصيانة')) currentTabIndex = 6;
                else if (tabText.includes('التفتيش الجماعي')) currentTabIndex = 7;
                else if (tabText.includes('الملاجئ')) currentTabIndex = 8;
            }
        }
        
        // =========================================================================
        // Background Music Volume Control Functions
        // =========================================================================
        
        let currentBackgroundVolume = 1; // Default: 1% (very low, non-annoying)
        
        /**
         * Open volume control modal
         */
        function openVolumeControl() {
            // Load current volume from audio-config.json if available
            loadCurrentVolume();
            
            // Show modal
            document.getElementById('volumeModal').classList.add('show');
        }
        
        /**
         * Close volume control modal
         */
        function closeVolumeControl() {
            document.getElementById('volumeModal').classList.remove('show');
        }
        
        /**
         * Load current volume setting
         */
        async function loadCurrentVolume() {
            try {
                const response = await fetch('audio-config.json?t=' + Date.now());
                if (response.ok) {
                    const config = await response.json();
                    if (config.backgroundMusic && typeof config.backgroundMusic.volume !== 'undefined') {
                        currentBackgroundVolume = Math.round(config.backgroundMusic.volume * 100);
                        updateMainVolumeDisplay(currentBackgroundVolume);
                        document.getElementById('mainVolumeSlider').value = currentBackgroundVolume;
                    }
                }
            } catch (error) {
                console.log('Could not load audio config:', error);
                // Use default value
                currentBackgroundVolume = 1;
                updateMainVolumeDisplay(1);
                document.getElementById('mainVolumeSlider').value = 1;
            }
        }
        
        /**
         * Update volume display in the modal
         */
        function updateMainVolumeDisplay(value) {
            currentBackgroundVolume = parseInt(value);
            const displayElement = document.getElementById('volumeDisplayBig');
            
            let icon = '🔇';
            if (value > 0 && value <= 5) {
                icon = '🔉';
            } else if (value > 5 && value <= 25) {
                icon = '🔊';
            } else if (value > 25) {
                icon = '📢';
            }
            
            displayElement.textContent = `${icon} ${value}%`;
        }
        
        /**
         * Set volume to a preset value
         */
        function setVolumePreset(value) {
            currentBackgroundVolume = value;
            document.getElementById('mainVolumeSlider').value = value;
            updateMainVolumeDisplay(value);
        }
        
        /**
         * Test background music with current volume
         */
        async function testBackgroundMusic() {
            // This will communicate with the main page
            const volume = currentBackgroundVolume / 100;
            
            alert(`🎵 اختبار الصوت\n\n` +
                  `المستوى الحالي: ${currentBackgroundVolume}%\n\n` +
                  `ملاحظة: لاختبار الصوت الفعلي، يرجى:\n` +
                  `1. حفظ الإعدادات\n` +
                  `2. الذهاب إلى الصفحة الرئيسية (index.html)\n` +
                  `3. النقر في أي مكان على الصفحة لتشغيل الموسيقى`);
        }
        
        /**
         * Save volume settings to GitHub
         */
        async function saveVolumeSettings() {
            if (!githubToken) {
                alert('⚠️ يجب تسجيل الدخول أولاً للحفظ على GitHub');
                return;
            }
            
            try {
                const volume = currentBackgroundVolume / 100; // Convert to decimal (0.0 - 1.0)
                
                // Load current audio-config.json
                const getResponse = await fetch(`https://api.github.com/repos/${repo}/contents/audio-config.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error('فشل في تحميل ملف audio-config.json');
                }
                
                const fileData = await getResponse.json();
                const sha = fileData.sha;
                
                // Decode and parse current config
                const currentContent = decodeURIComponent(escape(atob(fileData.content)));
                let audioConfig = JSON.parse(currentContent);
                
                // Update background music volume
                if (!audioConfig.backgroundMusic) {
                    audioConfig.backgroundMusic = {};
                }
                audioConfig.backgroundMusic.volume = volume;
                audioConfig.backgroundMusic.enabled = true; // Enable background music when volume is set
                audioConfig.lastUpdate = new Date().toISOString();
                
                // Encode and save
                const newContent = JSON.stringify(audioConfig, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(newContent)));
                
                const updateResponse = await fetch(`https://api.github.com/repos/${repo}/contents/audio-config.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `تحديث مستوى صوت الموسيقى الخلفية إلى ${currentBackgroundVolume}%`,
                        content: encodedContent,
                        sha: sha,
                        branch: 'main'
                    })
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.message || 'فشل في حفظ الإعدادات');
                }
                
                alert(`✅ تم حفظ الإعدادات بنجاح!\n\n` +
                      `مستوى الصوت الجديد: ${currentBackgroundVolume}%\n\n` +
                      `💡 للاستماع إلى التغييرات:\n` +
                      `1. انتقل إلى الصفحة الرئيسية (index.html)\n` +
                      `2. انقر في أي مكان على الصفحة لتشغيل الموسيقى\n` +
                      `3. ستسمع الموسيقى بالمستوى الجديد`);
                
                // Close modal after successful save
                setTimeout(() => {
                    closeVolumeControl();
                }, 2000);
                
            } catch (error) {
                console.error('Error saving volume settings:', error);
                alert(`❌ خطأ في حفظ الإعدادات: ${error.message}\n\n` +
                      `تأكد من:\n` +
                      `1. صحة توكن GitHub\n` +
                      `2. اتصالك بالإنترنت\n` +
                      `3. صلاحيات الوصول للمستودع`);
            }
        }
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('volumeModal');
            if (event.target === modal) {
                closeVolumeControl();
            }
        });
        
        // Initialize volume control on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎵 نظام التحكم في الصوت جاهز');
        });
        
        // ========================================
        // Group Inspection Management Functions
        // ========================================
        
        // Initialize group inspection tab
        function initializeGroupInspection() {
            // Populate areas dropdown for group inspection
            const areaSelect = document.getElementById('smartGroupFormArea');
            if (areaSelect) {
                areaSelect.innerHTML = '<option value="">اختر المنطقة</option>';
                if (planData && planData.areas) {
                    planData.areas.forEach(area => {
                        const option = document.createElement('option');
                        option.value = area.id || area.name;
                        option.textContent = area.name;
                        areaSelect.appendChild(option);
                    });
                }
            }
            
            // Populate inspectors checkboxes for group inspection
            const checkboxContainer = document.getElementById('smartGroupInspectorsCheckboxes');
            if (checkboxContainer) {
                checkboxContainer.innerHTML = '';
                if (planData && planData.inspectors) {
                    planData.inspectors.forEach(inspector => {
                        const label = document.createElement('label');
                        label.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;';
                        label.onmouseover = function() { this.style.borderColor = '#ff9800'; this.style.background = '#fff3e0'; };
                        label.onmouseout = function() { this.style.borderColor = 'transparent'; this.style.background = '#f8f9fa'; };
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = inspector.name;
                        checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';
                        
                        const span = document.createElement('span');
                        span.textContent = inspector.name;
                        span.style.cssText = 'font-size: 0.95em;';
                        
                        label.appendChild(checkbox);
                        label.appendChild(span);
                        checkboxContainer.appendChild(label);
                    });
                }
            }
            
            // Render the group inspections table
            renderSmartGroupInspectionTable();
        }
        
        // Render group inspection table
        function renderSmartGroupInspectionTable() {
            const container = document.getElementById('smartGroupInspectionTableContainer');
            if (!container) return;
            
            // Initialize groupInspectionData if it doesn't exist
            if (!planData.groupInspectionData) {
                planData.groupInspectionData = [];
            }
            
            // Check if user is a developer
            const isDevUser = isDeveloper();
            
            if (!planData.groupInspectionData || planData.groupInspectionData.length === 0) {
                const emptyMessage = isDevUser 
                    ? 'لا توجد تفتيشات جماعية حالياً. قم بإضافة تفتيش جماعي جديد باستخدام النموذج أعلاه.'
                    : 'لا توجد تفتيشات جماعية حالياً.';
                container.innerHTML = `
                    <p style="text-align: center; color: #999; padding: 40px 20px;">
                        ${emptyMessage}
                    </p>
                `;
                return;
            }
            
            // Helper function to check if a date is in the past
            function isDateInPast(dateStr) {
                const inspectionDate = new Date(dateStr);
                const today = new Date();
                // Set time to start of day for both dates to compare only dates
                inspectionDate.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);
                return inspectionDate < today;
            }
            
            // Filter out past inspections - only show today and future inspections
            const upcomingInspections = planData.groupInspectionData.filter((item, idx) => {
                return !isDateInPast(item.day);
            });
            
            // If no upcoming inspections, show message
            if (upcomingInspections.length === 0) {
                const emptyMessage = isDevUser 
                    ? 'لا توجد تفتيشات جماعية قادمة. جميع التفتيشات المجدولة قد انتهت.<br>قم بإضافة تفتيش جماعي جديد باستخدام النموذج أعلاه.'
                    : 'لا توجد تفتيشات جماعية قادمة. جميع التفتيشات المجدولة قد انتهت.';
                container.innerHTML = `
                    <p style="text-align: center; color: #999; padding: 40px 20px;">
                        ${emptyMessage}
                    </p>
                `;
                return;
            }
            
            // Helper function to get area name
            function getAreaName(areaIdOrName) {
                if (!planData.areas) return areaIdOrName;
                const area = planData.areas.find(a => a.id === areaIdOrName || a.name === areaIdOrName);
                return area ? area.name : areaIdOrName;
            }
            
            // Helper function to get Arabic day name
            function getArabicDayName(dateStr) {
                const days = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                const date = new Date(dateStr);
                return days[date.getDay()];
            }
            
            // Build table header - different for developers vs viewers
            const actionsHeader = isDevUser 
                ? '<th style="padding: 15px; text-align: center; border-bottom: 2px solid #e65100;">الإجراءات</th>'
                : '<th style="padding: 15px; text-align: center; border-bottom: 2px solid #e65100;">عرض</th>';
            
            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white;">
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid #e65100;">عرض المفتشين</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid #e65100;">التاريخ</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid #e65100;">المناوبة</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid #e65100;">المنطقة</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid #e65100;">المحلات</th>
                                ${actionsHeader}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Iterate over upcoming inspections only, but keep original index for edit/delete
            upcomingInspections.forEach((item) => {
                // Find the original index in the full array for edit/delete operations
                const originalIdx = planData.groupInspectionData.indexOf(item);
                const areaName = getAreaName(item.area);
                const dayName = getArabicDayName(item.day);
                
                const inspectorsBadges = item.inspectors.map(inspector => 
                    `<span style="display: inline-block; background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.85em; margin: 2px; white-space: nowrap;">👤 ${inspector}</span>`
                ).join('');
                
                // Build action buttons based on role
                let actionButtons = '';
                if (isDevUser) {
                    // Developer: Full CRUD buttons (Edit, Update, Delete)
                    actionButtons = `
                        <button onclick="editSmartGroupInspection(${originalIdx})" class="btn btn-sm" style="background: #2196f3; color: white; padding: 6px 12px; margin: 2px; border: none; border-radius: 5px; cursor: pointer;">
                            ✏️ تعديل
                        </button>
                        <button onclick="deleteSmartGroupInspection(${originalIdx})" class="btn btn-sm" style="background: #f44336; color: white; padding: 6px 12px; margin: 2px; border: none; border-radius: 5px; cursor: pointer;">
                            🗑️ حذف
                        </button>
                    `;
                } else {
                    // Viewer: Only view button (no edit/delete)
                    actionButtons = `
                        <button onclick="viewGroupInspectionDetails(${originalIdx})" class="btn btn-sm" style="background: #4caf50; color: white; padding: 6px 12px; margin: 2px; border: none; border-radius: 5px; cursor: pointer;">
                            👁️ عرض
                        </button>
                    `;
                }
                
                html += `
                    <tr style="border-bottom: 1px solid #eee; transition: background 0.2s;" onmouseover="this.style.background='#fff3e0'" onmouseout="this.style.background='white'">
                        <td style="padding: 12px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                ${inspectorsBadges}
                            </div>
                        </td>
                        <td style="padding: 12px; font-family: 'Cairo', Arial, sans-serif;">
                            <div style="line-height: 1.4;">
                                <div style="font-weight: 600;">${item.day}</div>
                                <div style="font-size: 0.85em; color: #666;">${dayName}</div>
                            </div>
                        </td>
                        <td style="padding: 12px;">
                            <span style="display: inline-block; background: ${item.shift === 'صباحية' ? '#e8f5e8' : '#fff3e0'}; color: ${item.shift === 'صباحية' ? '#2e7d32' : '#ef6c00'}; padding: 6px 12px; border-radius: 10px; font-size: 0.9em; border: 1px solid ${item.shift === 'صباحية' ? '#c8e6c9' : '#ffcc02'};">
                                ${item.shift === 'صباحية' ? '🌅' : '🌆'} ${item.shift}
                            </span>
                        </td>
                        <td style="padding: 12px; font-weight: 600; color: ${areaName === 'سوق الميناء' || areaName === 'سوق التراث' ? '#1976d2' : '#d32f2f'};">
                            ${areaName}
                        </td>
                        <td style="padding: 12px; font-weight: 600;">
                            ${item.shopName}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Update group form shops dropdown based on selected area
        // IMPORTANT: This function shows ALL shops in the selected area
        // No duplicate prevention or filtering logic is applied here
        // All shops appear in the dropdown regardless of previous inspection assignments
        function updateGroupFormShops() {
            const areaSelect = document.getElementById('smartGroupFormArea');
            const shopSelect = document.getElementById('smartGroupFormShopName');
            
            if (!areaSelect || !shopSelect) return;
            
            const selectedAreaIdOrName = areaSelect.value;
            
            // Clear current options
            shopSelect.innerHTML = '<option value="">اختر المحل</option>';
            
            if (!selectedAreaIdOrName) {
                return;
            }
            
            // Get area name from ID or use as-is
            let areaName = selectedAreaIdOrName;
            if (planData && planData.areas) {
                const areaObj = planData.areas.find(a => a.id === selectedAreaIdOrName);
                if (areaObj) {
                    areaName = areaObj.name;
                }
            }
            
            // Get all shops for the selected area (including Al-Wathba South "الوثبة جنوب")
            // All shops are included - no filtering applied
            if (planData && planData.shops) {
                const areaShops = planData.shops.filter(shop => shop.area === areaName);
                
                // Sort shops alphabetically
                areaShops.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                
                // Add shops to dropdown
                areaShops.forEach(shop => {
                    const option = document.createElement('option');
                    option.value = shop.name;
                    option.textContent = shop.name;
                    shopSelect.appendChild(option);
                });
                
                if (areaShops.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'لا توجد محلات في هذه المنطقة';
                    option.disabled = true;
                    shopSelect.appendChild(option);
                }
            }
        }
        
        // Update shelter form shelters dropdown based on selected area
        // IMPORTANT: This function shows ALL shelters in the selected area
        // No duplicate prevention or filtering logic is applied here
        function updateShelterFormShelters() {
            const areaSelect = document.getElementById('smartShelterFormArea');
            const shelterSelect = document.getElementById('smartShelterFormShelterName');
            
            if (!areaSelect || !shelterSelect) return;
            
            const selectedAreaIdOrName = areaSelect.value;
            
            // Clear current options
            shelterSelect.innerHTML = '<option value="">اختر الملجأ</option>';
            
            if (!selectedAreaIdOrName) {
                return;
            }
            
            // Get area name from ID or use as-is
            let areaName = selectedAreaIdOrName;
            if (planData && planData.areas) {
                const areaObj = planData.areas.find(a => a.id === selectedAreaIdOrName);
                if (areaObj) {
                    areaName = areaObj.name;
                }
            }
            
            // Get all shops for the selected area (treating shops as shelters in this context)
            // All shelters are included - no filtering applied
            if (planData && planData.shops) {
                const areaShelters = planData.shops.filter(shop => shop.area === areaName);
                
                // Sort shelters alphabetically
                areaShelters.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                
                // Add shelters to dropdown
                areaShelters.forEach(shelter => {
                    const option = document.createElement('option');
                    option.value = shelter.name;
                    option.textContent = shelter.name;
                    shelterSelect.appendChild(option);
                });
                
                if (areaShelters.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'لا توجد ملاجئ في هذه المنطقة';
                    option.disabled = true;
                    shelterSelect.appendChild(option);
                }
            }
        }
        
        // Handle group inspection form submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('smartGroupInspectionForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const day = document.getElementById('smartGroupFormDay').value;
                    const shift = document.getElementById('smartGroupFormShift').value;
                    const areaIdOrName = document.getElementById('smartGroupFormArea').value;
                    const shopName = document.getElementById('smartGroupFormShopName').value.trim();
                    
                    // Get selected inspectors from checkboxes
                    const checkboxes = document.querySelectorAll('#smartGroupInspectorsCheckboxes input[type="checkbox"]:checked');
                    const inspectors = Array.from(checkboxes).map(cb => cb.value);
                    
                    const editingIdx = document.getElementById('smartGroupFormEditingIndex').value;
                    
                    // Validation
                    if (!day || !shift || !areaIdOrName || !shopName) {
                        showGroupInspectionStatus('⚠️ يرجى تعبئة جميع الحقول المطلوبة!', 'error');
                        return;
                    }
                    
                    if (inspectors.length < 2) {
                        showGroupInspectionStatus('⚠️ يجب اختيار مفتشين اثنين على الأقل!', 'error');
                        return;
                    }
                    
                    // Convert area ID to name
                    let areaName = areaIdOrName;
                    if (planData && planData.areas) {
                        const areaObj = planData.areas.find(a => a.id === areaIdOrName);
                        if (areaObj) {
                            areaName = areaObj.name;
                        }
                    }
                    
                    const newGroupInspection = {
                        day,
                        shift,
                        area: areaName,
                        shopName,
                        inspectors,
                        reportUrl: null
                    };
                    
                    // Initialize groupInspectionData if it doesn't exist
                    if (!planData.groupInspectionData) {
                        planData.groupInspectionData = [];
                    }
                    
                    if (editingIdx === "") {
                        // Add new
                        planData.groupInspectionData.push(newGroupInspection);
                        showGroupInspectionStatus('✅ تم إضافة التفتيش الجماعي بنجاح!', 'success');
                    } else {
                        // Edit existing
                        if (planData.groupInspectionData[editingIdx] && planData.groupInspectionData[editingIdx].reportUrl) {
                            newGroupInspection.reportUrl = planData.groupInspectionData[editingIdx].reportUrl;
                        }
                        planData.groupInspectionData[editingIdx] = newGroupInspection;
                        showGroupInspectionStatus('✅ تم تعديل التفتيش الجماعي بنجاح!', 'success');
                    }
                    
                    // Save to GitHub
                    try {
                        await savePlanDataToGitHub();
                        renderSmartGroupInspectionTable();
                        
                        // Reset form
                        form.reset();
                        document.getElementById('smartGroupFormEditingIndex').value = "";
                        document.getElementById('smartGroupFormSubmitText').textContent = "إضافة تفتيش جماعي";
                        document.getElementById('smartGroupFormCancelBtn').style.display = 'none';
                        
                        // Uncheck all checkboxes
                        document.querySelectorAll('#smartGroupInspectorsCheckboxes input[type="checkbox"]').forEach(cb => {
                            cb.checked = false;
                        });
                    } catch (error) {
                        console.error('Error saving group inspection:', error);
                        showGroupInspectionStatus('❌ حدث خطأ أثناء الحفظ: ' + error.message, 'error');
                    }
                });
            }
        });
        
        // Edit group inspection
        function editSmartGroupInspection(idx) {
            if (!planData.groupInspectionData || !planData.groupInspectionData[idx]) return;
            
            const item = planData.groupInspectionData[idx];
            
            document.getElementById('smartGroupFormDay').value = item.day;
            document.getElementById('smartGroupFormShift').value = item.shift;
            
            // Set area
            if (planData && planData.areas) {
                const areaObj = planData.areas.find(a => a.name === item.area);
                document.getElementById('smartGroupFormArea').value = areaObj ? (areaObj.id || areaObj.name) : item.area;
            } else {
                document.getElementById('smartGroupFormArea').value = item.area;
            }
            
            // Update shops dropdown based on selected area
            updateGroupFormShops();
            
            // Set shop name
            document.getElementById('smartGroupFormShopName').value = item.shopName;
            
            // Check inspectors
            const checkboxes = document.querySelectorAll('#smartGroupInspectorsCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = item.inspectors.includes(cb.value);
            });
            
            document.getElementById('smartGroupFormEditingIndex').value = idx;
            document.getElementById('smartGroupFormSubmitText').textContent = "حفظ التعديلات";
            document.getElementById('smartGroupFormCancelBtn').style.display = 'inline-block';
            
            // Scroll to form
            document.querySelector('#groupInspectionTab .section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Cancel group inspection edit
        function cancelGroupInspectionEdit() {
            const form = document.getElementById('smartGroupInspectionForm');
            if (form) {
                form.reset();
            }
            
            document.getElementById('smartGroupFormEditingIndex').value = "";
            document.getElementById('smartGroupFormSubmitText').textContent = "إضافة تفتيش جماعي";
            document.getElementById('smartGroupFormCancelBtn').style.display = 'none';
            
            // Uncheck all checkboxes
            document.querySelectorAll('#smartGroupInspectorsCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }
        
        // View group inspection details (for viewers - read-only)
        function viewGroupInspectionDetails(idx) {
            if (!planData.groupInspectionData || !planData.groupInspectionData[idx]) return;
            
            const item = planData.groupInspectionData[idx];
            const days = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            const dayName = days[new Date(item.day).getDay()];
            
            // Create view modal
            const modal = document.createElement('div');
            modal.id = 'viewGroupInspectionModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 1.4em;">👁️ تفاصيل التفتيش الجماعي</h3>
                            <button onclick="document.getElementById('viewGroupInspectionModal').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.3em;">×</button>
                        </div>
                    </div>
                    <div style="padding: 25px;">
                        <div style="display: grid; gap: 15px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-right: 4px solid #ff9800;">
                                <strong style="color: #ff9800;">📅 التاريخ:</strong>
                                <div style="margin-top: 5px; font-size: 1.1em;">${item.day} (${dayName})</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-right: 4px solid #4caf50;">
                                <strong style="color: #4caf50;">🕐 المناوبة:</strong>
                                <div style="margin-top: 5px; font-size: 1.1em;">${item.shift === 'صباحية' ? '🌅' : '🌆'} ${item.shift}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-right: 4px solid #2196f3;">
                                <strong style="color: #2196f3;">📍 المنطقة:</strong>
                                <div style="margin-top: 5px; font-size: 1.1em;">${item.area}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-right: 4px solid #9c27b0;">
                                <strong style="color: #9c27b0;">🏪 المحل:</strong>
                                <div style="margin-top: 5px; font-size: 1.1em;">${item.shopName}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-right: 4px solid #009688;">
                                <strong style="color: #009688;">👥 المفتشون:</strong>
                                <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${item.inspectors.map(inspector => `<span style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.9em;">👤 ${inspector}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 25px; text-align: center;">
                            <button onclick="document.getElementById('viewGroupInspectionModal').remove()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold;">
                                إغلاق
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Delete group inspection
        async function deleteSmartGroupInspection(idx) {
            if (!planData.groupInspectionData || !planData.groupInspectionData[idx]) return;
            
            const item = planData.groupInspectionData[idx];
            const confirmMsg = `هل تريد حذف هذا التفتيش الجماعي نهائياً؟\n\nالمحل: ${item.shopName}\nالتاريخ: ${item.day}\nالمفتشين: ${item.inspectors.join(', ')}`;
            
            if (!confirm(confirmMsg)) return;
            
            planData.groupInspectionData.splice(idx, 1);
            
            try {
                await savePlanDataToGitHub();
                renderSmartGroupInspectionTable();
                showGroupInspectionStatus('✅ تم حذف التفتيش الجماعي بنجاح!', 'success');
            } catch (error) {
                console.error('Error deleting group inspection:', error);
                showGroupInspectionStatus('❌ حدث خطأ أثناء الحذف: ' + error.message, 'error');
            }
        }
        
        // Show status message for group inspection
        function showGroupInspectionStatus(message, type) {
            const statusDiv = document.getElementById('groupInspectionStatus');
            if (!statusDiv) return;
            
            statusDiv.textContent = message;
            statusDiv.className = 'status-message ' + type;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // ========================================
        // End of Group Inspection Management
        // ========================================
        
        // ========================================
        // Shelter Inspection Management Functions
        // ========================================
        
        // Initialize shelter inspection tab
        function initializeShelterInspection() {
            // Populate areas dropdown for shelter inspection
            const areaSelect = document.getElementById('smartShelterFormArea');
            if (areaSelect) {
                areaSelect.innerHTML = '<option value="">اختر المنطقة</option>';
                if (planData && planData.areas) {
                    planData.areas.forEach(area => {
                        const option = document.createElement('option');
                        option.value = area.id || area.name;
                        option.textContent = area.name;
                        areaSelect.appendChild(option);
                    });
                }
            }
            
            // Populate inspectors checkboxes for shelter inspection
            const checkboxContainer = document.getElementById('smartShelterInspectorsCheckboxes');
            if (checkboxContainer) {
                checkboxContainer.innerHTML = '';
                if (planData && planData.inspectors) {
                    planData.inspectors.forEach(inspector => {
                        const label = document.createElement('label');
                        label.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;';
                        label.onmouseover = function() { this.style.borderColor = '#9c27b0'; this.style.background = '#f3e5f5'; };
                        label.onmouseout = function() { this.style.borderColor = 'transparent'; this.style.background = '#f8f9fa'; };
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = inspector.name;
                        checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';
                        
                        const span = document.createElement('span');
                        span.textContent = inspector.name;
                        span.style.cssText = 'font-size: 0.95em;';
                        
                        label.appendChild(checkbox);
                        label.appendChild(span);
                        checkboxContainer.appendChild(label);
                    });
                }
            }
            
            // Render the shelter inspections table
            renderSmartShelterInspectionTable();
        }
        
        // Render shelter inspection table
        function renderSmartShelterInspectionTable() {
            const container = document.getElementById('smartShelterInspectionTableContainer');
            if (!container) return;
            
            // Initialize shelterInspectionData if it doesn't exist
            if (!planData.shelterInspectionData) {
                planData.shelterInspectionData = [];
            }
            
            // Check if user is a developer
            const isDevUser = isDeveloper();
            
            if (!planData.shelterInspectionData || planData.shelterInspectionData.length === 0) {
                const emptyMessage = isDevUser 
                    ? 'لا توجد خطط تفتيش ملاجئ حالياً. قم بإضافة خطة جديدة باستخدام النموذج أعلاه.'
                    : 'لا توجد خطط تفتيش ملاجئ حالياً.';
                container.innerHTML = `
                    <p style="text-align: center; color: #999; padding: 40px 20px;">
                        ${emptyMessage}
                    </p>
                `;
                return;
            }
            
            // Helper function to check if a date is in the past
            function isDateInPast(dateStr) {
                const inspectionDate = new Date(dateStr);
                const today = new Date();
                // Set time to start of day for both dates to compare only dates
                inspectionDate.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);
                return inspectionDate < today;
            }
            
            // Filter out past inspections - only show today and future inspections
            const upcomingInspections = planData.shelterInspectionData.filter((item) => {
                return !isDateInPast(item.day);
            });
            
            // If no upcoming inspections, show message
            if (upcomingInspections.length === 0) {
                const emptyMessage = isDevUser 
                    ? 'لا توجد خطط تفتيش ملاجئ قادمة. جميع خطط التفتيش المجدولة قد انتهت.<br>قم بإضافة خطة تفتيش جديدة باستخدام النموذج أعلاه.'
                    : 'لا توجد خطط تفتيش ملاجئ قادمة. جميع خطط التفتيش المجدولة قد انتهت.';
                container.innerHTML = `
                    <p style="text-align: center; color: #999; padding: 40px 20px;">
                        ${emptyMessage}
                    </p>
                `;
                return;
            }
            
            // Helper function to get Arabic day name
            function getArabicDayName(dateStr) {
                const days = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                const date = new Date(dateStr);
                return days[date.getDay()];
            }
            
            // Build table header - different for developers vs viewers
            const actionsHeader = isDevUser 
                ? '<th style="padding: 15px; text-align: center; border-bottom: 2px solid #6a1b9a;">الإجراءات</th>'
                : '<th style="padding: 15px; text-align: center; border-bottom: 2px solid #6a1b9a;">عرض</th>';
            
            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white;">
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid #6a1b9a;">المفتشون</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid #6a1b9a;">التاريخ</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid #6a1b9a;">المناوبة</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid #6a1b9a;">المنطقة</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid #6a1b9a;">الملجأ</th>
                                <th style="padding: 15px; text-align: right; border-bottom: 2px solid #6a1b9a;">الملاحظات</th>
                                ${actionsHeader}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Iterate over upcoming inspections only, but keep original index for edit/delete
            upcomingInspections.forEach((item) => {
                // Find the original index in the full array for edit/delete operations
                const originalIdx = planData.shelterInspectionData.indexOf(item);
                const dayName = getArabicDayName(item.day);
                
                const inspectorsBadges = item.inspectors.map(inspector => 
                    `<span style="display: inline-block; background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.85em; margin: 2px; white-space: nowrap;">👤 ${inspector}</span>`
                ).join('');
                
                const notes = item.notes ? item.notes : 'لا توجد ملاحظات';
                
                // Handle both old format (item.location) and new format (item.area)
                const areaName = item.area || item.location;
                
                // Build action buttons based on role
                let actionButtons = '';
                if (isDevUser) {
                    // Developer: Full CRUD buttons (Edit, Update, Delete)
                    actionButtons = `
                        <button onclick="editSmartShelterInspection(${originalIdx})" class="btn btn-sm" style="background: #2196f3; color: white; padding: 6px 12px; margin: 2px; border: none; border-radius: 5px; cursor: pointer;">
                            ✏️ تعديل
                        </button>
                        <button onclick="deleteSmartShelterInspection(${originalIdx})" class="btn btn-sm" style="background: #f44336; color: white; padding: 6px 12px; margin: 2px; border: none; border-radius: 5px; cursor: pointer;">
                            🗑️ حذف
                        </button>
                    `;
                } else {
                    // Viewer: Only view button (no edit/delete)
                    actionButtons = `
                        <button onclick="viewShelterInspectionDetails(${originalIdx})" class="btn btn-sm" style="background: #4caf50; color: white; padding: 6px 12px; margin: 2px; border: none; border-radius: 5px; cursor: pointer;">
                            👁️ عرض
                        </button>
                    `;
                }
                
                html += `
                    <tr style="border-bottom: 1px solid #eee; transition: background 0.2s;" onmouseover="this.style.background='#f3e5f5'" onmouseout="this.style.background='white'">
                        <td style="padding: 12px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                ${inspectorsBadges}
                            </div>
                        </td>
                        <td style="padding: 12px; font-family: 'Cairo', Arial, sans-serif;">
                            <div style="line-height: 1.4;">
                                <div style="font-weight: 600;">${item.day}</div>
                                <div style="font-size: 0.85em; color: #666;">${dayName}</div>
                            </div>
                        </td>
                        <td style="padding: 12px;">
                            <span style="display: inline-block; background: ${item.shift === 'صباحية' ? '#e8f5e8' : '#fff3e0'}; color: ${item.shift === 'صباحية' ? '#2e7d32' : '#ef6c00'}; padding: 6px 12px; border-radius: 10px; font-size: 0.9em; border: 1px solid ${item.shift === 'صباحية' ? '#c8e6c9' : '#ffcc02'};">
                                ${item.shift === 'صباحية' ? '🌅' : '🌆'} ${item.shift}
                            </span>
                        </td>
                        <td style="padding: 12px; font-weight: 600; color: #9c27b0;">
                            ${areaName}
                        </td>
                        <td style="padding: 12px; font-weight: 600;">
                            ${item.shelterName}
                        </td>
                        <td style="padding: 12px; color: #666; font-size: 0.9em;">
                            ${notes}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Handle shelter inspection form submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('smartShelterInspectionForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const day = document.getElementById('smartShelterFormDay').value;
                    const shift = document.getElementById('smartShelterFormShift').value;
                    const areaIdOrName = document.getElementById('smartShelterFormArea').value;
                    const shelterName = document.getElementById('smartShelterFormShelterName').value;
                    const notes = document.getElementById('smartShelterFormNotes').value.trim();
                    
                    // Get selected inspectors from checkboxes
                    const checkboxes = document.querySelectorAll('#smartShelterInspectorsCheckboxes input[type="checkbox"]:checked');
                    const inspectors = Array.from(checkboxes).map(cb => cb.value);
                    
                    const editingIdx = document.getElementById('smartShelterFormEditingIndex').value;
                    
                    // Validation
                    if (!day || !shift || !areaIdOrName || !shelterName) {
                        showShelterInspectionStatus('⚠️ يرجى تعبئة جميع الحقول المطلوبة!', 'error');
                        return;
                    }
                    
                    if (inspectors.length < 1) {
                        showShelterInspectionStatus('⚠️ يجب اختيار مفتش واحد على الأقل!', 'error');
                        return;
                    }
                    
                    // Get area name from ID or use as-is
                    let areaName = areaIdOrName;
                    if (planData && planData.areas) {
                        const areaObj = planData.areas.find(a => a.id === areaIdOrName);
                        if (areaObj) {
                            areaName = areaObj.name;
                        }
                    }
                    
                    const newShelterInspection = {
                        day,
                        shift,
                        area: areaName,
                        shelterName,
                        inspectors,
                        notes,
                        reportUrl: null
                    };
                    
                    // Initialize shelterInspectionData if it doesn't exist
                    if (!planData.shelterInspectionData) {
                        planData.shelterInspectionData = [];
                    }
                    
                    if (editingIdx === "") {
                        // Add new
                        planData.shelterInspectionData.push(newShelterInspection);
                        showShelterInspectionStatus('✅ تم إضافة خطة تفتيش الملجأ بنجاح!', 'success');
                    } else {
                        // Edit existing
                        if (planData.shelterInspectionData[editingIdx] && planData.shelterInspectionData[editingIdx].reportUrl) {
                            newShelterInspection.reportUrl = planData.shelterInspectionData[editingIdx].reportUrl;
                        }
                        planData.shelterInspectionData[editingIdx] = newShelterInspection;
                        showShelterInspectionStatus('✅ تم تعديل خطة تفتيش الملجأ بنجاح!', 'success');
                    }
                    
                    // Save to GitHub
                    try {
                        await savePlanDataToGitHub();
                        renderSmartShelterInspectionTable();
                        
                        // Reset form
                        form.reset();
                        document.getElementById('smartShelterFormEditingIndex').value = "";
                        document.getElementById('smartShelterFormSubmitText').textContent = "إضافة خطة تفتيش";
                        document.getElementById('smartShelterFormCancelBtn').style.display = 'none';
                        
                        // Uncheck all checkboxes
                        document.querySelectorAll('#smartShelterInspectorsCheckboxes input[type="checkbox"]').forEach(cb => {
                            cb.checked = false;
                        });
                    } catch (error) {
                        console.error('Error saving shelter inspection:', error);
                        showShelterInspectionStatus('❌ حدث خطأ أثناء الحفظ: ' + error.message, 'error');
                    }
                });
            }
        });
        
        // Edit shelter inspection
        function editSmartShelterInspection(idx) {
            if (!planData.shelterInspectionData || !planData.shelterInspectionData[idx]) return;
            
            const item = planData.shelterInspectionData[idx];
            
            document.getElementById('smartShelterFormDay').value = item.day;
            document.getElementById('smartShelterFormShift').value = item.shift;
            
            // Set area dropdown - handle both old format (item.location) and new format (item.area)
            const areaValue = item.area || item.location;
            if (planData && planData.areas) {
                const areaObj = planData.areas.find(a => a.name === areaValue);
                document.getElementById('smartShelterFormArea').value = areaObj ? (areaObj.id || areaObj.name) : areaValue;
            } else {
                document.getElementById('smartShelterFormArea').value = areaValue;
            }
            
            // Update shelters dropdown and set selected shelter
            updateShelterFormShelters();
            document.getElementById('smartShelterFormShelterName').value = item.shelterName;
            
            document.getElementById('smartShelterFormNotes').value = item.notes || '';
            
            // Check inspectors
            const checkboxes = document.querySelectorAll('#smartShelterInspectorsCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = item.inspectors.includes(cb.value);
            });
            
            document.getElementById('smartShelterFormEditingIndex').value = idx;
            document.getElementById('smartShelterFormSubmitText').textContent = "حفظ التعديلات";
            document.getElementById('smartShelterFormCancelBtn').style.display = 'inline-block';
            
            // Scroll to form
            document.querySelector('#shelterInspectionTab .section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Cancel shelter inspection edit
        function cancelShelterInspectionEdit() {
            const form = document.getElementById('smartShelterInspectionForm');
            if (form) {
                form.reset();
            }
            
            document.getElementById('smartShelterFormEditingIndex').value = "";
            document.getElementById('smartShelterFormSubmitText').textContent = "إضافة خطة تفتيش";
            document.getElementById('smartShelterFormCancelBtn').style.display = 'none';
            
            // Uncheck all checkboxes
            document.querySelectorAll('#smartShelterInspectorsCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }
        
        // Delete shelter inspection
        async function deleteSmartShelterInspection(idx) {
            if (!planData.shelterInspectionData || !planData.shelterInspectionData[idx]) return;
            
            const item = planData.shelterInspectionData[idx];
            const confirmMsg = `هل تريد حذف خطة تفتيش هذا الملجأ نهائياً؟\n\nالملجأ: ${item.shelterName}\nالموقع: ${item.location}\nالتاريخ: ${item.day}\nالمفتشين: ${item.inspectors.join(', ')}`;
            
            if (!confirm(confirmMsg)) return;
            
            planData.shelterInspectionData.splice(idx, 1);
            
            try {
                await savePlanDataToGitHub();
                renderSmartShelterInspectionTable();
                showShelterInspectionStatus('✅ تم حذف خطة تفتيش الملجأ بنجاح!', 'success');
            } catch (error) {
                console.error('Error deleting shelter inspection:', error);
                showShelterInspectionStatus('❌ حدث خطأ أثناء الحذف: ' + error.message, 'error');
            }
        }
        
        // Show status message for shelter inspection
        function showShelterInspectionStatus(message, type) {
            const statusDiv = document.getElementById('shelterInspectionStatus');
            if (!statusDiv) return;
            
            statusDiv.textContent = message;
            statusDiv.className = 'status-message ' + type;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // View shelter inspection details (for viewers - read-only)
        function viewShelterInspectionDetails(idx) {
            if (!planData.shelterInspectionData || !planData.shelterInspectionData[idx]) return;
            
            const item = planData.shelterInspectionData[idx];
            const days = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            const dayName = days[new Date(item.day).getDay()];
            const areaName = item.area || item.location;
            const notes = item.notes ? item.notes : 'لا توجد ملاحظات';
            
            // Create view modal
            const modal = document.createElement('div');
            modal.id = 'viewShelterInspectionModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 1.4em;">👁️ تفاصيل زيارة الملجأ</h3>
                            <button onclick="document.getElementById('viewShelterInspectionModal').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.3em;">×</button>
                        </div>
                    </div>
                    <div style="padding: 25px;">
                        <div style="display: grid; gap: 15px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-right: 4px solid #9c27b0;">
                                <strong style="color: #9c27b0;">📅 التاريخ:</strong>
                                <div style="margin-top: 5px; font-size: 1.1em;">${item.day} (${dayName})</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-right: 4px solid #4caf50;">
                                <strong style="color: #4caf50;">🕐 المناوبة:</strong>
                                <div style="margin-top: 5px; font-size: 1.1em;">${item.shift === 'صباحية' ? '🌅' : '🌆'} ${item.shift}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-right: 4px solid #2196f3;">
                                <strong style="color: #2196f3;">📍 المنطقة:</strong>
                                <div style="margin-top: 5px; font-size: 1.1em;">${areaName}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-right: 4px solid #ff9800;">
                                <strong style="color: #ff9800;">🏘️ الملجأ:</strong>
                                <div style="margin-top: 5px; font-size: 1.1em;">${item.shelterName}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-right: 4px solid #009688;">
                                <strong style="color: #009688;">👥 المفتشون:</strong>
                                <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${item.inspectors.map(inspector => `<span style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.9em;">👤 ${inspector}</span>`).join('')}
                                </div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-right: 4px solid #607d8b;">
                                <strong style="color: #607d8b;">📝 الملاحظات:</strong>
                                <div style="margin-top: 5px; font-size: 1em; color: #666;">${notes}</div>
                            </div>
                        </div>
                        <div style="margin-top: 25px; text-align: center;">
                            <button onclick="document.getElementById('viewShelterInspectionModal').remove()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold;">
                                إغلاق
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // ========================================
        // End of Shelter Inspection Management
        // ========================================
        
        // ========================================
        // Smart Pet Shop Discovery Functions
        // ========================================
        
        /**
         * Open the Smart Pet Shop Discovery modal
         */
        function openSmartPetShopDiscovery() {
            const modal = document.getElementById('smartPetShopModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                
                // Populate area dropdown
                populatePetShopAreaDropdown();
            }
        }
        
        /**
         * Close the Smart Pet Shop Discovery modal
         */
        function closeSmartPetShopModal() {
            const modal = document.getElementById('smartPetShopModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        /**
         * Populate the area dropdown in pet shop form
         */
        function populatePetShopAreaDropdown() {
            const areaSelect = document.getElementById('petShopArea');
            if (!areaSelect || !planData || !planData.areas) return;
            
            areaSelect.innerHTML = '<option value="">اختر المنطقة</option>';
            
            planData.areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.name;
                option.textContent = area.name;
                areaSelect.appendChild(option);
            });
        }
        
        /**
         * Open Google Maps with pet shop search
         * This opens Google Maps in a new tab with a search for pet shops, bird shops, and aquarium shops
         */
        function openGoogleMapsSearch() {
            // Abu Dhabi coordinates as default center
            const lat = 24.4539;
            const lng = 54.3773;
            
            // Search query for pet shops, bird shops, and aquarium shops in Arabic and English
            // Using multiple search terms to get comprehensive results
            const searchTerms = [
                'pet shop',
                'pets',
                'pet',
                'محل حيوانات',
                'محلات الحيوانات الأليفة',
                'محل طيور',
                'bird shop',
                'aquarium',
                'fish shop',
                'محل أسماك',
                'أسماك الزينة'
            ];
            
            // Create a combined search query
            const searchQuery = searchTerms.join(' OR ');
            
            // Google Maps search URL with the query
            const mapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(searchQuery)}/@${lat},${lng},12z`;
            
            // Open in new tab
            window.open(mapsUrl, '_blank');
            
            // Show helper message
            showPetShopStatus(
                '✅ تم فتح خرائط جوجل!\n\n' +
                'نصائح:\n' +
                '1. ابحث عن "pet shop" أو "محل حيوانات" أو "محل طيور"\n' +
                '2. انقر على أي محل لعرض التفاصيل\n' +
                '3. انسخ الاسم والموقع\n' +
                '4. الصق المعلومات في النموذج أدناه',
                'info'
            );
        }
        
        /**
         * Add pet shop to inspection plan
         */
        async function addPetShopToInspection(event) {
            event.preventDefault();
            
            if (!githubToken) {
                showPetShopStatus('⚠️ يجب تسجيل الدخول أولاً للحفظ على GitHub', 'error');
                return;
            }
            
            // Get form values
            const shopName = document.getElementById('petShopName').value.trim();
            const area = document.getElementById('petShopArea').value;
            const address = document.getElementById('petShopAddress').value.trim();
            const mapLink = document.getElementById('petShopMapLink').value.trim();
            const phone = document.getElementById('petShopPhone').value.trim();
            const priority = document.getElementById('petShopPriority').value;
            const notes = document.getElementById('petShopNotes').value.trim();
            
            if (!shopName || !area) {
                showPetShopStatus('⚠️ يرجى تعبئة الاسم والمنطقة على الأقل', 'error');
                return;
            }
            
            // Check if shop already exists
            if (planData.shops) {
                const existingShop = planData.shops.find(s => 
                    s.name.toLowerCase() === shopName.toLowerCase() && 
                    s.area === area
                );
                
                if (existingShop) {
                    const confirmOverwrite = confirm(
                        `المحل "${shopName}" موجود بالفعل في المنطقة "${area}".\n\n` +
                        `هل تريد تحديث معلوماته؟`
                    );
                    
                    if (!confirmOverwrite) {
                        return;
                    }
                }
            }
            
            // Create new shop object
            const newShop = {
                name: shopName,
                area: area,
                address: address || '',
                mapLink: mapLink || '',
                phone: phone || '',
                priority: priority,
                notes: notes || '',
                lastInspectionDate: null,
                addedVia: 'smart-discovery',
                addedDate: new Date().toISOString()
            };
            
            try {
                // Initialize shops array if it doesn't exist
                if (!planData.shops) {
                    planData.shops = [];
                }
                
                // Check if updating existing shop or adding new
                const existingIndex = planData.shops.findIndex(s => 
                    s.name.toLowerCase() === shopName.toLowerCase() && 
                    s.area === area
                );
                
                if (existingIndex !== -1) {
                    // Update existing shop
                    planData.shops[existingIndex] = {
                        ...planData.shops[existingIndex],
                        ...newShop
                    };
                    showPetShopStatus('✅ تم تحديث معلومات المحل بنجاح!', 'success');
                } else {
                    // Add new shop
                    planData.shops.push(newShop);
                    showPetShopStatus('✅ تم إضافة المحل الجديد بنجاح!', 'success');
                }
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                // Reset form
                resetPetShopForm();
                
                // Refresh shops list if on shops tab
                if (typeof renderShopsTable === 'function') {
                    renderShopsTable();
                }
                
                // Show success message with next steps
                setTimeout(() => {
                    showPetShopStatus(
                        '✅ تم الحفظ بنجاح!\n\n' +
                        'الخطوات التالية:\n' +
                        '1. يمكنك إضافة المزيد من المحلات\n' +
                        '2. أو الذهاب إلى تبويب "إضافة تفتيش" لجدولة التفتيش\n' +
                        '3. المحل الجديد متاح الآن في قائمة المحلات',
                        'success'
                    );
                }, 1500);
                
            } catch (error) {
                console.error('Error adding pet shop:', error);
                showPetShopStatus('❌ حدث خطأ أثناء الحفظ: ' + error.message, 'error');
            }
        }
        
        /**
         * Reset pet shop form
         */
        function resetPetShopForm() {
            const form = document.getElementById('smartPetShopForm');
            if (form) {
                form.reset();
            }
        }
        
        /**
         * Show status message for pet shop operations
         */
        function showPetShopStatus(message, type) {
            const statusDiv = document.getElementById('petShopStatus');
            if (!statusDiv) return;
            
            statusDiv.textContent = message;
            statusDiv.className = 'status-message show ' + type;
            statusDiv.style.display = 'block';
            
            // Auto-hide after 8 seconds for long messages
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 8000);
        }
        
        /**
         * Close modal when clicking outside
         */
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('smartPetShopModal');
            if (event.target === modal) {
                closeSmartPetShopModal();
            }
        });
        
        // ========================================
        // End of Smart Pet Shop Discovery
        // ========================================
        
        // ========================================
        // File Manager for Group Inspection Reports
        // ========================================
        
        // Check if user is a developer (has valid GitHub token)
        function isDeveloper() {
            return githubToken !== null && githubToken !== '';
        }
        
        // Update file manager UI based on user role
        function updateFileManagerUI() {
            const developerWarningBanner = document.getElementById('developerWarningBanner');
            const viewerInfoBanner = document.getElementById('viewerInfoBanner');
            const developerUploadSection = document.getElementById('developerUploadSection');
            
            if (isDeveloper()) {
                // Developer view: Show upload section and developer banner
                if (developerWarningBanner) developerWarningBanner.style.display = 'block';
                if (viewerInfoBanner) viewerInfoBanner.style.display = 'none';
                if (developerUploadSection) developerUploadSection.style.display = 'block';
            } else {
                // Viewer view: Show viewer banner, hide upload section
                if (developerWarningBanner) developerWarningBanner.style.display = 'none';
                if (viewerInfoBanner) viewerInfoBanner.style.display = 'block';
                if (developerUploadSection) developerUploadSection.style.display = 'none';
            }
        }
        
        // Load and display all group inspection reports
        async function loadGroupReportFiles() {
            const listDiv = document.getElementById('fileManagerFilesList');
            const statusDiv = document.getElementById('fileManagerStatus');
            
            if (!listDiv) return;
            
            // Update UI based on user role
            updateFileManagerUI();
            
            // Check if user is a developer
            const isDevUser = isDeveloper();
            
            try {
                listDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">⏳ جاري تحميل التقارير...</p>';
                
                // Load files.json
                const response = await fetch('files.json?t=' + Date.now(), {
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load files.json');
                }
                
                const filesData = await response.json();
                
                // Filter group inspection reports and shelter visit reports
                const groupReports = filesData.files
                    .filter(f => f.category === 'group_inspection_reports' || f.category === 'shelter_visit_reports')
                    .sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));
                
                if (groupReports.length === 0) {
                    const emptyMessage = isDevUser 
                        ? '<small>قم برفع تقرير جديد باستخدام النموذج أعلاه</small>'
                        : '<small>لا توجد تقارير متاحة حالياً للعرض</small>';
                    
                    listDiv.innerHTML = `
                        <p style="text-align: center; color: #666; padding: 60px;">
                            <span style="font-size: 3em; display: block; margin-bottom: 10px;">📑</span>
                            <strong>لا توجد تقارير حالياً</strong><br>
                            ${emptyMessage}
                        </p>
                    `;
                    return;
                }
                
                // Build files list HTML with different buttons based on role
                let html = '<div style="display: grid; gap: 15px;">';
                groupReports.forEach((file, index) => {
                    const uploadDate = new Date(file.uploadDate).toLocaleDateString('ar-EG', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const fileSize = formatFileSize(file.size || 0);
                    const fileIcon = getFileIcon(file.type);
                    
                    // Category badge color
                    const categoryColor = file.category === 'group_inspection_reports' ? '#ff9800' : '#9c27b0';
                    const categoryLabel = file.category === 'group_inspection_reports' ? 'تفتيش جماعي' : 'زيارة ملاجئ';
                    
                    // Build action buttons based on role
                    let actionButtons = '';
                    
                    if (isDevUser) {
                        // Developer: Full CRUD buttons (Add is in upload section, here: View, Download, Edit, Delete)
                        actionButtons = `
                            <button onclick="viewReportFile('${file.path}')" 
                                style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; white-space: nowrap; display: flex; align-items: center; gap: 5px;">
                                <span>👁️</span> عرض
                            </button>
                            <button onclick="downloadReportFile('${file.path}')" 
                                style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; white-space: nowrap; display: flex; align-items: center; gap: 5px;">
                                <span>📥</span> تحميل
                            </button>
                            <button onclick="editReportFile('${file.id}')" 
                                style="background: #ff9800; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; white-space: nowrap; display: flex; align-items: center; gap: 5px;">
                                <span>✏️</span> تعديل
                            </button>
                            <button onclick="deleteReportFile('${file.id}', '${file.path}')" 
                                style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; white-space: nowrap; display: flex; align-items: center; gap: 5px;">
                                <span>🗑️</span> حذف
                            </button>
                        `;
                    } else {
                        // Viewer: View and download buttons only (no edit/delete)
                        actionButtons = `
                            <button onclick="viewReportFile('${file.path}')" 
                                style="background: #2196f3; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.95em; white-space: nowrap; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2em;">👁️</span> عرض
                            </button>
                            <button onclick="downloadReportFile('${file.path}')" 
                                style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.95em; white-space: nowrap; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2em;">📥</span> تحميل
                            </button>
                        `;
                    }
                    
                    html += `
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-right: 4px solid ${categoryColor};">
                            <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 15px; align-items: start;">
                                <div style="font-size: 2.5em;">${fileIcon}</div>
                                <div>
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <h4 style="margin: 0; color: #2d3561; font-size: 1.1em;">${file.name}</h4>
                                        <span style="background: ${categoryColor}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75em; font-weight: bold;">${categoryLabel}</span>
                                    </div>
                                    <p style="margin: 0 0 10px 0; color: #666; font-size: 0.95em;">${file.description}</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.85em; color: #999;">
                                        <span><strong>📅 تاريخ الرفع:</strong> ${uploadDate}</span>
                                        <span><strong>👤 الرافع:</strong> ${file.uploader}</span>
                                        <span><strong>📦 الحجم:</strong> ${fileSize}</span>
                                        <span><strong>📝 النوع:</strong> ${file.type.toUpperCase()}</span>
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${actionButtons}
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                listDiv.innerHTML = html;
                const roleText = isDevUser ? '(وضع المطور - صلاحيات كاملة)' : '(وضع العرض - للقراءة والتحميل فقط)';
                showFileManagerMessage(`✅ تم تحميل ${groupReports.length} تقرير بنجاح ${roleText}`, 'success');
                
            } catch (error) {
                console.error('Error loading files:', error);
                listDiv.innerHTML = `
                    <p style="text-align: center; color: #dc3545; padding: 40px;">
                        <span style="font-size: 2em; display: block; margin-bottom: 10px;">❌</span>
                        <strong>حدث خطأ أثناء تحميل التقارير</strong><br>
                        <small>${error.message}</small>
                    </p>
                `;
                showFileManagerMessage('❌ فشل تحميل التقارير: ' + error.message, 'error');
            }
        }
        
        // View report file (opens in new tab)
        function viewReportFile(filePath) {
            const viewUrl = `https://raw.githubusercontent.com/${repo}/main/${filePath}`;
            window.open(viewUrl, '_blank');
        }
        
        // Upload a new report file
        async function uploadReportFile() {
            const fileInput = document.getElementById('fileManagerFileInput');
            const titleInput = document.getElementById('fileManagerTitle');
            const descriptionInput = document.getElementById('fileManagerDescription');
            const uploaderInput = document.getElementById('fileManagerUploader');
            const statusDiv = document.getElementById('fileManagerUploadStatus');
            
            // Validate inputs
            if (!fileInput.files[0]) {
                showFileManagerMessage('❌ يرجى اختيار ملف', 'error', 'fileManagerUploadStatus');
                return;
            }
            
            if (!titleInput.value.trim()) {
                showFileManagerMessage('❌ يرجى إدخال عنوان التقرير', 'error', 'fileManagerUploadStatus');
                return;
            }
            
            const file = fileInput.files[0];
            const maxSize = 25 * 1024 * 1024; // 25 MB
            
            if (file.size > maxSize) {
                showFileManagerMessage('❌ حجم الملف كبير جداً! الحد الأقصى 25 ميجابايت', 'error', 'fileManagerUploadStatus');
                return;
            }
            
            try {
                showFileManagerMessage('⏳ جاري التحضير...', 'info', 'fileManagerUploadStatus');
                
                // Get GitHub token
                const token = githubToken || localStorage.getItem('devToken');
                if (!token) {
                    showFileManagerMessage('❌ يرجى تسجيل الدخول أولاً', 'error', 'fileManagerUploadStatus');
                    return;
                }
                
                // Read file as base64
                const base64Content = await readFileAsBase64(file);
                
                // Clean filename - preserve Arabic and alphanumeric, replace problematic characters
                let cleanFileName = file.name
                    .replace(/[<>:"/\\|?*\x00-\x1f]/g, '_')  // Replace invalid file system characters
                    .replace(/\s+/g, '_')                     // Replace spaces with underscores
                    .replace(/_{2,}/g, '_')                   // Replace multiple underscores with single
                    .replace(/^_+|_+$/g, '');                 // Remove leading/trailing underscores
                
                // Ensure filename is not empty after sanitization
                if (!cleanFileName || cleanFileName.trim().length === 0) {
                    cleanFileName = 'report_' + Date.now() + '.' + (file.name.split('.').pop() || 'file');
                }
                const filePath = `files/group_inspection_reports/${cleanFileName}`;
                
                showFileManagerMessage('⏳ جاري رفع الملف إلى GitHub...', 'info', 'fileManagerUploadStatus');
                
                // Check if file exists
                let existingFileSha = null;
                try {
                    const checkRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (checkRes.ok) {
                        const existingFile = await checkRes.json();
                        existingFileSha = existingFile.sha;
                    }
                } catch (e) {
                    // File doesn't exist, which is fine
                }
                
                // Upload file to GitHub
                const uploadData = {
                    message: `رفع تقرير تفتيش جماعي: ${titleInput.value.trim()}`,
                    content: base64Content,
                    branch: 'main'
                };
                
                if (existingFileSha) {
                    uploadData.sha = existingFileSha;
                }
                
                const uploadRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(uploadData)
                });
                
                if (!uploadRes.ok) {
                    throw new Error('فشل رفع الملف إلى GitHub');
                }
                
                showFileManagerMessage('⏳ جاري تحديث files.json...', 'info', 'fileManagerUploadStatus');
                
                // Update files.json
                await updateFilesJson({
                    id: 'group_report_' + Date.now(),
                    name: cleanFileName,
                    path: filePath,
                    category: 'group_inspection_reports',
                    type: file.name.split('.').pop().toLowerCase(),
                    size: file.size,
                    uploadDate: new Date().toISOString(),
                    description: descriptionInput.value.trim() || titleInput.value.trim(),
                    uploader: uploaderInput.value.trim() || 'د. علي عبدالعال',
                    visible: true
                });
                
                showFileManagerMessage('✅ تم رفع التقرير بنجاح!', 'success', 'fileManagerUploadStatus');
                clearUploadForm();
                loadGroupReportFiles();
                
            } catch (error) {
                console.error('Error uploading file:', error);
                showFileManagerMessage('❌ حدث خطأ: ' + error.message, 'error', 'fileManagerUploadStatus');
            }
        }
        
        // Edit report metadata - Enhanced comprehensive edit modal
        async function editReportFile(fileId) {
            try {
                // Load files.json
                const response = await fetch('files.json?t=' + Date.now(), {
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error('فشل تحميل files.json');
                }
                
                const filesData = await response.json();
                const file = filesData.files.find(f => f.id === fileId);
                
                if (!file) {
                    throw new Error('لم يتم العثور على الملف');
                }
                
                // Store filesData globally for save operation
                window.currentEditFilesData = filesData;
                
                // Populate the edit modal with current file data
                document.getElementById('editReportFileId').value = fileId;
                document.getElementById('editReportName').value = file.name || '';
                document.getElementById('editReportDescription').value = file.description || '';
                document.getElementById('editReportUploader').value = file.uploader || 'د. علي عبدالعال';
                document.getElementById('editReportCategory').value = file.category || 'group_inspection_reports';
                document.getElementById('editReportVisible').value = file.visible !== false ? 'true' : 'false';
                
                // Handle inspection date - extract from uploadDate or inspectionDate
                const inspectionDate = file.inspectionDate || (file.uploadDate ? file.uploadDate.split('T')[0] : '');
                document.getElementById('editReportInspectionDate').value = inspectionDate;
                
                // Show the edit modal
                const modal = document.getElementById('editReportModal');
                if (modal) {
                    modal.style.display = 'flex';
                    modal.style.alignItems = 'center';
                    modal.style.justifyContent = 'center';
                }
                
            } catch (error) {
                console.error('Error loading file for edit:', error);
                showFileManagerMessage('❌ حدث خطأ: ' + error.message, 'error');
            }
        }
        
        // Close edit report modal
        function closeEditReportModal() {
            const modal = document.getElementById('editReportModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // Clear stored data
            window.currentEditFilesData = null;
        }
        
        // Save report edits - comprehensive update
        async function saveReportEdits(event) {
            event.preventDefault();
            
            try {
                const fileId = document.getElementById('editReportFileId').value;
                const filesData = window.currentEditFilesData;
                
                if (!filesData) {
                    throw new Error('لم يتم تحميل بيانات الملفات');
                }
                
                const file = filesData.files.find(f => f.id === fileId);
                if (!file) {
                    throw new Error('لم يتم العثور على الملف');
                }
                
                // Get all form values
                const newName = document.getElementById('editReportName').value.trim();
                const newDescription = document.getElementById('editReportDescription').value.trim();
                const newInspectionDate = document.getElementById('editReportInspectionDate').value;
                const newUploader = document.getElementById('editReportUploader').value.trim();
                const newCategory = document.getElementById('editReportCategory').value;
                const newVisible = document.getElementById('editReportVisible').value === 'true';
                
                // Validate required fields
                if (!newName) {
                    showEditReportStatus('⚠️ يرجى إدخال اسم الملف', 'error');
                    return;
                }
                
                // Update file metadata comprehensively
                file.name = newName;
                file.description = newDescription || newName; // Use name as description if empty
                file.uploader = newUploader || file.uploader;
                file.category = newCategory;
                file.visible = newVisible;
                
                // Add/update inspection date
                if (newInspectionDate) {
                    file.inspectionDate = newInspectionDate;
                }
                
                // Update last modified timestamp
                file.lastModified = new Date().toISOString();
                
                // Show saving status
                showEditReportStatus('⏳ جاري حفظ التعديلات...', 'info');
                
                // Save updated files.json
                await saveFilesJson(filesData);
                
                showEditReportStatus('✅ تم تحديث بيانات التقرير بنجاح!', 'success');
                
                // Close modal after short delay
                setTimeout(() => {
                    closeEditReportModal();
                    // Refresh the reports list
                    loadGroupReportFiles();
                    showFileManagerMessage('✅ تم تحديث بيانات التقرير بنجاح', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Error saving report edits:', error);
                showEditReportStatus('❌ حدث خطأ: ' + error.message, 'error');
            }
        }
        
        // Show status message in edit modal
        function showEditReportStatus(message, type) {
            const statusDiv = document.getElementById('editReportStatus');
            if (!statusDiv) return;
            
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            statusDiv.className = 'status-message show ' + type;
            
            // Auto-hide for success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // Delete report file
        async function deleteReportFile(fileId, filePath) {
            if (!confirm('هل أنت متأكد من حذف هذا التقرير؟\n\nسيتم حذف الملف نهائياً من GitHub والنظام.')) {
                return;
            }
            
            try {
                showFileManagerMessage('⏳ جاري الحذف...', 'info');
                
                const token = githubToken || localStorage.getItem('devToken');
                if (!token) {
                    showFileManagerMessage('❌ يرجى تسجيل الدخول أولاً', 'error');
                    return;
                }
                
                // Get file SHA
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getRes.ok) {
                    throw new Error('فشل الحصول على معلومات الملف');
                }
                
                const fileData = await getRes.json();
                
                // Delete file from GitHub
                const deleteRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `حذف تقرير التفتيش الجماعي: ${fileId}`,
                        sha: fileData.sha,
                        branch: 'main'
                    })
                });
                
                if (!deleteRes.ok) {
                    throw new Error('فشل حذف الملف من GitHub');
                }
                
                // Remove from files.json
                const response = await fetch('files.json?t=' + Date.now(), {
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const filesData = await response.json();
                    filesData.files = filesData.files.filter(f => f.id !== fileId);
                    await saveFilesJson(filesData);
                }
                
                showFileManagerMessage('✅ تم حذف التقرير بنجاح', 'success');
                loadGroupReportFiles();
                
            } catch (error) {
                console.error('Error deleting file:', error);
                showFileManagerMessage('❌ حدث خطأ: ' + error.message, 'error');
            }
        }
        
        // Download report file
        function downloadReportFile(filePath) {
            const downloadUrl = `https://raw.githubusercontent.com/${repo}/main/${filePath}`;
            window.open(downloadUrl, '_blank');
        }
        
        // Helper: Update files.json with new file
        async function updateFilesJson(newFile) {
            try {
                const token = githubToken || localStorage.getItem('devToken');
                if (!token) {
                    throw new Error('لا يوجد توكن متاح');
                }
                
                // Load current files.json
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getRes.ok) {
                    throw new Error('فشل تحميل files.json');
                }
                
                const currentFile = await getRes.json();
                const filesData = JSON.parse(atob(currentFile.content));
                
                // Add new file
                filesData.files.push(newFile);
                filesData.lastUpdate = new Date().toISOString();
                
                // Save updated files.json
                await saveFilesJson(filesData, currentFile.sha);
                
            } catch (error) {
                console.error('Error updating files.json:', error);
                throw error;
            }
        }
        
        // Helper: Save files.json to GitHub
        async function saveFilesJson(filesData, sha = null) {
            try {
                const token = githubToken || localStorage.getItem('devToken');
                if (!token) {
                    throw new Error('لا يوجد توكن متاح');
                }
                
                // Get current SHA if not provided
                if (!sha) {
                    const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (getRes.ok) {
                        const currentFile = await getRes.json();
                        sha = currentFile.sha;
                    }
                }
                
                // Update lastUpdate timestamp
                filesData.lastUpdate = new Date().toISOString();
                
                // Convert to base64
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(filesData, null, 2))));
                
                // Save to GitHub
                const saveRes = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'تحديث files.json - إدارة تقارير التفتيش الجماعي',
                        content: content,
                        sha: sha,
                        branch: 'main'
                    })
                });
                
                if (!saveRes.ok) {
                    throw new Error('فشل حفظ files.json');
                }
                
            } catch (error) {
                console.error('Error saving files.json:', error);
                throw error;
            }
        }
        
        // Helper: Read file as base64
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const result = e.target.result;
                        if (!result || typeof result !== 'string') {
                            throw new Error('Invalid file data');
                        }
                        const parts = result.split(',');
                        if (parts.length < 2) {
                            throw new Error('Invalid data URL format');
                        }
                        const base64 = parts[1];
                        if (!base64 || base64.trim().length === 0) {
                            throw new Error('Empty base64 data');
                        }
                        resolve(base64);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }
        
        // Helper: Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Helper: Get file icon
        function getFileIcon(fileType) {
            const icons = {
                'pdf': '📄',
                'xlsx': '📊',
                'xls': '📊',
                'docx': '📝',
                'doc': '📝',
                'pptx': '📊',
                'ppt': '📊'
            };
            return icons[fileType.toLowerCase()] || '📎';
        }
        
        // Helper: Show message
        function showFileManagerMessage(message, type, targetId = 'fileManagerStatus') {
            const statusDiv = document.getElementById(targetId);
            if (!statusDiv) return;
            
            statusDiv.textContent = message;
            statusDiv.className = 'status-message show';
            
            const colors = {
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107',
                'info': '#17a2b8'
            };
            
            statusDiv.style.background = colors[type] || colors['info'];
            statusDiv.style.color = 'white';
            statusDiv.style.padding = '15px';
            statusDiv.style.borderRadius = '8px';
            statusDiv.style.marginTop = '15px';
            statusDiv.style.fontWeight = 'bold';
            statusDiv.style.textAlign = 'center';
        }
        
        // Clear upload form
        function clearUploadForm() {
            document.getElementById('fileManagerFileInput').value = '';
            document.getElementById('fileManagerTitle').value = '';
            document.getElementById('fileManagerDescription').value = '';
            const statusDiv = document.getElementById('fileManagerUploadStatus');
            if (statusDiv) {
                statusDiv.textContent = '';
                statusDiv.className = 'status-message';
            }
        }
        
        // Note: File loading is now integrated directly into switchTab function
        // No need for wrapper function - see switchTab() for fileManager case
        
        // ========================================
        // End of File Manager
        // ========================================
    </script>
</body>
</html>
