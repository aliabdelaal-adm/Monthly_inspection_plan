<!DOCTYPE html>
<!-- Version 2.0.0 - ABSOLUTE ZERO-CACHE STRATEGY for instant updates -->
<!-- Last Updated: 2025-10-19 - Complete cache prevention for Safari, Chrome, Firefox (mobile/desktop) -->
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Ø£Ø¯Ø§Ø© Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø´Ù‡Ø±ÙŠ</title>
    
    <!-- ABSOLUTE CACHE PREVENTION - Works on ALL browsers including Safari, Chrome and Firefox -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, max-stale=0, post-check=0, pre-check=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Safari-specific cache prevention -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Chrome mobile-specific cache prevention -->
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Additional cache control for aggressive browsers -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="cleartype" content="on">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .feature-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .feature-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .feature-card h3 {
            color: #2d3561;
            margin-bottom: 5px;
        }
        
        .feature-card p {
            color: #666;
            font-size: 0.9em;
        }
        
        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.8em;
            color: #2d3561;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #2d3561;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102,126,234,0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(17,153,142,0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(17,153,142,0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(250,112,154,0.3);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(250,112,154,0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 600;
            display: none;
        }
        
        .status-message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .status-message.warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
        }
        
        .shops-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .shop-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .shop-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.2);
        }
        
        .shop-card.selected {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .shop-card.very-high-priority {
            border-left: 5px solid #8b0000;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
        }
        
        .shop-card.high-priority {
            border-left: 5px solid #dc3545;
        }
        
        .shop-card.medium-priority {
            border-left: 5px solid #ffc107;
        }
        
        .shop-card.low-priority {
            border-left: 5px solid #28a745;
        }
        
        .shop-card .priority-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .shop-card .priority-badge.very-high {
            background: #8b0000;
            color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .shop-card .priority-badge.high {
            background: #dc3545;
            color: white;
        }
        
        .shop-card .priority-badge.medium {
            background: #ffc107;
            color: #212529;
        }
        
        .shop-card .priority-badge.low {
            background: #28a745;
            color: white;
        }
        
        .shop-card .shop-name {
            font-weight: 600;
            color: #2d3561;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .shop-card .shop-info {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .shop-card .last-inspection {
            font-size: 0.85em;
            color: #999;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }
        
        .selected-shops {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .selected-shops h3 {
            color: #1565c0;
            margin-bottom: 15px;
        }
        
        .selected-shops-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .selected-shop-tag {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .selected-shop-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .selected-shop-tag .remove:hover {
            color: #ffcccc;
        }
        
        .filter-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        
        .stat-box .value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-box .label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .inspection-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }
        
        .inspection-preview h3 {
            color: #2d3561;
            margin-bottom: 15px;
        }
        
        .inspection-preview .preview-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .inspection-preview .preview-item strong {
            color: #667eea;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* New styles for enhanced features */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 12px 24px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            background: #f0f0ff;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .inspections-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .inspections-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .inspections-table th,
        .inspections-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .inspections-table tbody tr:hover {
            background: #f5f5f5;
        }
        
        .action-icon {
            cursor: pointer;
            font-size: 1.3em;
            margin: 0 5px;
            transition: transform 0.2s;
        }
        
        .action-icon:hover {
            transform: scale(1.2);
        }
        
        .edit-icon { color: #ffc107; }
        .delete-icon { color: #dc3545; }
        .copy-icon { color: #17a2b8; }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        
        .inspector-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-card .stat-label {
            font-size: 1em;
            color: #2d3561;
            margin-top: 5px;
        }
        
        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .calendar-day {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            min-height: 100px;
            position: relative;
        }
        
        .calendar-day .day-number {
            font-weight: 700;
            color: #2d3561;
            margin-bottom: 10px;
        }
        
        .calendar-day .inspection-badge {
            background: #667eea;
            color: white;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            margin-bottom: 5px;
            display: block;
        }
        
        .calendar-day.has-inspection {
            border-color: #667eea;
            background: #f0f0ff;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #2d3561;
        }
        
        .modal-close {
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
        }
        
        .search-box .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(231,76,60,0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(231,76,60,0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(52,152,219,0.3);
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52,152,219,0.4);
        }
        
        /* Bell Notification Control Styles */
        .bell-control-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .bell-control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5);
        }
        
        .bell-control-btn:active {
            transform: translateY(-1px);
        }
        
        /* Hand Gesture Control Styles */
        .gesture-control-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .gesture-control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.5);
        }
        
        .gesture-control-btn:active {
            transform: translateY(-1px);
        }
        
        .gesture-control-btn.active {
            background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
            }
            50% {
                box-shadow: 0 5px 30px rgba(56, 239, 125, 0.6);
            }
        }
        
        .gesture-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .gesture-modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 50px auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            color: white;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .gesture-close {
            color: white;
            float: left;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .gesture-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .gesture-video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .gesture-video {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1);
        }
        
        .gesture-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }
        
        .gesture-status {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .gesture-status h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .gesture-detected {
            font-size: 2em;
            font-weight: bold;
            color: #38ef7d;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(56, 239, 125, 0.5);
        }
        
        .gesture-guide {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .gesture-guide h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .gesture-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .gesture-icon {
            font-size: 2em;
            min-width: 50px;
            text-align: center;
        }
        
        .gesture-description {
            flex: 1;
        }
        
        .gesture-description strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .gesture-description span {
            opacity: 0.9;
            font-size: 0.95em;
        }
        
        .bell-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        
        .bell-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .bell-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }
        
        .bell-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        
        .bell-modal-header h2 {
            color: #2d3561;
            font-size: 2em;
            margin: 0;
        }
        
        .bell-modal-close {
            background: #e74c3c;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bell-modal-close:hover {
            transform: rotate(90deg);
            background: #c0392b;
        }
        
        .notification-add-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #dee2e6;
        }
        
        .notification-add-section h3 {
            color: #2d3561;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        .notification-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.3s ease;
        }
        
        .notification-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .notification-author-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ced4da;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            margin-top: 10px;
        }
        
        .notification-author-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .notification-add-btn {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s ease;
        }
        
        .notification-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .notifications-list {
            margin-top: 25px;
        }
        
        .notification-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .notification-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .notification-text {
            color: #2d3561;
            font-size: 1.05em;
            line-height: 1.6;
            margin-bottom: 12px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }
        
        .notification-text:hover {
            background: #f8f9fa;
        }
        
        .notification-edit-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            resize: vertical;
            min-height: 80px;
            display: none;
        }
        
        .notification-meta {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 12px;
        }
        
        .notification-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .notification-action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .notification-save-btn {
            background: #28a745;
            color: white;
            display: none;
        }
        
        .notification-save-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .notification-cancel-btn {
            background: #6c757d;
            color: white;
            display: none;
        }
        
        .notification-cancel-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .notification-delete-btn {
            background: #dc3545;
            color: white;
        }
        
        .notification-delete-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .notification-move-btn {
            background: #17a2b8;
            color: white;
        }
        
        .notification-move-btn:hover {
            background: #138496;
            transform: translateY(-2px);
        }
        
        .notification-priority-btn {
            background: #ffc107;
            color: #212529;
        }
        
        .notification-priority-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .notification-item.priority-high {
            border-left: 5px solid #dc3545;
            background: linear-gradient(to right, #fff5f5 0%, white 10%);
        }
        
        .notification-item.priority-medium {
            border-left: 5px solid #ffc107;
            background: linear-gradient(to right, #fffbf0 0%, white 10%);
        }
        
        .notification-item.priority-low {
            border-left: 5px solid #28a745;
            background: linear-gradient(to right, #f0fff4 0%, white 10%);
        }
        
        .notification-settings {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border: 1px solid #dee2e6;
        }
        
        .notification-settings label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .notification-settings input,
        .notification-settings select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            margin-bottom: 10px;
        }
        
        .notification-settings input:focus,
        .notification-settings select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .bell-control-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #dee2e6;
        }
        
        .bell-control-panel h3 {
            color: #2d3561;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        .bell-control-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .bell-control-item {
            flex: 1;
            min-width: 200px;
        }
        
        .bell-control-item label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .bell-control-item input,
        .bell-control-item select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
        }
        
        .bell-bulk-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .bell-bulk-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95em;
        }
        
        .bell-bulk-btn:hover {
            transform: translateY(-2px);
        }
        
        .bell-save-all-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }
        
        .bell-save-all-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }
        
        .bell-status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .bell-status-message.show {
            display: block;
        }
        
        .bell-status-message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .bell-status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    
    <!-- SheetJS library for Excel import/export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- jsPDF library for PDF export with Arabic support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.1/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ Ø£Ø¯Ø§Ø© Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h1>
            <p>Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ ÙˆÙ…Ø±Ù† Ù„ØªØ­Ø¯ÙŠØ« Ø®Ø·Ø© Ø§Ù„ØªÙØªÙŠØ´ Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆÙÙˆØ±Ø§Ù‹ Ù…Ø¹ ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø°Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</p>
        </div>
        
        <div class="features">
            <div class="feature-card">
                <div class="icon">âš¡</div>
                <h3>ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ</h3>
                <p>Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ØªØ¸Ù‡Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯ÙˆÙ† Ø±ÙØ¹ Ù…Ù„ÙØ§Øª</p>
            </div>
            <div class="feature-card">
                <div class="icon">ğŸ¯</div>
                <h3>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</h3>
                <p>Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø°Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ù„ÙŠØ© ØªØ¸Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹</p>
            </div>
            <div class="feature-card">
                <div class="icon">ğŸš«</div>
                <h3>Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±</h3>
                <p>ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…</p>
            </div>
            <div class="feature-card">
                <div class="icon">ğŸ“…</div>
                <h3>ÙØªØ±Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h3>
                <p>Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ø­Ø¯ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙØªÙŠØ´</p>
            </div>
            <div class="feature-card">
                <div class="icon">ğŸ“</div>
                <h3>ØªØ­Ø±ÙŠØ± Ø§Ù„ØªÙØªÙŠØ´Ø§Øª</h3>
                <p>Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</p>
            </div>
            <div class="feature-card">
                <div class="icon">ğŸ‘ï¸</div>
                <h3>Ø¹Ø±Ø¶ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª</h3>
                <p>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª Ù„ÙƒÙ„ Ù…ÙØªØ´</p>
            </div>
            <div class="feature-card">
                <div class="icon">ğŸ—‘ï¸</div>
                <h3>Ø­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ</h3>
                <p>Ø­Ø°Ù Ø§Ù„ØªÙØªÙŠØ´Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
            </div>
            <div class="feature-card">
                <div class="icon">ğŸ“Š</div>
                <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø©</h3>
                <p>ØªÙ‚Ø§Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠØ© Ù„ÙƒÙ„ Ù…ÙØªØ´</p>
            </div>
        </div>
        
        <!-- Quick Links & Smart Actions Toolbar -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
            <h3 style="color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <span>âš¡</span>
                <span>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© ÙˆØ§Ù„Ø°ÙƒÙŠØ©</span>
            </h3>
            
            <!-- Navigation Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <a href="admin-dashboard.html" style="text-decoration: none;">
                    <button class="btn btn-warning" style="background: white; color: #667eea;">
                        <span>ğŸ“Š</span>
                        <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                    </button>
                </a>
                <a href="index.html" style="text-decoration: none;">
                    <button class="btn btn-info" style="background: white; color: #3498db;">
                        <span>ğŸ </span>
                        <span>Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                    </button>
                </a>
                <button class="btn btn-success" onclick="openQuickAddInspection()" style="background: white; color: #11998e;">
                    <span>âš¡</span>
                    <span>Ø¥Ø¶Ø§ÙØ© ØªÙØªÙŠØ´ Ø³Ø±ÙŠØ¹</span>
                </button>
            </div>
            
            <!-- Data Management Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="importFromExcel()" style="background: white; color: #667eea;">
                    <span>ğŸ“¥</span>
                    <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel</span>
                </button>
                <button class="btn btn-primary" onclick="exportAllData()" style="background: white; color: #667eea;">
                    <span>ğŸ“¤</span>
                    <span>ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                </button>
                <button class="btn btn-primary" onclick="syncWithGitHub()" style="background: white; color: #667eea;">
                    <span>ğŸ”„</span>
                    <span>Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHub</span>
                </button>
                <button class="btn btn-danger" onclick="createBackup()" style="background: white; color: #e74c3c;">
                    <span>ğŸ’¾</span>
                    <span>Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</span>
                </button>
            </div>
            
            <!-- Analysis & Reports Buttons -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="generateFullReport()" style="background: white; color: #11998e;">
                    <span>ğŸ“ˆ</span>
                    <span>ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</span>
                </button>
                <button class="btn btn-warning" onclick="checkDataQuality()" style="background: white; color: #fa709a;">
                    <span>ğŸ”</span>
                    <span>ÙØ­Øµ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                </button>
                <button class="btn btn-info" onclick="viewSystemLogs()" style="background: white; color: #3498db;">
                    <span>ğŸ“‹</span>
                    <span>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…</span>
                </button>
                <button class="btn btn-success" onclick="bulkOperations()" style="background: white; color: #11998e;">
                    <span>âš™ï¸</span>
                    <span>Ø¹Ù…Ù„ÙŠØ§Øª Ø¬Ù…Ø§Ø¹ÙŠØ©</span>
                </button>
            </div>
            
            <!-- Bell Notifications Control Button -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(255, 255, 255, 0.3);">
                <button class="bell-control-btn" onclick="openBellNotificationsControl()">
                    <span style="font-size: 1.3em;">ğŸ””</span>
                    <span>Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø±Ø³</span>
                    <span style="font-size: 0.85em; opacity: 0.9;">(Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹)</span>
                </button>
            </div>
            
            <!-- Hand Gesture Control Button -->
            <div style="margin-top: 15px;">
                <button class="gesture-control-btn" id="gestureControlBtn" onclick="toggleGestureControl()">
                    <span style="font-size: 1.3em;">âœ‹</span>
                    <span>Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø­Ø±ÙƒØ© Ø§Ù„ÙŠØ¯</span>
                    <span style="font-size: 0.85em; opacity: 0.9;">(ØªØ­ÙƒÙ… Ø°ÙƒÙŠ Ø¨Ø¯ÙˆÙ† Ù„Ù…Ø³)</span>
                </button>
            </div>
        </div>
        
        <!-- Login Section -->
        <div class="section" id="loginSection">
            <h2 class="section-title">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø·ÙˆØ±</h2>
            <div class="form-group">
                <label class="form-label">GitHub Token (Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±)</label>
                <input type="password" id="githubToken" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <small style="color: #666; display: block; margin-top: 5px;">
                    Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù†: GitHub Settings â†’ Developer Settings â†’ Personal Access Tokens
                </small>
            </div>
            <button class="btn btn-primary" onclick="loginDeveloper()">
                <span>âœ“</span>
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
            </button>
            <div class="status-message" id="loginStatus"></div>
        </div>
        
        <!-- Main Interface with Tabs -->
        <div id="mainInterface" style="display: none;">
            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('add')">
                    <span>â•</span> Ø¥Ø¶Ø§ÙØ© ØªÙØªÙŠØ´ Ø¬Ø¯ÙŠØ¯
                </button>
                <button class="tab-button" onclick="switchTab('view')">
                    <span>ğŸ‘ï¸</span> Ø¹Ø±Ø¶ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª
                </button>
                <button class="tab-button" onclick="switchTab('stats')">
                    <span>ğŸ“Š</span> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØªØ´ÙŠÙ†
                </button>
                <button class="tab-button" onclick="switchTab('calendar')">
                    <span>ğŸ“…</span> Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠ
                </button>
                <button class="tab-button" onclick="switchTab('shops')">
                    <span>ğŸª</span> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª
                </button>
                <button class="tab-button" onclick="switchTab('areas')">
                    <span>ğŸ—ºï¸</span> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
                </button>
                <button class="tab-button" onclick="switchTab('maintenance')">
                    <span>ğŸ”§</span> Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«
                </button>
            </div>
            
            <!-- Tab Content: Add Inspection -->
            <div id="addTab" class="tab-content active">
                <div class="section">
            <h2 class="section-title">ğŸ“ Ø¥Ø¶Ø§ÙØ© ØªÙØªÙŠØ´ Ø¬Ø¯ÙŠØ¯</h2>
            
            <div class="form-group">
                <label class="form-label">Ø§Ù„Ù…ÙØªØ´</label>
                <select id="inspectorSelect" class="form-control" onchange="updateAvailableShops()">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <input type="date" id="inspectionDate" class="form-control" onchange="updateAvailableShops()">
            </div>
            
            <div class="form-group">
                <label class="form-label">Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</label>
                <select id="shiftSelect" class="form-control">
                    <option value="ØµØ¨Ø§Ø­ÙŠØ©">ØµØ¨Ø§Ø­ÙŠØ©</option>
                    <option value="Ù…Ø³Ø§Ø¦ÙŠØ©">Ù…Ø³Ø§Ø¦ÙŠØ©</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                <select id="areaSelect" class="form-control" onchange="updateAvailableShops()">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...</option>
                </select>
            </div>
            
            <!-- Filter Statistics -->
            <div class="filter-stats">
                <div class="stat-box">
                    <div class="value" id="totalShopsCount">0</div>
                    <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù„Ø§Øª</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="availableShopsCount">0</div>
                    <div class="label">Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="highPriorityCount">0</div>
                    <div class="label">Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="selectedShopsCount">0</div>
                    <div class="label">Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</div>
                </div>
            </div>
            
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label class="form-label" style="margin-bottom: 0;">Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©)</label>
                    <button id="showHighPriorityBtn" class="btn btn-warning btn-sm" onclick="toggleHighPriorityShops()" style="display: none; padding: 8px 16px;">
                        <span id="highPriorityBtnIcon">ğŸ‘ï¸</span>
                        <span id="highPriorityBtnText">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø°Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©</span>
                    </button>
                </div>
                <div id="shopsListContainer">
                    <p style="text-align: center; color: #999; padding: 20px;">
                        Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
                    </p>
                </div>
            </div>
            
            <!-- Selected Shops -->
            <div class="selected-shops" id="selectedShopsContainer" style="display: none;">
                <h3>Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ù„ØªÙØªÙŠØ´</h3>
                <div class="selected-shops-list" id="selectedShopsList"></div>
            </div>
            
            <!-- Inspection Preview -->
            <div class="inspection-preview" id="inspectionPreview" style="display: none;">
                <h3>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙØªÙŠØ´</h3>
                <div class="preview-item">
                    <strong>Ø§Ù„Ù…ÙØªØ´:</strong> <span id="previewInspector">-</span>
                </div>
                <div class="preview-item">
                    <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="previewDate">-</span>
                </div>
                <div class="preview-item">
                    <strong>Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©:</strong> <span id="previewShift">-</span>
                </div>
                <div class="preview-item">
                    <strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> <span id="previewArea">-</span>
                </div>
                <div class="preview-item">
                    <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª:</strong> <span id="previewShopsCount">0</span>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveInspection()" id="saveBtn" disabled>
                    <span>ğŸ’¾</span>
                    <span>Ø­ÙØ¸ Ø§Ù„ØªÙØªÙŠØ´ ÙÙˆØ±Ø§Ù‹</span>
                </button>
                <button class="btn btn-warning" onclick="resetForm()">
                    <span>ğŸ”„</span>
                    <span>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</span>
                </button>
            </div>
            
            <div class="status-message" id="planningStatus"></div>
                </div>
            </div>
            
            <!-- Tab Content: View Inspections -->
            <div id="viewTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">ğŸ‘ï¸ Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙØªÙŠØ´Ø§Øª</h2>
                    
                    <!-- Filter Bar -->
                    <div class="filter-bar">
                        <div class="filter-item">
                            <label class="form-label">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙØªØ´</label>
                            <select id="filterInspector" class="form-control" onchange="filterInspections()">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                            <select id="filterArea" class="form-control" onchange="filterInspections()">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="filterDateFrom" class="form-control" onchange="filterInspections()">
                        </div>
                        <div class="filter-item">
                            <label class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="filterDateTo" class="form-control" onchange="filterInspections()">
                        </div>
                    </div>
                    
                    <!-- Search Box -->
                    <div class="search-box">
                        <input type="text" id="searchBox" class="form-control" 
                               placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª (Ø§Ø³Ù… Ø§Ù„Ù…ÙØªØ´ØŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø§Ù„Ù…Ø­Ù„Ø§Øª...)" 
                               oninput="filterInspections()">
                        <span class="search-icon">ğŸ”</span>
                    </div>
                    
                    <!-- Inspections Table -->
                    <div id="inspectionsTableContainer">
                        <p style="text-align: center; color: #999; padding: 40px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª...</p>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-danger btn-sm" onclick="deleteSelectedInspections()">
                            <span>ğŸ—‘ï¸</span> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯
                        </button>
                        <button class="btn btn-info btn-sm" onclick="exportInspections()">
                            <span>ğŸ“¥</span> ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Statistics -->
            <div id="statsTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´</label>
                        <select id="statsInspector" class="form-control" onchange="loadInspectorStats()">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´...</option>
                        </select>
                    </div>
                    
                    <div id="statsContainer">
                        <div class="empty-state">
                            <div class="icon">ğŸ“Š</div>
                            <p>Ø§Ø®ØªØ± Ù…ÙØªØ´Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Calendar -->
            <div id="calendarTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">ğŸ“… Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠ</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±</label>
                        <input type="month" id="calendarMonth" class="form-control" onchange="loadCalendar()">
                    </div>
                    
                    <div id="calendarContainer">
                        <div class="empty-state">
                            <div class="icon">ğŸ“…</div>
                            <p>Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Shops Management -->
            <div id="shopsTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">ğŸª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h2>
                    
                    <!-- Smart Action Buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="openAddShopModal()">
                            <span>â•</span> Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„ Ø¬Ø¯ÙŠØ¯
                        </button>
                        <button class="btn btn-primary" onclick="refreshShopsList()">
                            <span>ğŸ”„</span> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                        </button>
                        <button class="btn btn-primary" onclick="reloadShopsFromExcel()">
                            <span>ğŸ“¥</span> ØªØ­Ù…ÙŠÙ„ Ù…Ù† Excel
                        </button>
                        <button class="btn btn-warning" onclick="exportShopsData()">
                            <span>ğŸ“¤</span> ØªØµØ¯ÙŠØ± JSON
                        </button>
                        <button class="btn btn-info" onclick="exportShopsToExcel()">
                            <span>ğŸ“Š</span> ØªØµØ¯ÙŠØ± Excel
                        </button>
                        <button class="btn btn-danger" onclick="bulkEditShops()">
                            <span>âœï¸</span> ØªØ¹Ø¯ÙŠÙ„ Ø¬Ù…Ø§Ø¹ÙŠ
                        </button>
                        <button class="btn btn-danger" onclick="bulkDeleteShops()">
                            <span>ğŸ—‘ï¸</span> Ø­Ø°Ù Ø¬Ù…Ø§Ø¹ÙŠ
                        </button>
                        <button class="btn btn-success" onclick="mergeShopsData()">
                            <span>ğŸ”—</span> Ø¯Ù…Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª
                        </button>
                        <button class="btn btn-info" onclick="validateShopsData()">
                            <span>âœ…</span> Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        </button>
                        <button class="btn btn-warning" onclick="viewShopsOnMap()">
                            <span>ğŸ—ºï¸</span> Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                        </button>
                        <button class="btn btn-success" onclick="openSmartShopListModal()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; font-weight: bold;">
                            <span>ğŸ“‹</span> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©
                        </button>
                    </div>
                    
                    <!-- Filter and Search -->
                    <div class="filter-bar">
                        <div class="filter-item">
                            <label class="form-label">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ù„</label>
                            <input type="text" id="searchShop" class="form-control" 
                                   placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." oninput="filterShopsList()">
                        </div>
                        <div class="filter-item">
                            <label class="form-label">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                            <select id="filterShopArea" class="form-control" onchange="filterShopsList()">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Shops Stats -->
                    <div class="inspector-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalShopsManagement">0</div>
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù„Ø§Øª</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="filteredShopsCount">0</div>
                            <div class="stat-label">Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalAreasInShops">0</div>
                            <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</div>
                        </div>
                    </div>
                    
                    <!-- Shops List Table -->
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table class="inspections-table" id="shopsManagementTable">
                            <thead>
                                <tr>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„</th>
                                    <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
                                    <th>Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="shopsManagementBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 40px;">
                                        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="status-message" id="shopsManagementStatus"></div>
                </div>
            </div>
            
            <!-- Tab Content: Maintenance Control -->
            <div id="maintenanceTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">ğŸ”§ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø·Ù„Ù‚ ÙÙŠ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ù„ÙƒØ§Ø´</h2>
                    
                    <!-- Cache Control Section -->
                    <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>ğŸš€</span>
                            <span>Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ ÙˆÙ…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø©</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            Ø²Ø± Ù‚ÙˆÙŠ Ù„Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ÙƒØ§Ø´ ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙÙˆØ±Ø§Ù‹ ÙÙŠ GitHub ÙˆØ§Ù„Ù…ØªØµÙØ­Ø§Øª (Safari, Chrome, Firefox)
                        </p>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button id="clearCacheBtn" class="btn btn-danger" onclick="forceCacheClear()" style="background: white; color: #ff6b6b; font-weight: bold;">
                                <span id="clearCacheIcon">ğŸš€</span>
                                <span id="clearCacheText">Ù…Ø³Ø­ Ù‚ÙˆÙŠ ÙˆÙÙˆØ±ÙŠ Ù„Ù„ÙƒØ§Ø´ (Safari + Chrome + Firefox)</span>
                            </button>
                            <button id="updateSWBtn" class="btn btn-warning" onclick="updateServiceWorker()" style="background: white; color: #ee5a6f;">
                                <span id="updateSWIcon">ğŸ”„</span>
                                <span id="updateSWText">ØªØ­Ø¯ÙŠØ« Service Worker ÙÙˆØ±Ø§Ù‹</span>
                            </button>
                        </div>
                        <div class="status-message" id="cacheControlStatus"></div>
                    </div>
                    
                    <!-- Maintenance Message Control Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>ğŸ“º</span>
                            <span>Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ù‚ØªØ©</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            ØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„ ÙˆÙ…Ø¨Ø§Ø´Ø± 100% ÙÙŠ Ø¸Ù‡ÙˆØ± ÙˆØ¥Ø®ÙØ§Ø¡ ÙˆØªÙØ¹ÙŠÙ„ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø±Ø³Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†"
                        </p>
                        
                        <!-- Enable/Disable Toggle -->
                        <div class="form-group">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>ğŸ”˜</span> Ø­Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«
                            </label>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <button id="enableMaintenanceBtn" class="btn btn-success" onclick="toggleMaintenanceMessage(true)" style="flex: 1;">
                                    <span>âœ…</span>
                                    <span>ØªÙØ¹ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«</span>
                                </button>
                                <button id="disableMaintenanceBtn" class="btn btn-danger" onclick="toggleMaintenanceMessage(false)" style="flex: 1;">
                                    <span>âŒ</span>
                                    <span>Ø¥ÙŠÙ‚Ø§Ù Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Current Status Display -->
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span>
                                <span id="maintenanceStatusLabel" style="font-size: 1.1em; font-weight: 700;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                            </div>
                        </div>
                        
                        <div class="status-message" id="maintenanceToggleStatus"></div>
                    </div>
                    
                    <!-- Music Control Section -->
                    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>ğŸµ</span>
                            <span>Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø·Ù„Ù‚ ÙÙŠ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            ØªØ­ÙƒÙ… ÙÙˆØ±ÙŠ ÙˆÙ…Ø¨Ø§Ø´Ø± 100% ÙÙŠ ØµÙˆØª Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ ÙˆØªÙ…ÙƒÙŠÙ†Ù‡Ø§/ØªØ¹Ø·ÙŠÙ„Ù‡Ø§ Ù…Ø¹ Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙÙŠ GitHub
                        </p>
                        
                        <!-- Music Enable/Disable -->
                        <div class="form-group">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>ğŸ”Š</span> Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
                            </label>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <button id="enableMusicBtn" class="btn btn-success" onclick="toggleMusic(true)" style="flex: 1;">
                                    <span>ğŸ”Š</span>
                                    <span>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰</span>
                                </button>
                                <button id="disableMusicBtn" class="btn btn-danger" onclick="toggleMusic(false)" style="flex: 1;">
                                    <span>ğŸ”‡</span>
                                    <span>Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Volume Control -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>ğŸšï¸</span> Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª (Ø­Ø¬Ù… Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰)
                            </label>
                            <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin-top: 10px;">
                                <input type="range" id="volumeSlider" min="0" max="100" value="10" 
                                       style="width: 100%; height: 8px; border-radius: 5px; cursor: pointer;"
                                       oninput="updateVolumeDisplay(this.value)"
                                       onchange="saveVolumeChange(this.value)">
                                <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9em;">
                                    <span>ğŸ”‡ 0%</span>
                                    <span id="volumeDisplay" style="font-size: 1.3em; font-weight: 700;">ğŸ”Š 10%</span>
                                    <span>ğŸ”Š 100%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Volume Presets -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" style="color: white; font-size: 1.1em;">
                                <span>âš¡</span> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ù„Ù„ØµÙˆØª
                            </label>
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <button class="btn btn-sm" onclick="setVolumePreset(0)" style="background: white; color: #11998e;">
                                    <span>ğŸ”‡</span> ÙƒØªÙ… Ø§Ù„ØµÙˆØª
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(10)" style="background: white; color: #11998e;">
                                    <span>ğŸ”‰</span> 10%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(25)" style="background: white; color: #11998e;">
                                    <span>ğŸ”‰</span> 25%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(40)" style="background: white; color: #11998e;">
                                    <span>ğŸ”Š</span> 40%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(50)" style="background: white; color: #11998e;">
                                    <span>ğŸ”Š</span> 50%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(75)" style="background: white; color: #11998e;">
                                    <span>ğŸ”Š</span> 75%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(100)" style="background: white; color: #11998e;">
                                    <span>ğŸ”Š</span> 100%
                                </button>
                            </div>
                        </div>
                        
                        <!-- Music Duration Control -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>â±ï¸</span> Ù…Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
                            </label>
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <button class="btn btn-sm" onclick="setMusicDuration(60)" style="background: white; color: #11998e;">
                                    <span>â±ï¸</span> Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(300)" style="background: white; color: #11998e;">
                                    <span>â±ï¸</span> 5 Ø¯Ù‚Ø§Ø¦Ù‚
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(600)" style="background: white; color: #11998e;">
                                    <span>â±ï¸</span> 10 Ø¯Ù‚Ø§Ø¦Ù‚
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(1800)" style="background: white; color: #11998e;">
                                    <span>â±ï¸</span> 30 Ø¯Ù‚ÙŠÙ‚Ø©
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(-1)" style="background: white; color: #11998e;">
                                    <span>â™¾ï¸</span> Ù…Ø³ØªÙ…Ø± (ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)
                                </button>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; margin-top: 10px;">
                                <span style="font-weight: 600;">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span>
                                <span id="musicDurationLabel" style="font-weight: 700; margin-right: 10px;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                            </div>
                        </div>
                        
                        <!-- Current Music Status -->
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰:</span>
                                <span id="musicStatusLabel" style="font-size: 1.1em; font-weight: 700;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                            </div>
                        </div>
                        
                        <div class="status-message" id="musicControlStatus"></div>
                    </div>
                    
                    <!-- Live Preview Section -->
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 25px; border-radius: 15px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>ğŸ‘ï¸</span>
                            <span>Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆØ­ÙŠØ© 100%</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØªÙ†Ø¹ÙƒØ³ ÙÙˆØ±Ø§Ù‹ ÙˆÙ…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ GitHub ÙˆØ¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ù…ØªØµÙØ­Ø§Øª
                        </p>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="margin-bottom: 10px;">
                                <span style="font-weight: 600;">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</span>
                                <span id="lastUpdateLabel" style="font-weight: 700; margin-right: 10px;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                            </div>
                            <div>
                                <span style="font-weight: 600;">ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØ§Ø³Ø·Ø©:</span>
                                <span id="updatedByLabel" style="font-weight: 700; margin-right: 10px;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="loadMaintenanceConfig()" style="margin-top: 15px; background: white; color: #fa709a;">
                            <span>ğŸ”„</span>
                            <span>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Areas Management -->
            <div id="areasTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">ğŸ—ºï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h2>
                    
                    <!-- Smart Action Buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="openAddAreaModal()">
                            <span>â•</span> Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©
                        </button>
                        <button class="btn btn-primary" onclick="refreshAreasList()">
                            <span>ğŸ”„</span> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                        </button>
                        <button class="btn btn-warning" onclick="sortAreasByName()">
                            <span>ğŸ”¤</span> ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹
                        </button>
                        <button class="btn btn-info" onclick="mergeAreas()">
                            <span>ğŸ”—</span> Ø¯Ù…Ø¬ Ù…Ù†Ø§Ø·Ù‚
                        </button>
                        <button class="btn btn-success" onclick="assignShopsToAreas()">
                            <span>ğŸ“</span> ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ù„Ø§Øª
                        </button>
                        <button class="btn btn-warning" onclick="exportAreasData()">
                            <span>ğŸ“¤</span> ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        </button>
                        <button class="btn btn-info" onclick="importAreasFromFile()">
                            <span>ğŸ“¥</span> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù†Ø§Ø·Ù‚
                        </button>
                        <button class="btn btn-danger" onclick="bulkEditAreas()">
                            <span>âœï¸</span> ØªØ¹Ø¯ÙŠÙ„ Ø¬Ù…Ø§Ø¹ÙŠ
                        </button>
                        <button class="btn btn-success" onclick="generateAreasReport()">
                            <span>ğŸ“Š</span> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
                        </button>
                    </div>
                    
                    <!-- Search -->
                    <div class="search-box">
                        <input type="text" id="searchArea" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø·Ù‚Ø©..." oninput="filterAreasList()">
                        <span class="search-icon">ğŸ”</span>
                    </div>
                    
                    <!-- Areas Stats -->
                    <div class="inspector-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalAreasManagement">0</div>
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="filteredAreasCount">0</div>
                            <div class="stat-label">Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalShopsInAreas">0</div>
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù„Ø§Øª</div>
                        </div>
                    </div>
                    
                    <!-- Areas List Table -->
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table class="inspections-table" id="areasManagementTable">
                            <thead>
                                <tr>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
                                    <th>Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ</th>
                                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="areasManagementBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 40px;">
                                        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="status-message" id="areasManagementStatus"></div>
                </div>
            </div>
        </div>
        
        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>âœï¸ ØªØ­Ø±ÙŠØ± Ø§Ù„ØªÙØªÙŠØ´</h2>
                    <span class="modal-close" onclick="closeEditModal()">&times;</span>
                </div>
                <input type="hidden" id="editInspectionIndex">
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…ÙØªØ´</label>
                    <select id="editInspector" class="form-control">
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="editDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</label>
                    <select id="editShift" class="form-control">
                        <option value="ØµØ¨Ø§Ø­ÙŠØ©">ØµØ¨Ø§Ø­ÙŠØ©</option>
                        <option value="Ù…Ø³Ø§Ø¦ÙŠØ©">Ù…Ø³Ø§Ø¦ÙŠØ©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                    <select id="editArea" class="form-control">
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ø­Ù„Ø§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)</label>
                    <textarea id="editShops" class="form-control" rows="6" 
                              placeholder="Ù…Ø­Ù„ 1ØŒ Ù…Ø­Ù„ 2ØŒ Ù…Ø­Ù„ 3..."></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveEditedInspection()">
                        <span>ğŸ’¾</span> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                    </button>
                    <button class="btn btn-warning" onclick="closeEditModal()">
                        <span>âœ•</span> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
                <div class="status-message" id="editStatus"></div>
            </div>
        </div>
        
        <!-- Add/Edit Shop Modal -->
        <div id="shopModal" class="modal">
            <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 id="shopModalTitle">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„ Ø¬Ø¯ÙŠØ¯</h2>
                    <span class="modal-close" onclick="closeShopModal()">&times;</span>
                </div>
                <input type="hidden" id="shopModalId">
                
                <!-- Required Fields Section -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #2d3561; font-size: 1.1em; margin-bottom: 15px;">ğŸ“‹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©)</h3>
                    <div class="form-group">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ <span style="color: red;">*</span></label>
                        <input type="text" id="shopModalName" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© <span style="color: red;">*</span></label>
                        <select id="shopModalArea" class="form-control">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...</option>
                        </select>
                    </div>
                </div>
                
                <!-- Optional Details Section -->
                <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #2d3561; font-size: 1.1em; margin-bottom: 15px;">ğŸ“ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</label>
                        <input type="text" id="shopModalNameEn" class="form-control" placeholder="Shop Name in English">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ</label>
                        <input type="text" id="shopModalLicense" class="form-control" placeholder="Ù…Ø«Ø§Ù„: CN-1234567">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                        <input type="text" id="shopModalAddress" class="form-control" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø­Ù„">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="tel" id="shopModalPhone" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 0501234567">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" id="shopModalEmail" class="form-control" placeholder="example@email.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ğŸ—ºï¸ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ù„ Ø¹Ù„Ù‰ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„</label>
                        <input type="url" id="shopModalGoogleMaps" class="form-control" placeholder="https://maps.google.com/...">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ğŸ’¡ Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ù„
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ø·Ø¨ÙŠØ¹Ø© Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø­Ù„</label>
                        <textarea id="shopModalActivity" class="form-control" rows="3" placeholder="Ù…Ø«Ø§Ù„: Ø¨ÙŠØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ø£Ù„ÙŠÙØ©ØŒ Ø¨ÙŠØ¹ Ø£Ø³Ù…Ø§Ùƒ Ø§Ù„Ø²ÙŠÙ†Ø©ØŒ Ø¨ÙŠØ¹ Ø§Ù„Ø·ÙŠÙˆØ±..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ø±Ù…Ø² ADM</label>
                        <input type="text" id="shopModalAdmCode" class="form-control" placeholder="Ù…Ø«Ø§Ù„: ADM0001">
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveShop()">
                        <span>ğŸ’¾</span> Ø­ÙØ¸ ÙÙˆØ±Ø§Ù‹
                    </button>
                    <button class="btn btn-warning" onclick="closeShopModal()">
                        <span>âœ•</span> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
                <div class="status-message" id="shopModalStatus"></div>
            </div>
        </div>
        
        <!-- Add/Edit Area Modal -->
        <div id="areaModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="areaModalTitle">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                    <span class="modal-close" onclick="closeAreaModal()">&times;</span>
                </div>
                <input type="hidden" id="areaModalId">
                <div class="form-group">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© <span style="color: red;">*</span></label>
                    <input type="text" id="areaModalName" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveArea()">
                        <span>ğŸ’¾</span> Ø­ÙØ¸
                    </button>
                    <button class="btn btn-warning" onclick="closeAreaModal()">
                        <span>âœ•</span> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
                <div class="status-message" id="areaModalStatus"></div>
            </div>
        </div>
        
        <!-- Merge Areas Modal -->
        <div id="mergeAreasModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2>ğŸ”— Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</h2>
                    <span class="modal-close" onclick="closeMergeAreasModal()">&times;</span>
                </div>
                
                <p style="color: #666; margin-bottom: 20px;">
                    Ø§Ø®ØªØ± Ù…Ù†Ø·Ù‚ØªÙŠÙ† Ø£Ùˆ Ø£ÙƒØ«Ø± Ù„Ø¯Ù…Ø¬Ù‡Ø§ ÙÙŠ Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ø­Ø¯Ø©. Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ù„Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.
                </p>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø³ÙŠØªÙ… Ø§Ù„Ø¯Ù…Ø¬ ÙÙŠÙ‡Ø§) <span style="color: red;">*</span></label>
                    <select id="mergeTargetArea" class="form-control">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¯Ù…Ø¬Ù‡Ø§ (Ø­Ø¯Ø¯ ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø£ÙƒØ«Ø±) <span style="color: red;">*</span></label>
                    <div id="mergeSourceAreasContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px;">
                        <!-- Checkboxes will be added here dynamically -->
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong>
                    <ul style="margin: 10px 0; padding-right: 20px;">
                        <li>Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</li>
                        <li>Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª Ù„Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ù†Ù‚ÙˆÙ„Ø©</li>
                        <li>Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© Ø¨Ø¹Ø¯ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ù„Ø§Øª</li>
                        <li>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</li>
                    </ul>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="executeMergeAreas()">
                        <span>ğŸ”—</span> ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯Ù…Ø¬
                    </button>
                    <button class="btn btn-warning" onclick="closeMergeAreasModal()">
                        <span>âœ•</span> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
                
                <div class="status-message" id="mergeAreasStatus"></div>
            </div>
        </div>
        
        <!-- Assign Shops to Areas Modal -->
        <div id="assignShopsModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2>ğŸ“ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ù„Ø§Øª Ù„Ù„Ù…Ù†Ø§Ø·Ù‚</h2>
                    <span class="modal-close" onclick="closeAssignShopsModal()">&times;</span>
                </div>
                
                <p style="color: #666; margin-bottom: 20px;">
                    Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©.
                </p>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù„Ù„ÙÙ„ØªØ±Ø©)</label>
                    <select id="assignShopsCurrentArea" class="form-control" onchange="loadShopsForAssignment()">
                        <option value="">-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© <span style="color: red;">*</span></label>
                    <select id="assignShopsTargetArea" class="form-control">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ù†Ù‚Ù„Ù‡Ø§ (Ø­Ø¯Ø¯ ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø£ÙƒØ«Ø±) <span style="color: red;">*</span>
                    </label>
                    <div style="margin-bottom: 10px;">
                        <input type="text" id="searchShopsForAssignment" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ù„..." oninput="filterShopsForAssignment()">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-info" onclick="selectAllShopsForAssignment()">
                            âœ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="deselectAllShopsForAssignment()">
                            âœ• Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                        </button>
                    </div>
                    <div id="assignShopsContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px;">
                        <!-- Checkboxes will be added here dynamically -->
                    </div>
                </div>
                
                <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª:</strong>
                    <ul style="margin: 10px 0; padding-right: 20px;">
                        <li>Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</li>
                        <li>Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…Ø­Ù„Ø§Øª</li>
                        <li>ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ù„Ø§Øª ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª</li>
                    </ul>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="executeAssignShops()">
                        <span>ğŸ“</span> ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ù„Ø§Øª
                    </button>
                    <button class="btn btn-warning" onclick="closeAssignShopsModal()">
                        <span>âœ•</span> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
                
                <div class="status-message" id="assignShopsStatus"></div>
            </div>
        </div>
        
        <!-- Bulk Edit Areas Modal -->
        <div id="bulkEditModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2>âœï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ù„Ù…Ù†Ø§Ø·Ù‚</h2>
                    <span class="modal-close" onclick="closeBulkEditModal()">&times;</span>
                </div>
                
                <p style="color: #666; margin-bottom: 20px;">
                    Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¯Ø© Ù…Ù†Ø§Ø·Ù‚ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ø¯Ø¦Ø© Ø£Ùˆ Ù„Ø§Ø­Ù‚Ø© Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø£Ùˆ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù†Øµ Ù…Ø¹ÙŠÙ†.
                </p>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ (Ø­Ø¯Ø¯ ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø£ÙƒØ«Ø±) <span style="color: red;">*</span></label>
                    <div style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-info" onclick="selectAllAreasForBulkEdit()">
                            âœ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="deselectAllAreasForBulkEdit()">
                            âœ• Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                        </button>
                    </div>
                    <div id="bulkEditAreasContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px;">
                        <!-- Checkboxes will be added here dynamically -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</label>
                    <select id="bulkEditType" class="form-control" onchange="toggleBulkEditOptions()">
                        <option value="prefix">Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ø¯Ø¦Ø© Ù„Ù„Ø£Ø³Ù…Ø§Ø¡</option>
                        <option value="suffix">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø­Ù‚Ø© Ù„Ù„Ø£Ø³Ù…Ø§Ø¡</option>
                        <option value="replace">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù†Øµ ÙÙŠ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</option>
                    </select>
                </div>
                
                <div id="bulkEditPrefixSuffix" style="display: block;">
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡</label>
                        <input type="text" id="bulkEditText" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù†Ø·Ù‚Ø©">
                    </div>
                </div>
                
                <div id="bulkEditReplace" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡</label>
                        <input type="text" id="bulkEditFindText" class="form-control" placeholder="Ø§Ù„Ù†Øµ Ø§Ù„Ù‚Ø¯ÙŠÙ…">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                        <input type="text" id="bulkEditReplaceText" class="form-control" placeholder="Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong>
                    <ul style="margin: 10px 0; padding-right: 20px;">
                        <li>Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙ‚Ø·</li>
                        <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°</li>
                        <li>Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</li>
                    </ul>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-info" onclick="previewBulkEdit()">
                        <span>ğŸ‘ï¸</span> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                    </button>
                    <button class="btn btn-success" onclick="executeBulkEdit()">
                        <span>âœï¸</span> ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                    </button>
                    <button class="btn btn-warning" onclick="closeBulkEditModal()">
                        <span>âœ•</span> Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
                
                <div id="bulkEditPreview" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="color: #2d3561; margin-bottom: 10px;">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª:</h3>
                    <div id="bulkEditPreviewContent"></div>
                </div>
                
                <div class="status-message" id="bulkEditStatus"></div>
            </div>
        </div>
        
        <!-- Smart Shop List Modal -->
        <div id="smartShopListModal" class="modal">
            <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</h2>
                    <span class="modal-close" onclick="closeSmartShopListModal()">&times;</span>
                </div>
                
                <!-- Filters and Controls -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                    <h3 style="margin-bottom: 15px;">âš™ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ… ÙˆØ§Ù„ØªØ±ØªÙŠØ¨</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:</label>
                            <select id="primarySort" class="form-control" onchange="updateSmartShopList()">
                                <option value="rating">Ø­Ø³Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø£ÙˆÙ„Ø§Ù‹)</option>
                                <option value="area">Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>
                                <option value="activity">Ø­Ø³Ø¨ Ø§Ù„Ù†Ø´Ø§Ø·</option>
                                <option value="alphabetical">Ø£Ø¨Ø¬Ø¯ÙŠ (Ø£-ÙŠ)</option>
                                <option value="lastInspection">Ø­Ø³Ø¨ Ø¢Ø®Ø± ØªÙØªÙŠØ´</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label>
                            <select id="smartListAreaFilter" class="form-control" onchange="updateSmartShopList()">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</label>
                            <select id="ratingFilter" class="form-control" onchange="updateSmartShopList()">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</option>
                                <option value="excellent">Ù…Ù…ØªØ§Ø² (90+)</option>
                                <option value="good">Ø¬ÙŠØ¯ (70-89)</option>
                                <option value="fair">Ù…Ù‚Ø¨ÙˆÙ„ (50-69)</option>
                                <option value="poor">Ø¶Ø¹ÙŠÙ (Ø£Ù‚Ù„ Ù…Ù† 50)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„:</label>
                            <select id="tableView" class="form-control" onchange="updateSmartShopList()">
                                <option value="unified">Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ­Ø¯</option>
                                <option value="byArea">Ø¬Ø¯ÙˆÙ„ Ù„ÙƒÙ„ Ù…Ù†Ø·Ù‚Ø©</option>
                                <option value="byActivity">Ø¬Ø¯ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù†Ø´Ø§Ø·</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="exportSmartShopList('excel')" style="background: white; color: #667eea;">
                            <span>ğŸ“Š</span> ØªØµØ¯ÙŠØ± Excel
                        </button>
                        <button class="btn btn-primary" onclick="exportSmartShopList('pdf')" style="background: white; color: #667eea;">
                            <span>ğŸ“„</span> ØªØµØ¯ÙŠØ± PDF
                        </button>
                        <button class="btn btn-info" onclick="exportSmartShopList('json')" style="background: white; color: #667eea;">
                            <span>ğŸ’¾</span> ØªØµØ¯ÙŠØ± JSON
                        </button>
                        <button class="btn btn-warning" onclick="printSmartShopList()" style="background: white; color: #667eea;">
                            <span>ğŸ–¨ï¸</span> Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                    </div>
                </div>
                
                <!-- Statistics Summary -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div style="background: #667eea; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListTotalShops">0</div>
                        <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù„Ø§Øª</div>
                    </div>
                    <div style="background: #11998e; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListAvgRating">0</div>
                        <div>Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</div>
                    </div>
                    <div style="background: #3498db; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListAreas">0</div>
                        <div>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</div>
                    </div>
                    <div style="background: #e74c3c; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListHighPriority">0</div>
                        <div>Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©</div>
                    </div>
                </div>
                
                <!-- Shop List Content -->
                <div id="smartShopListContent" style="margin-top: 20px;">
                    <p style="text-align: center; padding: 40px; color: #999;">
                        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø°ÙƒÙŠØ©...
                    </p>
                </div>
                
                <div class="status-message" id="smartShopListStatus"></div>
            </div>
        </div>
        
        <!-- Bell Notifications Control Modal -->
        <div id="bellNotificationsModal" class="bell-modal">
            <div class="bell-modal-content">
                <div class="bell-modal-header">
                    <h2>ğŸ”” Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø±Ø³</h2>
                    <button class="bell-modal-close" onclick="closeBellNotificationsControl()">&times;</button>
                </div>
                
                <div class="bell-status-message" id="bellStatusMessage"></div>
                
                <!-- Add New Notification Section -->
                <!-- Global Bell Settings Control Panel -->
                <div class="bell-control-panel">
                    <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
                    <div class="bell-control-row">
                        <div class="bell-control-item">
                            <label>â±ï¸ Ù…Ø¯Ø© Ø¸Ù‡ÙˆØ± ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ):</label>
                            <input type="number" id="bellBubbleDuration" value="24" min="5" max="120" 
                                   onchange="updateBellBubbleDuration()" 
                                   style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 8px;">
                            <small style="color: #6c757d; display: block; margin-top: 5px;">
                                ğŸ’¡ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: 24 Ø«Ø§Ù†ÙŠØ© (ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† 5 Ø¥Ù„Ù‰ 120 Ø«Ø§Ù†ÙŠØ©)
                            </small>
                        </div>
                        <div class="bell-control-item">
                            <label>ğŸ”” ØªÙØ¹ÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:</label>
                            <select id="bellSoundEnabled" onchange="updateBellSoundSetting()" 
                                    style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 8px;">
                                <option value="true">Ù…ÙØ¹Ù‘Ù„ âœ…</option>
                                <option value="false">Ù…Ø¹Ø·Ù‘Ù„ âŒ</option>
                            </select>
                        </div>
                        <div class="bell-control-item">
                            <label>ğŸ¨ Ù†Ù…Ø· Ø§Ù„Ø¹Ø±Ø¶:</label>
                            <select id="bellDisplayStyle" onchange="updateBellDisplayStyle()" 
                                    style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 8px;">
                                <option value="modern">Ø¹ØµØ±ÙŠ âœ¨</option>
                                <option value="classic">ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ ğŸ“œ</option>
                                <option value="minimal">Ø¨Ø³ÙŠØ· ğŸ¯</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="notification-add-section">
                    <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
                    <p style="color: #6c757d; margin-bottom: 15px; font-size: 0.95em;">
                        Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¬Ø±Ø³ ğŸ”” Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                    </p>
                    <textarea 
                        id="newBellNotificationText" 
                        class="notification-input" 
                        placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù‡Ù†Ø§... (Ù…Ø«Ø§Ù„: ØªÙ… ØªØ­Ø¯ÙŠØ« Ø®Ø·Ø© Ø§Ù„ØªÙØªÙŠØ´ Ù„Ø´Ù‡Ø± Ù†ÙˆÙÙ…Ø¨Ø±)"
                        dir="rtl"
                    ></textarea>
                    <input 
                        type="text" 
                        id="newBellNotificationAuthor" 
                        class="notification-author-input" 
                        placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù/Ø§Ù„Ù…Ø±Ø³Ù„ (Ù…Ø«Ø§Ù„: Ø¯. Ø¹Ù„ÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø§Ù„)"
                        value="Ø¯. Ø¹Ù„ÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø§Ù„"
                        dir="rtl"
                    />
                    
                    <!-- Enhanced notification settings -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 600;">ğŸ“Œ Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:</label>
                            <select id="newBellNotificationPriority" style="width: 100%; padding: 8px; border: 2px solid #ced4da; border-radius: 8px;">
                                <option value="high">Ø¹Ø§Ù„ÙŠØ© ğŸ”´</option>
                                <option value="medium" selected>Ù…ØªÙˆØ³Ø·Ø© ğŸŸ¡</option>
                                <option value="low">Ù…Ù†Ø®ÙØ¶Ø© ğŸŸ¢</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 600;">â±ï¸ Ù…Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…):</label>
                            <input type="number" id="newBellNotificationDuration" value="7" min="1" max="365" 
                                   style="width: 100%; padding: 8px; border: 2px solid #ced4da; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <button class="notification-add-btn" onclick="addBellNotification()">
                        â• Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø±
                    </button>
                </div>
                
                <!-- Existing Notifications List -->
                <div class="notifications-list">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #2d3561; font-size: 1.4em; margin: 0;">ğŸ“‹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                        <div class="bell-bulk-actions">
                            <button class="bell-bulk-btn" onclick="sortBellNotificationsByPriority()" 
                                    style="background: #17a2b8; color: white;">
                                ğŸ”½ ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
                            </button>
                            <button class="bell-bulk-btn" onclick="sortBellNotificationsByDate()" 
                                    style="background: #6c757d; color: white;">
                                ğŸ“… ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
                            </button>
                            <button class="bell-bulk-btn" onclick="deleteExpiredNotifications()" 
                                    style="background: #dc3545; color: white;">
                                ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
                            </button>
                        </div>
                    </div>
                    <div id="bellNotificationsList">
                        <p style="text-align: center; padding: 40px; color: #999;">
                            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...
                        </p>
                    </div>
                </div>
                
                <!-- Save All Button -->
                <button class="bell-save-all-btn" onclick="saveAllBellNotifications()">
                    ğŸ’¾ Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHub
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let planData = null;
        let shopsDetails = null;
        let selectedShops = [];
        let githubToken = null;
        const repo = "aliabdelaal-adm/Monthly_inspection_plan";
        let currentEditingIndex = -1;
        let selectedInspectionsForDelete = [];
        let showingHighPriority = false;
        let currentAvailableShops = [];
        let currentHighPriorityShops = [];
        
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'view') {
                loadInspectionsView();
            } else if (tabName === 'stats') {
                populateStatsInspector();
            } else if (tabName === 'calendar') {
                // Set default month to current month
                const now = new Date();
                document.getElementById('calendarMonth').value = 
                    `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                loadCalendar();
            } else if (tabName === 'shops') {
                loadShopsManagement();
            } else if (tabName === 'areas') {
                loadAreasManagement();
            }
        }
        
        // Login developer
        async function loginDeveloper() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                showMessage('loginStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ GitHub Token');
                return;
            }
            
            githubToken = token;
            localStorage.setItem('devToken', token);
            
            showMessage('loginStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...');
            
            try {
                // Load data from GitHub
                await loadPlanData();
                await loadShopsDetails();
                
                // Initialize UI
                populateInspectors();
                populateAreas();
                populateFilterDropdowns();
                
                // Set default date to today
                document.getElementById('inspectionDate').valueAsDate = new Date();
                
                // Hide login section and show main interface
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainInterface').style.display = 'block';
                
                showMessage('loginStatus', 'success', 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
                
            } catch (error) {
                showMessage('loginStatus', 'error', 'âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
                githubToken = null;
            }
        }
        
        // Load plan data from GitHub
        async function loadPlanData() {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!res.ok) {
                throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ plan-data.json');
            }
            
            const file = await res.json();
            planData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
        }
        
        // Load shops details from GitHub
        async function loadShopsDetails() {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!res.ok) {
                throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ shops_details.json');
            }
            
            const file = await res.json();
            shopsDetails = JSON.parse(decodeURIComponent(escape(atob(file.content))));
        }
        
        // Populate inspectors dropdown
        function populateInspectors() {
            const select = document.getElementById('inspectorSelect');
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const option = document.createElement('option');
                    option.value = inspector.name;
                    option.textContent = inspector.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Populate areas dropdown
        function populateAreas() {
            const select = document.getElementById('areaSelect');
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.name;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Update available shops based on selection
        function updateAvailableShops() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector || !date || !area) {
                document.getElementById('shopsListContainer').innerHTML = 
                    '<p style="text-align: center; color: #999; padding: 20px;">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</p>';
                document.getElementById('showHighPriorityBtn').style.display = 'none';
                return;
            }
            
            // Get all shops for the selected area
            const allShops = getAllShopsInArea(area);
            
            // Filter shops based on smart rules
            const availableShops = filterSmartShops(allShops, inspector, date);
            
            // Sort shops by priority
            const sortedShops = sortShopsByPriority(availableShops, inspector, date);
            
            // Get high-priority shops that were filtered out
            const unavailableShops = allShops.filter(shop => !availableShops.includes(shop));
            const highPriorityUnavailable = sortShopsByPriority(unavailableShops, inspector, date)
                .filter(shop => shop.priority === 'very-high' || shop.priority === 'high');
            
            // Store for later use
            currentAvailableShops = sortedShops;
            currentHighPriorityShops = highPriorityUnavailable;
            
            // Show/hide the high priority button based on availability
            const highPriorityBtn = document.getElementById('showHighPriorityBtn');
            if (currentHighPriorityShops.length > 0) {
                highPriorityBtn.style.display = 'inline-flex';
            } else {
                highPriorityBtn.style.display = 'none';
            }
            
            // Reset showing state
            showingHighPriority = false;
            document.getElementById('highPriorityBtnText').textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø°Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©';
            document.getElementById('highPriorityBtnIcon').textContent = 'ğŸ‘ï¸';
            
            // Update statistics
            updateStatistics(allShops.length, availableShops.length, sortedShops);
            
            // Display shops
            displayShops(sortedShops);
        }
        
        // Get all shops in an area
        function getAllShopsInArea(area) {
            const shops = [];
            
            if (!planData) return shops;
            
            // First, try to get shops from the planData.shops array (primary source)
            if (planData.shops && planData.areas) {
                // Find the area ID for the given area name
                const areaObj = planData.areas.find(a => a.name === area);
                
                if (areaObj) {
                    // Get all shops that belong to this area
                    const shopsInArea = planData.shops
                        .filter(shop => shop.areaId === areaObj.id)
                        .map(shop => shop.name);
                    
                    if (shopsInArea.length > 0) {
                        return shopsInArea;
                    }
                }
            }
            
            // Fallback: Collect all unique shops from inspection history
            // This ensures backward compatibility if shops array is not available
            if (planData.inspectionData) {
                const shopSet = new Set();
                planData.inspectionData.forEach(inspection => {
                    if (inspection.area === area && inspection.shops) {
                        inspection.shops.forEach(shop => shopSet.add(shop));
                    }
                });
                
                return Array.from(shopSet);
            }
            
            return shops;
        }
        
        // Filter shops based on smart rules
        function filterSmartShops(shops, inspector, date) {
            const available = [];
            
            shops.forEach(shop => {
                // Rule 1: Check if shop is already assigned to ANY inspector on the same day
                const assignedToday = isShopAssignedToday(shop, date);
                
                // Rule 2: Check if shop was inspected by THIS inspector in the last 7 days
                const recentlyInspected = wasShopRecentlyInspected(shop, inspector, date);
                
                // If shop passes both rules, it's available
                if (!assignedToday && !recentlyInspected) {
                    available.push(shop);
                }
            });
            
            return available;
        }
        
        // Check if shop is already assigned to any inspector on the same day
        function isShopAssignedToday(shop, date) {
            if (!planData || !planData.inspectionData) return false;
            
            return planData.inspectionData.some(inspection => {
                return inspection.day === date && 
                       inspection.shops && 
                       inspection.shops.includes(shop);
            });
        }
        
        // Check if shop was recently inspected by the same inspector (within 7 days)
        function wasShopRecentlyInspected(shop, inspector, date) {
            if (!planData || !planData.inspectionData) return false;
            
            const targetDate = new Date(date);
            const sevenDaysAgo = new Date(targetDate);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            return planData.inspectionData.some(inspection => {
                if (inspection.inspector !== inspector) return false;
                if (!inspection.shops || !inspection.shops.includes(shop)) return false;
                
                const inspectionDate = new Date(inspection.day);
                return inspectionDate > sevenDaysAgo && inspectionDate < targetDate;
            });
        }
        
        // Sort shops by priority
        function sortShopsByPriority(shops, inspector, date) {
            return shops.map(shop => {
                const priority = calculateShopPriority(shop, inspector, date);
                return { name: shop, priority: priority.level, score: priority.score, reason: priority.reason };
            }).sort((a, b) => b.score - a.score);
        }
        
        // Calculate shop priority
        function calculateShopPriority(shop, inspector, date) {
            let score = 0;
            let reasons = [];
            
            // Find last inspection date for this shop (by any inspector)
            const lastInspection = getLastInspectionDate(shop);
            
            if (!lastInspection) {
                score += 100; // Never inspected = highest priority
                reasons.push('Ù„Ù… ÙŠØªÙ… ØªÙØªÙŠØ´Ù‡ Ù…Ù† Ù‚Ø¨Ù„');
            } else {
                const targetDate = new Date(date);
                const lastDate = new Date(lastInspection);
                const daysSince = Math.floor((targetDate - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysSince > 30) {
                    score += 80;
                    reasons.push(`Ø¢Ø®Ø± ØªÙØªÙŠØ´ Ù‚Ø¨Ù„ ${daysSince} ÙŠÙˆÙ…`);
                } else if (daysSince > 21) {
                    score += 60;
                    reasons.push(`Ø¢Ø®Ø± ØªÙØªÙŠØ´ Ù‚Ø¨Ù„ ${daysSince} ÙŠÙˆÙ…`);
                } else if (daysSince > 14) {
                    score += 40;
                    reasons.push(`Ø¢Ø®Ø± ØªÙØªÙŠØ´ Ù‚Ø¨Ù„ ${daysSince} ÙŠÙˆÙ…`);
                } else {
                    score += 20;
                    reasons.push(`Ø¢Ø®Ø± ØªÙØªÙŠØ´ Ù‚Ø¨Ù„ ${daysSince} ÙŠÙˆÙ…`);
                }
            }
            
            // Priority based on shop type (if available in shops_details)
            if (shopsDetails && shopsDetails[shop]) {
                const activity = shopsDetails[shop].activity || '';
                if (activity.includes('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„Ù‡Ø§')) {
                    score += 30;
                    reasons.push('Ù†Ø´Ø§Ø· ÙŠØªØ·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
                }
            }
            
            // Check if we're in the second half of the month (from 15th onwards)
            // Boost priority for high-priority shops to ensure they're inspected before month end
            const targetDate = new Date(date);
            const dayOfMonth = targetDate.getDate();
            if (dayOfMonth >= 15) {
                // From the 15th onwards, boost high priority shops to "very high"
                if (score >= 80) {
                    score += 50; // Boost very high priority shops even more
                    reasons.push('Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù†ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…Ù† Ø§Ù„Ø´Ù‡Ø±');
                } else if (score >= 50) {
                    score += 20; // Moderate boost for medium priority
                }
            }
            
            // Determine priority level
            let level = 'low';
            if (score >= 130) level = 'very-high'; // Very high priority (from 15th onwards)
            else if (score >= 80) level = 'high';
            else if (score >= 50) level = 'medium';
            
            return { level, score, reason: reasons.join(' - ') };
        }
        
        // Get last inspection date for a shop
        function getLastInspectionDate(shop) {
            if (!planData || !planData.inspectionData) return null;
            
            let lastDate = null;
            
            planData.inspectionData.forEach(inspection => {
                if (inspection.shops && inspection.shops.includes(shop)) {
                    if (!lastDate || inspection.day > lastDate) {
                        lastDate = inspection.day;
                    }
                }
            });
            
            return lastDate;
        }
        
        // Update statistics
        function updateStatistics(total, available, sortedShops) {
            document.getElementById('totalShopsCount').textContent = total;
            document.getElementById('availableShopsCount').textContent = available;
            
            const veryHighPriority = sortedShops.filter(s => s.priority === 'very-high').length;
            const highPriority = sortedShops.filter(s => s.priority === 'high').length;
            document.getElementById('highPriorityCount').textContent = veryHighPriority + highPriority;
            
            document.getElementById('selectedShopsCount').textContent = selectedShops.length;
        }
        
        // HTML escape function to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Display shops
        function displayShops(shops, showingHighPriority = false) {
            const container = document.getElementById('shopsListContainer');
            
            if (shops.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>';
                return;
            }
            
            // Clear container (except info message if it exists)
            const infoDiv = document.getElementById('highPriorityInfo');
            container.innerHTML = '';
            if (infoDiv && showingHighPriority) {
                container.appendChild(infoDiv);
            }
            
            // Create shops list container
            const shopsListDiv = document.createElement('div');
            shopsListDiv.className = 'shops-list';
            
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            
            shops.forEach(shop => {
                const isSelected = selectedShops.includes(shop.name);
                const lastInspection = getLastInspectionDate(shop.name);
                
                // Check if this shop is from the high-priority unavailable list
                const isHighPriorityUnavailable = currentHighPriorityShops.some(s => s.name === shop.name);
                
                // Create shop card element
                const shopCard = document.createElement('div');
                shopCard.className = `shop-card ${shop.priority}-priority ${isSelected ? 'selected' : ''}`;
                
                // Add visual indicator for high-priority unavailable shops
                if (isHighPriorityUnavailable) {
                    shopCard.style.border = '3px solid #ff6b6b';
                    shopCard.style.opacity = '0.85';
                }
                
                shopCard.onclick = function() { toggleShop(shop.name); };
                
                // Priority badge
                const priorityBadge = document.createElement('div');
                priorityBadge.className = `priority-badge ${shop.priority}`;
                priorityBadge.textContent = shop.priority === 'very-high' ? 'Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹' :
                                            shop.priority === 'high' ? 'Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©' : 
                                            shop.priority === 'medium' ? 'Ø£ÙˆÙ„ÙˆÙŠØ© Ù…ØªÙˆØ³Ø·Ø©' : 'Ø£ÙˆÙ„ÙˆÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©';
                
                // Shop name
                const shopName = document.createElement('div');
                shopName.className = 'shop-name';
                shopName.textContent = shop.name;
                
                // Shop info - score
                const shopScore = document.createElement('div');
                shopScore.className = 'shop-info';
                shopScore.textContent = 'ğŸ“Š Ø§Ù„Ù†Ù‚Ø§Ø·: ' + shop.score;
                
                // Shop info - reason
                const shopReason = document.createElement('div');
                shopReason.className = 'shop-info';
                shopReason.textContent = 'ğŸ“ ' + shop.reason;
                
                // Warning for high-priority unavailable shops
                let warningDiv = null;
                if (isHighPriorityUnavailable) {
                    warningDiv = document.createElement('div');
                    warningDiv.style.cssText = 'background: #fff3cd; color: #856404; padding: 8px; border-radius: 5px; font-size: 0.85em; margin-top: 8px;';
                    
                    // Check why it's unavailable
                    const assignedToday = isShopAssignedToday(shop.name, date);
                    const recentlyInspected = wasShopRecentlyInspected(shop.name, inspector, date);
                    
                    if (assignedToday) {
                        warningDiv.textContent = 'âš ï¸ Ù…ÙƒØ±Ø±: ØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡ Ù„Ù…ÙØªØ´ Ø¢Ø®Ø± Ø§Ù„ÙŠÙˆÙ…';
                    } else if (recentlyInspected) {
                        warningDiv.textContent = 'âš ï¸ ØªÙ… Ø§Ù„ØªÙØªÙŠØ´: Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…';
                    }
                }
                
                // Last inspection
                const lastInspectionDiv = document.createElement('div');
                lastInspectionDiv.className = 'last-inspection';
                lastInspectionDiv.textContent = 'ğŸ“… Ø¢Ø®Ø± ØªÙØªÙŠØ´: ' + (lastInspection || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙØªÙŠØ´ Ø¨Ø¹Ø¯');
                
                // Append all elements
                shopCard.appendChild(priorityBadge);
                shopCard.appendChild(shopName);
                shopCard.appendChild(shopScore);
                shopCard.appendChild(shopReason);
                if (warningDiv) {
                    shopCard.appendChild(warningDiv);
                }
                shopCard.appendChild(lastInspectionDiv);
                
                shopsListDiv.appendChild(shopCard);
            });
            
            container.appendChild(shopsListDiv);
        }
        
        // Toggle shop selection
        function toggleShop(shopName) {
            const index = selectedShops.indexOf(shopName);
            
            if (index > -1) {
                selectedShops.splice(index, 1);
            } else {
                selectedShops.push(shopName);
            }
            
            updateSelectedShopsDisplay();
            updateAvailableShops();
            updatePreview();
        }
        
        // Update selected shops display
        function updateSelectedShopsDisplay() {
            const container = document.getElementById('selectedShopsContainer');
            const list = document.getElementById('selectedShopsList');
            
            if (selectedShops.length === 0) {
                container.style.display = 'none';
                document.getElementById('saveBtn').disabled = true;
                return;
            }
            
            container.style.display = 'block';
            document.getElementById('saveBtn').disabled = false;
            
            // Clear list
            list.innerHTML = '';
            
            // Create shop tags safely
            selectedShops.forEach(shop => {
                const tag = document.createElement('div');
                tag.className = 'selected-shop-tag';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = shop;
                
                const removeSpan = document.createElement('span');
                removeSpan.className = 'remove';
                removeSpan.textContent = 'Ã—';
                removeSpan.onclick = function() { toggleShop(shop); };
                
                tag.appendChild(nameSpan);
                tag.appendChild(removeSpan);
                list.appendChild(tag);
            });
            
            document.getElementById('selectedShopsCount').textContent = selectedShops.length;
        }
        
        // Update preview
        function updatePreview() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const shift = document.getElementById('shiftSelect').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector || !date || !area || selectedShops.length === 0) {
                document.getElementById('inspectionPreview').style.display = 'none';
                return;
            }
            
            document.getElementById('inspectionPreview').style.display = 'block';
            document.getElementById('previewInspector').textContent = inspector;
            document.getElementById('previewDate').textContent = date;
            document.getElementById('previewShift').textContent = shift;
            document.getElementById('previewArea').textContent = area;
            document.getElementById('previewShopsCount').textContent = selectedShops.length;
        }
        
        // Toggle high priority shops display
        function toggleHighPriorityShops() {
            showingHighPriority = !showingHighPriority;
            
            if (showingHighPriority) {
                // Show both available and high-priority shops
                const combinedShops = [...currentAvailableShops, ...currentHighPriorityShops];
                displayShops(combinedShops, true);
                
                // Update button text
                document.getElementById('highPriorityBtnText').textContent = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø°Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©';
                document.getElementById('highPriorityBtnIcon').textContent = 'ğŸš«';
                
                // Show info message
                const container = document.getElementById('shopsListContainer');
                const infoDiv = document.createElement('div');
                infoDiv.id = 'highPriorityInfo';
                infoDiv.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;';
                infoDiv.innerHTML = `
                    <strong>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡:</strong> ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø°Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ù„ÙŠØ© Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©.
                    <br>
                    <small style="color: #856404;">Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ù‚Ø¯ Ù„Ø§ ØªØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø°ÙƒÙŠ (ØªÙ… ØªÙØªÙŠØ´Ù‡Ø§ Ù…Ø¤Ø®Ø±Ø§Ù‹ Ø£Ùˆ Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…)</small>
                `;
                container.insertBefore(infoDiv, container.firstChild);
            } else {
                // Show only available shops
                displayShops(currentAvailableShops);
                
                // Update button text
                document.getElementById('highPriorityBtnText').textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø°Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©';
                document.getElementById('highPriorityBtnIcon').textContent = 'ğŸ‘ï¸';
                
                // Remove info message
                const infoDiv = document.getElementById('highPriorityInfo');
                if (infoDiv) {
                    infoDiv.remove();
                }
            }
        }
        
        // Populate filter dropdowns
        function populateFilterDropdowns() {
            // Populate inspector filter
            const filterInspector = document.getElementById('filterInspector');
            const statsInspector = document.getElementById('statsInspector');
            const editInspector = document.getElementById('editInspector');
            
            filterInspector.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</option>';
            statsInspector.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´...</option>';
            editInspector.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const opt1 = document.createElement('option');
                    opt1.value = inspector.name;
                    opt1.textContent = inspector.name;
                    filterInspector.appendChild(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = inspector.name;
                    opt2.textContent = inspector.name;
                    statsInspector.appendChild(opt2);
                    
                    const opt3 = document.createElement('option');
                    opt3.value = inspector.name;
                    opt3.textContent = inspector.name;
                    editInspector.appendChild(opt3);
                });
            }
            
            // Populate area filter
            const filterArea = document.getElementById('filterArea');
            const editArea = document.getElementById('editArea');
            
            filterArea.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>';
            editArea.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const opt1 = document.createElement('option');
                    opt1.value = area.name;
                    opt1.textContent = area.name;
                    filterArea.appendChild(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = area.name;
                    opt2.textContent = area.name;
                    editArea.appendChild(opt2);
                });
            }
        }
        
        // Load inspections view
        function loadInspectionsView() {
            filterInspections();
        }
        
        // Filter inspections
        function filterInspections() {
            if (!planData || !planData.inspectionData) {
                document.getElementById('inspectionsTableContainer').innerHTML = 
                    '<div class="empty-state"><div class="icon">ğŸ“­</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØªÙŠØ´Ø§Øª Ù…ØªØ§Ø­Ø©</p></div>';
                return;
            }
            
            const filterInspector = document.getElementById('filterInspector').value;
            const filterArea = document.getElementById('filterArea').value;
            const filterDateFrom = document.getElementById('filterDateFrom').value;
            const filterDateTo = document.getElementById('filterDateTo').value;
            const searchText = document.getElementById('searchBox').value.toLowerCase();
            
            let filtered = planData.inspectionData.filter(inspection => {
                // Filter by inspector
                if (filterInspector && inspection.inspector !== filterInspector) return false;
                
                // Filter by area
                if (filterArea && inspection.area !== filterArea) return false;
                
                // Filter by date range
                if (filterDateFrom && inspection.day < filterDateFrom) return false;
                if (filterDateTo && inspection.day > filterDateTo) return false;
                
                // Filter by search text
                if (searchText) {
                    const searchIn = `${inspection.inspector} ${inspection.area} ${inspection.shops.join(' ')}`.toLowerCase();
                    if (!searchIn.includes(searchText)) return false;
                }
                
                return true;
            });
            
            // Sort by date (newest first)
            filtered.sort((a, b) => b.day.localeCompare(a.day));
            
            displayInspectionsTable(filtered);
        }
        
        // Display inspections table
        function displayInspectionsTable(inspections) {
            const container = document.getElementById('inspectionsTableContainer');
            
            if (inspections.length === 0) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">ğŸ”</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„ØªØ±Ø©</p></div>';
                return;
            }
            
            let html = '<table class="inspections-table">';
            html += '<thead><tr>';
            html += '<th><input type="checkbox" onchange="toggleAllCheckboxes(this)"></th>';
            html += '<th>Ø§Ù„Ù…ÙØªØ´</th>';
            html += '<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>';
            html += '<th>Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</th>';
            html += '<th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>';
            html += '<th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª</th>';
            html += '<th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>';
            html += '</tr></thead><tbody>';
            
            inspections.forEach((inspection, index) => {
                // Find original index in planData
                const originalIndex = planData.inspectionData.indexOf(inspection);
                
                html += '<tr>';
                html += `<td><input type="checkbox" class="inspection-checkbox" value="${originalIndex}"></td>`;
                html += `<td>${escapeHtml(inspection.inspector)}</td>`;
                html += `<td>${inspection.day}</td>`;
                html += `<td>${escapeHtml(inspection.shift || 'ØµØ¨Ø§Ø­ÙŠØ©')}</td>`;
                html += `<td>${escapeHtml(inspection.area)}</td>`;
                html += `<td>${inspection.shops ? inspection.shops.length : 0}</td>`;
                html += `<td>
                    <span class="action-icon edit-icon" onclick="openEditModal(${originalIndex})" title="ØªØ­Ø±ÙŠØ±">âœï¸</span>
                    <span class="action-icon delete-icon" onclick="deleteInspection(${originalIndex})" title="Ø­Ø°Ù">ğŸ—‘ï¸</span>
                    <span class="action-icon copy-icon" onclick="copyInspection(${originalIndex})" title="Ù†Ø³Ø®">ğŸ“‹</span>
                </td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Toggle all checkboxes
        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('.inspection-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = source.checked;
            });
        }
        
        // Open edit modal
        function openEditModal(index) {
            const inspection = planData.inspectionData[index];
            
            document.getElementById('editInspectionIndex').value = index;
            document.getElementById('editInspector').value = inspection.inspector;
            document.getElementById('editDate').value = inspection.day;
            document.getElementById('editShift').value = inspection.shift || 'ØµØ¨Ø§Ø­ÙŠØ©';
            document.getElementById('editArea').value = inspection.area;
            document.getElementById('editShops').value = inspection.shops.join('ØŒ ');
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editStatus').className = 'status-message';
        }
        
        // Save edited inspection
        async function saveEditedInspection() {
            const index = parseInt(document.getElementById('editInspectionIndex').value);
            const inspector = document.getElementById('editInspector').value;
            const date = document.getElementById('editDate').value;
            const shift = document.getElementById('editShift').value;
            const area = document.getElementById('editArea').value;
            const shopsText = document.getElementById('editShops').value;
            
            if (!inspector || !date || !area || !shopsText) {
                showMessage('editStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
                return;
            }
            
            // Parse shops
            const shops = shopsText.split('ØŒ').map(s => s.trim()).filter(s => s);
            
            if (shops.length === 0) {
                showMessage('editStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            showMessage('editStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª...');
            
            try {
                // Check for duplicates (excluding current inspection)
                const duplicateIndex = planData.inspectionData.findIndex((insp, idx) => 
                    idx !== index && 
                    insp.inspector === inspector && 
                    insp.day === date
                );
                
                if (duplicateIndex !== -1) {
                    if (confirm('ÙŠÙˆØ¬Ø¯ ØªÙØªÙŠØ´ Ù…ÙƒØ±Ø± Ù„Ù†ÙØ³ Ø§Ù„Ù…ÙØªØ´ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ù‚Ø¯ÙŠÙ…ØŸ')) {
                        // Delete the duplicate
                        planData.inspectionData.splice(duplicateIndex, 1);
                        // Adjust index if needed
                        if (duplicateIndex < index) {
                            index--;
                        }
                    } else {
                        showMessage('editStatus', 'error', 'âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­ÙØ¸ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±');
                        return;
                    }
                }
                
                // Update inspection
                planData.inspectionData[index] = {
                    inspector: inspector,
                    day: date,
                    shift: shift,
                    area: area,
                    shops: shops
                };
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`ØªØ­Ø¯ÙŠØ« ØªÙØªÙŠØ´ - ${inspector} - ${date}`);
                
                showMessage('editStatus', 'success', 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                
                setTimeout(() => {
                    closeEditModal();
                    filterInspections();
                }, 2000);
                
            } catch (error) {
                showMessage('editStatus', 'error', 'âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª: ' + error.message);
            }
        }
        
        // Delete inspection
        async function deleteInspection(index) {
            const inspection = planData.inspectionData[index];
            
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙØªÙŠØ´ØŸ\n\nØ§Ù„Ù…ÙØªØ´: ${inspection.inspector}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${inspection.day}\nØ§Ù„Ù…Ø­Ù„Ø§Øª: ${inspection.shops.length}`)) {
                return;
            }
            
            try {
                // Remove inspection
                planData.inspectionData.splice(index, 1);
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`Ø­Ø°Ù ØªÙØªÙŠØ´ - ${inspection.inspector} - ${inspection.day}`);
                
                alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙØªÙŠØ´ Ø¨Ù†Ø¬Ø§Ø­!');
                filterInspections();
                
            } catch (error) {
                alert('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØªÙØªÙŠØ´: ' + error.message);
            }
        }
        
        // Copy inspection
        function copyInspection(index) {
            const inspection = planData.inspectionData[index];
            
            // Switch to add tab
            document.querySelectorAll('.tab-button')[0].click();
            
            // Fill form with copied data
            document.getElementById('inspectorSelect').value = inspection.inspector;
            document.getElementById('areaSelect').value = inspection.area;
            document.getElementById('shiftSelect').value = inspection.shift || 'ØµØ¨Ø§Ø­ÙŠØ©';
            
            // Set date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('inspectionDate').valueAsDate = tomorrow;
            
            // Pre-select shops (if they're available)
            selectedShops = [...inspection.shops];
            
            updateAvailableShops();
            
            alert('âœ… ØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØªÙŠØ´! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø­Ù„Ø§Øª ÙˆØ­ÙØ¸ Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø¬Ø¯ÙŠØ¯.');
        }
        
        // Delete selected inspections
        async function deleteSelectedInspections() {
            const checkboxes = document.querySelectorAll('.inspection-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡Ø§');
                return;
            }
            
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${checkboxes.length} ØªÙØªÙŠØ´ØŸ`)) {
                return;
            }
            
            try {
                // Get indices and sort in descending order (to delete from end to start)
                const indices = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => b - a);
                
                // Delete inspections
                indices.forEach(index => {
                    planData.inspectionData.splice(index, 1);
                });
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`Ø­Ø°Ù ${indices.length} ØªÙØªÙŠØ´`);
                
                alert(`âœ… ØªÙ… Ø­Ø°Ù ${indices.length} ØªÙØªÙŠØ´ Ø¨Ù†Ø¬Ø§Ø­!`);
                filterInspections();
                
            } catch (error) {
                alert('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØªÙØªÙŠØ´Ø§Øª: ' + error.message);
            }
        }
        
        // Export inspections
        function exportInspections() {
            const filterInspector = document.getElementById('filterInspector').value;
            const dataToExport = filterInspector ? 
                planData.inspectionData.filter(i => i.inspector === filterInspector) : 
                planData.inspectionData;
            
            const jsonStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inspections-${filterInspector || 'all'}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Load inspector statistics
        function loadInspectorStats() {
            const inspector = document.getElementById('statsInspector').value;
            const container = document.getElementById('statsContainer');
            
            if (!inspector) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">ğŸ“Š</div><p>Ø§Ø®ØªØ± Ù…ÙØªØ´Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p></div>';
                return;
            }
            
            // Calculate statistics
            const inspections = planData.inspectionData.filter(i => i.inspector === inspector);
            const totalInspections = inspections.length;
            const totalShops = inspections.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0);
            const areas = new Set(inspections.map(i => i.area)).size;
            const uniqueShops = new Set();
            inspections.forEach(i => i.shops && i.shops.forEach(s => uniqueShops.add(s)));
            
            // Get date range
            const dates = inspections.map(i => new Date(i.day)).sort((a, b) => a - b);
            const firstDate = dates.length > 0 ? dates[0].toLocaleDateString('ar-EG') : '-';
            const lastDate = dates.length > 0 ? dates[dates.length - 1].toLocaleDateString('ar-EG') : '-';
            
            // Calculate inspections per area
            const areaCount = {};
            inspections.forEach(i => {
                areaCount[i.area] = (areaCount[i.area] || 0) + 1;
            });
            
            let html = '<div class="inspector-stats">';
            html += `<div class="stat-card"><div class="stat-value">${totalInspections}</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${totalShops}</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù„Ø§Øª</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${uniqueShops.size}</div><div class="stat-label">Ù…Ø­Ù„Ø§Øª ÙØ±ÙŠØ¯Ø©</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${areas}</div><div class="stat-label">Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ØºØ·Ø§Ø©</div></div>`;
            html += '</div>';
            
            html += '<div style="margin-top: 30px;">';
            html += '<h3 style="color: #2d3561; margin-bottom: 15px;">ğŸ“… Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</h3>';
            html += `<p><strong>Ø£ÙˆÙ„ ØªÙØªÙŠØ´:</strong> ${firstDate}</p>`;
            html += `<p><strong>Ø¢Ø®Ø± ØªÙØªÙŠØ´:</strong> ${lastDate}</p>`;
            html += '</div>';
            
            html += '<div style="margin-top: 30px;">';
            html += '<h3 style="color: #2d3561; margin-bottom: 15px;">ğŸ—ºï¸ ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</h3>';
            for (const [area, count] of Object.entries(areaCount).sort((a, b) => b[1] - a[1])) {
                html += `<div style="padding: 10px; background: #f8f9fa; margin-bottom: 5px; border-radius: 8px;">`;
                html += `<strong>${escapeHtml(area)}:</strong> ${count} ØªÙØªÙŠØ´`;
                html += `</div>`;
            }
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Populate stats inspector dropdown
        function populateStatsInspector() {
            const select = document.getElementById('statsInspector');
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const option = document.createElement('option');
                    option.value = inspector.name;
                    option.textContent = inspector.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load calendar
        function loadCalendar() {
            const monthInput = document.getElementById('calendarMonth').value;
            const container = document.getElementById('calendarContainer');
            
            if (!monthInput) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">ğŸ“…</div><p>Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</p></div>';
                return;
            }
            
            const [year, month] = monthInput.split('-').map(Number);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const daysInMonth = lastDay.getDate();
            
            // Get inspections for this month
            const monthStr = monthInput;
            const monthInspections = planData.inspectionData.filter(i => 
                i.day.startsWith(monthStr)
            );
            
            // Group by date
            const inspectionsByDate = {};
            monthInspections.forEach(i => {
                if (!inspectionsByDate[i.day]) {
                    inspectionsByDate[i.day] = [];
                }
                inspectionsByDate[i.day].push(i);
            });
            
            let html = '<div style="margin-bottom: 20px;">';
            html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; font-weight: bold; text-align: center; color: #667eea;">';
            const daysOfWeek = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
            daysOfWeek.forEach(day => {
                html += `<div style="padding: 10px;">${day}</div>`;
            });
            html += '</div>';
            html += '<div class="calendar-view">';
            
            // Add empty cells for days before first day of month
            const startDay = firstDay.getDay();
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day" style="opacity: 0.3;"></div>';
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayInspections = inspectionsByDate[dateStr] || [];
                const hasInspection = dayInspections.length > 0;
                
                html += `<div class="calendar-day ${hasInspection ? 'has-inspection' : ''}">`;
                html += `<div class="day-number">${day}</div>`;
                
                dayInspections.forEach(insp => {
                    html += `<div class="inspection-badge" title="${escapeHtml(insp.inspector)} - ${escapeHtml(insp.area)}">`;
                    html += `${escapeHtml(insp.inspector.split(' ')[1] || insp.inspector)}`;
                    html += `</div>`;
                });
                
                html += '</div>';
            }
            
            html += '</div></div>';
            
            // Add summary
            html += '<div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">';
            html += `<h3 style="color: #2d3561; margin-bottom: 15px;">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±</h3>`;
            html += `<p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª:</strong> ${monthInspections.length}</p>`;
            html += `<p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù„Ø§Øª:</strong> ${monthInspections.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0)}</p>`;
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Save inspection to GitHub
        async function saveInspection() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const shift = document.getElementById('shiftSelect').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector || !date || !area || selectedShops.length === 0) {
                showMessage('planningStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ù„Ø§Øª');
                return;
            }
            
            // Check for duplicate inspection (same inspector and date)
            const duplicateIndex = planData.inspectionData.findIndex(insp => 
                insp.inspector === inspector && insp.day === date
            );
            
            let confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„ØªÙØªÙŠØ´ØŸ\n\nØ§Ù„Ù…ÙØªØ´: ${inspector}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${date}\nØ§Ù„Ù…Ø­Ù„Ø§Øª: ${selectedShops.length}`;
            
            if (duplicateIndex !== -1) {
                confirmMessage = `âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ÙŠÙˆØ¬Ø¯ ØªÙØªÙŠØ´ Ù…ÙƒØ±Ø± Ù„Ù†ÙØ³ Ø§Ù„Ù…ÙØªØ´ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…!\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŸ\n\nØ§Ù„Ù…ÙØªØ´: ${inspector}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${date}\nØ§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${selectedShops.length}`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            showMessage('planningStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙØªÙŠØ´...');
            document.getElementById('saveBtn').disabled = true;
            
            try {
                // Delete duplicate if exists
                if (duplicateIndex !== -1) {
                    planData.inspectionData.splice(duplicateIndex, 1);
                    showMessage('planningStatus', 'info', 'â³ ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ù…ÙƒØ±Ø±... Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø¬Ø¯ÙŠØ¯...');
                }
                
                // Create new inspection entry
                const newInspection = {
                    inspector: inspector,
                    day: date,
                    shift: shift,
                    area: area,
                    shops: [...selectedShops]
                };
                
                // Add to plan data
                planData.inspectionData.push(newInspection);
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`Ø¥Ø¶Ø§ÙØ© ØªÙØªÙŠØ´ Ø¬Ø¯ÙŠØ¯ - ${inspector} - ${date}`);
                
                let successMsg = `âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙØªÙŠØ´ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ“Š Ø§Ù„Ù…ÙØªØ´: ${inspector}\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}\nğŸª Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª: ${selectedShops.length}`;
                
                if (duplicateIndex !== -1) {
                    successMsg += '\n\nğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ù…ÙƒØ±Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹';
                }
                
                successMsg += '\n\nâœ¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø³ØªØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹!';
                
                showMessage('planningStatus', 'success', successMsg);
                
                // Reset form
                setTimeout(() => {
                    resetForm();
                }, 3000);
                
            } catch (error) {
                showMessage('planningStatus', 'error', 'âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªÙØªÙŠØ´: ' + error.message);
                document.getElementById('saveBtn').disabled = false;
            }
        }
        
        // Save plan data to GitHub
        async function savePlanDataToGitHub(commitMessage = null) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù„Ù plan-data.json');
            }
            
            const file = await getRes.json();
            const sha = file.sha;
            
            // Prepare content
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(planData, null, 2))));
            
            // Default commit message if not provided
            if (!commitMessage) {
                const inspector = document.getElementById('inspectorSelect').value;
                const date = document.getElementById('inspectionDate').value;
                commitMessage = `Ø¥Ø¶Ø§ÙØ© ØªÙØªÙŠØ´ Ø¬Ø¯ÙŠØ¯ - ${inspector} - ${date}`;
            }
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateRes.ok) {
                throw new Error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù plan-data.json');
            }
        }
        
        // Reset form
        function resetForm() {
            document.getElementById('inspectorSelect').value = '';
            document.getElementById('inspectionDate').valueAsDate = new Date();
            document.getElementById('shiftSelect').value = 'ØµØ¨Ø§Ø­ÙŠØ©';
            document.getElementById('areaSelect').value = '';
            selectedShops = [];
            
            document.getElementById('shopsListContainer').innerHTML = 
                '<p style="text-align: center; color: #999; padding: 20px;">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</p>';
            
            document.getElementById('selectedShopsContainer').style.display = 'none';
            document.getElementById('inspectionPreview').style.display = 'none';
            document.getElementById('saveBtn').disabled = true;
            
            updateStatistics(0, 0, []);
        }
        
        // Show message
        function showMessage(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.className = `status-message ${type} show`;
            el.textContent = message;
            
            setTimeout(() => {
                el.classList.remove('show');
            }, type === 'success' ? 5000 : 10000);
        }
        
        // Check if user is already logged in
        window.onload = function() {
            const savedToken = localStorage.getItem('devToken');
            if (savedToken) {
                document.getElementById('githubToken').value = savedToken;
                // Auto-set the token in the global variable
                githubToken = savedToken;
                // Load maintenance config immediately if we have a token
                loadMaintenanceConfig();
            }
        };
        
        // ============================================
        // SHOPS MANAGEMENT FUNCTIONS
        // ============================================
        
        // Load shops management tab
        function loadShopsManagement() {
            populateShopAreaFilter();
            displayShopsList();
        }
        
        // Populate area filter for shops
        function populateShopAreaFilter() {
            const select = document.getElementById('filterShopArea');
            select.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Display shops list with full details from shops_details.json
        async function displayShopsList() {
            const tbody = document.getElementById('shopsManagementBody');
            const searchTerm = document.getElementById('searchShop').value.toLowerCase();
            const filterAreaId = document.getElementById('filterShopArea').value;
            
            // Load shops_details.json for complete information
            let shopsDetails = {};
            try {
                const response = await fetch('shops_details.json?' + new Date().getTime());
                if (response.ok) {
                    shopsDetails = await response.json();
                }
            } catch (error) {
                console.error('Error loading shops_details.json:', error);
            }
            
            const totalShopsInDetails = Object.keys(shopsDetails).length;
            
            // Create combined shop list from both sources
            const allShops = [];
            
            // Add shops from shops_details.json
            Object.entries(shopsDetails).forEach(([shopName, shopInfo]) => {
                allShops.push({
                    name: shopInfo.nameAr || shopName,
                    nameEn: shopInfo.nameEn || '',
                    licenseNo: shopInfo.licenseNo || '',
                    admCode: shopInfo.admCode || '',
                    address: shopInfo.address || '',
                    contact: shopInfo.contact || '',
                    locationMap: shopInfo.locationMap || '',
                    activity: shopInfo.activity || '',
                    area: shopInfo.area || '',
                    areaId: shopInfo.areaId || '',
                    source: 'shops_details'
                });
            });
            
            // Add shops from plan-data.json if not already in list
            if (planData && planData.shops) {
                planData.shops.forEach(shop => {
                    if (!allShops.find(s => s.name === shop.name)) {
                        allShops.push({
                            ...shop,
                            source: 'plan_data'
                        });
                    }
                });
            }
            
            // Filter shops
            let filteredShops = allShops.filter(shop => {
                const matchesSearch = shop.name.toLowerCase().includes(searchTerm) ||
                                    (shop.nameEn && shop.nameEn.toLowerCase().includes(searchTerm)) ||
                                    (shop.licenseNo && shop.licenseNo.toLowerCase().includes(searchTerm)) ||
                                    (shop.admCode && shop.admCode.toLowerCase().includes(searchTerm));
                const matchesArea = !filterAreaId || shop.areaId === filterAreaId || shop.area === filterAreaId;
                return matchesSearch && matchesArea;
            });
            
            // Update statistics
            document.getElementById('totalShopsManagement').textContent = allShops.length;
            document.getElementById('filteredShopsCount').textContent = filteredShops.length;
            document.getElementById('totalAreasInShops').textContent = planData?.areas ? planData.areas.length : 0;
            
            if (filteredShops.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            filteredShops.forEach((shop, idx) => {
                const area = planData?.areas?.find(a => a.id === shop.areaId || a.name === shop.area);
                const tr = document.createElement('tr');
                
                // Create detailed shop info popup
                let shopDetails = `<strong>${shop.name}</strong>`;
                if (shop.nameEn) shopDetails += `<br><small style="color: #666;">${shop.nameEn}</small>`;
                if (shop.licenseNo) shopDetails += `<br><small>ğŸ”– Ø±Ø®ØµØ©: ${shop.licenseNo}</small>`;
                if (shop.admCode) shopDetails += `<br><small>ğŸ”¢ ÙƒÙˆØ¯ ADM: ${shop.admCode}</small>`;
                if (shop.address) shopDetails += `<br><small>ğŸ“ ${shop.address}</small>`;
                if (shop.contact) shopDetails += `<br><small>ğŸ“ ${shop.contact}</small>`;
                if (shop.activity) shopDetails += `<br><small>ğŸ’¼ ${shop.activity}</small>`;
                if (shop.locationMap) shopDetails += `<br><small><a href="${shop.locationMap}" target="_blank">ğŸ—ºï¸ Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a></small>`;
                
                tr.innerHTML = `
                    <td>
                        <div style="cursor: help;" title="${shop.nameEn || ''}">${shop.name}</div>
                        ${shop.licenseNo ? `<small style="color: #999; display: block;">ğŸ”– ${shop.licenseNo}</small>` : ''}
                        ${shop.admCode ? `<small style="color: #999; display: block;">ğŸ”¢ ${shop.admCode}</small>` : ''}
                    </td>
                    <td>${area ? area.name : (shop.area || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}</td>
                    <td style="font-family: monospace; font-size: 0.85em;">${shop.id || shop.admCode || idx}</td>
                    <td>
                        <span class="action-icon" onclick="viewShopDetails('${escapeHtml(shop.name)}')" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„" style="color: #3498db;">ğŸ‘ï¸</span>
                        <span class="action-icon edit-icon" onclick="openEditShopModal('${shop.id || idx}')" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</span>
                        <span class="action-icon delete-icon" onclick="deleteShop('${shop.id || idx}')" title="Ø­Ø°Ù">ğŸ—‘ï¸</span>
                        <span class="action-icon copy-icon" onclick="copyShopInfo('${escapeHtml(shop.name)}')" title="Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª">ğŸ“‹</span>
                        ${shop.locationMap ? `<span class="action-icon" onclick="window.open('${shop.locationMap}', '_blank')" title="Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©" style="color: #27ae60;">ğŸ—ºï¸</span>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Show success message if we loaded shops from details
            if (totalShopsInDetails > 0) {
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${totalShopsInDetails} Ù…Ø­Ù„ Ù…Ù† shops_details.json`);
            }
        }
        
        // View shop full details
        function viewShopDetails(shopName) {
            fetch('shops_details.json?' + new Date().getTime())
                .then(response => response.json())
                .then(shopsDetails => {
                    const shop = shopsDetails[shopName];
                    if (!shop) {
                        alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ù„');
                        return;
                    }
                    
                    let details = `ğŸª ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©\n`;
                    details += `${'='.repeat(50)}\n\n`;
                    details += `ğŸ“ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ: ${shop.nameAr || shopName}\n`;
                    if (shop.nameEn) details += `ğŸ“ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ: ${shop.nameEn}\n`;
                    if (shop.licenseNo) details += `ğŸ”– Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©: ${shop.licenseNo}\n`;
                    if (shop.admCode) details += `ğŸ”¢ ÙƒÙˆØ¯ ADM: ${shop.admCode}\n`;
                    if (shop.address) details += `ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${shop.address}\n`;
                    if (shop.contact) details += `ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${shop.contact}\n`;
                    if (shop.activity) details += `ğŸ’¼ Ø§Ù„Ù†Ø´Ø§Ø·: ${shop.activity}\n`;
                    if (shop.locationMap) details += `ğŸ—ºï¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…ØªÙˆÙØ± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©\n`;
                    
                    alert(details);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ù„');
                });
        }
        
        // Copy shop info
        function copyShopInfo(shopName) {
            fetch('shops_details.json?' + new Date().getTime())
                .then(response => response.json())
                .then(shopsDetails => {
                    const shop = shopsDetails[shopName];
                    if (!shop) {
                        navigator.clipboard.writeText(shopName).then(() => {
                            alert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„');
                        });
                        return;
                    }
                    
                    let info = `${shop.nameAr || shopName}`;
                    if (shop.nameEn) info += ` | ${shop.nameEn}`;
                    if (shop.licenseNo) info += ` | Ø±Ø®ØµØ©: ${shop.licenseNo}`;
                    if (shop.admCode) info += ` | ADM: ${shop.admCode}`;
                    
                    navigator.clipboard.writeText(info).then(() => {
                        alert('âœ… ØªÙ… Ù†Ø³Ø® Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­Ù„');
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    navigator.clipboard.writeText(shopName).then(() => {
                        alert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„');
                    });
                });
        }
        
        // Filter shops list
        function filterShopsList() {
            displayShopsList();
        }
        
        // Refresh shops list
        async function refreshShopsList() {
            showMessage('shopsManagementStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            try {
                await loadPlanData();
                displayShopsList();
                showMessage('shopsManagementStatus', 'success', 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                showMessage('shopsManagementStatus', 'error', 'âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
            }
        }
        
        // Open add shop modal
        function openAddShopModal() {
            document.getElementById('shopModalTitle').innerHTML = 'â• Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('shopModalId').value = '';
            document.getElementById('shopModalName').value = '';
            document.getElementById('shopModalArea').value = '';
            
            // Clear optional fields
            document.getElementById('shopModalNameEn').value = '';
            document.getElementById('shopModalLicense').value = '';
            document.getElementById('shopModalAddress').value = '';
            document.getElementById('shopModalPhone').value = '';
            document.getElementById('shopModalEmail').value = '';
            document.getElementById('shopModalGoogleMaps').value = '';
            document.getElementById('shopModalActivity').value = '';
            document.getElementById('shopModalAdmCode').value = '';
            
            // Populate areas dropdown
            const select = document.getElementById('shopModalArea');
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...</option>';
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
            
            document.getElementById('shopModal').style.display = 'block';
        }
        
        // Open edit shop modal
        function openEditShopModal(shopId) {
            const shop = planData.shops.find(s => s.id === shopId);
            if (!shop) return;
            
            document.getElementById('shopModalTitle').innerHTML = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø­Ù„';
            document.getElementById('shopModalId').value = shop.id;
            document.getElementById('shopModalName').value = shop.name;
            
            // Populate areas dropdown
            const select = document.getElementById('shopModalArea');
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...</option>';
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
            select.value = shop.areaId;
            
            // Load additional details from shops_details.json
            fetch('shops_details.json?' + new Date().getTime())
                .then(response => response.json())
                .then(shopsDetails => {
                    const details = shopsDetails[shop.name];
                    if (details) {
                        document.getElementById('shopModalNameEn').value = details.nameEn || '';
                        document.getElementById('shopModalLicense').value = details.licenseNo || '';
                        document.getElementById('shopModalAddress').value = details.address || '';
                        document.getElementById('shopModalPhone').value = details.contact || '';
                        document.getElementById('shopModalEmail').value = details.email || '';
                        document.getElementById('shopModalGoogleMaps').value = details.locationMap || '';
                        document.getElementById('shopModalActivity').value = details.activity || '';
                        document.getElementById('shopModalAdmCode').value = details.admCode || '';
                    } else {
                        // Clear optional fields if no details found
                        document.getElementById('shopModalNameEn').value = '';
                        document.getElementById('shopModalLicense').value = '';
                        document.getElementById('shopModalAddress').value = '';
                        document.getElementById('shopModalPhone').value = '';
                        document.getElementById('shopModalEmail').value = '';
                        document.getElementById('shopModalGoogleMaps').value = '';
                        document.getElementById('shopModalActivity').value = '';
                        document.getElementById('shopModalAdmCode').value = '';
                    }
                })
                .catch(error => {
                    console.error('Error loading shop details:', error);
                    // Clear optional fields on error
                    document.getElementById('shopModalNameEn').value = '';
                    document.getElementById('shopModalLicense').value = '';
                    document.getElementById('shopModalAddress').value = '';
                    document.getElementById('shopModalPhone').value = '';
                    document.getElementById('shopModalEmail').value = '';
                    document.getElementById('shopModalGoogleMaps').value = '';
                    document.getElementById('shopModalActivity').value = '';
                    document.getElementById('shopModalAdmCode').value = '';
                });
            
            document.getElementById('shopModal').style.display = 'block';
        }
        
        // Close shop modal
        function closeShopModal() {
            document.getElementById('shopModal').style.display = 'none';
        }
        
        // Save shop (add or edit)
        async function saveShop() {
            const shopId = document.getElementById('shopModalId').value;
            const shopName = document.getElementById('shopModalName').value.trim();
            const areaId = document.getElementById('shopModalArea').value;
            
            // Get optional fields
            const shopNameEn = document.getElementById('shopModalNameEn').value.trim();
            const licenseNo = document.getElementById('shopModalLicense').value.trim();
            const address = document.getElementById('shopModalAddress').value.trim();
            const contact = document.getElementById('shopModalPhone').value.trim();
            const email = document.getElementById('shopModalEmail').value.trim();
            const locationMap = document.getElementById('shopModalGoogleMaps').value.trim();
            const activity = document.getElementById('shopModalActivity').value.trim();
            const admCode = document.getElementById('shopModalAdmCode').value.trim();
            
            if (!shopName) {
                showMessage('shopModalStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„');
                return;
            }
            
            if (!areaId) {
                showMessage('shopModalStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©');
                return;
            }
            
            showMessage('shopModalStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');
            
            try {
                // Update or add shop in plan-data.json
                if (shopId) {
                    // Edit existing shop
                    const shopIndex = planData.shops.findIndex(s => s.id === shopId);
                    if (shopIndex !== -1) {
                        planData.shops[shopIndex].name = shopName;
                        planData.shops[shopIndex].areaId = areaId;
                    }
                } else {
                    // Add new shop
                    const newShop = {
                        id: 'shop_' + Date.now(),
                        name: shopName,
                        areaId: areaId
                    };
                    planData.shops.push(newShop);
                }
                
                // Save to plan-data.json on GitHub
                await savePlanDataToGitHub(`ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„: ${shopName}`);
                
                // Save additional details to shops_details.json if any optional field is filled
                if (shopNameEn || licenseNo || address || contact || email || locationMap || activity || admCode) {
                    await saveShopDetailsToGitHub(shopName, {
                        nameAr: shopName,
                        nameEn: shopNameEn,
                        licenseNo: licenseNo,
                        address: address,
                        contact: contact,
                        email: email,
                        locationMap: locationMap,
                        activity: activity,
                        admCode: admCode
                    });
                }
                
                showMessage('shopModalStatus', 'success', 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ - Ø§Ù„Ù…Ø­Ù„ Ø¸Ø§Ù‡Ø± Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
                setTimeout(() => {
                    closeShopModal();
                    displayShopsList();
                    populateAreas(); // Refresh main form areas
                }, 1500);
                
            } catch (error) {
                showMessage('shopModalStatus', 'error', 'âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + error.message);
            }
        }
        
        // Save shop details to shops_details.json on GitHub
        async function saveShopDetailsToGitHub(shopName, details) {
            try {
                // Get current shops_details.json file
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getRes.ok) {
                    throw new Error('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù„Ù shops_details.json');
                }
                
                const file = await getRes.json();
                const sha = file.sha;
                
                // Decode and parse current content
                const currentContent = JSON.parse(decodeURIComponent(escape(atob(file.content))));
                
                // Update or add shop details - remove empty fields
                const cleanDetails = {};
                if (details.nameAr) cleanDetails.nameAr = details.nameAr;
                if (details.nameEn) cleanDetails.nameEn = details.nameEn;
                if (details.licenseNo) cleanDetails.licenseNo = details.licenseNo;
                if (details.address) cleanDetails.address = details.address;
                if (details.contact) cleanDetails.contact = details.contact;
                if (details.email) cleanDetails.email = details.email;
                if (details.locationMap) cleanDetails.locationMap = details.locationMap;
                if (details.activity) cleanDetails.activity = details.activity;
                if (details.admCode) cleanDetails.admCode = details.admCode;
                
                currentContent[shopName] = cleanDetails;
                
                // Prepare content
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(currentContent, null, 2))));
                
                // Update file
                const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ù„: ${shopName}`,
                        content: content,
                        sha: sha
                    })
                });
                
                if (!updateRes.ok) {
                    throw new Error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù shops_details.json');
                }
            } catch (error) {
                console.error('Error saving shop details:', error);
                // Don't throw - optional details save failure shouldn't block main save
            }
        }
        
        // Delete shop
        async function deleteShop(shopId) {
            const shop = planData.shops.find(s => s.id === shopId);
            if (!shop) return;
            
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø­Ù„ "${shop.name}"ØŸ`)) {
                return;
            }
            
            showMessage('shopsManagementStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...');
            
            try {
                // Remove shop from array
                planData.shops = planData.shops.filter(s => s.id !== shopId);
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('shopsManagementStatus', 'success', 'âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ù„ Ø¨Ù†Ø¬Ø§Ø­');
                displayShopsList();
                populateAreas(); // Refresh main form areas
                
            } catch (error) {
                showMessage('shopsManagementStatus', 'error', 'âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + error.message);
            }
        }
        
        // Copy shop ID
        function copyShopId(shopId) {
            navigator.clipboard.writeText(shopId).then(() => {
                showMessage('shopsManagementStatus', 'success', 'âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù');
            });
        }
        
        // Export shops data
        function exportShopsData() {
            if (!planData || !planData.shops) return;
            
            const dataStr = JSON.stringify(planData.shops, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'shops-export-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
            
            showMessage('shopsManagementStatus', 'success', 'âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
        
        // ============================================
        // AREAS MANAGEMENT FUNCTIONS
        // ============================================
        
        // Load areas management tab
        function loadAreasManagement() {
            displayAreasList();
        }
        
        // Display areas list
        function displayAreasList() {
            const tbody = document.getElementById('areasManagementBody');
            const searchTerm = document.getElementById('searchArea').value.toLowerCase();
            
            if (!planData || !planData.areas) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
                return;
            }
            
            let filteredAreas = planData.areas.filter(area => {
                return area.name.toLowerCase().includes(searchTerm);
            });
            
            // Update statistics
            const totalShops = planData.shops ? planData.shops.length : 0;
            document.getElementById('totalAreasManagement').textContent = planData.areas.length;
            document.getElementById('filteredAreasCount').textContent = filteredAreas.length;
            document.getElementById('totalShopsInAreas').textContent = totalShops;
            
            if (filteredAreas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø·Ù‚ Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            filteredAreas.forEach(area => {
                const shopsCount = planData.shops.filter(s => s.areaId === area.id).length;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${area.name}</td>
                    <td style="font-family: monospace; font-size: 0.85em;">${area.id}</td>
                    <td>${shopsCount} Ù…Ø­Ù„</td>
                    <td>
                        <span class="action-icon edit-icon" onclick="openEditAreaModal('${area.id}')" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</span>
                        <span class="action-icon delete-icon" onclick="deleteArea('${area.id}')" title="Ø­Ø°Ù">ğŸ—‘ï¸</span>
                        <span class="action-icon copy-icon" onclick="copyAreaId('${area.id}')" title="Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù">ğŸ“‹</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Filter areas list
        function filterAreasList() {
            displayAreasList();
        }
        
        // Refresh areas list
        async function refreshAreasList() {
            showMessage('areasManagementStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            try {
                await loadPlanData();
                displayAreasList();
                showMessage('areasManagementStatus', 'success', 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                showMessage('areasManagementStatus', 'error', 'âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
            }
        }
        
        // Sort areas by name
        function sortAreasByName() {
            if (!planData || !planData.areas) return;
            
            planData.areas.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            displayAreasList();
            showMessage('areasManagementStatus', 'success', 'âœ… ØªÙ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹');
        }
        
        // Open add area modal
        function openAddAreaModal() {
            document.getElementById('areaModalTitle').innerHTML = 'â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©';
            document.getElementById('areaModalId').value = '';
            document.getElementById('areaModalName').value = '';
            document.getElementById('areaModal').style.display = 'block';
        }
        
        // Open edit area modal
        function openEditAreaModal(areaId) {
            const area = planData.areas.find(a => a.id === areaId);
            if (!area) return;
            
            document.getElementById('areaModalTitle').innerHTML = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø·Ù‚Ø©';
            document.getElementById('areaModalId').value = area.id;
            document.getElementById('areaModalName').value = area.name;
            document.getElementById('areaModal').style.display = 'block';
        }
        
        // Close area modal
        function closeAreaModal() {
            document.getElementById('areaModal').style.display = 'none';
        }
        
        // Save area (add or edit)
        async function saveArea() {
            const areaId = document.getElementById('areaModalId').value;
            const areaName = document.getElementById('areaModalName').value.trim();
            
            if (!areaName) {
                showMessage('areaModalStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©');
                return;
            }
            
            showMessage('areaModalStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');
            
            try {
                if (areaId) {
                    // Edit existing area
                    const areaIndex = planData.areas.findIndex(a => a.id === areaId);
                    if (areaIndex !== -1) {
                        planData.areas[areaIndex].name = areaName;
                    }
                } else {
                    // Add new area
                    const newArea = {
                        id: 'area_' + Date.now(),
                        name: areaName
                    };
                    planData.areas.push(newArea);
                }
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('areaModalStatus', 'success', 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
                setTimeout(() => {
                    closeAreaModal();
                    displayAreasList();
                    populateAreas(); // Refresh main form areas
                    populateShopAreaFilter(); // Refresh shops filter
                }, 1000);
                
            } catch (error) {
                showMessage('areaModalStatus', 'error', 'âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + error.message);
            }
        }
        
        // Delete area
        async function deleteArea(areaId) {
            const area = planData.areas.find(a => a.id === areaId);
            if (!area) return;
            
            // Check if area has shops
            const shopsInArea = planData.shops.filter(s => s.areaId === areaId).length;
            if (shopsInArea > 0) {
                if (!confirm(`Ø§Ù„Ù…Ù†Ø·Ù‚Ø© "${area.name}" ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${shopsInArea} Ù…Ø­Ù„. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ\nØ³ÙŠØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø¥Ù„Ù‰ "ØºÙŠØ± Ù…Ø­Ø¯Ø¯".`)) {
                    return;
                }
            } else {
                if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø·Ù‚Ø© "${area.name}"ØŸ`)) {
                    return;
                }
            }
            
            showMessage('areasManagementStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...');
            
            try {
                // Remove area from array
                planData.areas = planData.areas.filter(a => a.id !== areaId);
                
                // Update shops that belong to this area (set to null or empty)
                planData.shops.forEach(shop => {
                    if (shop.areaId === areaId) {
                        shop.areaId = '';
                    }
                });
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('areasManagementStatus', 'success', 'âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­');
                displayAreasList();
                populateAreas(); // Refresh main form areas
                
            } catch (error) {
                showMessage('areasManagementStatus', 'error', 'âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + error.message);
            }
        }
        
        // Copy area ID
        function copyAreaId(areaId) {
            navigator.clipboard.writeText(areaId).then(() => {
                showMessage('areasManagementStatus', 'success', 'âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù');
            });
        }
        
        // ============================================
        // MAINTENANCE CONTROL FUNCTIONS
        // ============================================
        
        let maintenanceConfigData = null;
        let maintenanceStatusData = null;
        
        // Load maintenance configuration
        async function loadMaintenanceConfig() {
            try {
                // Load maintenance-config.json
                const configRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-config.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (configRes.ok) {
                    const configFile = await configRes.json();
                    maintenanceConfigData = JSON.parse(decodeURIComponent(escape(atob(configFile.content))));
                }
                
                // Load maintenance-status.json
                const statusRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (statusRes.ok) {
                    const statusFile = await statusRes.json();
                    maintenanceStatusData = JSON.parse(decodeURIComponent(escape(atob(statusFile.content))));
                }
                
                // Update UI with loaded data
                updateMaintenanceUI();
                
            } catch (error) {
                console.error('Error loading maintenance config:', error);
            }
        }
        
        // Update maintenance UI with current values
        function updateMaintenanceUI() {
            if (!maintenanceConfigData || !maintenanceStatusData) return;
            
            // Update maintenance status
            const isEnabled = maintenanceStatusData.enabled === true;
            document.getElementById('maintenanceStatusLabel').textContent = isEnabled ? 'ğŸŸ¢ Ù…ÙØ¹Ù„Ø©' : 'ğŸ”´ Ù…ØªÙˆÙ‚ÙØ©';
            document.getElementById('maintenanceStatusLabel').style.color = isEnabled ? '#38ef7d' : '#ff6b6b';
            
            // Update buttons
            if (isEnabled) {
                document.getElementById('enableMaintenanceBtn').style.opacity = '0.5';
                document.getElementById('disableMaintenanceBtn').style.opacity = '1';
            } else {
                document.getElementById('enableMaintenanceBtn').style.opacity = '1';
                document.getElementById('disableMaintenanceBtn').style.opacity = '0.5';
            }
            
            // Update music status
            const musicEnabled = maintenanceConfigData.musicEnabled === true;
            document.getElementById('musicStatusLabel').textContent = musicEnabled ? 'ğŸ”Š Ù…ÙØ¹Ù„Ø©' : 'ğŸ”‡ Ù…ØªÙˆÙ‚ÙØ©';
            document.getElementById('musicStatusLabel').style.color = musicEnabled ? '#38ef7d' : '#ff6b6b';
            
            // Update buttons
            if (musicEnabled) {
                document.getElementById('enableMusicBtn').style.opacity = '0.5';
                document.getElementById('disableMusicBtn').style.opacity = '1';
            } else {
                document.getElementById('enableMusicBtn').style.opacity = '1';
                document.getElementById('disableMusicBtn').style.opacity = '0.5';
            }
            
            // Update volume slider
            const volume = Math.round((maintenanceConfigData.musicVolume || 0.1) * 100);
            document.getElementById('volumeSlider').value = volume;
            document.getElementById('volumeDisplay').textContent = `ğŸ”Š ${volume}%`;
            
            // Update music duration
            const duration = maintenanceConfigData.musicDuration || 600000;
            let durationText = '';
            if (duration === -1) {
                durationText = 'â™¾ï¸ Ù…Ø³ØªÙ…Ø± (ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)';
            } else {
                const minutes = Math.floor(duration / 60000);
                if (minutes === 1) {
                    durationText = 'â±ï¸ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©';
                } else {
                    durationText = `â±ï¸ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
                }
            }
            document.getElementById('musicDurationLabel').textContent = durationText;
            
            // Update last update info
            const lastUpdate = maintenanceConfigData.lastUpdated || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const updatedBy = maintenanceConfigData.updatedBy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            document.getElementById('lastUpdateLabel').textContent = new Date(lastUpdate).toLocaleString('ar-EG');
            document.getElementById('updatedByLabel').textContent = updatedBy;
        }
        
        // Toggle maintenance message on/off
        async function toggleMaintenanceMessage(enable) {
            if (!githubToken) {
                showMessage('maintenanceToggleStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            // Disable buttons and show immediate feedback
            const enableBtn = document.getElementById('enableMaintenanceBtn');
            const disableBtn = document.getElementById('disableMaintenanceBtn');
            
            if (enableBtn) enableBtn.disabled = true;
            if (disableBtn) disableBtn.disabled = true;
            
            showMessage('maintenanceToggleStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...');
            
            try {
                // Update maintenance-status.json
                maintenanceStatusData.enabled = enable;
                maintenanceStatusData.disabledAt = new Date().toISOString();
                maintenanceStatusData.disabledBy = 'Ø§Ù„Ù…Ø·ÙˆØ± - Smart Planner';
                
                await saveMaintenanceStatus(`${enable ? 'ØªÙØ¹ÙŠÙ„' : 'Ø¥ÙŠÙ‚Ø§Ù'} Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù† Smart Planner`);
                
                // Re-enable buttons
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('maintenanceToggleStatus', 'success', 
                    `âœ… ØªÙ… ${enable ? 'ØªÙØ¹ÙŠÙ„' : 'Ø¥ÙŠÙ‚Ø§Ù'} Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù†Ø¹ÙƒØ³Øª ÙÙˆØ±Ø§Ù‹ ÙÙŠ GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                // Re-enable buttons on error
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('maintenanceToggleStatus', 'error', 'âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + error.message);
            }
        }
        
        // Toggle music on/off
        async function toggleMusic(enable) {
            if (!githubToken) {
                showMessage('musicControlStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            // Disable buttons and show immediate feedback
            const enableBtn = document.getElementById('enableMusicBtn');
            const disableBtn = document.getElementById('disableMusicBtn');
            
            if (enableBtn) enableBtn.disabled = true;
            if (disableBtn) disableBtn.disabled = true;
            
            showMessage('musicControlStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...');
            
            try {
                // Update maintenance-config.json
                maintenanceConfigData.musicEnabled = enable;
                maintenanceConfigData.lastUpdated = new Date().toISOString();
                maintenanceConfigData.updatedBy = 'Ø§Ù„Ù…Ø·ÙˆØ± - Smart Planner';
                
                await saveMaintenanceConfig(`${enable ? 'ØªÙØ¹ÙŠÙ„' : 'Ø¥ÙŠÙ‚Ø§Ù'} Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ù…Ù† Smart Planner`);
                
                // Re-enable buttons
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('musicControlStatus', 'success', 
                    `âœ… ØªÙ… ${enable ? 'ØªÙØ¹ÙŠÙ„' : 'Ø¥ÙŠÙ‚Ø§Ù'} Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù†Ø¹ÙƒØ³Øª ÙÙˆØ±Ø§Ù‹ ÙÙŠ GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                // Re-enable buttons on error
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('musicControlStatus', 'error', 'âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + error.message);
            }
        }
        
        // Update volume display
        function updateVolumeDisplay(value) {
            document.getElementById('volumeDisplay').textContent = `ğŸ”Š ${value}%`;
        }
        
        // Save volume change
        async function saveVolumeChange(value) {
            if (!githubToken) {
                showMessage('musicControlStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            showMessage('musicControlStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª...');
            
            try {
                // Update maintenance-config.json
                maintenanceConfigData.musicVolume = parseInt(value) / 100;
                maintenanceConfigData.lastUpdated = new Date().toISOString();
                maintenanceConfigData.updatedBy = 'Ø§Ù„Ù…Ø·ÙˆØ± - Smart Planner';
                
                await saveMaintenanceConfig(`ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ ${value}% Ù…Ù† Smart Planner`);
                
                showMessage('musicControlStatus', 'success', 
                    `âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ ${value}% Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù†Ø¹ÙƒØ³Øª ÙÙˆØ±Ø§Ù‹ ÙÙŠ GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                showMessage('musicControlStatus', 'error', 'âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + error.message);
            }
        }
        
        // Set volume preset
        function setVolumePreset(value) {
            document.getElementById('volumeSlider').value = value;
            updateVolumeDisplay(value);
            saveVolumeChange(value);
        }
        
        // Set music duration
        async function setMusicDuration(seconds) {
            if (!githubToken) {
                showMessage('musicControlStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            showMessage('musicControlStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ù…Ø¯Ø© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰...');
            
            try {
                // Update maintenance-config.json
                const duration = seconds === -1 ? -1 : seconds * 1000;
                maintenanceConfigData.musicDuration = duration;
                maintenanceConfigData.lastUpdated = new Date().toISOString();
                maintenanceConfigData.updatedBy = 'Ø§Ù„Ù…Ø·ÙˆØ± - Smart Planner';
                
                let durationLabel = '';
                if (seconds === -1) {
                    durationLabel = 'ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯';
                    maintenanceConfigData.musicDurationLabel = 'Ù…Ø³ØªÙ…Ø± (ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)';
                } else {
                    const minutes = Math.floor(seconds / 60);
                    durationLabel = minutes === 1 ? 'Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©' : `${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
                    maintenanceConfigData.musicDurationLabel = durationLabel;
                }
                
                await saveMaintenanceConfig(`ØªØ­Ø¯ÙŠØ« Ù…Ø¯Ø© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø¥Ù„Ù‰ ${durationLabel} Ù…Ù† Smart Planner`);
                
                showMessage('musicControlStatus', 'success', 
                    `âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¯Ø© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø¥Ù„Ù‰ ${durationLabel} Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù†Ø¹ÙƒØ³Øª ÙÙˆØ±Ø§Ù‹ ÙÙŠ GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                showMessage('musicControlStatus', 'error', 'âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + error.message);
            }
        }
        
        // Save maintenance config to GitHub
        async function saveMaintenanceConfig(commitMessage) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-config.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù„Ù maintenance-config.json');
            }
            
            const file = await getRes.json();
            const sha = file.sha;
            
            // Prepare content
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(maintenanceConfigData, null, 2))));
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-config.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateRes.ok) {
                throw new Error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù maintenance-config.json');
            }
        }
        
        // Save maintenance status to GitHub
        async function saveMaintenanceStatus(commitMessage) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù„Ù maintenance-status.json');
            }
            
            const file = await getRes.json();
            const sha = file.sha;
            
            // Prepare content
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(maintenanceStatusData, null, 2))));
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateRes.ok) {
                throw new Error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù maintenance-status.json');
            }
        }
        
        // Force cache clear - AGGRESSIVE IMPLEMENTATION for all browsers
        async function forceCacheClear() {
            // Disable button and show immediate feedback
            const btn = document.getElementById('clearCacheBtn');
            const icon = document.getElementById('clearCacheIcon');
            const text = document.getElementById('clearCacheText');
            
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            }
            if (icon) icon.textContent = 'â³';
            if (text) text.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„ÙÙˆØ±ÙŠ...';
            
            showMessage('cacheControlStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø© Ø¨Ø´ÙƒÙ„ ÙÙˆØ±ÙŠ ÙˆÙ‚ÙˆÙŠ...');
            
            try {
                let clearedItems = [];
                
                // 1. Clear local storage (preserve devToken)
                const keysToKeep = ['devToken'];
                const allKeys = Object.keys(localStorage);
                let localStorageCount = 0;
                allKeys.forEach(key => {
                    if (!keysToKeep.includes(key)) {
                        localStorage.removeItem(key);
                        localStorageCount++;
                    }
                });
                clearedItems.push(`ğŸ’¾ LocalStorage: ØªÙ… Ù…Ø³Ø­ ${localStorageCount} Ø¹Ù†ØµØ±`);
                
                // 2. Clear session storage
                const sessionStorageCount = sessionStorage.length;
                sessionStorage.clear();
                clearedItems.push(`ğŸ“¦ SessionStorage: ØªÙ… Ù…Ø³Ø­ ${sessionStorageCount} Ø¹Ù†ØµØ±`);
                
                // 3. Unregister all service workers
                let swCount = 0;
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        swCount++;
                        console.log('âœ… Service Worker unregistered:', registration);
                    }
                }
                clearedItems.push(`ğŸ”„ Service Workers: ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ ${swCount} Ø®Ø¯Ù…Ø©`);
                
                // 4. Clear all caches
                let cacheCount = 0;
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        cacheCount++;
                        console.log('âœ… Cache deleted:', cacheName);
                    }
                }
                clearedItems.push(`ğŸ—‘ï¸ Caches: ØªÙ… Ù…Ø³Ø­ ${cacheCount} ÙƒØ§Ø´`);
                
                // 5. Clear cookies (if possible)
                try {
                    document.cookie.split(";").forEach(function(c) { 
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                    });
                    clearedItems.push(`ğŸª Cookies: ØªÙ… Ø§Ù„Ù…Ø³Ø­`);
                } catch (e) {
                    console.warn('Could not clear cookies:', e);
                }
                
                // 6. Clear IndexedDB (if exists)
                if ('indexedDB' in window) {
                    try {
                        const databases = await indexedDB.databases();
                        for (const db of databases) {
                            indexedDB.deleteDatabase(db.name);
                        }
                        clearedItems.push(`ğŸ“Š IndexedDB: ØªÙ… Ø§Ù„Ù…Ø³Ø­`);
                    } catch (e) {
                        console.warn('Could not clear IndexedDB:', e);
                    }
                }
                
                // Re-enable button with success state
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                if (icon) icon.textContent = 'âœ…';
                if (text) text.textContent = 'ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø¬Ø§Ø­!';
                
                // Show success message
                showMessage('cacheControlStatus', 'success', 
                    'âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ§Ø´ ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!\n\n' +
                    clearedItems.join('\n') + '\n\n' +
                    'âœ¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø³ØªÙ†Ø¹ÙƒØ³ ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª (Safari, Chrome, Firefox)\n' +
                    'ğŸ”„ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø´ÙƒÙ„ Ù‚ÙˆÙŠ Ø®Ù„Ø§Ù„ 3 Ø«ÙˆØ§Ù†Ù...');
                
                // Reset button text after a moment
                setTimeout(() => {
                    if (icon) icon.textContent = 'ğŸš€';
                    if (text) text.textContent = 'Ù…Ø³Ø­ Ù‚ÙˆÙŠ ÙˆÙÙˆØ±ÙŠ Ù„Ù„ÙƒØ§Ø´ (Safari + Chrome + Firefox)';
                }, 2000);
                
                // 7. Force hard reload after 3 seconds
                setTimeout(() => {
                    console.log('ğŸ”„ Performing hard reload...');
                    // Try multiple reload methods for maximum compatibility
                    if (window.location.reload) {
                        // Hard reload with cache bypass
                        window.location.reload(true);
                    }
                    // Fallback: Force reload by changing URL
                    setTimeout(() => {
                        window.location.href = window.location.href.split('?')[0] + '?t=' + new Date().getTime();
                    }, 500);
                }, 3000);
                
            } catch (error) {
                // Re-enable button on error
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                if (icon) icon.textContent = 'âŒ';
                if (text) text.textContent = 'ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­ - Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
                
                showMessage('cacheControlStatus', 'error', 'âŒ ÙØ´Ù„ Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´: ' + error.message);
                console.error('Cache clear error:', error);
                
                // Reset button text after a moment
                setTimeout(() => {
                    if (icon) icon.textContent = 'ğŸš€';
                    if (text) text.textContent = 'Ù…Ø³Ø­ Ù‚ÙˆÙŠ ÙˆÙÙˆØ±ÙŠ Ù„Ù„ÙƒØ§Ø´ (Safari + Chrome + Firefox)';
                }, 3000);
            }
        }
        
        // Update service worker
        async function updateServiceWorker() {
            // Disable button and show immediate feedback
            const btn = document.getElementById('updateSWBtn');
            const icon = document.getElementById('updateSWIcon');
            const text = document.getElementById('updateSWText');
            
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            }
            if (icon) icon.textContent = 'â³';
            if (text) text.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';
            
            showMessage('cacheControlStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Service Worker...');
            
            try {
                if ('serviceWorker' in navigator) {
                    // Get all registrations
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    
                    if (registrations.length === 0) {
                        // Re-enable button
                        if (btn) {
                            btn.disabled = false;
                            btn.style.opacity = '1';
                        }
                        if (icon) icon.textContent = 'âš ï¸';
                        if (text) text.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Service Workers';
                        
                        showMessage('cacheControlStatus', 'warning', 'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Service Workers Ù…Ø³Ø¬Ù„Ø©');
                        
                        // Reset button text
                        setTimeout(() => {
                            if (icon) icon.textContent = 'ğŸ”„';
                            if (text) text.textContent = 'ØªØ­Ø¯ÙŠØ« Service Worker ÙÙˆØ±Ø§Ù‹';
                        }, 2000);
                        return;
                    }
                    
                    // Update all service workers
                    for (let registration of registrations) {
                        await registration.update();
                        console.log('âœ… Service Worker updated:', registration);
                    }
                    
                    // Re-enable button with success state
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    }
                    if (icon) icon.textContent = 'âœ…';
                    if (text) text.textContent = 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­!';
                    
                    showMessage('cacheControlStatus', 'success', 
                        `âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${registrations.length} Service Worker Ø¨Ù†Ø¬Ø§Ø­!\n` +
                        'ğŸ”„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø³ØªÙ†Ø¹ÙƒØ³ ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨');
                    
                    // Reset button text after a moment
                    setTimeout(() => {
                        if (icon) icon.textContent = 'ğŸ”„';
                        if (text) text.textContent = 'ØªØ­Ø¯ÙŠØ« Service Worker ÙÙˆØ±Ø§Ù‹';
                    }, 2000);
                    
                } else {
                    // Re-enable button
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    }
                    if (icon) icon.textContent = 'âŒ';
                    if (text) text.textContent = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… SW';
                    
                    showMessage('cacheControlStatus', 'error', 'âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Service Workers');
                    
                    // Reset button text
                    setTimeout(() => {
                        if (icon) icon.textContent = 'ğŸ”„';
                        if (text) text.textContent = 'ØªØ­Ø¯ÙŠØ« Service Worker ÙÙˆØ±Ø§Ù‹';
                    }, 2000);
                }
                
            } catch (error) {
                // Re-enable button on error
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                if (icon) icon.textContent = 'âŒ';
                if (text) text.textContent = 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«';
                
                showMessage('cacheControlStatus', 'error', 'âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Service Worker: ' + error.message);
                
                // Reset button text after a moment
                setTimeout(() => {
                    if (icon) icon.textContent = 'ğŸ”„';
                    if (text) text.textContent = 'ØªØ­Ø¯ÙŠØ« Service Worker ÙÙˆØ±Ø§Ù‹';
                }, 3000);
            }
        }
        
        // Update switchTab function to load maintenance config when switching to maintenance tab
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab.call(this, tabName);
            
            if (tabName === 'maintenance') {
                loadMaintenanceConfig();
            }
        };
        
        // ============================================
        // NEW SMART PLANNER ENHANCED FUNCTIONS
        // ============================================
        
        // Quick Add Inspection
        function openQuickAddInspection() {
            // Switch to add tab and focus on first field
            document.querySelectorAll('.tab-button')[0].click();
            setTimeout(() => {
                document.getElementById('inspectorSelect').focus();
            }, 300);
            alert('âœ¨ Ø§Ø®ØªØµØ§Ø±: Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø© Ø¨Ø³Ø±Ø¹Ø© Ù„Ø¥Ø¶Ø§ÙØ© ØªÙØªÙŠØ´ Ø¬Ø¯ÙŠØ¯');
        }
        
        // Import from Excel - REAL IMPLEMENTATION
        function importFromExcel() {
            if (!window.XLSX) {
                alert('âš ï¸ Ù…ÙƒØªØ¨Ø© Excel ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    
                    // Create import preview modal
                    const modal = document.createElement('div');
                    modal.id = 'importExcelModal';
                    modal.style.cssText = `
                        display: block;
                        position: fixed;
                        z-index: 10000;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.8);
                        overflow: auto;
                    `;
                    
                    let sheetsHTML = '<div style="margin-bottom: 20px;">';
                    sheetsHTML += '<h3 style="color: #2d3561; margin-bottom: 15px;">ğŸ“‹ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø©:</h3>';
                    sheetsHTML += '<div style="display: flex; flex-direction: column; gap: 10px;">';
                    
                    workbook.SheetNames.forEach((sheetName, idx) => {
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        sheetsHTML += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border: 2px solid #e0e0e0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="color: #667eea; font-size: 1.1em;">${sheetName}</strong>
                                        <span style="color: #666; margin-right: 10px;">(${jsonData.length} ØµÙ)</span>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button onclick="importExcelSheet('${sheetName}', 'inspections')" class="btn btn-primary btn-sm">
                                            Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒØªÙØªÙŠØ´Ø§Øª
                                        </button>
                                        <button onclick="importExcelSheet('${sheetName}', 'shops')" class="btn btn-success btn-sm">
                                            Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒÙ…Ø­Ù„Ø§Øª
                                        </button>
                                    </div>
                                </div>
                                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                    Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: ${Object.keys(jsonData[0] || {}).slice(0, 5).join(', ')}${Object.keys(jsonData[0] || {}).length > 5 ? '...' : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    sheetsHTML += '</div></div>';
                    
                    modal.innerHTML = `
                        <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 900px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="color: #2d3561;">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel</h2>
                                <button onclick="document.getElementById('importExcelModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">Ã—</button>
                            </div>
                            ${sheetsHTML}
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-top: 20px; border: 2px solid #90caf9;">
                                <strong style="color: #1976d2;">ğŸ’¡ Ù†ØµØ§Ø¦Ø­:</strong>
                                <ul style="margin: 10px 0 0 20px; color: #666;">
                                    <li>ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</li>
                                    <li>Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒØªÙØªÙŠØ´Ø§Øª: ÙŠØªØ·Ù„Ø¨ Ø£Ø¹Ù…Ø¯Ø© (Ø§Ù„Ù…ÙØªØ´ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø§Ù„Ù…Ø­Ù„Ø§Øª)</li>
                                    <li>Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒÙ…Ø­Ù„Ø§Øª: ÙŠØªØ·Ù„Ø¨ Ø£Ø¹Ù…Ø¯Ø© (Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ØŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©)</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Store workbook for later use
                    window.excelWorkbook = workbook;
                    
                } catch (error) {
                    alert('âŒ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel: ' + error.message);
                }
            };
            input.click();
        }
        
        // Import Excel Sheet
        window.importExcelSheet = async function(sheetName, type) {
            if (!window.excelWorkbook) {
                alert('âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel');
                return;
            }
            
            const sheet = window.excelWorkbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet);
            
            if (type === 'inspections') {
                let importedCount = 0;
                let errors = [];
                
                jsonData.forEach((row, idx) => {
                    try {
                        // Try to extract inspection data with flexible column names
                        const inspector = row['Ø§Ù„Ù…ÙØªØ´'] || row['Inspector'] || row['inspector'] || '';
                        const day = row['Ø§Ù„ØªØ§Ø±ÙŠØ®'] || row['Date'] || row['date'] || row['day'] || '';
                        const area = row['Ø§Ù„Ù…Ù†Ø·Ù‚Ø©'] || row['Area'] || row['area'] || '';
                        const shopsStr = row['Ø§Ù„Ù…Ø­Ù„Ø§Øª'] || row['Shops'] || row['shops'] || '';
                        
                        if (!inspector || !day || !area) {
                            errors.push(`Ø§Ù„ØµÙ ${idx + 1}: Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©`);
                            return;
                        }
                        
                        const shops = shopsStr.split(',').map(s => s.trim()).filter(s => s);
                        
                        const newInspection = {
                            id: 'insp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            inspector: inspector,
                            day: day,
                            area: area,
                            shops: shops,
                            shift: row['Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©'] || row['Shift'] || 'ØµØ¨Ø§Ø­ÙŠØ©'
                        };
                        
                        planData.inspectionData.push(newInspection);
                        importedCount++;
                    } catch (error) {
                        errors.push(`Ø§Ù„ØµÙ ${idx + 1}: ${error.message}`);
                    }
                });
                
                if (errors.length > 0 && errors.length < 10) {
                    alert(`âš ï¸ ØªØ­Ø°ÙŠØ±Ø§Øª:\n\n` + errors.join('\n'));
                }
                
                alert(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedCount} ØªÙØªÙŠØ´ Ù…Ù† ${jsonData.length} ØµÙ!\n\nâš ï¸ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª`);
                
            } else if (type === 'shops') {
                let importedCount = 0;
                let errors = [];
                
                jsonData.forEach((row, idx) => {
                    try {
                        const shopName = row['Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„'] || row['Shop Name'] || row['name'] || row['Name'] || '';
                        const areaName = row['Ø§Ù„Ù…Ù†Ø·Ù‚Ø©'] || row['Area'] || row['area'] || '';
                        
                        if (!shopName) {
                            errors.push(`Ø§Ù„ØµÙ ${idx + 1}: Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ Ù…ÙÙ‚ÙˆØ¯`);
                            return;
                        }
                        
                        // Find or create area
                        let areaId = '';
                        if (areaName && planData.areas) {
                            const area = planData.areas.find(a => a.name === areaName);
                            if (area) {
                                areaId = area.id;
                            } else {
                                // Create new area
                                areaId = 'area_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                planData.areas.push({
                                    id: areaId,
                                    name: areaName
                                });
                            }
                        }
                        
                        // Check if shop already exists
                        const exists = planData.shops.some(s => s.name.toLowerCase().trim() === shopName.toLowerCase().trim());
                        if (exists) {
                            return;
                        }
                        
                        const newShop = {
                            id: 'shop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            name: shopName,
                            areaId: areaId
                        };
                        
                        planData.shops.push(newShop);
                        importedCount++;
                    } catch (error) {
                        errors.push(`Ø§Ù„ØµÙ ${idx + 1}: ${error.message}`);
                    }
                });
                
                if (errors.length > 0 && errors.length < 10) {
                    alert(`âš ï¸ ØªØ­Ø°ÙŠØ±Ø§Øª:\n\n` + errors.join('\n'));
                }
                
                alert(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedCount} Ù…Ø­Ù„ Ù…Ù† ${jsonData.length} ØµÙ!\n\nâš ï¸ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª`);
            }
            
            document.getElementById('importExcelModal').remove();
        };
        
        // Export All Data - ENHANCED WITH MULTIPLE FORMATS
        function exportAllData() {
            if (!planData) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }
            
            // Create export format selection modal
            const modal = document.createElement('div');
            modal.id = 'exportModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 5% auto; padding: 30px; border-radius: 20px; max-width: 700px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561;">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
                        <button onclick="document.getElementById('exportModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">Ã—</button>
                    </div>
                    
                    <!-- Data Summary -->
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <div style="font-size: 2em; font-weight: 700; color: #667eea;">${planData.inspectionData?.length || 0}</div>
                                <div style="color: #666;">Ø§Ù„ØªÙØªÙŠØ´Ø§Øª</div>
                            </div>
                            <div>
                                <div style="font-size: 2em; font-weight: 700; color: #11998e;">${planData.inspectors?.length || 0}</div>
                                <div style="color: #666;">Ø§Ù„Ù…ÙØªØ´ÙˆÙ†</div>
                            </div>
                            <div>
                                <div style="font-size: 2em; font-weight: 700; color: #fa709a;">${planData.areas?.length || 0}</div>
                                <div style="color: #666;">Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</div>
                            </div>
                            <div>
                                <div style="font-size: 2em; font-weight: 700; color: #ffc107;">${planData.shops?.length || 0}</div>
                                <div style="color: #666;">Ø§Ù„Ù…Ø­Ù„Ø§Øª</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export Format Selection -->
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">ğŸ“‹ Ø§Ø®ØªØ± ØµÙŠØºØ© Ø§Ù„ØªØµØ¯ÙŠØ±:</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <button onclick="exportDataFormat('json')" class="btn btn-primary" style="padding: 20px; flex-direction: column; gap: 10px;">
                                <span style="font-size: 2em;">ğŸ“„</span>
                                <span>JSON</span>
                                <small style="font-size: 0.85em; opacity: 0.8;">Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ† ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</small>
                            </button>
                            <button onclick="exportDataFormat('excel')" class="btn btn-success" style="padding: 20px; flex-direction: column; gap: 10px;">
                                <span style="font-size: 2em;">ğŸ“Š</span>
                                <span>Excel</span>
                                <small style="font-size: 0.85em; opacity: 0.8;">Ù„Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</small>
                            </button>
                            <button onclick="exportDataFormat('csv')" class="btn btn-info" style="padding: 20px; flex-direction: column; gap: 10px;">
                                <span style="font-size: 2em;">ğŸ“‹</span>
                                <span>CSV</span>
                                <small style="font-size: 0.85em; opacity: 0.8;">Ù„Ù„Ù‚ÙˆØ§Ø¹Ø¯ ÙˆØ§Ù„Ø£Ù†Ø¸Ù…Ø©</small>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Export Options -->
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; border: 2px solid #ffc107;">
                        <strong style="color: #856404;">âš™ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ±:</strong>
                        <div style="margin-top: 10px;">
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="checkbox" id="exportInspections" checked>
                                <span style="margin-right: 5px;">ØªØ¶Ù…ÙŠÙ† Ø§Ù„ØªÙØªÙŠØ´Ø§Øª</span>
                            </label>
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="checkbox" id="exportInspectors" checked>
                                <span style="margin-right: 5px;">ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</span>
                            </label>
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="checkbox" id="exportAreas" checked>
                                <span style="margin-right: 5px;">ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</span>
                            </label>
                            <label style="display: block;">
                                <input type="checkbox" id="exportShops" checked>
                                <span style="margin-right: 5px;">ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ù„Ø§Øª</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Export Data in Selected Format
        window.exportDataFormat = function(format) {
            const includeInspections = document.getElementById('exportInspections').checked;
            const includeInspectors = document.getElementById('exportInspectors').checked;
            const includeAreas = document.getElementById('exportAreas').checked;
            const includeShops = document.getElementById('exportShops').checked;
            
            const exportData = {
                exportDate: new Date().toISOString(),
                exportedBy: 'Smart Planner - Ø£Ø¯Ø§Ø© Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø°ÙƒÙŠØ©',
                format: format
            };
            
            if (includeInspections) exportData.inspections = planData.inspectionData || [];
            if (includeInspectors) exportData.inspectors = planData.inspectors || [];
            if (includeAreas) exportData.areas = planData.areas || [];
            if (includeShops) exportData.shops = planData.shops || [];
            
            if (format === 'json') {
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `smart-planner-export-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØµÙŠØºØ© JSON Ø¨Ù†Ø¬Ø§Ø­!');
                
            } else if (format === 'excel') {
                if (!window.XLSX) {
                    alert('âš ï¸ Ù…ÙƒØªØ¨Ø© Excel ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨ØµÙŠØºØ© JSON Ø¨Ø¯ÙŠÙ„Ø©...');
                    exportDataFormat('json');
                    return;
                }
                
                const wb = XLSX.utils.book_new();
                
                // Add inspections sheet
                if (includeInspections && exportData.inspections) {
                    const inspectionsSheet = exportData.inspections.map(i => ({
                        'Ø§Ù„Ù…ÙØªØ´': i.inspector,
                        'Ø§Ù„ØªØ§Ø±ÙŠØ®': i.day,
                        'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©': i.area,
                        'Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©': i.shift || '',
                        'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª': i.shops ? i.shops.length : 0,
                        'Ø§Ù„Ù…Ø­Ù„Ø§Øª': i.shops ? i.shops.join(', ') : ''
                    }));
                    const ws = XLSX.utils.json_to_sheet(inspectionsSheet);
                    XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„ØªÙØªÙŠØ´Ø§Øª');
                }
                
                // Add inspectors sheet
                if (includeInspectors && exportData.inspectors) {
                    const inspectorsSheet = exportData.inspectors.map(i => ({
                        'Ø§Ù„Ø§Ø³Ù…': i.name,
                        'Ø§Ù„Ø£ÙŠØ§Ù…': i.days ? i.days.join(', ') : ''
                    }));
                    const ws = XLSX.utils.json_to_sheet(inspectorsSheet);
                    XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ù…ÙØªØ´ÙˆÙ†');
                }
                
                // Add areas sheet
                if (includeAreas && exportData.areas) {
                    const areasSheet = exportData.areas.map(a => ({
                        'Ø§Ù„Ù…Ø¹Ø±Ù': a.id,
                        'Ø§Ù„Ø§Ø³Ù…': a.name
                    }));
                    const ws = XLSX.utils.json_to_sheet(areasSheet);
                    XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ù…Ù†Ø§Ø·Ù‚');
                }
                
                // Add shops sheet
                if (includeShops && exportData.shops) {
                    const shopsSheet = exportData.shops.map(s => {
                        const area = planData.areas?.find(a => a.id === s.areaId);
                        return {
                            'Ø§Ù„Ù…Ø¹Ø±Ù': s.id,
                            'Ø§Ù„Ø§Ø³Ù…': s.name,
                            'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©': area ? area.name : ''
                        };
                    });
                    const ws = XLSX.utils.json_to_sheet(shopsSheet);
                    XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ù…Ø­Ù„Ø§Øª');
                }
                
                XLSX.writeFile(wb, `smart-planner-export-${new Date().toISOString().split('T')[0]}.xlsx`);
                alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØµÙŠØºØ© Excel Ø¨Ù†Ø¬Ø§Ø­!');
                
            } else if (format === 'csv') {
                // Export inspections as CSV
                if (includeInspections && exportData.inspections) {
                    let csv = 'Ø§Ù„Ù…ÙØªØ´,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ù…Ù†Ø·Ù‚Ø©,Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©,Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª,Ø§Ù„Ù…Ø­Ù„Ø§Øª\n';
                    exportData.inspections.forEach(i => {
                        csv += `"${i.inspector}","${i.day}","${i.area}","${i.shift || ''}","${i.shops ? i.shops.length : 0}","${i.shops ? i.shops.join('; ') : ''}"\n`;
                    });
                    
                    const dataBlob = new Blob(['\uFEFF' + csv], {type: 'text/csv;charset=utf-8;'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `smart-planner-inspections-${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØµÙŠØºØ© CSV Ø¨Ù†Ø¬Ø§Ø­!');
                } else {
                    alert('âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                }
            }
            
            document.getElementById('exportModal').remove();
        };
        
        // Sync with GitHub
        async function syncWithGitHub() {
            if (!githubToken) {
                alert('âŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHub');
                return;
            }
            
            if (confirm('ğŸ”„ Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ GitHubØŸ\n\nØ³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹.')) {
                try {
                    await loadPlanData();
                    alert('âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
                    
                    // Refresh current tab
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab && activeTab.id === 'shopsTab') {
                        displayShopsList();
                    } else if (activeTab && activeTab.id === 'areasTab') {
                        displayAreasList();
                    }
                } catch (error) {
                    alert('âŒ ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ' + error.message);
                }
            }
        }
        
        // Create Backup
        function createBackup() {
            if (!planData) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ');
                return;
            }
            
            const backupData = {
                ...planData,
                backupDate: new Date().toISOString(),
                backupVersion: '1.0'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup-plan-data-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ’¾ Ø§Ø­ØªÙØ¸ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†.');
        }
        
        // Generate Full Report - ENHANCED WITH VISUAL REPORT
        function generateFullReport() {
            if (!planData || !planData.inspectionData) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
                return;
            }
            
            const totalInspections = planData.inspectionData.length;
            const totalShops = planData.inspectionData.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0);
            const inspectorCounts = {};
            const areaCounts = {};
            const monthCounts = {};
            const shiftCounts = { 'ØµØ¨Ø§Ø­ÙŠØ©': 0, 'Ù…Ø³Ø§Ø¦ÙŠØ©': 0 };
            
            planData.inspectionData.forEach(insp => {
                inspectorCounts[insp.inspector] = (inspectorCounts[insp.inspector] || 0) + 1;
                areaCounts[insp.area] = (areaCounts[insp.area] || 0) + 1;
                
                const month = insp.day ? insp.day.substring(0, 7) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                monthCounts[month] = (monthCounts[month] || 0) + 1;
                
                if (insp.shift) {
                    shiftCounts[insp.shift] = (shiftCounts[insp.shift] || 0) + 1;
                }
            });
            
            // Create visual report modal
            const modal = document.createElement('div');
            modal.id = 'reportModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            // Calculate top performers
            const topInspectors = Object.entries(inspectorCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const topAreas = Object.entries(areaCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 20px; max-width: 1200px; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #667eea;">
                        <h2 style="color: #2d3561; margin: 0;">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„ ÙˆØ§Ù„ØªÙØµÙŠÙ„ÙŠ</h2>
                        <button onclick="document.getElementById('reportModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">Ã—</button>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 3em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">${totalInspections}</div>
                            <div style="font-size: 1.1em; margin-top: 5px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 3em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">${totalShops}</div>
                            <div style="font-size: 1.1em; margin-top: 5px;">Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…ÙØªØ´Ø©</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 3em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">${Object.keys(inspectorCounts).length}</div>
                            <div style="font-size: 1.1em; margin-top: 5px;">Ø§Ù„Ù…ÙØªØ´ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 3em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">${Object.keys(areaCounts).length}</div>
                            <div style="font-size: 1.1em; margin-top: 5px;">Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ØºØ·Ø§Ø©</div>
                        </div>
                    </div>
                    
                    <!-- Top Performers -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 15px;">
                            <h3 style="color: #2d3561; margin-bottom: 15px;">ğŸ† Ø£ÙØ¶Ù„ 5 Ù…ÙØªØ´ÙŠÙ†</h3>
                            ${topInspectors.map(([ inspector, count], idx) => {
                                const percentage = ((count / totalInspections) * 100).toFixed(1);
                                return `
                                    <div style="margin-bottom: 15px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span style="font-weight: 600;">${idx + 1}. ${inspector}</span>
                                            <span style="color: #667eea; font-weight: 600;">${count} (${percentage}%)</span>
                                        </div>
                                        <div style="background: #e0e0e0; border-radius: 10px; height: 10px; overflow: hidden;">
                                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${percentage}%; transition: width 1s ease;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 15px;">
                            <h3 style="color: #2d3561; margin-bottom: 15px;">ğŸ“ Ø£ÙƒØ«Ø± 5 Ù…Ù†Ø§Ø·Ù‚ ØªÙØªÙŠØ´Ø§Ù‹</h3>
                            ${topAreas.map(([area, count], idx) => {
                                const percentage = ((count / totalInspections) * 100).toFixed(1);
                                return `
                                    <div style="margin-bottom: 15px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span style="font-weight: 600;">${idx + 1}. ${area}</span>
                                            <span style="color: #11998e; font-weight: 600;">${count} (${percentage}%)</span>
                                        </div>
                                        <div style="background: #e0e0e0; border-radius: 10px; height: 10px; overflow: hidden;">
                                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); height: 100%; width: ${percentage}%; transition: width 1s ease;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Shift Distribution -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">ğŸ• ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #ffc107;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #ffc107;">${shiftCounts['ØµØ¨Ø§Ø­ÙŠØ©'] || 0}</div>
                                <div style="color: #666;">Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ©</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #3498db;">${shiftCounts['Ù…Ø³Ø§Ø¦ÙŠØ©'] || 0}</div>
                                <div style="color: #666;">Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠØ©</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Distribution -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">ğŸ“… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„ØªÙØªÙŠØ´Ø§Øª</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            ${Object.entries(monthCounts).sort((a, b) => a[0].localeCompare(b[0])).map(([month, count]) => `
                                <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 2px solid #667eea;">
                                    <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">${month}</div>
                                    <div style="font-size: 1.8em; font-weight: 700; color: #2d3561;">${count}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                        <button onclick="downloadTextReport()" class="btn btn-primary">
                            <span>ğŸ“„</span>
                            <span>ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ØµÙŠ</span>
                        </button>
                        <button onclick="printReport()" class="btn btn-success">
                            <span>ğŸ–¨ï¸</span>
                            <span>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</span>
                        </button>
                        <button onclick="shareReport()" class="btn btn-info">
                            <span>ğŸ“¤</span>
                            <span>Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store report data globally for download functions
            window.currentReportData = {
                totalInspections,
                totalShops,
                inspectorCounts,
                areaCounts,
                monthCounts,
                shiftCounts
            };
        }
        
        // Download Text Report
        window.downloadTextReport = function() {
            const data = window.currentReportData;
            
            let report = 'ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø°ÙƒÙŠ\n';
            report += 'â•'.repeat(60) + '\n\n';
            report += `ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleString('ar-EG')}\n`;
            report += `ğŸ”— Ø§Ù„Ù†Ø¸Ø§Ù…: Smart Planner - Ø£Ø¯Ø§Ø© Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø°ÙƒÙŠØ©\n\n`;
            
            report += 'ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©:\n';
            report += 'â”€'.repeat(60) + '\n';
            report += `   â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª: ${data.totalInspections}\n`;
            report += `   â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…ÙØªØ´Ø©: ${data.totalShops}\n`;
            report += `   â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙØªØ´ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†: ${Object.keys(data.inspectorCounts).length}\n`;
            report += `   â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ØºØ·Ø§Ø©: ${Object.keys(data.areaCounts).length}\n`;
            report += `   â€¢ Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø­Ù„Ø§Øª Ù„ÙƒÙ„ ØªÙØªÙŠØ´: ${(data.totalShops / data.totalInspections).toFixed(2)}\n\n`;
            
            report += 'ğŸ‘¥ ØªÙØªÙŠØ´Ø§Øª Ø§Ù„Ù…ÙØªØ´ÙŠÙ† (Ù…Ø±ØªØ¨Ø© ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹):\n';
            report += 'â”€'.repeat(60) + '\n';
            Object.entries(data.inspectorCounts).sort((a, b) => b[1] - a[1]).forEach(([inspector, count], idx) => {
                const percentage = ((count / data.totalInspections) * 100).toFixed(1);
                report += `   ${idx + 1}. ${inspector}: ${count} ØªÙØªÙŠØ´ (${percentage}%)\n`;
            });
            
            report += '\nğŸ—ºï¸ ØªÙØªÙŠØ´Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ (Ù…Ø±ØªØ¨Ø© ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹):\n';
            report += 'â”€'.repeat(60) + '\n';
            Object.entries(data.areaCounts).sort((a, b) => b[1] - a[1]).forEach(([area, count], idx) => {
                const percentage = ((count / data.totalInspections) * 100).toFixed(1);
                report += `   ${idx + 1}. ${area}: ${count} ØªÙØªÙŠØ´ (${percentage}%)\n`;
            });
            
            report += '\nğŸ• ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª:\n';
            report += 'â”€'.repeat(60) + '\n';
            report += `   â€¢ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ©: ${data.shiftCounts['ØµØ¨Ø§Ø­ÙŠØ©'] || 0}\n`;
            report += `   â€¢ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠØ©: ${data.shiftCounts['Ù…Ø³Ø§Ø¦ÙŠØ©'] || 0}\n`;
            
            report += '\nğŸ“… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø±ÙŠ:\n';
            report += 'â”€'.repeat(60) + '\n';
            Object.entries(data.monthCounts).sort((a, b) => a[0].localeCompare(b[0])).forEach(([month, count]) => {
                report += `   â€¢ ${month}: ${count} ØªÙØªÙŠØ´\n`;
            });
            
            report += '\n' + 'â•'.repeat(60) + '\n';
            report += 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Smart Planner\n';
            report += 'Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©\n';
            
            const dataBlob = new Blob(['\uFEFF' + report], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ØªÙ‚Ø±ÙŠØ±-Ø´Ø§Ù…Ù„-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­!');
        };
        
        // Print Report
        window.printReport = function() {
            window.print();
        };
        
        // Share Report
        window.shareReport = function() {
            const data = window.currentReportData;
            const summary = `ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙØªÙŠØ´\n\n` +
                          `âœ… Ø§Ù„ØªÙØªÙŠØ´Ø§Øª: ${data.totalInspections}\n` +
                          `ğŸª Ø§Ù„Ù…Ø­Ù„Ø§Øª: ${data.totalShops}\n` +
                          `ğŸ‘¥ Ø§Ù„Ù…ÙØªØ´ÙˆÙ†: ${Object.keys(data.inspectorCounts).length}\n` +
                          `ğŸ—ºï¸ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚: ${Object.keys(data.areaCounts).length}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'ØªÙ‚Ø±ÙŠØ± Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø°ÙƒÙŠ',
                    text: summary
                }).catch(err => console.log('Error sharing:', err));
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(summary).then(() => {
                    alert('âœ… ØªÙ… Ù†Ø³Ø® Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©!');
                }).catch(() => {
                    alert('ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:\n\n' + summary);
                });
            }
        };
        
        // Check Data Quality - ENHANCED WITH AUTO-FIX
        function checkDataQuality() {
            if (!planData) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙØ­Øµ');
                return;
            }
            
            const issues = {
                critical: [],
                warnings: [],
                suggestions: []
            };
            
            // Check inspections
            if (planData.inspectionData) {
                planData.inspectionData.forEach((insp, idx) => {
                    if (!insp.inspector) issues.critical.push({ type: 'missing_inspector', index: idx, message: `ØªÙØªÙŠØ´ ${idx + 1}: Ù…ÙØªØ´ ØºÙŠØ± Ù…Ø­Ø¯Ø¯` });
                    if (!insp.day) issues.critical.push({ type: 'missing_date', index: idx, message: `ØªÙØªÙŠØ´ ${idx + 1}: ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø­Ø¯Ø¯` });
                    if (!insp.area) issues.warnings.push({ type: 'missing_area', index: idx, message: `ØªÙØªÙŠØ´ ${idx + 1}: Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©` });
                    if (!insp.shops || insp.shops.length === 0) issues.warnings.push({ type: 'no_shops', index: idx, message: `ØªÙØªÙŠØ´ ${idx + 1}: Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª` });
                    if (!insp.id) issues.suggestions.push({ type: 'missing_id', index: idx, message: `ØªÙØªÙŠØ´ ${idx + 1}: Ù…Ø¹Ø±Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯` });
                    if (!insp.shift) issues.suggestions.push({ type: 'missing_shift', index: idx, message: `ØªÙØªÙŠØ´ ${idx + 1}: Ù…Ù†Ø§ÙˆØ¨Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©` });
                    
                    // Check date format
                    if (insp.day && !/^\d{4}-\d{2}-\d{2}$/.test(insp.day)) {
                        issues.warnings.push({ type: 'invalid_date_format', index: idx, message: `ØªÙØªÙŠØ´ ${idx + 1}: ØµÙŠØºØ© ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­Ø© (${insp.day})` });
                    }
                });
            }
            
            // Check duplicates
            const inspectionKeys = new Map();
            planData.inspectionData.forEach((insp, idx) => {
                const key = `${insp.inspector}-${insp.day}`;
                if (inspectionKeys.has(key)) {
                    issues.warnings.push({
                        type: 'duplicate',
                        index: idx,
                        originalIndex: inspectionKeys.get(key),
                        message: `ØªÙØªÙŠØ´ Ù…ÙƒØ±Ø±: ${insp.inspector} ÙÙŠ ${insp.day}`,
                        fixable: true
                    });
                } else {
                    inspectionKeys.set(key, idx);
                }
            });
            
            // Check shops
            if (planData.shops) {
                planData.shops.forEach((shop, idx) => {
                    if (!shop.name) issues.critical.push({ type: 'missing_shop_name', index: idx, message: `Ù…Ø­Ù„ ${idx + 1}: Ø§Ø³Ù… ØºÙŠØ± Ù…Ø­Ø¯Ø¯` });
                    if (!shop.id) issues.suggestions.push({ type: 'missing_shop_id', index: idx, message: `Ù…Ø­Ù„ ${idx + 1}: Ù…Ø¹Ø±Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`, fixable: true });
                    if (!shop.areaId) issues.warnings.push({ type: 'missing_shop_area', index: idx, message: `${shop.name || 'Ù…Ø­Ù„ ' + (idx + 1)}: Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©` });
                });
                
                // Check for duplicate shop names
                const shopNames = new Map();
                planData.shops.forEach((shop, idx) => {
                    const name = shop.name?.toLowerCase().trim();
                    if (name) {
                        if (shopNames.has(name)) {
                            issues.warnings.push({
                                type: 'duplicate_shop',
                                index: idx,
                                originalIndex: shopNames.get(name),
                                message: `Ù…Ø­Ù„ Ù…ÙƒØ±Ø±: ${shop.name}`,
                                fixable: true
                            });
                        } else {
                            shopNames.set(name, idx);
                        }
                    }
                });
            }
            
            // Check areas
            if (planData.areas) {
                planData.areas.forEach((area, idx) => {
                    if (!area.name) issues.critical.push({ type: 'missing_area_name', index: idx, message: `Ù…Ù†Ø·Ù‚Ø© ${idx + 1}: Ø§Ø³Ù… ØºÙŠØ± Ù…Ø­Ø¯Ø¯` });
                    if (!area.id) issues.suggestions.push({ type: 'missing_area_id', index: idx, message: `Ù…Ù†Ø·Ù‚Ø© ${idx + 1}: Ù…Ø¹Ø±Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`, fixable: true });
                });
            }
            
            // Check inspectors
            if (planData.inspectors) {
                planData.inspectors.forEach((inspector, idx) => {
                    if (!inspector.name) issues.critical.push({ type: 'missing_inspector_name', index: idx, message: `Ù…ÙØªØ´ ${idx + 1}: Ø§Ø³Ù… ØºÙŠØ± Ù…Ø­Ø¯Ø¯` });
                });
            }
            
            // Create quality report modal
            const totalIssues = issues.critical.length + issues.warnings.length + issues.suggestions.length;
            
            if (totalIssues === 0) {
                alert('âœ… Ù…Ù…ØªØ§Ø²! Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹!\n\nÙ„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'qualityModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 900px; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #667eea;">
                        <h2 style="color: #2d3561; margin: 0;">ğŸ” ØªÙ‚Ø±ÙŠØ± Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
                        <button onclick="document.getElementById('qualityModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">Ã—</button>
                    </div>
                    
                    <!-- Summary -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: ${issues.critical.length > 0 ? 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)' : 'linear-gradient(135deg, #27ae60 0%, #229954 100%)'}; padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 700;">${issues.critical.length}</div>
                            <div>Ù…Ø´Ø§ÙƒÙ„ Ø­Ø±Ø¬Ø©</div>
                        </div>
                        <div style="background: ${issues.warnings.length > 0 ? 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)' : 'linear-gradient(135deg, #27ae60 0%, #229954 100%)'}; padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 700;">${issues.warnings.length}</div>
                            <div>ØªØ­Ø°ÙŠØ±Ø§Øª</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 700;">${issues.suggestions.length}</div>
                            <div>Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</div>
                        </div>
                    </div>
                    
                    <!-- Critical Issues -->
                    ${issues.critical.length > 0 ? `
                        <div style="background: #ffebee; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #e74c3c;">
                            <h3 style="color: #c0392b; margin-bottom: 15px;">ğŸš¨ Ù…Ø´Ø§ÙƒÙ„ Ø­Ø±Ø¬Ø© (ÙŠØ¬Ø¨ Ø¥ØµÙ„Ø§Ø­Ù‡Ø§)</h3>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${issues.critical.slice(0, 20).map(issue => `
                                    <div style="padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px; border-right: 4px solid #e74c3c;">
                                        ${issue.message}
                                    </div>
                                `).join('')}
                                ${issues.critical.length > 20 ? `<div style="text-align: center; color: #666; padding: 10px;">... Ùˆ ${issues.critical.length - 20} Ù…Ø´ÙƒÙ„Ø© Ø£Ø®Ø±Ù‰</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Warnings -->
                    ${issues.warnings.length > 0 ? `
                        <div style="background: #fff3cd; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #ffc107;">
                            <h3 style="color: #856404; margin-bottom: 15px;">âš ï¸ ØªØ­Ø°ÙŠØ±Ø§Øª (ÙŠÙÙ†ØµØ­ Ø¨Ø¥ØµÙ„Ø§Ø­Ù‡Ø§)</h3>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${issues.warnings.slice(0, 20).map(issue => `
                                    <div style="padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px; border-right: 4px solid #ffc107;">
                                        ${issue.message}
                                        ${issue.fixable ? '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 10px;">Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥ØµÙ„Ø§Ø­</span>' : ''}
                                    </div>
                                `).join('')}
                                ${issues.warnings.length > 20 ? `<div style="text-align: center; color: #666; padding: 10px;">... Ùˆ ${issues.warnings.length - 20} ØªØ­Ø°ÙŠØ± Ø¢Ø®Ø±</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Suggestions -->
                    ${issues.suggestions.length > 0 ? `
                        <div style="background: #d1ecf1; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #17a2b8;">
                            <h3 style="color: #0c5460; margin-bottom: 15px;">ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ØªØ­Ø³ÙŠÙ†</h3>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${issues.suggestions.slice(0, 20).map(issue => `
                                    <div style="padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px; border-right: 4px solid #17a2b8;">
                                        ${issue.message}
                                        ${issue.fixable ? '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 10px;">Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥ØµÙ„Ø§Ø­</span>' : ''}
                                    </div>
                                `).join('')}
                                ${issues.suggestions.length > 20 ? `<div style="text-align: center; color: #666; padding: 10px;">... Ùˆ ${issues.suggestions.length - 20} Ø§Ù‚ØªØ±Ø§Ø­ Ø¢Ø®Ø±</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Auto-fix Options -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0;">ğŸ”§ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</h3>
                        <p style="margin-bottom: 15px; font-size: 0.95em;">ÙŠÙ…ÙƒÙ† Ù„Ù„Ù†Ø¸Ø§Ù… Ø¥ØµÙ„Ø§Ø­ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:</p>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="autoFixMissingIds()" class="btn btn-success" style="background: white; color: #667eea;">
                                Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
                            </button>
                            <button onclick="autoFixDuplicates()" class="btn btn-warning" style="background: white; color: #667eea;">
                                Ø¯Ù…Ø¬ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
                            </button>
                            <button onclick="autoFixMissingShifts()" class="btn btn-info" style="background: white; color: #667eea;">
                                Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                            </button>
                        </div>
                    </div>
                    
                    <!-- Export Report -->
                    <div style="text-align: center;">
                        <button onclick="exportQualityReport()" class="btn btn-primary">
                            <span>ğŸ“„</span>
                            <span>ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store issues for auto-fix functions
            window.currentQualityIssues = issues;
        }
        
        // Auto-fix Missing IDs
        window.autoFixMissingIds = function() {
            let fixed = 0;
            
            // Fix inspection IDs
            planData.inspectionData?.forEach(insp => {
                if (!insp.id) {
                    insp.id = 'insp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    fixed++;
                }
            });
            
            // Fix shop IDs
            planData.shops?.forEach(shop => {
                if (!shop.id) {
                    shop.id = 'shop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    fixed++;
                }
            });
            
            // Fix area IDs
            planData.areas?.forEach(area => {
                if (!area.id) {
                    area.id = 'area_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    fixed++;
                }
            });
            
            alert(`âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ ${fixed} Ù…Ø¹Ø±Ù Ù…ÙÙ‚ÙˆØ¯!\n\nâš ï¸ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª`);
            document.getElementById('qualityModal').remove();
            checkDataQuality(); // Re-check
        };
        
        // Auto-fix Duplicates
        window.autoFixDuplicates = async function() {
            const duplicates = window.currentQualityIssues.warnings.filter(i => i.type === 'duplicate');
            
            if (duplicates.length === 0) {
                alert('âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØªÙŠØ´Ø§Øª Ù…ÙƒØ±Ø±Ø©!');
                return;
            }
            
            if (!confirm(`âš ï¸ Ø³ÙŠØªÙ… Ø¯Ù…Ø¬ ${duplicates.length} ØªÙØªÙŠØ´ Ù…ÙƒØ±Ø±\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) {
                return;
            }
            
            // Call bulk merge function
            await bulkMergeDuplicates();
        };
        
        // Auto-fix Missing Shifts
        window.autoFixMissingShifts = function() {
            let fixed = 0;
            
            planData.inspectionData?.forEach(insp => {
                if (!insp.shift) {
                    insp.shift = 'ØµØ¨Ø§Ø­ÙŠØ©'; // Default to morning shift
                    fixed++;
                }
            });
            
            alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ${fixed} Ù…Ù†Ø§ÙˆØ¨Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (ØµØ¨Ø§Ø­ÙŠØ©)!\n\nâš ï¸ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª`);
            document.getElementById('qualityModal').remove();
            checkDataQuality(); // Re-check
        };
        
        // Export Quality Report
        window.exportQualityReport = function() {
            const issues = window.currentQualityIssues;
            
            let report = 'ğŸ” ØªÙ‚Ø±ÙŠØ± Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Smart Planner\n';
            report += 'â•'.repeat(60) + '\n\n';
            report += `ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ: ${new Date().toLocaleString('ar-EG')}\n\n`;
            
            report += 'ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„:\n';
            report += 'â”€'.repeat(60) + '\n';
            report += `   ğŸš¨ Ù…Ø´Ø§ÙƒÙ„ Ø­Ø±Ø¬Ø©: ${issues.critical.length}\n`;
            report += `   âš ï¸ ØªØ­Ø°ÙŠØ±Ø§Øª: ${issues.warnings.length}\n`;
            report += `   ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª: ${issues.suggestions.length}\n\n`;
            
            if (issues.critical.length > 0) {
                report += 'ğŸš¨ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø­Ø±Ø¬Ø©:\n';
                report += 'â”€'.repeat(60) + '\n';
                issues.critical.forEach((issue, idx) => {
                    report += `   ${idx + 1}. ${issue.message}\n`;
                });
                report += '\n';
            }
            
            if (issues.warnings.length > 0) {
                report += 'âš ï¸ Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª:\n';
                report += 'â”€'.repeat(60) + '\n';
                issues.warnings.forEach((issue, idx) => {
                    report += `   ${idx + 1}. ${issue.message}${issue.fixable ? ' [Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥ØµÙ„Ø§Ø­]' : ''}\n`;
                });
                report += '\n';
            }
            
            if (issues.suggestions.length > 0) {
                report += 'ğŸ’¡ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª:\n';
                report += 'â”€'.repeat(60) + '\n';
                issues.suggestions.forEach((issue, idx) => {
                    report += `   ${idx + 1}. ${issue.message}${issue.fixable ? ' [Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥ØµÙ„Ø§Ø­]' : ''}\n`;
                });
            }
            
            const dataBlob = new Blob(['\uFEFF' + report], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ØªÙ‚Ø±ÙŠØ±-Ø¬ÙˆØ¯Ø©-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
        };
        
        // View System Logs - ENHANCED WITH DETAILED LOGS
        function viewSystemLogs() {
            // Initialize logs in sessionStorage if not exists
            if (!sessionStorage.getItem('smartPlannerLogs')) {
                sessionStorage.setItem('smartPlannerLogs', JSON.stringify([]));
            }
            
            const logs = JSON.parse(sessionStorage.getItem('smartPlannerLogs') || '[]');
            
            // Add current system status
            const currentStatus = {
                timestamp: new Date().toISOString(),
                type: 'info',
                message: 'Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…',
                details: {
                    inspections: planData?.inspectionData?.length || 0,
                    shops: planData?.shops?.length || 0,
                    areas: planData?.areas?.length || 0,
                    inspectors: planData?.inspectors?.length || 0
                }
            };
            
            // Create system logs modal
            const modal = document.createElement('div');
            modal.id = 'logsModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 1000px; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #667eea;">
                        <h2 style="color: #2d3561; margin: 0;">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØµÙ„</h2>
                        <button onclick="document.getElementById('logsModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">Ã—</button>
                    </div>
                    
                    <!-- System Status -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0;">âš¡ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: 700;">${planData?.inspectionData?.length || 0}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Ø§Ù„ØªÙØªÙŠØ´Ø§Øª</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: 700;">${planData?.shops?.length || 0}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Ø§Ù„Ù…Ø­Ù„Ø§Øª</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: 700;">${planData?.areas?.length || 0}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: 700;">${planData?.inspectors?.length || 0}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Ø§Ù„Ù…ÙØªØ´ÙˆÙ†</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                            <div style="font-size: 0.9em;">
                                ğŸ“… Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${planData?.lastUpdate ? new Date(planData.lastUpdate).toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Log Controls -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button onclick="filterLogs('all')" class="btn btn-primary btn-sm">
                            Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (${logs.length})
                        </button>
                        <button onclick="filterLogs('info')" class="btn btn-info btn-sm">
                            Ù…Ø¹Ù„ÙˆÙ…Ø§Øª (${logs.filter(l => l.type === 'info').length})
                        </button>
                        <button onclick="filterLogs('success')" class="btn btn-success btn-sm">
                            Ù†Ø¬Ø§Ø­ (${logs.filter(l => l.type === 'success').length})
                        </button>
                        <button onclick="filterLogs('warning')" class="btn btn-warning btn-sm">
                            ØªØ­Ø°ÙŠØ±Ø§Øª (${logs.filter(l => l.type === 'warning').length})
                        </button>
                        <button onclick="filterLogs('error')" class="btn btn-danger btn-sm">
                            Ø£Ø®Ø·Ø§Ø¡ (${logs.filter(l => l.type === 'error').length})
                        </button>
                        <button onclick="clearSystemLogs()" class="btn btn-danger btn-sm">
                            Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
                        </button>
                        <button onclick="exportSystemLogs()" class="btn btn-success btn-sm">
                            ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª
                        </button>
                    </div>
                    
                    <!-- Logs Display -->
                    <div id="logsDisplay" style="background: #f8f9fa; padding: 20px; border-radius: 15px; max-height: 500px; overflow-y: auto;">
                        ${logs.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“‹</div>
                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                                <p style="font-size: 0.9em;">Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                            </div>
                        ` : logs.slice().reverse().map(log => {
                            const typeColors = {
                                info: { bg: '#d1ecf1', border: '#17a2b8', icon: 'â„¹ï¸' },
                                success: { bg: '#d4edda', border: '#28a745', icon: 'âœ…' },
                                warning: { bg: '#fff3cd', border: '#ffc107', icon: 'âš ï¸' },
                                error: { bg: '#f8d7da', border: '#dc3545', icon: 'âŒ' }
                            };
                            const style = typeColors[log.type] || typeColors.info;
                            
                            return `
                                <div class="log-entry" data-type="${log.type}" style="background: ${style.bg}; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-right: 4px solid ${style.border};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 1.2em;">${style.icon}</span>
                                            <strong>${log.message}</strong>
                                        </div>
                                        <small style="color: #666;">${new Date(log.timestamp).toLocaleString('ar-EG')}</small>
                                    </div>
                                    ${log.details ? `
                                        <div style="font-size: 0.9em; color: #666; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(0,0,0,0.1);">
                                            ${typeof log.details === 'object' ? 
                                                Object.entries(log.details).map(([k, v]) => `${k}: ${v}`).join(' â€¢ ') : 
                                                log.details
                                            }
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Filter Logs
        window.filterLogs = function(type) {
            const entries = document.querySelectorAll('.log-entry');
            entries.forEach(entry => {
                if (type === 'all' || entry.dataset.type === type) {
                    entry.style.display = 'block';
                } else {
                    entry.style.display = 'none';
                }
            });
        };
        
        // Clear System Logs
        window.clearSystemLogs = function() {
            if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŸ\n\nÙ„Ù† ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡Ø§!')) {
                return;
            }
            
            sessionStorage.setItem('smartPlannerLogs', JSON.stringify([]));
            document.getElementById('logsModal').remove();
            alert('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª');
        };
        
        // Export System Logs
        window.exportSystemLogs = function() {
            const logs = JSON.parse(sessionStorage.getItem('smartPlannerLogs') || '[]');
            
            if (logs.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§');
                return;
            }
            
            let report = 'ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… - Smart Planner\n';
            report += 'â•'.repeat(60) + '\n\n';
            report += `ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ${new Date().toLocaleString('ar-EG')}\n`;
            report += `ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${logs.length}\n\n`;
            
            logs.slice().reverse().forEach((log, idx) => {
                report += `[${idx + 1}] ${new Date(log.timestamp).toLocaleString('ar-EG')}\n`;
                report += `Ø§Ù„Ù†ÙˆØ¹: ${log.type.toUpperCase()}\n`;
                report += `Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${log.message}\n`;
                if (log.details) {
                    report += `Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${typeof log.details === 'object' ? JSON.stringify(log.details, null, 2) : log.details}\n`;
                }
                report += 'â”€'.repeat(60) + '\n\n';
            });
            
            const dataBlob = new Blob(['\uFEFF' + report], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `system-logs-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        };
        
        // Add System Log (utility function)
        window.addSystemLog = function(type, message, details = null) {
            const logs = JSON.parse(sessionStorage.getItem('smartPlannerLogs') || '[]');
            logs.push({
                timestamp: new Date().toISOString(),
                type: type,
                message: message,
                details: details
            });
            
            // Keep only last 100 logs
            if (logs.length > 100) {
                logs.splice(0, logs.length - 100);
            }
            
            sessionStorage.setItem('smartPlannerLogs', JSON.stringify(logs));
        };
        
        // Bulk Operations - REAL IMPLEMENTATION
        function bulkOperations() {
            if (!planData || !planData.inspectionData) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©');
                return;
            }
            
            // Create bulk operations modal
            const modal = document.createElement('div');
            modal.id = 'bulkOpsModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 900px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #667eea;">
                        <h2 style="color: #2d3561; margin: 0;">âš™ï¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</h2>
                        <button onclick="document.getElementById('bulkOpsModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">Ã—</button>
                    </div>
                    
                    <!-- Operation Selection -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <button onclick="bulkEditInspections()" class="btn btn-primary" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">âœï¸</span>
                            <span>ØªØ¹Ø¯ÙŠÙ„ Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ù„ØªÙØªÙŠØ´Ø§Øª</span>
                        </button>
                        <button onclick="bulkDeleteInspections()" class="btn btn-danger" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">ğŸ—‘ï¸</span>
                            <span>Ø­Ø°Ù Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ù„ØªÙØªÙŠØ´Ø§Øª</span>
                        </button>
                        <button onclick="bulkCopyInspections()" class="btn btn-info" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">ğŸ“‹</span>
                            <span>Ù†Ø³Ø® Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ù„ØªÙØªÙŠØ´Ø§Øª</span>
                        </button>
                        <button onclick="bulkReassignInspectors()" class="btn btn-warning" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">ğŸ‘¥</span>
                            <span>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</span>
                        </button>
                        <button onclick="bulkReassignAreas()" class="btn btn-success" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">ğŸ—ºï¸</span>
                            <span>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</span>
                        </button>
                        <button onclick="bulkMergeDuplicates()" class="btn btn-primary" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">ğŸ”—</span>
                            <span>Ø¯Ù…Ø¬ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©</span>
                        </button>
                    </div>
                    
                    <!-- Statistics -->
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 15px; margin-top: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #667eea;">${planData.inspectionData.length}</div>
                                <div style="color: #666; font-size: 0.9em;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #11998e;">${new Set(planData.inspectionData.map(i => i.inspector)).size}</div>
                                <div style="color: #666; font-size: 0.9em;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #fa709a;">${new Set(planData.inspectionData.map(i => i.area)).size}</div>
                                <div style="color: #666; font-size: 0.9em;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #ffc107;">${planData.inspectionData.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0)}</div>
                                <div style="color: #666; font-size: 0.9em;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù„Ø§Øª</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Bulk Edit Inspections
        window.bulkEditInspections = function() {
            const selectedRange = prompt('ğŸ“… Ø£Ø¯Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„ØªÙØªÙŠØ´Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§:\n\nÙ…Ø«Ø§Ù„: 2025-01-01 Ø¥Ù„Ù‰ 2025-01-31\n\nØ§Ù„ØµÙŠØºØ©: Ù…Ù†-ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ø¥Ù„Ù‰-ØªØ§Ø±ÙŠØ®', '2025-01-01 Ø¥Ù„Ù‰ 2025-01-31');
            if (!selectedRange) return;
            
            const parts = selectedRange.split(' Ø¥Ù„Ù‰ ');
            if (parts.length !== 2) {
                alert('âš ï¸ ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø§Ø³ØªØ®Ø¯Ù…: Ù…Ù†-ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ø¥Ù„Ù‰-ØªØ§Ø±ÙŠØ®');
                return;
            }
            
            const fromDate = new Date(parts[0].trim());
            const toDate = new Date(parts[1].trim());
            
            const matchingInspections = planData.inspectionData.filter(insp => {
                const inspDate = new Date(insp.day);
                return inspDate >= fromDate && inspDate <= toDate;
            });
            
            if (matchingInspections.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØªÙŠØ´Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯');
                return;
            }
            
            const action = confirm(`âœï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${matchingInspections.length} ØªÙØªÙŠØ´ ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯:\nOK = ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙØªØ´\nCancel = ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©`);
            
            if (action) {
                // Edit inspector
                const newInspector = prompt('ğŸ‘¤ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙØªØ´ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', matchingInspections[0].inspector);
                if (!newInspector) return;
                
                matchingInspections.forEach(insp => {
                    insp.inspector = newInspector;
                });
                
                alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${matchingInspections.length} ØªÙØªÙŠØ´!\n\nØ§Ù„Ù…ÙØªØ´ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${newInspector}\n\nâš ï¸ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª`);
            } else {
                // Edit area
                const newArea = prompt('ğŸ—ºï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', matchingInspections[0].area);
                if (!newArea) return;
                
                matchingInspections.forEach(insp => {
                    insp.area = newArea;
                });
                
                alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${matchingInspections.length} ØªÙØªÙŠØ´!\n\nØ§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${newArea}\n\nâš ï¸ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª`);
            }
        };
        
        // Bulk Delete Inspections
        window.bulkDeleteInspections = async function() {
            const selectedRange = prompt('ğŸ—‘ï¸ Ø£Ø¯Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù„Ù„ØªÙØªÙŠØ´Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡Ø§:\n\nÙ…Ø«Ø§Ù„: 2025-01-01 Ø¥Ù„Ù‰ 2025-01-31\n\nØ§Ù„ØµÙŠØºØ©: Ù…Ù†-ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ø¥Ù„Ù‰-ØªØ§Ø±ÙŠØ®', '2025-01-01 Ø¥Ù„Ù‰ 2025-01-31');
            if (!selectedRange) return;
            
            const parts = selectedRange.split(' Ø¥Ù„Ù‰ ');
            if (parts.length !== 2) {
                alert('âš ï¸ ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø§Ø³ØªØ®Ø¯Ù…: Ù…Ù†-ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ø¥Ù„Ù‰-ØªØ§Ø±ÙŠØ®');
                return;
            }
            
            const fromDate = new Date(parts[0].trim());
            const toDate = new Date(parts[1].trim());
            
            const beforeCount = planData.inspectionData.length;
            planData.inspectionData = planData.inspectionData.filter(insp => {
                const inspDate = new Date(insp.day);
                return !(inspDate >= fromDate && inspDate <= toDate);
            });
            
            const deletedCount = beforeCount - planData.inspectionData.length;
            
            if (deletedCount === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØªÙŠØ´Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯');
                return;
            }
            
            if (!confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${deletedCount} ØªÙØªÙŠØ´ØŸ\n\nÙ‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§!`)) {
                // Reload data to undo
                await loadPlanData();
                return;
            }
            
            try {
                await savePlanDataToGitHub();
                alert(`âœ… ØªÙ… Ø­Ø°Ù ${deletedCount} ØªÙØªÙŠØ´ Ø¨Ù†Ø¬Ø§Ø­!`);
                document.getElementById('bulkOpsModal').remove();
            } catch (error) {
                alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + error.message);
            }
        };
        
        // Bulk Copy Inspections
        window.bulkCopyInspections = function() {
            const sourceDate = prompt('ğŸ“… Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ¯Ø± (Ø§Ù„ØªÙØªÙŠØ´Ø§Øª Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ù†Ø³Ø®Ù‡Ø§):', '2025-01-01');
            if (!sourceDate) return;
            
            const targetDate = prompt('ğŸ“… Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¯Ù (Ø­ÙŠØ« ØªØ±ÙŠØ¯ Ù†Ø³Ø® Ø§Ù„ØªÙØªÙŠØ´Ø§Øª):', '2025-02-01');
            if (!targetDate) return;
            
            const sourceInspections = planData.inspectionData.filter(i => i.day === sourceDate);
            
            if (sourceInspections.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØªÙŠØ´Ø§Øª ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ¯Ø±');
                return;
            }
            
            // Check if target date already has inspections
            const targetInspections = planData.inspectionData.filter(i => i.day === targetDate);
            if (targetInspections.length > 0) {
                if (!confirm(`âš ï¸ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¯Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${targetInspections.length} ØªÙØªÙŠØ´.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©ØŸ`)) {
                    return;
                }
            }
            
            // Copy inspections
            sourceInspections.forEach(insp => {
                const copiedInsp = {
                    ...insp,
                    day: targetDate,
                    id: 'insp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
                };
                planData.inspectionData.push(copiedInsp);
            });
            
            alert(`âœ… ØªÙ… Ù†Ø³Ø® ${sourceInspections.length} ØªÙØªÙŠØ´ Ù…Ù† ${sourceDate} Ø¥Ù„Ù‰ ${targetDate}!\n\nâš ï¸ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª`);
        };
        
        // Bulk Reassign Inspectors
        window.bulkReassignInspectors = function() {
            const oldInspector = prompt('ğŸ‘¤ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙØªØ´ Ø§Ù„Ù‚Ø¯ÙŠÙ…:', planData.inspectors[0]?.name || '');
            if (!oldInspector) return;
            
            const newInspector = prompt('ğŸ‘¤ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙØªØ´ Ø§Ù„Ø¬Ø¯ÙŠØ¯:');
            if (!newInspector) return;
            
            const matchingInspections = planData.inspectionData.filter(i => i.inspector === oldInspector);
            
            if (matchingInspections.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØªÙŠØ´Ø§Øª Ù„Ù„Ù…ÙØªØ´ Ø§Ù„Ù…Ø­Ø¯Ø¯');
                return;
            }
            
            if (!confirm(`ğŸ”„ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« ${matchingInspections.length} ØªÙØªÙŠØ´\n\nÙ…Ù†: ${oldInspector}\nØ¥Ù„Ù‰: ${newInspector}\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) {
                return;
            }
            
            matchingInspections.forEach(insp => {
                insp.inspector = newInspector;
            });
            
            alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${matchingInspections.length} ØªÙØªÙŠØ´!\n\nâš ï¸ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª`);
        };
        
        // Bulk Reassign Areas
        window.bulkReassignAreas = function() {
            const oldArea = prompt('ğŸ—ºï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©:', planData.areas[0]?.name || '');
            if (!oldArea) return;
            
            const newArea = prompt('ğŸ—ºï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:');
            if (!newArea) return;
            
            const matchingInspections = planData.inspectionData.filter(i => i.area === oldArea);
            
            if (matchingInspections.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØªÙŠØ´Ø§Øª Ù„Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©');
                return;
            }
            
            if (!confirm(`ğŸ”„ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« ${matchingInspections.length} ØªÙØªÙŠØ´\n\nÙ…Ù†: ${oldArea}\nØ¥Ù„Ù‰: ${newArea}\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) {
                return;
            }
            
            matchingInspections.forEach(insp => {
                insp.area = newArea;
            });
            
            alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${matchingInspections.length} ØªÙØªÙŠØ´!\n\nâš ï¸ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª`);
        };
        
        // Bulk Merge Duplicates
        window.bulkMergeDuplicates = async function() {
            const duplicates = [];
            const seen = new Map();
            
            planData.inspectionData.forEach((insp, idx) => {
                const key = `${insp.inspector}-${insp.day}-${insp.area}`;
                if (seen.has(key)) {
                    duplicates.push({
                        original: seen.get(key),
                        duplicate: idx,
                        inspector: insp.inspector,
                        day: insp.day,
                        area: insp.area
                    });
                } else {
                    seen.set(key, idx);
                }
            });
            
            if (duplicates.length === 0) {
                alert('âœ… Ø±Ø§Ø¦Ø¹! Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØªÙŠØ´Ø§Øª Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                return;
            }
            
            if (!confirm(`âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${duplicates.length} ØªÙØªÙŠØ´ Ù…ÙƒØ±Ø±\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø¯Ù…Ø¬Ù‡Ø§ ÙˆÙ…Ø­Ù„Ø§ØªÙ‡Ø§ ÙˆØ­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§ØªØŸ`)) {
                return;
            }
            
            // Merge duplicates
            duplicates.forEach(dup => {
                const original = planData.inspectionData[dup.original];
                const duplicate = planData.inspectionData[dup.duplicate];
                
                // Merge shops
                if (duplicate.shops) {
                    if (!original.shops) original.shops = [];
                    duplicate.shops.forEach(shop => {
                        if (!original.shops.includes(shop)) {
                            original.shops.push(shop);
                        }
                    });
                }
            });
            
            // Remove duplicates
            const toRemove = new Set(duplicates.map(d => d.duplicate));
            planData.inspectionData = planData.inspectionData.filter((_, idx) => !toRemove.has(idx));
            
            try {
                await savePlanDataToGitHub();
                alert(`âœ… ØªÙ… Ø¯Ù…Ø¬ ÙˆØ­Ø°Ù ${duplicates.length} ØªÙØªÙŠØ´ Ù…ÙƒØ±Ø± Ø¨Ù†Ø¬Ø§Ø­!`);
                document.getElementById('bulkOpsModal').remove();
            } catch (error) {
                alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + error.message);
            }
        };
        
        // Reload Shops from Excel - REAL IMPLEMENTATION
        async function reloadShopsFromExcel() {
            if (!githubToken) {
                alert('âŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            // Create file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.multiple = false;
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    // Show merge options modal
                    showExcelImportModal(file);
                } catch (error) {
                    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
                }
            };
            
            input.click();
        }
        
        // Show Excel Import Modal with merge options
        async function showExcelImportModal(file) {
            const modal = document.createElement('div');
            modal.id = 'excelImportModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 800px; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ù…Ù† Excel</h2>
                        <button onclick="document.getElementById('excelImportModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">Ã—</button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 10px 0;">ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù</h3>
                        <p style="margin: 0;">ğŸ“„ <strong>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù:</strong> ${file.name}</p>
                        <p style="margin: 5px 0 0 0;">ğŸ“Š <strong>Ø§Ù„Ø­Ø¬Ù…:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">âš™ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¯Ù…Ø¬</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="add" checked style="width: 20px; height: 20px;">
                                <div>
                                    <strong>Ø¥Ø¶Ø§ÙØ© ÙÙ‚Ø·</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· ÙˆØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…ÙƒØ±Ø±</p>
                                </div>
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="update" style="width: 20px; height: 20px;">
                                <div>
                                    <strong>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</p>
                                </div>
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="replace" style="width: 20px; height: 20px;">
                                <div>
                                    <strong>Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ffc107;">
                        <h4 style="color: #856404; margin: 0 0 10px 0;">ğŸ“Œ Ù…ØªØ·Ù„Ø¨Ø§Øª Ù…Ù„Ù Excel</h4>
                        <ul style="margin: 0; padding-right: 20px; color: #856404;">
                            <li>ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©: Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ØŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ</li>
                            <li>ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ù…Ø¯Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©: Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ ADMØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø§Ù„Ù†Ø´Ø§Ø·</li>
                            <li>ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ ÙˆÙ…Ø§ Ø¨Ø¹Ø¯Ù‡ (Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†)</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="processExcelImport('${file.name}')" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            âœ… Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                        </button>
                        <button onclick="document.getElementById('excelImportModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            âŒ Ø¥Ù„ØºØ§Ø¡
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store file data for processing
            window.excelImportFile = file;
        }
        
        // Process Excel Import
        async function processExcelImport(fileName) {
            const file = window.excelImportFile;
            if (!file) {
                alert('âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù');
                return;
            }
            
            // Get merge mode
            const mergeMode = document.querySelector('input[name="mergeMode"]:checked').value;
            
            // Close modal
            document.getElementById('excelImportModal').remove();
            
            // Show loading message
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingExcelImport';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10001;
                text-align: center;
            `;
            loadingDiv.innerHTML = `
                <h3 style="color: #2d3561; margin-bottom: 15px;">â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...</h3>
                <p style="color: #666;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
            `;
            document.body.appendChild(loadingDiv);
            
            try {
                // Read file
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get first sheet
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                
                if (!jsonData || jsonData.length === 0) {
                    throw new Error('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©');
                }
                
                // Process the data
                const result = await processShopsData(jsonData, mergeMode);
                
                // Remove loading
                document.getElementById('loadingExcelImport').remove();
                
                // Show result
                alert(`âœ… ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!\n\n` +
                      `ğŸ“Š Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: ${result.processed}\n` +
                      `â• Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©: ${result.added}\n` +
                      `ğŸ”„ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©: ${result.updated}\n` +
                      `â­ï¸  Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…ØªØ¬Ø§Ù‡Ù„Ø©: ${result.skipped}\n\n` +
                      `Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù†...`);
                
                // Save to GitHub
                await savePlanData();
                
                // Refresh the list
                refreshShopsList();
                
            } catch (error) {
                document.getElementById('loadingExcelImport')?.remove();
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
                console.error('Excel import error:', error);
            }
        }
        
        // Process shops data from Excel
        async function processShopsData(jsonData, mergeMode) {
            let processed = 0;
            let added = 0;
            let updated = 0;
            let skipped = 0;
            
            // Ensure planData.shops exists
            if (!planData.shops) {
                planData.shops = [];
            }
            
            // If replace mode, clear existing shops
            if (mergeMode === 'replace') {
                planData.shops = [];
            }
            
            // Get existing shop names for duplicate checking
            const existingShops = new Set(planData.shops.map(shop => shop.name));
            
            // Process each row
            for (const row of jsonData) {
                processed++;
                
                // Extract shop data (try different possible column names)
                const shopName = row['Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„'] || row['name'] || row['shopName'] || row['Ø§Ù„Ø§Ø³Ù…'];
                const area = row['Ø§Ù„Ù…Ù†Ø·Ù‚Ø©'] || row['area'] || row['Ø§Ù„Ù…Ù†Ø·Ù‚Ø©'];
                const licenseNo = row['Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ'] || row['license'] || row['licenseNo'] || '';
                const admCode = row['Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ'] || row['admCode'] || row['ADM'] || '';
                const address = row['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'] || row['address'] || '';
                const contact = row['Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„'] || row['contact'] || '';
                const activity = row['Ø§Ù„Ù†Ø´Ø§Ø·'] || row['activity'] || '';
                
                if (!shopName) {
                    skipped++;
                    continue;
                }
                
                // Check if shop exists
                const existingIndex = planData.shops.findIndex(s => s.name === shopName);
                const exists = existingIndex !== -1;
                
                if (exists && mergeMode === 'add') {
                    // Skip existing shops in add mode
                    skipped++;
                    continue;
                }
                
                // Create shop object
                const shopData = {
                    name: shopName,
                    area: area || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                    id: admCode || licenseNo || `SHOP${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                };
                
                // Add optional fields if available
                if (licenseNo) shopData.licenseNo = licenseNo;
                if (address) shopData.address = address;
                if (contact) shopData.contact = contact;
                if (activity) shopData.activity = activity;
                
                if (exists && mergeMode === 'update') {
                    // Update existing shop
                    planData.shops[existingIndex] = { ...planData.shops[existingIndex], ...shopData };
                    updated++;
                } else {
                    // Add new shop
                    planData.shops.push(shopData);
                    added++;
                }
            }
            
            return { processed, added, updated, skipped };
        }
        
        // Export Shops to Excel - REAL IMPLEMENTATION
        function exportShopsToExcel() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }
            
            try {
                // Prepare data for export
                const exportData = planData.shops.map(shop => ({
                    'Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„': shop.name,
                    'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©': shop.area,
                    'Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ': shop.id || '',
                    'Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ': shop.licenseNo || '',
                    'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†': shop.address || '',
                    'Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„': shop.contact || '',
                    'Ø§Ù„Ù†Ø´Ø§Ø·': shop.activity || ''
                }));
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 30 }, // Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„
                    { wch: 20 }, // Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
                    { wch: 15 }, // Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ
                    { wch: 15 }, // Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ
                    { wch: 25 }, // Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                    { wch: 20 }, // Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                    { wch: 25 }  // Ø§Ù„Ù†Ø´Ø§Ø·
                ];
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ù…Ø­Ù„Ø§Øª');
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `Ù…Ø­Ù„Ø§Øª_${timestamp}.xlsx`;
                
                // Download file
                XLSX.writeFile(wb, filename);
                
                alert(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${exportData.length} Ù…Ø­Ù„ Ø¥Ù„Ù‰ Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­!\n\n` +
                      `ğŸ“„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù: ${filename}`);
                
            } catch (error) {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
                console.error('Excel export error:', error);
            }
        }
        
        // Bulk Edit Shops - FULL IMPLEMENTATION
        async function bulkEditShops() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
                return;
            }
            
            // Create modal for bulk edit
            const modal = document.createElement('div');
            modal.id = 'bulkEditModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">âœï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ù„Ù…Ø­Ù„Ø§Øª</h2>
                        <button onclick="document.getElementById('bulkEditModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">Ã—</button>
                    </div>
                    
                    <!-- Selection Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 15px 0;">ğŸ“‹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button onclick="selectAllShopsForEdit()" style="padding: 10px 20px; border: none; border-radius: 8px; background: white; color: #667eea; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                â˜‘ï¸ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                            </button>
                            <button onclick="deselectAllShopsForEdit()" style="padding: 10px 20px; border: none; border-radius: 8px; background: white; color: #667eea; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                â˜ Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                            </button>
                            <select id="bulkEditAreaFilter" onchange="filterShopsForBulkEdit()" style="padding: 10px; border-radius: 8px; border: none; font-family: 'Cairo', sans-serif;">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Shops Selection List -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
                        <div id="bulkEditShopsList"></div>
                    </div>
                    
                    <!-- Edit Operations -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">âš™ï¸ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</h3>
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø©:</label>
                                <select id="bulkEditNewArea" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                                    <option value="">-- Ø§Ø®ØªØ± Ù…Ù†Ø·Ù‚Ø© --</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ø¯Ø¦Ø© Ù„Ù„Ø£Ø³Ù…Ø§Ø¡:</label>
                                <input type="text" id="bulkEditPrefix" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù„ -" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø­Ù‚Ø© Ù„Ù„Ø£Ø³Ù…Ø§Ø¡:</label>
                                <input type="text" id="bulkEditSuffix" placeholder="Ù…Ø«Ø§Ù„: - Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="bulkEditSelectedCount">0</div>
                            <div style="font-size: 0.9em;">Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="applyBulkEdit()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                        </button>
                        <button onclick="document.getElementById('bulkEditModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            âŒ Ø¥Ù„ØºØ§Ø¡
                        </button>
                    </div>
                    
                    <div id="bulkEditStatus" style="margin-top: 20px;"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate area filters and dropdowns
            const areaFilter = document.getElementById('bulkEditAreaFilter');
            const newAreaSelect = document.getElementById('bulkEditNewArea');
            
            if (planData.areas) {
                planData.areas.forEach(area => {
                    const filterOption = document.createElement('option');
                    filterOption.value = area.id;
                    filterOption.textContent = area.name;
                    areaFilter.appendChild(filterOption);
                    
                    const editOption = document.createElement('option');
                    editOption.value = area.id;
                    editOption.textContent = area.name;
                    newAreaSelect.appendChild(editOption);
                });
            }
            
            // Initialize shops list
            filterShopsForBulkEdit();
        }
        
        // Filter shops for bulk edit
        window.filterShopsForBulkEdit = function() {
            const filterAreaId = document.getElementById('bulkEditAreaFilter').value;
            const shopsList = document.getElementById('bulkEditShopsList');
            
            let shopsToShow = planData.shops;
            if (filterAreaId) {
                shopsToShow = shopsToShow.filter(s => s.areaId === filterAreaId);
            }
            
            shopsList.innerHTML = shopsToShow.map((shop, index) => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #e0e0e0;">
                        <input type="checkbox" id="shop_${shop.id}" value="${shop.id}" onchange="updateBulkEditCount()" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="shop_${shop.id}" style="flex: 1; cursor: pointer;">
                            <strong>${shop.name}</strong>
                            <span style="color: #666; font-size: 0.9em;"> - ${area ? area.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                        </label>
                    </div>
                `;
            }).join('');
            
            updateBulkEditCount();
        };
        
        // Select all shops for edit
        window.selectAllShopsForEdit = function() {
            document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateBulkEditCount();
        };
        
        // Deselect all shops for edit
        window.deselectAllShopsForEdit = function() {
            document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateBulkEditCount();
        };
        
        // Update bulk edit count
        window.updateBulkEditCount = function() {
            const count = document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]:checked').length;
            document.getElementById('bulkEditSelectedCount').textContent = count;
        };
        
        // Apply bulk edit
        window.applyBulkEdit = async function() {
            const selectedShopIds = Array.from(document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedShopIds.length === 0) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ø­Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            const newAreaId = document.getElementById('bulkEditNewArea').value;
            const prefix = document.getElementById('bulkEditPrefix').value.trim();
            const suffix = document.getElementById('bulkEditSuffix').value.trim();
            
            if (!newAreaId && !prefix && !suffix) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            if (!githubToken) {
                alert('âŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            if (!confirm(`ğŸ”„ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ ${selectedShopIds.length} Ù…Ø­Ù„ØŸ\n\nØ³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ GitHub.`)) {
                return;
            }
            
            const statusDiv = document.getElementById('bulkEditStatus');
            statusDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; border: 2px solid #bee5eb;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„...</div>';
            
            try {
                let editedCount = 0;
                
                planData.shops.forEach(shop => {
                    if (selectedShopIds.includes(shop.id)) {
                        if (newAreaId) {
                            shop.areaId = newAreaId;
                        }
                        if (prefix) {
                            shop.name = prefix + shop.name;
                        }
                        if (suffix) {
                            shop.name = shop.name + suffix;
                        }
                        editedCount++;
                    }
                });
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; border: 2px solid #c3e6cb;">
                        âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ${editedCount} Ù…Ø­Ù„ Ø¨Ù†Ø¬Ø§Ø­!
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('bulkEditModal').remove();
                    displayShopsList();
                    alert(`âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ${editedCount} Ù…Ø­Ù„ Ø¨Ù†Ø¬Ø§Ø­!`);
                }, 2000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">âŒ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ${error.message}</div>`;
            }
        };
        
        // Bulk Delete Shops - FULL IMPLEMENTATION
        async function bulkDeleteShops() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù„Ù„Ø­Ø°Ù');
                return;
            }
            
            // Create modal for bulk delete
            const modal = document.createElement('div');
            modal.id = 'bulkDeleteModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">ğŸ—‘ï¸ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ù„Ù…Ø­Ù„Ø§Øª</h2>
                        <button onclick="document.getElementById('bulkDeleteModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">Ã—</button>
                    </div>
                    
                    <!-- Warning -->
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 10px 0;">âš ï¸ ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù…</h3>
                        <p style="margin: 0;">Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯.</p>
                    </div>
                    
                    <!-- Selection Section -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                            <button onclick="selectAllShopsForDelete()" style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                â˜‘ï¸ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                            </button>
                            <button onclick="deselectAllShopsForDelete()" style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                â˜ Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                            </button>
                            <select id="bulkDeleteAreaFilter" onchange="filterShopsForBulkDelete()" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
                            </select>
                        </div>
                        <div id="bulkDeleteShopsList" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    
                    <!-- Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #dc3545 0%, #c0392b 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="bulkDeleteSelectedCount">0</div>
                            <div style="font-size: 0.9em;">Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„Ø­Ø°Ù</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="applyBulkDelete()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ğŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
                        </button>
                        <button onclick="document.getElementById('bulkDeleteModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            âŒ Ø¥Ù„ØºØ§Ø¡
                        </button>
                    </div>
                    
                    <div id="bulkDeleteStatus" style="margin-top: 20px;"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate area filter
            const areaFilter = document.getElementById('bulkDeleteAreaFilter');
            if (planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    areaFilter.appendChild(option);
                });
            }
            
            // Initialize shops list
            filterShopsForBulkDelete();
        }
        
        // Filter shops for bulk delete
        window.filterShopsForBulkDelete = function() {
            const filterAreaId = document.getElementById('bulkDeleteAreaFilter').value;
            const shopsList = document.getElementById('bulkDeleteShopsList');
            
            let shopsToShow = planData.shops;
            if (filterAreaId) {
                shopsToShow = shopsToShow.filter(s => s.areaId === filterAreaId);
            }
            
            shopsList.innerHTML = shopsToShow.map(shop => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #e0e0e0;">
                        <input type="checkbox" id="delshop_${shop.id}" value="${shop.id}" onchange="updateBulkDeleteCount()" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="delshop_${shop.id}" style="flex: 1; cursor: pointer;">
                            <strong>${shop.name}</strong>
                            <span style="color: #666; font-size: 0.9em;"> - ${area ? area.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                        </label>
                    </div>
                `;
            }).join('');
            
            updateBulkDeleteCount();
        };
        
        // Select all shops for delete
        window.selectAllShopsForDelete = function() {
            document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateBulkDeleteCount();
        };
        
        // Deselect all shops for delete
        window.deselectAllShopsForDelete = function() {
            document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateBulkDeleteCount();
        };
        
        // Update bulk delete count
        window.updateBulkDeleteCount = function() {
            const count = document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]:checked').length;
            document.getElementById('bulkDeleteSelectedCount').textContent = count;
        };
        
        // Apply bulk delete
        window.applyBulkDelete = async function() {
            const selectedShopIds = Array.from(document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedShopIds.length === 0) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ø­Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø°Ù');
                return;
            }
            
            if (!githubToken) {
                alert('âŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            if (!confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† Ø­Ø°Ù ${selectedShopIds.length} Ù…Ø­Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\n\nÙ‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§!\n\nØ³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ GitHub.`)) {
                return;
            }
            
            const statusDiv = document.getElementById('bulkDeleteStatus');
            statusDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; border: 2px solid #bee5eb;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...</div>';
            
            try {
                const initialCount = planData.shops.length;
                planData.shops = planData.shops.filter(shop => !selectedShopIds.includes(shop.id));
                const deletedCount = initialCount - planData.shops.length;
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; border: 2px solid #c3e6cb;">
                        âœ… ØªÙ… Ø­Ø°Ù ${deletedCount} Ù…Ø­Ù„ Ø¨Ù†Ø¬Ø§Ø­!
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('bulkDeleteModal').remove();
                    displayShopsList();
                    alert(`âœ… ØªÙ… Ø­Ø°Ù ${deletedCount} Ù…Ø­Ù„ Ø¨Ù†Ø¬Ø§Ø­!`);
                }, 2000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ${error.message}</div>`;
            }
        };
        
        
        // Merge Shops Data - FULL IMPLEMENTATION
        async function mergeShopsData() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„Ø§Øª Ù„Ù„Ø¯Ù…Ø¬');
                return;
            }
            
            // Create modal for merge operation
            const modal = document.createElement('div');
            modal.id = 'mergeModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">ğŸ”— Ø¯Ù…Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„Ø§Øª</h2>
                        <button onclick="document.getElementById('mergeModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">Ã—</button>
                    </div>
                    
                    <!-- Merge Options -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 15px 0;">âš™ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¯Ù…Ø¬</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="duplicates" checked onchange="updateMergePreview()">
                                <span>Ø¯Ù…Ø¬ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙÙ‚Ø·</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="similar" onchange="updateMergePreview()">
                                <span>Ø¯Ù…Ø¬ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="fromFile" onchange="updateMergePreview()">
                                <span>Ø¯Ù…Ø¬ Ù…Ù† Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- File Upload for External Merge -->
                    <div id="fileUploadSection" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ù„Ù„Ø¯Ù…Ø¬</h3>
                        <input type="file" id="mergeFileInput" accept=".json" onchange="loadMergeFile(this)" style="padding: 10px; border: 2px solid #667eea; border-radius: 8px; width: 100%; font-family: 'Cairo', sans-serif;">
                        <p style="color: #666; margin-top: 10px; font-size: 0.9em;">Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù JSON ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª Ù„Ù„Ø¯Ù…Ø¬</p>
                    </div>
                    
                    <!-- Merge Preview -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¯Ù…Ø¬</h3>
                        <div id="mergePreviewContent">
                            <p style="text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                        </div>
                    </div>
                    
                    <!-- Merge Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mergeCurrentCount">0</div>
                            <div style="font-size: 0.9em;">Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mergeDuplicatesCount">0</div>
                            <div style="font-size: 0.9em;">Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mergeAfterCount">0</div>
                            <div style="font-size: 0.9em;">Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ù…Ø¬</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="performMerge()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯Ù…Ø¬
                        </button>
                        <button onclick="document.getElementById('mergeModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            âŒ Ø¥Ù„ØºØ§Ø¡
                        </button>
                    </div>
                    
                    <div id="mergeStatus" style="margin-top: 20px;"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initial preview update
            setTimeout(() => updateMergePreview(), 100);
        }
        
        // Update merge preview based on selected mode
        window.updateMergePreview = function() {
            const mode = document.querySelector('input[name="mergeMode"]:checked').value;
            const fileUploadSection = document.getElementById('fileUploadSection');
            const previewContent = document.getElementById('mergePreviewContent');
            
            // Show/hide file upload section
            fileUploadSection.style.display = mode === 'fromFile' ? 'block' : 'none';
            
            // Update stats
            document.getElementById('mergeCurrentCount').textContent = planData.shops.length;
            
            if (mode === 'duplicates') {
                findDuplicates(previewContent);
            } else if (mode === 'similar') {
                findSimilar(previewContent);
            } else if (mode === 'fromFile') {
                previewContent.innerHTML = '<p style="text-align: center; color: #999;">Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù JSON Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</p>';
                document.getElementById('mergeDuplicatesCount').textContent = '0';
                document.getElementById('mergeAfterCount').textContent = planData.shops.length;
            }
        };
        
        // Find duplicate shops
        function findDuplicates(container) {
            const duplicates = [];
            const nameMap = {};
            
            planData.shops.forEach((shop, index) => {
                const normalizedName = shop.name.trim().toLowerCase();
                if (nameMap[normalizedName]) {
                    duplicates.push({
                        original: nameMap[normalizedName],
                        duplicate: shop,
                        index: index
                    });
                } else {
                    nameMap[normalizedName] = shop;
                }
            });
            
            document.getElementById('mergeDuplicatesCount').textContent = duplicates.length;
            document.getElementById('mergeAfterCount').textContent = planData.shops.length - duplicates.length;
            
            if (duplicates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #11998e;">
                        <div style="font-size: 3em; margin-bottom: 10px;">âœ…</div>
                        <p style="font-size: 1.2em; font-weight: 600;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø©!</p>
                        <p style="color: #666;">Ø¬Ù…ÙŠØ¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­Ù„Ø§Øª ÙØ±ÙŠØ¯Ø© ÙˆÙ…Ù†Ø¸Ù…Ø©.</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea; color: white; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 10px; text-align: right;">Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ø£ØµÙ„ÙŠ</th>
                                    <th style="padding: 10px; text-align: right;">Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ù…ÙƒØ±Ø±</th>
                                    <th style="padding: 10px; text-align: right;">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${duplicates.map(dup => {
                                    const origArea = planData.areas.find(a => a.id === dup.original.areaId);
                                    const dupArea = planData.areas.find(a => a.id === dup.duplicate.areaId);
                                    return `
                                        <tr style="border-bottom: 1px solid #e0e0e0;">
                                            <td style="padding: 10px;">${dup.original.name}</td>
                                            <td style="padding: 10px; color: #dc3545;">${dup.duplicate.name}</td>
                                            <td style="padding: 10px;">${origArea ? origArea.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} / ${dupArea ? dupArea.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                        ğŸ’¡ Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ø£ÙˆÙ„ ÙˆØ­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ÙƒØ±Ø±Ø©
                    </p>
                `;
            }
            
            // Store duplicates for later use
            window.currentDuplicates = duplicates;
        }
        
        // Find similar shops (with fuzzy matching)
        function findSimilar(container) {
            const similar = [];
            const shops = planData.shops;
            
            for (let i = 0; i < shops.length; i++) {
                for (let j = i + 1; j < shops.length; j++) {
                    const similarity = calculateSimilarity(shops[i].name, shops[j].name);
                    if (similarity > 0.7) { // 70% similarity threshold
                        similar.push({
                            shop1: shops[i],
                            shop2: shops[j],
                            similarity: similarity
                        });
                    }
                }
            }
            
            document.getElementById('mergeDuplicatesCount').textContent = similar.length;
            document.getElementById('mergeAfterCount').textContent = planData.shops.length - similar.length;
            
            if (similar.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #11998e;">
                        <div style="font-size: 3em; margin-bottom: 10px;">âœ…</div>
                        <p style="font-size: 1.2em; font-weight: 600;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù…ØªØ´Ø§Ø¨Ù‡Ø©!</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea; color: white; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 10px; text-align: right;">Ø§Ù„Ù…Ø­Ù„ 1</th>
                                    <th style="padding: 10px; text-align: right;">Ø§Ù„Ù…Ø­Ù„ 2</th>
                                    <th style="padding: 10px; text-align: right;">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ´Ø§Ø¨Ù‡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${similar.map(sim => `
                                    <tr style="border-bottom: 1px solid #e0e0e0;">
                                        <td style="padding: 10px;">${sim.shop1.name}</td>
                                        <td style="padding: 10px;">${sim.shop2.name}</td>
                                        <td style="padding: 10px; color: #ffc107;">${Math.round(sim.similarity * 100)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            window.currentSimilar = similar;
        }
        
        // Calculate string similarity (Levenshtein distance)
        function calculateSimilarity(str1, str2) {
            const s1 = str1.toLowerCase().trim();
            const s2 = str2.toLowerCase().trim();
            
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }
        
        // Levenshtein distance algorithm
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        // Load merge file
        window.loadMergeFile = function(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileData = JSON.parse(e.target.result);
                    
                    // Validate file format
                    if (!Array.isArray(fileData) && !fileData.shops) {
                        throw new Error('ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                    }
                    
                    const externalShops = Array.isArray(fileData) ? fileData : fileData.shops;
                    window.externalShopsToMerge = externalShops;
                    
                    // Update preview
                    const previewContent = document.getElementById('mergePreviewContent');
                    previewContent.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #11998e;">
                            <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“¥</div>
                            <p style="font-size: 1.2em; font-weight: 600;">ØªÙ… ØªØ­Ù…ÙŠÙ„ ${externalShops.length} Ù…Ø­Ù„ Ù…Ù† Ø§Ù„Ù…Ù„Ù</p>
                            <p style="color: #666;">Ø³ÙŠØªÙ… Ø¯Ù…Ø¬ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ù…Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
                        </div>
                    `;
                    
                    document.getElementById('mergeDuplicatesCount').textContent = externalShops.length;
                    document.getElementById('mergeAfterCount').textContent = planData.shops.length + externalShops.length;
                    
                } catch (error) {
                    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
                }
            };
            reader.readAsText(file);
        };
        
        // Perform merge operation
        window.performMerge = async function() {
            const mode = document.querySelector('input[name="mergeMode"]:checked').value;
            const statusDiv = document.getElementById('mergeStatus');
            
            if (!githubToken) {
                statusDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">âŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹</div>';
                return;
            }
            
            if (!confirm('ğŸ”— Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ù…Ø¬ØŸ\n\nØ³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ GitHub.')) {
                return;
            }
            
            statusDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; border: 2px solid #bee5eb;">â³ Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ù…Ø¬...</div>';
            
            try {
                let mergedShops = [...planData.shops];
                let removedCount = 0;
                let addedCount = 0;
                
                if (mode === 'duplicates') {
                    // Remove duplicates
                    if (window.currentDuplicates && window.currentDuplicates.length > 0) {
                        const duplicateIndices = window.currentDuplicates.map(d => d.index);
                        mergedShops = planData.shops.filter((shop, index) => !duplicateIndices.includes(index));
                        removedCount = window.currentDuplicates.length;
                    }
                } else if (mode === 'similar') {
                    // Remove similar shops (keep first occurrence)
                    if (window.currentSimilar && window.currentSimilar.length > 0) {
                        const toRemove = new Set();
                        window.currentSimilar.forEach(sim => {
                            const idx2 = planData.shops.indexOf(sim.shop2);
                            toRemove.add(idx2);
                        });
                        mergedShops = planData.shops.filter((shop, index) => !toRemove.has(index));
                        removedCount = toRemove.size;
                    }
                } else if (mode === 'fromFile') {
                    // Merge external shops
                    if (window.externalShopsToMerge && window.externalShopsToMerge.length > 0) {
                        window.externalShopsToMerge.forEach(extShop => {
                            // Check if shop already exists
                            const exists = mergedShops.some(s => 
                                s.name.toLowerCase().trim() === extShop.name.toLowerCase().trim()
                            );
                            
                            if (!exists) {
                                mergedShops.push({
                                    id: extShop.id || 'shop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                    name: extShop.name,
                                    areaId: extShop.areaId || ''
                                });
                                addedCount++;
                            }
                        });
                    }
                }
                
                // Update plan data
                planData.shops = mergedShops;
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; border: 2px solid #c3e6cb;">
                        âœ… ØªÙ… Ø§Ù„Ø¯Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­!<br>
                        ${removedCount > 0 ? `ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù ${removedCount} Ù…Ø­Ù„ Ù…ÙƒØ±Ø±<br>` : ''}
                        ${addedCount > 0 ? `â• ØªÙ… Ø¥Ø¶Ø§ÙØ© ${addedCount} Ù…Ø­Ù„ Ø¬Ø¯ÙŠØ¯<br>` : ''}
                        ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø¢Ù†: ${mergedShops.length}
                    </div>
                `;
                
                // Refresh shops list
                setTimeout(() => {
                    document.getElementById('mergeModal').remove();
                    displayShopsList();
                    alert(`âœ… ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!\n\n${removedCount > 0 ? `ØªÙ… Ø­Ø°Ù ${removedCount} Ù…Ø­Ù„ Ù…ÙƒØ±Ø±\n` : ''}${addedCount > 0 ? `ØªÙ… Ø¥Ø¶Ø§ÙØ© ${addedCount} Ù…Ø­Ù„ Ø¬Ø¯ÙŠØ¯\n` : ''}Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù„Ø§Øª: ${mergedShops.length}`);
                }, 2000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">âŒ ÙØ´Ù„ Ø§Ù„Ø¯Ù…Ø¬: ${error.message}</div>`;
            }
        };
        
        
        // Validate Shops Data
        function validateShopsData() {
            if (!planData || !planData.shops) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„Ø§Øª Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡Ø§');
                return;
            }
            
            const issues = [];
            planData.shops.forEach((shop, idx) => {
                if (!shop.name) issues.push(`Ù…Ø­Ù„ ${idx + 1}: Ø§Ø³Ù… ØºÙŠØ± Ù…Ø­Ø¯Ø¯`);
                if (!shop.areaId) issues.push(`${shop.name}: Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©`);
            });
            
            if (issues.length === 0) {
                alert('âœ… Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„Ø§Øª ØµØ­ÙŠØ­Ø©!\n\n' +
                      `ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù„Ø§Øª: ${planData.shops.length}`);
            } else {
                alert(`âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${issues.length} Ù…Ø´ÙƒÙ„Ø©:\n\n` + 
                      issues.slice(0, 10).join('\n') +
                      (issues.length > 10 ? `\n\n... Ùˆ ${issues.length - 10} Ù…Ø´ÙƒÙ„Ø© Ø£Ø®Ø±Ù‰` : ''));
            }
        }
        
        // View Shops on Map - INTERACTIVE AND HEATMAP IMPLEMENTATION
        function viewShopsOnMap() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©');
                return;
            }
            
            // Create modal for map
            const modal = document.createElement('div');
            modal.id = 'mapModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 95%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© ÙˆØ§Ù„Ø­Ø±Ø§Ø±ÙŠØ© Ù„Ù„Ù…Ø­Ù„Ø§Øª</h2>
                        <button onclick="document.getElementById('mapModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">Ã—</button>
                    </div>
                    
                    <!-- Map Controls -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <select id="mapViewMode" onchange="updateMapView()" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            <option value="interactive">ğŸ“ Ø¹Ø±Ø¶ ØªÙØ§Ø¹Ù„ÙŠ</option>
                            <option value="heatmap">ğŸ”¥ Ø®Ø±ÙŠØ·Ø© Ø­Ø±Ø§Ø±ÙŠØ©</option>
                            <option value="cluster">ğŸ¯ Ø¹Ø±Ø¶ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
                        </select>
                        <select id="mapFilterArea" onchange="updateMapView()" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
                        </select>
                        <button onclick="toggleHeatmapIntensity()" style="padding: 10px 20px; border-radius: 8px; border: none; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                            ğŸŒ¡ï¸ ØªØ¨Ø¯ÙŠÙ„ ÙƒØ«Ø§ÙØ© Ø§Ù„Ø­Ø±Ø§Ø±Ø©
                        </button>
                        <button onclick="exportMapData()" style="padding: 10px 20px; border-radius: 8px; border: none; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                            ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                        </button>
                    </div>
                    
                    <!-- Map Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mapTotalShops">0</div>
                            <div style="font-size: 0.9em;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù„Ø§Øª</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mapVisibleShops">0</div>
                            <div style="font-size: 0.9em;">Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mapAreasCount">0</div>
                            <div style="font-size: 0.9em;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</div>
                        </div>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="shopsMapContainer" style="background: #f5f5f5; border-radius: 10px; padding: 20px; min-height: 500px; position: relative;">
                        <div id="mapLegend" style="position: absolute; top: 10px; right: 10px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100;">
                            <h4 style="margin: 0 0 10px 0; color: #2d3561;">Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h4>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 20px; background: #667eea; border-radius: 50%;"></div>
                                    <span>Ù…Ø­Ù„ Ø¹Ø§Ø¯ÙŠ</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 20px; background: #dc3545; border-radius: 50%;"></div>
                                    <span>Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 20px; background: #ffc107; border-radius: 50%;"></div>
                                    <span>Ø£ÙˆÙ„ÙˆÙŠØ© Ù…ØªÙˆØ³Ø·Ø©</span>
                                </div>
                            </div>
                        </div>
                        <div id="mapCanvas" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 20px;">
                            <!-- Map items will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Shop Details Panel -->
                    <div id="shopDetailsPanel" style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px; display: none;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯</h3>
                        <div id="shopDetailsContent"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate area filter
            const areaFilter = document.getElementById('mapFilterArea');
            if (planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    areaFilter.appendChild(option);
                });
            }
            
            // Initial map render
            updateMapView();
        }
        
        // Update map view based on selected mode
        window.updateMapView = function() {
            const mode = document.getElementById('mapViewMode').value;
            const filterAreaId = document.getElementById('mapFilterArea').value;
            const mapCanvas = document.getElementById('mapCanvas');
            
            // Filter shops
            let shopsToDisplay = planData.shops || [];
            if (filterAreaId) {
                shopsToDisplay = shopsToDisplay.filter(s => s.areaId === filterAreaId);
            }
            
            // Update stats
            document.getElementById('mapTotalShops').textContent = planData.shops.length;
            document.getElementById('mapVisibleShops').textContent = shopsToDisplay.length;
            document.getElementById('mapAreasCount').textContent = new Set(planData.shops.map(s => s.areaId)).size;
            
            // Clear canvas
            mapCanvas.innerHTML = '';
            
            if (mode === 'interactive') {
                renderInteractiveMap(shopsToDisplay, mapCanvas);
            } else if (mode === 'heatmap') {
                renderHeatmap(shopsToDisplay, mapCanvas);
            } else if (mode === 'cluster') {
                renderClusterMap(shopsToDisplay, mapCanvas);
            }
        };
        
        // Render interactive map
        function renderInteractiveMap(shops, container) {
            shops.forEach((shop, index) => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                const areaName = area ? area.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                
                // Calculate priority color
                let color = '#667eea';
                let priorityLabel = 'Ø¹Ø§Ø¯ÙŠ';
                
                // Check if shop has high priority based on last inspection
                const lastInspection = planData.inspectionData ? 
                    planData.inspectionData.filter(i => i.shops && i.shops.includes(shop.name))
                    .sort((a, b) => new Date(b.day) - new Date(a.day))[0] : null;
                
                if (lastInspection) {
                    const daysSince = Math.floor((new Date() - new Date(lastInspection.day)) / (1000 * 60 * 60 * 24));
                    if (daysSince > 30) {
                        color = '#dc3545';
                        priorityLabel = 'Ø¹Ø§Ù„ÙŠØ©';
                    } else if (daysSince > 14) {
                        color = '#ffc107';
                        priorityLabel = 'Ù…ØªÙˆØ³Ø·Ø©';
                    }
                }
                
                const shopCard = document.createElement('div');
                shopCard.style.cssText = `
                    background: white;
                    padding: 15px;
                    border-radius: 10px;
                    border: 3px solid ${color};
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                `;
                shopCard.onmouseover = function() {
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
                };
                shopCard.onmouseout = function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                };
                shopCard.onclick = function() {
                    showShopDetails(shop, lastInspection);
                };
                
                shopCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #2d3561; font-size: 1.1em;">${shop.name}</h4>
                        <span style="background: ${color}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75em;">${priorityLabel}</span>
                    </div>
                    <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">ğŸ“ ${areaName}</div>
                    <div style="color: #999; font-size: 0.85em;">
                        ${lastInspection ? `Ø¢Ø®Ø± ØªÙØªÙŠØ´: ${new Date(lastInspection.day).toLocaleDateString('ar-EG')}` : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙØªÙŠØ´ Ø¨Ø¹Ø¯'}
                    </div>
                `;
                
                container.appendChild(shopCard);
            });
        }
        
        // Render heatmap
        function renderHeatmap(shops, container) {
            // Group shops by area
            const areaGroups = {};
            shops.forEach(shop => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                const areaName = area ? area.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (!areaGroups[areaName]) {
                    areaGroups[areaName] = [];
                }
                areaGroups[areaName].push(shop);
            });
            
            // Find max count for heat intensity
            const maxCount = Math.max(...Object.values(areaGroups).map(g => g.length));
            
            // Render heat blocks
            Object.entries(areaGroups).forEach(([areaName, areaShops]) => {
                const intensity = areaShops.length / maxCount;
                const heatColor = getHeatColor(intensity);
                
                const heatBlock = document.createElement('div');
                heatBlock.style.cssText = `
                    background: ${heatColor};
                    padding: 20px;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                    min-height: 150px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    text-align: center;
                `;
                heatBlock.onmouseover = function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
                };
                heatBlock.onmouseout = function() {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                };
                
                heatBlock.innerHTML = `
                    <h3 style="margin: 0 0 15px 0; color: white; font-size: 1.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">${areaName}</h3>
                    <div style="font-size: 3em; font-weight: 700; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">${areaShops.length}</div>
                    <div style="color: white; font-size: 1em; margin-top: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">Ù…Ø­Ù„</div>
                    <div style="margin-top: 10px; color: white; font-size: 0.9em;">ğŸ”¥ ÙƒØ«Ø§ÙØ©: ${Math.round(intensity * 100)}%</div>
                `;
                
                container.appendChild(heatBlock);
            });
        }
        
        // Render cluster map
        function renderClusterMap(shops, container) {
            // Similar to heatmap but with different visualization
            const areaGroups = {};
            shops.forEach(shop => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                const areaName = area ? area.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (!areaGroups[areaName]) {
                    areaGroups[areaName] = [];
                }
                areaGroups[areaName].push(shop);
            });
            
            Object.entries(areaGroups).forEach(([areaName, areaShops]) => {
                const clusterDiv = document.createElement('div');
                clusterDiv.style.cssText = `
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 20px;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                `;
                
                clusterDiv.innerHTML = `
                    <h3 style="margin: 0 0 15px 0; color: white;">${areaName}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 5px;">
                        ${areaShops.map((shop, idx) => `
                            <div style="width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; color: #667eea; font-weight: 700;" title="${shop.name}">
                                ${idx + 1}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(clusterDiv);
            });
        }
        
        // Get heat color based on intensity
        function getHeatColor(intensity) {
            const colors = [
                '#38ef7d',  // Low (green)
                '#11998e',  // Medium-low (teal)
                '#ffc107',  // Medium (yellow)
                '#fa709a',  // Medium-high (pink)
                '#dc3545'   // High (red)
            ];
            const index = Math.min(Math.floor(intensity * colors.length), colors.length - 1);
            return colors[index];
        }
        
        // Show shop details
        window.showShopDetails = function(shop, lastInspection) {
            const panel = document.getElementById('shopDetailsPanel');
            const content = document.getElementById('shopDetailsContent');
            const area = planData.areas.find(a => a.id === shop.areaId);
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <strong style="color: #667eea;">Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„:</strong><br>
                        <span>${shop.name}</span>
                    </div>
                    <div>
                        <strong style="color: #667eea;">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong><br>
                        <span>${area ? area.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </div>
                    <div>
                        <strong style="color: #667eea;">Ø§Ù„Ù…Ø¹Ø±Ù:</strong><br>
                        <span style="font-family: monospace;">${shop.id}</span>
                    </div>
                    ${lastInspection ? `
                        <div>
                            <strong style="color: #667eea;">Ø¢Ø®Ø± ØªÙØªÙŠØ´:</strong><br>
                            <span>${new Date(lastInspection.day).toLocaleDateString('ar-EG')}</span>
                        </div>
                        <div>
                            <strong style="color: #667eea;">Ø§Ù„Ù…ÙØªØ´:</strong><br>
                            <span>${lastInspection.inspector}</span>
                        </div>
                    ` : ''}
                </div>
            `;
            
            panel.style.display = 'block';
        };
        
        // Toggle heatmap intensity
        window.toggleHeatmapIntensity = function() {
            alert('ğŸŒ¡ï¸ ØªÙ… ØªØ¨Ø¯ÙŠÙ„ ÙƒØ«Ø§ÙØ© Ø§Ù„Ø­Ø±Ø§Ø±Ø©!\n\nØ§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© ØªØ¹Ø±Ø¶ Ø§Ù„Ø¢Ù† ÙƒØ«Ø§ÙØ§Øª Ù…Ø®ØªÙ„ÙØ© Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª ÙÙŠ ÙƒÙ„ Ù…Ù†Ø·Ù‚Ø©.');
            updateMapView();
        };
        
        // Export map data
        window.exportMapData = function() {
            const mode = document.getElementById('mapViewMode').value;
            const filterAreaId = document.getElementById('mapFilterArea').value;
            
            let shopsToExport = planData.shops || [];
            if (filterAreaId) {
                shopsToExport = shopsToExport.filter(s => s.areaId === filterAreaId);
            }
            
            const exportData = {
                exportDate: new Date().toISOString(),
                mode: mode,
                totalShops: shopsToExport.length,
                shops: shopsToExport.map(shop => {
                    const area = planData.areas.find(a => a.id === shop.areaId);
                    return {
                        name: shop.name,
                        area: area ? area.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        id: shop.id
                    };
                })
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `map-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${shopsToExport.length} Ù…Ø­Ù„ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ù†Ø¬Ø§Ø­!`);
        };
        
        
        // ============================================
        // MERGE AREAS FUNCTIONS
        // ============================================
        
        // Open merge areas modal
        function mergeAreas() {
            if (!planData || !planData.areas || planData.areas.length < 2) {
                alert('âš ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Ù…Ù†Ø·Ù‚ØªÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¯Ù…Ø¬');
                return;
            }
            
            // Populate target area dropdown
            const targetSelect = document.getElementById('mergeTargetArea');
            targetSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --</option>';
            planData.areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.name;
                targetSelect.appendChild(option);
            });
            
            // Populate source areas checkboxes
            const container = document.getElementById('mergeSourceAreasContainer');
            container.innerHTML = '';
            planData.areas.forEach(area => {
                const shopsCount = planData.shops.filter(s => s.areaId === area.id).length;
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.padding = '8px';
                label.style.cursor = 'pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${area.id}" class="merge-source-checkbox" style="margin-left: 10px;">
                    ${area.name} (${shopsCount} Ù…Ø­Ù„)
                `;
                container.appendChild(label);
            });
            
            document.getElementById('mergeAreasModal').style.display = 'block';
            document.getElementById('mergeAreasStatus').innerHTML = '';
        }
        
        // Close merge areas modal
        function closeMergeAreasModal() {
            document.getElementById('mergeAreasModal').style.display = 'none';
        }
        
        // Execute merge areas
        async function executeMergeAreas() {
            const targetAreaId = document.getElementById('mergeTargetArea').value;
            const checkboxes = document.querySelectorAll('.merge-source-checkbox:checked');
            const sourceAreaIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (!targetAreaId) {
                showMessage('mergeAreasStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
                return;
            }
            
            if (sourceAreaIds.length === 0) {
                showMessage('mergeAreasStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¯Ù…Ø¬');
                return;
            }
            
            if (sourceAreaIds.includes(targetAreaId)) {
                showMessage('mergeAreasStatus', 'error', 'âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙÙŠ Ù†ÙØ³Ù‡Ø§');
                return;
            }
            
            const targetArea = planData.areas.find(a => a.id === targetAreaId);
            const sourceAreas = planData.areas.filter(a => sourceAreaIds.includes(a.id));
            const sourceAreasNames = sourceAreas.map(a => a.name).join('ØŒ ');
            
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚:\n${sourceAreasNames}\n\nÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${targetArea.name}ØŸ\n\nØ³ÙŠØªÙ… Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ù„Ø§Øª ÙˆØ­Ø°Ù Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©.`)) {
                return;
            }
            
            showMessage('mergeAreasStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚...');
            
            try {
                // Move all shops from source areas to target area
                let movedShopsCount = 0;
                planData.shops.forEach(shop => {
                    if (sourceAreaIds.includes(shop.areaId)) {
                        shop.areaId = targetAreaId;
                        movedShopsCount++;
                    }
                });
                
                // Update inspections data
                let updatedInspections = 0;
                if (planData.inspectionData) {
                    planData.inspectionData.forEach(inspection => {
                        const sourceArea = sourceAreas.find(a => a.name === inspection.area);
                        if (sourceArea) {
                            inspection.area = targetArea.name;
                            updatedInspections++;
                        }
                    });
                }
                
                // Remove source areas
                planData.areas = planData.areas.filter(a => !sourceAreaIds.includes(a.id));
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('mergeAreasStatus', 'success', 
                    `âœ… ØªÙ… Ø¯Ù…Ø¬ ${sourceAreas.length} Ù…Ù†Ø·Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­!\n` +
                    `â€¢ ØªÙ… Ù†Ù‚Ù„ ${movedShopsCount} Ù…Ø­Ù„\n` +
                    `â€¢ ØªÙ… ØªØ­Ø¯ÙŠØ« ${updatedInspections} ØªÙØªÙŠØ´`);
                
                setTimeout(() => {
                    closeMergeAreasModal();
                    displayAreasList();
                    populateAreas();
                    populateShopAreaFilter();
                }, 2000);
                
            } catch (error) {
                showMessage('mergeAreasStatus', 'error', 'âŒ ÙØ´Ù„ Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚: ' + error.message);
            }
        }
        
        // ============================================
        // ASSIGN SHOPS TO AREAS FUNCTIONS
        // ============================================
        
        // Open assign shops modal
        function assignShopsToAreas() {
            if (!planData || !planData.areas || planData.areas.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø·Ù‚ Ù…ØªØ§Ø­Ø©');
                return;
            }
            
            if (!planData.shops || planData.shops.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù…ØªØ§Ø­Ø©');
                return;
            }
            
            // Populate current area filter
            const currentAreaSelect = document.getElementById('assignShopsCurrentArea');
            currentAreaSelect.innerHTML = '<option value="">-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ --</option>';
            planData.areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.name;
                currentAreaSelect.appendChild(option);
            });
            
            // Populate target area dropdown
            const targetSelect = document.getElementById('assignShopsTargetArea');
            targetSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© --</option>';
            planData.areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.name;
                targetSelect.appendChild(option);
            });
            
            // Load shops
            loadShopsForAssignment();
            
            document.getElementById('assignShopsModal').style.display = 'block';
            document.getElementById('assignShopsStatus').innerHTML = '';
        }
        
        // Close assign shops modal
        function closeAssignShopsModal() {
            document.getElementById('assignShopsModal').style.display = 'none';
        }
        
        // Load shops for assignment
        function loadShopsForAssignment() {
            const currentAreaId = document.getElementById('assignShopsCurrentArea').value;
            const container = document.getElementById('assignShopsContainer');
            
            let shopsToShow = planData.shops;
            if (currentAreaId) {
                shopsToShow = planData.shops.filter(s => s.areaId === currentAreaId);
            }
            
            container.innerHTML = '';
            if (shopsToShow.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª</p>';
                return;
            }
            
            shopsToShow.forEach(shop => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                const areaName = area ? area.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.padding = '8px';
                label.style.cursor = 'pointer';
                label.className = 'shop-assignment-label';
                label.innerHTML = `
                    <input type="checkbox" value="${shop.id}" class="assign-shop-checkbox" style="margin-left: 10px;">
                    ${shop.name} <span style="color: #999; font-size: 0.9em;">(${areaName})</span>
                `;
                container.appendChild(label);
            });
        }
        
        // Filter shops for assignment
        function filterShopsForAssignment() {
            const searchTerm = document.getElementById('searchShopsForAssignment').value.toLowerCase();
            const labels = document.querySelectorAll('.shop-assignment-label');
            
            labels.forEach(label => {
                const text = label.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    label.style.display = 'block';
                } else {
                    label.style.display = 'none';
                }
            });
        }
        
        // Select all shops for assignment
        function selectAllShopsForAssignment() {
            const checkboxes = document.querySelectorAll('.assign-shop-checkbox');
            checkboxes.forEach(cb => {
                if (cb.parentElement.style.display !== 'none') {
                    cb.checked = true;
                }
            });
        }
        
        // Deselect all shops for assignment
        function deselectAllShopsForAssignment() {
            const checkboxes = document.querySelectorAll('.assign-shop-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        // Execute assign shops
        async function executeAssignShops() {
            const targetAreaId = document.getElementById('assignShopsTargetArea').value;
            const checkboxes = document.querySelectorAll('.assign-shop-checkbox:checked');
            const shopIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (!targetAreaId) {
                showMessage('assignShopsStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
                return;
            }
            
            if (shopIds.length === 0) {
                showMessage('assignShopsStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            const targetArea = planData.areas.find(a => a.id === targetAreaId);
            
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ù‚Ù„ ${shopIds.length} Ù…Ø­Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${targetArea.name}ØŸ`)) {
                return;
            }
            
            showMessage('assignShopsStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ù„Ø§Øª...');
            
            try {
                // Update shops area
                const updatedShops = [];
                planData.shops.forEach(shop => {
                    if (shopIds.includes(shop.id)) {
                        const oldArea = planData.areas.find(a => a.id === shop.areaId);
                        shop.areaId = targetAreaId;
                        updatedShops.push({
                            name: shop.name,
                            oldArea: oldArea ? oldArea.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                            newArea: targetArea.name
                        });
                    }
                });
                
                // Update inspections
                let updatedInspections = 0;
                if (planData.inspectionData) {
                    updatedShops.forEach(shopInfo => {
                        planData.inspectionData.forEach(inspection => {
                            if (inspection.shops && inspection.shops.includes(shopInfo.name)) {
                                if (inspection.area === shopInfo.oldArea) {
                                    inspection.area = shopInfo.newArea;
                                    updatedInspections++;
                                }
                            }
                        });
                    });
                }
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('assignShopsStatus', 'success', 
                    `âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† ${shopIds.length} Ù…Ø­Ù„ Ø¨Ù†Ø¬Ø§Ø­!\n` +
                    `â€¢ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${targetArea.name}\n` +
                    `â€¢ ØªÙ… ØªØ­Ø¯ÙŠØ« ${updatedInspections} ØªÙØªÙŠØ´`);
                
                setTimeout(() => {
                    closeAssignShopsModal();
                    displayShopsList();
                    displayAreasList();
                }, 2000);
                
            } catch (error) {
                showMessage('assignShopsStatus', 'error', 'âŒ ÙØ´Ù„ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ù„Ø§Øª: ' + error.message);
            }
        }
        
        // Export Areas Data
        function exportAreasData() {
            if (!planData || !planData.areas) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†Ø§Ø·Ù‚ Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }
            
            const dataStr = JSON.stringify(planData.areas, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `areas-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${planData.areas.length} Ù…Ù†Ø·Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­!`);
        }
        
        // Import Areas from File
        function importAreasFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedAreas = JSON.parse(event.target.result);
                        if (!Array.isArray(importedAreas)) {
                            alert('âŒ ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ù…Ù†Ø§Ø·Ù‚.');
                            return;
                        }
                        
                        alert(`ğŸ“¥ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedAreas.length} Ù…Ù†Ø·Ù‚Ø©!\n\nØ³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…ÙŠØ²Ø© Ø§Ù„Ø¯Ù…Ø¬ Ù‚Ø±ÙŠØ¨Ø§Ù‹.`);
                    } catch (error) {
                        alert('âŒ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // ============================================
        // BULK EDIT AREAS FUNCTIONS
        // ============================================
        
        // Open bulk edit modal
        function bulkEditAreas() {
            if (!planData || !planData.areas || planData.areas.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø·Ù‚ Ù…ØªØ§Ø­Ø©');
                return;
            }
            
            // Populate areas checkboxes
            const container = document.getElementById('bulkEditAreasContainer');
            container.innerHTML = '';
            planData.areas.forEach(area => {
                const shopsCount = planData.shops.filter(s => s.areaId === area.id).length;
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.padding = '8px';
                label.style.cursor = 'pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${area.id}" class="bulk-edit-checkbox" style="margin-left: 10px;">
                    ${area.name} (${shopsCount} Ù…Ø­Ù„)
                `;
                container.appendChild(label);
            });
            
            document.getElementById('bulkEditModal').style.display = 'block';
            document.getElementById('bulkEditStatus').innerHTML = '';
            document.getElementById('bulkEditPreview').style.display = 'none';
        }
        
        // Close bulk edit modal
        function closeBulkEditModal() {
            document.getElementById('bulkEditModal').style.display = 'none';
        }
        
        // Toggle bulk edit options
        function toggleBulkEditOptions() {
            const editType = document.getElementById('bulkEditType').value;
            const prefixSuffixDiv = document.getElementById('bulkEditPrefixSuffix');
            const replaceDiv = document.getElementById('bulkEditReplace');
            
            if (editType === 'replace') {
                prefixSuffixDiv.style.display = 'none';
                replaceDiv.style.display = 'block';
            } else {
                prefixSuffixDiv.style.display = 'block';
                replaceDiv.style.display = 'none';
            }
        }
        
        // Select all areas for bulk edit
        function selectAllAreasForBulkEdit() {
            const checkboxes = document.querySelectorAll('.bulk-edit-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
        }
        
        // Deselect all areas for bulk edit
        function deselectAllAreasForBulkEdit() {
            const checkboxes = document.querySelectorAll('.bulk-edit-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        // Preview bulk edit
        function previewBulkEdit() {
            const checkboxes = document.querySelectorAll('.bulk-edit-checkbox:checked');
            const areaIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (areaIds.length === 0) {
                showMessage('bulkEditStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            const editType = document.getElementById('bulkEditType').value;
            const changes = [];
            
            if (editType === 'prefix') {
                const prefix = document.getElementById('bulkEditText').value.trim();
                if (!prefix) {
                    showMessage('bulkEditStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø§Ø¯Ø¦Ø©');
                    return;
                }
                
                areaIds.forEach(areaId => {
                    const area = planData.areas.find(a => a.id === areaId);
                    if (area) {
                        changes.push({
                            old: area.name,
                            new: prefix + ' ' + area.name
                        });
                    }
                });
            } else if (editType === 'suffix') {
                const suffix = document.getElementById('bulkEditText').value.trim();
                if (!suffix) {
                    showMessage('bulkEditStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù„Ø§Ø­Ù‚Ø©');
                    return;
                }
                
                areaIds.forEach(areaId => {
                    const area = planData.areas.find(a => a.id === areaId);
                    if (area) {
                        changes.push({
                            old: area.name,
                            new: area.name + ' ' + suffix
                        });
                    }
                });
            } else if (editType === 'replace') {
                const findText = document.getElementById('bulkEditFindText').value.trim();
                const replaceText = document.getElementById('bulkEditReplaceText').value.trim();
                
                if (!findText) {
                    showMessage('bulkEditStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡');
                    return;
                }
                
                areaIds.forEach(areaId => {
                    const area = planData.areas.find(a => a.id === areaId);
                    if (area && area.name.includes(findText)) {
                        changes.push({
                            old: area.name,
                            new: area.name.replace(new RegExp(findText, 'g'), replaceText)
                        });
                    }
                });
            }
            
            if (changes.length === 0) {
                showMessage('bulkEditStatus', 'warning', 'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§');
                return;
            }
            
            // Display preview
            const previewDiv = document.getElementById('bulkEditPreview');
            const previewContent = document.getElementById('bulkEditPreviewContent');
            previewContent.innerHTML = '';
            
            changes.forEach(change => {
                const changeDiv = document.createElement('div');
                changeDiv.style.padding = '10px';
                changeDiv.style.borderBottom = '1px solid #e0e0e0';
                changeDiv.innerHTML = `
                    <div style="color: #dc3545;">Ø§Ù„Ù‚Ø¯ÙŠÙ…: ${change.old}</div>
                    <div style="color: #28a745;">Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${change.new}</div>
                `;
                previewContent.appendChild(changeDiv);
            });
            
            previewDiv.style.display = 'block';
            showMessage('bulkEditStatus', 'success', `âœ… Ù…Ø¹Ø§ÙŠÙ†Ø© ${changes.length} ØªØºÙŠÙŠØ±`);
        }
        
        // Execute bulk edit
        async function executeBulkEdit() {
            const checkboxes = document.querySelectorAll('.bulk-edit-checkbox:checked');
            const areaIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (areaIds.length === 0) {
                showMessage('bulkEditStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            const editType = document.getElementById('bulkEditType').value;
            
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ ${areaIds.length} Ù…Ù†Ø·Ù‚Ø©ØŸ`)) {
                return;
            }
            
            showMessage('bulkEditStatus', 'info', 'â³ Ø¬Ø§Ø±ÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª...');
            
            try {
                let changesCount = 0;
                const updates = [];
                
                if (editType === 'prefix') {
                    const prefix = document.getElementById('bulkEditText').value.trim();
                    if (!prefix) {
                        showMessage('bulkEditStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø§Ø¯Ø¦Ø©');
                        return;
                    }
                    
                    areaIds.forEach(areaId => {
                        const area = planData.areas.find(a => a.id === areaId);
                        if (area) {
                            const oldName = area.name;
                            area.name = prefix + ' ' + area.name;
                            updates.push({ oldName, newName: area.name });
                            changesCount++;
                        }
                    });
                } else if (editType === 'suffix') {
                    const suffix = document.getElementById('bulkEditText').value.trim();
                    if (!suffix) {
                        showMessage('bulkEditStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù„Ø§Ø­Ù‚Ø©');
                        return;
                    }
                    
                    areaIds.forEach(areaId => {
                        const area = planData.areas.find(a => a.id === areaId);
                        if (area) {
                            const oldName = area.name;
                            area.name = area.name + ' ' + suffix;
                            updates.push({ oldName, newName: area.name });
                            changesCount++;
                        }
                    });
                } else if (editType === 'replace') {
                    const findText = document.getElementById('bulkEditFindText').value.trim();
                    const replaceText = document.getElementById('bulkEditReplaceText').value.trim();
                    
                    if (!findText) {
                        showMessage('bulkEditStatus', 'error', 'âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡');
                        return;
                    }
                    
                    areaIds.forEach(areaId => {
                        const area = planData.areas.find(a => a.id === areaId);
                        if (area && area.name.includes(findText)) {
                            const oldName = area.name;
                            area.name = area.name.replace(new RegExp(findText, 'g'), replaceText);
                            updates.push({ oldName, newName: area.name });
                            changesCount++;
                        }
                    });
                }
                
                // Update inspections to match new area names
                let updatedInspections = 0;
                if (planData.inspectionData) {
                    updates.forEach(update => {
                        planData.inspectionData.forEach(inspection => {
                            if (inspection.area === update.oldName) {
                                inspection.area = update.newName;
                                updatedInspections++;
                            }
                        });
                    });
                }
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('bulkEditStatus', 'success', 
                    `âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ${changesCount} ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n` +
                    `â€¢ ØªÙ… ØªØ­Ø¯ÙŠØ« ${updatedInspections} ØªÙØªÙŠØ´`);
                
                setTimeout(() => {
                    closeBulkEditModal();
                    displayAreasList();
                    populateAreas();
                }, 2000);
                
            } catch (error) {
                showMessage('bulkEditStatus', 'error', 'âŒ ÙØ´Ù„ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª: ' + error.message);
            }
        }
        
        // Generate Areas Report
        function generateAreasReport() {
            if (!planData || !planData.areas || !planData.shops) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„ØªÙ‚Ø±ÙŠØ±');
                return;
            }
            
            let report = 'ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø§Ø·Ù‚\n';
            report += '=' .repeat(50) + '\n\n';
            
            planData.areas.forEach(area => {
                const shopsInArea = planData.shops.filter(s => s.areaId === area.id).length;
                const inspectionsInArea = planData.inspectionData.filter(i => i.area === area.name).length;
                
                report += `ğŸ—ºï¸ ${area.name}\n`;
                report += `   â€¢ Ø§Ù„Ù…Ø­Ù„Ø§Øª: ${shopsInArea}\n`;
                report += `   â€¢ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª: ${inspectionsInArea}\n\n`;
            });
            
            const dataBlob = new Blob([report], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `areas-report-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø§Ø·Ù‚!');
        }
        
        // ==================== Smart Shop List Functions ====================
        
        /**
         * Calculate shop rating based on multiple criteria
         * Rating criteria:
         * 1. Compliance (Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…) - 30 points
         * 2. Last inspection date (Ø¢Ø®Ø± ØªÙØªÙŠØ´) - 25 points
         * 3. Inspection frequency (ØªÙƒØ±Ø§Ø± Ø§Ù„ØªÙØªÙŠØ´) - 20 points
         * 4. Data completeness (Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) - 15 points
         * 5. Activity type priority (Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù†Ø´Ø§Ø·) - 10 points
         */
        function calculateShopRating(shopName) {
            let rating = 0;
            let details = {
                compliance: 0,
                lastInspection: 0,
                frequency: 0,
                dataCompleteness: 0,
                activityPriority: 0
            };
            
            // Get shop details
            const shopDetails = shopsDetails ? shopsDetails[shopName] : null;
            
            // 1. Data Completeness (15 points)
            if (shopDetails) {
                let completeness = 0;
                if (shopDetails.nameAr) completeness += 2;
                if (shopDetails.nameEn) completeness += 2;
                if (shopDetails.licenseNo) completeness += 3;
                if (shopDetails.admCode) completeness += 2;
                if (shopDetails.address) completeness += 2;
                if (shopDetails.contact) completeness += 2;
                if (shopDetails.activity) completeness += 2;
                details.dataCompleteness = completeness;
                rating += completeness;
            }
            
            // 2. Activity Type Priority (10 points)
            if (shopDetails && shopDetails.activity) {
                const activity = shopDetails.activity.toLowerCase();
                // High priority activities
                if (activity.includes('animal') || activity.includes('Ø­ÙŠÙˆØ§Ù†') || 
                    activity.includes('veterinar') || activity.includes('Ø¨ÙŠØ·Ø±')) {
                    details.activityPriority = 10;
                    rating += 10;
                } else if (activity.includes('pet') || activity.includes('Ø£Ù„ÙŠÙ')) {
                    details.activityPriority = 8;
                    rating += 8;
                } else if (activity.includes('bird') || activity.includes('Ø·ÙŠÙˆØ±')) {
                    details.activityPriority = 7;
                    rating += 7;
                } else {
                    details.activityPriority = 5;
                    rating += 5;
                }
            }
            
            // 3. Last Inspection Date (25 points)
            const lastInspection = getLastInspectionForShop(shopName);
            if (lastInspection) {
                const daysSince = Math.floor((new Date() - new Date(lastInspection.day)) / (1000 * 60 * 60 * 24));
                if (daysSince <= 7) {
                    details.lastInspection = 25;
                    rating += 25;
                } else if (daysSince <= 14) {
                    details.lastInspection = 20;
                    rating += 20;
                } else if (daysSince <= 30) {
                    details.lastInspection = 15;
                    rating += 15;
                } else if (daysSince <= 60) {
                    details.lastInspection = 10;
                    rating += 10;
                } else {
                    details.lastInspection = 5;
                    rating += 5;
                }
            }
            
            // 4. Inspection Frequency (20 points)
            const inspectionCount = getInspectionCountForShop(shopName);
            if (inspectionCount >= 10) {
                details.frequency = 20;
                rating += 20;
            } else if (inspectionCount >= 7) {
                details.frequency = 16;
                rating += 16;
            } else if (inspectionCount >= 5) {
                details.frequency = 12;
                rating += 12;
            } else if (inspectionCount >= 3) {
                details.frequency = 8;
                rating += 8;
            } else if (inspectionCount >= 1) {
                details.frequency = 4;
                rating += 4;
            }
            
            // 5. Compliance Score (30 points) - Based on consistent inspections
            // Good compliance = regular inspections without long gaps
            if (inspectionCount > 0) {
                const inspections = getInspectionsForShop(shopName);
                if (inspections.length >= 2) {
                    // Calculate consistency
                    const dates = inspections.map(i => new Date(i.day)).sort((a, b) => b - a);
                    const gaps = [];
                    for (let i = 0; i < dates.length - 1; i++) {
                        gaps.push(Math.floor((dates[i] - dates[i + 1]) / (1000 * 60 * 60 * 24)));
                    }
                    const avgGap = gaps.reduce((a, b) => a + b, 0) / gaps.length;
                    
                    if (avgGap <= 14) {
                        details.compliance = 30;
                        rating += 30;
                    } else if (avgGap <= 21) {
                        details.compliance = 25;
                        rating += 25;
                    } else if (avgGap <= 30) {
                        details.compliance = 20;
                        rating += 20;
                    } else {
                        details.compliance = 15;
                        rating += 15;
                    }
                } else if (inspectionCount === 1) {
                    details.compliance = 10;
                    rating += 10;
                }
            }
            
            return { rating, details };
        }
        
        function getLastInspectionForShop(shopName) {
            if (!planData || !planData.inspectionData) return null;
            
            const inspections = planData.inspectionData
                .filter(i => i.shops && i.shops.includes(shopName))
                .sort((a, b) => new Date(b.day) - new Date(a.day));
            
            return inspections.length > 0 ? inspections[0] : null;
        }
        
        function getInspectionCountForShop(shopName) {
            if (!planData || !planData.inspectionData) return 0;
            
            return planData.inspectionData.filter(i => i.shops && i.shops.includes(shopName)).length;
        }
        
        function getInspectionsForShop(shopName) {
            if (!planData || !planData.inspectionData) return [];
            
            return planData.inspectionData.filter(i => i.shops && i.shops.includes(shopName));
        }
        
        // Open Smart Shop List Modal
        async function openSmartShopListModal() {
            // Load shops details if not loaded
            if (!shopsDetails) {
                try {
                    const response = await fetch('shops_details.json?' + new Date().getTime());
                    if (response.ok) {
                        shopsDetails = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading shops_details.json:', error);
                }
            }
            
            // Populate area filter
            const areaFilter = document.getElementById('smartListAreaFilter');
            areaFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>';
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    areaFilter.appendChild(option);
                });
            }
            
            // Show modal
            document.getElementById('smartShopListModal').style.display = 'block';
            
            // Generate initial list
            updateSmartShopList();
        }
        
        // Close Smart Shop List Modal
        function closeSmartShopListModal() {
            document.getElementById('smartShopListModal').style.display = 'none';
        }
        
        // Update Smart Shop List based on filters
        function updateSmartShopList() {
            const primarySort = document.getElementById('primarySort').value;
            const areaFilter = document.getElementById('smartListAreaFilter').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            const tableView = document.getElementById('tableView').value;
            
            // Collect all shops
            let allShops = [];
            
            if (shopsDetails) {
                Object.entries(shopsDetails).forEach(([shopName, shopInfo]) => {
                    const area = planData?.areas?.find(a => a.name === shopInfo.address || a.id === shopInfo.areaId);
                    const ratingData = calculateShopRating(shopName);
                    
                    allShops.push({
                        name: shopInfo.nameAr || shopName,
                        nameEn: shopInfo.nameEn || '',
                        licenseNo: shopInfo.licenseNo || '',
                        admCode: shopInfo.admCode || '',
                        address: shopInfo.address || '',
                        contact: shopInfo.contact || '',
                        activity: shopInfo.activity || '',
                        area: area ? area.name : shopInfo.address || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        areaId: area ? area.id : '',
                        rating: ratingData.rating,
                        ratingDetails: ratingData.details,
                        lastInspection: getLastInspectionForShop(shopName),
                        inspectionCount: getInspectionCountForShop(shopName)
                    });
                });
            }
            
            // Apply filters
            if (areaFilter) {
                const selectedArea = planData?.areas?.find(a => a.id === areaFilter);
                if (selectedArea) {
                    allShops = allShops.filter(s => s.area === selectedArea.name || s.areaId === areaFilter);
                }
            }
            
            if (ratingFilter) {
                allShops = allShops.filter(shop => {
                    if (ratingFilter === 'excellent') return shop.rating >= 90;
                    if (ratingFilter === 'good') return shop.rating >= 70 && shop.rating < 90;
                    if (ratingFilter === 'fair') return shop.rating >= 50 && shop.rating < 70;
                    if (ratingFilter === 'poor') return shop.rating < 50;
                    return true;
                });
            }
            
            // Apply sorting
            if (primarySort === 'rating') {
                allShops.sort((a, b) => b.rating - a.rating);
            } else if (primarySort === 'area') {
                allShops.sort((a, b) => a.area.localeCompare(b.area, 'ar'));
            } else if (primarySort === 'activity') {
                allShops.sort((a, b) => (a.activity || '').localeCompare(b.activity || '', 'ar'));
            } else if (primarySort === 'alphabetical') {
                allShops.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            } else if (primarySort === 'lastInspection') {
                allShops.sort((a, b) => {
                    const dateA = a.lastInspection ? new Date(a.lastInspection.day) : new Date(0);
                    const dateB = b.lastInspection ? new Date(b.lastInspection.day) : new Date(0);
                    return dateB - dateA;
                });
            }
            
            // Update statistics
            const totalShops = allShops.length;
            const avgRating = totalShops > 0 ? (allShops.reduce((sum, s) => sum + s.rating, 0) / totalShops).toFixed(1) : 0;
            const uniqueAreas = new Set(allShops.map(s => s.area)).size;
            const highPriority = allShops.filter(s => s.rating >= 70).length;
            
            document.getElementById('smartListTotalShops').textContent = totalShops;
            document.getElementById('smartListAvgRating').textContent = avgRating;
            document.getElementById('smartListAreas').textContent = uniqueAreas;
            document.getElementById('smartListHighPriority').textContent = highPriority;
            
            // Generate tables based on view mode
            const content = document.getElementById('smartShopListContent');
            
            if (tableView === 'unified') {
                content.innerHTML = generateUnifiedTable(allShops);
            } else if (tableView === 'byArea') {
                content.innerHTML = generateTablesByArea(allShops);
            } else if (tableView === 'byActivity') {
                content.innerHTML = generateTablesByActivity(allShops);
            }
        }
        
        // Generate unified table
        function generateUnifiedTable(shops) {
            if (shops.length === 0) {
                return '<p style="text-align: center; padding: 40px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>';
            }
            
            let html = '<div style="overflow-x: auto;">';
            html += '<table class="inspections-table" style="width: 100%;">';
            html += '<thead><tr>';
            html += '<th>#</th>';
            html += '<th>Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„</th>';
            html += '<th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>';
            html += '<th>Ø§Ù„Ù†Ø´Ø§Ø·</th>';
            html += '<th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>';
            html += '<th>Ø¢Ø®Ø± ØªÙØªÙŠØ´</th>';
            html += '<th>Ø¹Ø¯Ø¯ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª</th>';
            html += '<th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>';
            html += '</tr></thead><tbody>';
            
            shops.forEach((shop, idx) => {
                const ratingClass = shop.rating >= 90 ? 'excellent' : 
                                   shop.rating >= 70 ? 'good' : 
                                   shop.rating >= 50 ? 'fair' : 'poor';
                const ratingColor = shop.rating >= 90 ? '#27ae60' : 
                                   shop.rating >= 70 ? '#3498db' : 
                                   shop.rating >= 50 ? '#f39c12' : '#e74c3c';
                
                const lastInspectionText = shop.lastInspection ? 
                    new Date(shop.lastInspection.day).toLocaleDateString('ar-EG') : 'Ù„Ù… ÙŠØªÙ…';
                
                const activityShort = shop.activity ? 
                    (shop.activity.length > 50 ? shop.activity.substring(0, 50) + '...' : shop.activity) : 
                    'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                
                html += '<tr>';
                html += `<td>${idx + 1}</td>`;
                html += `<td><strong>${escapeHtml(shop.name)}</strong><br><small style="color: #999;">${escapeHtml(shop.nameEn || '')}</small></td>`;
                html += `<td>${escapeHtml(shop.area)}</td>`;
                html += `<td title="${escapeHtml(shop.activity || '')}">${escapeHtml(activityShort)}</td>`;
                html += `<td><div style="background: ${ratingColor}; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; text-align: center;">${shop.rating.toFixed(0)}</div></td>`;
                html += `<td>${lastInspectionText}</td>`;
                html += `<td style="text-align: center;">${shop.inspectionCount}</td>`;
                html += `<td><button onclick="showShopRatingDetails('${escapeHtml(shop.name)}')" class="btn btn-sm btn-info" style="padding: 5px 10px;">Ø¹Ø±Ø¶</button></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        // Generate tables by area
        function generateTablesByArea(shops) {
            if (shops.length === 0) {
                return '<p style="text-align: center; padding: 40px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>';
            }
            
            // Group shops by area
            const shopsByArea = {};
            shops.forEach(shop => {
                if (!shopsByArea[shop.area]) {
                    shopsByArea[shop.area] = [];
                }
                shopsByArea[shop.area].push(shop);
            });
            
            let html = '';
            Object.keys(shopsByArea).sort((a, b) => a.localeCompare(b, 'ar')).forEach(area => {
                const areaShops = shopsByArea[area];
                const avgRating = (areaShops.reduce((sum, s) => sum + s.rating, 0) / areaShops.length).toFixed(1);
                
                html += `<div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">`;
                html += `<h3 style="color: #667eea; margin-bottom: 15px;">ğŸ—ºï¸ ${escapeHtml(area)} <span style="color: #999; font-size: 0.8em;">(${areaShops.length} Ù…Ø­Ù„ - Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${avgRating})</span></h3>`;
                html += generateUnifiedTable(areaShops);
                html += '</div>';
            });
            
            return html;
        }
        
        // Generate tables by activity
        function generateTablesByActivity(shops) {
            if (shops.length === 0) {
                return '<p style="text-align: center; padding: 40px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>';
            }
            
            // Group shops by main activity type
            const shopsByActivity = {};
            shops.forEach(shop => {
                let activityType = 'Ø£Ø®Ø±Ù‰';
                const activity = (shop.activity || '').toLowerCase();
                
                if (activity.includes('animal') || activity.includes('Ø­ÙŠÙˆØ§Ù†')) {
                    activityType = 'ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª';
                } else if (activity.includes('veterinar') || activity.includes('Ø¨ÙŠØ·Ø±')) {
                    activityType = 'Ø®Ø¯Ù…Ø§Øª Ø¨ÙŠØ·Ø±ÙŠØ©';
                } else if (activity.includes('bird') || activity.includes('Ø·ÙŠÙˆØ±')) {
                    activityType = 'ØªØ¬Ø§Ø±Ø© Ø§Ù„Ø·ÙŠÙˆØ±';
                } else if (activity.includes('pet') || activity.includes('Ø£Ù„ÙŠÙ')) {
                    activityType = 'Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø£Ù„ÙŠÙØ©';
                } else if (activity.includes('fish') || activity.includes('Ø£Ø³Ù…Ø§Ùƒ')) {
                    activityType = 'Ø£Ø³Ù…Ø§Ùƒ Ø§Ù„Ø²ÙŠÙ†Ø©';
                }
                
                if (!shopsByActivity[activityType]) {
                    shopsByActivity[activityType] = [];
                }
                shopsByActivity[activityType].push(shop);
            });
            
            let html = '';
            Object.keys(shopsByActivity).sort((a, b) => a.localeCompare(b, 'ar')).forEach(activityType => {
                const activityShops = shopsByActivity[activityType];
                const avgRating = (activityShops.reduce((sum, s) => sum + s.rating, 0) / activityShops.length).toFixed(1);
                
                html += `<div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">`;
                html += `<h3 style="color: #667eea; margin-bottom: 15px;">ğŸ’¼ ${escapeHtml(activityType)} <span style="color: #999; font-size: 0.8em;">(${activityShops.length} Ù…Ø­Ù„ - Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${avgRating})</span></h3>`;
                html += generateUnifiedTable(activityShops);
                html += '</div>';
            });
            
            return html;
        }
        
        // Show shop rating details
        function showShopRatingDetails(shopName) {
            const ratingData = calculateShopRating(shopName);
            const shop = shopsDetails[shopName];
            
            let details = `ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${shopName}\n`;
            details += `${'='.repeat(50)}\n\n`;
            details += `ğŸ“ˆ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${ratingData.rating.toFixed(0)}/100\n\n`;
            details += `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆØ±:\n`;
            details += `â€¢ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…: ${ratingData.details.compliance}/30\n`;
            details += `â€¢ Ø¢Ø®Ø± ØªÙØªÙŠØ´: ${ratingData.details.lastInspection}/25\n`;
            details += `â€¢ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªÙØªÙŠØ´: ${ratingData.details.frequency}/20\n`;
            details += `â€¢ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${ratingData.details.dataCompleteness}/15\n`;
            details += `â€¢ Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù†Ø´Ø§Ø·: ${ratingData.details.activityPriority}/10\n\n`;
            
            const lastInspection = getLastInspectionForShop(shopName);
            if (lastInspection) {
                const daysSince = Math.floor((new Date() - new Date(lastInspection.day)) / (1000 * 60 * 60 * 24));
                details += `ğŸ“… Ø¢Ø®Ø± ØªÙØªÙŠØ´: ${new Date(lastInspection.day).toLocaleDateString('ar-EG')} (Ù…Ù†Ø° ${daysSince} ÙŠÙˆÙ…)\n`;
            } else {
                details += `ğŸ“… Ø¢Ø®Ø± ØªÙØªÙŠØ´: Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙØªÙŠØ´ Ø¨Ø¹Ø¯\n`;
            }
            
            details += `ğŸ”¢ Ø¹Ø¯Ø¯ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©: ${getInspectionCountForShop(shopName)}\n`;
            
            if (shop) {
                details += `\nğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­Ù„:\n`;
                if (shop.licenseNo) details += `â€¢ Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©: ${shop.licenseNo}\n`;
                if (shop.admCode) details += `â€¢ ÙƒÙˆØ¯ ADM: ${shop.admCode}\n`;
                if (shop.address) details += `â€¢ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${shop.address}\n`;
                if (shop.contact) details += `â€¢ Ø§Ù„Ù‡Ø§ØªÙ: ${shop.contact}\n`;
            }
            
            alert(details);
        }
        
        // Export Smart Shop List
        function exportSmartShopList(format) {
            const primarySort = document.getElementById('primarySort').value;
            const areaFilter = document.getElementById('smartListAreaFilter').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            
            // Get current filtered shops
            let allShops = [];
            
            if (shopsDetails) {
                Object.entries(shopsDetails).forEach(([shopName, shopInfo]) => {
                    const area = planData?.areas?.find(a => a.name === shopInfo.address || a.id === shopInfo.areaId);
                    const ratingData = calculateShopRating(shopName);
                    
                    allShops.push({
                        name: shopInfo.nameAr || shopName,
                        nameEn: shopInfo.nameEn || '',
                        licenseNo: shopInfo.licenseNo || '',
                        admCode: shopInfo.admCode || '',
                        address: shopInfo.address || '',
                        contact: shopInfo.contact || '',
                        activity: shopInfo.activity || '',
                        area: area ? area.name : shopInfo.address || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        rating: ratingData.rating,
                        lastInspection: getLastInspectionForShop(shopName),
                        inspectionCount: getInspectionCountForShop(shopName)
                    });
                });
            }
            
            // Apply same filters
            if (areaFilter) {
                const selectedArea = planData?.areas?.find(a => a.id === areaFilter);
                if (selectedArea) {
                    allShops = allShops.filter(s => s.area === selectedArea.name);
                }
            }
            
            if (ratingFilter) {
                allShops = allShops.filter(shop => {
                    if (ratingFilter === 'excellent') return shop.rating >= 90;
                    if (ratingFilter === 'good') return shop.rating >= 70 && shop.rating < 90;
                    if (ratingFilter === 'fair') return shop.rating >= 50 && shop.rating < 70;
                    if (ratingFilter === 'poor') return shop.rating < 50;
                    return true;
                });
            }
            
            // Check if there are shops to export
            if (allShops.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }
            
            if (format === 'json') {
                try {
                    const dataStr = JSON.stringify(allShops, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `smart-shop-list-${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                    alert(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${allShops.length} Ù…Ø­Ù„ Ø¨ØµÙŠØºØ© JSON Ø¨Ù†Ø¬Ø§Ø­!`);
                } catch (error) {
                    alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± JSON: ' + error.message);
                    console.error('JSON export error:', error);
                }
            } else if (format === 'excel') {
                try {
                    // Prepare data for Excel export
                    const exportData = allShops.map((shop, index) => ({
                        'Ø§Ù„Ø±Ù‚Ù…': index + 1,
                        'Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„': shop.name,
                        'Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©': shop.nameEn,
                        'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©': shop.area,
                        'Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ': shop.licenseNo,
                        'ÙƒÙˆØ¯ ADM': shop.admCode,
                        'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†': shop.address,
                        'Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„': shop.contact,
                        'Ø§Ù„Ù†Ø´Ø§Ø·': shop.activity,
                        'Ø§Ù„ØªÙ‚ÙŠÙŠÙ…': shop.rating ? shop.rating.toFixed(1) + '%' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯',
                        'Ø¢Ø®Ø± ØªÙØªÙŠØ´': shop.lastInspection || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙØªÙŠØ´',
                        'Ø¹Ø¯Ø¯ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª': shop.inspectionCount || 0
                    }));
                    
                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    
                    // Set column widths
                    ws['!cols'] = [
                        { wch: 8 },  // Ø§Ù„Ø±Ù‚Ù…
                        { wch: 30 }, // Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„
                        { wch: 25 }, // Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
                        { wch: 20 }, // Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
                        { wch: 15 }, // Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ
                        { wch: 12 }, // ÙƒÙˆØ¯ ADM
                        { wch: 30 }, // Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                        { wch: 20 }, // Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                        { wch: 25 }, // Ø§Ù„Ù†Ø´Ø§Ø·
                        { wch: 12 }, // Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                        { wch: 18 }, // Ø¢Ø®Ø± ØªÙØªÙŠØ´
                        { wch: 15 }  // Ø¹Ø¯Ø¯ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª
                    ];
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©');
                    
                    // Generate filename with timestamp
                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ù…Ø­Ù„Ø§Øª_Ø§Ù„Ø°ÙƒÙŠØ©_${timestamp}.xlsx`;
                    
                    // Download file
                    XLSX.writeFile(wb, filename);
                    
                    alert(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${allShops.length} Ù…Ø­Ù„ Ø¥Ù„Ù‰ Excel Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ“„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù: ${filename}`);
                } catch (error) {
                    alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Excel: ' + error.message);
                    console.error('Excel export error:', error);
                }
            } else if (format === 'pdf') {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Set font for better Arabic support (using default font)
                    doc.setFont('helvetica');
                    doc.setFontSize(16);
                    
                    // Add title
                    const title = 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© - Smart Shop List';
                    doc.text(title, doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                    
                    // Add date
                    doc.setFontSize(10);
                    const dateText = `ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ${new Date().toLocaleDateString('ar-EG')} - Export Date: ${new Date().toLocaleDateString('en-US')}`;
                    doc.text(dateText, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });
                    
                    // Prepare table data
                    const tableData = allShops.map((shop, index) => [
                        index + 1,
                        shop.name,
                        shop.area,
                        shop.licenseNo || '-',
                        shop.activity || '-',
                        shop.rating ? shop.rating.toFixed(1) + '%' : '-',
                        shop.inspectionCount || 0
                    ]);
                    
                    // Add table
                    doc.autoTable({
                        startY: 30,
                        head: [['#', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ / Shop Name', 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø© / Area', 'Ø§Ù„ØªØ±Ø®ÙŠØµ / License', 'Ø§Ù„Ù†Ø´Ø§Ø· / Activity', 'Ø§Ù„ØªÙ‚ÙŠÙŠÙ… / Rating', 'Ø§Ù„ØªÙØªÙŠØ´Ø§Øª / Inspections']],
                        body: tableData,
                        styles: {
                            font: 'helvetica',
                            fontSize: 9,
                            cellPadding: 3,
                            halign: 'center'
                        },
                        headStyles: {
                            fillColor: [102, 126, 234],
                            textColor: 255,
                            fontStyle: 'bold',
                            halign: 'center'
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        margin: { top: 30, left: 10, right: 10 }
                    });
                    
                    // Add footer with statistics
                    const finalY = doc.lastAutoTable.finalY || 30;
                    doc.setFontSize(10);
                    const stats = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ù„Ø§Øª / Total Shops: ${allShops.length}`;
                    doc.text(stats, 15, finalY + 10);
                    
                    // Save PDF
                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `Smart_Shop_List_${timestamp}.pdf`;
                    doc.save(filename);
                    
                    alert(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${allShops.length} Ù…Ø­Ù„ Ø¥Ù„Ù‰ PDF Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ“„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù: ${filename}`);
                } catch (error) {
                    alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± PDF: ' + error.message);
                    console.error('PDF export error:', error);
                }
            }
        }
        
        // Print Smart Shop List
        function printSmartShopList() {
            try {
                const content = document.getElementById('smartShopListContent').innerHTML;
                
                // Check if there's content to print
                if (!content || content.trim() === '') {
                    alert('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
                    return;
                }
                
                const printWindow = window.open('', '', 'height=800,width=1000');
                
                if (!printWindow) {
                    alert('âš ï¸ ØªÙ… Ø­Ø¸Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©.');
                    return;
                }
                
                printWindow.document.write('<html><head><title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</title>');
                printWindow.document.write('<meta charset="UTF-8">');
                printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">');
                printWindow.document.write('<style>');
                printWindow.document.write('* { margin: 0; padding: 0; box-sizing: border-box; }');
                printWindow.document.write('body { font-family: "Cairo", Arial, sans-serif; direction: rtl; padding: 20px; }');
                printWindow.document.write('h1 { text-align: center; color: #667eea; margin-bottom: 10px; }');
                printWindow.document.write('p { text-align: center; color: #666; margin-bottom: 20px; }');
                printWindow.document.write('table { width: 100%; border-collapse: collapse; margin: 20px 0; }');
                printWindow.document.write('th, td { border: 1px solid #ddd; padding: 10px; text-align: right; font-size: 12px; }');
                printWindow.document.write('th { background-color: #667eea; color: white; font-weight: bold; }');
                printWindow.document.write('tr:nth-child(even) { background-color: #f8f9fa; }');
                printWindow.document.write('h3 { color: #667eea; margin-top: 30px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }');
                printWindow.document.write('.priority-high { background-color: #ffe6e6; }');
                printWindow.document.write('.rating-excellent { background-color: #d4edda; }');
                printWindow.document.write('.rating-good { background-color: #cce5ff; }');
                printWindow.document.write('.rating-fair { background-color: #fff3cd; }');
                printWindow.document.write('.rating-poor { background-color: #f8d7da; }');
                printWindow.document.write('@media print { body { padding: 10px; } }');
                printWindow.document.write('</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write('<h1>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</h1>');
                printWindow.document.write('<p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ' + new Date().toLocaleDateString('ar-EG') + ' - ' + new Date().toLocaleTimeString('ar-EG') + '</p>');
                printWindow.document.write(content);
                printWindow.document.write('<div style="margin-top: 30px; text-align: center; color: #999; font-size: 11px; border-top: 1px solid #ddd; padding-top: 10px;">');
                printWindow.document.write('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø£Ø¯Ø§Ø© Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø´Ù‡Ø±ÙŠ');
                printWindow.document.write('</div>');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                
                // Wait for content to load then print
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                }, 250);
                
            } catch (error) {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ' + error.message);
                console.error('Print error:', error);
            }
        }
        
        // =========================================================================
        // Bell Notifications Control Functions
        // =========================================================================
        
        // Open Bell Notifications Control Modal
        async function openBellNotificationsControl() {
            if (!githubToken) {
                alert('âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
                return;
            }
            
            // Show modal
            document.getElementById('bellNotificationsModal').classList.add('show');
            
            // Load notifications from plan-data.json
            await loadBellNotifications();
        }
        
        // Close Bell Notifications Control Modal
        function closeBellNotificationsControl() {
            document.getElementById('bellNotificationsModal').classList.remove('show');
        }
        
        // Load Bell Notifications from plan-data.json
        async function loadBellNotifications() {
            try {
                showBellStatusMessage('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...', 'info');
                
                // If planData is already loaded, use it
                if (planData && planData.bellNotes) {
                    console.log('Using already loaded planData');
                    displayBellNotifications();
                    loadBellSettings();
                    showBellStatusMessage('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
                    setTimeout(() => hideBellStatusMessage(), 2000);
                    return;
                }
                
                // Otherwise, fetch from server
                const response = await fetch('plan-data.json?' + new Date().getTime());
                if (!response.ok) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }
                
                const data = await response.json();
                planData = data;
                
                // Display notifications
                displayBellNotifications();
                loadBellSettings();
                
                showBellStatusMessage('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
                setTimeout(() => hideBellStatusMessage(), 2000);
            } catch (error) {
                console.error('Error loading bell notifications:', error);
                showBellStatusMessage('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: ' + error.message + '\n\nØ³ÙŠØªÙ… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰...', 'error');
                
                // Retry with current planData if available
                if (planData) {
                    setTimeout(() => {
                        displayBellNotifications();
                        loadBellSettings();
                        showBellStatusMessage('ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ âœ…', 'success');
                    }, 1000);
                }
            }
        }
        
        // Display Bell Notifications
        function displayBellNotifications() {
            const container = document.getElementById('bellNotificationsList');
            
            // Initialize bellNotes if it doesn't exist
            if (!planData.bellNotes) {
                planData.bellNotes = { notifications: [] };
            }
            
            if (!planData.bellNotes.notifications) {
                planData.bellNotes.notifications = [];
            }
            
            // Check if there are no notifications
            if (planData.bellNotes.notifications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“­</div>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯</p>
                    </div>
                `;
                return;
            }
            
            // Display notifications
            let html = '';
            planData.bellNotes.notifications.forEach((notification, index) => {
                const timestamp = notification.timestamp ? new Date(notification.timestamp).toLocaleString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                
                const author = notification.author || 'Ø¯. Ø¹Ù„ÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø§Ù„';
                const priority = notification.priority || 'medium';
                const displayDuration = notification.displayDuration || 7;
                const expiryDate = notification.expiryDate || null;
                
                // Calculate if notification is expired
                const isExpired = expiryDate && new Date(expiryDate) < new Date();
                const expiredClass = isExpired ? 'opacity: 0.5; text-decoration: line-through;' : '';
                
                // Priority icons
                const priorityIcons = {
                    high: 'ğŸ”´',
                    medium: 'ğŸŸ¡',
                    low: 'ğŸŸ¢'
                };
                
                html += `
                    <div class="notification-item priority-${priority}" style="${expiredClass}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div class="notification-text" id="bellNotifText_${index}" onclick="editBellNotification(${index})">
                                    ${notification.text}
                                </div>
                                <textarea 
                                    class="notification-edit-textarea" 
                                    id="bellNotifEdit_${index}"
                                    dir="rtl"
                                >${notification.text}</textarea>
                            </div>
                            <div style="display: flex; gap: 5px; margin-right: 10px;">
                                ${index > 0 ? `<button class="notification-action-btn notification-move-btn" onclick="moveBellNotificationUp(${index})" title="Ù†Ù‚Ù„ Ù„Ø£Ø¹Ù„Ù‰">â¬†ï¸</button>` : ''}
                                ${index < planData.bellNotes.notifications.length - 1 ? `<button class="notification-action-btn notification-move-btn" onclick="moveBellNotificationDown(${index})" title="Ù†Ù‚Ù„ Ù„Ø£Ø³ÙÙ„">â¬‡ï¸</button>` : ''}
                            </div>
                        </div>
                        
                        <div id="bellAuthorEditContainer_${index}" style="display: none; margin-top: 10px;">
                            <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 500; font-size: 0.9em;">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù/Ø§Ù„Ù…Ø±Ø³Ù„:</label>
                            <input 
                                type="text" 
                                id="bellAuthorEdit_${index}" 
                                value="${author}"
                                class="notification-author-input"
                                dir="rtl"
                            />
                        </div>
                        
                        <div id="bellSettingsContainer_${index}" style="display: none;" class="notification-settings">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label>ğŸ“Œ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:</label>
                                    <select id="bellPriorityEdit_${index}" style="width: 100%; padding: 8px; border: 2px solid #ced4da; border-radius: 8px;">
                                        <option value="high" ${priority === 'high' ? 'selected' : ''}>Ø¹Ø§Ù„ÙŠØ© ğŸ”´</option>
                                        <option value="medium" ${priority === 'medium' ? 'selected' : ''}>Ù…ØªÙˆØ³Ø·Ø© ğŸŸ¡</option>
                                        <option value="low" ${priority === 'low' ? 'selected' : ''}>Ù…Ù†Ø®ÙØ¶Ø© ğŸŸ¢</option>
                                    </select>
                                </div>
                                <div>
                                    <label>â±ï¸ Ù…Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…):</label>
                                    <input type="number" id="bellDurationEdit_${index}" value="${displayDuration}" min="1" max="365" 
                                           style="width: 100%; padding: 8px; border: 2px solid #ced4da; border-radius: 8px;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="notification-meta">
                            <span>ğŸ“… ${timestamp}</span>
                            <span>ğŸ‘¤ ${author}</span>
                            <span>${priorityIcons[priority]} ${priority === 'high' ? 'Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©' : priority === 'medium' ? 'Ø£ÙˆÙ„ÙˆÙŠØ© Ù…ØªÙˆØ³Ø·Ø©' : 'Ø£ÙˆÙ„ÙˆÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©'}</span>
                            ${isExpired ? '<span style="color: #dc3545;">â° Ù…Ù†ØªÙ‡ÙŠ</span>' : `<span>â±ï¸ ${displayDuration} Ø£ÙŠØ§Ù…</span>`}
                        </div>
                        
                        <div class="notification-actions">
                            <button class="notification-action-btn notification-save-btn" id="bellSaveBtn_${index}" onclick="saveBellNotificationEdit(${index})">
                                âœ… Ø­ÙØ¸
                            </button>
                            <button class="notification-action-btn notification-cancel-btn" id="bellCancelBtn_${index}" onclick="cancelBellNotificationEdit(${index})">
                                âŒ Ø¥Ù„ØºØ§Ø¡
                            </button>
                            <button class="notification-action-btn notification-priority-btn" onclick="toggleBellSettings(${index})">
                                âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                            </button>
                            <button class="notification-action-btn notification-delete-btn" onclick="deleteBellNotification(${index})">
                                ğŸ—‘ï¸ Ø­Ø°Ù
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Add Bell Notification
        function addBellNotification() {
            const textInput = document.getElementById('newBellNotificationText');
            const authorInput = document.getElementById('newBellNotificationAuthor');
            const priorityInput = document.getElementById('newBellNotificationPriority');
            const durationInput = document.getElementById('newBellNotificationDuration');
            
            const text = textInput.value.trim();
            const author = authorInput.value.trim();
            const priority = priorityInput.value;
            const displayDuration = parseInt(durationInput.value);
            
            if (!text) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±');
                return;
            }
            
            if (!author) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù');
                return;
            }
            
            // Initialize bellNotes if needed
            if (!planData.bellNotes) {
                planData.bellNotes = { notifications: [], settings: {} };
            }
            
            if (!planData.bellNotes.notifications) {
                planData.bellNotes.notifications = [];
            }
            
            // Calculate expiry date
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + displayDuration);
            
            // Create new notification
            const newNotification = {
                id: Date.now().toString(),
                text: text,
                timestamp: new Date().toISOString(),
                author: author,
                priority: priority,
                displayDuration: displayDuration,
                expiryDate: expiryDate.toISOString()
            };
            
            // Add to beginning of array (most recent first)
            planData.bellNotes.notifications.unshift(newNotification);
            
            // Clear inputs
            textInput.value = '';
            // Keep author for convenience
            priorityInput.value = 'medium';
            durationInput.value = '7';
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­! âœ… Ù„Ø§ ØªÙ†Ø³Ù Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª" Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'success');
        }
        
        // Edit Bell Notification
        function editBellNotification(index) {
            const textDiv = document.getElementById(`bellNotifText_${index}`);
            const editTextarea = document.getElementById(`bellNotifEdit_${index}`);
            const authorEditContainer = document.getElementById(`bellAuthorEditContainer_${index}`);
            const saveBtn = document.getElementById(`bellSaveBtn_${index}`);
            const cancelBtn = document.getElementById(`bellCancelBtn_${index}`);
            
            textDiv.style.display = 'none';
            editTextarea.style.display = 'block';
            authorEditContainer.style.display = 'block';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
            
            editTextarea.focus();
        }
        
        // Save Bell Notification Edit
        function saveBellNotificationEdit(index) {
            const textDiv = document.getElementById(`bellNotifText_${index}`);
            const editTextarea = document.getElementById(`bellNotifEdit_${index}`);
            const authorEditContainer = document.getElementById(`bellAuthorEditContainer_${index}`);
            const authorEdit = document.getElementById(`bellAuthorEdit_${index}`);
            const settingsContainer = document.getElementById(`bellSettingsContainer_${index}`);
            const priorityEdit = document.getElementById(`bellPriorityEdit_${index}`);
            const durationEdit = document.getElementById(`bellDurationEdit_${index}`);
            const saveBtn = document.getElementById(`bellSaveBtn_${index}`);
            const cancelBtn = document.getElementById(`bellCancelBtn_${index}`);
            
            const newText = editTextarea.value.trim();
            const newAuthor = authorEdit.value.trim();
            const newPriority = priorityEdit ? priorityEdit.value : (planData.bellNotes.notifications[index].priority || 'medium');
            const newDuration = durationEdit ? parseInt(durationEdit.value) : (planData.bellNotes.notifications[index].displayDuration || 7);
            
            if (!newText) {
                alert('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙØ§Ø±ØºØ§Ù‹');
                return;
            }
            
            if (!newAuthor) {
                alert('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù ÙØ§Ø±ØºØ§Ù‹');
                return;
            }
            
            // Calculate new expiry date
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + newDuration);
            
            // Update notification
            planData.bellNotes.notifications[index].text = newText;
            planData.bellNotes.notifications[index].author = newAuthor;
            planData.bellNotes.notifications[index].priority = newPriority;
            planData.bellNotes.notifications[index].displayDuration = newDuration;
            planData.bellNotes.notifications[index].expiryDate = expiryDate.toISOString();
            planData.bellNotes.notifications[index].lastModified = new Date().toISOString();
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­! âœ… Ù„Ø§ ØªÙ†Ø³Ù Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª" Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'success');
        }
        
        // Cancel Bell Notification Edit
        function cancelBellNotificationEdit(index) {
            const textDiv = document.getElementById(`bellNotifText_${index}`);
            const editTextarea = document.getElementById(`bellNotifEdit_${index}`);
            const authorEditContainer = document.getElementById(`bellAuthorEditContainer_${index}`);
            const authorEdit = document.getElementById(`bellAuthorEdit_${index}`);
            const saveBtn = document.getElementById(`bellSaveBtn_${index}`);
            const cancelBtn = document.getElementById(`bellCancelBtn_${index}`);
            
            // Reset to original values
            editTextarea.value = planData.bellNotes.notifications[index].text;
            authorEdit.value = planData.bellNotes.notifications[index].author || 'Ø¯. Ø¹Ù„ÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø§Ù„';
            
            textDiv.style.display = 'block';
            editTextarea.style.display = 'none';
            authorEditContainer.style.display = 'none';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }
        
        // Delete Bell Notification
        function deleteBellNotification(index) {
            if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©.')) {
                return;
            }
            
            // Remove notification
            planData.bellNotes.notifications.splice(index, 1);
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­! âœ… Ù„Ø§ ØªÙ†Ø³Ù Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª" Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'success');
        }
        
        // Save All Bell Notifications to GitHub
        async function saveAllBellNotifications() {
            if (!githubToken) {
                alert('âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHubØŸ\n\nØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙÙˆØ±Ø§Ù‹.')) {
                return;
            }
            
            try {
                showBellStatusMessage('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHub...', 'info');
                
                // Get current file SHA
                const getResponse = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù');
                }
                
                const fileData = await getResponse.json();
                const sha = fileData.sha;
                
                // Update lastUpdate
                planData.lastUpdate = new Date().toISOString();
                
                // Convert to JSON
                const jsonContent = JSON.stringify(planData, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(jsonContent)));
                
                // Commit to GitHub
                const updateResponse = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `ØªØ­Ø¯ÙŠØ« Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø±Ø³ - ${new Date().toLocaleString('ar-EG')}`,
                        content: encodedContent,
                        sha: sha,
                        branch: 'main'
                    })
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.message || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª');
                }
                
                showBellStatusMessage('âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!\n\nØ³ØªØ¸Ù‡Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¬Ø±Ø³ ğŸ”” Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', 'success');
                
                // Reload notifications to confirm
                setTimeout(() => {
                    loadBellNotifications();
                }, 2000);
                
            } catch (error) {
                console.error('Error saving bell notifications:', error);
                showBellStatusMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª: ' + error.message, 'error');
            }
        }
        
        // Show Bell Status Message
        function showBellStatusMessage(message, type) {
            const messageDiv = document.getElementById('bellStatusMessage');
            messageDiv.textContent = message;
            messageDiv.className = 'bell-status-message show ' + type;
        }
        
        // Hide Bell Status Message
        function hideBellStatusMessage() {
            const messageDiv = document.getElementById('bellStatusMessage');
            messageDiv.classList.remove('show');
        }
        
        // =========================================================================
        // Enhanced Bell Notification Functions
        // =========================================================================
        
        // Toggle Bell Settings
        function toggleBellSettings(index) {
            const settingsContainer = document.getElementById(`bellSettingsContainer_${index}`);
            if (settingsContainer.style.display === 'none') {
                settingsContainer.style.display = 'block';
            } else {
                settingsContainer.style.display = 'none';
            }
        }
        
        // Move Bell Notification Up
        function moveBellNotificationUp(index) {
            if (index === 0) return;
            
            // Swap with previous
            const temp = planData.bellNotes.notifications[index];
            planData.bellNotes.notifications[index] = planData.bellNotes.notifications[index - 1];
            planData.bellNotes.notifications[index - 1] = temp;
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ø£Ø¹Ù„Ù‰ â¬†ï¸ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª', 'success');
        }
        
        // Move Bell Notification Down
        function moveBellNotificationDown(index) {
            if (index >= planData.bellNotes.notifications.length - 1) return;
            
            // Swap with next
            const temp = planData.bellNotes.notifications[index];
            planData.bellNotes.notifications[index] = planData.bellNotes.notifications[index + 1];
            planData.bellNotes.notifications[index + 1] = temp;
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ø£Ø³ÙÙ„ â¬‡ï¸ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª', 'success');
        }
        
        // Sort Bell Notifications by Priority
        function sortBellNotificationsByPriority() {
            const priorityOrder = { high: 0, medium: 1, low: 2 };
            
            planData.bellNotes.notifications.sort((a, b) => {
                const priorityA = priorityOrder[a.priority || 'medium'];
                const priorityB = priorityOrder[b.priority || 'medium'];
                return priorityA - priorityB;
            });
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('ØªÙ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© ğŸ”½ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª', 'success');
        }
        
        // Sort Bell Notifications by Date
        function sortBellNotificationsByDate() {
            planData.bellNotes.notifications.sort((a, b) => {
                const dateA = new Date(a.timestamp || 0);
                const dateB = new Date(b.timestamp || 0);
                return dateB - dateA; // Most recent first
            });
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('ØªÙ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ğŸ“… Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª', 'success');
        }
        
        // Delete Expired Notifications
        function deleteExpiredNotifications() {
            const now = new Date();
            const before = planData.bellNotes.notifications.length;
            
            planData.bellNotes.notifications = planData.bellNotes.notifications.filter(notification => {
                if (!notification.expiryDate) return true;
                return new Date(notification.expiryDate) >= now;
            });
            
            const after = planData.bellNotes.notifications.length;
            const deleted = before - after;
            
            if (deleted === 0) {
                showBellStatusMessage('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù†ØªÙ‡ÙŠØ© Ù„Ù„Ø­Ø°Ù âœ…', 'success');
            } else {
                displayBellNotifications();
                showBellStatusMessage(`ØªÙ… Ø­Ø°Ù ${deleted} Ø¥Ø´Ø¹Ø§Ø± Ù…Ù†ØªÙ‡ÙŠ ğŸ—‘ï¸ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª`, 'success');
            }
        }
        
        // Load Bell Settings
        function loadBellSettings() {
            // Initialize settings if they don't exist
            if (!planData.bellNotes.settings) {
                planData.bellNotes.settings = {
                    bubbleDuration: 24,
                    soundEnabled: true,
                    displayStyle: 'modern'
                };
            }
            
            // Load settings into UI
            const bubbleDurationInput = document.getElementById('bellBubbleDuration');
            const soundEnabledSelect = document.getElementById('bellSoundEnabled');
            const displayStyleSelect = document.getElementById('bellDisplayStyle');
            
            if (bubbleDurationInput) {
                bubbleDurationInput.value = planData.bellNotes.settings.bubbleDuration || 24;
            }
            
            if (soundEnabledSelect) {
                soundEnabledSelect.value = planData.bellNotes.settings.soundEnabled !== false ? 'true' : 'false';
            }
            
            if (displayStyleSelect) {
                displayStyleSelect.value = planData.bellNotes.settings.displayStyle || 'modern';
            }
        }
        
        // Update Bell Bubble Duration
        function updateBellBubbleDuration() {
            const bubbleDurationInput = document.getElementById('bellBubbleDuration');
            const duration = parseInt(bubbleDurationInput.value);
            
            if (duration < 5 || duration > 120) {
                alert('âš ï¸ Ù…Ø¯Ø© Ø§Ù„Ø¸Ù‡ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 5 Ùˆ 120 Ø«Ø§Ù†ÙŠØ©');
                bubbleDurationInput.value = planData.bellNotes.settings.bubbleDuration || 24;
                return;
            }
            
            if (!planData.bellNotes.settings) {
                planData.bellNotes.settings = {};
            }
            
            planData.bellNotes.settings.bubbleDuration = duration;
            showBellStatusMessage(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¯Ø© Ø¸Ù‡ÙˆØ± Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø¥Ù„Ù‰ ${duration} Ø«Ø§Ù†ÙŠØ© â±ï¸ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª`, 'success');
        }
        
        // Update Bell Sound Setting
        function updateBellSoundSetting() {
            const soundEnabledSelect = document.getElementById('bellSoundEnabled');
            const soundEnabled = soundEnabledSelect.value === 'true';
            
            if (!planData.bellNotes.settings) {
                planData.bellNotes.settings = {};
            }
            
            planData.bellNotes.settings.soundEnabled = soundEnabled;
            showBellStatusMessage(`ØªÙ… ${soundEnabled ? 'ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ø·ÙŠÙ„'} ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ğŸ”” Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª`, 'success');
        }
        
        // Update Bell Display Style
        function updateBellDisplayStyle() {
            const displayStyleSelect = document.getElementById('bellDisplayStyle');
            const displayStyle = displayStyleSelect.value;
            
            if (!planData.bellNotes.settings) {
                planData.bellNotes.settings = {};
            }
            
            planData.bellNotes.settings.displayStyle = displayStyle;
            showBellStatusMessage(`ØªÙ… ØªØºÙŠÙŠØ± Ù†Ù…Ø· Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ ${displayStyle === 'modern' ? 'Ø¹ØµØ±ÙŠ' : displayStyle === 'classic' ? 'ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ' : 'Ø¨Ø³ÙŠØ·'} ğŸ¨ Ù„Ø§ ØªÙ†Ø³Ù Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª`, 'success');
        }
    </script>
    
    <!-- Hand Gesture Control Modal -->
    <div id="gestureModal" class="gesture-modal">
        <div class="gesture-modal-content">
            <span class="gesture-close" onclick="closeGestureControl()">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px; font-size: 2em;">
                âœ‹ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠ Ø¨Ø­Ø±ÙƒØ© Ø§Ù„ÙŠØ¯
            </h2>
            
            <div class="gesture-video-container">
                <video id="gestureVideo" class="gesture-video" autoplay playsinline></video>
                <canvas id="gestureCanvas" class="gesture-canvas"></canvas>
            </div>
            
            <div class="gesture-status">
                <h3>Ø§Ù„Ø­Ø§Ù„Ø©: <span id="gestureStatusText">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</span></h3>
                <div class="gesture-detected" id="gestureDetected">---</div>
                <p id="gestureAction" style="font-size: 1.2em; margin-top: 10px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡</p>
            </div>
            
            <div class="gesture-guide">
                <h3>ğŸ¯ Ø¯Ù„ÙŠÙ„ Ø­Ø±ÙƒØ§Øª Ø§Ù„ÙŠØ¯</h3>
                
                <div class="gesture-item">
                    <div class="gesture-icon">ğŸ‘‰</div>
                    <div class="gesture-description">
                        <strong>Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„ÙŠÙ…ÙŠÙ†</strong>
                        <span>Ø­Ø±Ùƒ ÙŠØ¯Ùƒ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† â†’ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ§Ù„ÙŠ</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">ğŸ‘ˆ</div>
                    <div class="gesture-description">
                        <strong>Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„ÙŠØ³Ø§Ø±</strong>
                        <span>Ø­Ø±Ùƒ ÙŠØ¯Ùƒ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± â†’ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø³Ø§Ø¨Ù‚</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">ğŸ‘†</div>
                    <div class="gesture-description">
                        <strong>Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø¹Ù„Ù‰</strong>
                        <span>Ø­Ø±Ùƒ ÙŠØ¯Ùƒ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù„Ù‰ â†’ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">ğŸ‘‡</div>
                    <div class="gesture-description">
                        <strong>Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„</strong>
                        <span>Ø­Ø±Ùƒ ÙŠØ¯Ùƒ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³ÙÙ„ â†’ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø©</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">âœ‹</div>
                    <div class="gesture-description">
                        <strong>Ø±Ø§Ø­Ø© Ø§Ù„ÙŠØ¯ Ø§Ù„Ù…ÙØªÙˆØ­Ø©</strong>
                        <span>Ø§ÙØªØ­ ÙƒÙ ÙŠØ¯Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ â†’ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù…Ø¤Ù‚ØªØ§Ù‹</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">âœŠ</div>
                    <div class="gesture-description">
                        <strong>Ù‚Ø¨Ø¶Ø© Ø§Ù„ÙŠØ¯ Ø§Ù„Ù…ØºÙ„Ù‚Ø©</strong>
                        <span>Ø£ØºÙ„Ù‚ Ù‚Ø¨Ø¶Ø© ÙŠØ¯Ùƒ â†’ Ø§Ù„Ù†Ù‚Ø± Ø£Ùˆ Ø§Ù„ØªÙØ¹ÙŠÙ„</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">â˜ï¸</div>
                    <div class="gesture-description">
                        <strong>Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¨Ø§Ù„Ø³Ø¨Ø§Ø¨Ø©</strong>
                        <span>Ø£Ø´Ø± Ø¨Ø¥ØµØ¨Ø¹ Ø§Ù„Ø³Ø¨Ø§Ø¨Ø© ÙÙ‚Ø· â†’ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¯Ù‚ÙŠÙ‚ ÙˆØ§Ù„ØªÙ†Ù‚Ù„</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">âœŒï¸</div>
                    <div class="gesture-description">
                        <strong>Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù†ØµØ± (Ø¥ØµØ¨Ø¹Ø§Ù†)</strong>
                        <span>Ø£Ø´Ø± Ø¨Ø¥ØµØ¨Ø¹ÙŠÙ† â†’ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-danger" onclick="closeGestureControl()" style="padding: 15px 40px; font-size: 1.2em;">
                    Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø­Ø±ÙƒØ© Ø§Ù„ÙŠØ¯
                </button>
            </div>
        </div>
    </div>
    
    <!-- MediaPipe Hands Library -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <!-- Hand Gesture Control Script -->
    <script>
        // Global variables for gesture control
        let gestureControlActive = false;
        let camera = null;
        let hands = null;
        let lastGestureTime = 0;
        let gestureDebounceDelay = 800; // milliseconds between gestures
        let previousHandPosition = null;
        let gestureThreshold = 0.15; // Movement threshold for gesture detection
        
        // Tab management
        const tabs = ['add', 'view', 'stats', 'calendar', 'shops', 'areas', 'maintenance'];
        let currentTabIndex = 0;
        
        // Toggle gesture control
        function toggleGestureControl() {
            const modal = document.getElementById('gestureModal');
            const btn = document.getElementById('gestureControlBtn');
            
            if (!gestureControlActive) {
                modal.style.display = 'block';
                btn.classList.add('active');
                initializeGestureControl();
            } else {
                closeGestureControl();
            }
        }
        
        // Close gesture control
        function closeGestureControl() {
            const modal = document.getElementById('gestureModal');
            const btn = document.getElementById('gestureControlBtn');
            
            modal.style.display = 'none';
            btn.classList.remove('active');
            gestureControlActive = false;
            
            // Stop camera and cleanup
            if (camera) {
                camera.stop();
                camera = null;
            }
            
            const video = document.getElementById('gestureVideo');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            updateGestureStatus('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø­Ø±ÙƒØ© Ø§Ù„ÙŠØ¯', '---', '');
        }
        
        // Initialize gesture control
        async function initializeGestureControl() {
            try {
                gestureControlActive = true;
                updateGestureStatus('Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...', 'â³', '');
                
                // Initialize MediaPipe Hands
                hands = new Hands({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    }
                });
                
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.7,
                    minTrackingConfidence: 0.7
                });
                
                hands.onResults(onHandsResults);
                
                // Setup camera
                const video = document.getElementById('gestureVideo');
                
                updateGestureStatus('Ø¬Ø§Ø±Ù ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...', 'ğŸ“¹', '');
                
                camera = new Camera(video, {
                    onFrame: async () => {
                        if (gestureControlActive) {
                            await hands.send({image: video});
                        }
                    },
                    width: 640,
                    height: 480
                });
                
                await camera.start();
                
                updateGestureStatus('Ø¬Ø§Ù‡Ø²! Ø­Ø±Ùƒ ÙŠØ¯Ùƒ Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'âœ…', '');
                
            } catch (error) {
                console.error('Error initializing gesture control:', error);
                updateGestureStatus('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'âŒ', 'ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
                
                // Show alert
                alert('ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰:\n1. Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§\n2. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø¢Ø®Ø±\n3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ¯Ø¹Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©');
                
                closeGestureControl();
            }
        }
        
        // Process hand detection results
        function onHandsResults(results) {
            const canvas = document.getElementById('gestureCanvas');
            const canvasCtx = canvas.getContext('2d');
            
            // Set canvas size to match video
            canvas.width = results.image.width;
            canvas.height = results.image.height;
            
            // Clear canvas
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw hand landmarks
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                for (const landmarks of results.multiHandLandmarks) {
                    // Draw connections
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {
                        color: '#00FF00',
                        lineWidth: 3
                    });
                    
                    // Draw landmarks
                    drawLandmarks(canvasCtx, landmarks, {
                        color: '#FF0000',
                        lineWidth: 1,
                        radius: 4
                    });
                }
                
                // Detect gesture
                detectGesture(results.multiHandLandmarks[0]);
            } else {
                updateGestureStatus('Ø¬Ø§Ù‡Ø²! Ø­Ø±Ùƒ ÙŠØ¯Ùƒ Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'âœ‹', '');
                previousHandPosition = null;
            }
        }
        
        // Detect and process gestures
        function detectGesture(landmarks) {
            const now = Date.now();
            
            // Debounce gestures
            if (now - lastGestureTime < gestureDebounceDelay) {
                return;
            }
            
            // Get key landmarks
            const wrist = landmarks[0];
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const thumbTip = landmarks[4];
            const pinkyTip = landmarks[20];
            
            // Calculate hand center (wrist position)
            const currentPosition = {
                x: wrist.x,
                y: wrist.y,
                z: wrist.z
            };
            
            // Detect gestures based on movement and hand shape
            if (previousHandPosition) {
                const deltaX = currentPosition.x - previousHandPosition.x;
                const deltaY = currentPosition.y - previousHandPosition.y;
                
                // Swipe Right (Hand moves right)
                if (deltaX > gestureThreshold) {
                    executeGesture('swipe-right', 'Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„ÙŠÙ…ÙŠÙ† ğŸ‘‰', 'Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ§Ù„ÙŠ');
                    lastGestureTime = now;
                }
                // Swipe Left (Hand moves left)
                else if (deltaX < -gestureThreshold) {
                    executeGesture('swipe-left', 'Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„ÙŠØ³Ø§Ø± ğŸ‘ˆ', 'Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø³Ø§Ø¨Ù‚');
                    lastGestureTime = now;
                }
                // Swipe Up (Hand moves up)
                else if (deltaY < -gestureThreshold) {
                    executeGesture('swipe-up', 'Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø¹Ù„Ù‰ ğŸ‘†', 'Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©');
                    lastGestureTime = now;
                }
                // Swipe Down (Hand moves down)
                else if (deltaY > gestureThreshold) {
                    executeGesture('swipe-down', 'Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„ ğŸ‘‡', 'Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø©');
                    lastGestureTime = now;
                }
            }
            
            // Detect hand shapes
            const fingersExtended = countExtendedFingers(landmarks);
            
            // Open palm (all 5 fingers extended)
            if (fingersExtended === 5) {
                if (now - lastGestureTime > gestureDebounceDelay * 2) {
                    updateGestureStatus('Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­ÙƒÙ…', 'Ø±Ø§Ø­Ø© Ø§Ù„ÙŠØ¯ Ø§Ù„Ù…ÙØªÙˆØ­Ø© âœ‹', 'Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø­Ø±ÙƒØ©');
                }
            }
            // Closed fist (no fingers extended)
            else if (fingersExtended === 0) {
                executeGesture('fist', 'Ù‚Ø¨Ø¶Ø© Ø§Ù„ÙŠØ¯ âœŠ', 'Ø§Ù„Ù†Ù‚Ø±/Ø§Ù„ØªÙØ¹ÙŠÙ„');
                lastGestureTime = now;
            }
            // Index finger pointing (only index extended)
            else if (fingersExtended === 1 && isFingerExtended(landmarks, 8)) {
                if (now - lastGestureTime > gestureDebounceDelay * 2) {
                    updateGestureStatus('ØªØ­ÙƒÙ… Ø¯Ù‚ÙŠÙ‚', 'Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¨Ø§Ù„Ø³Ø¨Ø§Ø¨Ø© â˜ï¸', 'Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¯Ù‚ÙŠÙ‚');
                }
            }
            // Peace sign (index and middle extended)
            else if (fingersExtended === 2 && isFingerExtended(landmarks, 8) && isFingerExtended(landmarks, 12)) {
                executeGesture('peace', 'Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù†ØµØ± âœŒï¸', 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
                lastGestureTime = now;
            }
            
            // Update previous position
            previousHandPosition = currentPosition;
        }
        
        // Count extended fingers
        function countExtendedFingers(landmarks) {
            let count = 0;
            
            // Thumb (different calculation)
            if (landmarks[4].x < landmarks[3].x) count++;
            
            // Other fingers (8, 12, 16, 20 are tips; 6, 10, 14, 18 are middle joints)
            const fingerIndices = [
                [8, 6],   // Index
                [12, 10], // Middle
                [16, 14], // Ring
                [20, 18]  // Pinky
            ];
            
            for (const [tip, middle] of fingerIndices) {
                if (landmarks[tip].y < landmarks[middle].y) {
                    count++;
                }
            }
            
            return count;
        }
        
        // Check if specific finger is extended
        function isFingerExtended(landmarks, tipIndex) {
            const middleIndex = tipIndex - 2;
            return landmarks[tipIndex].y < landmarks[middleIndex].y;
        }
        
        // Execute gesture action
        function executeGesture(gestureType, gestureName, actionDescription) {
            updateGestureStatus('ØªÙ… Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ø­Ø±ÙƒØ©!', gestureName, actionDescription);
            
            // Perform action based on gesture
            switch(gestureType) {
                case 'swipe-right':
                    navigateToNextTab();
                    break;
                case 'swipe-left':
                    navigateToPreviousTab();
                    break;
                case 'swipe-up':
                    scrollPage(-300);
                    break;
                case 'swipe-down':
                    scrollPage(300);
                    break;
                case 'fist':
                    // Simulate click action
                    playClickSound();
                    break;
                case 'peace':
                    navigateToHome();
                    break;
            }
        }
        
        // Navigate to next tab
        function navigateToNextTab() {
            currentTabIndex = (currentTabIndex + 1) % tabs.length;
            switchTab(tabs[currentTabIndex]);
            playClickSound();
        }
        
        // Navigate to previous tab
        function navigateToPreviousTab() {
            currentTabIndex = (currentTabIndex - 1 + tabs.length) % tabs.length;
            switchTab(tabs[currentTabIndex]);
            playClickSound();
        }
        
        // Scroll page
        function scrollPage(amount) {
            window.scrollBy({
                top: amount,
                behavior: 'smooth'
            });
        }
        
        // Navigate to home
        function navigateToHome() {
            window.location.href = 'index.html';
        }
        
        // Play click sound (if available)
        function playClickSound() {
            try {
                const audio = new Audio();
                audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFA==';
                audio.volume = 0.3;
                audio.play().catch(() => {});
            } catch (error) {
                // Ignore audio errors
            }
        }
        
        // Update gesture status display
        function updateGestureStatus(status, gesture, action) {
            document.getElementById('gestureStatusText').textContent = status;
            document.getElementById('gestureDetected').textContent = gesture;
            document.getElementById('gestureAction').textContent = action;
        }
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('gestureModal');
            if (event.target === modal) {
                closeGestureControl();
            }
        });
        
        // Find current tab index on page load
        function updateCurrentTabIndex() {
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab) {
                const tabText = activeTab.textContent;
                if (tabText.includes('Ø¥Ø¶Ø§ÙØ©')) currentTabIndex = 0;
                else if (tabText.includes('Ø¹Ø±Ø¶')) currentTabIndex = 1;
                else if (tabText.includes('Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª')) currentTabIndex = 2;
                else if (tabText.includes('Ø§Ù„ØªÙ‚ÙˆÙŠÙ…')) currentTabIndex = 3;
                else if (tabText.includes('Ø§Ù„Ù…Ø­Ù„Ø§Øª')) currentTabIndex = 4;
                else if (tabText.includes('Ø§Ù„Ù…Ù†Ø§Ø·Ù‚')) currentTabIndex = 5;
                else if (tabText.includes('Ø§Ù„ØµÙŠØ§Ù†Ø©')) currentTabIndex = 6;
            }
        }
        
        // Update tab index when tabs are switched
        const originalSwitchTab = window.switchTab;
        if (originalSwitchTab) {
            window.switchTab = function(tabName) {
                originalSwitchTab(tabName);
                const tabIndex = tabs.indexOf(tabName);
                if (tabIndex >= 0) {
                    currentTabIndex = tabIndex;
                }
            };
        }
    </script>
</body>
</html>
