<!DOCTYPE html>
<!-- Version 2.0.0 - Group Inspection Report with Visit Report Layout -->
<!-- Last Updated: 2025-11-21 -->
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø¬Ù…Ø§Ø¹Ù‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    
    <!-- Cache Prevention -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            direction: rtl;
            overflow-x: hidden;
        }
        
        .inspection-fullscreen-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            overflow-y: auto;
            overflow-x: hidden;
            direction: rtl;
        }
        
        .inspection-header {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .return-home-btn {
            position: absolute;
            top: 50%;
            left: 30px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            z-index: 101; /* Ensure button is above header content */
        }
        
        .return-home-btn:hover {
            background: white;
            color: #ff9800;
            transform: translateY(-50%) scale(1.05);
        }
        
        .inspection-title {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .inspection-subtitle {
            font-size: 1.2em;
            margin: 0;
            opacity: 0.9;
        }
        
        .inspection-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 30px;
        }
        
        .details-card,
        .form-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .details-card:hover,
        .form-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .section-header {
            color: #ff9800;
            font-size: 1.8em;
            margin: 0 0 25px 0;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 3px solid #ff9800;
            padding-bottom: 15px;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 15px;
        }
        
        .details-grid > div {
            font-size: 1.1em;
        }
        
        .details-grid strong {
            color: #e65100;
            font-weight: 700;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: #333;
            font-size: 1.1em;
        }
        
        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1em;
            font-family: inherit;
            transition: all 0.3s ease;
            background: #f9f9f9;
        }
        
        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #ff9800;
            background: white;
            box-shadow: 0 0 0 4px rgba(255, 152, 0, 0.1);
        }
        
        .form-input[readonly] {
            background: #f5f5f5;
            cursor: not-allowed;
        }
        
        .password-toggle-btn {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.3em;
            padding: 5px;
            transition: transform 0.2s ease;
        }
        
        .password-toggle-btn:hover {
            transform: translateY(-50%) scale(1.2);
        }
        
        .verify-password-btn {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }
        
        .verify-password-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }
        
        .password-status-success {
            padding: 15px;
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
        }
        
        .password-status-error {
            padding: 15px;
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
        }
        
        .checklist-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        
        .checklist-item-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .checklist-item-card:hover {
            border-color: #ff9800;
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.2);
        }
        
        .checklist-item-header {
            font-weight: 700;
            color: #e65100;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 10px 12px;
            border-radius: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .radio-option:hover {
            border-color: #ff9800;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-left: 8px;
            cursor: pointer;
        }
        
        .radio-option input[type="radio"]:checked + .radio-label {
            font-weight: 700;
        }
        
        .radio-label {
            cursor: pointer;
            font-size: 1em;
        }
        
        .radio-label.fulfilled {
            color: #28a745;
        }
        
        .radio-label.unfulfilled {
            color: #dc3545;
        }
        
        .radio-label.not-inspected {
            color: #ff9800;
        }
        
        .radio-label.not-applicable {
            color: #6c757d;
        }
        
        .capture-photo-btn {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
        }
        
        .capture-photo-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(255, 152, 0, 0.4);
        }
        
        .photos-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .photos-preview-grid > div {
            position: relative;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .photos-preview-grid img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .photo-hint {
            margin-top: 15px;
            padding: 12px;
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            border-radius: 8px;
            color: #e65100;
            font-size: 0.95em;
        }
        
        .submit-section {
            margin-top: 30px;
            text-align: center;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 20px 60px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.4em;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        
        @media (max-width: 768px) {
            .inspection-header {
                padding: 20px 15px;
            }
            
            .return-home-btn {
                position: static;
                transform: none;
                margin-bottom: 15px;
                display: block;
                width: fit-content;
                margin-left: auto;
                margin-right: auto;
            }
            
            .inspection-title {
                font-size: 1.8em;
            }
            
            .inspection-subtitle {
                font-size: 1em;
            }
            
            .inspection-content {
                padding: 20px 15px;
                /* Add extra bottom padding to ensure save button is visible on mobile
                   120px provides adequate space below content for:
                   - Submit button and section (approx. 100px with padding/margins)
                   - Mobile browser UI elements and safe scrolling area */
                padding-bottom: 120px;
            }
            
            .details-card,
            .form-card {
                padding: 20px;
            }
            
            .section-header {
                font-size: 1.4em;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .checklist-container {
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                grid-template-columns: 1fr 1fr;
            }
            
            /* Ensure submit section is visible and accessible on mobile */
            .submit-section {
                margin-top: 40px;
                margin-bottom: 40px;
                padding: 20px;
            }
            
            .submit-btn {
                width: 100%;
                padding: 18px 30px;
                font-size: 1.3em;
                /* Ensure button appears above other elements and is easily accessible */
                position: relative;
                z-index: 50;
            }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #f5f7fa 0%, #e3f2fd 100%);
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #2196f3;
            gap: 15px; /* Add gap between items to prevent overlap */
        }
        
        .modal-close-btn {
            background: transparent;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #666;
            transition: color 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0; /* Prevent button from shrinking */
            margin-inline-start: 10px; /* Add spacing from title (RTL-compatible) */
        }
        
        .modal-close-btn:hover {
            color: #d32f2f;
            background: rgba(211, 47, 47, 0.1);
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .modal-footer {
            padding: 20px 30px;
            border-top: 2px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .modal-btn-cancel {
            background: #e0e0e0;
            color: #666;
        }
        
        .modal-btn-cancel:hover {
            background: #d0d0d0;
        }
        
        .modal-btn-confirm {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .modal-btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        

        /* Actions list */
        .actions-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .action-option {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-option:hover {
            background: #fff;
            border-color: #2196f3;
            transform: translateX(-5px);
        }
        
        .action-option input[type="radio"] {
            width: 22px;
            height: 22px;
            margin-left: 15px;
            cursor: pointer;
        }
        
        .action-label {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }
        
        .action-option input[type="radio"]:checked + .action-label {
            color: #2196f3;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-width: calc(100vw - 20px); /* Ensure modal never exceeds viewport (10px margin each side) */
                max-height: 95vh;
                margin: 10px;
            }
            
            .modal-header {
                padding: 15px;
                flex-wrap: nowrap; /* Prevent wrapping */
            }
            
            .modal-header h2 {
                font-size: 1.2em;
                flex: 1;
                min-width: 0; /* Allow flex item to shrink below content size */
            }
            
            .modal-close-btn {
                font-size: 1.8em;
                width: 36px;
                height: 36px;
                min-width: 36px; /* Ensure button never shrinks below this size */
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .modal-footer {
                padding: 15px 20px;
                flex-direction: column;
            }
            
            .modal-btn {
                width: 100%;
            }
        }
        
        /* Developer Controls Styles */
        .developer-controls {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .developer-btn {
            background: white;
            color: #667eea;
            border: 2px solid white;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .developer-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .subitem-manager {
            margin-top: 20px;
        }
        
        .subitem-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .subitem-actions {
            display: flex;
            gap: 10px;
        }
        
        .subitem-actions button {
            padding: 6px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .edit-btn {
            background: #ff9800;
            color: white;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        
        .edit-btn:hover, .delete-btn:hover {
            transform: scale(1.05);
        }
    </style>
    
    <!-- PptxGenJS Library for PowerPoint Generation -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    
</head>
<body>
    <div class="inspection-fullscreen-container">
        <!-- Header with Return Button -->
        <div class="inspection-header">
            <a href="index.html" class="return-home-btn">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <h1 class="inspection-title">ğŸ“ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø¬Ù…Ø§Ø¹Ù‰</h1>
            <p class="inspection-subtitle">Group Inspection Report</p>
        </div>
        
        <!-- Scrollable Content -->
        <div class="inspection-content">
            <!-- Inspection Details Card -->
            <div class="details-card">
                <h3 class="section-header">ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø©</h3>
                <div id="inspectionDetailsGrid" class="details-grid">
                    <!-- Will be filled dynamically -->
                </div>
            </div>
            
            <!-- Inspector Authentication Card -->
            <div class="form-card">
                <h3 class="section-header">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙØªØ´</h3>
                <p style="margin-bottom: 20px; color: #666; font-size: 1em;">
                    ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø­Ø¯ Ø§Ù„Ù…ÙØªØ´ÙŠÙ† Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆØ¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡
                </p>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´</label>
                        <select id="inspectorSelect" class="form-select">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´ --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <div style="position: relative;">
                            <input type="password" id="inspectorPassword" class="form-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ">
                            <button onclick="togglePasswordVisibility()" class="password-toggle-btn" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">ğŸ‘ï¸</button>
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; gap: 15px; flex-wrap: wrap;">
                    <button onclick="verifyPassword()" class="verify-password-btn">
                        âœ… Ø¯Ø®ÙˆÙ„
                    </button>
                </div>
                <div id="passwordVerificationStatus" style="margin-top: 15px; display: none;"></div>
            </div>
            
            <!-- Developer Controls for Sub-items Management -->
            <div class="developer-controls" id="developerControls" style="display: none;">
                <h3 style="color: white; margin-bottom: 15px; font-size: 1.5em;">ğŸ”§ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ±Ø¹ÙŠØ© (Ù„Ù„Ù…Ø·ÙˆØ± ÙÙ‚Ø·)</h3>
                <button onclick="openSubItemsManager()" class="developer-btn">
                    ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„ÙØ±Ø¹ÙŠØ©
                </button>
                <button onclick="openGitHubSettings()" class="developer-btn">
                    ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub
                </button>
                <button onclick="testGitHubConnectionManual()" class="developer-btn">
                    ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub
                </button>
                <button onclick="toggleDeveloperMode()" class="developer-btn">
                    ğŸ”’ Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø·ÙˆØ±
                </button>
            </div>
            
            <!-- Detailed Inspection Checklist -->
            <div class="form-card">
                <h3 class="section-header">âœ… Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h3>
                <div class="checklist-container" id="checklistContainer">
                    <!-- Checklist items will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Additional Notes -->
            <div class="form-card">
                <h3 class="section-header">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h3>
                <div class="form-group">
                    <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©</label>
                    <textarea id="generalNotes" class="form-textarea" rows="4" placeholder="Ø£Ø¶Ù Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ØµÙˆØ¯Ø©</label>
                    <textarea id="violations" class="form-textarea" rows="3" placeholder="Ù‚Ù… Ø¨Ø¥Ø¯Ø±Ø§Ø¬ Ø£ÙŠ Ù…Ø®Ø§Ù„ÙØ§Øª ØªÙ… Ø±ØµØ¯Ù‡Ø§..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙˆØ¹ÙŠØ©</label>
                    <textarea id="awarenessItems" class="form-textarea" rows="3" placeholder="Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙˆØ¹ÙŠØ© Ø§Ù„ØªÙŠ ØªÙ… ØªÙ‚Ø¯ÙŠÙ…Ù‡Ø§..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©</label>
                    <textarea id="actionsTaken" class="form-textarea" rows="3" placeholder="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø§ØªØ®Ø§Ø°Ù‡Ø§..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„ØªÙˆØµÙŠØ§Øª</label>
                    <textarea id="recommendations" class="form-textarea" rows="3" placeholder="Ø§Ù„ØªÙˆØµÙŠØ§Øª ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©..."></textarea>
                </div>
            </div>
            
            <!-- Photo Capture Section -->
            <div class="form-card">
                <h3 class="section-header">ğŸ“· ØµÙˆØ± Ø§Ù„ØªÙØªÙŠØ´</h3>
                <button onclick="capturePhoto()" class="capture-photo-btn">
                    <span style="font-size: 1.5em;">ğŸ“¸</span>
                    <span>Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</span>
                </button>
                <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoCapture(event)" multiple>
                
                <div id="photosPreview" class="photos-preview-grid">
                    <!-- Photos will be displayed here -->
                </div>
                
                <div class="photo-hint">
                    ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙ‚Ø§Ø· Ø¹Ø¯Ø© ØµÙˆØ± Ù„Ù„ØªÙØªÙŠØ´
                </div>
            </div>
            
            <!-- Submit Section -->
            <div class="submit-section">
                <button onclick="submitInspectionReport()" class="submit-btn">
                    ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                </button>
                
                <button onclick="exportGroupInspectionToPowerPoint()" class="submit-btn" style="background: linear-gradient(135deg, #fd7e14 0%, #e8590c 100%); margin-top: 15px;">
                    ğŸ“½ï¸ Ø­ÙØ¸ PowerPoint
                </button>
                
                <button onclick="downloadReportAsFile()" class="submit-btn" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); margin-top: 15px; display: none;">
                    ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ…Ù„Ù Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                </button>
            </div>
        </div>
    </div>
    
    <!-- Unfulfilled Items Modal -->
    <div id="unfulfilledItemsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; color: #d32f2f;">âŒ Ø§Ù„Ø¨Ù†ÙˆØ¯ ØºÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆÙÙŠØ©</h2>
                <button class="modal-close-btn" onclick="closeUnfulfilledItemsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666;">ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ±Ø¹ÙŠØ© ØºÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆÙÙŠØ©:</p>
                
                <!-- Manual text entry -->
                <div style="margin-top: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                        Ø£Ø¶Ù Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ±Ø¹ÙŠØ© ØºÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆÙÙŠØ©:
                    </label>
                    <textarea 
                        id="manualUnfulfilledItems" 
                        style="width: 100%; min-height: 150px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 1em; resize: vertical;"
                        placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ù†ÙˆØ¯ ØºÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆÙÙŠØ© Ù‡Ù†Ø§ (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø¨Ù†Ø¯)..."
                    ></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="cancelUnfulfilledItems()">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmUnfulfilledItems()">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>
    
    <!-- Actions Modal -->
    <div id="actionsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; color: #f57c00;">âš–ï¸ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°</h2>
                <button class="modal-close-btn" onclick="closeActionsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666;">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨:</p>
                
                <div class="actions-list">
                    <label class="action-option">
                        <input type="radio" name="actionType" value="ØªÙˆØ¹ÙŠØ©">
                        <span class="action-label">ğŸ”µ ØªÙˆØ¹ÙŠØ©</span>
                    </label>
                    <label class="action-option">
                        <input type="radio" name="actionType" value="Ø¥Ù†Ø°Ø§Ø±">
                        <span class="action-label">ğŸŸ¡ Ø¥Ù†Ø°Ø§Ø±</span>
                    </label>
                    <label class="action-option">
                        <input type="radio" name="actionType" value="Ø¥Ø®Ø·Ø§Ø±">
                        <span class="action-label">ğŸŸ  Ø¥Ø®Ø·Ø§Ø±</span>
                    </label>
                    <label class="action-option">
                        <input type="radio" name="actionType" value="Ù…Ø®Ø§Ù„ÙØ©">
                        <span class="action-label">ğŸ”´ Ù…Ø®Ø§Ù„ÙØ©</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="cancelAction()">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmAction()">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>
    
    <!-- Deadline Modal (shown when Ø¥Ù†Ø°Ø§Ø± is selected) -->
    <div id="deadlineModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; color: #ff9800;">ğŸ“… Ù…Ù‡Ù„Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h2>
                <button class="modal-close-btn" onclick="closeDeadlineModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666;">ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©:</p>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                        ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù„Ø©:
                    </label>
                    <input 
                        type="date" 
                        id="deadlineDate" 
                        style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 1em;"
                    >
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                        Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
                    </label>
                    <textarea 
                        id="deadlineNotes" 
                        style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 1em; resize: vertical;"
                        placeholder="Ø£Ø¶Ù Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø§Ù„Ù…Ù‡Ù„Ø©..."
                    ></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="cancelDeadline()">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmDeadline()">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>
    
    <!-- Sub-items Manager Modal -->
    <div id="subItemsManagerModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 style="margin: 0; color: #667eea;">ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„ÙØ±Ø¹ÙŠØ©</h2>
                <button class="modal-close-btn" onclick="closeSubItemsManager()">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                        Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ:
                    </label>
                    <select id="mainItemSelect" onchange="loadSubItemsForEditing()" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø¯ --</option>
                    </select>
                </div>
                
                <div id="subItemsEditor" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #667eea;">Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h4>
                        <div id="currentSubItems" class="subitem-manager">
                            <!-- Current sub-items will be listed here -->
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 15px;">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ ÙØ±Ø¹ÙŠ Ø¬Ø¯ÙŠØ¯:</h4>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input 
                                type="text" 
                                id="newSubItemInput" 
                                placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„ÙØ±Ø¹ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯..."
                                style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;"
                            >
                            <button onclick="addNewSubItem()" style="padding: 12px 25px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                â• Ø¥Ø¶Ø§ÙØ©
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeSubItemsManager()">Ø¥ØºÙ„Ø§Ù‚</button>
                <button class="modal-btn modal-btn-confirm" onclick="saveSubItemsToGitHub()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Sub-item Modal -->
    <div id="editSubItemModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; color: #ff9800;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„ÙØ±Ø¹ÙŠ</h2>
                <button class="modal-close-btn" onclick="closeEditSubItemModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                    Ù†Øµ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„ÙØ±Ø¹ÙŠ:
                </label>
                <input 
                    type="text" 
                    id="editSubItemInput" 
                    style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;"
                >
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeEditSubItemModal()">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmEditSubItem()">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>
    
    <!-- GitHub Settings Modal -->
    <div id="githubSettingsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; color: #667eea;">ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub</h2>
                <button class="modal-close-btn" onclick="closeGitHubSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666;">
                    Ù‚Ù… Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø´Ø®ØµÙŠ (Personal Access Token) Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ GitHub Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.
                </p>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                        Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø´Ø®ØµÙŠ (GitHub Token):
                    </label>
                    <input 
                        type="password" 
                        id="githubTokenInput" 
                        placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                        style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;"
                    >
                    <small style="display: block; margin-top: 8px; color: #666;">
                        ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² ÙˆØµÙˆÙ„ Ù…Ù† GitHub Settings > Developer settings > Personal access tokens
                    </small>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="showGitHubToken" onchange="toggleGitHubTokenVisibility()">
                        <span>Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ù…Ø²</span>
                    </label>
                </div>
                
                <div id="githubConnectionStatus" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 15px;"></div>
                
                <div style="padding: 15px; background: #f8f9fa; border-radius: 10px; border-right: 4px solid #667eea;">
                    <h4 style="margin: 0 0 10px 0; color: #667eea;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø§Ù…Ø©:</h4>
                    <ul style="margin: 0; padding-right: 20px; color: #666;">
                        <li>ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ù„Ø±Ù…Ø² ØµÙ„Ø§Ø­ÙŠØ© <code>repo</code> ÙƒØ§Ù…Ù„Ø©</li>
                        <li>Ù„Ù† ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¥Ù„Ù‰ Ø£ÙŠ Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠ</li>
                        <li>Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ù…Ø² Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ Ù…ØªØµÙØ­Ùƒ ÙÙ‚Ø·</li>
                        <li>ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø§Ù„Ø±Ù…Ø² ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="clearGitHubToken()">Ø­Ø°Ù Ø§Ù„Ø±Ù…Ø²</button>
                <button class="modal-btn modal-btn-confirm" onclick="saveGitHubToken()">Ø­ÙØ¸ ÙˆØ§Ø®ØªØ¨Ø§Ø±</button>
            </div>
        </div>
    </div>
    
    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const inspectors = urlParams.get('inspectors') ? decodeURIComponent(urlParams.get('inspectors')).split(',') : [];
        const date = urlParams.get('date') || '';
        const shift = urlParams.get('shift') || '';
        const area = urlParams.get('area') || '';
        const shops = urlParams.get('shops') ? decodeURIComponent(urlParams.get('shops')).split(',') : [];
        
        // Inspection checklist items based on requirements
        const checklistItems = [
            { id: 'item_1', label: 'Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´Ø¢Øª ØºÙŠØ± Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© Ø§Ù„Ø®Ø§Ø¶Ø¹Ø© Ù„Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ©' },
            { id: 'item_2', label: 'Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´Ø¢Øª Ø§Ù„Ø®Ø§Ø¶Ø¹Ø© Ù„Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠØ©' },
            { id: 'item_3', label: 'Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ù…Ù†Ø´Ø¢Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ø£Ù„ÙŠÙØ©' },
            { id: 'item_4', label: 'Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª' }
        ];
        
        // Storage for inspection photos
        let inspectionPhotos = [];
        
        // Storage for unfulfilled items and actions
        let unfulfilledItemsData = {};
        
        // Storage for inspection sub-items
        let inspectionSubItems = {};
        
        // Load inspection sub-items from JSON file
        async function loadInspectionSubItems() {
            try {
                const response = await fetch('inspection-subitems.json');
                if (response.ok) {
                    inspectionSubItems = await response.json();
                } else {
                    console.warn('Could not load inspection sub-items, using defaults');
                    // Fallback to default sub-items
                    inspectionSubItems = {
                        "item_1": {
                            "name": "Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´Ø¢Øª ØºÙŠØ± Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© Ø§Ù„Ø®Ø§Ø¶Ø¹Ø© Ù„Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ©",
                            "subitems": ["Ù†Ø¸Ø§ÙØ© Ø§Ù„Ù…Ù†Ø´Ø£Ø©", "Ø§Ù„ØªÙ‡ÙˆÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©", "Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© Ø§Ù„ÙƒØ§ÙÙŠØ©", "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙØ§ÙŠØ§Øª", "Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªØµØ§Ø±ÙŠØ­"]
                        },
                        "item_2": {
                            "name": "Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´Ø¢Øª Ø§Ù„Ø®Ø§Ø¶Ø¹Ø© Ù„Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠØ©",
                            "subitems": ["Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠØ©", "Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„ØªØ¹Ù‚ÙŠÙ…", "Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©", "ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠØ©", "Ø§Ù„ÙƒÙˆØ§Ø¯Ø± Ø§Ù„Ù…Ø¤Ù‡Ù„Ø©"]
                        },
                        "item_3": {
                            "name": "Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ù…Ù†Ø´Ø¢Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ø£Ù„ÙŠÙØ©",
                            "subitems": ["Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù‚ÙØ§Øµ ÙˆØ§Ù„Ø­Ø¸Ø§Ø¦Ø±", "ØªÙˆÙØ± Ø§Ù„Ù…ÙŠØ§Ù‡ Ø§Ù„Ù†Ø¸ÙŠÙØ©", "Ø¬ÙˆØ¯Ø© Ø§Ù„Ø£Ø¹Ù„Ø§Ù ÙˆØ§Ù„Ø·Ø¹Ø§Ù…", "Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© Ù„Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª", "Ø§Ù„Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©"]
                        },
                        "item_4": {
                            "name": "Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª",
                            "subitems": ["Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©", "Ø§Ù„ØªØ·Ø¹ÙŠÙ…Ø§Øª ÙˆØ§Ù„ÙˆØ«Ø§Ø¦Ù‚", "Ø¹Ù„Ø§Ù…Ø§Øª Ø³ÙˆØ¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©", "Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø·Ø¨ÙŠØ©", "Ø¸Ø±ÙˆÙ Ø§Ù„Ù…Ø¹ÙŠØ´Ø©"]
                        }
                    };
                }
            } catch (error) {
                console.error('Error loading inspection sub-items:', error);
                // Use default fallback
                inspectionSubItems = {
                    "item_1": {
                        "name": "Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´Ø¢Øª ØºÙŠØ± Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© Ø§Ù„Ø®Ø§Ø¶Ø¹Ø© Ù„Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ©",
                        "subitems": ["Ù†Ø¸Ø§ÙØ© Ø§Ù„Ù…Ù†Ø´Ø£Ø©", "Ø§Ù„ØªÙ‡ÙˆÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©", "Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© Ø§Ù„ÙƒØ§ÙÙŠØ©", "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙØ§ÙŠØ§Øª", "Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ ÙˆØ§Ù„ØªØµØ§Ø±ÙŠØ­"]
                    },
                    "item_2": {
                        "name": "Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´Ø¢Øª Ø§Ù„Ø®Ø§Ø¶Ø¹Ø© Ù„Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠØ©",
                        "subitems": ["Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠØ©", "Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙˆØ§Ù„ØªØ¹Ù‚ÙŠÙ…", "Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©", "ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠØ©", "Ø§Ù„ÙƒÙˆØ§Ø¯Ø± Ø§Ù„Ù…Ø¤Ù‡Ù„Ø©"]
                    },
                    "item_3": {
                        "name": "Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ù…Ù†Ø´Ø¢Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ø£Ù„ÙŠÙØ©",
                        "subitems": ["Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù‚ÙØ§Øµ ÙˆØ§Ù„Ø­Ø¸Ø§Ø¦Ø±", "ØªÙˆÙØ± Ø§Ù„Ù…ÙŠØ§Ù‡ Ø§Ù„Ù†Ø¸ÙŠÙØ©", "Ø¬ÙˆØ¯Ø© Ø§Ù„Ø£Ø¹Ù„Ø§Ù ÙˆØ§Ù„Ø·Ø¹Ø§Ù…", "Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© Ù„Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª", "Ø§Ù„Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©"]
                    },
                    "item_4": {
                        "name": "Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª",
                        "subitems": ["Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©", "Ø§Ù„ØªØ·Ø¹ÙŠÙ…Ø§Øª ÙˆØ§Ù„ÙˆØ«Ø§Ø¦Ù‚", "Ø¹Ù„Ø§Ù…Ø§Øª Ø³ÙˆØ¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©", "Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø·Ø¨ÙŠØ©", "Ø¸Ø±ÙˆÙ Ø§Ù„Ù…Ø¹ÙŠØ´Ø©"]
                    }
                };
            }
        }
        
        // Initialize page
        async function initializePage() {
            // Load inspection sub-items first
            await loadInspectionSubItems();
            
            // Display inspection details
            displayInspectionDetails();
            
            // Populate inspector dropdown
            populateInspectorDropdown();
            
            // Generate checklist items
            generateChecklistItems();
            
            // Check if GitHub token is configured
            if (!GITHUB_TOKEN) {
                console.warn('âš ï¸ No GitHub token configured. Direct GitHub save will not work.');
                console.warn('â„¹ï¸ Use Ctrl+Shift+D to open Developer Controls and configure GitHub Settings');
            }
        }
        
        function displayInspectionDetails() {
            const detailsGrid = document.getElementById('inspectionDetailsGrid');
            detailsGrid.innerHTML = `
                <div><strong>Ø§Ù„Ù…ÙØªØ´ÙŠÙ†:</strong> ${inspectors.join('ØŒ ') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                <div><strong>Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©:</strong> ${shift || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                <div><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${area || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                <div><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª:</strong> ${shops.length || 0}</div>
                <div style="grid-column: span 2;"><strong>Ø§Ù„Ù…Ø­Ù„Ø§Øª:</strong> ${shops.join('ØŒ ') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
            `;
        }
        
        function populateInspectorDropdown() {
            const select = document.getElementById('inspectorSelect');
            inspectors.forEach(inspector => {
                const option = document.createElement('option');
                option.value = inspector;
                option.textContent = inspector;
                select.appendChild(option);
            });
        }
        
        function generateChecklistItems() {
            const container = document.getElementById('checklistContainer');
            let html = '';
            
            checklistItems.forEach((item) => {
                html += `
                    <div class="checklist-item-card">
                        <div class="checklist-item-header">${item.label}</div>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="${item.id}" value="Ù…Ø³ØªÙˆÙÙ‰">
                                <span class="radio-label fulfilled">âœ… Ù…Ø³ØªÙˆÙÙ‰</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${item.id}" value="ØºÙŠØ± Ù…Ø³ØªÙˆÙÙ‰" data-item-id="${item.id}">
                                <span class="radio-label unfulfilled">âŒ ØºÙŠØ± Ù…Ø³ØªÙˆÙÙ‰</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${item.id}" value="Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙØªÙŠØ´">
                                <span class="radio-label not-inspected">â­ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙØªÙŠØ´</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${item.id}" value="Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚">
                                <span class="radio-label not-applicable">â– Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚</span>
                            </label>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Add event listeners to "ØºÙŠØ± Ù…Ø³ØªÙˆÙÙ‰" radio buttons
            document.querySelectorAll('input[type="radio"][value="ØºÙŠØ± Ù…Ø³ØªÙˆÙÙ‰"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        const itemId = this.getAttribute('data-item-id');
                        openUnfulfilledItemsModal(itemId);
                    }
                });
            });
        }
        
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('inspectorPassword');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
            } else {
                passwordInput.type = 'password';
            }
        }
        
        // Generate default password from username
        function generateDefaultPassword(username) {
            return username.replace(/\s+/g, '').replace(/\./g, '').replace(/ØŒ/g, '');
        }
        
        // Check if password is valid for the given username
        function isValidPassword(password, username) {
            const expectedPassword = generateDefaultPassword(username);
            const passwordData = JSON.parse(localStorage.getItem('inspectorPasswords') || '{}');
            const storedPassword = passwordData[username];
            
            return password === expectedPassword || 
                   password === '12345' || 
                   (storedPassword && password === storedPassword);
        }
        
        // Verify password
        function verifyPassword() {
            const password = document.getElementById('inspectorPassword').value;
            const username = document.getElementById('inspectorSelect').value;
            const statusDiv = document.getElementById('passwordVerificationStatus');
            
            if (!username) {
                statusDiv.className = 'password-status-error';
                statusDiv.innerHTML = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙØªØ´ Ø£ÙˆÙ„Ø§Ù‹';
                statusDiv.style.display = 'block';
                return;
            }
            
            if (!password) {
                statusDiv.className = 'password-status-error';
                statusDiv.innerHTML = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
                statusDiv.style.display = 'block';
                return;
            }
            
            // Validate password using helper function
            if (isValidPassword(password, username)) {
                statusDiv.className = 'password-status-success';
                statusDiv.innerHTML = 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù…Ù„Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
                statusDiv.style.display = 'block';
            } else {
                statusDiv.className = 'password-status-error';
                statusDiv.innerHTML = 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
                statusDiv.style.display = 'block';
            }
        }
        
        function capturePhoto() {
            const input = document.getElementById('photoInput');
            if (input) {
                input.click();
            }
        }
        
        function handlePhotoCapture(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª ØµÙˆØ± ÙÙ‚Ø·');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoData = {
                        data: e.target.result,
                        name: file.name,
                        timestamp: new Date().toISOString()
                    };
                    
                    inspectionPhotos.push(photoData);
                    displayPhotos();
                };
                reader.readAsDataURL(file);
            });
            
            // Reset input to allow selecting the same file again
            event.target.value = '';
        }
        
        function displayPhotos() {
            const previewDiv = document.getElementById('photosPreview');
            if (!previewDiv) return;
            
            previewDiv.innerHTML = inspectionPhotos.map((photo, index) => `
                <div style="position: relative; border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                    <img src="${photo.data}" style="width: 100%; height: 150px; object-fit: cover;">
                    <button onclick="removePhoto(${index})" style="position: absolute; top: 5px; left: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);" title="Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©">Ã—</button>
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 0.8em; text-align: center;">
                        ØµÙˆØ±Ø© ${index + 1}
                    </div>
                </div>
            `).join('');
        }
        
        function removePhoto(index) {
            inspectionPhotos.splice(index, 1);
            displayPhotos();
        }
        
        // Variables to track current item being processed
        let currentProcessingItemId = null;
        
        // Open unfulfilled items modal
        function openUnfulfilledItemsModal(itemId) {
            currentProcessingItemId = itemId;
            const modal = document.getElementById('unfulfilledItemsModal');
            const manualTextarea = document.getElementById('manualUnfulfilledItems');
            
            // Clear previous data
            manualTextarea.value = '';
            
            // Load previously saved data if exists
            if (unfulfilledItemsData[itemId]) {
                const savedData = unfulfilledItemsData[itemId];
                
                // Set manual text
                if (savedData.manualItems) {
                    manualTextarea.value = savedData.manualItems;
                }
            }
            
            modal.style.display = 'flex';
        }
        
        // Close unfulfilled items modal
        function closeUnfulfilledItemsModal() {
            const modal = document.getElementById('unfulfilledItemsModal');
            modal.style.display = 'none';
            // Don't reset currentProcessingItemId here, as it's still needed for the actions modal
        }
        
        // Cancel unfulfilled items - revert radio selection
        function cancelUnfulfilledItems() {
            if (currentProcessingItemId) {
                // Uncheck the "ØºÙŠØ± Ù…Ø³ØªÙˆÙÙ‰" radio button
                const radio = document.querySelector(`input[name="${currentProcessingItemId}"][value="ØºÙŠØ± Ù…Ø³ØªÙˆÙÙ‰"]`);
                if (radio) {
                    radio.checked = false;
                }
                
                // Clear any saved data for this item
                delete unfulfilledItemsData[currentProcessingItemId];
            }
            closeUnfulfilledItemsModal();
            currentProcessingItemId = null;
        }
        
        // Confirm unfulfilled items and proceed to actions modal
        function confirmUnfulfilledItems() {
            if (!currentProcessingItemId) return;
            
            // Get manual text
            const manualItems = document.getElementById('manualUnfulfilledItems').value.trim();
            
            // Validate that at least something is written
            if (!manualItems) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø¨Ù†Ø¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø¨Ù†ÙˆØ¯ ØºÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆÙÙŠØ©');
                return;
            }
            
            // Save data
            if (!unfulfilledItemsData[currentProcessingItemId]) {
                unfulfilledItemsData[currentProcessingItemId] = {};
            }
            // Remove any old selectedSubItems property and save only manual items
            delete unfulfilledItemsData[currentProcessingItemId].selectedSubItems;
            unfulfilledItemsData[currentProcessingItemId].manualItems = manualItems;
            
            // Close this modal and open actions modal
            closeUnfulfilledItemsModal();
            openActionsModal(currentProcessingItemId);
        }
        
        // Open actions modal
        function openActionsModal(itemId) {
            const modal = document.getElementById('actionsModal');
            
            // Clear previous selection
            document.querySelectorAll('input[name="actionType"]').forEach(radio => {
                radio.checked = false;
            });
            
            // Load previously saved action if exists
            if (unfulfilledItemsData[itemId] && unfulfilledItemsData[itemId].action) {
                const savedAction = unfulfilledItemsData[itemId].action;
                const radio = document.querySelector(`input[name="actionType"][value="${savedAction}"]`);
                if (radio) {
                    radio.checked = true;
                }
            }
            
            modal.style.display = 'flex';
        }
        
        // Close actions modal
        function closeActionsModal() {
            const modal = document.getElementById('actionsModal');
            modal.style.display = 'none';
        }
        
        // Cancel action - go back to unfulfilled items modal
        function cancelAction() {
            closeActionsModal();
            if (currentProcessingItemId) {
                openUnfulfilledItemsModal(currentProcessingItemId);
            }
        }
        
        // Confirm action - FIXED: Now properly saves and closes
        function confirmAction() {
            if (!currentProcessingItemId) return;
            
            // Get selected action
            const selectedAction = document.querySelector('input[name="actionType"]:checked');
            if (!selectedAction) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø±Ø§Ø¡');
                return;
            }
            
            const actionValue = selectedAction.value;
            
            // Save action
            if (!unfulfilledItemsData[currentProcessingItemId]) {
                unfulfilledItemsData[currentProcessingItemId] = {};
            }
            unfulfilledItemsData[currentProcessingItemId].action = actionValue;
            
            // Auto-close the actions modal
            closeActionsModal();
            
            // If action is "Ø¥Ù†Ø°Ø§Ø±", open deadline modal
            if (actionValue === 'Ø¥Ù†Ø°Ø§Ø±') {
                openDeadlineModal(currentProcessingItemId);
            } else {
                // Auto-save is now complete, show confirmation
                console.log('Action saved automatically:', actionValue);
                // All done, reset current processing item
                currentProcessingItemId = null;
            }
        }
        
        // Open deadline modal
        function openDeadlineModal(itemId) {
            const modal = document.getElementById('deadlineModal');
            const dateInput = document.getElementById('deadlineDate');
            const notesInput = document.getElementById('deadlineNotes');
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
            
            // Clear previous data
            dateInput.value = '';
            notesInput.value = '';
            
            // Load previously saved deadline if exists
            if (unfulfilledItemsData[itemId] && unfulfilledItemsData[itemId].deadline) {
                const savedDeadline = unfulfilledItemsData[itemId].deadline;
                dateInput.value = savedDeadline.date || '';
                notesInput.value = savedDeadline.notes || '';
            }
            
            modal.style.display = 'flex';
        }
        
        // Close deadline modal
        function closeDeadlineModal() {
            const modal = document.getElementById('deadlineModal');
            modal.style.display = 'none';
        }
        
        // Cancel deadline - go back to actions modal
        function cancelDeadline() {
            closeDeadlineModal();
            if (currentProcessingItemId) {
                openActionsModal(currentProcessingItemId);
            }
        }
        
        // Confirm deadline
        function confirmDeadline() {
            if (!currentProcessingItemId) return;
            
            const dateValue = document.getElementById('deadlineDate').value;
            const notesValue = document.getElementById('deadlineNotes').value.trim();
            
            // Validate that date is selected
            if (!dateValue) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù„Ø©');
                return;
            }
            
            // Save deadline data
            if (!unfulfilledItemsData[currentProcessingItemId]) {
                unfulfilledItemsData[currentProcessingItemId] = {};
            }
            unfulfilledItemsData[currentProcessingItemId].deadline = {
                date: dateValue,
                notes: notesValue
            };
            
            closeDeadlineModal();
            
            // All done, reset current processing item
            currentProcessingItemId = null;
        }
        
        // GitHub API Configuration
        const GITHUB_REPO = 'aliabdelaal-adm/Monthly_inspection_plan';
        // Token with fallback for direct saving functionality
        const GITHUB_TOKEN = localStorage.getItem('developerToken') || 'github_pat_11BXTWBWY0P3bOey5lxzfA_pdwYx3RvhUWS9mgpdds94znoS31j0801ocwUAD4TJ5CD8Qpf4Nu';
        
        // Test GitHub API connectivity
        async function testGitHubConnection() {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}`, {
                    headers: {
                        'Authorization': `Bearer ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    console.log('âœ… GitHub API connection successful');
                    return true;
                } else {
                    console.warn('âš ï¸ GitHub API returned error:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('âŒ GitHub API connection failed:', error);
                return false;
            }
        }
        
        // Save report to GitHub - REAL PERMANENT SAVE with multiple fallback methods
        async function saveReportToGitHub(reportData) {
            // Create unique filename based on timestamp
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const fileName = `group-inspection-${timestamp}.json`;
            const filePath = `files/group_inspection_reports/${fileName}`;
            
            // Check if GitHub token is configured
            if (!GITHUB_TOKEN) {
                console.warn('âš ï¸ No GitHub token configured. GitHub save methods will not work.');
                console.warn('â„¹ï¸ Please configure a token in Developer Controls > GitHub Settings');
                // Return early to skip GitHub API attempts
                return { success: false, method: 'none', error: 'no_token' };
            }
            
            // Test GitHub connectivity first
            const isConnected = await testGitHubConnection();
            if (!isConnected) {
                console.warn('âš ï¸ GitHub API not accessible, using fallback methods');
            }
            
            // Method 1: Try direct file creation via Contents API
            try {
                console.log('Attempting direct GitHub API save...');
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(reportData, null, 2))));
                
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        message: `Add group inspection report - ${reportData.date} - ${reportData.area}`,
                        content: content,
                        branch: 'main'
                    })
                });
                
                if (response.ok) {
                    console.log('âœ… Report saved via direct API!');
                    
                    // Try to update files.json registry
                    try {
                        await updateFilesJsonRegistry(fileName, filePath, reportData);
                        console.log('âœ… Registry updated successfully!');
                    } catch (regError) {
                        console.warn('âš ï¸ Report saved but registry update failed:', regError);
                    }
                    
                    return { success: true, method: 'direct_api' };
                } else {
                    const errorText = await response.text();
                    console.warn('Direct API failed:', response.status, errorText);
                }
            } catch (directError) {
                console.warn('Direct API error:', directError);
            }
            
            // Method 2: Try repository_dispatch workflow trigger
            try {
                console.log('Attempting repository dispatch...');
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        event_type: 'save-inspection-report',
                        client_payload: {
                            filename: fileName,
                            report: reportData,
                            commit_message: `Add group inspection report - ${reportData.date} - ${reportData.area}`
                        }
                    })
                });
                
                if (response.status === 204) {
                    console.log('âœ… Report dispatched to GitHub Actions!');
                    
                    // Wait for workflow to process
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    // Try to update registry
                    try {
                        await updateFilesJsonRegistry(fileName, filePath, reportData);
                        console.log('âœ… Registry updated!');
                    } catch (regError) {
                        console.warn('âš ï¸ Registry update pending');
                    }
                    
                    return { success: true, method: 'repository_dispatch' };
                } else {
                    const errorText = await response.text();
                    console.warn('Repository dispatch failed:', response.status, errorText);
                }
            } catch (dispatchError) {
                console.warn('Repository dispatch error:', dispatchError);
            }
            
            // Method 3: Create a GitHub Issue as fallback
            try {
                console.log('Creating GitHub issue as fallback...');
                // Truncate report data if too large for issue (photos can be very large)
                const reportSummary = {
                    ...reportData,
                    photos: reportData.photos.length > 0 ? { count: reportData.photos.length, truncated: true } : []
                };
                
                const issueBody = `## ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø¬Ù…Ø§Ø¹Ù‰ - ${reportData.area}

**Ø§Ù„ØªØ§Ø±ÙŠØ®:** ${reportData.date}
**Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©:** ${reportData.shift}
**Ø§Ù„Ù…ÙØªØ´:** ${reportData.selectedInspector}
**Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:** ${reportData.area}
**Ø§Ù„Ù…Ø­Ù„Ø§Øª:** ${reportData.shops.join('ØŒ ')}

### Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±
- **Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ±:** ${reportData.photos.length}
- **Ø±Ù‚Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ±:** ${reportData.reportId}

### Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙØªÙŠØ´
${reportData.checklist.map(item => `- **${item.label}:** ${item.value || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±'}`).join('\n')}

### Ù…Ù„Ø§Ø­Ø¸Ø§Øª
${reportData.notes.generalNotes ? `**Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©:** ${reportData.notes.generalNotes}\n` : ''}
${reportData.notes.violations ? `**Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª:** ${reportData.notes.violations}\n` : ''}
${reportData.notes.recommendations ? `**Ø§Ù„ØªÙˆØµÙŠØ§Øª:** ${reportData.notes.recommendations}\n` : ''}

---

**Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ù‚ØªØ±Ø­:** \`${fileName}\`
**Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­:** \`${filePath}\`

Ù„Ù„Ø­ÙØ¸ Ø§Ù„ÙŠØ¯ÙˆÙŠØŒ ÙŠÙ…ÙƒÙ† ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.
`;
                
                const issueResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        title: `ğŸ“‹ ØªÙ‚Ø±ÙŠØ± ØªÙØªÙŠØ´ Ø¬Ù…Ø§Ø¹ÙŠ - ${reportData.area} - ${reportData.date}`,
                        body: issueBody,
                        labels: ['inspection-report', 'auto-generated']
                    })
                });
                
                if (issueResponse.ok) {
                    const issueData = await issueResponse.json();
                    console.log('âœ… Report saved as GitHub issue:', issueData.html_url);
                    
                    return { success: true, method: 'github_issue', url: issueData.html_url };
                } else {
                    const errorText = await issueResponse.text();
                    console.warn('Issue creation failed:', issueResponse.status, errorText);
                }
            } catch (issueError) {
                console.error('Issue creation failed:', issueError);
            }
            
            // All methods failed
            console.error('All save methods failed');
            return { success: false, method: 'none' };
        }
        
        async function updateFilesJsonRegistry(fileName, filePath, reportData) {
            try {
                // Fetch current files.json
                const getResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/files.json?t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                let filesData = { files: [], categories: [], lastUpdate: new Date().toISOString() };
                let currentSha = '';
                
                if (getResponse.ok) {
                    const file = await getResponse.json();
                    filesData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
                    currentSha = file.sha;
                } else {
                    console.error('Failed to fetch files.json');
                    return false;
                }
                
                // Create report entry with unique ID
                const uniqueId = `GIR_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const inspectorName = reportData.selectedInspector || 
                                     (reportData.inspectors && reportData.inspectors.length > 0 ? reportData.inspectors[0] : 'Ù…ÙØªØ´');
                
                const reportEntry = {
                    id: uniqueId,
                    name: fileName,
                    path: filePath,
                    category: 'group_inspection_reports',
                    type: 'json',
                    size: new Blob([JSON.stringify(reportData)]).size,
                    uploadDate: new Date().toISOString(),
                    description: `ØªÙ‚Ø±ÙŠØ± ØªÙØªÙŠØ´ Ø¬Ù…Ø§Ø¹ÙŠ - ${reportData.area} - ${reportData.date}`,
                    uploader: inspectorName,
                    visible: true
                };
                
                // Add to files array
                filesData.files.push(reportEntry);
                filesData.lastUpdate = new Date().toISOString();
                
                // Ensure group_inspection_reports category exists
                const categoryExists = filesData.categories.some(c => c.id === 'group_inspection_reports');
                if (!categoryExists) {
                    filesData.categories.push({
                        id: 'group_inspection_reports',
                        name: 'ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ',
                        nameEn: 'Group Inspection Reports',
                        description: 'ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙØªØ´ÙŠÙ†',
                        path: 'files/group_inspection_reports/'
                    });
                }
                
                // Save updated files.json
                const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(filesData, null, 2))));
                const updateResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/files.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: `Update files registry - Add group inspection report: ${reportData.area}`,
                        content: updatedContent,
                        sha: currentSha,
                        branch: 'main'
                    }),
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                if (updateResponse.ok) {
                    console.log('âœ… files.json registry updated successfully');
                    return true;
                } else {
                    const errorData = await updateResponse.json();
                    console.error('Error updating files.json:', errorData);
                    return false;
                }
            } catch (error) {
                console.error('Error updating files.json registry:', error);
                return false;
            }
        }
        
        async function submitInspectionReport() {
            // Validate password
            const password = document.getElementById('inspectorPassword').value.trim();
            const username = document.getElementById('inspectorSelect').value;
            
            if (!username) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙØªØ´ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            if (!password) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                return;
            }
            
            // Validate password using helper function
            if (!isValidPassword(password, username)) {
                alert('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                return;
            }
            
            // Collect checklist data
            const checklistData = [];
            checklistItems.forEach(item => {
                const selected = document.querySelector(`input[name="${item.id}"]:checked`);
                const itemData = {
                    id: item.id,
                    label: item.label,
                    value: selected ? selected.value : null
                };
                
                // If item is "ØºÙŠØ± Ù…Ø³ØªÙˆÙÙ‰", include the detailed unfulfilled items data
                if (selected && selected.value === 'ØºÙŠØ± Ù…Ø³ØªÙˆÙÙ‰' && unfulfilledItemsData[item.id]) {
                    itemData.unfulfilledDetails = unfulfilledItemsData[item.id];
                }
                
                checklistData.push(itemData);
            });
            
            // Create inspection report object
            const inspectionReport = {
                inspectors: inspectors,
                selectedInspector: username,
                date: date,
                shift: shift,
                area: area,
                shops: shops,
                checklist: checklistData,
                notes: {
                    generalNotes: document.getElementById('generalNotes').value,
                    violations: document.getElementById('violations').value,
                    awarenessItems: document.getElementById('awarenessItems').value,
                    actionsTaken: document.getElementById('actionsTaken').value,
                    recommendations: document.getElementById('recommendations').value
                },
                photos: inspectionPhotos,
                timestamp: new Date().toISOString(),
                reportId: `GIR-${Date.now()}` // Unique ID for the report
            };
            
            // Show saving indicator
            const saveBtn = event.target;
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            saveBtn.disabled = true;
            
            try {
                // Save directly to GitHub for PERMANENT storage
                const saveResult = await saveReportToGitHub(inspectionReport);
                
                if (saveResult.success) {
                    // Save to localStorage as backup only
                    let localBackupSuccess = true;
                    try {
                        const savedReports = JSON.parse(localStorage.getItem('groupInspectionReports') || '[]');
                        savedReports.push(inspectionReport);
                        localStorage.setItem('groupInspectionReports', JSON.stringify(savedReports));
                        console.log('âœ… Local backup created successfully');
                    } catch (localStorageError) {
                        localBackupSuccess = false;
                        console.warn('âš ï¸ Local storage backup failed:', localStorageError);
                        // Not critical since GitHub save succeeded
                    }
                    
                    let successMessage = 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ GitHub!';
                    
                    if (saveResult.method === 'direct_api') {
                        successMessage += '\n\nØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹. Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙˆØ±Ø§Ù‹ ÙÙŠ ØµÙØ­Ø© ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ.';
                    } else if (saveResult.method === 'repository_dispatch') {
                        successMessage += '\n\nØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø­ÙØ¸. Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø®Ù„Ø§Ù„ Ø¯Ù‚Ø§Ø¦Ù‚.';
                    } else if (saveResult.method === 'github_issue') {
                        successMessage += '\n\nØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ€ Issue ÙÙŠ GitHub. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ:\n' + saveResult.url;
                    }
                    
                    if (!localBackupSuccess) {
                        successMessage += '\n\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­Ù„ÙŠØ© Ø¨Ø³Ø¨Ø¨ Ø§Ù…ØªÙ„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†ÙŠØ©.';
                    }
                    
                    alert(successMessage);
                    
                    // Redirect back to main page
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                } else {
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    
                    // Provide detailed error feedback based on error type
                    let errorMsg = 'âš ï¸ ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ GitHub Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹.\n\n';
                    
                    if (saveResult.error === 'no_token') {
                        errorMsg += 'Ø§Ù„Ø³Ø¨Ø¨: Ù„Ù… ÙŠØªÙ… ØªÙƒÙˆÙŠÙ† Ø±Ù…Ø² ÙˆØµÙˆÙ„ GitHub.\n\n' +
                            'Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:\n' +
                            '1. Ø§Ø¶ØºØ· Ctrl+Shift+D Ù„ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø·ÙˆØ±\n' +
                            '2. Ø§Ø¶ØºØ· "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub"\n' +
                            '3. Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø´Ø®ØµÙŠ\n\n' +
                            'Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ:\n' +
                            'â€¢ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ…Ù„Ù Ø§Ø­ØªÙŠØ§Ø·ÙŠ" Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø©\n' +
                            'â€¢ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­';
                    } else {
                        errorMsg += 'ØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø¯Ø© Ø·Ø±Ù‚ Ù„Ù„Ø­ÙØ¸ ÙˆÙ„ÙƒÙ†Ù‡Ø§ ÙØ´Ù„Øª.\n\n' +
                            'Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©:\n' +
                            '1. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª\n' +
                            '2. ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø±Ù…Ø² GitHub (Ctrl+Shift+D)\n' +
                            '3. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ…Ù„Ù Ø§Ø­ØªÙŠØ§Ø·ÙŠ"\n' +
                            '4. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„\n\n' +
                            'ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.';
                    }
                    
                    alert(errorMsg);
                    
                    // Save to localStorage as fallback even if GitHub save failed
                    try {
                        const savedReports = JSON.parse(localStorage.getItem('groupInspectionReports') || '[]');
                        savedReports.push(inspectionReport);
                        localStorage.setItem('groupInspectionReports', JSON.stringify(savedReports));
                        console.log('âœ… Local backup created as fallback');
                    } catch (localStorageError) {
                        console.error('âŒ Local storage backup also failed:', localStorageError);
                    }
                }
            } catch (error) {
                console.error('Error saving report:', error);
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                
                // Provide helpful error message
                let errorDetails = error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                if (error.name === 'TypeError' && errorDetails.includes('fetch')) {
                    errorDetails = 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­';
                }
                
                const errorMsg = 'âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.\n\n' +
                    `Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${errorDetails}\n\n` +
                    'Ø§Ù„Ø±Ø¬Ø§Ø¡:\n' +
                    '1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª\n' +
                    '2. Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰\n' +
                    '3. Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ\n\n' +
                    'ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­Ù„ÙŠØ©.';
                
                alert(errorMsg);
                
                // Save to localStorage as fallback
                try {
                    const savedReports = JSON.parse(localStorage.getItem('groupInspectionReports') || '[]');
                    savedReports.push(inspectionReport);
                    localStorage.setItem('groupInspectionReports', JSON.stringify(savedReports));
                    console.log('âœ… Local backup created after error');
                } catch (localStorageError) {
                    console.error('âŒ Local storage backup also failed:', localStorageError);
                }
            }
        }
        
        // Download report as JSON file (backup method)
        function downloadReportAsFile() {
            // Validate that basic fields are filled
            const username = document.getElementById('inspectorSelect').value;
            
            if (!username) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙØªØ´ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            // Collect checklist data
            const checklistData = [];
            checklistItems.forEach(item => {
                const selected = document.querySelector(`input[name="${item.id}"]:checked`);
                const itemData = {
                    id: item.id,
                    label: item.label,
                    value: selected ? selected.value : null
                };
                
                if (selected && selected.value === 'ØºÙŠØ± Ù…Ø³ØªÙˆÙÙ‰' && unfulfilledItemsData[item.id]) {
                    itemData.unfulfilledDetails = unfulfilledItemsData[item.id];
                }
                
                checklistData.push(itemData);
            });
            
            // Create inspection report object
            const inspectionReport = {
                inspectors: inspectors,
                selectedInspector: username,
                date: date,
                shift: shift,
                area: area,
                shops: shops,
                checklist: checklistData,
                notes: {
                    generalNotes: document.getElementById('generalNotes').value,
                    violations: document.getElementById('violations').value,
                    awarenessItems: document.getElementById('awarenessItems').value,
                    actionsTaken: document.getElementById('actionsTaken').value,
                    recommendations: document.getElementById('recommendations').value
                },
                photos: inspectionPhotos,
                timestamp: new Date().toISOString(),
                reportId: `GIR-${Date.now()}`
            };
            
            // Create filename
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const fileName = `group-inspection-${timestamp}.json`;
            
            // Create blob and download
            const jsonString = JSON.stringify(inspectionReport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`âœ… ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ø³Ù… Ø§Ù„Ù…Ù„Ù: ${fileName}\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø±:\nfiles/group_inspection_reports/${fileName}`);
        }
        
        // Developer Controls Functions
        let currentEditingMainItem = null;
        let currentEditingSubItemIndex = null;
        
        // Toggle developer mode
        function toggleDeveloperMode() {
            const devControls = document.getElementById('developerControls');
            if (devControls.style.display === 'none') {
                const password = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø·ÙˆØ±:');
                // Use stored developer password if available, otherwise use default
                const storedPassword = localStorage.getItem('developerPassword');
                const validPasswords = ['12345', 'developer'];
                
                if (storedPassword) {
                    validPasswords.push(storedPassword);
                }
                
                if (validPasswords.includes(password)) {
                    devControls.style.display = 'block';
                } else {
                    alert('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                }
            } else {
                devControls.style.display = 'none';
            }
        }
        
        // Open sub-items manager
        function openSubItemsManager() {
            const modal = document.getElementById('subItemsManagerModal');
            const select = document.getElementById('mainItemSelect');
            
            // Clear and populate main items
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø¯ --</option>';
            checklistItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.label;
                select.appendChild(option);
            });
            
            modal.style.display = 'flex';
        }
        
        // Close sub-items manager
        function closeSubItemsManager() {
            const modal = document.getElementById('subItemsManagerModal');
            modal.style.display = 'none';
        }
        
        // Load sub-items for editing
        function loadSubItemsForEditing() {
            const mainItemId = document.getElementById('mainItemSelect').value;
            if (!mainItemId) {
                document.getElementById('subItemsEditor').style.display = 'none';
                return;
            }
            
            currentEditingMainItem = mainItemId;
            document.getElementById('subItemsEditor').style.display = 'block';
            
            const itemData = inspectionSubItems[mainItemId];
            const container = document.getElementById('currentSubItems');
            
            if (!itemData || !itemData.subitems || itemData.subitems.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ ÙØ±Ø¹ÙŠØ©. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†ÙˆØ¯ Ø¬Ø¯ÙŠØ¯Ø© Ø£Ø¯Ù†Ø§Ù‡.</p>';
                return;
            }
            
            container.innerHTML = itemData.subitems.map((subitem, index) => `
                <div class="subitem-item">
                    <span>${subitem}</span>
                    <div class="subitem-actions">
                        <button class="edit-btn" onclick="editSubItem(${index})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="delete-btn" onclick="deleteSubItem(${index})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Add new sub-item
        function addNewSubItem() {
            const input = document.getElementById('newSubItemInput');
            const newSubItem = input.value.trim();
            
            if (!newSubItem) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„ÙØ±Ø¹ÙŠ');
                return;
            }
            
            if (!currentEditingMainItem) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            // Add to inspectionSubItems
            if (!inspectionSubItems[currentEditingMainItem]) {
                inspectionSubItems[currentEditingMainItem] = {
                    name: checklistItems.find(item => item.id === currentEditingMainItem).label,
                    subitems: []
                };
            }
            
            inspectionSubItems[currentEditingMainItem].subitems.push(newSubItem);
            
            // Clear input and reload display
            input.value = '';
            loadSubItemsForEditing();
            
            alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„ÙØ±Ø¹ÙŠ. Ù„Ø§ ØªÙ†Ø³Ù‰ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª!');
        }
        
        // Edit sub-item
        function editSubItem(index) {
            currentEditingSubItemIndex = index;
            const modal = document.getElementById('editSubItemModal');
            const input = document.getElementById('editSubItemInput');
            
            const currentValue = inspectionSubItems[currentEditingMainItem].subitems[index];
            input.value = currentValue;
            
            modal.style.display = 'flex';
        }
        
        // Close edit sub-item modal
        function closeEditSubItemModal() {
            const modal = document.getElementById('editSubItemModal');
            modal.style.display = 'none';
        }
        
        // Confirm edit sub-item
        function confirmEditSubItem() {
            const input = document.getElementById('editSubItemInput');
            const newValue = input.value.trim();
            
            if (!newValue) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„ÙØ±Ø¹ÙŠ');
                return;
            }
            
            inspectionSubItems[currentEditingMainItem].subitems[currentEditingSubItemIndex] = newValue;
            
            closeEditSubItemModal();
            loadSubItemsForEditing();
            
            alert('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„ÙØ±Ø¹ÙŠ. Ù„Ø§ ØªÙ†Ø³Ù‰ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª!');
        }
        
        // Delete sub-item
        function deleteSubItem(index) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„ÙØ±Ø¹ÙŠØŸ')) {
                return;
            }
            
            inspectionSubItems[currentEditingMainItem].subitems.splice(index, 1);
            loadSubItemsForEditing();
            
            alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„ÙØ±Ø¹ÙŠ. Ù„Ø§ ØªÙ†Ø³Ù‰ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª!');
        }
        
        // Save sub-items to GitHub
        async function saveSubItemsToGitHub() {
            try {
                // Show saving indicator
                const saveBtn = event.target;
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
                saveBtn.disabled = true;
                
                // Get current file SHA
                let sha = null;
                const getResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/inspection-subitems.json`, {
                    headers: {
                        'Authorization': `Bearer ${GITHUB_TOKEN}`
                    }
                });
                
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }
                
                // Encode content as base64
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(inspectionSubItems, null, 2))));
                
                // Prepare request body
                const requestBody = {
                    message: 'Update inspection sub-items',
                    content: content,
                    branch: 'main'
                };
                
                if (sha) {
                    requestBody.sha = sha;
                }
                
                // Save to GitHub
                const saveResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/inspection-subitems.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (saveResponse.ok) {
                    alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ GitHub Ø¨Ù†Ø¬Ø§Ø­!');
                    closeSubItemsManager();
                } else {
                    const errorData = await saveResponse.json();
                    console.error('GitHub API Error:', errorData);
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ GitHub. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.');
                }
                
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            } catch (error) {
                console.error('Error saving to GitHub:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }
        
        // GitHub Settings Functions
        function openGitHubSettings() {
            const modal = document.getElementById('githubSettingsModal');
            const input = document.getElementById('githubTokenInput');
            
            // Load current token (masked)
            const currentToken = localStorage.getItem('developerToken');
            if (currentToken) {
                input.value = currentToken;
            } else {
                input.value = '';
            }
            
            // Hide status
            document.getElementById('githubConnectionStatus').style.display = 'none';
            
            modal.style.display = 'flex';
        }
        
        function closeGitHubSettings() {
            const modal = document.getElementById('githubSettingsModal');
            modal.style.display = 'none';
        }
        
        function toggleGitHubTokenVisibility() {
            const input = document.getElementById('githubTokenInput');
            const checkbox = document.getElementById('showGitHubToken');
            input.type = checkbox.checked ? 'text' : 'password';
        }
        
        async function saveGitHubToken() {
            const token = document.getElementById('githubTokenInput').value.trim();
            const statusDiv = document.getElementById('githubConnectionStatus');
            
            if (!token) {
                statusDiv.className = '';
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = 'âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„';
                return;
            }
            
            // Show testing status
            statusDiv.className = '';
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
            statusDiv.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...';
            
            // Test the token
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const repoData = await response.json();
                    
                    // Save token to localStorage
                    localStorage.setItem('developerToken', token);
                    
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = `âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!<br>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: ${repoData.full_name}<br>Ø§Ù„ÙˆØµÙˆÙ„: ${repoData.permissions.push ? 'ÙƒØ§Ù…Ù„' : 'Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·'}`;
                    
                    // Note: GITHUB_TOKEN constant cannot be updated, page will use localStorage value
                    console.log('âœ… Token saved successfully. It will be used for future save operations.');
                } else {
                    const errorData = await response.json();
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.innerHTML = `âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ${errorData.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`;
                }
            } catch (error) {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}`;
            }
        }
        
        function clearGitHubToken() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸ØŸ')) {
                localStorage.removeItem('developerToken');
                alert('âœ… ØªÙ… Ø­Ø°Ù Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„');
                closeGitHubSettings();
            }
        }
        
        async function testGitHubConnectionManual() {
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10001; min-width: 300px; text-align: center;';
            statusDiv.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub...';
            document.body.appendChild(statusDiv);
            
            const isConnected = await testGitHubConnection();
            
            if (isConnected) {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = 'âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub Ù†Ø§Ø¬Ø­!<br><br>ÙŠÙ…ÙƒÙ†Ùƒ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø¨Ø§Ø´Ø±Ø©.';
            } else {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = 'âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub<br><br>ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†:<br>1. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª<br>2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„';
            }
            
            setTimeout(() => {
                document.body.removeChild(statusDiv);
            }, 3000);
        }
        
        // Helper function to escape HTML and prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Export Group Inspection Reports to PowerPoint
        function exportGroupInspectionToPowerPoint() {
            const savedReports = JSON.parse(localStorage.getItem('groupInspectionReports') || '[]');
            
            if (savedReports.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§');
                return;
            }
            
            // Check if PptxGenJS is loaded
            if (typeof PptxGenJS === 'undefined') {
                alert('âš ï¸ Ù…ÙƒØªØ¨Ø© PowerPoint ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                console.error('PptxGenJS library not loaded');
                return;
            }
            
            try {
                // Create new presentation
                const pptx = new PptxGenJS();
                
                // Set RTL direction for the presentation
                pptx.rtlMode = true;
                pptx.layout = 'LAYOUT_WIDE';
                
                // Sort reports by timestamp
                savedReports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Calculate total checklist items from first report
                const totalChecklistItems = savedReports.length > 0 && savedReports[0].checklist ? savedReports[0].checklist.length : 0;
                
                // Title slide
                let slide = pptx.addSlide();
                slide.background = { fill: 'ff9800' };
                slide.addText('ğŸ“‹ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ', {
                    x: 0.5, y: 1.5, w: 9, h: 1.5,
                    fontSize: 44, bold: true, color: 'FFFFFF', align: 'center',
                    fontFace: 'Arial',
                    rtlMode: true
                });

                slide.addText(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±: ${savedReports.length} | Ø¨Ù†ÙˆØ¯ Ø±Ø¦ÙŠØ³ÙŠØ©: ${totalChecklistItems}`, {
                    x: 0.5, y: 3.5, w: 9, h: 0.6,
                    fontSize: 20, color: 'FFFFFF', align: 'center',
                    fontFace: 'Arial',
                    rtlMode: true
                });
                slide.addText(`ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleDateString('ar-EG')}`, {
                    x: 0.5, y: 4.5, w: 9, h: 0.6,
                    fontSize: 18, color: 'FFFFFF', align: 'center',
                    fontFace: 'Arial',
                    rtlMode: true
                });
                
                // Individual report slides
                savedReports.forEach((report, index) => {
                    const checklist = report.checklist || [];
                    const fulfilled = checklist.filter(item => item.value === 'Ù…Ø³ØªÙˆÙÙ‰').length;
                    const unfulfilled = checklist.filter(item => item.value === 'ØºÙŠØ± Ù…Ø³ØªÙˆÙÙ‰').length;
                    const compliance = checklist.length > 0 ? ((fulfilled / checklist.length) * 100).toFixed(0) : '0';
                    // Format timestamp with clear separation between date and time
                    const timestampDate = new Date(report.timestamp);
                    const dateStr = timestampDate.toLocaleDateString('ar-EG', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric'
                    });
                    const timeStr = timestampDate.toLocaleTimeString('ar-EG', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const timestamp = `${dateStr}  -  ${timeStr}`;
                    
                    // Slide 1: Report Summary
                    slide = pptx.addSlide();
                    slide.addText(`Ø§Ù„ØªÙ‚Ø±ÙŠØ± #${index + 1} - Ø§Ù„Ù…Ù„Ø®Øµ`, {
                        x: 0.5, y: 0.3, w: 9, h: 0.6,
                        fontSize: 28, bold: true, color: 'ff9800', align: 'right',
                        fontFace: 'Arial'
                    });
                    
                    const summaryRows = [
                        ['Ø§Ù„Ù…ÙØªØ´ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„', escapeHtml(report.selectedInspector || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')],
                        ['Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙØªØ´ÙŠÙ†', escapeHtml((report.inspectors || []).join('ØŒ ') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')],
                        ['Ø§Ù„ØªØ§Ø±ÙŠØ®', escapeHtml(report.date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')],
                        ['Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©', escapeHtml(report.shift || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')],
                        ['Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', escapeHtml(report.area || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')],
                        ['Ø§Ù„Ù…Ø­Ù„Ø§Øª', escapeHtml((report.shops || []).join('ØŒ ') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')],
                        ['ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', escapeHtml(timestamp)],
                        ['Ø±Ù‚Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ±', escapeHtml(report.reportId || 'N/A')],
                        ['Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„', `${compliance}%`],
                        ['Ø¨Ù†ÙˆØ¯ Ù…Ø³ØªÙˆÙØ§Ø©', fulfilled.toString()],
                        ['Ø¨Ù†ÙˆØ¯ ØºÙŠØ± Ù…Ø³ØªÙˆÙØ§Ø©', unfulfilled.toString()],
                        ['Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ±', (report.photos || []).length.toString()]
                    ];
                    
                    slide.addTable(summaryRows, {
                        x: 0.5, y: 1.2, w: 9, h: 4.5,
                        fontSize: 14, fontFace: 'Arial', align: 'right',
                        border: { pt: 1, color: 'CFCFCF' },
                        fill: { color: 'F5F5F5' },
                        colW: [3, 6]
                    });
                    
                    // Slide 2: Detailed Checklist Items
                    slide = pptx.addSlide();
                    slide.addText(`Ø§Ù„ØªÙ‚Ø±ÙŠØ± #${index + 1} - Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©`, {
                        x: 0.5, y: 0.3, w: 9, h: 0.6,
                        fontSize: 28, bold: true, color: 'ff9800', align: 'right',
                        fontFace: 'Arial'
                    });
                    
                    const checklistRows = [['Ø§Ù„Ø¨Ù†Ø¯', 'Ø§Ù„Ø­Ø§Ù„Ø©']];
                    checklist.forEach(item => {
                        const status = item.value || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙØªÙŠØ´';
                        checklistRows.push([escapeHtml(item.label || item.id), escapeHtml(status)]);
                        
                        // Add unfulfilled details if present
                        if (item.unfulfilledDetails) {
                            const details = item.unfulfilledDetails;
                            let detailsText = '';
                            if (details.manualItems) detailsText += `Ø§Ù„Ø¨Ù†ÙˆØ¯: ${escapeHtml(details.manualItems)} `;
                            if (details.action) detailsText += `Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: ${escapeHtml(details.action)} `;
                            if (details.deadline) detailsText += `Ø§Ù„Ù…Ù‡Ù„Ø©: ${escapeHtml(details.deadline)}`;
                            if (detailsText) {
                                checklistRows.push(['  Ø§Ù„ØªÙØ§ØµÙŠÙ„:', detailsText]);
                            }
                        }
                    });
                    
                    slide.addTable(checklistRows, {
                        x: 0.5, y: 1.2, w: 9, h: 4.5,
                        fontSize: 13, fontFace: 'Arial', align: 'right',
                        border: { pt: 1, color: 'CFCFCF' },
                        fill: { color: 'F5F5F5' },
                        colW: [6, 3]
                    });
                    
                    // Slide 3: Notes and Details
                    if (report.notes) {
                        slide = pptx.addSlide();
                        slide.addText(`Ø§Ù„ØªÙ‚Ø±ÙŠØ± #${index + 1} - Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª`, {
                            x: 0.5, y: 0.3, w: 9, h: 0.6,
                            fontSize: 28, bold: true, color: 'ff9800', align: 'right',
                            fontFace: 'Arial'
                        });
                        
                        let yPos = 1.2;
                        
                        if (report.notes.generalNotes) {
                            slide.addText('ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©:', {
                                x: 0.5, y: yPos, w: 9, h: 0.5,
                                fontSize: 18, bold: true, color: '856404', align: 'right',
                                fontFace: 'Arial'
                            });
                            slide.addText(escapeHtml(report.notes.generalNotes), {
                                x: 0.5, y: yPos + 0.5, w: 9, h: 0.8,
                                fontSize: 14, color: '333333', align: 'right',
                                fontFace: 'Arial'
                            });
                            yPos += 1.5;
                        }
                        
                        if (report.notes.violations) {
                            slide.addText('âš ï¸ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª:', {
                                x: 0.5, y: yPos, w: 9, h: 0.5,
                                fontSize: 18, bold: true, color: 'dc3545', align: 'right',
                                fontFace: 'Arial'
                            });
                            slide.addText(escapeHtml(report.notes.violations), {
                                x: 0.5, y: yPos + 0.5, w: 9, h: 0.8,
                                fontSize: 14, color: '333333', align: 'right',
                                fontFace: 'Arial'
                            });
                            yPos += 1.5;
                        }
                        
                        if (report.notes.awarenessItems) {
                            slide.addText('ğŸ’¡ Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙˆØ¹ÙŠØ©:', {
                                x: 0.5, y: yPos, w: 9, h: 0.5,
                                fontSize: 18, bold: true, color: '856404', align: 'right',
                                fontFace: 'Arial'
                            });
                            slide.addText(escapeHtml(report.notes.awarenessItems), {
                                x: 0.5, y: yPos + 0.5, w: 9, h: 0.8,
                                fontSize: 14, color: '333333', align: 'right',
                                fontFace: 'Arial'
                            });
                            yPos += 1.5;
                        }
                        
                        if (yPos < 4 && report.notes.actionsTaken) {
                            slide.addText('âœ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©:', {
                                x: 0.5, y: yPos, w: 9, h: 0.5,
                                fontSize: 18, bold: true, color: '17a2b8', align: 'right',
                                fontFace: 'Arial'
                            });
                            slide.addText(escapeHtml(report.notes.actionsTaken), {
                                x: 0.5, y: yPos + 0.5, w: 9, h: 0.8,
                                fontSize: 14, color: '333333', align: 'right',
                                fontFace: 'Arial'
                            });
                        }
                        
                        // If there are recommendations and space allows, add them
                        if (report.notes.recommendations && yPos < 3.5) {
                            yPos = yPos < 4 ? yPos + 1.5 : yPos;
                            if (yPos < 5) {
                                slide.addText('ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ§Øª:', {
                                    x: 0.5, y: yPos, w: 9, h: 0.5,
                                    fontSize: 18, bold: true, color: '17a2b8', align: 'right',
                                    fontFace: 'Arial'
                                });
                                slide.addText(escapeHtml(report.notes.recommendations), {
                                    x: 0.5, y: yPos + 0.5, w: 9, h: 0.8,
                                    fontSize: 14, color: '333333', align: 'right',
                                    fontFace: 'Arial'
                                });
                            }
                        }
                    }
                });
                
                // Save the presentation
                const fileName = `ØªÙ‚Ø§Ø±ÙŠØ±_Ø§Ù„ØªÙØªÙŠØ´_Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ_${new Date().toISOString().split('T')[0]}.pptx`;
                pptx.writeFile({ fileName: fileName });
                
                alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PowerPoint Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...');
            } catch (error) {
                console.error('Error generating PowerPoint:', error);
                alert('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PowerPoint. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }

        // Enable developer mode with keyboard shortcut (Ctrl+Shift+D)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                toggleDeveloperMode();
            }
        });
        
        // Initialize page on load
        window.onload = initializePage;
    </script>
</body>
</html>
