<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>عرض الخطة الشهرية للتفتيش</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background:#f6f7fa; font-family:'Segoe UI',Arial,sans-serif; margin:0; padding:0;}
    .container {max-width:950px; margin:38px auto 34px auto; background:#fff; border-radius:10px; box-shadow:0 0 12px #bbb; padding:26px 18px 36px 18px;}
    .header { background:#2336a0; color:#fff; font-size:2em; text-align:center; padding:17px 0; border-radius:8px; margin-bottom:22px;}
    .section-title { background:#e2e6f6; color:#2336a0; font-size:1.19em; font-weight:bold; margin:23px 0 14px 0; padding:8px 0; border-radius:6px; text-align:right;}
    table {width:100%; border-collapse:collapse; background:#fafafa; margin-bottom:30px;}
    th,td {border:1px solid #bbb; padding:12px 6px; text-align:center; vertical-align:middle; font-size:1.09em;}
    th {background:#2336a0; color:#fff;}
    .goals-cell { text-align:right; background:#f3f7ff; color:#2336a0; font-weight:bold; font-size:1.09em;}
    .goals-red { color:#c00; font-weight:bold; }
    .copyright { text-align:center; color:#2336a0; font-weight:bold; margin-top:25px; font-size:1.09em;}
    .plan-meta {margin:0 0 17px 0; color:#777; text-align:left; font-size:0.98em;}
    .update-time {color:#888; font-size:0.91em; margin:0 0 3px 0; text-align:left;}
    .list-label {font-weight:bold; color:#2336a0;}
    .list-area {margin-bottom:7px;}
    .shop-list {display:inline-block; background:#f3f7ff; color:#2336a0; margin:2px 7px 2px 0; padding:4px 14px; border-radius:4px; font-size:1em;}
    .inspector-label {color:#2336a0; font-weight:bold;}
    .area-label {color:#2a43c7; font-weight:bold;}
    .shop-label {color:#555;}
    .stats-table {margin:16px auto 24px auto; border:1px solid #2336a0; border-radius:8px; background:#f7f7ff;}
    .stats-table th {background:#2336a0; color:#fff;}
    .stats-table td {background:#fff;}
    .stats-table tfoot td {background:#e2e6f6; font-weight:bold;}
    .stats-inspector-col {min-width:160px; width:160px;}
    .stats-total-cell { color:#c00; font-weight:bold;}
    .plan-section {margin-bottom:32px;}
    .shop-badge {background:#e2e6f6; color:#2336a0; border-radius:3px; margin:0 2px; padding:2px 9px; font-size:0.99em;}
    
    /* أنماط إدارة التوزيع */
    .distribution-form {background:#f9f9f9; border:1px solid #ddd; border-radius:8px; padding:15px; margin-bottom:20px;}
    .form-row {display:flex; gap:10px; margin-bottom:10px; align-items:center; flex-wrap:wrap;}
    .form-group {display:flex; flex-direction:column; gap:5px;}
    .form-group label {font-weight:bold; color:#2336a0; font-size:0.9em;}
    .form-group select, .form-group input {padding:8px; border:1px solid #ccc; border-radius:4px; font-size:0.9em;}
    .shops-checkboxes {display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}
    .shop-checkbox {display:flex; align-items:center; gap:5px; background:#fff; padding:5px 10px; border:1px solid #ddd; border-radius:4px;}
    .shop-checkbox input[type="checkbox"] {margin:0;}
    .btn {background:#2336a0; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:0.9em;}
    .btn:hover {background:#1a2a80;}
    .btn-secondary {background:#6c757d;}
    .btn-secondary:hover {background:#545b62;}
    .distribution-table {margin-top:20px;}
    .distribution-table td {padding:8px; vertical-align:top;}
    .distribution-actions {display:flex; gap:5px;}
    .btn-small {padding:4px 8px; font-size:0.8em;}
    .btn-danger {background:#dc3545;}
    .btn-danger:hover {background:#c82333;}
    @media (max-width: 700px) {
      .container {padding:8px 2px;}
      th,td {padding:7px 2px; font-size:0.98em;}
      .header {font-size:1.1em;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">عرض الخطة الشهرية للتفتيش</div>
    <div id="updateTime" class="update-time"></div>
    <div id="planMeta" class="plan-meta"></div>

    <div class="section-title">جدول التفتيش الشهري</div>
    <div class="plan-section" id="planTable"></div>

    <div class="section-title">إدارة توزيع المحلات على المفتشين</div>
    <div class="plan-section" id="distributionManager"></div>

    <div class="section-title">إحصائيات التفتيش</div>
    <div class="plan-section" id="stats"></div>

    <div class="section-title">المفتشون</div>
    <div id="inspectorsList" class="plan-section"></div>

    <div class="section-title">المناطق والمحلات التابعة</div>
    <div id="areasList" class="plan-section"></div>

    <div class="section-title">أهداف التفتيش لهذا الشهر</div>
    <div class="plan-section">
      <div id="goalsSection" class="goals-cell"></div>
    </div>

    <div class="copyright">
      جميع الحقوق محفوظة &copy; المطور د. علي عبدالعال
    </div>
  </div>
  <script>
    // استخدام ملف البيانات المحلي للاختبار
    const PLAN_URL = "./plan-data.json";

    // تحديث وقت العرض فقط
    document.getElementById("updateTime").innerHTML = "آخر تحديث للخطة: <b>" + new Date().toLocaleDateString('ar-EG') + " " + new Date().toLocaleTimeString('ar-EG') + "</b>";

    fetch(PLAN_URL)
      .then(r=>r.json())
      .then(plan=>{
        // إعداد بيانات عامة
        const d = new Date();
        let meta = "تاريخ العرض: " + d.toLocaleDateString('ar-EG') + " " + d.toLocaleTimeString('ar-EG');
        document.getElementById("planMeta").textContent = meta;

        // رسم جدول الخطة
        let html = `<table>
          <thead>
            <tr>
              <th>اسم المفتش</th>
              <th>اليوم</th>
              <th>وقت المناوبة</th>
              <th>المنطقة</th>
              <th>المحلات</th>
            </tr>
          </thead>
          <tbody>`;
        (plan.distribution||[]).forEach(row=>{
          html += `<tr>
            <td class="inspector-label">${row.inspector||""}</td>
            <td>${row.day||""}</td>
            <td>${row.shift||""}</td>
            <td class="area-label">${row.area||""}</td>
            <td>${
              (row.shops||[]).map(shop=>`<span class="shop-badge">${shop}</span>`).join(" ")
            }</td>
          </tr>`;
        });
        html += `</tbody></table>`;
        document.getElementById("planTable").innerHTML = html;

        // المفتشون
        let inspectorsHtml = "";
        (plan.inspectors||[]).forEach(name=>{
          inspectorsHtml += `<span class="shop-list">${name}</span>`;
        });
        document.getElementById("inspectorsList").innerHTML = inspectorsHtml;

        // المناطق والمحلات
        let areasHtml = "";
        let shopsByArea = plan.shopsByArea || {};
        Object.keys(shopsByArea).forEach(area=>{
          areasHtml += `<div class="list-area"><span class="area-label">${area}:</span> `;
          (shopsByArea[area]||[]).forEach(shop=>{
            areasHtml += `<span class="shop-badge">${shop}</span>`;
          });
          areasHtml += `</div>`;
        });
        document.getElementById("areasList").innerHTML = areasHtml;

        // الأهداف
        document.getElementById("goalsSection").innerHTML = 
          `<span class="goals-red">${(plan.goals||"" ).replace(/\n/g,"<br>")}</span>`;

        // جدول الإحصائيات
        let inspectorShopCounts = {}, morningCounts = {}, eveningCounts = {}, weekendCounts = {};
        (plan.inspectors||[]).forEach(inspector=>{
          inspectorShopCounts[inspector]=0;
          morningCounts[inspector]=0;
          eveningCounts[inspector]=0;
          weekendCounts[inspector]=0;
        });
        (plan.distribution||[]).forEach(row=>{
          if (!row.inspector || !plan.inspectors.includes(row.inspector)) return;
          let shopsCount = row.shops ? row.shops.length : 0;
          let shift = row.shift || "";
          let inspector = row.inspector;
          let dayStr = row.day;
          let isWeekend = false;
          if (dayStr) {
            let d = new Date(dayStr);
            let dayOfWeek = d.getDay();
            if (dayOfWeek === 5 || dayOfWeek === 6 || dayOfWeek === 0) isWeekend = true;
          }
          inspectorShopCounts[inspector] += shopsCount;
          if (shift === "صباحية") morningCounts[inspector] += shopsCount;
          if (shift === "مسائية") eveningCounts[inspector] += shopsCount;
          if (isWeekend) weekendCounts[inspector] += shopsCount;
        });
        let statsHtml = `<table class="stats-table">
          <thead>
            <tr>
              <th class="stats-inspector-col">اسم المفتش</th>
              <th>عدد التفتيشات (كل الشهر)</th>
              <th>عدد التفتيشات الصباحية</th>
              <th>عدد التفتيشات المسائية</th>
              <th>عدد التفتيشات في العطلة (جمعة/سبت/أحد)</th>
            </tr>
          </thead>
          <tbody>`;
        (plan.inspectors||[]).forEach(name=>{
          statsHtml += `<tr>
            <td class="stats-inspector-col">${name}</td>
            <td>${inspectorShopCounts[name]}</td>
            <td>${morningCounts[name]}</td>
            <td>${eveningCounts[name]}</td>
            <td>${weekendCounts[name]}</td>
          </tr>`;
        });
        statsHtml += `</tbody>
          <tfoot>
            <tr>
              <td class="stats-total-cell">مجموع التفتيش</td>
              <td class="stats-total-cell">${Object.values(inspectorShopCounts).reduce((a,b)=>a+b,0)}</td>
              <td class="stats-total-cell">${Object.values(morningCounts).reduce((a,b)=>a+b,0)}</td>
              <td class="stats-total-cell">${Object.values(eveningCounts).reduce((a,b)=>a+b,0)}</td>
              <td class="stats-total-cell">${Object.values(weekendCounts).reduce((a,b)=>a+b,0)}</td>
            </tr>
          </tfoot>
        </table>`;
        document.getElementById("stats").innerHTML = statsHtml;

        // إنشاء واجهة إدارة التوزيع
        createDistributionManager(plan);
      })
      .catch(()=>{
        document.getElementById("planTable").innerHTML='<p style="color:#c00; font-weight:bold;">تعذر تحميل الخطة من الخادم!</p>';
      });

    // متغيرات عامة لإدارة التوزيع
    let currentPlan = {};
    let editingIndex = -1;

    // إنشاء واجهة إدارة التوزيع
    function createDistributionManager(plan) {
      currentPlan = plan;
      
      let html = `
        <div class="distribution-form">
          <h3 style="color:#2336a0; margin-top:0;">إضافة توزيع جديد</h3>
          <div class="form-row">
            <div class="form-group">
              <label>المفتش</label>
              <select id="inspectorSelect">
                <option value="">اختر المفتش</option>
                ${(plan.inspectors || []).map(inspector => 
                  `<option value="${inspector}">${inspector}</option>`
                ).join('')}
              </select>
            </div>
            <div class="form-group">
              <label>اليوم</label>
              <input type="date" id="dayInput">
            </div>
            <div class="form-group">
              <label>وقت المناوبة</label>
              <select id="shiftSelect">
                <option value="">اختر الوقت</option>
                <option value="صباحية">صباحية</option>
                <option value="مسائية">مسائية</option>
              </select>
            </div>
            <div class="form-group">
              <label>المنطقة</label>
              <select id="areaSelect" onchange="updateShopsForArea()">
                <option value="">اختر المنطقة</option>
                ${Object.keys(plan.shopsByArea || {}).map(area => 
                  `<option value="${area}">${area}</option>`
                ).join('')}
              </select>
            </div>
          </div>
          <div id="shopsSelection" class="shops-checkboxes" style="display:none;">
            <strong style="color:#2336a0; width:100%; display:block; margin-bottom:10px;">اختر المحلات:</strong>
          </div>
          <div class="form-row">
            <button class="btn" onclick="addDistribution()">إضافة التوزيع</button>
            <button class="btn btn-secondary" onclick="cancelEdit()" style="display:none;" id="cancelBtn">إلغاء التعديل</button>
          </div>
        </div>
        <div class="distribution-table">
          <h3 style="color:#2336a0;">التوزيعات الحالية</h3>
          <table id="distributionTable">
            <thead>
              <tr>
                <th>المفتش</th>
                <th>اليوم</th>
                <th>المناوبة</th>
                <th>المنطقة</th>
                <th>المحلات</th>
                <th>العمليات</th>
              </tr>
            </thead>
            <tbody id="distributionTableBody">
            </tbody>
          </table>
        </div>
      `;
      
      document.getElementById("distributionManager").innerHTML = html;
      updateDistributionTable();
    }

    // تحديث المحلات حسب المنطقة المختارة
    function updateShopsForArea() {
      const areaSelect = document.getElementById("areaSelect");
      const shopsContainer = document.getElementById("shopsSelection");
      const selectedArea = areaSelect.value;
      
      if (!selectedArea) {
        shopsContainer.style.display = "none";
        return;
      }
      
      const shops = currentPlan.shopsByArea[selectedArea] || [];
      let shopsHtml = '<strong style="color:#2336a0; width:100%; display:block; margin-bottom:10px;">اختر المحلات:</strong>';
      
      shops.forEach(shop => {
        shopsHtml += `
          <div class="shop-checkbox">
            <input type="checkbox" id="shop_${shop}" value="${shop}">
            <label for="shop_${shop}">${shop}</label>
          </div>
        `;
      });
      
      shopsContainer.innerHTML = shopsHtml;
      shopsContainer.style.display = "block";
    }

    // إضافة توزيع جديد
    function addDistribution() {
      const inspector = document.getElementById("inspectorSelect").value;
      const day = document.getElementById("dayInput").value;
      const shift = document.getElementById("shiftSelect").value;
      const area = document.getElementById("areaSelect").value;
      
      if (!inspector || !day || !shift || !area) {
        alert("يرجى ملء جميع الحقول المطلوبة!");
        return;
      }
      
      // جمع المحلات المختارة
      const shopCheckboxes = document.querySelectorAll('#shopsSelection input[type="checkbox"]:checked');
      const selectedShops = Array.from(shopCheckboxes).map(cb => cb.value);
      
      if (selectedShops.length === 0) {
        alert("يرجى اختيار محل واحد على الأقل!");
        return;
      }
      
      const newDistribution = {
        inspector: inspector,
        day: day,
        shift: shift,
        area: area,
        shops: selectedShops
      };
      
      if (editingIndex >= 0) {
        // تعديل توزيع موجود
        currentPlan.distribution[editingIndex] = newDistribution;
        editingIndex = -1;
        document.getElementById("cancelBtn").style.display = "none";
      } else {
        // إضافة توزيع جديد
        if (!currentPlan.distribution) currentPlan.distribution = [];
        currentPlan.distribution.push(newDistribution);
      }
      
      // إعادة تعيين النموذج
      resetForm();
      updateDistributionTable();
      updateMainPlanTable();
    }

    // إلغاء التعديل
    function cancelEdit() {
      editingIndex = -1;
      resetForm();
      document.getElementById("cancelBtn").style.display = "none";
    }

    // إعادة تعيين النموذج
    function resetForm() {
      document.getElementById("inspectorSelect").value = "";
      document.getElementById("dayInput").value = "";
      document.getElementById("shiftSelect").value = "";
      document.getElementById("areaSelect").value = "";
      document.getElementById("shopsSelection").style.display = "none";
    }

    // تحديث جدول التوزيعات
    function updateDistributionTable() {
      const tbody = document.getElementById("distributionTableBody");
      let html = "";
      
      (currentPlan.distribution || []).forEach((dist, index) => {
        html += `
          <tr>
            <td class="inspector-label">${dist.inspector}</td>
            <td>${dist.day}</td>
            <td>${dist.shift}</td>
            <td class="area-label">${dist.area}</td>
            <td>${(dist.shops || []).map(shop => `<span class="shop-badge">${shop}</span>`).join(' ')}</td>
            <td class="distribution-actions">
              <button class="btn btn-small" onclick="editDistribution(${index})">تعديل</button>
              <button class="btn btn-small btn-danger" onclick="deleteDistribution(${index})">حذف</button>
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    }

    // تعديل توزيع
    function editDistribution(index) {
      const dist = currentPlan.distribution[index];
      editingIndex = index;
      
      document.getElementById("inspectorSelect").value = dist.inspector;
      document.getElementById("dayInput").value = dist.day;
      document.getElementById("shiftSelect").value = dist.shift;
      document.getElementById("areaSelect").value = dist.area;
      
      // تحديث المحلات للمنطقة المختارة
      updateShopsForArea();
      
      // تحديد المحلات المختارة
      setTimeout(() => {
        (dist.shops || []).forEach(shop => {
          const checkbox = document.getElementById(`shop_${shop}`);
          if (checkbox) checkbox.checked = true;
        });
      }, 100);
      
      document.getElementById("cancelBtn").style.display = "inline-block";
    }

    // حذف توزيع
    function deleteDistribution(index) {
      if (confirm("هل أنت متأكد من حذف هذا التوزيع؟")) {
        currentPlan.distribution.splice(index, 1);
        updateDistributionTable();
        updateMainPlanTable();
      }
    }

    // تحديث جدول الخطة الرئيسي
    function updateMainPlanTable() {
      let html = `<table>
        <thead>
          <tr>
            <th>اسم المفتش</th>
            <th>اليوم</th>
            <th>وقت المناوبة</th>
            <th>المنطقة</th>
            <th>المحلات</th>
          </tr>
        </thead>
        <tbody>`;
      (currentPlan.distribution||[]).forEach(row=>{
        html += `<tr>
          <td class="inspector-label">${row.inspector||""}</td>
          <td>${row.day||""}</td>
          <td>${row.shift||""}</td>
          <td class="area-label">${row.area||""}</td>
          <td>${
            (row.shops||[]).map(shop=>`<span class="shop-badge">${shop}</span>`).join(" ")
          }</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById("planTable").innerHTML = html;
    }
  </script>
</body>
</html>
