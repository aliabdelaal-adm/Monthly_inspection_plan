<!DOCTYPE html>
<!-- Version 2.0.0 - ABSOLUTE ZERO-CACHE STRATEGY for instant updates -->
<!-- Last Updated: 2025-10-19 - Complete cache prevention for Safari, Chrome, Firefox (mobile/desktop) -->
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ÿ£ÿØÿßÿ© ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑ ÿßŸÑÿ∞ŸÉŸäÿ© ŸÑŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿä</title>
    
    <!-- ABSOLUTE CACHE PREVENTION - Works on ALL browsers including Safari, Chrome and Firefox -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, max-stale=0, post-check=0, pre-check=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Safari-specific cache prevention -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Chrome mobile-specific cache prevention -->
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Additional cache control for aggressive browsers -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="cleartype" content="on">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .feature-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .feature-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .feature-card h3 {
            color: #2d3561;
            margin-bottom: 5px;
        }
        
        .feature-card p {
            color: #666;
            font-size: 0.9em;
        }
        
        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.8em;
            color: #2d3561;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #2d3561;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102,126,234,0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(17,153,142,0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(17,153,142,0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(250,112,154,0.3);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(250,112,154,0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 600;
            display: none;
        }
        
        .status-message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .status-message.warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
        }
        
        .shops-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .shop-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .shop-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.2);
        }
        
        .shop-card.selected {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .shop-card.very-high-priority {
            border-left: 5px solid #8b0000;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
        }
        
        .shop-card.high-priority {
            border-left: 5px solid #dc3545;
        }
        
        .shop-card.medium-priority {
            border-left: 5px solid #ffc107;
        }
        
        .shop-card.low-priority {
            border-left: 5px solid #28a745;
        }
        
        .shop-card .priority-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .shop-card .priority-badge.very-high {
            background: #8b0000;
            color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .shop-card .priority-badge.high {
            background: #dc3545;
            color: white;
        }
        
        .shop-card .priority-badge.medium {
            background: #ffc107;
            color: #212529;
        }
        
        .shop-card .priority-badge.low {
            background: #28a745;
            color: white;
        }
        
        .shop-card .shop-name {
            font-weight: 600;
            color: #2d3561;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .shop-card .shop-info {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .shop-card .last-inspection {
            font-size: 0.85em;
            color: #999;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }
        
        .selected-shops {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .selected-shops h3 {
            color: #1565c0;
            margin-bottom: 15px;
        }
        
        .selected-shops-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .selected-shop-tag {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .selected-shop-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .selected-shop-tag .remove:hover {
            color: #ffcccc;
        }
        
        .filter-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        
        .stat-box .value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-box .label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .inspection-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }
        
        .inspection-preview h3 {
            color: #2d3561;
            margin-bottom: 15px;
        }
        
        .inspection-preview .preview-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .inspection-preview .preview-item strong {
            color: #667eea;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* New styles for enhanced features */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 12px 24px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            background: #f0f0ff;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .inspections-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .inspections-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .inspections-table th,
        .inspections-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .inspections-table tbody tr:hover {
            background: #f5f5f5;
        }
        
        .action-icon {
            cursor: pointer;
            font-size: 1.3em;
            margin: 0 5px;
            transition: transform 0.2s;
        }
        
        .action-icon:hover {
            transform: scale(1.2);
        }
        
        .edit-icon { color: #ffc107; }
        .delete-icon { color: #dc3545; }
        .copy-icon { color: #17a2b8; }
        
        /* Professional Action Buttons for Shops and Areas Management */
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 14px;
            border: 2px solid transparent;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .action-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .action-btn span:first-child {
            font-size: 1.2em;
        }
        
        .action-btn-text {
            font-size: 0.85em;
        }
        
        .action-btn-view {
            border-color: #3498db;
            color: #3498db;
        }
        
        .action-btn-view:hover {
            background: #3498db;
            color: white;
        }
        
        .action-btn-edit {
            border-color: #f39c12;
            color: #f39c12;
        }
        
        .action-btn-edit:hover {
            background: #f39c12;
            color: white;
        }
        
        .action-btn-delete {
            border-color: #e74c3c;
            color: #e74c3c;
        }
        
        .action-btn-delete:hover {
            background: #e74c3c;
            color: white;
        }
        
        .action-btn-copy {
            border-color: #1abc9c;
            color: #1abc9c;
        }
        
        .action-btn-copy:hover {
            background: #1abc9c;
            color: white;
        }
        
        .action-btn-map {
            border-color: #27ae60;
            color: #27ae60;
        }
        
        .action-btn-map:hover {
            background: #27ae60;
            color: white;
        }
        
        /* Responsive for smaller screens */
        @media (max-width: 768px) {
            .action-btn-text {
                display: none;
            }
            
            .action-btn {
                padding: 8px 10px;
            }
        }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        
        .inspector-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-card .stat-label {
            font-size: 1em;
            color: #2d3561;
            margin-top: 5px;
        }
        
        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .calendar-day {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            min-height: 100px;
            position: relative;
        }
        
        .calendar-day .day-number {
            font-weight: 700;
            color: #2d3561;
            margin-bottom: 10px;
        }
        
        .calendar-day .inspection-badge {
            background: #667eea;
            color: white;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            margin-bottom: 5px;
            display: block;
        }
        
        .calendar-day.has-inspection {
            border-color: #667eea;
            background: #f0f0ff;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        /* Smart shop list modal should be below shop edit modal */
        #smartShopListModal {
            z-index: 1500;
        }
        
        /* Shop edit/add modal should appear on top of other modals */
        #shopModal {
            z-index: 2000;
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #2d3561;
        }
        
        .modal-close {
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
        }
        
        .search-box .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(231,76,60,0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(231,76,60,0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(52,152,219,0.3);
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52,152,219,0.4);
        }
        
        /* Bell Notification Control Styles */
        .bell-control-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .bell-control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5);
        }
        
        .bell-control-btn:active {
            transform: translateY(-1px);
        }
        
        /* Hand Gesture Control Styles */
        .gesture-control-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .gesture-control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.5);
        }
        
        .gesture-control-btn:active {
            transform: translateY(-1px);
        }
        
        .gesture-control-btn.active {
            background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
            }
            50% {
                box-shadow: 0 5px 30px rgba(56, 239, 125, 0.6);
            }
        }
        
        /* Background Music Volume Control Styles */
        .volume-control-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .volume-control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.5);
        }
        
        .volume-control-btn:active {
            transform: translateY(-1px);
        }
        
        .volume-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .volume-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .volume-modal-content {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            margin: auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            color: white;
            position: relative;
        }
        
        .volume-close {
            color: white;
            float: left;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .volume-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .volume-slider-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .volume-slider {
            width: 100%;
            height: 12px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .volume-slider::-moz-range-thumb {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: none;
        }
        
        .volume-display-big {
            font-size: 3em;
            font-weight: 900;
            text-align: center;
            margin: 20px 0;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .volume-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .volume-preset-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.4);
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .volume-preset-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
        }
        
        .volume-preset-btn:active {
            transform: translateY(0);
        }
        
        .gesture-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .gesture-modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 50px auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            color: white;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .gesture-close {
            color: white;
            float: left;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .gesture-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .gesture-video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .gesture-video {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1);
        }
        
        .gesture-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }
        
        .gesture-status {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .gesture-status h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .gesture-detected {
            font-size: 2em;
            font-weight: bold;
            color: #38ef7d;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(56, 239, 125, 0.5);
        }
        
        .gesture-guide {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .gesture-guide h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .gesture-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .gesture-icon {
            font-size: 2em;
            min-width: 50px;
            text-align: center;
        }
        
        .gesture-description {
            flex: 1;
        }
        
        .gesture-description strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .gesture-description span {
            opacity: 0.9;
            font-size: 0.95em;
        }
        
        .bell-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        
        .bell-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .bell-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }
        
        .bell-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        
        .bell-modal-header h2 {
            color: #2d3561;
            font-size: 2em;
            margin: 0;
        }
        
        .bell-modal-close {
            background: #e74c3c;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bell-modal-close:hover {
            transform: rotate(90deg);
            background: #c0392b;
        }
        
        .notification-add-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #dee2e6;
        }
        
        .notification-add-section h3 {
            color: #2d3561;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        .notification-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.3s ease;
        }
        
        .notification-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .notification-author-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ced4da;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            margin-top: 10px;
        }
        
        .notification-author-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .notification-add-btn {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s ease;
        }
        
        .notification-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .notifications-list {
            margin-top: 25px;
        }
        
        .notification-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .notification-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .notification-text {
            color: #2d3561;
            font-size: 1.05em;
            line-height: 1.6;
            margin-bottom: 12px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }
        
        .notification-text:hover {
            background: #f8f9fa;
        }
        
        .notification-edit-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            resize: vertical;
            min-height: 80px;
            display: none;
        }
        
        .notification-meta {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 12px;
        }
        
        .notification-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .notification-action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .notification-save-btn {
            background: #28a745;
            color: white;
            display: none;
        }
        
        .notification-save-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .notification-cancel-btn {
            background: #6c757d;
            color: white;
            display: none;
        }
        
        .notification-cancel-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .notification-delete-btn {
            background: #dc3545;
            color: white;
        }
        
        .notification-delete-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .notification-move-btn {
            background: #17a2b8;
            color: white;
        }
        
        .notification-move-btn:hover {
            background: #138496;
            transform: translateY(-2px);
        }
        
        .notification-priority-btn {
            background: #ffc107;
            color: #212529;
        }
        
        .notification-priority-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .notification-item.priority-high {
            border-left: 5px solid #dc3545;
            background: linear-gradient(to right, #fff5f5 0%, white 10%);
        }
        
        .notification-item.priority-medium {
            border-left: 5px solid #ffc107;
            background: linear-gradient(to right, #fffbf0 0%, white 10%);
        }
        
        .notification-item.priority-low {
            border-left: 5px solid #28a745;
            background: linear-gradient(to right, #f0fff4 0%, white 10%);
        }
        
        .notification-settings {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border: 1px solid #dee2e6;
        }
        
        .notification-settings label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .notification-settings input,
        .notification-settings select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            margin-bottom: 10px;
        }
        
        .notification-settings input:focus,
        .notification-settings select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .bell-control-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #dee2e6;
        }
        
        .bell-control-panel h3 {
            color: #2d3561;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        .bell-control-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .bell-control-item {
            flex: 1;
            min-width: 200px;
        }
        
        .bell-control-item label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .bell-control-item input,
        .bell-control-item select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
        }
        
        .bell-bulk-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .bell-bulk-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95em;
        }
        
        .bell-bulk-btn:hover {
            transform: translateY(-2px);
        }
        
        .bell-save-all-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }
        
        .bell-save-all-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }
        
        .bell-status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .bell-status-message.show {
            display: block;
        }
        
        .bell-status-message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .bell-status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    
    <!-- SheetJS library for Excel import/export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- jsPDF library for PDF export with Arabic support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.1/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ ÿ£ÿØÿßÿ© ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑ ÿßŸÑÿ∞ŸÉŸäÿ© ŸÑŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿä</h1>
            <p>ŸÜÿ∏ÿßŸÖ ÿ∞ŸÉŸä ŸàŸÖÿ±ŸÜ ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸàŸÅŸàÿ±ÿßŸã ŸÖÿπ ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ∞ÿßÿ™ ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©</p>
        </div>
        
        <div class="features">
            <div class="feature-card">
                <div class="icon">‚ö°</div>
                <h3>ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸàÿ±Ÿä</h3>
                <p>ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿ™ÿ∏Ÿáÿ± ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿØŸàŸÜ ÿ±ŸÅÿπ ŸÖŸÑŸÅÿßÿ™</p>
            </div>
            <div class="feature-card">
                <div class="icon">üéØ</div>
                <h3>ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑÿ∞ŸÉŸäÿ©</h3>
                <p>ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ∞ÿßÿ™ ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑÿπÿßŸÑŸäÿ© ÿ™ÿ∏Ÿáÿ± ÿ£ŸàŸÑÿßŸã</p>
            </div>
            <div class="feature-card">
                <div class="icon">üö´</div>
                <h3>ŸÖŸÜÿπ ÿßŸÑÿ™ŸÉÿ±ÿßÿ±</h3>
                <p>ÿ™ÿ¨ŸÜÿ® ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ© ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ</p>
            </div>
            <div class="feature-card">
                <div class="icon">üìÖ</div>
                <h3>ŸÅÿ™ÿ±ÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</h3>
                <p>ÿ£ÿ≥ÿ®Ÿàÿπ Ÿàÿßÿ≠ÿØ ŸÇÿ®ŸÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥</p>
            </div>
            <div class="feature-card">
                <div class="icon">üìù</div>
                <h3>ÿ™ÿ≠ÿ±Ÿäÿ± ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</h3>
                <p>ÿ•ŸÖŸÉÿßŸÜŸäÿ© ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©</p>
            </div>
            <div class="feature-card">
                <div class="icon">üëÅÔ∏è</div>
                <h3>ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</h3>
                <p>ŸÖÿ¥ÿßŸáÿØÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÑŸÉŸÑ ŸÖŸÅÿ™ÿ¥</p>
            </div>
            <div class="feature-card">
                <div class="icon">üóëÔ∏è</div>
                <h3>ÿ≠ÿ∞ŸÅ ÿ™ŸÑŸÇÿßÿ¶Ÿä</h3>
                <p>ÿ≠ÿ∞ŸÅ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã</p>
            </div>
            <div class="feature-card">
                <div class="icon">üìä</div>
                <h3>ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ¥ÿßŸÖŸÑÿ©</h3>
                <p>ÿ™ŸÇÿßÿ±Ÿäÿ± ÿ™ŸÅÿµŸäŸÑŸäÿ© ŸÑŸÉŸÑ ŸÖŸÅÿ™ÿ¥</p>
            </div>
        </div>
        
        <!-- Quick Links & Smart Actions Toolbar -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
            <h3 style="color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <span>‚ö°</span>
                <span>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ© ŸàÿßŸÑÿ∞ŸÉŸäÿ©</span>
            </h3>
            
            <!-- Navigation Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <a href="admin-dashboard.html" style="text-decoration: none;">
                    <button class="btn btn-warning" style="background: white; color: #667eea;">
                        <span>üìä</span>
                        <span>ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
                    </button>
                </a>
                <a href="index.html" style="text-decoration: none;">
                    <button class="btn btn-info" style="background: white; color: #3498db;">
                        <span>üè†</span>
                        <span>ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
                    </button>
                </a>
                <button class="btn btn-success" onclick="openQuickAddInspection()" style="background: white; color: #11998e;">
                    <span>‚ö°</span>
                    <span>ÿ•ÿ∂ÿßŸÅÿ© ÿ™ŸÅÿ™Ÿäÿ¥ ÿ≥ÿ±Ÿäÿπ</span>
                </button>
            </div>
            
            <!-- Data Management Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="importFromExcel()" style="background: white; color: #667eea;">
                    <span>üì•</span>
                    <span>ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÜ Excel</span>
                </button>
                <button class="btn btn-primary" onclick="exportAllData()" style="background: white; color: #667eea;">
                    <span>üì§</span>
                    <span>ÿ™ÿµÿØŸäÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                </button>
                <button class="btn btn-primary" onclick="syncWithGitHub()" style="background: white; color: #667eea;">
                    <span>üîÑ</span>
                    <span>ŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub</span>
                </button>
                <button class="btn btn-danger" onclick="createBackup()" style="background: white; color: #e74c3c;">
                    <span>üíæ</span>
                    <span>ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©</span>
                </button>
            </div>
            
            <!-- Analysis & Reports Buttons -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="generateFullReport()" style="background: white; color: #11998e;">
                    <span>üìà</span>
                    <span>ÿ™ŸÇÿ±Ÿäÿ± ÿ¥ÿßŸÖŸÑ</span>
                </button>
                <button class="btn btn-warning" onclick="checkDataQuality()" style="background: white; color: #fa709a;">
                    <span>üîç</span>
                    <span>ŸÅÿ≠ÿµ ÿ¨ŸàÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                </button>
                <button class="btn btn-info" onclick="viewSystemLogs()" style="background: white; color: #3498db;">
                    <span>üìã</span>
                    <span>ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ</span>
                </button>
                <button class="btn btn-success" onclick="bulkOperations()" style="background: white; color: #11998e;">
                    <span>‚öôÔ∏è</span>
                    <span>ÿπŸÖŸÑŸäÿßÿ™ ÿ¨ŸÖÿßÿπŸäÿ©</span>
                </button>
            </div>
            
            <!-- Bell Notifications Control Button -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(255, 255, 255, 0.3);">
                <button class="bell-control-btn" onclick="openBellNotificationsControl()">
                    <span style="font-size: 1.3em;">üîî</span>
                    <span>ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ¨ÿ±ÿ≥</span>
                    <span style="font-size: 0.85em; opacity: 0.9;">(ÿ•ÿØÿßÿ±ÿ© ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖŸàŸÇÿπ)</span>
                </button>
            </div>
            
            <!-- Hand Gesture Control Button -->
            <div style="margin-top: 15px;">
                <button class="gesture-control-btn" id="gestureControlBtn" onclick="toggleGestureControl()">
                    <span style="font-size: 1.3em;">‚úã</span>
                    <span>ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿ®ÿ≠ÿ±ŸÉÿ© ÿßŸÑŸäÿØ</span>
                    <span style="font-size: 0.85em; opacity: 0.9;">(ÿ™ÿ≠ŸÉŸÖ ÿ∞ŸÉŸä ÿ®ÿØŸàŸÜ ŸÑŸÖÿ≥)</span>
                </button>
            </div>
            
            <!-- Background Music Volume Control Button -->
            <div style="margin-top: 15px;">
                <button class="volume-control-btn" id="volumeControlBtn" onclick="openVolumeControl()">
                    <span style="font-size: 1.3em;">üîä</span>
                    <span>ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿµŸàÿ™ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ÿßŸÑÿÆŸÑŸÅŸäÿ©</span>
                    <span style="font-size: 0.85em; opacity: 0.9;">(ÿ∂ÿ®ÿ∑ ÿ¥ÿØÿ© ÿßŸÑÿµŸàÿ™)</span>
                </button>
            </div>
        </div>
        
        <!-- Login Section -->
        <div class="section" id="loginSection">
            <h2 class="section-title">üîê ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÉŸÖÿ∑Ÿàÿ±</h2>
            <div class="form-group">
                <label class="form-label">GitHub Token (ŸÑŸÑÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±)</label>
                <input type="password" id="githubToken" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <small style="color: #666; display: block; margin-top: 5px;">
                    ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿßŸÑÿ™ŸàŸÉŸÜ ŸÖŸÜ: GitHub Settings ‚Üí Developer Settings ‚Üí Personal Access Tokens
                </small>
            </div>
            <button class="btn btn-primary" onclick="loginDeveloper()">
                <span>‚úì</span>
                <span>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</span>
            </button>
            <div class="status-message" id="loginStatus"></div>
        </div>
        
        <!-- Main Interface with Tabs -->
        <div id="mainInterface" style="display: none;">
            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('add')">
                    <span>‚ûï</span> ÿ•ÿ∂ÿßŸÅÿ© ÿ™ŸÅÿ™Ÿäÿ¥ ÿ¨ÿØŸäÿØ
                </button>
                <button class="tab-button" onclick="switchTab('view')">
                    <span>üëÅÔ∏è</span> ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™
                </button>
                <button class="tab-button" onclick="switchTab('stats')">
                    <span>üìä</span> ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ
                </button>
                <button class="tab-button" onclick="switchTab('calendar')">
                    <span>üìÖ</span> ÿßŸÑÿ™ŸÇŸàŸäŸÖ ÿßŸÑÿ¥Ÿáÿ±Ÿä
                </button>
                <button class="tab-button" onclick="switchTab('shops')">
                    <span>üè™</span> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
                </button>
                <button class="tab-button" onclick="switchTab('areas')">
                    <span>üó∫Ô∏è</span> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
                </button>
                <button class="tab-button" onclick="switchTab('maintenance')">
                    <span>üîß</span> ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ∞ŸÉŸä ŸÅŸä ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´
                </button>
            </div>
            
            <!-- Tab Content: Add Inspection -->
            <div id="addTab" class="tab-content active">
                <div class="section">
            <h2 class="section-title">üìù ÿ•ÿ∂ÿßŸÅÿ© ÿ™ŸÅÿ™Ÿäÿ¥ ÿ¨ÿØŸäÿØ</h2>
            
            <div class="form-group">
                <label class="form-label">ÿßŸÑŸÖŸÅÿ™ÿ¥</label>
                <select id="inspectorSelect" class="form-control" onchange="updateAvailableShops()">
                    <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</label>
                <input type="date" id="inspectionDate" class="form-control" onchange="updateAvailableShops()">
            </div>
            
            <div class="form-group">
                <label class="form-label">ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©</label>
                <select id="shiftSelect" class="form-control">
                    <option value="ÿµÿ®ÿßÿ≠Ÿäÿ©">ÿµÿ®ÿßÿ≠Ÿäÿ©</option>
                    <option value="ŸÖÿ≥ÿßÿ¶Ÿäÿ©">ŸÖÿ≥ÿßÿ¶Ÿäÿ©</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</label>
                <select id="areaSelect" class="form-control" onchange="updateAvailableShops()">
                    <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©...</option>
                </select>
            </div>
            
            <!-- Filter Statistics -->
            <div class="filter-stats">
                <div class="stat-box">
                    <div class="value" id="totalShopsCount">0</div>
                    <div class="label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="availableShopsCount">0</div>
                    <div class="label">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="highPriorityCount">0</div>
                    <div class="label">ÿ£ŸàŸÑŸàŸäÿ© ÿπÿßŸÑŸäÿ©</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="selectedShopsCount">0</div>
                    <div class="label">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©</div>
                </div>
            </div>
            
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label class="form-label" style="margin-bottom: 0;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© (ŸÖÿ±ÿ™ÿ®ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©)</label>
                    <button id="showHighPriorityBtn" class="btn btn-warning btn-sm" onclick="toggleHighPriorityShops()" style="display: none; padding: 8px 16px;">
                        <span id="highPriorityBtnIcon">üëÅÔ∏è</span>
                        <span id="highPriorityBtnText">ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ∞ÿßÿ™ ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑÿπÿßŸÑŸäÿ©</span>
                    </button>
                </div>
                
                <!-- Search box for shops in new inspection -->
                <div class="search-box" id="inspectionShopSearchBox" style="display: none; margin-bottom: 15px;">
                    <input type="text" id="inspectionShopSearch" class="form-control" 
                           placeholder="üîç ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≠ŸÑ ŸÖÿπŸäŸÜ (ÿ®ÿßŸÑÿßÿ≥ŸÖÿå ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿÆŸäÿµÿå ŸÉŸàÿØ ADM...)" 
                           oninput="filterInspectionShops()">
                    <span class="search-icon">üîç</span>
                </div>
                
                <div id="shopsListContainer">
                    <p style="text-align: center; color: #999; padding: 20px;">
                        ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥ ŸàÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©
                    </p>
                </div>
            </div>
            
            <!-- Selected Shops -->
            <div class="selected-shops" id="selectedShopsContainer" style="display: none;">
                <h3>ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ© ŸÑŸÑÿ™ŸÅÿ™Ÿäÿ¥</h3>
                <div class="selected-shops-list" id="selectedShopsList"></div>
            </div>
            
            <!-- Inspection Preview -->
            <div class="inspection-preview" id="inspectionPreview" style="display: none;">
                <h3>ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥</h3>
                <div class="preview-item">
                    <strong>ÿßŸÑŸÖŸÅÿ™ÿ¥:</strong> <span id="previewInspector">-</span>
                </div>
                <div class="preview-item">
                    <strong>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:</strong> <span id="previewDate">-</span>
                </div>
                <div class="preview-item">
                    <strong>ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©:</strong> <span id="previewShift">-</span>
                </div>
                <div class="preview-item">
                    <strong>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:</strong> <span id="previewArea">-</span>
                </div>
                <div class="preview-item">
                    <strong>ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™:</strong> <span id="previewShopsCount">0</span>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveInspection()" id="saveBtn" disabled>
                    <span>üíæ</span>
                    <span>ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ŸÅŸàÿ±ÿßŸã</span>
                </button>
                <button class="btn btn-warning" onclick="resetForm()">
                    <span>üîÑ</span>
                    <span>ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ</span>
                </button>
            </div>
            
            <div class="status-message" id="planningStatus"></div>
                </div>
            </div>
            
            <!-- Tab Content: View Inspections -->
            <div id="viewTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">üëÅÔ∏è ÿπÿ±ÿ∂ Ÿàÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</h2>
                    
                    <!-- Filter Bar -->
                    <div class="filter-bar">
                        <div class="filter-item">
                            <label class="form-label">ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸÅÿ™ÿ¥</label>
                            <select id="filterInspector" class="form-control" onchange="filterInspections()">
                                <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</label>
                            <select id="filterArea" class="form-control" onchange="filterInspections()">
                                <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ</label>
                            <input type="date" id="filterDateFrom" class="form-control" onchange="filterInspections()">
                        </div>
                        <div class="filter-item">
                            <label class="form-label">ÿ•ŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ</label>
                            <input type="date" id="filterDateTo" class="form-control" onchange="filterInspections()">
                        </div>
                    </div>
                    
                    <!-- Search Box -->
                    <div class="search-box">
                        <input type="text" id="searchBox" class="form-control" 
                               placeholder="ÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ (ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÅÿ™ÿ¥ÿå ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©ÿå ÿßŸÑŸÖÿ≠ŸÑÿßÿ™...)" 
                               oninput="filterInspections()">
                        <span class="search-icon">üîç</span>
                    </div>
                    
                    <!-- Inspections Table -->
                    <div id="inspectionsTableContainer">
                        <p style="text-align: center; color: #999; padding: 40px;">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™...</p>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-danger btn-sm" onclick="deleteSelectedInspections()">
                            <span>üóëÔ∏è</span> ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ÿØÿØ
                        </button>
                        <button class="btn btn-info btn-sm" onclick="exportInspections()">
                            <span>üì•</span> ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Statistics -->
            <div id="statsTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">üìä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</h2>
                    
                    <div class="form-group">
                        <label class="form-label">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥</label>
                        <select id="statsInspector" class="form-control" onchange="loadInspectorStats()">
                            <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥...</option>
                        </select>
                    </div>
                    
                    <div id="statsContainer">
                        <div class="empty-state">
                            <div class="icon">üìä</div>
                            <p>ÿßÿÆÿ™ÿ± ŸÖŸÅÿ™ÿ¥ÿßŸã ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Calendar -->
            <div id="calendarTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">üìÖ ÿßŸÑÿ™ŸÇŸàŸäŸÖ ÿßŸÑÿ¥Ÿáÿ±Ÿä</h2>
                    
                    <div class="form-group">
                        <label class="form-label">ÿßÿÆÿ™ÿ± ÿßŸÑÿ¥Ÿáÿ±</label>
                        <input type="month" id="calendarMonth" class="form-control" onchange="loadCalendar()">
                    </div>
                    
                    <div id="calendarContainer">
                        <div class="empty-state">
                            <div class="icon">üìÖ</div>
                            <p>ÿßÿÆÿ™ÿ± ÿßŸÑÿ¥Ÿáÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇŸàŸäŸÖ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Shops Management -->
            <div id="shopsTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">üè™ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÉÿßŸÖŸÑÿ©</h2>
                    
                    <!-- Smart Action Buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="openAddShopModal()">
                            <span>‚ûï</span> ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ
                        </button>
                        <button class="btn btn-primary" onclick="refreshShopsList()">
                            <span>üîÑ</span> ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
                        </button>
                        <button class="btn btn-primary" onclick="reloadShopsFromExcel()">
                            <span>üì•</span> ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜ Excel
                        </button>
                        <button class="btn btn-warning" onclick="exportShopsData()">
                            <span>üì§</span> ÿ™ÿµÿØŸäÿ± JSON
                        </button>
                        <button class="btn btn-info" onclick="exportShopsToExcel()">
                            <span>üìä</span> ÿ™ÿµÿØŸäÿ± Excel
                        </button>
                        <button class="btn btn-danger" onclick="bulkEditShops()">
                            <span>‚úèÔ∏è</span> ÿ™ÿπÿØŸäŸÑ ÿ¨ŸÖÿßÿπŸä
                        </button>
                        <button class="btn btn-danger" onclick="bulkDeleteShops()">
                            <span>üóëÔ∏è</span> ÿ≠ÿ∞ŸÅ ÿ¨ŸÖÿßÿπŸä
                        </button>
                        <button class="btn btn-success" onclick="mergeShopsData()">
                            <span>üîó</span> ÿØŸÖÿ¨ ÿ®ŸäÿßŸÜÿßÿ™
                        </button>
                        <button class="btn btn-info" onclick="validateShopsData()">
                            <span>‚úÖ</span> ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                        </button>
                        <button class="btn btn-secondary" onclick="findOrphanShops()" style="background: #6c757d; border: none;">
                            <span>üîç</span> ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿπÿ≤ŸàŸÑÿ©
                        </button>
                        <button class="btn btn-warning" onclick="viewShopsOnMap()">
                            <span>üó∫Ô∏è</span> ÿπÿ±ÿ∂ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©
                        </button>
                        <button class="btn btn-success" onclick="openSmartShopListModal()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; font-weight: bold;">
                            <span>üìã</span> ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©
                        </button>
                        <button class="btn btn-success" onclick="openShopsByAreaModal()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; font-weight: bold;">
                            <span>üèòÔ∏è</span> ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ±ÿ™ÿ®ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©
                        </button>
                        <button class="btn btn-warning" onclick="openMoveShopsModal()" style="border: none; font-weight: bold;">
                            <span>‚ÜîÔ∏è</span> ŸÜŸÇŸÑ ŸÖÿ≠ŸÑÿßÿ™ ÿ®ŸäŸÜ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
                        </button>
                    </div>
                    
                    <!-- Filter and Search -->
                    <div class="filter-bar">
                        <div class="filter-item">
                            <label class="form-label">ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≠ŸÑ</label>
                            <input type="text" id="searchShop" class="form-control" 
                                   placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ..." oninput="filterShopsList()">
                        </div>
                        <div class="filter-item">
                            <label class="form-label">ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</label>
                            <select id="filterShopArea" class="form-control" onchange="filterShopsList()">
                                <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Shops Stats -->
                    <div class="inspector-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalShopsManagement">0</div>
                            <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="filteredShopsCount">0</div>
                            <div class="stat-label">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ÿ©</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalAreasInShops">0</div>
                            <div class="stat-label">ÿπÿØÿØ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</div>
                        </div>
                    </div>
                    
                    <!-- Shops List Table -->
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table class="inspections-table" id="shopsManagementTable">
                            <thead>
                                <tr>
                                    <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ</th>
                                    <th>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                                    <th>ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿπÿ±ŸäŸÅ</th>
                                    <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                                </tr>
                            </thead>
                            <tbody id="shopsManagementBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 40px;">
                                        ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="status-message" id="shopsManagementStatus"></div>
                </div>
            </div>
            
            <!-- Tab Content: Maintenance Control -->
            <div id="maintenanceTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">üîß ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ∞ŸÉŸä ÿßŸÑŸÖÿ∑ŸÑŸÇ ŸÅŸä ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸàÿßŸÑŸÉÿßÿ¥</h2>
                    
                    <!-- Cache Control Section -->
                    <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>üöÄ</span>
                            <span>ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅŸàÿ±Ÿä ŸàŸÖÿ≥ÿ≠ ÿßŸÑŸÉÿßÿ¥ ŸàÿßŸÑÿ∞ÿßŸÉÿ±ÿ©</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            ÿ≤ÿ± ŸÇŸàŸä ŸÑŸÖÿ≥ÿ≠ ŸÉŸÑ ÿßŸÑŸÉÿßÿ¥ ŸàÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ÿßŸÑŸÖÿ§ŸÇÿ™ÿ© ŸÅŸàÿ±ÿßŸã ŸÅŸä GitHub ŸàÿßŸÑŸÖÿ™ÿµŸÅÿ≠ÿßÿ™ (Safari, Chrome, Firefox)
                        </p>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button id="clearCacheBtn" class="btn btn-danger" onclick="forceCacheClear()" style="background: white; color: #ff6b6b; font-weight: bold;">
                                <span id="clearCacheIcon">üöÄ</span>
                                <span id="clearCacheText">ŸÖÿ≥ÿ≠ ŸÇŸàŸä ŸàŸÅŸàÿ±Ÿä ŸÑŸÑŸÉÿßÿ¥ (Safari + Chrome + Firefox)</span>
                            </button>
                            <button id="updateSWBtn" class="btn btn-warning" onclick="updateServiceWorker()" style="background: white; color: #ee5a6f;">
                                <span id="updateSWIcon">üîÑ</span>
                                <span id="updateSWText">ÿ™ÿ≠ÿØŸäÿ´ Service Worker ŸÅŸàÿ±ÿßŸã</span>
                            </button>
                        </div>
                        <div class="status-message" id="cacheControlStatus"></div>
                    </div>
                    
                    <!-- Maintenance Message Control Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>üì∫</span>
                            <span>ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ∞ŸÉŸä ŸÅŸä ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ§ŸÇÿ™ÿ©</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            ÿ™ÿ≠ŸÉŸÖ ŸÉÿßŸÖŸÑ ŸàŸÖÿ®ÿßÿ¥ÿ± 100% ŸÅŸä ÿ∏ŸáŸàÿ± Ÿàÿ•ÿÆŸÅÿßÿ° Ÿàÿ™ŸÅÿπŸäŸÑ Ÿàÿ•ÿ∫ŸÑÿßŸÇ ÿ±ÿ≥ÿßŸÑÿ© "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ¢ŸÜ"
                        </p>
                        
                        <!-- Enable/Disable Toggle -->
                        <div class="form-group">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>üîò</span> ÿ≠ÿßŸÑÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´
                            </label>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <button id="enableMaintenanceBtn" class="btn btn-success" onclick="toggleMaintenanceMessage(true)" style="flex: 1;">
                                    <span>‚úÖ</span>
                                    <span>ÿ™ŸÅÿπŸäŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´</span>
                                </button>
                                <button id="disableMaintenanceBtn" class="btn btn-danger" onclick="toggleMaintenanceMessage(false)" style="flex: 1;">
                                    <span>‚ùå</span>
                                    <span>ÿ•ŸäŸÇÿßŸÅ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Current Status Display -->
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©:</span>
                                <span id="maintenanceStatusLabel" style="font-size: 1.1em; font-weight: 700;">‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</span>
                            </div>
                        </div>
                        
                        <div class="status-message" id="maintenanceToggleStatus"></div>
                    </div>
                    
                    <!-- Music Control Section -->
                    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>üéµ</span>
                            <span>ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ∞ŸÉŸä ÿßŸÑŸÖÿ∑ŸÑŸÇ ŸÅŸä ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            ÿ™ÿ≠ŸÉŸÖ ŸÅŸàÿ±Ÿä ŸàŸÖÿ®ÿßÿ¥ÿ± 100% ŸÅŸä ÿµŸàÿ™ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ Ÿàÿ™ŸÖŸÉŸäŸÜŸáÿß/ÿ™ÿπÿ∑ŸäŸÑŸáÿß ŸÖÿπ ÿßŸÑÿßŸÜÿπŸÉÿßÿ≥ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ± ŸÅŸä GitHub
                        </p>
                        
                        <!-- Music Enable/Disable -->
                        <div class="form-group">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>üîä</span> ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ
                            </label>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <button id="enableMusicBtn" class="btn btn-success" onclick="toggleMusic(true)" style="flex: 1;">
                                    <span>üîä</span>
                                    <span>ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ</span>
                                </button>
                                <button id="disableMusicBtn" class="btn btn-danger" onclick="toggleMusic(false)" style="flex: 1;">
                                    <span>üîá</span>
                                    <span>ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Volume Control -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>üéöÔ∏è</span> ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿµŸàÿ™ (ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ)
                            </label>
                            <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin-top: 10px;">
                                <input type="range" id="volumeSlider" min="0" max="100" value="10" 
                                       style="width: 100%; height: 8px; border-radius: 5px; cursor: pointer;"
                                       oninput="updateVolumeDisplay(this.value)"
                                       onchange="saveVolumeChange(this.value)">
                                <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9em;">
                                    <span>üîá 0%</span>
                                    <span id="volumeDisplay" style="font-size: 1.3em; font-weight: 700;">üîä 10%</span>
                                    <span>üîä 100%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Volume Presets -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" style="color: white; font-size: 1.1em;">
                                <span>‚ö°</span> ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ© ŸÑŸÑÿµŸàÿ™
                            </label>
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <button class="btn btn-sm" onclick="setVolumePreset(0)" style="background: white; color: #11998e;">
                                    <span>üîá</span> ŸÉÿ™ŸÖ ÿßŸÑÿµŸàÿ™
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(1)" style="background: white; color: #11998e;">
                                    <span>üîâ</span> 1% (ÿÆÿßŸÅÿ™ ÿ¨ÿØÿßŸã)
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(5)" style="background: white; color: #11998e;">
                                    <span>üîâ</span> 5% (ÿÆÿßŸÅÿ™)
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(10)" style="background: white; color: #11998e;">
                                    <span>üîâ</span> 10%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(25)" style="background: white; color: #11998e;">
                                    <span>üîâ</span> 25%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(40)" style="background: white; color: #11998e;">
                                    <span>üîä</span> 40%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(50)" style="background: white; color: #11998e;">
                                    <span>üîä</span> 50%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(75)" style="background: white; color: #11998e;">
                                    <span>üîä</span> 75%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(100)" style="background: white; color: #11998e;">
                                    <span>üîä</span> 100%
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tap to Stop Feature -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" style="color: white; font-size: 1.1em;">
                                <span>üëÜ</span> ŸÖŸäÿ≤ÿ© ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ±
                            </label>
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 10px;">
                                <p style="margin-bottom: 10px; font-size: 0.95em;">
                                    ÿ™ŸÅÿπŸäŸÑ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ© Ÿäÿ¨ÿπŸÑ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ÿ™ÿ™ŸàŸÇŸÅ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿ£Ÿä ŸÖŸÉÿßŸÜ ŸÅŸä ÿßŸÑÿ¥ÿßÿ¥ÿ©
                                </p>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-sm" onclick="setTapToStop(true)" style="background: white; color: #11998e; flex: 1;">
                                        <span>‚úÖ</span> ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÜŸÇÿ± ŸÑŸÑÿ•ŸäŸÇÿßŸÅ
                                    </button>
                                    <button class="btn btn-sm" onclick="setTapToStop(false)" style="background: white; color: #e74c3c; flex: 1;">
                                        <span>‚ùå</span> ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑŸÜŸÇÿ± ŸÑŸÑÿ•ŸäŸÇÿßŸÅ
                                    </button>
                                </div>
                                <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.15); border-radius: 5px;">
                                    <span style="font-weight: 600;">ÿßŸÑÿ≠ÿßŸÑÿ©:</span>
                                    <span id="tapToStopStatus" style="font-weight: 700; margin-right: 10px;">‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Music Duration Control -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>‚è±Ô∏è</span> ŸÖÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ
                            </label>
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <button class="btn btn-sm" onclick="setMusicDuration(60)" style="background: white; color: #11998e;">
                                    <span>‚è±Ô∏è</span> ÿØŸÇŸäŸÇÿ© Ÿàÿßÿ≠ÿØÿ©
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(300)" style="background: white; color: #11998e;">
                                    <span>‚è±Ô∏è</span> 5 ÿØŸÇÿßÿ¶ŸÇ
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(600)" style="background: white; color: #11998e;">
                                    <span>‚è±Ô∏è</span> 10 ÿØŸÇÿßÿ¶ŸÇ
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(1800)" style="background: white; color: #11998e;">
                                    <span>‚è±Ô∏è</span> 30 ÿØŸÇŸäŸÇÿ©
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(-1)" style="background: white; color: #11998e;">
                                    <span>‚ôæÔ∏è</span> ŸÖÿ≥ÿ™ŸÖÿ± (ÿ∫Ÿäÿ± ŸÖÿ≠ÿØŸàÿØ)
                                </button>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; margin-top: 10px;">
                                <span style="font-weight: 600;">ÿßŸÑŸÖÿØÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©:</span>
                                <span id="musicDurationLabel" style="font-weight: 700; margin-right: 10px;">‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</span>
                            </div>
                        </div>
                        
                        <!-- Current Music Status -->
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ:</span>
                                <span id="musicStatusLabel" style="font-size: 1.1em; font-weight: 700;">‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</span>
                            </div>
                        </div>
                        
                        <div class="status-message" id="musicControlStatus"></div>
                    </div>
                    
                    <!-- Live Preview Section -->
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 25px; border-radius: 15px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>üëÅÔ∏è</span>
                            <span>ŸÖÿπÿßŸäŸÜÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ© Ÿàÿ≠Ÿäÿ© 100%</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ™ŸÜÿπŸÉÿ≥ ŸÅŸàÿ±ÿßŸã ŸàŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÅŸä GitHub ŸàÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ŸàÿßŸÑŸÖÿ™ÿµŸÅÿ≠ÿßÿ™
                        </p>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="margin-bottom: 10px;">
                                <span style="font-weight: 600;">ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´:</span>
                                <span id="lastUpdateLabel" style="font-weight: 700; margin-right: 10px;">‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</span>
                            </div>
                            <div>
                                <span style="font-weight: 600;">ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ®Ÿàÿßÿ≥ÿ∑ÿ©:</span>
                                <span id="updatedByLabel" style="font-weight: 700; margin-right: 10px;">‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="loadMaintenanceConfig()" style="margin-top: 15px; background: white; color: #fa709a;">
                            <span>üîÑ</span>
                            <span>ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ©</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Areas Management -->
            <div id="areasTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">üó∫Ô∏è ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÉÿßŸÖŸÑÿ©</h2>
                    
                    <!-- Smart Action Buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="openAddAreaModal()">
                            <span>‚ûï</span> ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇÿ© ÿ¨ÿØŸäÿØÿ©
                        </button>
                        <button class="btn btn-primary" onclick="refreshAreasList()">
                            <span>üîÑ</span> ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
                        </button>
                        <button class="btn btn-warning" onclick="sortAreasBySmartPriority()">
                            <span>‚≠ê</span> ÿ™ÿ±ÿ™Ÿäÿ® ÿ∞ŸÉŸä ÿ®ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©
                        </button>
                        <button class="btn btn-warning" onclick="sortAreasByName()">
                            <span>üî§</span> ÿ™ÿ±ÿ™Ÿäÿ® ÿ£ÿ®ÿ¨ÿØŸäÿßŸã
                        </button>
                        <button class="btn btn-warning" onclick="sortAreasByShopCount()">
                            <span>üè™</span> ÿ™ÿ±ÿ™Ÿäÿ® ÿ®ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
                        </button>
                        <button class="btn btn-info" onclick="mergeAreas()">
                            <span>üîó</span> ÿØŸÖÿ¨ ŸÖŸÜÿßÿ∑ŸÇ
                        </button>
                        <button class="btn btn-success" onclick="assignShopsToAreas()">
                            <span>üìç</span> ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
                        </button>
                        <button class="btn btn-warning" onclick="exportAreasData()">
                            <span>üì§</span> ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                        </button>
                        <button class="btn btn-info" onclick="importAreasFromFile()">
                            <span>üì•</span> ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÜÿßÿ∑ŸÇ
                        </button>
                        <button class="btn btn-danger" onclick="bulkEditAreas()">
                            <span>‚úèÔ∏è</span> ÿ™ÿπÿØŸäŸÑ ÿ¨ŸÖÿßÿπŸä
                        </button>
                        <button class="btn btn-success" onclick="generateAreasReport()">
                            <span>üìä</span> ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
                        </button>
                        <button class="btn btn-danger" onclick="openAreaShopsViewModal()" style="border: none; font-weight: bold;">
                            <span>üè™</span> ÿπÿ±ÿ∂ ŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜÿ∑ŸÇÿ© ŸÖÿπŸäŸÜÿ©
                        </button>
                    </div>
                    
                    <!-- Search -->
                    <div class="search-box">
                        <input type="text" id="searchArea" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ∑ŸÇÿ©..." oninput="filterAreasList()">
                        <span class="search-icon">üîç</span>
                    </div>
                    
                    <!-- Areas Stats -->
                    <div class="inspector-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalAreasManagement">0</div>
                            <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="filteredAreasCount">0</div>
                            <div class="stat-label">ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ÿ©</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalShopsInAreas">0</div>
                            <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>
                        </div>
                    </div>
                    
                    <!-- Areas List Table -->
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table class="inspections-table" id="areasManagementTable">
                            <thead>
                                <tr>
                                    <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                                    <th>ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿπÿ±ŸäŸÅ</th>
                                    <th>ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</th>
                                    <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                                </tr>
                            </thead>
                            <tbody id="areasManagementBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 40px;">
                                        ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="status-message" id="areasManagementStatus"></div>
                </div>
            </div>
        </div>
        
        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚úèÔ∏è ÿ™ÿ≠ÿ±Ÿäÿ± ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥</h2>
                    <span class="modal-close" onclick="closeEditModal()">&times;</span>
                </div>
                <input type="hidden" id="editInspectionIndex">
                <div class="form-group">
                    <label class="form-label">ÿßŸÑŸÖŸÅÿ™ÿ¥</label>
                    <select id="editInspector" class="form-control">
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</label>
                    <input type="date" id="editDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©</label>
                    <select id="editShift" class="form-control">
                        <option value="ÿµÿ®ÿßÿ≠Ÿäÿ©">ÿµÿ®ÿßÿ≠Ÿäÿ©</option>
                        <option value="ŸÖÿ≥ÿßÿ¶Ÿäÿ©">ŸÖÿ≥ÿßÿ¶Ÿäÿ©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</label>
                    <select id="editArea" class="form-control">
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ (ŸÖŸÅÿµŸàŸÑÿ© ÿ®ŸÅŸàÿßÿµŸÑ)</label>
                    <textarea id="editShops" class="form-control" rows="6" 
                              placeholder="ŸÖÿ≠ŸÑ 1ÿå ŸÖÿ≠ŸÑ 2ÿå ŸÖÿ≠ŸÑ 3..."></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveEditedInspection()">
                        <span>üíæ</span> ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
                    </button>
                    <button class="btn btn-warning" onclick="closeEditModal()">
                        <span>‚úï</span> ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
                <div class="status-message" id="editStatus"></div>
            </div>
        </div>
        
        <!-- Add/Edit Shop Modal -->
        <div id="shopModal" class="modal">
            <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 id="shopModalTitle">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ</h2>
                    <span class="modal-close" onclick="closeShopModal()">&times;</span>
                </div>
                <input type="hidden" id="shopModalId">
                
                <!-- Required Fields Section -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #2d3561; font-size: 1.1em; margin-bottom: 15px;">üìã ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© (ÿ•ÿ¨ÿ®ÿßÿ±Ÿäÿ©)</h3>
                    <div class="form-group">
                        <label class="form-label">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ <span style="color: red;">*</span></label>
                        <input type="text" id="shopModalName" class="form-control" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© <span style="color: red;">*</span></label>
                        <select id="shopModalArea" class="form-control">
                            <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©...</option>
                        </select>
                    </div>
                </div>
                
                <!-- Optional Details Section -->
                <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #2d3561; font-size: 1.1em; margin-bottom: 15px;">üìù ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿ©)</h3>
                    
                    <div class="form-group">
                        <label class="form-label">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©</label>
                        <input type="text" id="shopModalNameEn" class="form-control" placeholder="Shop Name in English">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ</label>
                        <input type="text" id="shopModalLicense" class="form-control" placeholder="ŸÖÿ´ÿßŸÑ: CN-1234567">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑÿπŸÜŸàÿßŸÜ</label>
                        <input type="text" id="shopModalAddress" class="form-control" placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑŸÉÿßŸÖŸÑ ŸÑŸÑŸÖÿ≠ŸÑ">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
                        <input type="tel" id="shopModalPhone" class="form-control" placeholder="ŸÖÿ´ÿßŸÑ: 0501234567">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
                        <input type="email" id="shopModalEmail" class="form-control" placeholder="example@email.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üó∫Ô∏è ŸÖŸàŸÇÿπ ÿßŸÑŸÖÿ≠ŸÑ ÿπŸÑŸâ ÿÆÿ±ÿßÿ¶ÿ∑ ÿ¨Ÿàÿ¨ŸÑ</label>
                        <!-- ‚ö†Ô∏è CRITICAL: Manual Google Maps link ONLY - NO auto-generation -->
                        <!-- ‚ö†Ô∏è ÿ≠ÿ±ÿ¨: ÿ±ÿßÿ®ÿ∑ ÿÆÿ±ÿßÿ¶ÿ∑ ÿ¨Ÿàÿ¨ŸÑ ŸäÿØŸàŸä ŸÅŸÇÿ∑ - ŸÑÿß ÿ™ŸàŸÑŸäÿØ ÿ™ŸÑŸÇÿßÿ¶Ÿä -->
                        <input type="url" id="shopModalGoogleMaps" class="form-control" placeholder="https://maps.google.com/...">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            üí° ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÖŸàŸÇÿπ ŸÖŸÜ ÿÆÿ±ÿßÿ¶ÿ∑ ÿ¨Ÿàÿ¨ŸÑ ŸÑÿ™ÿ≥ŸáŸäŸÑ ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÖÿ≠ŸÑ
                        </small>
                        <small style="color: #d9534f; display: block; margin-top: 3px; font-weight: 500;">
                            ‚ö†Ô∏è Ÿäÿ¨ÿ® ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸäÿØŸàŸäÿßŸã ŸÖŸÜ ÿÆÿ±ÿßÿ¶ÿ∑ ÿ¨Ÿàÿ¨ŸÑ - ŸÑÿß ÿ™ŸàŸÑŸäÿØ ÿ™ŸÑŸÇÿßÿ¶Ÿä
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÿ∑ÿ®Ÿäÿπÿ© ŸÜÿ¥ÿßÿ∑ ÿßŸÑŸÖÿ≠ŸÑ</label>
                        <textarea id="shopModalActivity" class="form-control" rows="3" placeholder="ŸÖÿ´ÿßŸÑ: ÿ®Ÿäÿπ ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿßŸÑÿ£ŸÑŸäŸÅÿ©ÿå ÿ®Ÿäÿπ ÿ£ÿ≥ŸÖÿßŸÉ ÿßŸÑÿ≤ŸäŸÜÿ©ÿå ÿ®Ÿäÿπ ÿßŸÑÿ∑ŸäŸàÿ±..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÿ±ŸÖÿ≤ ADM</label>
                        <input type="text" id="shopModalAdmCode" class="form-control" placeholder="ŸÖÿ´ÿßŸÑ: ADM0001">
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveShop()">
                        <span>üíæ</span> ÿ≠ŸÅÿ∏ ŸÅŸàÿ±ÿßŸã
                    </button>
                    <button class="btn btn-warning" onclick="closeShopModal()">
                        <span>‚úï</span> ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
                <div class="status-message" id="shopModalStatus"></div>
            </div>
        </div>
        
        <!-- Add/Edit Area Modal -->
        <div id="areaModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="areaModalTitle">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇÿ© ÿ¨ÿØŸäÿØÿ©</h2>
                    <span class="modal-close" onclick="closeAreaModal()">&times;</span>
                </div>
                <input type="hidden" id="areaModalId">
                <div class="form-group">
                    <label class="form-label">ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© <span style="color: red;">*</span></label>
                    <input type="text" id="areaModalName" class="form-control" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©">
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveArea()">
                        <span>üíæ</span> ÿ≠ŸÅÿ∏
                    </button>
                    <button class="btn btn-warning" onclick="closeAreaModal()">
                        <span>‚úï</span> ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
                <div class="status-message" id="areaModalStatus"></div>
            </div>
        </div>
        
        <!-- Merge Areas Modal -->
        <div id="mergeAreasModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2>üîó ÿØŸÖÿ¨ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</h2>
                    <span class="modal-close" onclick="closeMergeAreasModal()">&times;</span>
                </div>
                
                <p style="color: #666; margin-bottom: 20px;">
                    ÿßÿÆÿ™ÿ± ŸÖŸÜÿ∑ŸÇÿ™ŸäŸÜ ÿ£Ÿà ÿ£ŸÉÿ´ÿ± ŸÑÿØŸÖÿ¨Ÿáÿß ŸÅŸä ŸÖŸÜÿ∑ŸÇÿ© Ÿàÿßÿ≠ÿØÿ©. ÿ≥Ÿäÿ™ŸÖ ŸÜŸÇŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ•ŸÑŸâ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©.
                </p>
                
                <div class="form-group">
                    <label class="form-label">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© (ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿØŸÖÿ¨ ŸÅŸäŸáÿß) <span style="color: red;">*</span></label>
                    <select id="mergeTargetArea" class="form-control">
                        <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿ±ÿßÿØ ÿØŸÖÿ¨Ÿáÿß (ÿ≠ÿØÿØ Ÿàÿßÿ≠ÿØÿ© ÿ£Ÿà ÿ£ŸÉÿ´ÿ±) <span style="color: red;">*</span></label>
                    <div id="mergeSourceAreasContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px;">
                        <!-- Checkboxes will be added here dynamically -->
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>‚ö†Ô∏è ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸáÿßŸÖÿ©:</strong>
                    <ul style="margin: 10px 0; padding-right: 20px;">
                        <li>ÿ≥Ÿäÿ™ŸÖ ŸÜŸÇŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿ≠ÿØÿØÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</li>
                        <li>ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÜŸÇŸàŸÑÿ©</li>
                        <li>ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿØŸÖÿ¨ÿ© ÿ®ÿπÿØ ŸÜŸÇŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</li>
                        <li>ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ©</li>
                    </ul>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="executeMergeAreas()">
                        <span>üîó</span> ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿØŸÖÿ¨
                    </button>
                    <button class="btn btn-warning" onclick="closeMergeAreasModal()">
                        <span>‚úï</span> ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
                
                <div class="status-message" id="mergeAreasStatus"></div>
            </div>
        </div>
        
        <!-- Assign Shops to Areas Modal -->
        <div id="assignShopsModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2>üìç ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÑŸÖŸÜÿßÿ∑ŸÇ</h2>
                    <span class="modal-close" onclick="closeAssignShopsModal()">&times;</span>
                </div>
                
                <p style="color: #666; margin-bottom: 20px;">
                    ÿ≠ÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ÿ±ŸäÿØ ŸÜŸÇŸÑŸáÿß ÿ•ŸÑŸâ ŸÖŸÜÿ∑ŸÇÿ© ÿ¨ÿØŸäÿØÿ©.
                </p>
                
                <div class="form-group">
                    <label class="form-label">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© (ŸÑŸÑŸÅŸÑÿ™ÿ±ÿ©)</label>
                    <select id="assignShopsCurrentArea" class="form-control" onchange="loadShopsForAssignment()">
                        <option value="">-- ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© <span style="color: red;">*</span></label>
                    <select id="assignShopsTargetArea" class="form-control">
                        <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ±ÿßÿØ ŸÜŸÇŸÑŸáÿß (ÿ≠ÿØÿØ Ÿàÿßÿ≠ÿØ ÿ£Ÿà ÿ£ŸÉÿ´ÿ±) <span style="color: red;">*</span>
                    </label>
                    <div style="margin-bottom: 10px;">
                        <input type="text" id="searchShopsForAssignment" class="form-control" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≠ŸÑ..." oninput="filterShopsForAssignment()">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-info" onclick="selectAllShopsForAssignment()">
                            ‚úì ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="deselectAllShopsForAssignment()">
                            ‚úï ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ≠ÿØŸäÿØ
                        </button>
                    </div>
                    <div id="assignShopsContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px;">
                        <!-- Checkboxes will be added here dynamically -->
                    </div>
                </div>
                
                <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>‚ÑπÔ∏è ŸÖÿπŸÑŸàŸÖÿßÿ™:</strong>
                    <ul style="margin: 10px 0; padding-right: 20px;">
                        <li>ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©</li>
                        <li>ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</li>
                        <li>ŸäŸÖŸÉŸÜ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÅŸä ÿ£Ÿä ŸàŸÇÿ™</li>
                    </ul>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="executeAssignShops()">
                        <span>üìç</span> ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
                    </button>
                    <button class="btn btn-warning" onclick="closeAssignShopsModal()">
                        <span>‚úï</span> ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
                
                <div class="status-message" id="assignShopsStatus"></div>
            </div>
        </div>
        
        <!-- Bulk Edit Areas Modal -->
        <div id="bulkEditModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2>‚úèÔ∏è ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ¨ŸÖÿßÿπŸä ŸÑŸÑŸÖŸÜÿßÿ∑ŸÇ</h2>
                    <span class="modal-close" onclick="closeBulkEditModal()">&times;</span>
                </div>
                
                <p style="color: #666; margin-bottom: 20px;">
                    ŸÇŸÖ ÿ®ÿ™ÿπÿØŸäŸÑ ÿπÿØÿ© ŸÖŸÜÿßÿ∑ŸÇ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸàŸÇÿ™. ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© ÿ®ÿßÿØÿ¶ÿ© ÿ£Ÿà ŸÑÿßÿ≠ŸÇÿ© ŸÑÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿ£Ÿà ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ŸÜÿµ ŸÖÿπŸäŸÜ.
                </p>
                
                <div class="form-group">
                    <label class="form-label">ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿ±ÿßÿØ ÿ™ÿπÿØŸäŸÑŸáÿß (ÿ≠ÿØÿØ Ÿàÿßÿ≠ÿØÿ© ÿ£Ÿà ÿ£ŸÉÿ´ÿ±) <span style="color: red;">*</span></label>
                    <div style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-info" onclick="selectAllAreasForBulkEdit()">
                            ‚úì ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="deselectAllAreasForBulkEdit()">
                            ‚úï ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ≠ÿØŸäÿØ
                        </button>
                    </div>
                    <div id="bulkEditAreasContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px;">
                        <!-- Checkboxes will be added here dynamically -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ŸÜŸàÿπ ÿßŸÑÿ™ÿπÿØŸäŸÑ</label>
                    <select id="bulkEditType" class="form-control" onchange="toggleBulkEditOptions()">
                        <option value="prefix">ÿ•ÿ∂ÿßŸÅÿ© ÿ®ÿßÿØÿ¶ÿ© ŸÑŸÑÿ£ÿ≥ŸÖÿßÿ°</option>
                        <option value="suffix">ÿ•ÿ∂ÿßŸÅÿ© ŸÑÿßÿ≠ŸÇÿ© ŸÑŸÑÿ£ÿ≥ŸÖÿßÿ°</option>
                        <option value="replace">ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ŸÜÿµ ŸÅŸä ÿßŸÑÿ£ÿ≥ŸÖÿßÿ°</option>
                    </select>
                </div>
                
                <div id="bulkEditPrefixSuffix" style="display: block;">
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿ±ÿßÿØ ÿ•ÿ∂ÿßŸÅÿ™Ÿá</label>
                        <input type="text" id="bulkEditText" class="form-control" placeholder="ŸÖÿ´ÿßŸÑ: ŸÖŸÜÿ∑ŸÇÿ©">
                    </div>
                </div>
                
                <div id="bulkEditReplace" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿ±ÿßÿØ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑŸá</label>
                        <input type="text" id="bulkEditFindText" class="form-control" placeholder="ÿßŸÑŸÜÿµ ÿßŸÑŸÇÿØŸäŸÖ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÿßŸÑŸÜÿµ ÿßŸÑÿ¨ÿØŸäÿØ</label>
                        <input type="text" id="bulkEditReplaceText" class="form-control" placeholder="ÿßŸÑŸÜÿµ ÿßŸÑÿ¨ÿØŸäÿØ">
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>‚ö†Ô∏è ŸÖŸÑÿßÿ≠ÿ∏ÿ©:</strong>
                    <ul style="margin: 10px 0; padding-right: 20px;">
                        <li>ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿ≠ÿØÿØÿ© ŸÅŸÇÿ∑</li>
                        <li>ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÖÿπÿßŸäŸÜÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞</li>
                        <li>ÿ≥Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã</li>
                    </ul>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-info" onclick="previewBulkEdit()">
                        <span>üëÅÔ∏è</span> ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
                    </button>
                    <button class="btn btn-success" onclick="executeBulkEdit()">
                        <span>‚úèÔ∏è</span> ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ™ÿπÿØŸäŸÑ
                    </button>
                    <button class="btn btn-warning" onclick="closeBulkEditModal()">
                        <span>‚úï</span> ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
                
                <div id="bulkEditPreview" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="color: #2d3561; margin-bottom: 10px;">üëÅÔ∏è ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™:</h3>
                    <div id="bulkEditPreviewContent"></div>
                </div>
                
                <div class="status-message" id="bulkEditStatus"></div>
            </div>
        </div>
        
        <!-- Smart Shop List Modal -->
        <div id="smartShopListModal" class="modal">
            <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>üìã ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©</h2>
                    <span class="modal-close" onclick="closeSmartShopListModal()">&times;</span>
                </div>
                
                <!-- Filters and Controls -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                    <h3 style="margin-bottom: 15px;">‚öôÔ∏è ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ŸÜÿ∏ŸäŸÖ ŸàÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä:</label>
                            <select id="primarySort" class="form-control" onchange="updateSmartShopList()">
                                <option value="smartPriority">‚≠ê ÿ™ÿ±ÿ™Ÿäÿ® ÿ∞ŸÉŸä ÿ®ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©</option>
                                <option value="areaProximity">üìç ÿ™ÿ±ÿ™Ÿäÿ® ÿ®ÿßŸÑŸÇÿ±ÿ® ÿßŸÑÿ¨ÿ∫ÿ±ÿßŸÅŸä</option>
                                <option value="rating">ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ŸÇŸäŸäŸÖ (ÿßŸÑÿ£ÿπŸÑŸâ ÿ£ŸàŸÑÿßŸã)</option>
                                <option value="area">ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</option>
                                <option value="activity">ÿ≠ÿ≥ÿ® ÿßŸÑŸÜÿ¥ÿßÿ∑</option>
                                <option value="alphabetical">ÿ£ÿ®ÿ¨ÿØŸä (ÿ£-Ÿä)</option>
                                <option value="lastInspection">ÿ≠ÿ≥ÿ® ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:</label>
                            <select id="smartListAreaFilter" class="form-control" onchange="updateSmartShopList()">
                                <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ŸÇŸäŸäŸÖ:</label>
                            <select id="ratingFilter" class="form-control" onchange="updateSmartShopList()">
                                <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™</option>
                                <option value="excellent">ŸÖŸÖÿ™ÿßÿ≤ (90+)</option>
                                <option value="good">ÿ¨ŸäÿØ (70-89)</option>
                                <option value="fair">ŸÖŸÇÿ®ŸàŸÑ (50-69)</option>
                                <option value="poor">ÿ∂ÿπŸäŸÅ (ÿ£ŸÇŸÑ ŸÖŸÜ 50)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÿπÿ±ÿ∂ ÿßŸÑÿ¨ÿØÿßŸàŸÑ:</label>
                            <select id="tableView" class="form-control" onchange="updateSmartShopList()">
                                <option value="unified">ÿ¨ÿØŸàŸÑ ŸÖŸàÿ≠ÿØ</option>
                                <option value="byArea">ÿ¨ÿØŸàŸÑ ŸÑŸÉŸÑ ŸÖŸÜÿ∑ŸÇÿ©</option>
                                <option value="byActivity">ÿ¨ÿØŸàŸÑ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜÿ¥ÿßÿ∑</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Smart Management Buttons Section -->
                    <div style="margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.15); border-radius: 10px;">
                        <h4 style="color: white; margin-bottom: 15px; font-size: 1.2em;">üéØ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©</h4>
                        
                        <!-- Row 1: Core Management Actions -->
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="openAddShopFromSmartList()" style="background: white; color: #28a745; font-weight: bold;">
                                <span>‚ûï</span> ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ
                            </button>
                            <button class="btn btn-primary" onclick="openBulkEditShops()" style="background: white; color: #007bff;">
                                <span>‚úèÔ∏è</span> ÿ™ÿπÿØŸäŸÑ ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ©
                            </button>
                            <button class="btn btn-danger" onclick="openBulkDeleteShops()" style="background: white; color: #dc3545;">
                                <span>üóëÔ∏è</span> ÿ≠ÿ∞ŸÅ ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ©
                            </button>
                            <button class="btn btn-warning" onclick="openImportShopsFromExcel()" style="background: white; color: #ffc107;">
                                <span>üì•</span> ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÜ Excel
                            </button>
                        </div>
                        
                        <!-- Row 2: Advanced Management Actions -->
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="mergeDuplicateShops()" style="background: white; color: #17a2b8;">
                                <span>üîÑ</span> ÿØŸÖÿ¨ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©
                            </button>
                            <button class="btn btn-success" onclick="syncShopsWithGitHub()" style="background: white; color: #11998e;">
                                <span>‚òÅÔ∏è</span> ŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub
                            </button>
                            <button class="btn btn-primary" onclick="refreshSmartShopData()" style="background: white; color: #3498db;">
                                <span>üîÑ</span> ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                            </button>
                            <button class="btn btn-warning" onclick="openAdvancedShopSearch()" style="background: white; color: #f39c12;">
                                <span>üîç</span> ÿ®ÿ≠ÿ´ ŸÖÿ™ŸÇÿØŸÖ
                            </button>
                        </div>
                        
                        <!-- Row 3: Backup and Export Actions -->
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="createShopsBackup()" style="background: white; color: #6c757d;">
                                <span>üíæ</span> ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
                            </button>
                            <button class="btn btn-success" onclick="exportSmartShopList('excel')" style="background: white; color: #667eea;">
                                <span>üìä</span> ÿ™ÿµÿØŸäÿ± Excel
                            </button>
                            <button class="btn btn-primary" onclick="exportSmartShopList('pdf')" style="background: white; color: #667eea;">
                                <span>üìÑ</span> ÿ™ÿµÿØŸäÿ± PDF
                            </button>
                            <button class="btn btn-info" onclick="exportSmartShopList('json')" style="background: white; color: #667eea;">
                                <span>üíæ</span> ÿ™ÿµÿØŸäÿ± JSON
                            </button>
                            <button class="btn btn-warning" onclick="printSmartShopList()" style="background: white; color: #667eea;">
                                <span>üñ®Ô∏è</span> ÿ∑ÿ®ÿßÿπÿ©
                            </button>
                        </div>
                        
                        <!-- Row 4: Batch Selection Actions -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-sm" onclick="selectAllShopsInList()" style="background: white; color: #28a745; padding: 8px 16px;">
                                <span>‚òëÔ∏è</span> ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ
                            </button>
                            <button class="btn btn-sm" onclick="deselectAllShopsInList()" style="background: white; color: #dc3545; padding: 8px 16px;">
                                <span>‚¨ú</span> ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ≠ÿØŸäÿØ
                            </button>
                            <button class="btn btn-sm" onclick="selectHighPriorityShopsInList()" style="background: white; color: #ffc107; padding: 8px 16px;">
                                <span>‚≠ê</span> ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑÿπÿßŸÑŸäÿ©
                            </button>
                            <button class="btn btn-sm" onclick="exportSelectedShops()" style="background: white; color: #17a2b8; padding: 8px 16px;">
                                <span>üì§</span> ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÖÿ≠ÿØÿØ
                            </button>
                            <button class="btn btn-sm" onclick="applyBatchOperation()" style="background: white; color: #6f42c1; padding: 8px 16px;">
                                <span>‚öôÔ∏è</span> ÿπŸÖŸÑŸäÿ© ÿ¨ŸÖÿßÿπŸäÿ©
                            </button>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- Statistics Summary -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div style="background: #667eea; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListTotalShops">0</div>
                        <div>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>
                    </div>
                    <div style="background: #11998e; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListAvgRating">0</div>
                        <div>ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ</div>
                    </div>
                    <div style="background: #3498db; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListAreas">0</div>
                        <div>ÿπÿØÿØ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</div>
                    </div>
                    <div style="background: #e74c3c; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListHighPriority">0</div>
                        <div>ÿ£ŸàŸÑŸàŸäÿ© ÿπÿßŸÑŸäÿ©</div>
                    </div>
                    <div id="selectedShopsCounter" style="background: #28a745; color: white; padding: 15px; border-radius: 10px; text-align: center; display: none;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListSelectedCount">0</div>
                        <div>ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ≠ÿØÿØÿ©</div>
                    </div>
                </div>
                
                <!-- Shop List Content -->
                <div id="smartShopListContent" style="margin-top: 20px;">
                    <p style="text-align: center; padding: 40px; color: #999;">
                        ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∞ŸÉŸäÿ©...
                    </p>
                </div>
                
                <div class="status-message" id="smartShopListStatus"></div>
            </div>
        </div>
        
        <!-- Shops By Area View Modal -->
        <div id="shopsByAreaModal" class="modal">
            <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>üèòÔ∏è ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ±ÿ™ÿ®ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</h2>
                    <span class="modal-close" onclick="closeShopsByAreaModal()">&times;</span>
                </div>
                
                <!-- Search and Filter -->
                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≠ŸÑ:</label>
                            <input type="text" id="shopsByAreaSearch" class="form-control" placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ..." oninput="updateShopsByAreaView()">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:</label>
                            <select id="shopsByAreaFilter" class="form-control" onchange="updateShopsByAreaView()">
                                <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÿπÿ±ÿ∂:</label>
                            <select id="shopsByAreaViewType" class="form-control" onchange="updateShopsByAreaView()">
                                <option value="grouped">ŸÖÿ¨ŸÖŸàÿπÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</option>
                                <option value="list">ŸÇÿßÿ¶ŸÖÿ© ŸÉÿßŸÖŸÑÿ©</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Statistics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div style="background: #e74c3c; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="shopsByAreaTotalShops">0</div>
                        <div>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>
                    </div>
                    <div style="background: #3498db; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="shopsByAreaTotalAreas">0</div>
                        <div>ÿπÿØÿØ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</div>
                    </div>
                    <div style="background: #11998e; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="shopsByAreaDisplayed">0</div>
                        <div>ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿπÿ±Ÿàÿ∂ÿ©</div>
                    </div>
                </div>
                
                <!-- Content -->
                <div id="shopsByAreaContent" style="margin-top: 20px;">
                    <p style="text-align: center; padding: 40px; color: #999;">
                        ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...
                    </p>
                </div>
                
                <div class="status-message" id="shopsByAreaStatus"></div>
            </div>
        </div>
        
        <!-- Area Shops View Modal (for viewing shops of a specific area) -->
        <div id="areaShopsViewModal" class="modal">
            <div class="modal-content" style="max-width: 90%; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>üè™ ÿπÿ±ÿ∂ ŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜÿ∑ŸÇÿ© ŸÖÿπŸäŸÜÿ©</h2>
                    <span class="modal-close" onclick="closeAreaShopsViewModal()">&times;</span>
                </div>
                
                <!-- Area Selection -->
                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                    <h3 style="margin-bottom: 15px;">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</h3>
                    <select id="areaShopsViewSelect" class="form-control" onchange="loadShopsForSelectedArea()" style="font-size: 1.1em; padding: 12px;">
                        <option value="">-- ÿßÿÆÿ™ÿ± ŸÖŸÜÿ∑ŸÇÿ© --</option>
                    </select>
                </div>
                
                <!-- Selected Area Info -->
                <div id="selectedAreaInfo" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">
                        <span>üìç</span> ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: <span id="selectedAreaName" style="color: #e74c3c;">-</span>
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div style="background: #3498db; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2em; font-weight: bold;" id="selectedAreaShopsCount">0</div>
                            <div>ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>
                        </div>
                        <div style="background: #11998e; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2em; font-weight: bold;" id="selectedAreaInspections">0</div>
                            <div>ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÖŸÇÿ±ÿ±ÿ©</div>
                        </div>
                    </div>
                </div>
                
                <!-- Shops List -->
                <div id="areaShopsViewContent" style="margin-top: 20px;">
                    <p style="text-align: center; padding: 40px; color: #999;">
                        ÿßÿÆÿ™ÿ± ŸÖŸÜÿ∑ŸÇÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ™ÿßÿ®ÿπÿ© ŸÑŸáÿß
                    </p>
                </div>
                
                <div class="status-message" id="areaShopsViewStatus"></div>
            </div>
        </div>
        
        <!-- Move Shops Between Areas Modal -->
        <div id="moveShopsModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2>‚ÜîÔ∏è ŸÜŸÇŸÑ ŸÖÿ≠ŸÑÿßÿ™ ÿ®ŸäŸÜ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</h2>
                    <span class="modal-close" onclick="closeMoveShopsModal()">&times;</span>
                </div>
                
                <!-- Source Area Selection -->
                <div class="form-group">
                    <label class="form-label" style="font-size: 1.1em;">
                        <span>üìç</span> ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿµÿØÿ± (ŸÜŸÇŸÑ ŸÖŸÜ):
                    </label>
                    <select id="moveShopsSourceArea" class="form-control" onchange="loadShopsForMove()" style="font-size: 1.05em; padding: 12px;">
                        <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿµÿØÿ± --</option>
                    </select>
                </div>
                
                <!-- Shops Selection -->
                <div id="moveShopsSelection" style="display: none; margin: 20px 0;">
                    <label class="form-label" style="font-size: 1.1em;">
                        <span>üè™</span> ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ±ÿßÿØ ŸÜŸÇŸÑŸáÿß:
                    </label>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; max-height: 300px; overflow-y: auto; border: 2px solid #dee2e6;">
                        <div style="margin-bottom: 10px;">
                            <button class="btn btn-sm btn-primary" onclick="selectAllShopsForMove()">
                                <span>‚òëÔ∏è</span> ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="deselectAllShopsForMove()">
                                <span>‚¨ú</span> ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ≠ÿØŸäÿØ
                            </button>
                            <span id="moveShopsSelectedCount" style="margin-right: 15px; font-weight: bold; color: #28a745;"></span>
                        </div>
                        <div id="moveShopsList"></div>
                    </div>
                </div>
                
                <!-- Destination Area Selection -->
                <div id="moveShopsDestination" style="display: none; margin: 20px 0;">
                    <label class="form-label" style="font-size: 1.1em;">
                        <span>üéØ</span> ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≥ÿ™ŸáÿØŸÅÿ© (ŸÜŸÇŸÑ ÿ•ŸÑŸâ):
                    </label>
                    <select id="moveShopsTargetArea" class="form-control" style="font-size: 1.05em; padding: 12px;">
                        <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≥ÿ™ŸáÿØŸÅÿ© --</option>
                    </select>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="executeMoveShops()" style="flex: 1;">
                        <span>‚úÖ</span> ÿ™ŸÜŸÅŸäÿ∞ ÿπŸÖŸÑŸäÿ© ÿßŸÑŸÜŸÇŸÑ
                    </button>
                    <button class="btn btn-secondary" onclick="closeMoveShopsModal()" style="flex: 1;">
                        <span>‚ùå</span> ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
                
                <div class="status-message" id="moveShopsStatus"></div>
            </div>
        </div>
        
        <!-- Bell Notifications Control Modal -->
        <div id="bellNotificationsModal" class="bell-modal">
            <div class="bell-modal-content">
                <div class="bell-modal-header">
                    <h2>üîî ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÉÿßŸÖŸÑ ŸÅŸä ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ¨ÿ±ÿ≥</h2>
                    <button class="bell-modal-close" onclick="closeBellNotificationsControl()">&times;</button>
                </div>
                
                <div class="bell-status-message" id="bellStatusMessage"></div>
                
                <!-- Add New Notification Section -->
                <!-- Global Bell Settings Control Panel -->
                <div class="bell-control-panel">
                    <h3>‚öôÔ∏è ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿßŸÖÿ© ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</h3>
                    <div class="bell-control-row">
                        <div class="bell-control-item">
                            <label>‚è±Ô∏è ŸÖÿØÿ© ÿ∏ŸáŸàÿ± ŸÅŸÇÿßÿπÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ± (ÿ®ÿßŸÑÿ´ŸàÿßŸÜŸä):</label>
                            <input type="number" id="bellBubbleDuration" value="24" min="5" max="120" 
                                   onchange="updateBellBubbleDuration()" 
                                   style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 8px;">
                            <small style="color: #6c757d; display: block; margin-top: 5px;">
                                üí° ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©: 24 ÿ´ÿßŸÜŸäÿ© (ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿπÿØŸäŸÑ ŸÖŸÜ 5 ÿ•ŸÑŸâ 120 ÿ´ÿßŸÜŸäÿ©)
                            </small>
                        </div>
                        <div class="bell-control-item">
                            <label>üîî ÿ™ŸÅÿπŸäŸÑ ÿµŸàÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™:</label>
                            <select id="bellSoundEnabled" onchange="updateBellSoundSetting()" 
                                    style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 8px;">
                                <option value="true">ŸÖŸÅÿπŸëŸÑ ‚úÖ</option>
                                <option value="false">ŸÖÿπÿ∑ŸëŸÑ ‚ùå</option>
                            </select>
                        </div>
                        <div class="bell-control-item">
                            <label>üé® ŸÜŸÖÿ∑ ÿßŸÑÿπÿ±ÿ∂:</label>
                            <select id="bellDisplayStyle" onchange="updateBellDisplayStyle()" 
                                    style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 8px;">
                                <option value="modern">ÿπÿµÿ±Ÿä ‚ú®</option>
                                <option value="classic">ŸÉŸÑÿßÿ≥ŸäŸÉŸä üìú</option>
                                <option value="minimal">ÿ®ÿ≥Ÿäÿ∑ üéØ</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="notification-add-section">
                    <h3>‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ¥ÿπÿßÿ± ÿ¨ÿØŸäÿØ</h3>
                    <p style="color: #6c757d; margin-bottom: 15px; font-size: 0.95em;">
                        ÿ≥Ÿäÿ∏Ÿáÿ± ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ŸÅŸàÿ±ÿßŸã ŸÅŸä ÿßŸÑÿ¨ÿ±ÿ≥ üîî ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
                    </p>
                    <textarea 
                        id="newBellNotificationText" 
                        class="notification-input" 
                        placeholder="ÿßŸÉÿ™ÿ® ŸÜÿµ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ŸáŸÜÿß... (ŸÖÿ´ÿßŸÑ: ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ŸÑÿ¥Ÿáÿ± ŸÜŸàŸÅŸÖÿ®ÿ±)"
                        dir="rtl"
                    ></textarea>
                    <input 
                        type="text" 
                        id="newBellNotificationAuthor" 
                        class="notification-author-input" 
                        placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ§ŸÑŸÅ/ÿßŸÑŸÖÿ±ÿ≥ŸÑ (ŸÖÿ´ÿßŸÑ: ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ)"
                        value="ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ"
                        dir="rtl"
                    />
                    
                    <!-- Enhanced notification settings -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 600;">üìå ÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±:</label>
                            <select id="newBellNotificationPriority" style="width: 100%; padding: 8px; border: 2px solid #ced4da; border-radius: 8px;">
                                <option value="high">ÿπÿßŸÑŸäÿ© üî¥</option>
                                <option value="medium" selected>ŸÖÿ™Ÿàÿ≥ÿ∑ÿ© üü°</option>
                                <option value="low">ŸÖŸÜÿÆŸÅÿ∂ÿ© üü¢</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 600;">‚è±Ô∏è ŸÖÿØÿ© ÿßŸÑÿπÿ±ÿ∂ (ÿ®ÿßŸÑÿ£ŸäÿßŸÖ):</label>
                            <input type="number" id="newBellNotificationDuration" value="7" min="1" max="365" 
                                   style="width: 100%; padding: 8px; border: 2px solid #ced4da; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <button class="notification-add-btn" onclick="addBellNotification()">
                        ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ¥ÿπÿßÿ±
                    </button>
                </div>
                
                <!-- Existing Notifications List -->
                <div class="notifications-list">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #2d3561; font-size: 1.4em; margin: 0;">üìã ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©</h3>
                        <div class="bell-bulk-actions">
                            <button class="bell-bulk-btn" onclick="sortBellNotificationsByPriority()" 
                                    style="background: #17a2b8; color: white;">
                                üîΩ ÿ™ÿ±ÿ™Ÿäÿ® ÿ≠ÿ≥ÿ® ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©
                            </button>
                            <button class="bell-bulk-btn" onclick="sortBellNotificationsByDate()" 
                                    style="background: #6c757d; color: white;">
                                üìÖ ÿ™ÿ±ÿ™Ÿäÿ® ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
                            </button>
                            <button class="bell-bulk-btn" onclick="deleteExpiredNotifications()" 
                                    style="background: #dc3545; color: white;">
                                üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ŸáŸäÿ©
                            </button>
                        </div>
                    </div>
                    <div id="bellNotificationsList">
                        <p style="text-align: center; padding: 40px; color: #999;">
                            ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™...
                        </p>
                    </div>
                </div>
                
                <!-- Save All Button -->
                <button class="bell-save-all-btn" onclick="saveAllBellNotifications()">
                    üíæ ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let planData = null;
        let shopsDetails = null;
        let selectedShops = [];
        let githubToken = null;
        const repo = "aliabdelaal-adm/Monthly_inspection_plan";
        let currentEditingIndex = -1;
        let selectedInspectionsForDelete = [];
        let showingHighPriority = false;
        let currentAvailableShops = [];
        let currentHighPriorityShops = [];
        
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'view') {
                loadInspectionsView();
            } else if (tabName === 'stats') {
                populateStatsInspector();
            } else if (tabName === 'calendar') {
                // Set default month to current month
                const now = new Date();
                document.getElementById('calendarMonth').value = 
                    `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                loadCalendar();
            } else if (tabName === 'shops') {
                // Load planData if not already loaded
                if (!planData) {
                    loadPlanData().then(() => {
                        loadShopsManagement();
                    }).catch(error => {
                        console.error('Error loading plan data:', error);
                        // Initialize empty planData for read-only mode
                        if (!planData) {
                            planData = {
                                shops: [],
                                areas: [],
                                inspectionData: [],
                                inspectors: []
                            };
                        }
                        // Still try to load shops from shops_details.json
                        loadShopsManagement();
                    });
                } else {
                    loadShopsManagement();
                }
            } else if (tabName === 'areas') {
                // Load planData if not already loaded
                if (!planData) {
                    loadPlanData().then(() => {
                        loadAreasManagement();
                    }).catch(error => {
                        console.error('Error loading plan data:', error);
                        // Initialize empty planData for read-only mode
                        if (!planData) {
                            planData = {
                                shops: [],
                                areas: [],
                                inspectionData: [],
                                inspectors: []
                            };
                        }
                        loadAreasManagement();
                    });
                } else {
                    loadAreasManagement();
                }
            }
        }
        
        // Login developer
        async function loginDeveloper() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                showMessage('loginStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ GitHub Token');
                return;
            }
            
            githubToken = token;
            localStorage.setItem('devToken', token);
            
            showMessage('loginStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™...');
            
            try {
                // Load data from GitHub
                await loadPlanData();
                await loadShopsDetails();
                
                // Initialize UI
                populateInspectors();
                populateAreas();
                populateFilterDropdowns();
                
                // Set default date to today
                document.getElementById('inspectionDate').valueAsDate = new Date();
                
                // Hide login section and show main interface
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainInterface').style.display = 'block';
                
                showMessage('loginStatus', 'success', '‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!');
                
            } catch (error) {
                showMessage('loginStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message);
                githubToken = null;
            }
        }
        
        // Load plan data from GitHub
        async function loadPlanData() {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!res.ok) {
                throw new Error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ plan-data.json');
            }
            
            const file = await res.json();
            planData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
        }
        
        // Load shops details from GitHub
        async function loadShopsDetails() {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!res.ok) {
                throw new Error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ shops_details.json');
            }
            
            const file = await res.json();
            shopsDetails = JSON.parse(decodeURIComponent(escape(atob(file.content))));
        }
        
        // Populate inspectors dropdown
        function populateInspectors() {
            const select = document.getElementById('inspectorSelect');
            select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const option = document.createElement('option');
                    option.value = inspector.name;
                    option.textContent = inspector.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Populate areas dropdown
        function populateAreas() {
            const select = document.getElementById('areaSelect');
            select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©...</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.name;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Update available shops based on selection
        function updateAvailableShops() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const area = document.getElementById('areaSelect').value;
            const searchBox = document.getElementById('inspectionShopSearchBox');
            const searchInput = document.getElementById('inspectionShopSearch');
            
            // Clear search when filters change
            if (searchInput) {
                searchInput.value = '';
            }
            
            if (!inspector || !date || !area) {
                document.getElementById('shopsListContainer').innerHTML = 
                    '<p style="text-align: center; color: #999; padding: 20px;">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥ ŸàÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</p>';
                document.getElementById('showHighPriorityBtn').style.display = 'none';
                if (searchBox) {
                    searchBox.style.display = 'none';
                }
                return;
            }
            
            // Get all shops for the selected area
            const allShops = getAllShopsInArea(area);
            
            // Filter shops based on smart rules
            const availableShops = filterSmartShops(allShops, inspector, date);
            
            // Sort shops by priority
            const sortedShops = sortShopsByPriority(availableShops, inspector, date);
            
            // Get high-priority shops that were filtered out
            const unavailableShops = allShops.filter(shop => !availableShops.includes(shop));
            const highPriorityUnavailable = sortShopsByPriority(unavailableShops, inspector, date)
                .filter(shop => shop.priority === 'very-high' || shop.priority === 'high');
            
            // Store for later use
            currentAvailableShops = sortedShops;
            currentHighPriorityShops = highPriorityUnavailable;
            
            // Show/hide the high priority button based on availability
            const highPriorityBtn = document.getElementById('showHighPriorityBtn');
            if (currentHighPriorityShops.length > 0) {
                highPriorityBtn.style.display = 'inline-flex';
            } else {
                highPriorityBtn.style.display = 'none';
            }
            
            // Reset showing state
            showingHighPriority = false;
            document.getElementById('highPriorityBtnText').textContent = 'ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ∞ÿßÿ™ ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑÿπÿßŸÑŸäÿ©';
            document.getElementById('highPriorityBtnIcon').textContent = 'üëÅÔ∏è';
            
            // Update statistics
            updateStatistics(allShops.length, availableShops.length, sortedShops);
            
            // Display shops
            displayShops(sortedShops);
        }
        
        // Get all shops in an area
        function getAllShopsInArea(area) {
            const shops = [];
            
            if (!planData) return shops;
            
            // First, try to get shops from the planData.shops array (primary source)
            if (planData.shops && planData.areas) {
                // Find the area ID for the given area name
                const areaObj = planData.areas.find(a => a.name === area);
                
                if (areaObj) {
                    // Get all shops that belong to this area
                    const shopsInArea = planData.shops
                        .filter(shop => shop.areaId === areaObj.id)
                        .map(shop => shop.name);
                    
                    if (shopsInArea.length > 0) {
                        return shopsInArea;
                    }
                }
            }
            
            // Fallback: Collect all unique shops from inspection history
            // This ensures backward compatibility if shops array is not available
            if (planData.inspectionData) {
                const shopSet = new Set();
                planData.inspectionData.forEach(inspection => {
                    if (inspection.area === area && inspection.shops) {
                        inspection.shops.forEach(shop => shopSet.add(shop));
                    }
                });
                
                return Array.from(shopSet);
            }
            
            return shops;
        }
        
        // Filter shops based on smart rules
        function filterSmartShops(shops, inspector, date) {
            const available = [];
            
            shops.forEach(shop => {
                // Rule 1: Check if shop is already assigned to ANY inspector on the same day
                const assignedToday = isShopAssignedToday(shop, date);
                
                // Rule 2: Check if shop was inspected by THIS inspector in the last 7 days
                const recentlyInspected = wasShopRecentlyInspected(shop, inspector, date);
                
                // If shop passes both rules, it's available
                if (!assignedToday && !recentlyInspected) {
                    available.push(shop);
                }
            });
            
            return available;
        }
        
        // Check if shop is already assigned to any inspector on the same day
        function isShopAssignedToday(shop, date) {
            if (!planData || !planData.inspectionData) return false;
            
            return planData.inspectionData.some(inspection => {
                return inspection.day === date && 
                       inspection.shops && 
                       inspection.shops.includes(shop);
            });
        }
        
        // Check if shop was recently inspected by the same inspector (within 7 days)
        function wasShopRecentlyInspected(shop, inspector, date) {
            if (!planData || !planData.inspectionData) return false;
            
            const targetDate = new Date(date);
            const sevenDaysAgo = new Date(targetDate);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            return planData.inspectionData.some(inspection => {
                if (inspection.inspector !== inspector) return false;
                if (!inspection.shops || !inspection.shops.includes(shop)) return false;
                
                const inspectionDate = new Date(inspection.day);
                return inspectionDate > sevenDaysAgo && inspectionDate < targetDate;
            });
        }
        
        // Sort shops by priority
        function sortShopsByPriority(shops, inspector, date) {
            return shops.map(shop => {
                const priority = calculateShopPriority(shop, inspector, date);
                return { name: shop, priority: priority.level, score: priority.score, reason: priority.reason };
            }).sort((a, b) => b.score - a.score);
        }
        
        // Calculate shop priority
        function calculateShopPriority(shop, inspector, date) {
            let score = 0;
            let reasons = [];
            
            // Find last inspection date for this shop (by any inspector)
            const lastInspection = getLastInspectionDate(shop);
            
            if (!lastInspection) {
                score += 100; // Never inspected = highest priority
                reasons.push('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿá ŸÖŸÜ ŸÇÿ®ŸÑ');
            } else {
                const targetDate = new Date(date);
                const lastDate = new Date(lastInspection);
                const daysSince = Math.floor((targetDate - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysSince > 30) {
                    score += 80;
                    reasons.push(`ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥ ŸÇÿ®ŸÑ ${daysSince} ŸäŸàŸÖ`);
                } else if (daysSince > 21) {
                    score += 60;
                    reasons.push(`ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥ ŸÇÿ®ŸÑ ${daysSince} ŸäŸàŸÖ`);
                } else if (daysSince > 14) {
                    score += 40;
                    reasons.push(`ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥ ŸÇÿ®ŸÑ ${daysSince} ŸäŸàŸÖ`);
                } else {
                    score += 20;
                    reasons.push(`ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥ ŸÇÿ®ŸÑ ${daysSince} ŸäŸàŸÖ`);
                }
            }
            
            // Priority based on shop type (if available in shops_details)
            if (shopsDetails && shopsDetails[shop]) {
                const activity = shopsDetails[shop].activity || '';
                if (activity.includes('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑŸáÿß')) {
                    score += 30;
                    reasons.push('ŸÜÿ¥ÿßÿ∑ Ÿäÿ™ÿ∑ŸÑÿ® ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ');
                }
            }
            
            // Check if we're in the second half of the month (from 15th onwards)
            // Boost priority for high-priority shops to ensure they're inspected before month end
            const targetDate = new Date(date);
            const dayOfMonth = targetDate.getDate();
            if (dayOfMonth >= 15) {
                // From the 15th onwards, boost high priority shops to "very high"
                if (score >= 80) {
                    score += 50; // Boost very high priority shops even more
                    reasons.push('ÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑŸÜÿµŸÅ ÿßŸÑÿ´ÿßŸÜŸä ŸÖŸÜ ÿßŸÑÿ¥Ÿáÿ±');
                } else if (score >= 50) {
                    score += 20; // Moderate boost for medium priority
                }
            }
            
            // Determine priority level
            let level = 'low';
            if (score >= 130) level = 'very-high'; // Very high priority (from 15th onwards)
            else if (score >= 80) level = 'high';
            else if (score >= 50) level = 'medium';
            
            return { level, score, reason: reasons.join(' - ') };
        }
        
        // Get last inspection date for a shop
        function getLastInspectionDate(shop) {
            if (!planData || !planData.inspectionData) return null;
            
            let lastDate = null;
            
            planData.inspectionData.forEach(inspection => {
                if (inspection.shops && inspection.shops.includes(shop)) {
                    if (!lastDate || inspection.day > lastDate) {
                        lastDate = inspection.day;
                    }
                }
            });
            
            return lastDate;
        }
        
        // Update statistics
        function updateStatistics(total, available, sortedShops) {
            document.getElementById('totalShopsCount').textContent = total;
            document.getElementById('availableShopsCount').textContent = available;
            
            const veryHighPriority = sortedShops.filter(s => s.priority === 'very-high').length;
            const highPriority = sortedShops.filter(s => s.priority === 'high').length;
            document.getElementById('highPriorityCount').textContent = veryHighPriority + highPriority;
            
            document.getElementById('selectedShopsCount').textContent = selectedShops.length;
        }
        
        // HTML escape function to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Escape string for use in JavaScript (single-quoted strings)
        function escapeJs(text) {
            if (!text) return '';
            return text
                .replace(/\\/g, '\\\\')  // Escape backslashes first
                .replace(/'/g, "\\'")     // Escape single quotes
                .replace(/"/g, '\\"')     // Escape double quotes
                .replace(/\n/g, '\\n')    // Escape newlines
                .replace(/\r/g, '\\r');   // Escape carriage returns
        }
        
        // Display shops
        function displayShops(shops, showingHighPriority = false) {
            const container = document.getElementById('shopsListContainer');
            const searchBox = document.getElementById('inspectionShopSearchBox');
            
            // Show search box when there are shops to display
            if (shops.length > 0) {
                searchBox.style.display = 'block';
            } else {
                searchBox.style.display = 'none';
            }
            
            if (shops.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿπÿßŸäŸäÿ± ÿßŸÑŸÖÿ≠ÿØÿØÿ©</p>';
                return;
            }
            
            // Clear container (except info message if it exists)
            const infoDiv = document.getElementById('highPriorityInfo');
            container.innerHTML = '';
            if (infoDiv && showingHighPriority) {
                container.appendChild(infoDiv);
            }
            
            // Create shops list container
            const shopsListDiv = document.createElement('div');
            shopsListDiv.className = 'shops-list';
            
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            
            shops.forEach(shop => {
                const isSelected = selectedShops.includes(shop.name);
                const lastInspection = getLastInspectionDate(shop.name);
                
                // Check if this shop is from the high-priority unavailable list
                const isHighPriorityUnavailable = currentHighPriorityShops.some(s => s.name === shop.name);
                
                // Create shop card element
                const shopCard = document.createElement('div');
                shopCard.className = `shop-card ${shop.priority}-priority ${isSelected ? 'selected' : ''}`;
                
                // Add visual indicator for high-priority unavailable shops
                if (isHighPriorityUnavailable) {
                    shopCard.style.border = '3px solid #ff6b6b';
                    shopCard.style.opacity = '0.85';
                }
                
                shopCard.onclick = function() { toggleShop(shop.name); };
                
                // Priority badge
                const priorityBadge = document.createElement('div');
                priorityBadge.className = `priority-badge ${shop.priority}`;
                priorityBadge.textContent = shop.priority === 'very-high' ? 'ÿ£ŸàŸÑŸàŸäÿ© ÿπÿßŸÑŸäÿ© ÿ¨ÿØÿßŸã' :
                                            shop.priority === 'high' ? 'ÿ£ŸàŸÑŸàŸäÿ© ÿπÿßŸÑŸäÿ©' : 
                                            shop.priority === 'medium' ? 'ÿ£ŸàŸÑŸàŸäÿ© ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©' : 'ÿ£ŸàŸÑŸàŸäÿ© ŸÖŸÜÿÆŸÅÿ∂ÿ©';
                
                // Shop name
                const shopName = document.createElement('div');
                shopName.className = 'shop-name';
                shopName.textContent = shop.name;
                
                // Shop info - score
                const shopScore = document.createElement('div');
                shopScore.className = 'shop-info';
                shopScore.textContent = 'üìä ÿßŸÑŸÜŸÇÿßÿ∑: ' + shop.score;
                
                // Shop info - reason
                const shopReason = document.createElement('div');
                shopReason.className = 'shop-info';
                shopReason.textContent = 'üìù ' + shop.reason;
                
                // Warning for high-priority unavailable shops
                let warningDiv = null;
                if (isHighPriorityUnavailable) {
                    warningDiv = document.createElement('div');
                    warningDiv.style.cssText = 'background: #fff3cd; color: #856404; padding: 8px; border-radius: 5px; font-size: 0.85em; margin-top: 8px;';
                    
                    // Check why it's unavailable
                    const assignedToday = isShopAssignedToday(shop.name, date);
                    const recentlyInspected = wasShopRecentlyInspected(shop.name, inspector, date);
                    
                    if (assignedToday) {
                        warningDiv.textContent = '‚ö†Ô∏è ŸÖŸÉÿ±ÿ±: ÿ™ŸÖ ÿ™ÿπŸäŸäŸÜŸá ŸÑŸÖŸÅÿ™ÿ¥ ÿ¢ÿÆÿ± ÿßŸÑŸäŸàŸÖ';
                    } else if (recentlyInspected) {
                        warningDiv.textContent = '‚ö†Ô∏è ÿ™ŸÖ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥: ÿ¢ÿÆÿ± 7 ÿ£ŸäÿßŸÖ';
                    }
                }
                
                // Last inspection
                const lastInspectionDiv = document.createElement('div');
                lastInspectionDiv.className = 'last-inspection';
                lastInspectionDiv.textContent = 'üìÖ ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥: ' + (lastInspection || 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿ®ÿπÿØ');
                
                // Append all elements
                shopCard.appendChild(priorityBadge);
                shopCard.appendChild(shopName);
                shopCard.appendChild(shopScore);
                shopCard.appendChild(shopReason);
                if (warningDiv) {
                    shopCard.appendChild(warningDiv);
                }
                shopCard.appendChild(lastInspectionDiv);
                
                shopsListDiv.appendChild(shopCard);
            });
            
            container.appendChild(shopsListDiv);
        }
        
        // Toggle shop selection
        function toggleShop(shopName) {
            const index = selectedShops.indexOf(shopName);
            
            if (index > -1) {
                selectedShops.splice(index, 1);
            } else {
                selectedShops.push(shopName);
            }
            
            updateSelectedShopsDisplay();
            updateAvailableShops();
            updatePreview();
        }
        
        // Filter shops in new inspection based on search term
        function filterInspectionShops() {
            const searchTerm = document.getElementById('inspectionShopSearch').value.toLowerCase().trim();
            const shopCards = document.querySelectorAll('#shopsListContainer .shop-card');
            
            if (!searchTerm) {
                // Show all shops if search is empty
                shopCards.forEach(card => {
                    card.style.display = '';
                });
                return;
            }
            
            // Filter shop cards based on search term
            shopCards.forEach(card => {
                const shopName = card.querySelector('.shop-name').textContent.toLowerCase();
                
                // Try to get additional details from shopsDetails if available
                let shopDetails = '';
                const originalShopName = card.querySelector('.shop-name').textContent;
                if (shopsDetails && shopsDetails[originalShopName]) {
                    const shop = shopsDetails[originalShopName];
                    shopDetails = [
                        shop.nameEn || '',
                        shop.licenseNo || '',
                        shop.admCode || '',
                        shop.activity || '',
                        shop.address || ''
                    ].join(' ').toLowerCase();
                }
                
                // Check if search term matches shop name or details
                const searchableText = shopName + ' ' + shopDetails;
                if (searchableText.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // Update selected shops display
        function updateSelectedShopsDisplay() {
            const container = document.getElementById('selectedShopsContainer');
            const list = document.getElementById('selectedShopsList');
            
            if (selectedShops.length === 0) {
                container.style.display = 'none';
                document.getElementById('saveBtn').disabled = true;
                return;
            }
            
            container.style.display = 'block';
            document.getElementById('saveBtn').disabled = false;
            
            // Clear list
            list.innerHTML = '';
            
            // Create shop tags safely
            selectedShops.forEach(shop => {
                const tag = document.createElement('div');
                tag.className = 'selected-shop-tag';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = shop;
                
                const removeSpan = document.createElement('span');
                removeSpan.className = 'remove';
                removeSpan.textContent = '√ó';
                removeSpan.onclick = function() { toggleShop(shop); };
                
                tag.appendChild(nameSpan);
                tag.appendChild(removeSpan);
                list.appendChild(tag);
            });
            
            document.getElementById('selectedShopsCount').textContent = selectedShops.length;
        }
        
        // Update preview
        function updatePreview() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const shift = document.getElementById('shiftSelect').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector || !date || !area || selectedShops.length === 0) {
                document.getElementById('inspectionPreview').style.display = 'none';
                return;
            }
            
            document.getElementById('inspectionPreview').style.display = 'block';
            document.getElementById('previewInspector').textContent = inspector;
            document.getElementById('previewDate').textContent = date;
            document.getElementById('previewShift').textContent = shift;
            document.getElementById('previewArea').textContent = area;
            document.getElementById('previewShopsCount').textContent = selectedShops.length;
        }
        
        // Toggle high priority shops display
        function toggleHighPriorityShops() {
            showingHighPriority = !showingHighPriority;
            
            if (showingHighPriority) {
                // Show both available and high-priority shops
                const combinedShops = [...currentAvailableShops, ...currentHighPriorityShops];
                displayShops(combinedShops, true);
                
                // Update button text
                document.getElementById('highPriorityBtnText').textContent = 'ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ∞ÿßÿ™ ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑÿπÿßŸÑŸäÿ©';
                document.getElementById('highPriorityBtnIcon').textContent = 'üö´';
                
                // Show info message
                const container = document.getElementById('shopsListContainer');
                const infoDiv = document.createElement('div');
                infoDiv.id = 'highPriorityInfo';
                infoDiv.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;';
                infoDiv.innerHTML = `
                    <strong>‚ö†Ô∏è ÿ™ŸÜÿ®ŸäŸá:</strong> Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ∞ÿßÿ™ ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑÿπÿßŸÑŸäÿ© ÿ®ÿ¨ÿßŸÜÿ® ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©.
                    <br>
                    <small style="color: #856404;">Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÇÿØ ŸÑÿß ÿ™ÿ™ŸàÿßŸÅŸÇ ŸÖÿπ ŸÇŸàÿßÿπÿØ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ∞ŸÉŸä (ÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß ŸÖÿ§ÿÆÿ±ÿßŸã ÿ£Ÿà ŸÖŸÉÿ±ÿ±ÿ© ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ)</small>
                `;
                container.insertBefore(infoDiv, container.firstChild);
            } else {
                // Show only available shops
                displayShops(currentAvailableShops);
                
                // Update button text
                document.getElementById('highPriorityBtnText').textContent = 'ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ∞ÿßÿ™ ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑÿπÿßŸÑŸäÿ©';
                document.getElementById('highPriorityBtnIcon').textContent = 'üëÅÔ∏è';
                
                // Remove info message
                const infoDiv = document.getElementById('highPriorityInfo');
                if (infoDiv) {
                    infoDiv.remove();
                }
            }
        }
        
        // Populate filter dropdowns
        function populateFilterDropdowns() {
            // Populate inspector filter
            const filterInspector = document.getElementById('filterInspector');
            const statsInspector = document.getElementById('statsInspector');
            const editInspector = document.getElementById('editInspector');
            
            filterInspector.innerHTML = '<option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</option>';
            statsInspector.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥...</option>';
            editInspector.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const opt1 = document.createElement('option');
                    opt1.value = inspector.name;
                    opt1.textContent = inspector.name;
                    filterInspector.appendChild(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = inspector.name;
                    opt2.textContent = inspector.name;
                    statsInspector.appendChild(opt2);
                    
                    const opt3 = document.createElement('option');
                    opt3.value = inspector.name;
                    opt3.textContent = inspector.name;
                    editInspector.appendChild(opt3);
                });
            }
            
            // Populate area filter
            const filterArea = document.getElementById('filterArea');
            const editArea = document.getElementById('editArea');
            
            filterArea.innerHTML = '<option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>';
            editArea.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©...</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const opt1 = document.createElement('option');
                    opt1.value = area.name;
                    opt1.textContent = area.name;
                    filterArea.appendChild(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = area.name;
                    opt2.textContent = area.name;
                    editArea.appendChild(opt2);
                });
            }
        }
        
        // Load inspections view
        function loadInspectionsView() {
            filterInspections();
        }
        
        // Filter inspections
        function filterInspections() {
            if (!planData || !planData.inspectionData) {
                document.getElementById('inspectionsTableContainer').innerHTML = 
                    '<div class="empty-state"><div class="icon">üì≠</div><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©</p></div>';
                return;
            }
            
            const filterInspector = document.getElementById('filterInspector').value;
            const filterArea = document.getElementById('filterArea').value;
            const filterDateFrom = document.getElementById('filterDateFrom').value;
            const filterDateTo = document.getElementById('filterDateTo').value;
            const searchText = document.getElementById('searchBox').value.toLowerCase();
            
            let filtered = planData.inspectionData.filter(inspection => {
                // Filter by inspector
                if (filterInspector && inspection.inspector !== filterInspector) return false;
                
                // Filter by area
                if (filterArea && inspection.area !== filterArea) return false;
                
                // Filter by date range
                if (filterDateFrom && inspection.day < filterDateFrom) return false;
                if (filterDateTo && inspection.day > filterDateTo) return false;
                
                // Filter by search text
                if (searchText) {
                    const searchIn = `${inspection.inspector} ${inspection.area} ${inspection.shops.join(' ')}`.toLowerCase();
                    if (!searchIn.includes(searchText)) return false;
                }
                
                return true;
            });
            
            // Sort by date (newest first)
            filtered.sort((a, b) => b.day.localeCompare(a.day));
            
            displayInspectionsTable(filtered);
        }
        
        // Display inspections table
        function displayInspectionsTable(inspections) {
            const container = document.getElementById('inspectionsTableContainer');
            
            if (inspections.length === 0) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">üîç</div><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑŸÑŸÅŸÑÿ™ÿ±ÿ©</p></div>';
                return;
            }
            
            let html = '<table class="inspections-table">';
            html += '<thead><tr>';
            html += '<th><input type="checkbox" onchange="toggleAllCheckboxes(this)"></th>';
            html += '<th>ÿßŸÑŸÖŸÅÿ™ÿ¥</th>';
            html += '<th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>';
            html += '<th>ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©</th>';
            html += '<th>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>';
            html += '<th>ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</th>';
            html += '<th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>';
            html += '</tr></thead><tbody>';
            
            inspections.forEach((inspection, index) => {
                // Find original index in planData
                const originalIndex = planData.inspectionData.indexOf(inspection);
                
                html += '<tr>';
                html += `<td><input type="checkbox" class="inspection-checkbox" value="${originalIndex}"></td>`;
                html += `<td>${escapeHtml(inspection.inspector)}</td>`;
                html += `<td>${inspection.day}</td>`;
                html += `<td>${escapeHtml(inspection.shift || 'ÿµÿ®ÿßÿ≠Ÿäÿ©')}</td>`;
                html += `<td>${escapeHtml(inspection.area)}</td>`;
                html += `<td>${inspection.shops ? inspection.shops.length : 0}</td>`;
                html += `<td>
                    <span class="action-icon edit-icon" onclick="openEditModal(${originalIndex})" title="ÿ™ÿ≠ÿ±Ÿäÿ±">‚úèÔ∏è</span>
                    <span class="action-icon delete-icon" onclick="deleteInspection(${originalIndex})" title="ÿ≠ÿ∞ŸÅ">üóëÔ∏è</span>
                    <span class="action-icon copy-icon" onclick="copyInspection(${originalIndex})" title="ŸÜÿ≥ÿÆ">üìã</span>
                </td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Toggle all checkboxes
        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('.inspection-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = source.checked;
            });
        }
        
        // Open edit modal
        function openEditModal(index) {
            const inspection = planData.inspectionData[index];
            
            document.getElementById('editInspectionIndex').value = index;
            document.getElementById('editInspector').value = inspection.inspector;
            document.getElementById('editDate').value = inspection.day;
            document.getElementById('editShift').value = inspection.shift || 'ÿµÿ®ÿßÿ≠Ÿäÿ©';
            document.getElementById('editArea').value = inspection.area;
            document.getElementById('editShops').value = inspection.shops.join('ÿå ');
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editStatus').className = 'status-message';
        }
        
        // Save edited inspection
        async function saveEditedInspection() {
            const index = parseInt(document.getElementById('editInspectionIndex').value);
            const inspector = document.getElementById('editInspector').value;
            const date = document.getElementById('editDate').value;
            const shift = document.getElementById('editShift').value;
            const area = document.getElementById('editArea').value;
            const shopsText = document.getElementById('editShops').value;
            
            if (!inspector || !date || !area || !shopsText) {
                showMessage('editStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ');
                return;
            }
            
            // Parse shops
            const shops = shopsText.split('ÿå').map(s => s.trim()).filter(s => s);
            
            if (shops.length === 0) {
                showMessage('editStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                return;
            }
            
            // Check for duplicate shops assigned to other inspectors on the same day
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÉÿ±ÿ±ÿ© ŸÖÿÆÿµÿµÿ© ŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ÿ¢ÿÆÿ±ŸäŸÜ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ
            const duplicateShops = [];
            for (let i = 0; i < planData.inspectionData.length; i++) {
                const inspection = planData.inspectionData[i];
                
                // Skip the current inspection being edited
                if (i === index) {
                    continue;
                }
                
                // Skip if it's the same inspector (will be handled separately)
                if (inspection.inspector === inspector && inspection.day === date) {
                    continue;
                }
                
                // Check if it's the same day but different inspector
                if (inspection.day === date) {
                    const inspectionShops = inspection.shops || [];
                    for (const shop of shops) {
                        if (inspectionShops.includes(shop)) {
                            duplicateShops.push({
                                shop: shop,
                                inspector: inspection.inspector
                            });
                        }
                    }
                }
            }
            
            // If duplicate shops found with other inspectors, prevent saving
            if (duplicateShops.length > 0) {
                let errorMessage = '‚ùå ÿÆÿ∑ÿ£: ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™!\n\n';
                errorMessage += 'ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ™ÿßŸÑŸäÿ© ŸÖÿÆÿµÿµÿ© ÿ®ÿßŸÑŸÅÿπŸÑ ŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ÿ¢ÿÆÿ±ŸäŸÜ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ:\n\n';
                
                const shopsByInspector = {};
                duplicateShops.forEach(dup => {
                    if (!shopsByInspector[dup.inspector]) {
                        shopsByInspector[dup.inspector] = [];
                    }
                    shopsByInspector[dup.inspector].push(dup.shop);
                });
                
                for (const [otherInspector, shopsList] of Object.entries(shopsByInspector)) {
                    errorMessage += `\nüî∏ ${otherInspector}:\n`;
                    shopsList.forEach(shop => {
                        errorMessage += `   ‚Ä¢ ${shop}\n`;
                    });
                }
                
                errorMessage += '\n‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ≤ÿßŸÑÿ© Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ£Ÿà ÿßÿÆÿ™Ÿäÿßÿ± ŸäŸàŸÖ ÿ¢ÿÆÿ±.';
                errorMessage += '\n\nüí° ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ŸäŸÖŸÉŸÜ ÿ™ÿÆÿµŸäÿµ ŸÜŸÅÿ≥ ÿßŸÑŸÖÿ≠ŸÑ ŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÖÿÆÿ™ŸÑŸÅŸäŸÜ ŸÅŸä ÿ£ŸäÿßŸÖ ŸÖÿÆÿ™ŸÑŸÅÿ©.';
                
                showMessage('editStatus', 'error', errorMessage);
                return;
            }
            
            showMessage('editStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™...');
            
            try {
                // Check for duplicates (excluding current inspection)
                const duplicateIndex = planData.inspectionData.findIndex((insp, idx) => 
                    idx !== index && 
                    insp.inspector === inspector && 
                    insp.day === date
                );
                
                if (duplicateIndex !== -1) {
                    if (confirm('ŸäŸàÿ¨ÿØ ÿ™ŸÅÿ™Ÿäÿ¥ ŸÖŸÉÿ±ÿ± ŸÑŸÜŸÅÿ≥ ÿßŸÑŸÖŸÅÿ™ÿ¥ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸÇÿØŸäŸÖÿü')) {
                        // Delete the duplicate
                        planData.inspectionData.splice(duplicateIndex, 1);
                        // Adjust index if needed
                        if (duplicateIndex < index) {
                            index--;
                        }
                    } else {
                        showMessage('editStatus', 'error', '‚ùå ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ŸÅÿ∏ ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ™ŸÉÿ±ÿßÿ±');
                        return;
                    }
                }
                
                // Update inspection
                planData.inspectionData[index] = {
                    inspector: inspector,
                    day: date,
                    shift: shift,
                    area: area,
                    shops: shops
                };
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`ÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸÅÿ™Ÿäÿ¥ - ${inspector} - ${date}`);
                
                showMessage('editStatus', 'success', '‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!');
                
                setTimeout(() => {
                    closeEditModal();
                    filterInspections();
                }, 2000);
                
            } catch (error) {
                showMessage('editStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™: ' + error.message);
            }
        }
        
        // Delete inspection
        async function deleteInspection(index) {
            const inspection = planData.inspectionData[index];
            
            if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿü\n\nÿßŸÑŸÖŸÅÿ™ÿ¥: ${inspection.inspector}\nÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${inspection.day}\nÿßŸÑŸÖÿ≠ŸÑÿßÿ™: ${inspection.shops.length}`)) {
                return;
            }
            
            try {
                // Remove inspection
                planData.inspectionData.splice(index, 1);
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`ÿ≠ÿ∞ŸÅ ÿ™ŸÅÿ™Ÿäÿ¥ - ${inspection.inspector} - ${inspection.day}`);
                
                alert('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿ®ŸÜÿ¨ÿßÿ≠!');
                filterInspections();
                
            } catch (error) {
                alert('‚ùå ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥: ' + error.message);
            }
        }
        
        // Copy inspection
        function copyInspection(index) {
            const inspection = planData.inspectionData[index];
            
            // Switch to add tab
            document.querySelectorAll('.tab-button')[0].click();
            
            // Fill form with copied data
            document.getElementById('inspectorSelect').value = inspection.inspector;
            document.getElementById('areaSelect').value = inspection.area;
            document.getElementById('shiftSelect').value = inspection.shift || 'ÿµÿ®ÿßÿ≠Ÿäÿ©';
            
            // Set date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('inspectionDate').valueAsDate = tomorrow;
            
            // Pre-select shops (if they're available)
            selectedShops = [...inspection.shops];
            
            updateAvailableShops();
            
            alert('‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥! ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸÖÿ≠ŸÑÿßÿ™ Ÿàÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¨ÿØŸäÿØ.');
        }
        
        // Delete selected inspections
        async function deleteSelectedInspections() {
            const checkboxes = document.querySelectorAll('.inspection-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÖÿ±ÿßÿØ ÿ≠ÿ∞ŸÅŸáÿß');
                return;
            }
            
            if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ${checkboxes.length} ÿ™ŸÅÿ™Ÿäÿ¥ÿü`)) {
                return;
            }
            
            try {
                // Get indices and sort in descending order (to delete from end to start)
                const indices = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => b - a);
                
                // Delete inspections
                indices.forEach(index => {
                    planData.inspectionData.splice(index, 1);
                });
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`ÿ≠ÿ∞ŸÅ ${indices.length} ÿ™ŸÅÿ™Ÿäÿ¥`);
                
                alert(`‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${indices.length} ÿ™ŸÅÿ™Ÿäÿ¥ ÿ®ŸÜÿ¨ÿßÿ≠!`);
                filterInspections();
                
            } catch (error) {
                alert('‚ùå ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™: ' + error.message);
            }
        }
        
        // Export inspections
        function exportInspections() {
            const filterInspector = document.getElementById('filterInspector').value;
            const dataToExport = filterInspector ? 
                planData.inspectionData.filter(i => i.inspector === filterInspector) : 
                planData.inspectionData;
            
            const jsonStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inspections-${filterInspector || 'all'}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Load inspector statistics
        function loadInspectorStats() {
            const inspector = document.getElementById('statsInspector').value;
            const container = document.getElementById('statsContainer');
            
            if (!inspector) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">üìä</div><p>ÿßÿÆÿ™ÿ± ŸÖŸÅÿ™ÿ¥ÿßŸã ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</p></div>';
                return;
            }
            
            // Calculate statistics
            const inspections = planData.inspectionData.filter(i => i.inspector === inspector);
            const totalInspections = inspections.length;
            const totalShops = inspections.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0);
            const areas = new Set(inspections.map(i => i.area)).size;
            const uniqueShops = new Set();
            inspections.forEach(i => i.shops && i.shops.forEach(s => uniqueShops.add(s)));
            
            // Get date range
            const dates = inspections.map(i => new Date(i.day)).sort((a, b) => a - b);
            const firstDate = dates.length > 0 ? dates[0].toLocaleDateString('ar-EG') : '-';
            const lastDate = dates.length > 0 ? dates[dates.length - 1].toLocaleDateString('ar-EG') : '-';
            
            // Calculate inspections per area
            const areaCount = {};
            inspections.forEach(i => {
                areaCount[i.area] = (areaCount[i.area] || 0) + 1;
            });
            
            let html = '<div class="inspector-stats">';
            html += `<div class="stat-card"><div class="stat-value">${totalInspections}</div><div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${totalShops}</div><div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${uniqueShops.size}</div><div class="stat-label">ŸÖÿ≠ŸÑÿßÿ™ ŸÅÿ±ŸäÿØÿ©</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${areas}</div><div class="stat-label">ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿ∫ÿ∑ÿßÿ©</div></div>`;
            html += '</div>';
            
            html += '<div style="margin-top: 30px;">';
            html += '<h3 style="color: #2d3561; margin-bottom: 15px;">üìÖ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©</h3>';
            html += `<p><strong>ÿ£ŸàŸÑ ÿ™ŸÅÿ™Ÿäÿ¥:</strong> ${firstDate}</p>`;
            html += `<p><strong>ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥:</strong> ${lastDate}</p>`;
            html += '</div>';
            
            html += '<div style="margin-top: 30px;">';
            html += '<h3 style="color: #2d3561; margin-bottom: 15px;">üó∫Ô∏è ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</h3>';
            for (const [area, count] of Object.entries(areaCount).sort((a, b) => b[1] - a[1])) {
                html += `<div style="padding: 10px; background: #f8f9fa; margin-bottom: 5px; border-radius: 8px;">`;
                html += `<strong>${escapeHtml(area)}:</strong> ${count} ÿ™ŸÅÿ™Ÿäÿ¥`;
                html += `</div>`;
            }
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Populate stats inspector dropdown
        function populateStatsInspector() {
            const select = document.getElementById('statsInspector');
            select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const option = document.createElement('option');
                    option.value = inspector.name;
                    option.textContent = inspector.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load calendar
        function loadCalendar() {
            const monthInput = document.getElementById('calendarMonth').value;
            const container = document.getElementById('calendarContainer');
            
            if (!monthInput) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">üìÖ</div><p>ÿßÿÆÿ™ÿ± ÿßŸÑÿ¥Ÿáÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇŸàŸäŸÖ</p></div>';
                return;
            }
            
            const [year, month] = monthInput.split('-').map(Number);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const daysInMonth = lastDay.getDate();
            
            // Get inspections for this month
            const monthStr = monthInput;
            const monthInspections = planData.inspectionData.filter(i => 
                i.day.startsWith(monthStr)
            );
            
            // Group by date
            const inspectionsByDate = {};
            monthInspections.forEach(i => {
                if (!inspectionsByDate[i.day]) {
                    inspectionsByDate[i.day] = [];
                }
                inspectionsByDate[i.day].push(i);
            });
            
            let html = '<div style="margin-bottom: 20px;">';
            html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; font-weight: bold; text-align: center; color: #667eea;">';
            const daysOfWeek = ['ÿßŸÑÿ£ÿ≠ÿØ', 'ÿßŸÑÿßÿ´ŸÜŸäŸÜ', 'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°', 'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°', 'ÿßŸÑÿÆŸÖŸäÿ≥', 'ÿßŸÑÿ¨ŸÖÿπÿ©', 'ÿßŸÑÿ≥ÿ®ÿ™'];
            daysOfWeek.forEach(day => {
                html += `<div style="padding: 10px;">${day}</div>`;
            });
            html += '</div>';
            html += '<div class="calendar-view">';
            
            // Add empty cells for days before first day of month
            const startDay = firstDay.getDay();
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day" style="opacity: 0.3;"></div>';
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayInspections = inspectionsByDate[dateStr] || [];
                const hasInspection = dayInspections.length > 0;
                
                html += `<div class="calendar-day ${hasInspection ? 'has-inspection' : ''}">`;
                html += `<div class="day-number">${day}</div>`;
                
                dayInspections.forEach(insp => {
                    html += `<div class="inspection-badge" title="${escapeHtml(insp.inspector)} - ${escapeHtml(insp.area)}">`;
                    html += `${escapeHtml(insp.inspector.split(' ')[1] || insp.inspector)}`;
                    html += `</div>`;
                });
                
                html += '</div>';
            }
            
            html += '</div></div>';
            
            // Add summary
            html += '<div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">';
            html += `<h3 style="color: #2d3561; margin-bottom: 15px;">üìä ŸÖŸÑÿÆÿµ ÿßŸÑÿ¥Ÿáÿ±</h3>`;
            html += `<p><strong>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™:</strong> ${monthInspections.length}</p>`;
            html += `<p><strong>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™:</strong> ${monthInspections.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0)}</p>`;
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Save inspection to GitHub
        async function saveInspection() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const shift = document.getElementById('shiftSelect').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector || !date || !area || selectedShops.length === 0) {
                showMessage('planningStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ŸàÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿ≠ŸÑÿßÿ™');
                return;
            }
            
            // Check for duplicate shops assigned to other inspectors on the same day
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÉÿ±ÿ±ÿ© ŸÖÿÆÿµÿµÿ© ŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ÿ¢ÿÆÿ±ŸäŸÜ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ
            const duplicateShops = [];
            for (const inspection of planData.inspectionData) {
                // Skip if it's the same inspector (will be handled separately)
                if (inspection.inspector === inspector && inspection.day === date) {
                    continue;
                }
                
                // Check if it's the same day but different inspector
                if (inspection.day === date) {
                    const inspectionShops = inspection.shops || [];
                    for (const shop of selectedShops) {
                        if (inspectionShops.includes(shop)) {
                            duplicateShops.push({
                                shop: shop,
                                inspector: inspection.inspector
                            });
                        }
                    }
                }
            }
            
            // If duplicate shops found with other inspectors, prevent saving
            if (duplicateShops.length > 0) {
                let errorMessage = '‚ùå ÿÆÿ∑ÿ£: ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥!\n\n';
                errorMessage += 'ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ™ÿßŸÑŸäÿ© ŸÖÿÆÿµÿµÿ© ÿ®ÿßŸÑŸÅÿπŸÑ ŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ÿ¢ÿÆÿ±ŸäŸÜ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ:\n\n';
                
                const shopsByInspector = {};
                duplicateShops.forEach(dup => {
                    if (!shopsByInspector[dup.inspector]) {
                        shopsByInspector[dup.inspector] = [];
                    }
                    shopsByInspector[dup.inspector].push(dup.shop);
                });
                
                for (const [otherInspector, shops] of Object.entries(shopsByInspector)) {
                    errorMessage += `\nüî∏ ${otherInspector}:\n`;
                    shops.forEach(shop => {
                        errorMessage += `   ‚Ä¢ ${shop}\n`;
                    });
                }
                
                errorMessage += '\n‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ≤ÿßŸÑÿ© Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ£Ÿà ÿßÿÆÿ™Ÿäÿßÿ± ŸäŸàŸÖ ÿ¢ÿÆÿ±.';
                errorMessage += '\n\nüí° ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ŸäŸÖŸÉŸÜ ÿ™ÿÆÿµŸäÿµ ŸÜŸÅÿ≥ ÿßŸÑŸÖÿ≠ŸÑ ŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÖÿÆÿ™ŸÑŸÅŸäŸÜ ŸÅŸä ÿ£ŸäÿßŸÖ ŸÖÿÆÿ™ŸÑŸÅÿ©.';
                
                showMessage('planningStatus', 'error', errorMessage);
                document.getElementById('saveBtn').disabled = false;
                return;
            }
            
            // Check for duplicate inspection (same inspector and date)
            const duplicateIndex = planData.inspectionData.findIndex(insp => 
                insp.inspector === inspector && insp.day === date
            );
            
            let confirmMessage = `ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞ÿß ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿü\n\nÿßŸÑŸÖŸÅÿ™ÿ¥: ${inspector}\nÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${date}\nÿßŸÑŸÖÿ≠ŸÑÿßÿ™: ${selectedShops.length}`;
            
            if (duplicateIndex !== -1) {
                confirmMessage = `‚ö†Ô∏è ÿ™ŸÜÿ®ŸäŸá: ŸäŸàÿ¨ÿØ ÿ™ŸÅÿ™Ÿäÿ¥ ŸÖŸÉÿ±ÿ± ŸÑŸÜŸÅÿ≥ ÿßŸÑŸÖŸÅÿ™ÿ¥ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ!\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸÇÿØŸäŸÖ Ÿàÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¨ÿØŸäÿØÿü\n\nÿßŸÑŸÖŸÅÿ™ÿ¥: ${inspector}\nÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${date}\nÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©: ${selectedShops.length}`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            showMessage('planningStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥...');
            document.getElementById('saveBtn').disabled = true;
            
            try {
                // Delete duplicate if exists
                if (duplicateIndex !== -1) {
                    planData.inspectionData.splice(duplicateIndex, 1);
                    showMessage('planningStatus', 'info', '‚è≥ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸÖŸÉÿ±ÿ±... ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¨ÿØŸäÿØ...');
                }
                
                // Create new inspection entry
                const newInspection = {
                    inspector: inspector,
                    day: date,
                    shift: shift,
                    area: area,
                    shops: [...selectedShops]
                };
                
                // Add to plan data
                planData.inspectionData.push(newInspection);
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`ÿ•ÿ∂ÿßŸÅÿ© ÿ™ŸÅÿ™Ÿäÿ¥ ÿ¨ÿØŸäÿØ - ${inspector} - ${date}`);
                
                let successMsg = `‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüìä ÿßŸÑŸÖŸÅÿ™ÿ¥: ${inspector}\nüìÖ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${date}\nüè™ ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™: ${selectedShops.length}`;
                
                if (duplicateIndex !== -1) {
                    successMsg += '\n\nüóëÔ∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸÖŸÉÿ±ÿ± ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã';
                }
                
                successMsg += '\n\n‚ú® ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸÅŸàÿ±ÿßŸã ŸÅŸä ÿßŸÑŸÖŸàŸÇÿπ!';
                
                showMessage('planningStatus', 'success', successMsg);
                
                // Reset form
                setTimeout(() => {
                    resetForm();
                }, 3000);
                
            } catch (error) {
                showMessage('planningStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥: ' + error.message);
                document.getElementById('saveBtn').disabled = false;
            }
        }
        
        // Save plan data to GitHub
        async function savePlanDataToGitHub(commitMessage = null) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖŸÑŸÅ plan-data.json');
            }
            
            const file = await getRes.json();
            const sha = file.sha;
            
            // Prepare content
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(planData, null, 2))));
            
            // Default commit message if not provided
            if (!commitMessage) {
                const inspector = document.getElementById('inspectorSelect').value;
                const date = document.getElementById('inspectionDate').value;
                commitMessage = `ÿ•ÿ∂ÿßŸÅÿ© ÿ™ŸÅÿ™Ÿäÿ¥ ÿ¨ÿØŸäÿØ - ${inspector} - ${date}`;
            }
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateRes.ok) {
                throw new Error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅ plan-data.json');
            }
        }
        
        // Reset form
        function resetForm() {
            document.getElementById('inspectorSelect').value = '';
            document.getElementById('inspectionDate').valueAsDate = new Date();
            document.getElementById('shiftSelect').value = 'ÿµÿ®ÿßÿ≠Ÿäÿ©';
            document.getElementById('areaSelect').value = '';
            selectedShops = [];
            
            // Clear search input and hide search box
            const searchInput = document.getElementById('inspectionShopSearch');
            const searchBox = document.getElementById('inspectionShopSearchBox');
            if (searchInput) {
                searchInput.value = '';
            }
            if (searchBox) {
                searchBox.style.display = 'none';
            }
            
            document.getElementById('shopsListContainer').innerHTML = 
                '<p style="text-align: center; color: #999; padding: 20px;">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥ ŸàÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</p>';
            
            document.getElementById('selectedShopsContainer').style.display = 'none';
            document.getElementById('inspectionPreview').style.display = 'none';
            document.getElementById('saveBtn').disabled = true;
            
            updateStatistics(0, 0, []);
        }
        
        // Show message
        function showMessage(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.className = `status-message ${type} show`;
            el.textContent = message;
            
            setTimeout(() => {
                el.classList.remove('show');
            }, type === 'success' ? 5000 : 10000);
        }
        
        // Check if user is already logged in
        window.onload = function() {
            const savedToken = localStorage.getItem('devToken');
            if (savedToken) {
                document.getElementById('githubToken').value = savedToken;
                // Auto-set the token in the global variable
                githubToken = savedToken;
                // Load maintenance config immediately if we have a token
                loadMaintenanceConfig();
            }
        };
        
        // ============================================
        // SHOPS MANAGEMENT FUNCTIONS
        // ============================================
        
        // Load shops management tab
        function loadShopsManagement() {
            populateShopAreaFilter();
            displayShopsList();
        }
        
        // Populate area filter for shops
        function populateShopAreaFilter() {
            const select = document.getElementById('filterShopArea');
            select.innerHTML = '<option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Display shops list with full details from shops_details.json
        async function displayShopsList() {
            const tbody = document.getElementById('shopsManagementBody');
            const searchTerm = document.getElementById('searchShop').value.toLowerCase();
            const filterAreaId = document.getElementById('filterShopArea').value;
            
            // Use global shopsDetails for consistency with Smart Shop List
            // This ensures all 306 shops are visible to developers
            let currentShopsDetails = shopsDetails || {};
            
            // If global shopsDetails is not loaded (e.g., not logged in), try loading from local file
            if (!shopsDetails || Object.keys(shopsDetails).length === 0) {
                try {
                    const response = await fetch('shops_details.json?' + new Date().getTime());
                    if (response.ok) {
                        currentShopsDetails = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading shops_details.json:', error);
                }
            }
            
            const totalShopsInDetails = Object.keys(currentShopsDetails).length;
            
            // Create combined shop list from both sources
            const allShops = [];
            
            // Add ALL shops from shops_details.json for developer access
            Object.entries(currentShopsDetails).forEach(([shopName, shopInfo]) => {
                allShops.push({
                    name: shopInfo.nameAr || shopName,
                    nameEn: shopInfo.nameEn || '',
                    licenseNo: shopInfo.licenseNo || '',
                    admCode: shopInfo.admCode || '',
                    address: shopInfo.address || '',
                    contact: shopInfo.contact || '',
                    locationMap: shopInfo.locationMap || '',
                    activity: shopInfo.activity || '',
                    area: shopInfo.area || '',
                    areaId: shopInfo.areaId || '',
                    source: 'shops_details'
                });
            });
            
            // Add shops from plan-data.json if not already in list
            if (planData && planData.shops) {
                planData.shops.forEach(shop => {
                    if (!allShops.find(s => s.name === shop.name)) {
                        allShops.push({
                            ...shop,
                            source: 'plan_data'
                        });
                    }
                });
            }
            
            // Filter shops
            let filteredShops = allShops.filter(shop => {
                const matchesSearch = shop.name.toLowerCase().includes(searchTerm) ||
                                    (shop.nameEn && shop.nameEn.toLowerCase().includes(searchTerm)) ||
                                    (shop.licenseNo && shop.licenseNo.toLowerCase().includes(searchTerm)) ||
                                    (shop.admCode && shop.admCode.toLowerCase().includes(searchTerm));
                const matchesArea = !filterAreaId || shop.areaId === filterAreaId || shop.area === filterAreaId;
                return matchesSearch && matchesArea;
            });
            
            // Update statistics
            document.getElementById('totalShopsManagement').textContent = allShops.length;
            document.getElementById('filteredShopsCount').textContent = filteredShops.length;
            document.getElementById('totalAreasInShops').textContent = planData?.areas ? planData.areas.length : 0;
            
            if (filteredShops.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ∑ÿßÿ®ŸÇÿ©</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            filteredShops.forEach((shop, idx) => {
                const area = planData?.areas?.find(a => a.id === shop.areaId || a.name === shop.area);
                const tr = document.createElement('tr');
                
                // Create detailed shop info popup
                let shopDetails = `<strong>${shop.name}</strong>`;
                if (shop.nameEn) shopDetails += `<br><small style="color: #666;">${shop.nameEn}</small>`;
                if (shop.licenseNo) shopDetails += `<br><small>üîñ ÿ±ÿÆÿµÿ©: ${shop.licenseNo}</small>`;
                if (shop.admCode) shopDetails += `<br><small>üî¢ ŸÉŸàÿØ ADM: ${shop.admCode}</small>`;
                if (shop.address) shopDetails += `<br><small>üìç ${shop.address}</small>`;
                if (shop.contact) shopDetails += `<br><small>üìû ${shop.contact}</small>`;
                if (shop.activity) shopDetails += `<br><small>üíº ${shop.activity}</small>`;
                if (shop.locationMap) shopDetails += `<br><small><a href="${shop.locationMap}" target="_blank">üó∫Ô∏è ÿπÿ±ÿ∂ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©</a></small>`;
                
                tr.innerHTML = `
                    <td>
                        <div style="cursor: help;" title="${shop.nameEn || ''}">${shop.name}</div>
                        ${shop.licenseNo ? `<small style="color: #999; display: block;">üîñ ${shop.licenseNo}</small>` : ''}
                        ${shop.admCode ? `<small style="color: #999; display: block;">üî¢ ${shop.admCode}</small>` : ''}
                    </td>
                    <td>${area ? area.name : (shop.area || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ')}</td>
                    <td style="font-family: monospace; font-size: 0.85em;">${shop.id || shop.admCode || idx}</td>
                    <td>
                        <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                            <button class="action-btn action-btn-view" onclick="viewShopDetails('${escapeJs(shop.name)}')" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ">
                                <span>üëÅÔ∏è</span>
                                <span class="action-btn-text">ÿπÿ±ÿ∂</span>
                            </button>
                            <button class="action-btn action-btn-edit" onclick="openEditShopModal('${escapeJs(shop.name)}')" title="ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ">
                                <span>‚úèÔ∏è</span>
                                <span class="action-btn-text">ÿ™ÿπÿØŸäŸÑ</span>
                            </button>
                            <button class="action-btn action-btn-delete" onclick="deleteShop('${escapeJs(shop.name)}')" title="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑ">
                                <span>üóëÔ∏è</span>
                                <span class="action-btn-text">ÿ≠ÿ∞ŸÅ</span>
                            </button>
                            <button class="action-btn action-btn-copy" onclick="copyShopInfo('${escapeJs(shop.name)}')" title="ŸÜÿ≥ÿÆ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™">
                                <span>üìã</span>
                                <span class="action-btn-text">ŸÜÿ≥ÿÆ</span>
                            </button>
                            ${shop.locationMap ? `<button class="action-btn action-btn-map" onclick="window.open('${shop.locationMap}', '_blank')" title="ŸÖŸàŸÇÿπ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©">
                                <span>üó∫Ô∏è</span>
                                <span class="action-btn-text">ÿÆÿ±Ÿäÿ∑ÿ©</span>
                            </button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Show success message if we loaded shops from details
            if (totalShopsInDetails > 0) {
                console.log(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${totalShopsInDetails} ŸÖÿ≠ŸÑ ŸÖŸÜ shops_details.json`);
            }
        }
        
        // View shop full details
        function viewShopDetails(shopName) {
            fetch('shops_details.json?' + new Date().getTime())
                .then(response => response.json())
                .then(shopsDetails => {
                    const shop = shopsDetails[shopName];
                    
                    // Find shop in planData to get area information
                    let planShop = null;
                    if (planData && planData.shops) {
                        planShop = planData.shops.find(s => s.name === shopName);
                    }
                    
                    let details = `üè™ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ ÿßŸÑŸÉÿßŸÖŸÑÿ©\n`;
                    details += `${'='.repeat(50)}\n\n`;
                    details += `üìù ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä: ${shop?.nameAr || shopName}\n`;
                    
                    if (shop?.nameEn) details += `üìù ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä: ${shop.nameEn}\n`;
                    if (shop?.licenseNo) details += `üîñ ÿ±ŸÇŸÖ ÿßŸÑÿ±ÿÆÿµÿ©: ${shop.licenseNo}\n`;
                    if (shop?.admCode) details += `üî¢ ŸÉŸàÿØ ADM: ${shop.admCode}\n`;
                    if (shop?.address) details += `üìç ÿßŸÑÿπŸÜŸàÿßŸÜ: ${shop.address}\n`;
                    if (shop?.contact) details += `üìû ÿßŸÑŸáÿßÿ™ŸÅ: ${shop.contact}\n`;
                    if (shop?.activity) details += `üíº ÿßŸÑŸÜÿ¥ÿßÿ∑: ${shop.activity}\n`;
                    if (shop?.locationMap) details += `üó∫Ô∏è ÿßŸÑŸÖŸàŸÇÿπ: ŸÖÿ™ŸàŸÅÿ± ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©\n`;
                    
                    // Add area information from planData if available
                    if (planShop) {
                        if (planShop.id) details += `üÜî ÿßŸÑŸÖÿπÿ±ŸÅ: ${planShop.id}\n`;
                        if (planShop.area) details += `üó∫Ô∏è ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: ${planShop.area}\n`;
                    }
                    
                    // If no detailed info found, show basic info
                    if (!shop && !planShop) {
                        details += `\n‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿßÿµŸäŸÑ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÖÿ™ŸàŸÅÿ±ÿ© ŸÑŸáÿ∞ÿß ÿßŸÑŸÖÿ≠ŸÑ\n`;
                        details += `‚ÑπÔ∏è Ÿäÿ∏Ÿáÿ± ÿßŸÑŸÖÿ≠ŸÑ ŸÅŸä ÿ¨ÿØÿßŸàŸÑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ŸÅŸÇÿ∑\n`;
                    }
                    
                    alert(details);
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Show basic shop info even on error
                    let details = `üè™ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©\n`;
                    details += `${'='.repeat(50)}\n\n`;
                    details += `üìù ÿßŸÑÿßÿ≥ŸÖ: ${shopName}\n`;
                    details += `\n‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÉÿßŸÖŸÑÿ© ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ\n`;
                    details += `‚ÑπÔ∏è Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ\n`;
                    alert(details);
                });
        }
        
        // Copy shop info
        function copyShopInfo(shopName) {
            fetch('shops_details.json?' + new Date().getTime())
                .then(response => response.json())
                .then(shopsDetails => {
                    const shop = shopsDetails[shopName];
                    if (!shop) {
                        navigator.clipboard.writeText(shopName).then(() => {
                            alert('‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ');
                        });
                        return;
                    }
                    
                    let info = `${shop.nameAr || shopName}`;
                    if (shop.nameEn) info += ` | ${shop.nameEn}`;
                    if (shop.licenseNo) info += ` | ÿ±ÿÆÿµÿ©: ${shop.licenseNo}`;
                    if (shop.admCode) info += ` | ADM: ${shop.admCode}`;
                    
                    navigator.clipboard.writeText(info).then(() => {
                        alert('‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑ');
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    navigator.clipboard.writeText(shopName).then(() => {
                        alert('‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ');
                    });
                });
        }
        
        // Filter shops list
        function filterShopsList() {
            displayShopsList();
        }
        
        // Refresh shops list
        async function refreshShopsList() {
            showMessage('shopsManagementStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
            try {
                await loadPlanData();
                displayShopsList();
                showMessage('shopsManagementStatus', 'success', '‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
            } catch (error) {
                showMessage('shopsManagementStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message);
            }
        }
        
        // Open add shop modal
        function openAddShopModal() {
            document.getElementById('shopModalTitle').innerHTML = '‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ';
            document.getElementById('shopModalId').value = '';
            document.getElementById('shopModalName').value = '';
            document.getElementById('shopModalArea').value = '';
            
            // Clear optional fields
            document.getElementById('shopModalNameEn').value = '';
            document.getElementById('shopModalLicense').value = '';
            document.getElementById('shopModalAddress').value = '';
            document.getElementById('shopModalPhone').value = '';
            document.getElementById('shopModalEmail').value = '';
            document.getElementById('shopModalGoogleMaps').value = '';
            document.getElementById('shopModalActivity').value = '';
            document.getElementById('shopModalAdmCode').value = '';
            
            // Populate areas dropdown
            const select = document.getElementById('shopModalArea');
            select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©...</option>';
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
            
            document.getElementById('shopModal').style.display = 'block';
        }
        
        // Open edit shop modal - accepts shop ID or shop name
        function openEditShopModal(shopIdOrName) {
            // Check if planData is loaded
            if (!planData) {
                alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿ≠ÿ™Ÿâ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                return;
            }
            
            // Initialize shops array if it doesn't exist
            if (!planData.shops) {
                planData.shops = [];
            }
            
            // Try to find shop by ID first, then by name
            let shop = planData.shops.find(s => s.id === shopIdOrName);
            if (!shop) {
                // Try finding by name
                shop = planData.shops.find(s => s.name === shopIdOrName);
            }
            
            // If still not found, create a new shop entry
            if (!shop) {
                // This might be a shop from shops_details.json not yet in plan-data
                console.log('Shop not found in plan-data, will create new entry:', shopIdOrName);
                shop = {
                    id: '',  // Will be generated when saving
                    name: shopIdOrName,
                    areaId: '',
                    area: ''
                };
            }
            
            document.getElementById('shopModalTitle').innerHTML = '‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ŸÖÿ≠ŸÑ';
            document.getElementById('shopModalId').value = shop.id || '';
            document.getElementById('shopModalName').value = shop.name;
            
            // Populate areas dropdown
            const select = document.getElementById('shopModalArea');
            select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©...</option>';
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
            select.value = shop.areaId;
            
            // Load additional details from shops_details.json
            fetch('shops_details.json?' + new Date().getTime())
                .then(response => response.json())
                .then(shopsDetails => {
                    const details = shopsDetails[shop.name];
                    if (details) {
                        document.getElementById('shopModalNameEn').value = details.nameEn || '';
                        document.getElementById('shopModalLicense').value = details.licenseNo || '';
                        document.getElementById('shopModalAddress').value = details.address || '';
                        document.getElementById('shopModalPhone').value = details.contact || '';
                        document.getElementById('shopModalEmail').value = details.email || '';
                        document.getElementById('shopModalGoogleMaps').value = details.locationMap || '';
                        document.getElementById('shopModalActivity').value = details.activity || '';
                        document.getElementById('shopModalAdmCode').value = details.admCode || '';
                        
                        // If shop was not in planData.shops, update the area from shops_details
                        if (!shop.areaId && details.areaId) {
                            select.value = details.areaId;
                        }
                    } else {
                        // Clear optional fields if no details found
                        document.getElementById('shopModalNameEn').value = '';
                        document.getElementById('shopModalLicense').value = '';
                        document.getElementById('shopModalAddress').value = '';
                        document.getElementById('shopModalPhone').value = '';
                        document.getElementById('shopModalEmail').value = '';
                        document.getElementById('shopModalGoogleMaps').value = '';
                        document.getElementById('shopModalActivity').value = '';
                        document.getElementById('shopModalAdmCode').value = '';
                    }
                })
                .catch(error => {
                    console.error('Error loading shop details:', error);
                    // Clear optional fields on error
                    document.getElementById('shopModalNameEn').value = '';
                    document.getElementById('shopModalLicense').value = '';
                    document.getElementById('shopModalAddress').value = '';
                    document.getElementById('shopModalPhone').value = '';
                    document.getElementById('shopModalEmail').value = '';
                    document.getElementById('shopModalGoogleMaps').value = '';
                    document.getElementById('shopModalActivity').value = '';
                    document.getElementById('shopModalAdmCode').value = '';
                });
            
            document.getElementById('shopModal').style.display = 'block';
        }
        
        // Close shop modal
        function closeShopModal() {
            document.getElementById('shopModal').style.display = 'none';
        }
        
        // Save shop (add or edit)
        async function saveShop() {
            const shopId = document.getElementById('shopModalId').value;
            const shopName = document.getElementById('shopModalName').value.trim();
            const areaId = document.getElementById('shopModalArea').value;
            
            // Get optional fields
            const shopNameEn = document.getElementById('shopModalNameEn').value.trim();
            const licenseNo = document.getElementById('shopModalLicense').value.trim();
            const address = document.getElementById('shopModalAddress').value.trim();
            const contact = document.getElementById('shopModalPhone').value.trim();
            const email = document.getElementById('shopModalEmail').value.trim();
            
            // ‚ö†Ô∏è CRITICAL: locationMap MUST be manually provided - NO AUTO-GENERATION
            // ‚ö†Ô∏è ÿ≠ÿ±ÿ¨: locationMap Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ™ŸÖ ÿ™ŸàŸÅŸäÿ±Ÿá ŸäÿØŸàŸäÿßŸã - ŸÑÿß ÿ™ŸàŸÑŸäÿØ ÿ™ŸÑŸÇÿßÿ¶Ÿä
            // DO NOT auto-generate Google Maps links from address or coordinates
            // ŸÑÿß ÿ™ŸÇŸÖ ÿ®ÿ™ŸàŸÑŸäÿØ ÿ±Ÿàÿßÿ®ÿ∑ ÿÆÿ±ÿßÿ¶ÿ∑ ÿ¨Ÿàÿ¨ŸÑ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÖŸÜ ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ£Ÿà ÿßŸÑÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™
            // Requirement: Manual Google Maps links ONLY for 100% accuracy
            // ŸÖÿ™ÿ∑ŸÑÿ®: ÿ±Ÿàÿßÿ®ÿ∑ ÿÆÿ±ÿßÿ¶ÿ∑ ÿ¨Ÿàÿ¨ŸÑ ŸäÿØŸàŸäÿ© ŸÅŸÇÿ∑ ŸÑÿ∂ŸÖÿßŸÜ ÿØŸÇÿ© 100%
            const locationMap = document.getElementById('shopModalGoogleMaps').value.trim();
            
            const activity = document.getElementById('shopModalActivity').value.trim();
            const admCode = document.getElementById('shopModalAdmCode').value.trim();
            
            if (!shopName) {
                showMessage('shopModalStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ');
                return;
            }
            
            if (!areaId) {
                showMessage('shopModalStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©');
                return;
            }
            
            showMessage('shopModalStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...');
            
            try {
                let oldShopName = null;
                
                // Update or add shop in plan-data.json
                if (shopId) {
                    // Edit existing shop
                    const shopIndex = planData.shops.findIndex(s => s.id === shopId);
                    if (shopIndex !== -1) {
                        oldShopName = planData.shops[shopIndex].name;
                        planData.shops[shopIndex].name = shopName;
                        planData.shops[shopIndex].areaId = areaId;
                        
                        // Get area name for display
                        const area = planData.areas.find(a => a.id === areaId);
                        if (area) {
                            planData.shops[shopIndex].area = area.name;
                        }
                    }
                } else {
                    // Add new shop
                    const area = planData.areas.find(a => a.id === areaId);
                    const newShop = {
                        id: 'shop_' + Date.now(),
                        name: shopName,
                        areaId: areaId,
                        area: area ? area.name : ''
                    };
                    planData.shops.push(newShop);
                }
                
                // If shop name changed, update it in all inspection data
                if (oldShopName && oldShopName !== shopName) {
                    if (planData.inspectionData) {
                        for (const inspection of planData.inspectionData) {
                            if (inspection.shops) {
                                inspection.shops = inspection.shops.map(s => 
                                    s === oldShopName ? shopName : s
                                );
                            }
                        }
                    }
                }
                
                // Save to plan-data.json on GitHub
                await savePlanDataToGitHub(`ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ≠ŸÑ: ${shopName}`);
                
                // Save additional details to shops_details.json if any optional field is filled
                if (shopNameEn || licenseNo || address || contact || email || locationMap || activity || admCode) {
                    await saveShopDetailsToGitHub(shopName, {
                        nameAr: shopName,
                        nameEn: shopNameEn,
                        licenseNo: licenseNo,
                        address: address,
                        contact: contact,
                        email: email,
                        locationMap: locationMap,
                        activity: activity,
                        admCode: admCode
                    });
                }
                
                // Reload plan data from GitHub to ensure we have the latest data
                await loadPlanData();
                
                showMessage('shopModalStatus', 'success', '‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿ®ŸÜÿ¨ÿßÿ≠ - ÿßŸÑŸÖÿ≠ŸÑ ÿ∏ÿßŸáÿ± ÿßŸÑÿ¢ŸÜ ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ©');
                setTimeout(() => {
                    closeShopModal();
                    displayShopsList();
                    populateAreas(); // Refresh main form areas
                    // Only refresh smart shop list if the modal is currently visible
                    const smartShopModal = document.getElementById('smartShopListModal');
                    if (smartShopModal && smartShopModal.style.display === 'block') {
                        updateSmartShopList(); // Refresh smart shop list if visible
                    }
                }, 1500);
                
            } catch (error) {
                showMessage('shopModalStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏: ' + error.message);
            }
        }
        
        // Save shop details to shops_details.json on GitHub
        async function saveShopDetailsToGitHub(shopName, details) {
            try {
                // Get current shops_details.json file
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getRes.ok) {
                    throw new Error('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖŸÑŸÅ shops_details.json');
                }
                
                const file = await getRes.json();
                const sha = file.sha;
                
                // Decode and parse current content
                const currentContent = JSON.parse(decodeURIComponent(escape(atob(file.content))));
                
                // Update or add shop details - remove empty fields
                const cleanDetails = {};
                if (details.nameAr) cleanDetails.nameAr = details.nameAr;
                if (details.nameEn) cleanDetails.nameEn = details.nameEn;
                if (details.licenseNo) cleanDetails.licenseNo = details.licenseNo;
                if (details.address) cleanDetails.address = details.address;
                if (details.contact) cleanDetails.contact = details.contact;
                if (details.email) cleanDetails.email = details.email;
                if (details.locationMap) cleanDetails.locationMap = details.locationMap;
                if (details.activity) cleanDetails.activity = details.activity;
                if (details.admCode) cleanDetails.admCode = details.admCode;
                
                currentContent[shopName] = cleanDetails;
                
                // Prepare content
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(currentContent, null, 2))));
                
                // Update file
                const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `ÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ: ${shopName}`,
                        content: content,
                        sha: sha
                    })
                });
                
                if (!updateRes.ok) {
                    throw new Error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅ shops_details.json');
                }
            } catch (error) {
                console.error('Error saving shop details:', error);
                // Don't throw - optional details save failure shouldn't block main save
            }
        }
        
        // Delete shop from shops_details.json on GitHub
        async function deleteShopDetailsFromGitHub(shopName) {
            try {
                // Get current shops_details.json file
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getRes.ok) {
                    throw new Error('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖŸÑŸÅ shops_details.json');
                }
                
                const file = await getRes.json();
                const sha = file.sha;
                
                // Decode and parse current content
                const currentContent = JSON.parse(decodeURIComponent(escape(atob(file.content))));
                
                // Check if shop exists in shops_details.json
                if (!currentContent[shopName]) {
                    return false; // Shop not found in shops_details
                }
                
                // Delete shop from shops_details
                delete currentContent[shopName];
                
                // Update global shopsDetails if it exists
                if (shopsDetails && shopsDetails[shopName]) {
                    delete shopsDetails[shopName];
                }
                
                // Prepare content
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(currentContent, null, 2))));
                
                // Update file
                const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `ÿ≠ÿ∞ŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ: ${shopName}`,
                        content: content,
                        sha: sha
                    })
                });
                
                if (!updateRes.ok) {
                    throw new Error('ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑ ŸÖŸÜ shops_details.json');
                }
                
                return true; // Successfully deleted
            } catch (error) {
                console.error('Error deleting shop from shops_details:', error);
                throw error;
            }
        }
        
        // Delete shop
        async function deleteShop(shopIdOrName) {
            // Check authentication first
            if (!githubToken) {
                alert('‚ö†Ô∏è Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã ŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™');
                return;
            }
            
            // Check if planData is loaded
            if (!planData) {
                alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿ≠ÿ™Ÿâ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                return;
            }
            
            // Initialize shops array if it doesn't exist
            if (!planData.shops) {
                planData.shops = [];
            }
            
            // Try to find shop by ID first, then by name in shops array
            let shop = planData.shops.find(s => s.id === shopIdOrName);
            if (!shop) {
                shop = planData.shops.find(s => s.name === shopIdOrName);
            }
            
            // Determine the shop name to delete
            let shopNameToDelete = shop ? shop.name : shopIdOrName;
            
            // Check if shop exists in inspection data
            let foundInInspections = false;
            let inspectionCount = 0;
            if (planData.inspectionData) {
                for (const inspection of planData.inspectionData) {
                    if (inspection.shops && inspection.shops.includes(shopNameToDelete)) {
                        foundInInspections = true;
                        inspectionCount++;
                    }
                }
            }
            
            // Check if shop exists in shops_details.json
            let foundInShopsDetails = false;
            if (shopsDetails && shopsDetails[shopNameToDelete]) {
                foundInShopsDetails = true;
            }
            
            // If shop not found in any source (shops array, inspection data, or shops_details)
            if (!shop && !foundInInspections && !foundInShopsDetails) {
                showMessage('shopsManagementStatus', 'error', '‚ùå ÿßŸÑŸÖÿ≠ŸÑ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                alert('‚ùå ÿßŸÑŸÖÿ≠ŸÑ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                return;
            }
            
            // Build confirmation message
            let confirmMsg = `ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑ "${shopNameToDelete}"ÿü\n\n`;
            if (shop) {
                confirmMsg += `üìç ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©\n`;
            }
            if (foundInInspections) {
                confirmMsg += `üìã ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ${inspectionCount} ÿ¨ÿØŸàŸÑ ÿ™ŸÅÿ™Ÿäÿ¥\n`;
            }
            if (foundInShopsDetails) {
                confirmMsg += `üìù ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™\n`;
            }
            confirmMsg += `\n‚ö†Ô∏è Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            showMessage('shopsManagementStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ÿ∞ŸÅ...');
            
            try {
                let changesCount = 0;
                
                // Remove shop from shops array if it exists there
                if (shop) {
                    const beforeCount = planData.shops.length;
                    planData.shops = planData.shops.filter(s => s.id !== shop.id && s.name !== shop.name);
                    changesCount += (beforeCount - planData.shops.length);
                }
                
                // Remove shop from all inspection data
                if (planData.inspectionData) {
                    for (const inspection of planData.inspectionData) {
                        if (inspection.shops) {
                            const beforeCount = inspection.shops.length;
                            inspection.shops = inspection.shops.filter(s => s !== shopNameToDelete);
                            changesCount += (beforeCount - inspection.shops.length);
                        }
                    }
                }
                
                // Save plan-data.json changes to GitHub if there were any changes
                let planDataChanges = changesCount;
                if (planDataChanges > 0) {
                    await savePlanDataToGitHub(`ÿ≠ÿ∞ŸÅ ŸÖÿ≠ŸÑ: ${shopNameToDelete} (${planDataChanges} ÿ™ÿπÿØŸäŸÑ)`);
                }
                
                // Delete shop from shops_details.json if it exists there
                let shopsDetailsDeleted = false;
                if (foundInShopsDetails) {
                    try {
                        await deleteShopDetailsFromGitHub(shopNameToDelete);
                        shopsDetailsDeleted = true;
                    } catch (error) {
                        console.error('Error deleting from shops_details:', error);
                        // Continue even if shops_details deletion fails
                    }
                }
                
                // Build success message
                let successMsg = '‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠';
                if (planDataChanges > 0 && shopsDetailsDeleted) {
                    successMsg += ` (${planDataChanges} ÿ™ÿπÿØŸäŸÑ ŸÅŸä plan-data + ÿ≠ÿ∞ŸÅ ŸÖŸÜ shops_details)`;
                } else if (planDataChanges > 0) {
                    successMsg += ` (${planDataChanges} ÿ™ÿπÿØŸäŸÑ ŸÅŸä plan-data)`;
                } else if (shopsDetailsDeleted) {
                    successMsg += ` (ÿ≠ÿ∞ŸÅ ŸÖŸÜ shops_details ŸÅŸÇÿ∑)`;
                }
                
                showMessage('shopsManagementStatus', 'success', successMsg);
                displayShopsList();
                populateAreas(); // Refresh main form areas
                
                // If the area shops view modal is open, refresh it
                const areaShopsModal = document.getElementById('areaShopsViewModal');
                if (areaShopsModal && areaShopsModal.style.display === 'block') {
                    loadShopsForSelectedArea();
                }
                
            } catch (error) {
                console.error('Error deleting shop:', error);
                showMessage('shopsManagementStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿ∞ŸÅ: ' + error.message);
                alert('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿ∞ŸÅ: ' + error.message);
            }
        }
        
        // Copy shop ID
        function copyShopId(shopId) {
            navigator.clipboard.writeText(shopId).then(() => {
                showMessage('shopsManagementStatus', 'success', '‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑŸÖÿπÿ±ŸÅ');
            });
        }
        
        // Export shops data
        function exportShopsData() {
            if (!planData || !planData.shops) return;
            
            const dataStr = JSON.stringify(planData.shops, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'shops-export-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
            
            showMessage('shopsManagementStatus', 'success', '‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
        }
        
        // Find orphan shops (shops in inspection data but not in shops array)
        function findOrphanShops() {
            if (!planData || !planData.inspectionData) {
                alert('‚ùå ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©');
                return;
            }
            
            // Get all shops from shops array
            const shopsInArray = new Set(planData.shops.map(s => s.name));
            
            // Get all unique shops from inspection data
            const shopsInInspections = new Set();
            planData.inspectionData.forEach(inspection => {
                if (inspection.shops) {
                    inspection.shops.forEach(shop => shopsInInspections.add(shop));
                }
            });
            
            // Find orphan shops
            const orphanShops = Array.from(shopsInInspections).filter(shop => !shopsInArray.has(shop));
            
            if (orphanShops.length === 0) {
                alert(`‚úÖ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿπÿ≤ŸàŸÑÿ©!\n\nÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÅŸä ÿ¨ÿØÿßŸàŸÑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ (${shopsInInspections.size}) ŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© (${shopsInArray.size})`);
                return;
            }
            
            // Show report
            let report = `üìä ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿπÿ≤ŸàŸÑÿ©\n`;
            report += `${'='.repeat(50)}\n\n`;
            report += `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÅŸä ÿ¨ÿØÿßŸàŸÑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥: ${shopsInInspections.size}\n`;
            report += `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©: ${shopsInArray.size}\n`;
            report += `ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿπÿ≤ŸàŸÑÿ© (ŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ŸÅŸÇÿ∑): ${orphanShops.length}\n\n`;
            report += `ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿπÿ≤ŸàŸÑÿ©:\n`;
            report += `${'='.repeat(50)}\n`;
            
            orphanShops.sort().forEach((shop, idx) => {
                report += `${idx + 1}. ${shop}\n`;
            });
            
            report += `\n${'='.repeat(50)}\n`;
            report += `üí° ŸÜÿµŸäÿ≠ÿ©: ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ•ŸÑŸâ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©\n`;
            report += `ŸÖŸÜ ÿÆŸÑÿßŸÑ ÿ≤ÿ± "ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ" ŸÅŸä ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™`;
            
            // Create a modal to show the report
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                max-width: 90%;
                max-height: 90%;
                overflow: auto;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            `;
            
            const pre = document.createElement('pre');
            pre.textContent = report;
            pre.style.cssText = `
                white-space: pre-wrap;
                font-family: 'Cairo', monospace;
                font-size: 14px;
                line-height: 1.6;
                direction: rtl;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '‚úñ ÿ•ÿ∫ŸÑÿßŸÇ';
            closeBtn.className = 'btn btn-secondary';
            closeBtn.style.cssText = 'margin-top: 20px; width: 100%; padding: 10px;';
            closeBtn.onclick = () => document.body.removeChild(modal);
            
            content.appendChild(pre);
            content.appendChild(closeBtn);
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Also log to console for developers
            console.log('Orphan Shops Report:', orphanShops);
        }
        
        // ============================================
        // AREAS MANAGEMENT FUNCTIONS
        // ============================================
        
        // Load areas management tab
        function loadAreasManagement() {
            displayAreasList();
        }
        
        // Display areas list
        function displayAreasList() {
            const tbody = document.getElementById('areasManagementBody');
            const searchTerm = document.getElementById('searchArea').value.toLowerCase();
            
            if (!planData || !planData.areas) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</td></tr>';
                return;
            }
            
            let filteredAreas = planData.areas.filter(area => {
                return area.name.toLowerCase().includes(searchTerm);
            });
            
            // Update statistics
            const totalShops = planData.shops ? planData.shops.length : 0;
            document.getElementById('totalAreasManagement').textContent = planData.areas.length;
            document.getElementById('filteredAreasCount').textContent = filteredAreas.length;
            document.getElementById('totalShopsInAreas').textContent = totalShops;
            
            if (filteredAreas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿßÿ∑ŸÇ ŸÖÿ∑ÿßÿ®ŸÇÿ©</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            filteredAreas.forEach(area => {
                const shopsCount = planData.shops.filter(s => s.areaId === area.id).length;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${area.name}</td>
                    <td style="font-family: monospace; font-size: 0.85em;">${area.id}</td>
                    <td>${shopsCount} ŸÖÿ≠ŸÑ</td>
                    <td>
                        <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                            <button class="action-btn action-btn-view" onclick="viewAreaShops('${area.id}')" title="ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™" role="button" aria-label="ÿπÿ±ÿ∂ ŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©">
                                <span>üè™</span>
                                <span class="action-btn-text">ŸÖÿ≠ŸÑÿßÿ™</span>
                            </button>
                            <button class="action-btn action-btn-edit" onclick="openEditAreaModal('${area.id}')" title="ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©">
                                <span>‚úèÔ∏è</span>
                                <span class="action-btn-text">ÿ™ÿπÿØŸäŸÑ</span>
                            </button>
                            <button class="action-btn action-btn-delete" onclick="deleteArea('${area.id}')" title="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©">
                                <span>üóëÔ∏è</span>
                                <span class="action-btn-text">ÿ≠ÿ∞ŸÅ</span>
                            </button>
                            <button class="action-btn action-btn-copy" onclick="copyAreaId('${area.id}')" title="ŸÜÿ≥ÿÆ ÿßŸÑŸÖÿπÿ±ŸÅ">
                                <span>üìã</span>
                                <span class="action-btn-text">ŸÜÿ≥ÿÆ</span>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Filter areas list
        function filterAreasList() {
            displayAreasList();
        }
        
        // Refresh areas list
        async function refreshAreasList() {
            showMessage('areasManagementStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
            try {
                await loadPlanData();
                displayAreasList();
                showMessage('areasManagementStatus', 'success', '‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
            } catch (error) {
                showMessage('areasManagementStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message);
            }
        }
        
        // Sort areas by name
        function sortAreasByName() {
            if (!planData || !planData.areas) return;
            
            planData.areas.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            displayAreasList();
            showMessage('areasManagementStatus', 'success', '‚úÖ ÿ™ŸÖ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿ£ÿ®ÿ¨ÿØŸäÿßŸã');
        }
        
        // Sort areas by smart priority (areas with more shops and lower ratings get priority)
        function sortAreasBySmartPriority() {
            if (!planData || !planData.areas) return;
            
            planData.areas.sort((a, b) => {
                // Calculate priority score for each area
                const scoreA = calculateAreaPriorityScore(a);
                const scoreB = calculateAreaPriorityScore(b);
                return scoreB - scoreA; // Higher priority first
            });
            
            displayAreasList();
            showMessage('areasManagementStatus', 'success', '‚úÖ ÿ™ŸÖ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿ≠ÿ≥ÿ® ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑÿ∞ŸÉŸäÿ©');
        }
        
        // Sort areas by shop count (descending)
        function sortAreasByShopCount() {
            if (!planData || !planData.areas) return;
            
            planData.areas.sort((a, b) => {
                const countA = planData.shops.filter(s => s.areaId === a.id).length;
                const countB = planData.shops.filter(s => s.areaId === b.id).length;
                return countB - countA; // More shops first
            });
            
            displayAreasList();
            showMessage('areasManagementStatus', 'success', '‚úÖ ÿ™ŸÖ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿ≠ÿ≥ÿ® ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™');
        }
        
        // Calculate area priority score
        function calculateAreaPriorityScore(area) {
            let score = 0;
            
            // Get shops in this area
            const shopsInArea = planData.shops.filter(s => s.areaId === area.id);
            const shopCount = shopsInArea.length;
            
            // 1. Shop count factor (0-40 points) - More shops = higher priority
            score += Math.min(shopCount * 4, 40);
            
            // 2. Average rating factor (0-40 points) - Lower average rating = higher priority
            if (shopCount > 0 && shopsDetails) {
                let totalRating = 0;
                let ratedShops = 0;
                
                shopsInArea.forEach(shop => {
                    const shopDetail = shopsDetails[shop.name];
                    if (shopDetail) {
                        const ratingData = calculateShopRating(shop.name);
                        totalRating += ratingData.rating;
                        ratedShops++;
                    }
                });
                
                if (ratedShops > 0) {
                    const avgRating = totalRating / ratedShops;
                    // Invert: 0% avg rating = 40 points, 100% avg rating = 0 points
                    score += (100 - avgRating) * 0.4;
                }
            }
            
            // 3. Inspection coverage factor (0-20 points) - Fewer inspected shops = higher priority
            if (shopCount > 0) {
                const inspectedShops = shopsInArea.filter(shop => {
                    const lastInsp = getLastInspectionForShop(shop.name);
                    return lastInsp !== null;
                }).length;
                const coveragePercent = (inspectedShops / shopCount) * 100;
                // Lower coverage = higher priority
                score += (100 - coveragePercent) * 0.2;
            }
            
            return score;
        }
        
        // Open add area modal
        function openAddAreaModal() {
            document.getElementById('areaModalTitle').innerHTML = '‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇÿ© ÿ¨ÿØŸäÿØÿ©';
            document.getElementById('areaModalId').value = '';
            document.getElementById('areaModalName').value = '';
            document.getElementById('areaModal').style.display = 'block';
        }
        
        // Open edit area modal
        function openEditAreaModal(areaId) {
            // Check if planData is loaded
            if (!planData) {
                alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿ≠ÿ™Ÿâ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                return;
            }
            
            // Initialize areas array if it doesn't exist
            if (!planData.areas) {
                planData.areas = [];
            }
            
            const area = planData.areas.find(a => a.id === areaId);
            if (!area) return;
            
            document.getElementById('areaModalTitle').innerHTML = '‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ŸÖŸÜÿ∑ŸÇÿ©';
            document.getElementById('areaModalId').value = area.id;
            document.getElementById('areaModalName').value = area.name;
            document.getElementById('areaModal').style.display = 'block';
        }
        
        // Close area modal
        function closeAreaModal() {
            document.getElementById('areaModal').style.display = 'none';
        }
        
        // Save area (add or edit)
        async function saveArea() {
            const areaId = document.getElementById('areaModalId').value;
            const areaName = document.getElementById('areaModalName').value.trim();
            
            if (!areaName) {
                showMessage('areaModalStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©');
                return;
            }
            
            showMessage('areaModalStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...');
            
            try {
                if (areaId) {
                    // Edit existing area
                    const areaIndex = planData.areas.findIndex(a => a.id === areaId);
                    if (areaIndex !== -1) {
                        planData.areas[areaIndex].name = areaName;
                    }
                } else {
                    // Add new area
                    const newArea = {
                        id: 'area_' + Date.now(),
                        name: areaName
                    };
                    planData.areas.push(newArea);
                }
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('areaModalStatus', 'success', '‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿ®ŸÜÿ¨ÿßÿ≠');
                setTimeout(() => {
                    closeAreaModal();
                    displayAreasList();
                    populateAreas(); // Refresh main form areas
                    populateShopAreaFilter(); // Refresh shops filter
                }, 1000);
                
            } catch (error) {
                showMessage('areaModalStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏: ' + error.message);
            }
        }
        
        // Delete area
        async function deleteArea(areaId) {
            // Check authentication first
            if (!githubToken) {
                alert('‚ö†Ô∏è Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã ŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ');
                return;
            }
            
            // Check if planData is loaded
            if (!planData) {
                alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿ≠ÿ™Ÿâ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                return;
            }
            
            // Initialize arrays if they don't exist
            if (!planData.areas) {
                planData.areas = [];
            }
            if (!planData.shops) {
                planData.shops = [];
            }
            
            const area = planData.areas.find(a => a.id === areaId);
            if (!area) return;
            
            // Check if area has shops
            const shopsInArea = planData.shops.filter(s => s.areaId === areaId).length;
            if (shopsInArea > 0) {
                if (!confirm(`ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© "${area.name}" ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ${shopsInArea} ŸÖÿ≠ŸÑ. ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ≠ÿ∞ŸÅÿü\nÿ≥Ÿäÿ™ŸÖ ŸÜŸÇŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ•ŸÑŸâ "ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ".`)) {
                    return;
                }
            } else {
                if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© "${area.name}"ÿü`)) {
                    return;
                }
            }
            
            showMessage('areasManagementStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ÿ∞ŸÅ...');
            
            try {
                // Remove area from array
                planData.areas = planData.areas.filter(a => a.id !== areaId);
                
                // Update shops that belong to this area (set to null or empty)
                planData.shops.forEach(shop => {
                    if (shop.areaId === areaId) {
                        shop.areaId = '';
                    }
                });
                
                // Save to GitHub
                await savePlanDataToGitHub(`ÿ≠ÿ∞ŸÅ ŸÖŸÜÿ∑ŸÇÿ©: ${area.name}`);
                
                showMessage('areasManagementStatus', 'success', '‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                displayAreasList();
                populateAreas(); // Refresh main form areas
                
            } catch (error) {
                showMessage('areasManagementStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿ∞ŸÅ: ' + error.message);
            }
        }
        
        // Copy area ID
        function copyAreaId(areaId) {
            navigator.clipboard.writeText(areaId).then(() => {
                showMessage('areasManagementStatus', 'success', '‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑŸÖÿπÿ±ŸÅ');
            });
        }
        
        // ============================================
        // SHOPS BY AREA VIEW FUNCTIONS
        // ============================================
        
        // Open shops by area modal
        function openShopsByAreaModal() {
            document.getElementById('shopsByAreaModal').style.display = 'block';
            populateShopsByAreaFilter();
            updateShopsByAreaView();
        }
        
        // Close shops by area modal
        function closeShopsByAreaModal() {
            document.getElementById('shopsByAreaModal').style.display = 'none';
        }
        
        // Populate area filter for shops by area view
        function populateShopsByAreaFilter() {
            const select = document.getElementById('shopsByAreaFilter');
            select.innerHTML = '<option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Update shops by area view
        async function updateShopsByAreaView() {
            const searchTerm = document.getElementById('shopsByAreaSearch').value.toLowerCase();
            const filterAreaId = document.getElementById('shopsByAreaFilter').value;
            const viewType = document.getElementById('shopsByAreaViewType').value;
            const contentDiv = document.getElementById('shopsByAreaContent');
            
            // Use global shopsDetails for consistency, ensuring all shops are visible
            let currentShopsDetails = shopsDetails || {};
            
            // If global shopsDetails is not loaded, try loading from local file
            if (!shopsDetails || Object.keys(shopsDetails).length === 0) {
                try {
                    const response = await fetch('shops_details.json?' + new Date().getTime());
                    if (response.ok) {
                        currentShopsDetails = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading shops_details.json:', error);
                }
            }
            
            // Create combined shop list
            const allShops = [];
            
            // Add ALL shops from shops_details.json
            Object.entries(currentShopsDetails).forEach(([shopName, shopInfo]) => {
                allShops.push({
                    name: shopInfo.nameAr || shopName,
                    nameEn: shopInfo.nameEn || '',
                    licenseNo: shopInfo.licenseNo || '',
                    admCode: shopInfo.admCode || '',
                    address: shopInfo.address || '',
                    contact: shopInfo.contact || '',
                    locationMap: shopInfo.locationMap || '',
                    activity: shopInfo.activity || '',
                    area: shopInfo.area || '',
                    areaId: shopInfo.areaId || '',
                });
            });
            
            // Add shops from plan-data.json if not already in list
            if (planData && planData.shops) {
                planData.shops.forEach(shop => {
                    if (!allShops.find(s => s.name === shop.name)) {
                        allShops.push(shop);
                    }
                });
            }
            
            // Filter shops
            let filteredShops = allShops.filter(shop => {
                const matchesSearch = shop.name.toLowerCase().includes(searchTerm) ||
                                    (shop.nameEn && shop.nameEn.toLowerCase().includes(searchTerm)) ||
                                    (shop.licenseNo && shop.licenseNo.toLowerCase().includes(searchTerm));
                const matchesArea = !filterAreaId || shop.areaId === filterAreaId;
                return matchesSearch && matchesArea;
            });
            
            // Update statistics
            const uniqueAreas = new Set(allShops.map(s => s.areaId).filter(id => id));
            document.getElementById('shopsByAreaTotalShops').textContent = allShops.length;
            document.getElementById('shopsByAreaTotalAreas').textContent = uniqueAreas.size;
            document.getElementById('shopsByAreaDisplayed').textContent = filteredShops.length;
            
            // Display based on view type
            if (viewType === 'grouped') {
                displayShopsGroupedByArea(filteredShops, contentDiv);
            } else {
                displayShopsAsList(filteredShops, contentDiv);
            }
        }
        
        // Display shops grouped by area
        function displayShopsGroupedByArea(shops, contentDiv) {
            const shopsByArea = {};
            
            // Group shops by area
            shops.forEach(shop => {
                const area = planData?.areas?.find(a => a.id === shop.areaId);
                const areaName = area ? area.name : (shop.area || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ');
                const areaId = shop.areaId || 'unknown';
                
                if (!shopsByArea[areaId]) {
                    shopsByArea[areaId] = {
                        name: areaName,
                        shops: []
                    };
                }
                shopsByArea[areaId].shops.push(shop);
            });
            
            let html = '';
            
            // Sort areas alphabetically
            const sortedAreas = Object.entries(shopsByArea).sort((a, b) => 
                a[1].name.localeCompare(b[1].name, 'ar')
            );
            
            sortedAreas.forEach(([areaId, areaData]) => {
                html += `
                    <div style="margin-bottom: 30px; background: #f8f9fa; padding: 20px; border-radius: 10px; border-right: 5px solid #e74c3c;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
                            <span>
                                <span style="color: #e74c3c;">üìç</span> ${areaData.name}
                                <span style="background: #e74c3c; color: white; padding: 3px 12px; border-radius: 15px; font-size: 0.85em; margin-right: 10px;">
                                    ${areaData.shops.length} ŸÖÿ≠ŸÑ
                                </span>
                            </span>
                            <button class="btn btn-sm btn-primary" onclick="viewAreaShops('${areaId}')" style="padding: 5px 15px;">
                                <span>üîç</span> ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
                            </button>
                        </h3>
                        <div style="overflow-x: auto;">
                            <table class="inspections-table">
                                <thead>
                                    <tr>
                                        <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ</th>
                                        <th>ÿ±ŸÇŸÖ ÿßŸÑÿ±ÿÆÿµÿ©</th>
                                        <th>ŸÉŸàÿØ ADM</th>
                                        <th>ÿßŸÑÿπŸÜŸàÿßŸÜ</th>
                                        <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                areaData.shops.forEach(shop => {
                    html += `
                        <tr>
                            <td>
                                <strong>${shop.name}</strong>
                                ${shop.nameEn ? `<br><small style="color: #666;">${shop.nameEn}</small>` : ''}
                            </td>
                            <td>${shop.licenseNo || '-'}</td>
                            <td style="font-family: monospace;">${shop.admCode || '-'}</td>
                            <td>${shop.address || '-'}</td>
                            <td>
                                <span class="action-icon" onclick="viewShopDetails('${escapeJs(shop.name)}')" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ" style="color: #3498db;">üëÅÔ∏è</span>
                                ${shop.locationMap ? `<span class="action-icon" onclick="window.open('${shop.locationMap}', '_blank')" title="ŸÖŸàŸÇÿπ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©" style="color: #27ae60;">üó∫Ô∏è</span>` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<p style="text-align: center; padding: 40px; color: #999;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ∑ÿßÿ®ŸÇÿ©</p>';
            }
            
            contentDiv.innerHTML = html;
        }
        
        // Display shops as a list
        function displayShopsAsList(shops, contentDiv) {
            let html = `
                <div style="overflow-x: auto;">
                    <table class="inspections-table">
                        <thead>
                            <tr>
                                <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ</th>
                                <th>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                                <th>ÿ±ŸÇŸÖ ÿßŸÑÿ±ÿÆÿµÿ©</th>
                                <th>ŸÉŸàÿØ ADM</th>
                                <th>ÿßŸÑÿπŸÜŸàÿßŸÜ</th>
                                <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            shops.forEach(shop => {
                const area = planData?.areas?.find(a => a.id === shop.areaId);
                const areaName = area ? area.name : (shop.area || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ');
                
                html += `
                    <tr>
                        <td>
                            <strong>${shop.name}</strong>
                            ${shop.nameEn ? `<br><small style="color: #666;">${shop.nameEn}</small>` : ''}
                        </td>
                        <td><span style="background: #e74c3c; color: white; padding: 3px 10px; border-radius: 5px; font-size: 0.9em;">${areaName}</span></td>
                        <td>${shop.licenseNo || '-'}</td>
                        <td style="font-family: monospace;">${shop.admCode || '-'}</td>
                        <td>${shop.address || '-'}</td>
                        <td>
                            <span class="action-icon" onclick="viewShopDetails('${escapeJs(shop.name)}')" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ" style="color: #3498db;">üëÅÔ∏è</span>
                            ${shop.locationMap ? `<span class="action-icon" onclick="window.open('${shop.locationMap}', '_blank')" title="ŸÖŸàŸÇÿπ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©" style="color: #27ae60;">üó∫Ô∏è</span>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            if (shops.length === 0) {
                html = '<p style="text-align: center; padding: 40px; color: #999;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ∑ÿßÿ®ŸÇÿ©</p>';
            }
            
            contentDiv.innerHTML = html;
        }
        
        // ============================================
        // AREA SHOPS VIEW FUNCTIONS (View shops of specific area)
        // ============================================
        
        // Open area shops view modal
        function openAreaShopsViewModal() {
            document.getElementById('areaShopsViewModal').style.display = 'block';
            populateAreaShopsViewSelect();
        }
        
        // Close area shops view modal
        function closeAreaShopsViewModal() {
            document.getElementById('areaShopsViewModal').style.display = 'none';
            document.getElementById('selectedAreaInfo').style.display = 'none';
            document.getElementById('areaShopsViewContent').innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">ÿßÿÆÿ™ÿ± ŸÖŸÜÿ∑ŸÇÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ™ÿßÿ®ÿπÿ© ŸÑŸáÿß</p>';
        }
        
        // Populate area select for area shops view
        function populateAreaShopsViewSelect() {
            const select = document.getElementById('areaShopsViewSelect');
            select.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ŸÖŸÜÿ∑ŸÇÿ© --</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load shops for selected area
        async function loadShopsForSelectedArea() {
            const areaId = document.getElementById('areaShopsViewSelect').value;
            const contentDiv = document.getElementById('areaShopsViewContent');
            const infoDiv = document.getElementById('selectedAreaInfo');
            
            if (!areaId) {
                infoDiv.style.display = 'none';
                contentDiv.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">ÿßÿÆÿ™ÿ± ŸÖŸÜÿ∑ŸÇÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ™ÿßÿ®ÿπÿ© ŸÑŸáÿß</p>';
                return;
            }
            
            const area = planData?.areas?.find(a => a.id === areaId);
            if (!area) {
                showMessage('areaShopsViewStatus', 'error', '‚ùå ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                return;
            }
            
            // Show area info
            infoDiv.style.display = 'block';
            document.getElementById('selectedAreaName').textContent = area.name;
            
            // Use global shopsDetails for consistency
            let currentShopsDetails = shopsDetails || {};
            
            // If global shopsDetails is not loaded, try loading from local file
            if (!shopsDetails || Object.keys(shopsDetails).length === 0) {
                try {
                    const response = await fetch('shops_details.json?' + new Date().getTime());
                    if (response.ok) {
                        currentShopsDetails = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading shops_details.json:', error);
                }
            }
            
            // Get shops for this area
            const areaShops = [];
            
            // From shops_details.json
            Object.entries(currentShopsDetails).forEach(([shopName, shopInfo]) => {
                if (shopInfo.areaId === areaId) {
                    areaShops.push({
                        name: shopInfo.nameAr || shopName,
                        nameEn: shopInfo.nameEn || '',
                        licenseNo: shopInfo.licenseNo || '',
                        admCode: shopInfo.admCode || '',
                        address: shopInfo.address || '',
                        contact: shopInfo.contact || '',
                        locationMap: shopInfo.locationMap || '',
                        activity: shopInfo.activity || '',
                    });
                }
            });
            
            // From plan-data.json
            if (planData && planData.shops) {
                planData.shops.forEach(shop => {
                    if (shop.areaId === areaId && !areaShops.find(s => s.name === shop.name)) {
                        areaShops.push(shop);
                    }
                });
            }
            
            // Count inspections for this area
            const inspectionsCount = planData?.inspectionData?.filter(insp => insp.area === area.name).length || 0;
            
            // Update statistics
            document.getElementById('selectedAreaShopsCount').textContent = areaShops.length;
            document.getElementById('selectedAreaInspections').textContent = inspectionsCount;
            
            // Display shops
            if (areaShops.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #fff3cd; border-radius: 10px; color: #856404;">
                        <h3>‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</h3>
                        <p style="margin-top: 10px;">ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑÿßÿ™ ÿ¨ÿØŸäÿØÿ© ÿ£Ÿà ŸÜŸÇŸÑ ŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜ ŸÖŸÜÿßÿ∑ŸÇ ÿ£ÿÆÿ±Ÿâ</p>
                        <button class="btn btn-success" onclick="closeAreaShopsViewModal(); openAddShopModal();" style="margin-top: 15px;">
                            <span>‚ûï</span> ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50;">üìã ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ (${areaShops.length} ŸÖÿ≠ŸÑ)</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="closeAreaShopsViewModal(); openAddShopModal();">
                                <span>‚ûï</span> ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ
                            </button>
                            <button class="btn btn-warning" onclick="openMoveShopsFromArea('${areaId}')">
                                <span>‚ÜîÔ∏è</span> ŸÜŸÇŸÑ ŸÖÿ≠ŸÑÿßÿ™
                            </button>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="inspections-table">
                            <thead>
                                <tr>
                                    <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ</th>
                                    <th>ÿ±ŸÇŸÖ ÿßŸÑÿ±ÿÆÿµÿ©</th>
                                    <th>ŸÉŸàÿØ ADM</th>
                                    <th>ÿßŸÑÿπŸÜŸàÿßŸÜ</th>
                                    <th>ÿßŸÑŸáÿßÿ™ŸÅ</th>
                                    <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            areaShops.forEach((shop, idx) => {
                html += `
                    <tr>
                        <td>
                            <strong>${shop.name}</strong>
                            ${shop.nameEn ? `<br><small style="color: #666;">${shop.nameEn}</small>` : ''}
                        </td>
                        <td>${shop.licenseNo || '-'}</td>
                        <td style="font-family: monospace;">${shop.admCode || '-'}</td>
                        <td>${shop.address || '-'}</td>
                        <td>${shop.contact || '-'}</td>
                        <td>
                            <span class="action-icon" onclick="viewShopDetails('${escapeJs(shop.name)}')" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ" style="color: #3498db;">üëÅÔ∏è</span>
                            <span class="action-icon edit-icon" onclick="openEditShopModal('${escapeJs(shop.name)}')" title="ÿ™ÿπÿØŸäŸÑ">‚úèÔ∏è</span>
                            <span class="action-icon delete-icon" onclick="deleteShop('${escapeJs(shop.name)}')" title="ÿ≠ÿ∞ŸÅ">üóëÔ∏è</span>
                            ${shop.locationMap ? `<span class="action-icon" onclick="window.open('${shop.locationMap}', '_blank')" title="ŸÖŸàŸÇÿπ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©" style="color: #27ae60;">üó∫Ô∏è</span>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = html;
        }
        
        // View shops for a specific area (called from areas table)
        function viewAreaShops(areaId) {
            openAreaShopsViewModal();
            document.getElementById('areaShopsViewSelect').value = areaId;
            loadShopsForSelectedArea();
        }
        
        // ============================================
        // MOVE SHOPS BETWEEN AREAS FUNCTIONS
        // ============================================
        
        let selectedShopsForMove = [];
        
        // Open move shops modal
        function openMoveShopsModal() {
            document.getElementById('moveShopsModal').style.display = 'block';
            populateMoveShopsAreas();
            selectedShopsForMove = [];
            document.getElementById('moveShopsSelection').style.display = 'none';
            document.getElementById('moveShopsDestination').style.display = 'none';
        }
        
        // Open move shops modal from a specific area
        function openMoveShopsFromArea(areaId) {
            closeAreaShopsViewModal();
            openMoveShopsModal();
            document.getElementById('moveShopsSourceArea').value = areaId;
            loadShopsForMove();
        }
        
        // Close move shops modal
        function closeMoveShopsModal() {
            document.getElementById('moveShopsModal').style.display = 'none';
            selectedShopsForMove = [];
        }
        
        // Populate area selects for move shops
        function populateMoveShopsAreas() {
            const sourceSelect = document.getElementById('moveShopsSourceArea');
            const targetSelect = document.getElementById('moveShopsTargetArea');
            
            sourceSelect.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿµÿØÿ± --</option>';
            targetSelect.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≥ÿ™ŸáÿØŸÅÿ© --</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option1 = document.createElement('option');
                    option1.value = area.id;
                    option1.textContent = area.name;
                    sourceSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = area.id;
                    option2.textContent = area.name;
                    targetSelect.appendChild(option2);
                });
            }
        }
        
        // Load shops for move
        async function loadShopsForMove() {
            const areaId = document.getElementById('moveShopsSourceArea').value;
            const listDiv = document.getElementById('moveShopsList');
            
            if (!areaId) {
                document.getElementById('moveShopsSelection').style.display = 'none';
                document.getElementById('moveShopsDestination').style.display = 'none';
                return;
            }
            
            // Use global shopsDetails for consistency
            let currentShopsDetails = shopsDetails || {};
            
            // If global shopsDetails is not loaded, try loading from local file
            if (!shopsDetails || Object.keys(shopsDetails).length === 0) {
                try {
                    const response = await fetch('shops_details.json?' + new Date().getTime());
                    if (response.ok) {
                        currentShopsDetails = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading shops_details.json:', error);
                }
            }
            
            // Get shops for this area
            const areaShops = [];
            
            // From shops_details.json
            Object.entries(currentShopsDetails).forEach(([shopName, shopInfo]) => {
                if (shopInfo.areaId === areaId) {
                    areaShops.push({
                        name: shopInfo.nameAr || shopName,
                        originalName: shopName,
                        areaId: areaId
                    });
                }
            });
            
            // From plan-data.json
            if (planData && planData.shops) {
                planData.shops.forEach(shop => {
                    if (shop.areaId === areaId && !areaShops.find(s => s.name === shop.name)) {
                        areaShops.push({
                            name: shop.name,
                            originalName: shop.name,
                            areaId: areaId
                        });
                    }
                });
            }
            
            if (areaShops.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</p>';
                document.getElementById('moveShopsSelection').style.display = 'block';
                document.getElementById('moveShopsDestination').style.display = 'none';
                return;
            }
            
            // Display shops as checkboxes
            let html = '';
            areaShops.forEach((shop, idx) => {
                html += `
                    <div style="padding: 8px; border-bottom: 1px solid #dee2e6;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" class="move-shop-checkbox" value="${idx}" data-shop-name="${escapeHtml(shop.originalName)}" onchange="updateMoveShopsCount()" style="margin-left: 10px; transform: scale(1.3);">
                            <span style="font-weight: 500;">${shop.name}</span>
                        </label>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
            document.getElementById('moveShopsSelection').style.display = 'block';
            document.getElementById('moveShopsDestination').style.display = 'block';
            updateMoveShopsCount();
        }
        
        // Select all shops for move
        function selectAllShopsForMove() {
            document.querySelectorAll('.move-shop-checkbox').forEach(cb => {
                cb.checked = true;
            });
            updateMoveShopsCount();
        }
        
        // Deselect all shops for move
        function deselectAllShopsForMove() {
            document.querySelectorAll('.move-shop-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateMoveShopsCount();
        }
        
        // Update move shops count
        function updateMoveShopsCount() {
            const checkedBoxes = document.querySelectorAll('.move-shop-checkbox:checked');
            const count = checkedBoxes.length;
            const countSpan = document.getElementById('moveShopsSelectedCount');
            
            if (count > 0) {
                countSpan.textContent = `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ${count} ŸÖÿ≠ŸÑ`;
                countSpan.style.color = '#28a745';
            } else {
                countSpan.textContent = 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿ£Ÿä ŸÖÿ≠ŸÑ';
                countSpan.style.color = '#dc3545';
            }
        }
        
        // Execute move shops
        async function executeMoveShops() {
            const sourceAreaId = document.getElementById('moveShopsSourceArea').value;
            const targetAreaId = document.getElementById('moveShopsTargetArea').value;
            const checkedBoxes = document.querySelectorAll('.move-shop-checkbox:checked');
            
            if (!sourceAreaId) {
                showMessage('moveShopsStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿµÿØÿ±');
                return;
            }
            
            if (checkedBoxes.length === 0) {
                showMessage('moveShopsStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿØ ŸÖÿ≠ŸÑ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                return;
            }
            
            if (!targetAreaId) {
                showMessage('moveShopsStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≥ÿ™ŸáÿØŸÅÿ©');
                return;
            }
            
            if (sourceAreaId === targetAreaId) {
                showMessage('moveShopsStatus', 'error', '‚ùå ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿµÿØÿ± ŸàÿßŸÑŸÖÿ≥ÿ™ŸáÿØŸÅÿ© ŸÖÿ™ÿ∑ÿßÿ®ŸÇÿ™ÿßŸÜ');
                return;
            }
            
            const sourceArea = planData.areas.find(a => a.id === sourceAreaId);
            const targetArea = planData.areas.find(a => a.id === targetAreaId);
            
            if (!sourceArea || !targetArea) {
                showMessage('moveShopsStatus', 'error', '‚ùå ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                return;
            }
            
            // Get selected shop names
            const shopNames = Array.from(checkedBoxes).map(cb => cb.getAttribute('data-shop-name'));
            
            if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÜŸÇŸÑ ${shopNames.length} ŸÖÿ≠ŸÑ ŸÖŸÜ "${sourceArea.name}" ÿ•ŸÑŸâ "${targetArea.name}"ÿü`)) {
                return;
            }
            
            showMessage('moveShopsStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ŸÜŸÇŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™...');
            
            try {
                // Use global shopsDetails for consistency
                let currentShopsDetails = shopsDetails || {};
                
                // If global shopsDetails is not loaded, try loading from local file
                if (!shopsDetails || Object.keys(shopsDetails).length === 0) {
                    try {
                        const response = await fetch('shops_details.json?' + new Date().getTime());
                        if (response.ok) {
                            currentShopsDetails = await response.json();
                        }
                    } catch (error) {
                        console.error('Error loading shops_details.json:', error);
                    }
                }
                
                // Update shops in shops_details.json
                let updatedCount = 0;
                shopNames.forEach(shopName => {
                    if (currentShopsDetails[shopName]) {
                        currentShopsDetails[shopName].areaId = targetAreaId;
                        currentShopsDetails[shopName].area = targetArea.name;
                        updatedCount++;
                    }
                });
                
                // Update shops in plan-data.json
                if (planData && planData.shops) {
                    planData.shops.forEach(shop => {
                        if (shopNames.includes(shop.name)) {
                            shop.areaId = targetAreaId;
                            shop.area = targetArea.name;
                            updatedCount++;
                        }
                    });
                }
                
                // Note: Currently only updating plan-data.json
                // shops_details.json is maintained separately and loaded read-only for display purposes
                planData.lastUpdate = new Date().toISOString();
                await savePlanDataToGitHub(`ŸÜŸÇŸÑ ${shopNames.length} ŸÖÿ≠ŸÑ ŸÖŸÜ ${sourceArea.name} ÿ•ŸÑŸâ ${targetArea.name}`);
                
                showMessage('moveShopsStatus', 'success', `‚úÖ ÿ™ŸÖ ŸÜŸÇŸÑ ${shopNames.length} ŸÖÿ≠ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠ ÿ•ŸÑŸâ "${targetArea.name}"`);
                
                setTimeout(() => {
                    closeMoveShopsModal();
                    // Refresh displays
                    if (document.getElementById('shopsByAreaModal').style.display === 'block') {
                        updateShopsByAreaView();
                    }
                    if (document.getElementById('shopsTab').classList.contains('active')) {
                        displayShopsList();
                    }
                    if (document.getElementById('areasTab').classList.contains('active')) {
                        displayAreasList();
                    }
                }, 2000);
                
            } catch (error) {
                showMessage('moveShopsStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ŸÜŸÇŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™: ' + error.message);
            }
        }
        
        // ============================================
        // MAINTENANCE CONTROL FUNCTIONS
        // ============================================
        
        let maintenanceConfigData = null;
        let maintenanceStatusData = null;
        
        // Load maintenance configuration
        async function loadMaintenanceConfig() {
            try {
                // Load maintenance-config.json
                const configRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-config.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (configRes.ok) {
                    const configFile = await configRes.json();
                    maintenanceConfigData = JSON.parse(decodeURIComponent(escape(atob(configFile.content))));
                }
                
                // Load maintenance-status.json
                const statusRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (statusRes.ok) {
                    const statusFile = await statusRes.json();
                    maintenanceStatusData = JSON.parse(decodeURIComponent(escape(atob(statusFile.content))));
                }
                
                // Update UI with loaded data
                updateMaintenanceUI();
                
            } catch (error) {
                console.error('Error loading maintenance config:', error);
            }
        }
        
        // Update maintenance UI with current values
        function updateMaintenanceUI() {
            if (!maintenanceConfigData || !maintenanceStatusData) return;
            
            // Update maintenance status
            const isEnabled = maintenanceStatusData.enabled === true;
            document.getElementById('maintenanceStatusLabel').textContent = isEnabled ? 'üü¢ ŸÖŸÅÿπŸÑÿ©' : 'üî¥ ŸÖÿ™ŸàŸÇŸÅÿ©';
            document.getElementById('maintenanceStatusLabel').style.color = isEnabled ? '#38ef7d' : '#ff6b6b';
            
            // Update buttons
            if (isEnabled) {
                document.getElementById('enableMaintenanceBtn').style.opacity = '0.5';
                document.getElementById('disableMaintenanceBtn').style.opacity = '1';
            } else {
                document.getElementById('enableMaintenanceBtn').style.opacity = '1';
                document.getElementById('disableMaintenanceBtn').style.opacity = '0.5';
            }
            
            // Update music status
            const musicEnabled = maintenanceConfigData.musicEnabled === true;
            document.getElementById('musicStatusLabel').textContent = musicEnabled ? 'üîä ŸÖŸÅÿπŸÑÿ©' : 'üîá ŸÖÿ™ŸàŸÇŸÅÿ©';
            document.getElementById('musicStatusLabel').style.color = musicEnabled ? '#38ef7d' : '#ff6b6b';
            
            // Update buttons
            if (musicEnabled) {
                document.getElementById('enableMusicBtn').style.opacity = '0.5';
                document.getElementById('disableMusicBtn').style.opacity = '1';
            } else {
                document.getElementById('enableMusicBtn').style.opacity = '1';
                document.getElementById('disableMusicBtn').style.opacity = '0.5';
            }
            
            // Update volume slider
            const volume = Math.round((maintenanceConfigData.musicVolume || 0.1) * 100);
            document.getElementById('volumeSlider').value = volume;
            document.getElementById('volumeDisplay').textContent = `üîä ${volume}%`;
            
            // Update music duration
            const duration = maintenanceConfigData.musicDuration || 600000;
            let durationText = '';
            if (duration === -1) {
                durationText = '‚ôæÔ∏è ŸÖÿ≥ÿ™ŸÖÿ± (ÿ∫Ÿäÿ± ŸÖÿ≠ÿØŸàÿØ)';
            } else {
                const minutes = Math.floor(duration / 60000);
                if (minutes === 1) {
                    durationText = '‚è±Ô∏è ÿØŸÇŸäŸÇÿ© Ÿàÿßÿ≠ÿØÿ©';
                } else {
                    durationText = `‚è±Ô∏è ${minutes} ÿØŸÇŸäŸÇÿ©`;
                }
            }
            document.getElementById('musicDurationLabel').textContent = durationText;
            
            // Load and update tap to stop status
            loadTapToStopStatus();
            
            // Update last update info
            const lastUpdate = maintenanceConfigData.lastUpdated || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            const updatedBy = maintenanceConfigData.updatedBy || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            document.getElementById('lastUpdateLabel').textContent = new Date(lastUpdate).toLocaleString('ar-EG');
            document.getElementById('updatedByLabel').textContent = updatedBy;
        }
        
        // Load tap to stop status
        async function loadTapToStopStatus() {
            try {
                const audioConfigData = await loadAudioConfig();
                const tapToStopEnabled = audioConfigData.backgroundMusic?.tapToStop || false;
                updateTapToStopUI(tapToStopEnabled);
            } catch (error) {
                console.error('Error loading tap to stop status:', error);
                // Default to disabled
                updateTapToStopUI(false);
            }
        }
        
        // Toggle maintenance message on/off
        async function toggleMaintenanceMessage(enable) {
            if (!githubToken) {
                showMessage('maintenanceToggleStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            
            // Disable buttons and show immediate feedback
            const enableBtn = document.getElementById('enableMaintenanceBtn');
            const disableBtn = document.getElementById('disableMaintenanceBtn');
            
            if (enableBtn) enableBtn.disabled = true;
            if (disableBtn) disableBtn.disabled = true;
            
            showMessage('maintenanceToggleStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´...');
            
            try {
                // Update maintenance-status.json
                maintenanceStatusData.enabled = enable;
                maintenanceStatusData.disabledAt = new Date().toISOString();
                maintenanceStatusData.disabledBy = 'ÿßŸÑŸÖÿ∑Ÿàÿ± - Smart Planner';
                
                await saveMaintenanceStatus(`${enable ? 'ÿ™ŸÅÿπŸäŸÑ' : 'ÿ•ŸäŸÇÿßŸÅ'} ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÜ Smart Planner`);
                
                // Re-enable buttons
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('maintenanceToggleStatus', 'success', 
                    `‚úÖ ÿ™ŸÖ ${enable ? 'ÿ™ŸÅÿπŸäŸÑ' : 'ÿ•ŸäŸÇÿßŸÅ'} ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸÜÿ¨ÿßÿ≠! ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿßŸÜÿπŸÉÿ≥ÿ™ ŸÅŸàÿ±ÿßŸã ŸÅŸä GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                // Re-enable buttons on error
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('maintenanceToggleStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´: ' + error.message);
            }
        }
        
        // Toggle music on/off
        async function toggleMusic(enable) {
            if (!githubToken) {
                showMessage('musicControlStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            
            // Disable buttons and show immediate feedback
            const enableBtn = document.getElementById('enableMusicBtn');
            const disableBtn = document.getElementById('disableMusicBtn');
            
            if (enableBtn) enableBtn.disabled = true;
            if (disableBtn) disableBtn.disabled = true;
            
            showMessage('musicControlStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´...');
            
            try {
                // Update maintenance-config.json
                maintenanceConfigData.musicEnabled = enable;
                maintenanceConfigData.lastUpdated = new Date().toISOString();
                maintenanceConfigData.updatedBy = 'ÿßŸÑŸÖÿ∑Ÿàÿ± - Smart Planner';
                
                await saveMaintenanceConfig(`${enable ? 'ÿ™ŸÅÿπŸäŸÑ' : 'ÿ•ŸäŸÇÿßŸÅ'} ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ŸÖŸÜ Smart Planner`);
                
                // Re-enable buttons
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('musicControlStatus', 'success', 
                    `‚úÖ ÿ™ŸÖ ${enable ? 'ÿ™ŸÅÿπŸäŸÑ' : 'ÿ•ŸäŸÇÿßŸÅ'} ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ÿ®ŸÜÿ¨ÿßÿ≠! ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿßŸÜÿπŸÉÿ≥ÿ™ ŸÅŸàÿ±ÿßŸã ŸÅŸä GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                // Re-enable buttons on error
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('musicControlStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´: ' + error.message);
            }
        }
        
        // Update volume display
        function updateVolumeDisplay(value) {
            document.getElementById('volumeDisplay').textContent = `üîä ${value}%`;
        }
        
        // Save volume change
        async function saveVolumeChange(value) {
            if (!githubToken) {
                showMessage('musicControlStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            
            showMessage('musicControlStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿµŸàÿ™...');
            
            try {
                // Update maintenance-config.json
                maintenanceConfigData.musicVolume = parseInt(value) / 100;
                maintenanceConfigData.lastUpdated = new Date().toISOString();
                maintenanceConfigData.updatedBy = 'ÿßŸÑŸÖÿ∑Ÿàÿ± - Smart Planner';
                
                await saveMaintenanceConfig(`ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿµŸàÿ™ ÿ•ŸÑŸâ ${value}% ŸÖŸÜ Smart Planner`);
                
                showMessage('musicControlStatus', 'success', 
                    `‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿµŸàÿ™ ÿ•ŸÑŸâ ${value}% ÿ®ŸÜÿ¨ÿßÿ≠! ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿßŸÜÿπŸÉÿ≥ÿ™ ŸÅŸàÿ±ÿßŸã ŸÅŸä GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                showMessage('musicControlStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´: ' + error.message);
            }
        }
        
        // Set volume preset
        function setVolumePreset(value) {
            document.getElementById('volumeSlider').value = value;
            updateVolumeDisplay(value);
            saveVolumeChange(value);
        }
        
        // Set music duration
        async function setMusicDuration(seconds) {
            if (!githubToken) {
                showMessage('musicControlStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            
            showMessage('musicControlStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿØÿ© ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ...');
            
            try {
                // Update maintenance-config.json
                const duration = seconds === -1 ? -1 : seconds * 1000;
                maintenanceConfigData.musicDuration = duration;
                maintenanceConfigData.lastUpdated = new Date().toISOString();
                maintenanceConfigData.updatedBy = 'ÿßŸÑŸÖÿ∑Ÿàÿ± - Smart Planner';
                
                let durationLabel = '';
                if (seconds === -1) {
                    durationLabel = 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØŸàÿØ';
                    maintenanceConfigData.musicDurationLabel = 'ŸÖÿ≥ÿ™ŸÖÿ± (ÿ∫Ÿäÿ± ŸÖÿ≠ÿØŸàÿØ)';
                } else {
                    const minutes = Math.floor(seconds / 60);
                    durationLabel = minutes === 1 ? 'ÿØŸÇŸäŸÇÿ© Ÿàÿßÿ≠ÿØÿ©' : `${minutes} ÿØŸÇŸäŸÇÿ©`;
                    maintenanceConfigData.musicDurationLabel = durationLabel;
                }
                
                await saveMaintenanceConfig(`ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿØÿ© ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ÿ•ŸÑŸâ ${durationLabel} ŸÖŸÜ Smart Planner`);
                
                showMessage('musicControlStatus', 'success', 
                    `‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿØÿ© ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ÿ•ŸÑŸâ ${durationLabel} ÿ®ŸÜÿ¨ÿßÿ≠! ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿßŸÜÿπŸÉÿ≥ÿ™ ŸÅŸàÿ±ÿßŸã ŸÅŸä GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                showMessage('musicControlStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´: ' + error.message);
            }
        }
        
        // Set tap to stop feature
        async function setTapToStop(enabled) {
            if (!githubToken) {
                showMessage('musicControlStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            
            showMessage('musicControlStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸäÿ≤ÿ© ÿßŸÑŸÜŸÇÿ± ŸÑŸÑÿ•ŸäŸÇÿßŸÅ...');
            
            try {
                // Update audio-config.json
                const audioConfigData = await loadAudioConfig();
                
                if (!audioConfigData.backgroundMusic) {
                    audioConfigData.backgroundMusic = {};
                }
                
                audioConfigData.backgroundMusic.tapToStop = enabled;
                audioConfigData.lastUpdated = new Date().toISOString();
                audioConfigData.updatedBy = 'ÿßŸÑŸÖÿ∑Ÿàÿ± - Smart Planner';
                
                await saveAudioConfig(audioConfigData, `ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸäÿ≤ÿ© ÿßŸÑŸÜŸÇÿ± ŸÑŸÑÿ•ŸäŸÇÿßŸÅ: ${enabled ? 'ŸÖŸÅÿπŸÑÿ©' : 'ŸÖÿπÿ∑ŸÑÿ©'}`);
                
                showMessage('musicControlStatus', 'success', 
                    `‚úÖ ÿ™ŸÖ ${enabled ? 'ÿ™ŸÅÿπŸäŸÑ' : 'ÿ™ÿπÿ∑ŸäŸÑ'} ŸÖŸäÿ≤ÿ© ÿßŸÑŸÜŸÇÿ± ŸÑŸÑÿ•ŸäŸÇÿßŸÅ ÿ®ŸÜÿ¨ÿßÿ≠! ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿßŸÜÿπŸÉÿ≥ÿ™ ŸÅŸàÿ±ÿßŸã ŸÅŸä GitHub`);
                
                // Update UI
                updateTapToStopUI(enabled);
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                showMessage('musicControlStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´: ' + error.message);
            }
        }
        
        // Load audio config from GitHub
        async function loadAudioConfig() {
            const response = await fetch(`https://api.github.com/repos/${repo}/contents/audio-config.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!response.ok) {
                throw new Error('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖŸÑŸÅ audio-config.json');
            }
            
            const file = await response.json();
            const content = atob(file.content);
            return JSON.parse(content);
        }
        
        // Save audio config to GitHub
        async function saveAudioConfig(audioConfigData, commitMessage) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/audio-config.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖŸÑŸÅ audio-config.json');
            }
            
            const file = await getRes.json();
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/audio-config.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(audioConfigData, null, 2)))),
                    sha: file.sha
                })
            });
            
            if (!updateRes.ok) {
                const errorData = await updateRes.json();
                throw new Error(errorData.message || 'ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅ audio-config.json');
            }
        }
        
        // Update tap to stop UI
        function updateTapToStopUI(enabled) {
            const statusElement = document.getElementById('tapToStopStatus');
            if (statusElement) {
                statusElement.textContent = enabled ? '‚úÖ ŸÖŸÅÿπŸÑÿ©' : '‚ùå ŸÖÿπÿ∑ŸÑÿ©';
                statusElement.style.color = enabled ? '#38ef7d' : '#ff6b6b';
            }
        }
        
        // Save maintenance config to GitHub
        async function saveMaintenanceConfig(commitMessage) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-config.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖŸÑŸÅ maintenance-config.json');
            }
            
            const file = await getRes.json();
            const sha = file.sha;
            
            // Prepare content
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(maintenanceConfigData, null, 2))));
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-config.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateRes.ok) {
                throw new Error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅ maintenance-config.json');
            }
        }
        
        // Save maintenance status to GitHub
        async function saveMaintenanceStatus(commitMessage) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖŸÑŸÅ maintenance-status.json');
            }
            
            const file = await getRes.json();
            const sha = file.sha;
            
            // Prepare content
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(maintenanceStatusData, null, 2))));
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateRes.ok) {
                throw new Error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅ maintenance-status.json');
            }
        }
        
        // Force cache clear - AGGRESSIVE IMPLEMENTATION for all browsers
        async function forceCacheClear() {
            // Disable button and show immediate feedback
            const btn = document.getElementById('clearCacheBtn');
            const icon = document.getElementById('clearCacheIcon');
            const text = document.getElementById('clearCacheText');
            
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            }
            if (icon) icon.textContent = '‚è≥';
            if (text) text.textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑŸÅŸàÿ±Ÿä...';
            
            showMessage('cacheControlStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ŸÖÿ≥ÿ≠ ÿßŸÑŸÉÿßÿ¥ ŸàÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ÿ®ÿ¥ŸÉŸÑ ŸÅŸàÿ±Ÿä ŸàŸÇŸàŸä...');
            
            try {
                let clearedItems = [];
                
                // 1. Clear local storage (preserve devToken)
                const keysToKeep = ['devToken'];
                const allKeys = Object.keys(localStorage);
                let localStorageCount = 0;
                allKeys.forEach(key => {
                    if (!keysToKeep.includes(key)) {
                        localStorage.removeItem(key);
                        localStorageCount++;
                    }
                });
                clearedItems.push(`üíæ LocalStorage: ÿ™ŸÖ ŸÖÿ≥ÿ≠ ${localStorageCount} ÿπŸÜÿµÿ±`);
                
                // 2. Clear session storage
                const sessionStorageCount = sessionStorage.length;
                sessionStorage.clear();
                clearedItems.push(`üì¶ SessionStorage: ÿ™ŸÖ ŸÖÿ≥ÿ≠ ${sessionStorageCount} ÿπŸÜÿµÿ±`);
                
                // 3. Unregister all service workers
                let swCount = 0;
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        swCount++;
                        console.log('‚úÖ Service Worker unregistered:', registration);
                    }
                }
                clearedItems.push(`üîÑ Service Workers: ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ${swCount} ÿÆÿØŸÖÿ©`);
                
                // 4. Clear all caches
                let cacheCount = 0;
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        cacheCount++;
                        console.log('‚úÖ Cache deleted:', cacheName);
                    }
                }
                clearedItems.push(`üóëÔ∏è Caches: ÿ™ŸÖ ŸÖÿ≥ÿ≠ ${cacheCount} ŸÉÿßÿ¥`);
                
                // 5. Clear cookies (if possible)
                try {
                    document.cookie.split(";").forEach(function(c) { 
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                    });
                    clearedItems.push(`üç™ Cookies: ÿ™ŸÖ ÿßŸÑŸÖÿ≥ÿ≠`);
                } catch (e) {
                    console.warn('Could not clear cookies:', e);
                }
                
                // 6. Clear IndexedDB (if exists)
                if ('indexedDB' in window) {
                    try {
                        const databases = await indexedDB.databases();
                        for (const db of databases) {
                            indexedDB.deleteDatabase(db.name);
                        }
                        clearedItems.push(`üìä IndexedDB: ÿ™ŸÖ ÿßŸÑŸÖÿ≥ÿ≠`);
                    } catch (e) {
                        console.warn('Could not clear IndexedDB:', e);
                    }
                }
                
                // Re-enable button with success state
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                if (icon) icon.textContent = '‚úÖ';
                if (text) text.textContent = 'ÿ™ŸÖ ÿßŸÑŸÖÿ≥ÿ≠ ÿ®ŸÜÿ¨ÿßÿ≠!';
                
                // Show success message
                showMessage('cacheControlStatus', 'success', 
                    '‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÉÿßÿ¥ ŸàÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!\n\n' +
                    clearedItems.join('\n') + '\n\n' +
                    '‚ú® ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿ≥ÿ™ŸÜÿπŸÉÿ≥ ŸÅŸàÿ±ÿßŸã ŸÅŸä ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ÿßÿ™ (Safari, Chrome, Firefox)\n' +
                    'üîÑ ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ÿ®ÿ¥ŸÉŸÑ ŸÇŸàŸä ÿÆŸÑÿßŸÑ 3 ÿ´ŸàÿßŸÜŸç...');
                
                // Reset button text after a moment
                setTimeout(() => {
                    if (icon) icon.textContent = 'üöÄ';
                    if (text) text.textContent = 'ŸÖÿ≥ÿ≠ ŸÇŸàŸä ŸàŸÅŸàÿ±Ÿä ŸÑŸÑŸÉÿßÿ¥ (Safari + Chrome + Firefox)';
                }, 2000);
                
                // 7. Force hard reload after 3 seconds
                setTimeout(() => {
                    console.log('üîÑ Performing hard reload...');
                    // Try multiple reload methods for maximum compatibility
                    if (window.location.reload) {
                        // Hard reload with cache bypass
                        window.location.reload(true);
                    }
                    // Fallback: Force reload by changing URL
                    setTimeout(() => {
                        window.location.href = window.location.href.split('?')[0] + '?t=' + new Date().getTime();
                    }, 500);
                }, 3000);
                
            } catch (error) {
                // Re-enable button on error
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                if (icon) icon.textContent = '‚ùå';
                if (text) text.textContent = 'ŸÅÿ¥ŸÑ ÿßŸÑŸÖÿ≥ÿ≠ - ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ';
                
                showMessage('cacheControlStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ŸÖÿ≥ÿ≠ ÿßŸÑŸÉÿßÿ¥: ' + error.message);
                console.error('Cache clear error:', error);
                
                // Reset button text after a moment
                setTimeout(() => {
                    if (icon) icon.textContent = 'üöÄ';
                    if (text) text.textContent = 'ŸÖÿ≥ÿ≠ ŸÇŸàŸä ŸàŸÅŸàÿ±Ÿä ŸÑŸÑŸÉÿßÿ¥ (Safari + Chrome + Firefox)';
                }, 3000);
            }
        }
        
        // Update service worker
        async function updateServiceWorker() {
            // Disable button and show immediate feedback
            const btn = document.getElementById('updateSWBtn');
            const icon = document.getElementById('updateSWIcon');
            const text = document.getElementById('updateSWText');
            
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            }
            if (icon) icon.textContent = '‚è≥';
            if (text) text.textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´...';
            
            showMessage('cacheControlStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ Service Worker...');
            
            try {
                if ('serviceWorker' in navigator) {
                    // Get all registrations
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    
                    if (registrations.length === 0) {
                        // Re-enable button
                        if (btn) {
                            btn.disabled = false;
                            btn.style.opacity = '1';
                        }
                        if (icon) icon.textContent = '‚ö†Ô∏è';
                        if (text) text.textContent = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ Service Workers';
                        
                        showMessage('cacheControlStatus', 'warning', '‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ Service Workers ŸÖÿ≥ÿ¨ŸÑÿ©');
                        
                        // Reset button text
                        setTimeout(() => {
                            if (icon) icon.textContent = 'üîÑ';
                            if (text) text.textContent = 'ÿ™ÿ≠ÿØŸäÿ´ Service Worker ŸÅŸàÿ±ÿßŸã';
                        }, 2000);
                        return;
                    }
                    
                    // Update all service workers
                    for (let registration of registrations) {
                        await registration.update();
                        console.log('‚úÖ Service Worker updated:', registration);
                    }
                    
                    // Re-enable button with success state
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    }
                    if (icon) icon.textContent = '‚úÖ';
                    if (text) text.textContent = 'ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸÜÿ¨ÿßÿ≠!';
                    
                    showMessage('cacheControlStatus', 'success', 
                        `‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${registrations.length} Service Worker ÿ®ŸÜÿ¨ÿßÿ≠!\n` +
                        'üîÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿ≥ÿ™ŸÜÿπŸÉÿ≥ ŸÅŸàÿ±ÿßŸã ŸÅŸä ÿ¨ŸÖŸäÿπ ÿπŸÑÿßŸÖÿßÿ™ ÿßŸÑÿ™ÿ®ŸàŸäÿ®');
                    
                    // Reset button text after a moment
                    setTimeout(() => {
                        if (icon) icon.textContent = 'üîÑ';
                        if (text) text.textContent = 'ÿ™ÿ≠ÿØŸäÿ´ Service Worker ŸÅŸàÿ±ÿßŸã';
                    }, 2000);
                    
                } else {
                    // Re-enable button
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    }
                    if (icon) icon.textContent = '‚ùå';
                    if (text) text.textContent = 'ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ SW';
                    
                    showMessage('cacheControlStatus', 'error', '‚ùå ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ Service Workers');
                    
                    // Reset button text
                    setTimeout(() => {
                        if (icon) icon.textContent = 'üîÑ';
                        if (text) text.textContent = 'ÿ™ÿ≠ÿØŸäÿ´ Service Worker ŸÅŸàÿ±ÿßŸã';
                    }, 2000);
                }
                
            } catch (error) {
                // Re-enable button on error
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                if (icon) icon.textContent = '‚ùå';
                if (text) text.textContent = 'ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´';
                
                showMessage('cacheControlStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ≠ÿØŸäÿ´ Service Worker: ' + error.message);
                
                // Reset button text after a moment
                setTimeout(() => {
                    if (icon) icon.textContent = 'üîÑ';
                    if (text) text.textContent = 'ÿ™ÿ≠ÿØŸäÿ´ Service Worker ŸÅŸàÿ±ÿßŸã';
                }, 3000);
            }
        }
        
        // Update switchTab function to load maintenance config when switching to maintenance tab
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab.call(this, tabName);
            
            if (tabName === 'maintenance') {
                loadMaintenanceConfig();
            }
        };
        
        // ============================================
        // NEW SMART PLANNER ENHANCED FUNCTIONS
        // ============================================
        
        // Quick Add Inspection
        function openQuickAddInspection() {
            // Switch to add tab and focus on first field
            document.querySelectorAll('.tab-button')[0].click();
            setTimeout(() => {
                document.getElementById('inspectorSelect').focus();
            }, 300);
            alert('‚ú® ÿßÿÆÿ™ÿµÿßÿ±: ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥ ŸàÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ®ÿ≥ÿ±ÿπÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ™ŸÅÿ™Ÿäÿ¥ ÿ¨ÿØŸäÿØ');
        }
        
        // Import from Excel - REAL IMPLEMENTATION
        function importFromExcel() {
            if (!window.XLSX) {
                alert('‚ö†Ô∏è ŸÖŸÉÿ™ÿ®ÿ© Excel ÿ∫Ÿäÿ± ŸÖÿ≠ŸÖŸÑÿ©. Ÿäÿ±ÿ¨Ÿâ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©.');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    
                    // Create import preview modal
                    const modal = document.createElement('div');
                    modal.id = 'importExcelModal';
                    modal.style.cssText = `
                        display: block;
                        position: fixed;
                        z-index: 10000;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.8);
                        overflow: auto;
                    `;
                    
                    let sheetsHTML = '<div style="margin-bottom: 20px;">';
                    sheetsHTML += '<h3 style="color: #2d3561; margin-bottom: 15px;">üìã ÿ£Ÿàÿ±ÿßŸÇ ÿßŸÑÿπŸÖŸÑ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©:</h3>';
                    sheetsHTML += '<div style="display: flex; flex-direction: column; gap: 10px;">';
                    
                    workbook.SheetNames.forEach((sheetName, idx) => {
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        sheetsHTML += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border: 2px solid #e0e0e0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="color: #667eea; font-size: 1.1em;">${sheetName}</strong>
                                        <span style="color: #666; margin-right: 10px;">(${jsonData.length} ÿµŸÅ)</span>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button onclick="importExcelSheet('${sheetName}', 'inspections')" class="btn btn-primary btn-sm">
                                            ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÉÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™
                                        </button>
                                        <button onclick="importExcelSheet('${sheetName}', 'shops')" class="btn btn-success btn-sm">
                                            ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÉŸÖÿ≠ŸÑÿßÿ™
                                        </button>
                                    </div>
                                </div>
                                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                    ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ£ÿπŸÖÿØÿ©: ${Object.keys(jsonData[0] || {}).slice(0, 5).join(', ')}${Object.keys(jsonData[0] || {}).length > 5 ? '...' : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    sheetsHTML += '</div></div>';
                    
                    modal.innerHTML = `
                        <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 900px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="color: #2d3561;">üì• ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÜ Excel</h2>
                                <button onclick="document.getElementById('importExcelModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">√ó</button>
                            </div>
                            ${sheetsHTML}
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-top: 20px; border: 2px solid #90caf9;">
                                <strong style="color: #1976d2;">üí° ŸÜÿµÿßÿ¶ÿ≠:</strong>
                                <ul style="margin: 10px 0 0 20px; color: #666;">
                                    <li>ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ∑ÿßÿ®ŸÇ ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑÿ£ÿπŸÖÿØÿ© ŸÖÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©</li>
                                    <li>ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÉÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™: Ÿäÿ™ÿ∑ŸÑÿ® ÿ£ÿπŸÖÿØÿ© (ÿßŸÑŸÖŸÅÿ™ÿ¥ÿå ÿßŸÑÿ™ÿßÿ±ŸäÿÆÿå ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©ÿå ÿßŸÑŸÖÿ≠ŸÑÿßÿ™)</li>
                                    <li>ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÉŸÖÿ≠ŸÑÿßÿ™: Ÿäÿ™ÿ∑ŸÑÿ® ÿ£ÿπŸÖÿØÿ© (ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑÿå ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©)</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Store workbook for later use
                    window.excelWorkbook = workbook;
                    
                } catch (error) {
                    alert('‚ùå ŸÅÿ¥ŸÑ ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ Excel: ' + error.message);
                }
            };
            input.click();
        }
        
        // Import Excel Sheet
        window.importExcelSheet = async function(sheetName, type) {
            if (!window.excelWorkbook) {
                alert('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ Excel');
                return;
            }
            
            const sheet = window.excelWorkbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet);
            
            if (type === 'inspections') {
                let importedCount = 0;
                let errors = [];
                
                jsonData.forEach((row, idx) => {
                    try {
                        // Try to extract inspection data with flexible column names
                        const inspector = row['ÿßŸÑŸÖŸÅÿ™ÿ¥'] || row['Inspector'] || row['inspector'] || '';
                        const day = row['ÿßŸÑÿ™ÿßÿ±ŸäÿÆ'] || row['Date'] || row['date'] || row['day'] || '';
                        const area = row['ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©'] || row['Area'] || row['area'] || '';
                        const shopsStr = row['ÿßŸÑŸÖÿ≠ŸÑÿßÿ™'] || row['Shops'] || row['shops'] || '';
                        
                        if (!inspector || !day || !area) {
                            errors.push(`ÿßŸÑÿµŸÅ ${idx + 1}: ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿßŸÇÿµÿ©`);
                            return;
                        }
                        
                        const shops = shopsStr.split(',').map(s => s.trim()).filter(s => s);
                        
                        const newInspection = {
                            id: 'insp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            inspector: inspector,
                            day: day,
                            area: area,
                            shops: shops,
                            shift: row['ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©'] || row['Shift'] || 'ÿµÿ®ÿßÿ≠Ÿäÿ©'
                        };
                        
                        planData.inspectionData.push(newInspection);
                        importedCount++;
                    } catch (error) {
                        errors.push(`ÿßŸÑÿµŸÅ ${idx + 1}: ${error.message}`);
                    }
                });
                
                if (errors.length > 0 && errors.length < 10) {
                    alert(`‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±ÿßÿ™:\n\n` + errors.join('\n'));
                }
                
                alert(`‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${importedCount} ÿ™ŸÅÿ™Ÿäÿ¥ ŸÖŸÜ ${jsonData.length} ÿµŸÅ!\n\n‚ö†Ô∏è ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™`);
                
            } else if (type === 'shops') {
                let importedCount = 0;
                let errors = [];
                
                jsonData.forEach((row, idx) => {
                    try {
                        const shopName = row['ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ'] || row['Shop Name'] || row['name'] || row['Name'] || '';
                        const areaName = row['ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©'] || row['Area'] || row['area'] || '';
                        
                        if (!shopName) {
                            errors.push(`ÿßŸÑÿµŸÅ ${idx + 1}: ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ ŸÖŸÅŸÇŸàÿØ`);
                            return;
                        }
                        
                        // Find or create area
                        let areaId = '';
                        if (areaName && planData.areas) {
                            const area = planData.areas.find(a => a.name === areaName);
                            if (area) {
                                areaId = area.id;
                            } else {
                                // Create new area
                                areaId = 'area_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                planData.areas.push({
                                    id: areaId,
                                    name: areaName
                                });
                            }
                        }
                        
                        // Check if shop already exists
                        const exists = planData.shops.some(s => s.name.toLowerCase().trim() === shopName.toLowerCase().trim());
                        if (exists) {
                            return;
                        }
                        
                        const newShop = {
                            id: 'shop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            name: shopName,
                            areaId: areaId
                        };
                        
                        planData.shops.push(newShop);
                        importedCount++;
                    } catch (error) {
                        errors.push(`ÿßŸÑÿµŸÅ ${idx + 1}: ${error.message}`);
                    }
                });
                
                if (errors.length > 0 && errors.length < 10) {
                    alert(`‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±ÿßÿ™:\n\n` + errors.join('\n'));
                }
                
                alert(`‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${importedCount} ŸÖÿ≠ŸÑ ŸÖŸÜ ${jsonData.length} ÿµŸÅ!\n\n‚ö†Ô∏è ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™`);
            }
            
            document.getElementById('importExcelModal').remove();
        };
        
        // Export All Data - ENHANCED WITH MULTIPLE FORMATS
        function exportAllData() {
            if (!planData) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±');
                return;
            }
            
            // Create export format selection modal
            const modal = document.createElement('div');
            modal.id = 'exportModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 5% auto; padding: 30px; border-radius: 20px; max-width: 700px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561;">üì§ ÿ™ÿµÿØŸäÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h2>
                        <button onclick="document.getElementById('exportModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">√ó</button>
                    </div>
                    
                    <!-- Data Summary -->
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">üìä ŸÖŸÑÿÆÿµ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <div style="font-size: 2em; font-weight: 700; color: #667eea;">${planData.inspectionData?.length || 0}</div>
                                <div style="color: #666;">ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</div>
                            </div>
                            <div>
                                <div style="font-size: 2em; font-weight: 700; color: #11998e;">${planData.inspectors?.length || 0}</div>
                                <div style="color: #666;">ÿßŸÑŸÖŸÅÿ™ÿ¥ŸàŸÜ</div>
                            </div>
                            <div>
                                <div style="font-size: 2em; font-weight: 700; color: #fa709a;">${planData.areas?.length || 0}</div>
                                <div style="color: #666;">ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</div>
                            </div>
                            <div>
                                <div style="font-size: 2em; font-weight: 700; color: #ffc107;">${planData.shops?.length || 0}</div>
                                <div style="color: #666;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export Format Selection -->
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">üìã ÿßÿÆÿ™ÿ± ÿµŸäÿ∫ÿ© ÿßŸÑÿ™ÿµÿØŸäÿ±:</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <button onclick="exportDataFormat('json')" class="btn btn-primary" style="padding: 20px; flex-direction: column; gap: 10px;">
                                <span style="font-size: 2em;">üìÑ</span>
                                <span>JSON</span>
                                <small style="font-size: 0.85em; opacity: 0.8;">ŸÑŸÑŸÖÿ∑Ÿàÿ±ŸäŸÜ ŸàÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇÿßÿ™</small>
                            </button>
                            <button onclick="exportDataFormat('excel')" class="btn btn-success" style="padding: 20px; flex-direction: column; gap: 10px;">
                                <span style="font-size: 2em;">üìä</span>
                                <span>Excel</span>
                                <small style="font-size: 0.85em; opacity: 0.8;">ŸÑŸÑÿ™ÿ≠ŸÑŸäŸÑ ŸàÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©</small>
                            </button>
                            <button onclick="exportDataFormat('csv')" class="btn btn-info" style="padding: 20px; flex-direction: column; gap: 10px;">
                                <span style="font-size: 2em;">üìã</span>
                                <span>CSV</span>
                                <small style="font-size: 0.85em; opacity: 0.8;">ŸÑŸÑŸÇŸàÿßÿπÿØ ŸàÿßŸÑÿ£ŸÜÿ∏ŸÖÿ©</small>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Export Options -->
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; border: 2px solid #ffc107;">
                        <strong style="color: #856404;">‚öôÔ∏è ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿµÿØŸäÿ±:</strong>
                        <div style="margin-top: 10px;">
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="checkbox" id="exportInspections" checked>
                                <span style="margin-right: 5px;">ÿ™ÿ∂ŸÖŸäŸÜ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</span>
                            </label>
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="checkbox" id="exportInspectors" checked>
                                <span style="margin-right: 5px;">ÿ™ÿ∂ŸÖŸäŸÜ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</span>
                            </label>
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="checkbox" id="exportAreas" checked>
                                <span style="margin-right: 5px;">ÿ™ÿ∂ŸÖŸäŸÜ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</span>
                            </label>
                            <label style="display: block;">
                                <input type="checkbox" id="exportShops" checked>
                                <span style="margin-right: 5px;">ÿ™ÿ∂ŸÖŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Export Data in Selected Format
        window.exportDataFormat = function(format) {
            const includeInspections = document.getElementById('exportInspections').checked;
            const includeInspectors = document.getElementById('exportInspectors').checked;
            const includeAreas = document.getElementById('exportAreas').checked;
            const includeShops = document.getElementById('exportShops').checked;
            
            const exportData = {
                exportDate: new Date().toISOString(),
                exportedBy: 'Smart Planner - ÿ£ÿØÿßÿ© ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑ ÿßŸÑÿ∞ŸÉŸäÿ©',
                format: format
            };
            
            if (includeInspections) exportData.inspections = planData.inspectionData || [];
            if (includeInspectors) exportData.inspectors = planData.inspectors || [];
            if (includeAreas) exportData.areas = planData.areas || [];
            if (includeShops) exportData.shops = planData.shops || [];
            
            if (format === 'json') {
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `smart-planner-export-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                alert('‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿµŸäÿ∫ÿ© JSON ÿ®ŸÜÿ¨ÿßÿ≠!');
                
            } else if (format === 'excel') {
                if (!window.XLSX) {
                    alert('‚ö†Ô∏è ŸÖŸÉÿ™ÿ®ÿ© Excel ÿ∫Ÿäÿ± ŸÖÿ≠ŸÖŸÑÿ©. ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿµÿØŸäÿ± ÿ®ÿµŸäÿ∫ÿ© JSON ÿ®ÿØŸäŸÑÿ©...');
                    exportDataFormat('json');
                    return;
                }
                
                const wb = XLSX.utils.book_new();
                
                // Add inspections sheet
                if (includeInspections && exportData.inspections) {
                    const inspectionsSheet = exportData.inspections.map(i => ({
                        'ÿßŸÑŸÖŸÅÿ™ÿ¥': i.inspector,
                        'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ': i.day,
                        'ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©': i.area,
                        'ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©': i.shift || '',
                        'ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™': i.shops ? i.shops.length : 0,
                        'ÿßŸÑŸÖÿ≠ŸÑÿßÿ™': i.shops ? i.shops.join(', ') : ''
                    }));
                    const ws = XLSX.utils.json_to_sheet(inspectionsSheet);
                    XLSX.utils.book_append_sheet(wb, ws, 'ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™');
                }
                
                // Add inspectors sheet
                if (includeInspectors && exportData.inspectors) {
                    const inspectorsSheet = exportData.inspectors.map(i => ({
                        'ÿßŸÑÿßÿ≥ŸÖ': i.name,
                        'ÿßŸÑÿ£ŸäÿßŸÖ': i.days ? i.days.join(', ') : ''
                    }));
                    const ws = XLSX.utils.json_to_sheet(inspectorsSheet);
                    XLSX.utils.book_append_sheet(wb, ws, 'ÿßŸÑŸÖŸÅÿ™ÿ¥ŸàŸÜ');
                }
                
                // Add areas sheet
                if (includeAreas && exportData.areas) {
                    const areasSheet = exportData.areas.map(a => ({
                        'ÿßŸÑŸÖÿπÿ±ŸÅ': a.id,
                        'ÿßŸÑÿßÿ≥ŸÖ': a.name
                    }));
                    const ws = XLSX.utils.json_to_sheet(areasSheet);
                    XLSX.utils.book_append_sheet(wb, ws, 'ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ');
                }
                
                // Add shops sheet
                if (includeShops && exportData.shops) {
                    const shopsSheet = exportData.shops.map(s => {
                        const area = planData.areas?.find(a => a.id === s.areaId);
                        return {
                            'ÿßŸÑŸÖÿπÿ±ŸÅ': s.id,
                            'ÿßŸÑÿßÿ≥ŸÖ': s.name,
                            'ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©': area ? area.name : ''
                        };
                    });
                    const ws = XLSX.utils.json_to_sheet(shopsSheet);
                    XLSX.utils.book_append_sheet(wb, ws, 'ÿßŸÑŸÖÿ≠ŸÑÿßÿ™');
                }
                
                XLSX.writeFile(wb, `smart-planner-export-${new Date().toISOString().split('T')[0]}.xlsx`);
                alert('‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿµŸäÿ∫ÿ© Excel ÿ®ŸÜÿ¨ÿßÿ≠!');
                
            } else if (format === 'csv') {
                // Export inspections as CSV
                if (includeInspections && exportData.inspections) {
                    let csv = 'ÿßŸÑŸÖŸÅÿ™ÿ¥,ÿßŸÑÿ™ÿßÿ±ŸäÿÆ,ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©,ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©,ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™,ÿßŸÑŸÖÿ≠ŸÑÿßÿ™\n';
                    exportData.inspections.forEach(i => {
                        csv += `"${i.inspector}","${i.day}","${i.area}","${i.shift || ''}","${i.shops ? i.shops.length : 0}","${i.shops ? i.shops.join('; ') : ''}"\n`;
                    });
                    
                    const dataBlob = new Blob(['\uFEFF' + csv], {type: 'text/csv;charset=utf-8;'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `smart-planner-inspections-${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    alert('‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿµŸäÿ∫ÿ© CSV ÿ®ŸÜÿ¨ÿßÿ≠!');
                } else {
                    alert('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±');
                }
            }
            
            document.getElementById('exportModal').remove();
        };
        
        // Sync with GitHub
        async function syncWithGitHub() {
            if (!githubToken) {
                alert('‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã ŸÑŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub');
                return;
            }
            
            if (confirm('üîÑ ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿπ GitHubÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ£ÿ≠ÿØÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ.')) {
                try {
                    await loadPlanData();
                    alert('‚úÖ ÿ™ŸÖÿ™ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿ®ŸÜÿ¨ÿßÿ≠! ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ£ÿ≠ÿØÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.');
                    
                    // Refresh current tab
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab && activeTab.id === 'shopsTab') {
                        displayShopsList();
                    } else if (activeTab && activeTab.id === 'areasTab') {
                        displayAreasList();
                    }
                } catch (error) {
                    alert('‚ùå ŸÅÿ¥ŸÑÿ™ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©: ' + error.message);
                }
            }
        }
        
        // Create Backup
        function createBackup() {
            if (!planData) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä');
                return;
            }
            
            const backupData = {
                ...planData,
                backupDate: new Date().toISOString(),
                backupVersion: '1.0'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup-plan-data-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüíæ ÿßÿ≠ÿ™ŸÅÿ∏ ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÖŸÑŸÅ ŸÅŸä ŸÖŸÉÿßŸÜ ÿ¢ŸÖŸÜ.');
        }
        
        // Generate Full Report - ENHANCED WITH VISUAL REPORT
        function generateFullReport() {
            if (!planData || !planData.inspectionData) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±');
                return;
            }
            
            const totalInspections = planData.inspectionData.length;
            const totalShops = planData.inspectionData.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0);
            const inspectorCounts = {};
            const areaCounts = {};
            const monthCounts = {};
            const shiftCounts = { 'ÿµÿ®ÿßÿ≠Ÿäÿ©': 0, 'ŸÖÿ≥ÿßÿ¶Ÿäÿ©': 0 };
            
            planData.inspectionData.forEach(insp => {
                inspectorCounts[insp.inspector] = (inspectorCounts[insp.inspector] || 0) + 1;
                areaCounts[insp.area] = (areaCounts[insp.area] || 0) + 1;
                
                const month = insp.day ? insp.day.substring(0, 7) : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                monthCounts[month] = (monthCounts[month] || 0) + 1;
                
                if (insp.shift) {
                    shiftCounts[insp.shift] = (shiftCounts[insp.shift] || 0) + 1;
                }
            });
            
            // Create visual report modal
            const modal = document.createElement('div');
            modal.id = 'reportModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            // Calculate top performers
            const topInspectors = Object.entries(inspectorCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const topAreas = Object.entries(areaCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 20px; max-width: 1200px; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #667eea;">
                        <h2 style="color: #2d3561; margin: 0;">üìä ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¥ÿßŸÖŸÑ ŸàÿßŸÑÿ™ŸÅÿµŸäŸÑŸä</h2>
                        <button onclick="document.getElementById('reportModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">√ó</button>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 3em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">${totalInspections}</div>
                            <div style="font-size: 1.1em; margin-top: 5px;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 3em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">${totalShops}</div>
                            <div style="font-size: 1.1em; margin-top: 5px;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ÿ©</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 3em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">${Object.keys(inspectorCounts).length}</div>
                            <div style="font-size: 1.1em; margin-top: 5px;">ÿßŸÑŸÖŸÅÿ™ÿ¥ŸàŸÜ ÿßŸÑŸÜÿ¥ÿ∑ŸàŸÜ</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 3em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">${Object.keys(areaCounts).length}</div>
                            <div style="font-size: 1.1em; margin-top: 5px;">ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿ∫ÿ∑ÿßÿ©</div>
                        </div>
                    </div>
                    
                    <!-- Top Performers -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 15px;">
                            <h3 style="color: #2d3561; margin-bottom: 15px;">üèÜ ÿ£ŸÅÿ∂ŸÑ 5 ŸÖŸÅÿ™ÿ¥ŸäŸÜ</h3>
                            ${topInspectors.map(([ inspector, count], idx) => {
                                const percentage = ((count / totalInspections) * 100).toFixed(1);
                                return `
                                    <div style="margin-bottom: 15px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span style="font-weight: 600;">${idx + 1}. ${inspector}</span>
                                            <span style="color: #667eea; font-weight: 600;">${count} (${percentage}%)</span>
                                        </div>
                                        <div style="background: #e0e0e0; border-radius: 10px; height: 10px; overflow: hidden;">
                                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${percentage}%; transition: width 1s ease;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 15px;">
                            <h3 style="color: #2d3561; margin-bottom: 15px;">üìç ÿ£ŸÉÿ´ÿ± 5 ŸÖŸÜÿßÿ∑ŸÇ ÿ™ŸÅÿ™Ÿäÿ¥ÿßŸã</h3>
                            ${topAreas.map(([area, count], idx) => {
                                const percentage = ((count / totalInspections) * 100).toFixed(1);
                                return `
                                    <div style="margin-bottom: 15px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span style="font-weight: 600;">${idx + 1}. ${area}</span>
                                            <span style="color: #11998e; font-weight: 600;">${count} (${percentage}%)</span>
                                        </div>
                                        <div style="background: #e0e0e0; border-radius: 10px; height: 10px; overflow: hidden;">
                                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); height: 100%; width: ${percentage}%; transition: width 1s ease;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Shift Distribution -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">üïê ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #ffc107;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #ffc107;">${shiftCounts['ÿµÿ®ÿßÿ≠Ÿäÿ©'] || 0}</div>
                                <div style="color: #666;">ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿßŸÑÿµÿ®ÿßÿ≠Ÿäÿ©</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #3498db;">${shiftCounts['ŸÖÿ≥ÿßÿ¶Ÿäÿ©'] || 0}</div>
                                <div style="color: #666;">ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿßŸÑŸÖÿ≥ÿßÿ¶Ÿäÿ©</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Distribution -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">üìÖ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¥Ÿáÿ±Ÿä ŸÑŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            ${Object.entries(monthCounts).sort((a, b) => a[0].localeCompare(b[0])).map(([month, count]) => `
                                <div style="background: white; padding: 12px; border-radius: 8px; text-align: center; border: 2px solid #667eea;">
                                    <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">${month}</div>
                                    <div style="font-size: 1.8em; font-weight: 700; color: #2d3561;">${count}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                        <button onclick="downloadTextReport()" class="btn btn-primary">
                            <span>üìÑ</span>
                            <span>ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÜÿµŸä</span>
                        </button>
                        <button onclick="printReport()" class="btn btn-success">
                            <span>üñ®Ô∏è</span>
                            <span>ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</span>
                        </button>
                        <button onclick="shareReport()" class="btn btn-info">
                            <span>üì§</span>
                            <span>ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store report data globally for download functions
            window.currentReportData = {
                totalInspections,
                totalShops,
                inspectorCounts,
                areaCounts,
                monthCounts,
                shiftCounts
            };
        }
        
        // Download Text Report
        window.downloadTextReport = function() {
            const data = window.currentReportData;
            
            let report = 'üìä ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¥ÿßŸÖŸÑ ŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ∞ŸÉŸä\n';
            report += '‚ïê'.repeat(60) + '\n\n';
            report += `üìÖ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${new Date().toLocaleString('ar-EG')}\n`;
            report += `üîó ÿßŸÑŸÜÿ∏ÿßŸÖ: Smart Planner - ÿ£ÿØÿßÿ© ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑ ÿßŸÑÿ∞ŸÉŸäÿ©\n\n`;
            
            report += 'üìà ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©:\n';
            report += '‚îÄ'.repeat(60) + '\n';
            report += `   ‚Ä¢ ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™: ${data.totalInspections}\n`;
            report += `   ‚Ä¢ ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ÿ©: ${data.totalShops}\n`;
            report += `   ‚Ä¢ ÿπÿØÿØ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ÿßŸÑŸÜÿ¥ÿ∑ŸäŸÜ: ${Object.keys(data.inspectorCounts).length}\n`;
            report += `   ‚Ä¢ ÿπÿØÿØ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿ∫ÿ∑ÿßÿ©: ${Object.keys(data.areaCounts).length}\n`;
            report += `   ‚Ä¢ ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÉŸÑ ÿ™ŸÅÿ™Ÿäÿ¥: ${(data.totalShops / data.totalInspections).toFixed(2)}\n\n`;
            
            report += 'üë• ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ (ŸÖÿ±ÿ™ÿ®ÿ© ÿ™ŸÜÿßÿ≤ŸÑŸäÿßŸã):\n';
            report += '‚îÄ'.repeat(60) + '\n';
            Object.entries(data.inspectorCounts).sort((a, b) => b[1] - a[1]).forEach(([inspector, count], idx) => {
                const percentage = ((count / data.totalInspections) * 100).toFixed(1);
                report += `   ${idx + 1}. ${inspector}: ${count} ÿ™ŸÅÿ™Ÿäÿ¥ (${percentage}%)\n`;
            });
            
            report += '\nüó∫Ô∏è ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ (ŸÖÿ±ÿ™ÿ®ÿ© ÿ™ŸÜÿßÿ≤ŸÑŸäÿßŸã):\n';
            report += '‚îÄ'.repeat(60) + '\n';
            Object.entries(data.areaCounts).sort((a, b) => b[1] - a[1]).forEach(([area, count], idx) => {
                const percentage = ((count / data.totalInspections) * 100).toFixed(1);
                report += `   ${idx + 1}. ${area}: ${count} ÿ™ŸÅÿ™Ÿäÿ¥ (${percentage}%)\n`;
            });
            
            report += '\nüïê ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™:\n';
            report += '‚îÄ'.repeat(60) + '\n';
            report += `   ‚Ä¢ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿßŸÑÿµÿ®ÿßÿ≠Ÿäÿ©: ${data.shiftCounts['ÿµÿ®ÿßÿ≠Ÿäÿ©'] || 0}\n`;
            report += `   ‚Ä¢ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿßŸÑŸÖÿ≥ÿßÿ¶Ÿäÿ©: ${data.shiftCounts['ŸÖÿ≥ÿßÿ¶Ÿäÿ©'] || 0}\n`;
            
            report += '\nüìÖ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¥Ÿáÿ±Ÿä:\n';
            report += '‚îÄ'.repeat(60) + '\n';
            Object.entries(data.monthCounts).sort((a, b) => a[0].localeCompare(b[0])).forEach(([month, count]) => {
                report += `   ‚Ä¢ ${month}: ${count} ÿ™ŸÅÿ™Ÿäÿ¥\n`;
            });
            
            report += '\n' + '‚ïê'.repeat(60) + '\n';
            report += 'ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° Ÿáÿ∞ÿß ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®Ÿàÿßÿ≥ÿ∑ÿ© Smart Planner\n';
            report += '¬© 2025 ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ©\n';
            
            const dataBlob = new Blob(['\uFEFF' + report], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ÿ™ŸÇÿ±Ÿäÿ±-ÿ¥ÿßŸÖŸÑ-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÜÿµŸä ÿ®ŸÜÿ¨ÿßÿ≠!');
        };
        
        // Print Report
        window.printReport = function() {
            window.print();
        };
        
        // Share Report
        window.shareReport = function() {
            const data = window.currentReportData;
            const summary = `üìä ÿ™ŸÇÿ±Ÿäÿ± ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥\n\n` +
                          `‚úÖ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™: ${data.totalInspections}\n` +
                          `üè™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™: ${data.totalShops}\n` +
                          `üë• ÿßŸÑŸÖŸÅÿ™ÿ¥ŸàŸÜ: ${Object.keys(data.inspectorCounts).length}\n` +
                          `üó∫Ô∏è ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ: ${Object.keys(data.areaCounts).length}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'ÿ™ŸÇÿ±Ÿäÿ± ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ∞ŸÉŸä',
                    text: summary
                }).catch(err => console.log('Error sharing:', err));
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(summary).then(() => {
                    alert('‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ŸÖŸÑÿÆÿµ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©!');
                }).catch(() => {
                    alert('üìã ŸÖŸÑÿÆÿµ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±:\n\n' + summary);
                });
            }
        };
        
        // Check Data Quality - ENHANCED WITH AUTO-FIX
        function checkDataQuality() {
            if (!planData) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑŸÅÿ≠ÿµ');
                return;
            }
            
            const issues = {
                critical: [],
                warnings: [],
                suggestions: []
            };
            
            // Check inspections
            if (planData.inspectionData) {
                planData.inspectionData.forEach((insp, idx) => {
                    if (!insp.inspector) issues.critical.push({ type: 'missing_inspector', index: idx, message: `ÿ™ŸÅÿ™Ÿäÿ¥ ${idx + 1}: ŸÖŸÅÿ™ÿ¥ ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ` });
                    if (!insp.day) issues.critical.push({ type: 'missing_date', index: idx, message: `ÿ™ŸÅÿ™Ÿäÿ¥ ${idx + 1}: ÿ™ÿßÿ±ŸäÿÆ ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ` });
                    if (!insp.area) issues.warnings.push({ type: 'missing_area', index: idx, message: `ÿ™ŸÅÿ™Ÿäÿ¥ ${idx + 1}: ŸÖŸÜÿ∑ŸÇÿ© ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØÿ©` });
                    if (!insp.shops || insp.shops.length === 0) issues.warnings.push({ type: 'no_shops', index: idx, message: `ÿ™ŸÅÿ™Ÿäÿ¥ ${idx + 1}: ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™` });
                    if (!insp.id) issues.suggestions.push({ type: 'missing_id', index: idx, message: `ÿ™ŸÅÿ™Ÿäÿ¥ ${idx + 1}: ŸÖÿπÿ±ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ` });
                    if (!insp.shift) issues.suggestions.push({ type: 'missing_shift', index: idx, message: `ÿ™ŸÅÿ™Ÿäÿ¥ ${idx + 1}: ŸÖŸÜÿßŸàÿ®ÿ© ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØÿ©` });
                    
                    // Check date format
                    if (insp.day && !/^\d{4}-\d{2}-\d{2}$/.test(insp.day)) {
                        issues.warnings.push({ type: 'invalid_date_format', index: idx, message: `ÿ™ŸÅÿ™Ÿäÿ¥ ${idx + 1}: ÿµŸäÿ∫ÿ© ÿ™ÿßÿ±ŸäÿÆ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ© (${insp.day})` });
                    }
                });
            }
            
            // Check duplicates
            const inspectionKeys = new Map();
            planData.inspectionData.forEach((insp, idx) => {
                const key = `${insp.inspector}-${insp.day}`;
                if (inspectionKeys.has(key)) {
                    issues.warnings.push({
                        type: 'duplicate',
                        index: idx,
                        originalIndex: inspectionKeys.get(key),
                        message: `ÿ™ŸÅÿ™Ÿäÿ¥ ŸÖŸÉÿ±ÿ±: ${insp.inspector} ŸÅŸä ${insp.day}`,
                        fixable: true
                    });
                } else {
                    inspectionKeys.set(key, idx);
                }
            });
            
            // Check shops
            if (planData.shops) {
                planData.shops.forEach((shop, idx) => {
                    if (!shop.name) issues.critical.push({ type: 'missing_shop_name', index: idx, message: `ŸÖÿ≠ŸÑ ${idx + 1}: ÿßÿ≥ŸÖ ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ` });
                    if (!shop.id) issues.suggestions.push({ type: 'missing_shop_id', index: idx, message: `ŸÖÿ≠ŸÑ ${idx + 1}: ŸÖÿπÿ±ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ`, fixable: true });
                    if (!shop.areaId) issues.warnings.push({ type: 'missing_shop_area', index: idx, message: `${shop.name || 'ŸÖÿ≠ŸÑ ' + (idx + 1)}: ŸÖŸÜÿ∑ŸÇÿ© ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØÿ©` });
                });
                
                // Check for duplicate shop names
                const shopNames = new Map();
                planData.shops.forEach((shop, idx) => {
                    const name = shop.name?.toLowerCase().trim();
                    if (name) {
                        if (shopNames.has(name)) {
                            issues.warnings.push({
                                type: 'duplicate_shop',
                                index: idx,
                                originalIndex: shopNames.get(name),
                                message: `ŸÖÿ≠ŸÑ ŸÖŸÉÿ±ÿ±: ${shop.name}`,
                                fixable: true
                            });
                        } else {
                            shopNames.set(name, idx);
                        }
                    }
                });
            }
            
            // Check areas
            if (planData.areas) {
                planData.areas.forEach((area, idx) => {
                    if (!area.name) issues.critical.push({ type: 'missing_area_name', index: idx, message: `ŸÖŸÜÿ∑ŸÇÿ© ${idx + 1}: ÿßÿ≥ŸÖ ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ` });
                    if (!area.id) issues.suggestions.push({ type: 'missing_area_id', index: idx, message: `ŸÖŸÜÿ∑ŸÇÿ© ${idx + 1}: ŸÖÿπÿ±ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ`, fixable: true });
                });
            }
            
            // Check inspectors
            if (planData.inspectors) {
                planData.inspectors.forEach((inspector, idx) => {
                    if (!inspector.name) issues.critical.push({ type: 'missing_inspector_name', index: idx, message: `ŸÖŸÅÿ™ÿ¥ ${idx + 1}: ÿßÿ≥ŸÖ ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ` });
                });
            }
            
            // Create quality report modal
            const totalIssues = issues.critical.length + issues.warnings.length + issues.suggestions.length;
            
            if (totalIssues === 0) {
                alert('‚úÖ ŸÖŸÖÿ™ÿßÿ≤! ÿ¨ŸàÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπÿßŸÑŸäÿ© ÿ¨ÿØÿßŸã!\n\nŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ¥ÿßŸÉŸÑ ŸÅŸä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'qualityModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 900px; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #667eea;">
                        <h2 style="color: #2d3561; margin: 0;">üîç ÿ™ŸÇÿ±Ÿäÿ± ÿ¨ŸàÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h2>
                        <button onclick="document.getElementById('qualityModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">√ó</button>
                    </div>
                    
                    <!-- Summary -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: ${issues.critical.length > 0 ? 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)' : 'linear-gradient(135deg, #27ae60 0%, #229954 100%)'}; padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 700;">${issues.critical.length}</div>
                            <div>ŸÖÿ¥ÿßŸÉŸÑ ÿ≠ÿ±ÿ¨ÿ©</div>
                        </div>
                        <div style="background: ${issues.warnings.length > 0 ? 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)' : 'linear-gradient(135deg, #27ae60 0%, #229954 100%)'}; padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 700;">${issues.warnings.length}</div>
                            <div>ÿ™ÿ≠ÿ∞Ÿäÿ±ÿßÿ™</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 20px; border-radius: 15px; color: white; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 700;">${issues.suggestions.length}</div>
                            <div>ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™</div>
                        </div>
                    </div>
                    
                    <!-- Critical Issues -->
                    ${issues.critical.length > 0 ? `
                        <div style="background: #ffebee; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #e74c3c;">
                            <h3 style="color: #c0392b; margin-bottom: 15px;">üö® ŸÖÿ¥ÿßŸÉŸÑ ÿ≠ÿ±ÿ¨ÿ© (Ÿäÿ¨ÿ® ÿ•ÿµŸÑÿßÿ≠Ÿáÿß)</h3>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${issues.critical.slice(0, 20).map(issue => `
                                    <div style="padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px; border-right: 4px solid #e74c3c;">
                                        ${issue.message}
                                    </div>
                                `).join('')}
                                ${issues.critical.length > 20 ? `<div style="text-align: center; color: #666; padding: 10px;">... Ÿà ${issues.critical.length - 20} ŸÖÿ¥ŸÉŸÑÿ© ÿ£ÿÆÿ±Ÿâ</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Warnings -->
                    ${issues.warnings.length > 0 ? `
                        <div style="background: #fff3cd; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #ffc107;">
                            <h3 style="color: #856404; margin-bottom: 15px;">‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±ÿßÿ™ (ŸäŸèŸÜÿµÿ≠ ÿ®ÿ•ÿµŸÑÿßÿ≠Ÿáÿß)</h3>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${issues.warnings.slice(0, 20).map(issue => `
                                    <div style="padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px; border-right: 4px solid #ffc107;">
                                        ${issue.message}
                                        ${issue.fixable ? '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 10px;">ŸÇÿßÿ®ŸÑ ŸÑŸÑÿ•ÿµŸÑÿßÿ≠</span>' : ''}
                                    </div>
                                `).join('')}
                                ${issues.warnings.length > 20 ? `<div style="text-align: center; color: #666; padding: 10px;">... Ÿà ${issues.warnings.length - 20} ÿ™ÿ≠ÿ∞Ÿäÿ± ÿ¢ÿÆÿ±</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Suggestions -->
                    ${issues.suggestions.length > 0 ? `
                        <div style="background: #d1ecf1; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #17a2b8;">
                            <h3 style="color: #0c5460; margin-bottom: 15px;">üí° ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿ™ÿ≠ÿ≥ŸäŸÜ</h3>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${issues.suggestions.slice(0, 20).map(issue => `
                                    <div style="padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px; border-right: 4px solid #17a2b8;">
                                        ${issue.message}
                                        ${issue.fixable ? '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 10px;">ŸÇÿßÿ®ŸÑ ŸÑŸÑÿ•ÿµŸÑÿßÿ≠</span>' : ''}
                                    </div>
                                `).join('')}
                                ${issues.suggestions.length > 20 ? `<div style="text-align: center; color: #666; padding: 10px;">... Ÿà ${issues.suggestions.length - 20} ÿßŸÇÿ™ÿ±ÿßÿ≠ ÿ¢ÿÆÿ±</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Auto-fix Options -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0;">üîß ÿßŸÑÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä</h3>
                        <p style="margin-bottom: 15px; font-size: 0.95em;">ŸäŸÖŸÉŸÜ ŸÑŸÑŸÜÿ∏ÿßŸÖ ÿ•ÿµŸÑÿßÿ≠ ÿ®ÿπÿ∂ ÿßŸÑŸÖÿ¥ÿßŸÉŸÑ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã:</p>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="autoFixMissingIds()" class="btn btn-success" style="background: white; color: #667eea;">
                                ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑŸÖÿπÿ±ŸÅÿßÿ™ ÿßŸÑŸÖŸÅŸÇŸàÿØÿ©
                            </button>
                            <button onclick="autoFixDuplicates()" class="btn btn-warning" style="background: white; color: #667eea;">
                                ÿØŸÖÿ¨ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©
                            </button>
                            <button onclick="autoFixMissingShifts()" class="btn btn-info" style="background: white; color: #667eea;">
                                ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
                            </button>
                        </div>
                    </div>
                    
                    <!-- Export Report -->
                    <div style="text-align: center;">
                        <button onclick="exportQualityReport()" class="btn btn-primary">
                            <span>üìÑ</span>
                            <span>ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¨ŸàÿØÿ©</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store issues for auto-fix functions
            window.currentQualityIssues = issues;
        }
        
        // Auto-fix Missing IDs
        window.autoFixMissingIds = function() {
            let fixed = 0;
            
            // Fix inspection IDs
            planData.inspectionData?.forEach(insp => {
                if (!insp.id) {
                    insp.id = 'insp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    fixed++;
                }
            });
            
            // Fix shop IDs
            planData.shops?.forEach(shop => {
                if (!shop.id) {
                    shop.id = 'shop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    fixed++;
                }
            });
            
            // Fix area IDs
            planData.areas?.forEach(area => {
                if (!area.id) {
                    area.id = 'area_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    fixed++;
                }
            });
            
            alert(`‚úÖ ÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠ ${fixed} ŸÖÿπÿ±ŸÅ ŸÖŸÅŸÇŸàÿØ!\n\n‚ö†Ô∏è ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™`);
            document.getElementById('qualityModal').remove();
            checkDataQuality(); // Re-check
        };
        
        // Auto-fix Duplicates
        window.autoFixDuplicates = async function() {
            const duplicates = window.currentQualityIssues.warnings.filter(i => i.type === 'duplicate');
            
            if (duplicates.length === 0) {
                alert('‚úÖ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÖŸÉÿ±ÿ±ÿ©!');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è ÿ≥Ÿäÿ™ŸÖ ÿØŸÖÿ¨ ${duplicates.length} ÿ™ŸÅÿ™Ÿäÿ¥ ŸÖŸÉÿ±ÿ±\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`)) {
                return;
            }
            
            // Call bulk merge function
            await bulkMergeDuplicates();
        };
        
        // Auto-fix Missing Shifts
        window.autoFixMissingShifts = function() {
            let fixed = 0;
            
            planData.inspectionData?.forEach(insp => {
                if (!insp.shift) {
                    insp.shift = 'ÿµÿ®ÿßÿ≠Ÿäÿ©'; // Default to morning shift
                    fixed++;
                }
            });
            
            alert(`‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${fixed} ŸÖŸÜÿßŸàÿ®ÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© (ÿµÿ®ÿßÿ≠Ÿäÿ©)!\n\n‚ö†Ô∏è ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™`);
            document.getElementById('qualityModal').remove();
            checkDataQuality(); // Re-check
        };
        
        // Export Quality Report
        window.exportQualityReport = function() {
            const issues = window.currentQualityIssues;
            
            let report = 'üîç ÿ™ŸÇÿ±Ÿäÿ± ÿ¨ŸàÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ - Smart Planner\n';
            report += '‚ïê'.repeat(60) + '\n\n';
            report += `üìÖ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÅÿ≠ÿµ: ${new Date().toLocaleString('ar-EG')}\n\n`;
            
            report += 'üìä ŸÖŸÑÿÆÿµ ÿßŸÑŸÖÿ¥ÿßŸÉŸÑ:\n';
            report += '‚îÄ'.repeat(60) + '\n';
            report += `   üö® ŸÖÿ¥ÿßŸÉŸÑ ÿ≠ÿ±ÿ¨ÿ©: ${issues.critical.length}\n`;
            report += `   ‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±ÿßÿ™: ${issues.warnings.length}\n`;
            report += `   üí° ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™: ${issues.suggestions.length}\n\n`;
            
            if (issues.critical.length > 0) {
                report += 'üö® ÿßŸÑŸÖÿ¥ÿßŸÉŸÑ ÿßŸÑÿ≠ÿ±ÿ¨ÿ©:\n';
                report += '‚îÄ'.repeat(60) + '\n';
                issues.critical.forEach((issue, idx) => {
                    report += `   ${idx + 1}. ${issue.message}\n`;
                });
                report += '\n';
            }
            
            if (issues.warnings.length > 0) {
                report += '‚ö†Ô∏è ÿßŸÑÿ™ÿ≠ÿ∞Ÿäÿ±ÿßÿ™:\n';
                report += '‚îÄ'.repeat(60) + '\n';
                issues.warnings.forEach((issue, idx) => {
                    report += `   ${idx + 1}. ${issue.message}${issue.fixable ? ' [ŸÇÿßÿ®ŸÑ ŸÑŸÑÿ•ÿµŸÑÿßÿ≠]' : ''}\n`;
                });
                report += '\n';
            }
            
            if (issues.suggestions.length > 0) {
                report += 'üí° ÿßŸÑÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™:\n';
                report += '‚îÄ'.repeat(60) + '\n';
                issues.suggestions.forEach((issue, idx) => {
                    report += `   ${idx + 1}. ${issue.message}${issue.fixable ? ' [ŸÇÿßÿ®ŸÑ ŸÑŸÑÿ•ÿµŸÑÿßÿ≠]' : ''}\n`;
                });
            }
            
            const dataBlob = new Blob(['\uFEFF' + report], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ÿ™ŸÇÿ±Ÿäÿ±-ÿ¨ŸàÿØÿ©-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¨ŸàÿØÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
        };
        
        // View System Logs - ENHANCED WITH DETAILED LOGS
        function viewSystemLogs() {
            // Initialize logs in sessionStorage if not exists
            if (!sessionStorage.getItem('smartPlannerLogs')) {
                sessionStorage.setItem('smartPlannerLogs', JSON.stringify([]));
            }
            
            const logs = JSON.parse(sessionStorage.getItem('smartPlannerLogs') || '[]');
            
            // Add current system status
            const currentStatus = {
                timestamp: new Date().toISOString(),
                type: 'info',
                message: 'ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ',
                details: {
                    inspections: planData?.inspectionData?.length || 0,
                    shops: planData?.shops?.length || 0,
                    areas: planData?.areas?.length || 0,
                    inspectors: planData?.inspectors?.length || 0
                }
            };
            
            // Create system logs modal
            const modal = document.createElement('div');
            modal.id = 'logsModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 1000px; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #667eea;">
                        <h2 style="color: #2d3561; margin: 0;">üìã ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖŸÅÿµŸÑ</h2>
                        <button onclick="document.getElementById('logsModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer;">√ó</button>
                    </div>
                    
                    <!-- System Status -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0;">‚ö° ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≠ÿßŸÑŸäÿ©</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: 700;">${planData?.inspectionData?.length || 0}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: 700;">${planData?.shops?.length || 0}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: 700;">${planData?.areas?.length || 0}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: 700;">${planData?.inspectors?.length || 0}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">ÿßŸÑŸÖŸÅÿ™ÿ¥ŸàŸÜ</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                            <div style="font-size: 0.9em;">
                                üìÖ ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´: ${planData?.lastUpdate ? new Date(planData.lastUpdate).toLocaleString('ar-EG') : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Log Controls -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button onclick="filterLogs('all')" class="btn btn-primary btn-sm">
                            ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ (${logs.length})
                        </button>
                        <button onclick="filterLogs('info')" class="btn btn-info btn-sm">
                            ŸÖÿπŸÑŸàŸÖÿßÿ™ (${logs.filter(l => l.type === 'info').length})
                        </button>
                        <button onclick="filterLogs('success')" class="btn btn-success btn-sm">
                            ŸÜÿ¨ÿßÿ≠ (${logs.filter(l => l.type === 'success').length})
                        </button>
                        <button onclick="filterLogs('warning')" class="btn btn-warning btn-sm">
                            ÿ™ÿ≠ÿ∞Ÿäÿ±ÿßÿ™ (${logs.filter(l => l.type === 'warning').length})
                        </button>
                        <button onclick="filterLogs('error')" class="btn btn-danger btn-sm">
                            ÿ£ÿÆÿ∑ÿßÿ° (${logs.filter(l => l.type === 'error').length})
                        </button>
                        <button onclick="clearSystemLogs()" class="btn btn-danger btn-sm">
                            ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™
                        </button>
                        <button onclick="exportSystemLogs()" class="btn btn-success btn-sm">
                            ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™
                        </button>
                    </div>
                    
                    <!-- Logs Display -->
                    <div id="logsDisplay" style="background: #f8f9fa; padding: 20px; border-radius: 15px; max-height: 500px; overflow-y: auto;">
                        ${logs.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <div style="font-size: 3em; margin-bottom: 10px;">üìã</div>
                                <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™ ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ</p>
                                <p style="font-size: 0.9em;">ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ŸáŸÜÿß ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã</p>
                            </div>
                        ` : logs.slice().reverse().map(log => {
                            const typeColors = {
                                info: { bg: '#d1ecf1', border: '#17a2b8', icon: '‚ÑπÔ∏è' },
                                success: { bg: '#d4edda', border: '#28a745', icon: '‚úÖ' },
                                warning: { bg: '#fff3cd', border: '#ffc107', icon: '‚ö†Ô∏è' },
                                error: { bg: '#f8d7da', border: '#dc3545', icon: '‚ùå' }
                            };
                            const style = typeColors[log.type] || typeColors.info;
                            
                            return `
                                <div class="log-entry" data-type="${log.type}" style="background: ${style.bg}; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-right: 4px solid ${style.border};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 1.2em;">${style.icon}</span>
                                            <strong>${log.message}</strong>
                                        </div>
                                        <small style="color: #666;">${new Date(log.timestamp).toLocaleString('ar-EG')}</small>
                                    </div>
                                    ${log.details ? `
                                        <div style="font-size: 0.9em; color: #666; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(0,0,0,0.1);">
                                            ${typeof log.details === 'object' ? 
                                                Object.entries(log.details).map(([k, v]) => `${k}: ${v}`).join(' ‚Ä¢ ') : 
                                                log.details
                                            }
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Filter Logs
        window.filterLogs = function(type) {
            const entries = document.querySelectorAll('.log-entry');
            entries.forEach(entry => {
                if (type === 'all' || entry.dataset.type === type) {
                    entry.style.display = 'block';
                } else {
                    entry.style.display = 'none';
                }
            });
        };
        
        // Clear System Logs
        window.clearSystemLogs = function() {
            if (!confirm('‚ö†Ô∏è ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ÿü\n\nŸÑŸÜ ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπŸáÿß!')) {
                return;
            }
            
            sessionStorage.setItem('smartPlannerLogs', JSON.stringify([]));
            document.getElementById('logsModal').remove();
            alert('‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™');
        };
        
        // Export System Logs
        window.exportSystemLogs = function() {
            const logs = JSON.parse(sessionStorage.getItem('smartPlannerLogs') || '[]');
            
            if (logs.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™ ŸÑÿ™ÿµÿØŸäÿ±Ÿáÿß');
                return;
            }
            
            let report = 'üìã ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ - Smart Planner\n';
            report += '‚ïê'.repeat(60) + '\n\n';
            report += `üìÖ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±: ${new Date().toLocaleString('ar-EG')}\n`;
            report += `üìä ÿπÿØÿØ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™: ${logs.length}\n\n`;
            
            logs.slice().reverse().forEach((log, idx) => {
                report += `[${idx + 1}] ${new Date(log.timestamp).toLocaleString('ar-EG')}\n`;
                report += `ÿßŸÑŸÜŸàÿπ: ${log.type.toUpperCase()}\n`;
                report += `ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©: ${log.message}\n`;
                if (log.details) {
                    report += `ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ: ${typeof log.details === 'object' ? JSON.stringify(log.details, null, 2) : log.details}\n`;
                }
                report += '‚îÄ'.repeat(60) + '\n\n';
            });
            
            const dataBlob = new Blob(['\uFEFF' + report], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `system-logs-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!');
        };
        
        // Add System Log (utility function)
        window.addSystemLog = function(type, message, details = null) {
            const logs = JSON.parse(sessionStorage.getItem('smartPlannerLogs') || '[]');
            logs.push({
                timestamp: new Date().toISOString(),
                type: type,
                message: message,
                details: details
            });
            
            // Keep only last 100 logs
            if (logs.length > 100) {
                logs.splice(0, logs.length - 100);
            }
            
            sessionStorage.setItem('smartPlannerLogs', JSON.stringify(logs));
        };
        
        // Bulk Operations - REAL IMPLEMENTATION
        function bulkOperations() {
            if (!planData || !planData.inspectionData) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ¨ŸÖÿßÿπŸäÿ©');
                return;
            }
            
            // Create bulk operations modal
            const modal = document.createElement('div');
            modal.id = 'bulkOpsModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 3% auto; padding: 30px; border-radius: 20px; max-width: 900px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #667eea;">
                        <h2 style="color: #2d3561; margin: 0;">‚öôÔ∏è ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ¨ŸÖÿßÿπŸäÿ© ÿßŸÑÿ∞ŸÉŸäÿ©</h2>
                        <button onclick="document.getElementById('bulkOpsModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">√ó</button>
                    </div>
                    
                    <!-- Operation Selection -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <button onclick="bulkEditInspections()" class="btn btn-primary" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">‚úèÔ∏è</span>
                            <span>ÿ™ÿπÿØŸäŸÑ ÿ¨ŸÖÿßÿπŸä ŸÑŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</span>
                        </button>
                        <button onclick="bulkDeleteInspections()" class="btn btn-danger" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">üóëÔ∏è</span>
                            <span>ÿ≠ÿ∞ŸÅ ÿ¨ŸÖÿßÿπŸä ŸÑŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</span>
                        </button>
                        <button onclick="bulkCopyInspections()" class="btn btn-info" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">üìã</span>
                            <span>ŸÜÿ≥ÿÆ ÿ¨ŸÖÿßÿπŸä ŸÑŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</span>
                        </button>
                        <button onclick="bulkReassignInspectors()" class="btn btn-warning" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">üë•</span>
                            <span>ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</span>
                        </button>
                        <button onclick="bulkReassignAreas()" class="btn btn-success" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">üó∫Ô∏è</span>
                            <span>ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</span>
                        </button>
                        <button onclick="bulkMergeDuplicates()" class="btn btn-primary" style="padding: 20px; flex-direction: column; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">üîó</span>
                            <span>ÿØŸÖÿ¨ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©</span>
                        </button>
                    </div>
                    
                    <!-- Statistics -->
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 15px; margin-top: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">üìä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #667eea;">${planData.inspectionData.length}</div>
                                <div style="color: #666; font-size: 0.9em;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #11998e;">${new Set(planData.inspectionData.map(i => i.inspector)).size}</div>
                                <div style="color: #666; font-size: 0.9em;">ÿπÿØÿØ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #fa709a;">${new Set(planData.inspectionData.map(i => i.area)).size}</div>
                                <div style="color: #666; font-size: 0.9em;">ÿπÿØÿØ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2.5em; font-weight: 700; color: #ffc107;">${planData.inspectionData.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0)}</div>
                                <div style="color: #666; font-size: 0.9em;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Bulk Edit Inspections
        window.bulkEditInspections = function() {
            const selectedRange = prompt('üìÖ ÿ£ÿØÿÆŸÑ ŸÜÿ∑ÿßŸÇ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ ŸÑŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÖÿ±ÿßÿØ ÿ™ÿπÿØŸäŸÑŸáÿß:\n\nŸÖÿ´ÿßŸÑ: 2025-01-01 ÿ•ŸÑŸâ 2025-01-31\n\nÿßŸÑÿµŸäÿ∫ÿ©: ŸÖŸÜ-ÿ™ÿßÿ±ŸäÿÆ ÿ•ŸÑŸâ ÿ•ŸÑŸâ-ÿ™ÿßÿ±ŸäÿÆ', '2025-01-01 ÿ•ŸÑŸâ 2025-01-31');
            if (!selectedRange) return;
            
            const parts = selectedRange.split(' ÿ•ŸÑŸâ ');
            if (parts.length !== 2) {
                alert('‚ö†Ô∏è ÿµŸäÿ∫ÿ© ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©. ÿßÿ≥ÿ™ÿÆÿØŸÖ: ŸÖŸÜ-ÿ™ÿßÿ±ŸäÿÆ ÿ•ŸÑŸâ ÿ•ŸÑŸâ-ÿ™ÿßÿ±ŸäÿÆ');
                return;
            }
            
            const fromDate = new Date(parts[0].trim());
            const toDate = new Date(parts[1].trim());
            
            const matchingInspections = planData.inspectionData.filter(insp => {
                const inspDate = new Date(insp.day);
                return inspDate >= fromDate && inspDate <= toDate;
            });
            
            if (matchingInspections.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÅŸä ÿßŸÑŸÜÿ∑ÿßŸÇ ÿßŸÑŸÖÿ≠ÿØÿØ');
                return;
            }
            
            const action = confirm(`‚úèÔ∏è ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${matchingInspections.length} ÿ™ŸÅÿ™Ÿäÿ¥ ŸÅŸä ÿßŸÑŸÜÿ∑ÿßŸÇ ÿßŸÑŸÖÿ≠ÿØÿØ.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ:\nOK = ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÅÿ™ÿ¥\nCancel = ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©`);
            
            if (action) {
                // Edit inspector
                const newInspector = prompt('üë§ ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿßŸÑÿ¨ÿØŸäÿØ:', matchingInspections[0].inspector);
                if (!newInspector) return;
                
                matchingInspections.forEach(insp => {
                    insp.inspector = newInspector;
                });
                
                alert(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${matchingInspections.length} ÿ™ŸÅÿ™Ÿäÿ¥!\n\nÿßŸÑŸÖŸÅÿ™ÿ¥ ÿßŸÑÿ¨ÿØŸäÿØ: ${newInspector}\n\n‚ö†Ô∏è ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™`);
            } else {
                // Edit area
                const newArea = prompt('üó∫Ô∏è ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©:', matchingInspections[0].area);
                if (!newArea) return;
                
                matchingInspections.forEach(insp => {
                    insp.area = newArea;
                });
                
                alert(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${matchingInspections.length} ÿ™ŸÅÿ™Ÿäÿ¥!\n\nÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©: ${newArea}\n\n‚ö†Ô∏è ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™`);
            }
        };
        
        // Bulk Delete Inspections
        window.bulkDeleteInspections = async function() {
            const selectedRange = prompt('üóëÔ∏è ÿ£ÿØÿÆŸÑ ŸÜÿ∑ÿßŸÇ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ ŸÑŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÖÿ±ÿßÿØ ÿ≠ÿ∞ŸÅŸáÿß:\n\nŸÖÿ´ÿßŸÑ: 2025-01-01 ÿ•ŸÑŸâ 2025-01-31\n\nÿßŸÑÿµŸäÿ∫ÿ©: ŸÖŸÜ-ÿ™ÿßÿ±ŸäÿÆ ÿ•ŸÑŸâ ÿ•ŸÑŸâ-ÿ™ÿßÿ±ŸäÿÆ', '2025-01-01 ÿ•ŸÑŸâ 2025-01-31');
            if (!selectedRange) return;
            
            const parts = selectedRange.split(' ÿ•ŸÑŸâ ');
            if (parts.length !== 2) {
                alert('‚ö†Ô∏è ÿµŸäÿ∫ÿ© ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©. ÿßÿ≥ÿ™ÿÆÿØŸÖ: ŸÖŸÜ-ÿ™ÿßÿ±ŸäÿÆ ÿ•ŸÑŸâ ÿ•ŸÑŸâ-ÿ™ÿßÿ±ŸäÿÆ');
                return;
            }
            
            const fromDate = new Date(parts[0].trim());
            const toDate = new Date(parts[1].trim());
            
            const beforeCount = planData.inspectionData.length;
            planData.inspectionData = planData.inspectionData.filter(insp => {
                const inspDate = new Date(insp.day);
                return !(inspDate >= fromDate && inspDate <= toDate);
            });
            
            const deletedCount = beforeCount - planData.inspectionData.length;
            
            if (deletedCount === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÅŸä ÿßŸÑŸÜÿ∑ÿßŸÇ ÿßŸÑŸÖÿ≠ÿØÿØ');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ${deletedCount} ÿ™ŸÅÿ™Ÿäÿ¥ÿü\n\nŸáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸáÿß!`)) {
                // Reload data to undo
                await loadPlanData();
                return;
            }
            
            try {
                await savePlanDataToGitHub();
                alert(`‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${deletedCount} ÿ™ŸÅÿ™Ÿäÿ¥ ÿ®ŸÜÿ¨ÿßÿ≠!`);
                document.getElementById('bulkOpsModal').remove();
            } catch (error) {
                alert('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏: ' + error.message);
            }
        };
        
        // Bulk Copy Inspections
        window.bulkCopyInspections = function() {
            const sourceDate = prompt('üìÖ ÿ£ÿØÿÆŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿµÿØÿ± (ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ÿ±ŸäÿØ ŸÜÿ≥ÿÆŸáÿß):', '2025-01-01');
            if (!sourceDate) return;
            
            const targetDate = prompt('üìÖ ÿ£ÿØÿÆŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸáÿØŸÅ (ÿ≠Ÿäÿ´ ÿ™ÿ±ŸäÿØ ŸÜÿ≥ÿÆ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™):', '2025-02-01');
            if (!targetDate) return;
            
            const sourceInspections = planData.inspectionData.filter(i => i.day === sourceDate);
            
            if (sourceInspections.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÅŸä ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿµÿØÿ±');
                return;
            }
            
            // Check if target date already has inspections
            const targetInspections = planData.inspectionData.filter(i => i.day === targetDate);
            if (targetInspections.length > 0) {
                if (!confirm(`‚ö†Ô∏è ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸáÿØŸÅ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ${targetInspections.length} ÿ™ŸÅÿ™Ÿäÿ¥.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©ÿü`)) {
                    return;
                }
            }
            
            // Copy inspections
            sourceInspections.forEach(insp => {
                const copiedInsp = {
                    ...insp,
                    day: targetDate,
                    id: 'insp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
                };
                planData.inspectionData.push(copiedInsp);
            });
            
            alert(`‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ${sourceInspections.length} ÿ™ŸÅÿ™Ÿäÿ¥ ŸÖŸÜ ${sourceDate} ÿ•ŸÑŸâ ${targetDate}!\n\n‚ö†Ô∏è ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™`);
        };
        
        // Bulk Reassign Inspectors
        window.bulkReassignInspectors = function() {
            const oldInspector = prompt('üë§ ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿßŸÑŸÇÿØŸäŸÖ:', planData.inspectors[0]?.name || '');
            if (!oldInspector) return;
            
            const newInspector = prompt('üë§ ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿßŸÑÿ¨ÿØŸäÿØ:');
            if (!newInspector) return;
            
            const matchingInspections = planData.inspectionData.filter(i => i.inspector === oldInspector);
            
            if (matchingInspections.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÑŸÑŸÖŸÅÿ™ÿ¥ ÿßŸÑŸÖÿ≠ÿØÿØ');
                return;
            }
            
            if (!confirm(`üîÑ ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${matchingInspections.length} ÿ™ŸÅÿ™Ÿäÿ¥\n\nŸÖŸÜ: ${oldInspector}\nÿ•ŸÑŸâ: ${newInspector}\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`)) {
                return;
            }
            
            matchingInspections.forEach(insp => {
                insp.inspector = newInspector;
            });
            
            alert(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${matchingInspections.length} ÿ™ŸÅÿ™Ÿäÿ¥!\n\n‚ö†Ô∏è ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™`);
        };
        
        // Bulk Reassign Areas
        window.bulkReassignAreas = function() {
            const oldArea = prompt('üó∫Ô∏è ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÇÿØŸäŸÖÿ©:', planData.areas[0]?.name || '');
            if (!oldArea) return;
            
            const newArea = prompt('üó∫Ô∏è ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©:');
            if (!newArea) return;
            
            const matchingInspections = planData.inspectionData.filter(i => i.area === oldArea);
            
            if (matchingInspections.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÑŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©');
                return;
            }
            
            if (!confirm(`üîÑ ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${matchingInspections.length} ÿ™ŸÅÿ™Ÿäÿ¥\n\nŸÖŸÜ: ${oldArea}\nÿ•ŸÑŸâ: ${newArea}\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`)) {
                return;
            }
            
            matchingInspections.forEach(insp => {
                insp.area = newArea;
            });
            
            alert(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${matchingInspections.length} ÿ™ŸÅÿ™Ÿäÿ¥!\n\n‚ö†Ô∏è ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™`);
        };
        
        // Bulk Merge Duplicates
        window.bulkMergeDuplicates = async function() {
            const duplicates = [];
            const seen = new Map();
            
            planData.inspectionData.forEach((insp, idx) => {
                const key = `${insp.inspector}-${insp.day}-${insp.area}`;
                if (seen.has(key)) {
                    duplicates.push({
                        original: seen.get(key),
                        duplicate: idx,
                        inspector: insp.inspector,
                        day: insp.day,
                        area: insp.area
                    });
                } else {
                    seen.set(key, idx);
                }
            });
            
            if (duplicates.length === 0) {
                alert('‚úÖ ÿ±ÿßÿ¶ÿπ! ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÖŸÉÿ±ÿ±ÿ© ŸÅŸä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${duplicates.length} ÿ™ŸÅÿ™Ÿäÿ¥ ŸÖŸÉÿ±ÿ±\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿØŸÖÿ¨Ÿáÿß ŸàŸÖÿ≠ŸÑÿßÿ™Ÿáÿß Ÿàÿ≠ÿ∞ŸÅ ÿßŸÑÿ™ŸÉÿ±ÿßÿ±ÿßÿ™ÿü`)) {
                return;
            }
            
            // Merge duplicates
            duplicates.forEach(dup => {
                const original = planData.inspectionData[dup.original];
                const duplicate = planData.inspectionData[dup.duplicate];
                
                // Merge shops
                if (duplicate.shops) {
                    if (!original.shops) original.shops = [];
                    duplicate.shops.forEach(shop => {
                        if (!original.shops.includes(shop)) {
                            original.shops.push(shop);
                        }
                    });
                }
            });
            
            // Remove duplicates
            const toRemove = new Set(duplicates.map(d => d.duplicate));
            planData.inspectionData = planData.inspectionData.filter((_, idx) => !toRemove.has(idx));
            
            try {
                await savePlanDataToGitHub();
                alert(`‚úÖ ÿ™ŸÖ ÿØŸÖÿ¨ Ÿàÿ≠ÿ∞ŸÅ ${duplicates.length} ÿ™ŸÅÿ™Ÿäÿ¥ ŸÖŸÉÿ±ÿ± ÿ®ŸÜÿ¨ÿßÿ≠!`);
                document.getElementById('bulkOpsModal').remove();
            } catch (error) {
                alert('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏: ' + error.message);
            }
        };
        
        // Reload Shops from Excel - REAL IMPLEMENTATION
        async function reloadShopsFromExcel() {
            if (!githubToken) {
                alert('‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            
            // Create file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.multiple = false;
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    // Show merge options modal
                    showExcelImportModal(file);
                } catch (error) {
                    alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ: ' + error.message);
                }
            };
            
            input.click();
        }
        
        // Show Excel Import Modal with merge options
        async function showExcelImportModal(file) {
            const modal = document.createElement('div');
            modal.id = 'excelImportModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 800px; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">üì• ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜ Excel</h2>
                        <button onclick="document.getElementById('excelImportModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">√ó</button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 10px 0;">üìã ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÑŸÅ</h3>
                        <p style="margin: 0;">üìÑ <strong>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ:</strong> ${file.name}</p>
                        <p style="margin: 5px 0 0 0;">üìä <strong>ÿßŸÑÿ≠ÿ¨ŸÖ:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">‚öôÔ∏è ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿØŸÖÿ¨</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="add" checked style="width: 20px; height: 20px;">
                                <div>
                                    <strong>ÿ•ÿ∂ÿßŸÅÿ© ŸÅŸÇÿ∑</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÅŸÇÿ∑ Ÿàÿ™ÿ¨ÿßŸáŸÑ ÿßŸÑŸÖŸÉÿ±ÿ±</p>
                                </div>
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="update" style="width: 20px; height: 20px;">
                                <div>
                                    <strong>ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàÿ¨ŸàÿØ</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ© ÿ®ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©</p>
                                </div>
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="replace" style="width: 20px; height: 20px;">
                                <div>
                                    <strong>ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ŸÉÿßŸÖŸÑ</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ© Ÿàÿßÿ≥ÿ™ÿ®ÿØÿßŸÑŸáÿß ÿ®ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ffc107;">
                        <h4 style="color: #856404; margin: 0 0 10px 0;">üìå ŸÖÿ™ÿ∑ŸÑÿ®ÿßÿ™ ŸÖŸÑŸÅ Excel</h4>
                        <ul style="margin: 0; padding-right: 20px; color: #856404;">
                            <li>Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ≠ÿ™ŸàŸä ÿßŸÑŸÖŸÑŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ÿπŸÖÿØÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©: ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑÿå ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©ÿå ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ</li>
                            <li>ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ÿ£ÿπŸÖÿØÿ© ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿ©: ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿπÿ±ŸäŸÅ ADMÿå ÿßŸÑÿπŸÜŸàÿßŸÜÿå ÿ¨Ÿáÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑÿå ÿßŸÑŸÜÿ¥ÿßÿ∑</li>
                            <li>Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑÿµŸÅ ÿßŸÑÿ´ÿßŸÜŸä ŸàŸÖÿß ÿ®ÿπÿØŸá (ÿßŸÑÿµŸÅ ÿßŸÑÿ£ŸàŸÑ ŸÑŸÑÿπŸÜÿßŸàŸäŸÜ)</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="processExcelImport('${file.name}')" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ‚úÖ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
                        </button>
                        <button onclick="document.getElementById('excelImportModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ‚ùå ÿ•ŸÑÿ∫ÿßÿ°
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store file data for processing
            window.excelImportFile = file;
        }
        
        // Process Excel Import
        async function processExcelImport(fileName) {
            const file = window.excelImportFile;
            if (!file) {
                alert('‚ùå ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸÑŸÅ');
                return;
            }
            
            // Get merge mode
            const mergeMode = document.querySelector('input[name="mergeMode"]:checked').value;
            
            // Close modal
            document.getElementById('excelImportModal').remove();
            
            // Show loading message
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingExcelImport';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10001;
                text-align: center;
            `;
            loadingDiv.innerHTML = `
                <h3 style="color: #2d3561; margin-bottom: 15px;">‚è≥ ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ...</h3>
                <p style="color: #666;">Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</p>
            `;
            document.body.appendChild(loadingDiv);
            
            try {
                // Read file
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get first sheet
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                
                if (!jsonData || jsonData.length === 0) {
                    throw new Error('ÿßŸÑŸÖŸÑŸÅ ŸÅÿßÿ±ÿ∫ ÿ£Ÿà ŸÑÿß Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿµÿßŸÑÿ≠ÿ©');
                }
                
                // Process the data
                const result = await processShopsData(jsonData, mergeMode);
                
                // Remove loading
                document.getElementById('loadingExcelImport').remove();
                
                // Show result
                alert(`‚úÖ ÿ™ŸÖ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠!\n\n` +
                      `üìä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©: ${result.processed}\n` +
                      `‚ûï ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ∂ÿßŸÅÿ©: ${result.added}\n` +
                      `üîÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿ´ÿ©: ${result.updated}\n` +
                      `‚è≠Ô∏è  ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿ¨ÿßŸáŸÑÿ©: ${result.skipped}\n\n` +
                      `ÿ≥Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¢ŸÜ...`);
                
                // Save to GitHub
                await savePlanData();
                
                // Refresh the list
                refreshShopsList();
                
            } catch (error) {
                document.getElementById('loadingExcelImport')?.remove();
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ: ' + error.message);
                console.error('Excel import error:', error);
            }
        }
        
        // Process shops data from Excel
        async function processShopsData(jsonData, mergeMode) {
            let processed = 0;
            let added = 0;
            let updated = 0;
            let skipped = 0;
            
            // Ensure planData.shops exists
            if (!planData.shops) {
                planData.shops = [];
            }
            
            // If replace mode, clear existing shops
            if (mergeMode === 'replace') {
                planData.shops = [];
            }
            
            // Get existing shop names for duplicate checking
            const existingShops = new Set(planData.shops.map(shop => shop.name));
            
            // Process each row
            for (const row of jsonData) {
                processed++;
                
                // Extract shop data (try different possible column names)
                const shopName = row['ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ'] || row['name'] || row['shopName'] || row['ÿßŸÑÿßÿ≥ŸÖ'];
                const area = row['ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©'] || row['area'] || row['ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©'];
                const licenseNo = row['ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ'] || row['license'] || row['licenseNo'] || '';
                const admCode = row['ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿπÿ±ŸäŸÅ'] || row['admCode'] || row['ADM'] || '';
                const address = row['ÿßŸÑÿπŸÜŸàÿßŸÜ'] || row['address'] || '';
                const contact = row['ÿ¨Ÿáÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ'] || row['contact'] || '';
                const activity = row['ÿßŸÑŸÜÿ¥ÿßÿ∑'] || row['activity'] || '';
                
                if (!shopName) {
                    skipped++;
                    continue;
                }
                
                // Check if shop exists
                const existingIndex = planData.shops.findIndex(s => s.name === shopName);
                const exists = existingIndex !== -1;
                
                if (exists && mergeMode === 'add') {
                    // Skip existing shops in add mode
                    skipped++;
                    continue;
                }
                
                // Create shop object
                const shopData = {
                    name: shopName,
                    area: area || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
                    id: admCode || licenseNo || `SHOP${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                };
                
                // Add optional fields if available
                if (licenseNo) shopData.licenseNo = licenseNo;
                if (address) shopData.address = address;
                if (contact) shopData.contact = contact;
                if (activity) shopData.activity = activity;
                
                if (exists && mergeMode === 'update') {
                    // Update existing shop
                    planData.shops[existingIndex] = { ...planData.shops[existingIndex], ...shopData };
                    updated++;
                } else {
                    // Add new shop
                    planData.shops.push(shopData);
                    added++;
                }
            }
            
            return { processed, added, updated, skipped };
        }
        
        // Export Shops to Excel - REAL IMPLEMENTATION
        function exportShopsToExcel() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±');
                return;
            }
            
            try {
                // Prepare data for export
                const exportData = planData.shops.map(shop => ({
                    'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ': shop.name,
                    'ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©': shop.area,
                    'ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿπÿ±ŸäŸÅ': shop.id || '',
                    'ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ': shop.licenseNo || '',
                    'ÿßŸÑÿπŸÜŸàÿßŸÜ': shop.address || '',
                    'ÿ¨Ÿáÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ': shop.contact || '',
                    'ÿßŸÑŸÜÿ¥ÿßÿ∑': shop.activity || ''
                }));
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 30 }, // ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ
                    { wch: 20 }, // ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©
                    { wch: 15 }, // ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿπÿ±ŸäŸÅ
                    { wch: 15 }, // ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ
                    { wch: 25 }, // ÿßŸÑÿπŸÜŸàÿßŸÜ
                    { wch: 20 }, // ÿ¨Ÿáÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
                    { wch: 25 }  // ÿßŸÑŸÜÿ¥ÿßÿ∑
                ];
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'ÿßŸÑŸÖÿ≠ŸÑÿßÿ™');
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `ŸÖÿ≠ŸÑÿßÿ™_${timestamp}.xlsx`;
                
                // Download file
                XLSX.writeFile(wb, filename);
                
                alert(`‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${exportData.length} ŸÖÿ≠ŸÑ ÿ•ŸÑŸâ ŸÖŸÑŸÅ Excel ÿ®ŸÜÿ¨ÿßÿ≠!\n\n` +
                      `üìÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ: ${filename}`);
                
            } catch (error) {
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message);
                console.error('Excel export error:', error);
            }
        }
        
        // Bulk Edit Shops - FULL IMPLEMENTATION
        async function bulkEditShops() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÑÿ™ÿπÿØŸäŸÑ');
                return;
            }
            
            // Create modal for bulk edit
            const modal = document.createElement('div');
            modal.id = 'bulkEditModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">‚úèÔ∏è ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ¨ŸÖÿßÿπŸä ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™</h2>
                        <button onclick="document.getElementById('bulkEditModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">√ó</button>
                    </div>
                    
                    <!-- Selection Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 15px 0;">üìã ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÑÿ™ÿπÿØŸäŸÑ</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button onclick="selectAllShopsForEdit()" style="padding: 10px 20px; border: none; border-radius: 8px; background: white; color: #667eea; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                ‚òëÔ∏è ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ
                            </button>
                            <button onclick="deselectAllShopsForEdit()" style="padding: 10px 20px; border: none; border-radius: 8px; background: white; color: #667eea; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                ‚òê ÿ•ŸÑÿ∫ÿßÿ° ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ
                            </button>
                            <select id="bulkEditAreaFilter" onchange="filterShopsForBulkEdit()" style="padding: 10px; border-radius: 8px; border: none; font-family: 'Cairo', sans-serif;">
                                <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Shops Selection List -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
                        <div id="bulkEditShopsList"></div>
                    </div>
                    
                    <!-- Edit Operations -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">‚öôÔ∏è ÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ™ÿπÿØŸäŸÑ</h3>
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">ŸÜŸÇŸÑ ÿ•ŸÑŸâ ŸÖŸÜÿ∑ŸÇÿ©:</label>
                                <select id="bulkEditNewArea" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                                    <option value="">-- ÿßÿÆÿ™ÿ± ŸÖŸÜÿ∑ŸÇÿ© --</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">ÿ•ÿ∂ÿßŸÅÿ© ÿ®ÿßÿØÿ¶ÿ© ŸÑŸÑÿ£ÿ≥ŸÖÿßÿ°:</label>
                                <input type="text" id="bulkEditPrefix" placeholder="ŸÖÿ´ÿßŸÑ: ŸÖÿ≠ŸÑ -" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">ÿ•ÿ∂ÿßŸÅÿ© ŸÑÿßÿ≠ŸÇÿ© ŸÑŸÑÿ£ÿ≥ŸÖÿßÿ°:</label>
                                <input type="text" id="bulkEditSuffix" placeholder="ŸÖÿ´ÿßŸÑ: - ÿßŸÑŸÅÿ±ÿπ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="bulkEditSelectedCount">0</div>
                            <div style="font-size: 0.9em;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="applyBulkEdit()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ‚úÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™
                        </button>
                        <button onclick="document.getElementById('bulkEditModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ‚ùå ÿ•ŸÑÿ∫ÿßÿ°
                        </button>
                    </div>
                    
                    <div id="bulkEditStatus" style="margin-top: 20px;"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate area filters and dropdowns
            const areaFilter = document.getElementById('bulkEditAreaFilter');
            const newAreaSelect = document.getElementById('bulkEditNewArea');
            
            if (planData.areas) {
                planData.areas.forEach(area => {
                    const filterOption = document.createElement('option');
                    filterOption.value = area.id;
                    filterOption.textContent = area.name;
                    areaFilter.appendChild(filterOption);
                    
                    const editOption = document.createElement('option');
                    editOption.value = area.id;
                    editOption.textContent = area.name;
                    newAreaSelect.appendChild(editOption);
                });
            }
            
            // Initialize shops list
            filterShopsForBulkEdit();
        }
        
        // Filter shops for bulk edit
        window.filterShopsForBulkEdit = function() {
            const filterAreaId = document.getElementById('bulkEditAreaFilter').value;
            const shopsList = document.getElementById('bulkEditShopsList');
            
            let shopsToShow = planData.shops;
            if (filterAreaId) {
                shopsToShow = shopsToShow.filter(s => s.areaId === filterAreaId);
            }
            
            shopsList.innerHTML = shopsToShow.map((shop, index) => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #e0e0e0;">
                        <input type="checkbox" id="shop_${shop.id}" value="${shop.id}" onchange="updateBulkEditCount()" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="shop_${shop.id}" style="flex: 1; cursor: pointer;">
                            <strong>${shop.name}</strong>
                            <span style="color: #666; font-size: 0.9em;"> - ${area ? area.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                        </label>
                    </div>
                `;
            }).join('');
            
            updateBulkEditCount();
        };
        
        // Select all shops for edit
        window.selectAllShopsForEdit = function() {
            document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateBulkEditCount();
        };
        
        // Deselect all shops for edit
        window.deselectAllShopsForEdit = function() {
            document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateBulkEditCount();
        };
        
        // Update bulk edit count
        window.updateBulkEditCount = function() {
            const count = document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]:checked').length;
            document.getElementById('bulkEditSelectedCount').textContent = count;
        };
        
        // Apply bulk edit
        window.applyBulkEdit = async function() {
            const selectedShopIds = Array.from(document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedShopIds.length === 0) {
                alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿØ ŸÖÿ≠ŸÑ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                return;
            }
            
            const newAreaId = document.getElementById('bulkEditNewArea').value;
            const prefix = document.getElementById('bulkEditPrefix').value.trim();
            const suffix = document.getElementById('bulkEditSuffix').value.trim();
            
            if (!newAreaId && !prefix && !suffix) {
                alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿØ ÿπŸÖŸÑŸäÿ© ÿ™ÿπÿØŸäŸÑ Ÿàÿßÿ≠ÿØÿ© ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                return;
            }
            
            if (!githubToken) {
                alert('‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            
            if (!confirm(`üîÑ ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿπÿØŸäŸÑ ${selectedShopIds.length} ŸÖÿ≠ŸÑÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÅŸä GitHub.`)) {
                return;
            }
            
            const statusDiv = document.getElementById('bulkEditStatus');
            statusDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; border: 2px solid #bee5eb;">‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿπÿØŸäŸÑ...</div>';
            
            try {
                let editedCount = 0;
                
                planData.shops.forEach(shop => {
                    if (selectedShopIds.includes(shop.id)) {
                        if (newAreaId) {
                            shop.areaId = newAreaId;
                        }
                        if (prefix) {
                            shop.name = prefix + shop.name;
                        }
                        if (suffix) {
                            shop.name = shop.name + suffix;
                        }
                        editedCount++;
                    }
                });
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; border: 2px solid #c3e6cb;">
                        ‚úÖ ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ${editedCount} ŸÖÿ≠ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('bulkEditModal').remove();
                    displayShopsList();
                    alert(`‚úÖ ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ${editedCount} ŸÖÿ≠ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!`);
                }, 2000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑ: ${error.message}</div>`;
            }
        };
        
        // Bulk Delete Shops - FULL IMPLEMENTATION
        async function bulkDeleteShops() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÑÿ≠ÿ∞ŸÅ');
                return;
            }
            
            // Create modal for bulk delete
            const modal = document.createElement('div');
            modal.id = 'bulkDeleteModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">üóëÔ∏è ÿßŸÑÿ≠ÿ∞ŸÅ ÿßŸÑÿ¨ŸÖÿßÿπŸä ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™</h2>
                        <button onclick="document.getElementById('bulkDeleteModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">√ó</button>
                    </div>
                    
                    <!-- Warning -->
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 10px 0;">‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ± ŸáÿßŸÖ</h3>
                        <p style="margin: 0;">ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ≠ÿ∞ŸÅ ŸÜŸáÿßÿ¶Ÿäÿ© ŸàŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸáÿß. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ.</p>
                    </div>
                    
                    <!-- Selection Section -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                            <button onclick="selectAllShopsForDelete()" style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                ‚òëÔ∏è ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ
                            </button>
                            <button onclick="deselectAllShopsForDelete()" style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                ‚òê ÿ•ŸÑÿ∫ÿßÿ° ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ
                            </button>
                            <select id="bulkDeleteAreaFilter" onchange="filterShopsForBulkDelete()" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                                <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>
                            </select>
                        </div>
                        <div id="bulkDeleteShopsList" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    
                    <!-- Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #dc3545 0%, #c0392b 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="bulkDeleteSelectedCount">0</div>
                            <div style="font-size: 0.9em;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ© ŸÑŸÑÿ≠ÿ∞ŸÅ</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="applyBulkDelete()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            üóëÔ∏è ÿ≠ÿ∞ŸÅ ŸÜŸáÿßÿ¶Ÿä
                        </button>
                        <button onclick="document.getElementById('bulkDeleteModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ‚ùå ÿ•ŸÑÿ∫ÿßÿ°
                        </button>
                    </div>
                    
                    <div id="bulkDeleteStatus" style="margin-top: 20px;"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate area filter
            const areaFilter = document.getElementById('bulkDeleteAreaFilter');
            if (planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    areaFilter.appendChild(option);
                });
            }
            
            // Initialize shops list
            filterShopsForBulkDelete();
        }
        
        // Filter shops for bulk delete
        window.filterShopsForBulkDelete = function() {
            const filterAreaId = document.getElementById('bulkDeleteAreaFilter').value;
            const shopsList = document.getElementById('bulkDeleteShopsList');
            
            let shopsToShow = planData.shops;
            if (filterAreaId) {
                shopsToShow = shopsToShow.filter(s => s.areaId === filterAreaId);
            }
            
            shopsList.innerHTML = shopsToShow.map(shop => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #e0e0e0;">
                        <input type="checkbox" id="delshop_${shop.id}" value="${shop.id}" onchange="updateBulkDeleteCount()" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="delshop_${shop.id}" style="flex: 1; cursor: pointer;">
                            <strong>${shop.name}</strong>
                            <span style="color: #666; font-size: 0.9em;"> - ${area ? area.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                        </label>
                    </div>
                `;
            }).join('');
            
            updateBulkDeleteCount();
        };
        
        // Select all shops for delete
        window.selectAllShopsForDelete = function() {
            document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateBulkDeleteCount();
        };
        
        // Deselect all shops for delete
        window.deselectAllShopsForDelete = function() {
            document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateBulkDeleteCount();
        };
        
        // Update bulk delete count
        window.updateBulkDeleteCount = function() {
            const count = document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]:checked').length;
            document.getElementById('bulkDeleteSelectedCount').textContent = count;
        };
        
        // Apply bulk delete
        window.applyBulkDelete = async function() {
            const selectedShopIds = Array.from(document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedShopIds.length === 0) {
                alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿØ ŸÖÿ≠ŸÑ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ ŸÑŸÑÿ≠ÿ∞ŸÅ');
                return;
            }
            
            if (!githubToken) {
                alert('‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ™ŸÖÿßŸÖÿßŸã ŸÖŸÜ ÿ≠ÿ∞ŸÅ ${selectedShopIds.length} ŸÖÿ≠ŸÑ ŸÜŸáÿßÿ¶ŸäÿßŸãÿü\n\nŸáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸáÿß!\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÅŸä GitHub.`)) {
                return;
            }
            
            const statusDiv = document.getElementById('bulkDeleteStatus');
            statusDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; border: 2px solid #bee5eb;">‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ÿ∞ŸÅ...</div>';
            
            try {
                const initialCount = planData.shops.length;
                planData.shops = planData.shops.filter(shop => !selectedShopIds.includes(shop.id));
                const deletedCount = initialCount - planData.shops.length;
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; border: 2px solid #c3e6cb;">
                        ‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${deletedCount} ŸÖÿ≠ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('bulkDeleteModal').remove();
                    displayShopsList();
                    alert(`‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${deletedCount} ŸÖÿ≠ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!`);
                }, 2000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿ∞ŸÅ: ${error.message}</div>`;
            }
        };
        
        
        // Merge Shops Data - FULL IMPLEMENTATION
        async function mergeShopsData() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÑÿØŸÖÿ¨');
                return;
            }
            
            // Create modal for merge operation
            const modal = document.createElement('div');
            modal.id = 'mergeModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">üîó ÿØŸÖÿ¨ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</h2>
                        <button onclick="document.getElementById('mergeModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">√ó</button>
                    </div>
                    
                    <!-- Merge Options -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 15px 0;">‚öôÔ∏è ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿØŸÖÿ¨</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="duplicates" checked onchange="updateMergePreview()">
                                <span>ÿØŸÖÿ¨ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ© ŸÅŸÇÿ∑</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="similar" onchange="updateMergePreview()">
                                <span>ÿØŸÖÿ¨ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿ¥ÿßÿ®Ÿáÿ©</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="fromFile" onchange="updateMergePreview()">
                                <span>ÿØŸÖÿ¨ ŸÖŸÜ ŸÖŸÑŸÅ ÿÆÿßÿ±ÿ¨Ÿä</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- File Upload for External Merge -->
                    <div id="fileUploadSection" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">üì• ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÑŸÅ ŸÑŸÑÿØŸÖÿ¨</h3>
                        <input type="file" id="mergeFileInput" accept=".json" onchange="loadMergeFile(this)" style="padding: 10px; border: 2px solid #667eea; border-radius: 8px; width: 100%; font-family: 'Cairo', sans-serif;">
                        <p style="color: #666; margin-top: 10px; font-size: 0.9em;">ŸÇŸÖ ÿ®ÿ±ŸÅÿπ ŸÖŸÑŸÅ JSON Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÑÿØŸÖÿ¨</p>
                    </div>
                    
                    <!-- Merge Preview -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">üëÅÔ∏è ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿØŸÖÿ¨</h3>
                        <div id="mergePreviewContent">
                            <p style="text-align: center; color: #999;">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</p>
                        </div>
                    </div>
                    
                    <!-- Merge Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mergeCurrentCount">0</div>
                            <div style="font-size: 0.9em;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mergeDuplicatesCount">0</div>
                            <div style="font-size: 0.9em;">ÿßŸÑŸÖŸÉÿ±ÿ±ÿßÿ™ ÿßŸÑŸÖŸÉÿ™ÿ¥ŸÅÿ©</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mergeAfterCount">0</div>
                            <div style="font-size: 0.9em;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ®ÿπÿØ ÿßŸÑÿØŸÖÿ¨</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="performMerge()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ‚úÖ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿØŸÖÿ¨
                        </button>
                        <button onclick="document.getElementById('mergeModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ‚ùå ÿ•ŸÑÿ∫ÿßÿ°
                        </button>
                    </div>
                    
                    <div id="mergeStatus" style="margin-top: 20px;"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initial preview update
            setTimeout(() => updateMergePreview(), 100);
        }
        
        // Update merge preview based on selected mode
        window.updateMergePreview = function() {
            const mode = document.querySelector('input[name="mergeMode"]:checked').value;
            const fileUploadSection = document.getElementById('fileUploadSection');
            const previewContent = document.getElementById('mergePreviewContent');
            
            // Show/hide file upload section
            fileUploadSection.style.display = mode === 'fromFile' ? 'block' : 'none';
            
            // Update stats
            document.getElementById('mergeCurrentCount').textContent = planData.shops.length;
            
            if (mode === 'duplicates') {
                findDuplicates(previewContent);
            } else if (mode === 'similar') {
                findSimilar(previewContent);
            } else if (mode === 'fromFile') {
                previewContent.innerHTML = '<p style="text-align: center; color: #999;">ŸÇŸÖ ÿ®ÿ±ŸÅÿπ ŸÖŸÑŸÅ JSON ŸÑŸÑŸÖÿπÿßŸäŸÜÿ©</p>';
                document.getElementById('mergeDuplicatesCount').textContent = '0';
                document.getElementById('mergeAfterCount').textContent = planData.shops.length;
            }
        };
        
        // Find duplicate shops
        function findDuplicates(container) {
            const duplicates = [];
            const nameMap = {};
            
            planData.shops.forEach((shop, index) => {
                const normalizedName = shop.name.trim().toLowerCase();
                if (nameMap[normalizedName]) {
                    duplicates.push({
                        original: nameMap[normalizedName],
                        duplicate: shop,
                        index: index
                    });
                } else {
                    nameMap[normalizedName] = shop;
                }
            });
            
            document.getElementById('mergeDuplicatesCount').textContent = duplicates.length;
            document.getElementById('mergeAfterCount').textContent = planData.shops.length - duplicates.length;
            
            if (duplicates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #11998e;">
                        <div style="font-size: 3em; margin-bottom: 10px;">‚úÖ</div>
                        <p style="font-size: 1.2em; font-weight: 600;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÉÿ±ÿ±ÿ©!</p>
                        <p style="color: #666;">ÿ¨ŸÖŸäÿπ ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÅÿ±ŸäÿØÿ© ŸàŸÖŸÜÿ∏ŸÖÿ©.</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea; color: white; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 10px; text-align: right;">ÿßŸÑŸÖÿ≠ŸÑ ÿßŸÑÿ£ÿµŸÑŸä</th>
                                    <th style="padding: 10px; text-align: right;">ÿßŸÑŸÖÿ≠ŸÑ ÿßŸÑŸÖŸÉÿ±ÿ±</th>
                                    <th style="padding: 10px; text-align: right;">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${duplicates.map(dup => {
                                    const origArea = planData.areas.find(a => a.id === dup.original.areaId);
                                    const dupArea = planData.areas.find(a => a.id === dup.duplicate.areaId);
                                    return `
                                        <tr style="border-bottom: 1px solid #e0e0e0;">
                                            <td style="padding: 10px;">${dup.original.name}</td>
                                            <td style="padding: 10px; color: #dc3545;">${dup.duplicate.name}</td>
                                            <td style="padding: 10px;">${origArea ? origArea.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'} / ${dupArea ? dupArea.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                        üí° ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿßŸÑŸÖÿ≠ŸÑ ÿßŸÑÿ£ŸàŸÑ Ÿàÿ≠ÿ∞ŸÅ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©
                    </p>
                `;
            }
            
            // Store duplicates for later use
            window.currentDuplicates = duplicates;
        }
        
        // Find similar shops (with fuzzy matching)
        function findSimilar(container) {
            const similar = [];
            const shops = planData.shops;
            
            for (let i = 0; i < shops.length; i++) {
                for (let j = i + 1; j < shops.length; j++) {
                    const similarity = calculateSimilarity(shops[i].name, shops[j].name);
                    if (similarity > 0.7) { // 70% similarity threshold
                        similar.push({
                            shop1: shops[i],
                            shop2: shops[j],
                            similarity: similarity
                        });
                    }
                }
            }
            
            document.getElementById('mergeDuplicatesCount').textContent = similar.length;
            document.getElementById('mergeAfterCount').textContent = planData.shops.length - similar.length;
            
            if (similar.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #11998e;">
                        <div style="font-size: 3em; margin-bottom: 10px;">‚úÖ</div>
                        <p style="font-size: 1.2em; font-weight: 600;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ™ÿ¥ÿßÿ®Ÿáÿ©!</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea; color: white; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 10px; text-align: right;">ÿßŸÑŸÖÿ≠ŸÑ 1</th>
                                    <th style="padding: 10px; text-align: right;">ÿßŸÑŸÖÿ≠ŸÑ 2</th>
                                    <th style="padding: 10px; text-align: right;">ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ™ÿ¥ÿßÿ®Ÿá</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${similar.map(sim => `
                                    <tr style="border-bottom: 1px solid #e0e0e0;">
                                        <td style="padding: 10px;">${sim.shop1.name}</td>
                                        <td style="padding: 10px;">${sim.shop2.name}</td>
                                        <td style="padding: 10px; color: #ffc107;">${Math.round(sim.similarity * 100)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            window.currentSimilar = similar;
        }
        
        // Calculate string similarity (Levenshtein distance)
        function calculateSimilarity(str1, str2) {
            const s1 = str1.toLowerCase().trim();
            const s2 = str2.toLowerCase().trim();
            
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }
        
        // Levenshtein distance algorithm
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        // Load merge file
        window.loadMergeFile = function(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileData = JSON.parse(e.target.result);
                    
                    // Validate file format
                    if (!Array.isArray(fileData) && !fileData.shops) {
                        throw new Error('ÿµŸäÿ∫ÿ© ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                    }
                    
                    const externalShops = Array.isArray(fileData) ? fileData : fileData.shops;
                    window.externalShopsToMerge = externalShops;
                    
                    // Update preview
                    const previewContent = document.getElementById('mergePreviewContent');
                    previewContent.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #11998e;">
                            <div style="font-size: 3em; margin-bottom: 10px;">üì•</div>
                            <p style="font-size: 1.2em; font-weight: 600;">ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${externalShops.length} ŸÖÿ≠ŸÑ ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ</p>
                            <p style="color: #666;">ÿ≥Ÿäÿ™ŸÖ ÿØŸÖÿ¨ Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖÿπ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©</p>
                        </div>
                    `;
                    
                    document.getElementById('mergeDuplicatesCount').textContent = externalShops.length;
                    document.getElementById('mergeAfterCount').textContent = planData.shops.length + externalShops.length;
                    
                } catch (error) {
                    alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ: ' + error.message);
                }
            };
            reader.readAsText(file);
        };
        
        // Perform merge operation
        window.performMerge = async function() {
            const mode = document.querySelector('input[name="mergeMode"]:checked').value;
            const statusDiv = document.getElementById('mergeStatus');
            
            if (!githubToken) {
                statusDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã</div>';
                return;
            }
            
            if (!confirm('üîó ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ŸÜŸÅŸäÿ∞ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿØŸÖÿ¨ÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÅŸä GitHub.')) {
                return;
            }
            
            statusDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; border: 2px solid #bee5eb;">‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ŸÜŸÅŸäÿ∞ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿØŸÖÿ¨...</div>';
            
            try {
                let mergedShops = [...planData.shops];
                let removedCount = 0;
                let addedCount = 0;
                
                if (mode === 'duplicates') {
                    // Remove duplicates
                    if (window.currentDuplicates && window.currentDuplicates.length > 0) {
                        const duplicateIndices = window.currentDuplicates.map(d => d.index);
                        mergedShops = planData.shops.filter((shop, index) => !duplicateIndices.includes(index));
                        removedCount = window.currentDuplicates.length;
                    }
                } else if (mode === 'similar') {
                    // Remove similar shops (keep first occurrence)
                    if (window.currentSimilar && window.currentSimilar.length > 0) {
                        const toRemove = new Set();
                        window.currentSimilar.forEach(sim => {
                            const idx2 = planData.shops.indexOf(sim.shop2);
                            toRemove.add(idx2);
                        });
                        mergedShops = planData.shops.filter((shop, index) => !toRemove.has(index));
                        removedCount = toRemove.size;
                    }
                } else if (mode === 'fromFile') {
                    // Merge external shops
                    if (window.externalShopsToMerge && window.externalShopsToMerge.length > 0) {
                        window.externalShopsToMerge.forEach(extShop => {
                            // Check if shop already exists
                            const exists = mergedShops.some(s => 
                                s.name.toLowerCase().trim() === extShop.name.toLowerCase().trim()
                            );
                            
                            if (!exists) {
                                mergedShops.push({
                                    id: extShop.id || 'shop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                    name: extShop.name,
                                    areaId: extShop.areaId || ''
                                });
                                addedCount++;
                            }
                        });
                    }
                }
                
                // Update plan data
                planData.shops = mergedShops;
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; border: 2px solid #c3e6cb;">
                        ‚úÖ ÿ™ŸÖ ÿßŸÑÿØŸÖÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠!<br>
                        ${removedCount > 0 ? `üóëÔ∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${removedCount} ŸÖÿ≠ŸÑ ŸÖŸÉÿ±ÿ±<br>` : ''}
                        ${addedCount > 0 ? `‚ûï ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${addedCount} ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ<br>` : ''}
                        üìä ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ¢ŸÜ: ${mergedShops.length}
                    </div>
                `;
                
                // Refresh shops list
                setTimeout(() => {
                    document.getElementById('mergeModal').remove();
                    displayShopsList();
                    alert(`‚úÖ ÿ™ŸÖ ÿØŸÖÿ¨ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!\n\n${removedCount > 0 ? `ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${removedCount} ŸÖÿ≠ŸÑ ŸÖŸÉÿ±ÿ±\n` : ''}${addedCount > 0 ? `ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${addedCount} ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ\n` : ''}ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™: ${mergedShops.length}`);
                }, 2000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿØŸÖÿ¨: ${error.message}</div>`;
            }
        };
        
        
        // Validate Shops Data
        function validateShopsData() {
            if (!planData || !planData.shops) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜŸáÿß');
                return;
            }
            
            const issues = [];
            planData.shops.forEach((shop, idx) => {
                if (!shop.name) issues.push(`ŸÖÿ≠ŸÑ ${idx + 1}: ÿßÿ≥ŸÖ ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ`);
                if (!shop.areaId) issues.push(`${shop.name}: ŸÖŸÜÿ∑ŸÇÿ© ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØÿ©`);
            });
            
            if (issues.length === 0) {
                alert('‚úÖ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿµÿ≠Ÿäÿ≠ÿ©!\n\n' +
                      `üìä ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™: ${planData.shops.length}`);
            } else {
                alert(`‚ö†Ô∏è ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${issues.length} ŸÖÿ¥ŸÉŸÑÿ©:\n\n` + 
                      issues.slice(0, 10).join('\n') +
                      (issues.length > 10 ? `\n\n... Ÿà ${issues.length - 10} ŸÖÿ¥ŸÉŸÑÿ© ÿ£ÿÆÿ±Ÿâ` : ''));
            }
        }
        
        // View Shops on Map - INTERACTIVE AND HEATMAP IMPLEMENTATION
        async function viewShopsOnMap() {
            // Load shops details if not already loaded
            if (!shopsDetails) {
                try {
                    // Cache-busting parameter ensures users always get latest data after updates
                    const response = await fetch('shops_details.json?v=' + new Date().getTime());
                    shopsDetails = await response.json();
                } catch (error) {
                    console.error('Error loading shops_details.json:', error);
                }
            }
            
            // Clear cached array when reloading shopsDetails
            window.cachedAllShopsArray = null;
            window.cachedUniqueAreas = null;
            
            if (!shopsDetails || Object.keys(shopsDetails).length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÑÿπÿ±ÿ∂Ÿáÿß ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©');
                return;
            }
            
            // Create modal for map
            const modal = document.createElement('div');
            modal.id = 'mapModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 95%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">üó∫Ô∏è ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿßŸÑÿ™ŸÅÿßÿπŸÑŸäÿ© ŸàÿßŸÑÿ≠ÿ±ÿßÿ±Ÿäÿ© ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™</h2>
                        <button onclick="document.getElementById('mapModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">√ó</button>
                    </div>
                    
                    <!-- Map Controls -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <select id="mapViewMode" onchange="updateMapView()" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            <option value="interactive">üìç ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿπŸÑŸä</option>
                            <option value="heatmap">üî• ÿÆÿ±Ÿäÿ∑ÿ© ÿ≠ÿ±ÿßÿ±Ÿäÿ©</option>
                            <option value="cluster">üéØ ÿπÿ±ÿ∂ ŸÖÿ¨ŸÖŸàÿπÿßÿ™</option>
                        </select>
                        <select id="mapFilterArea" onchange="updateMapView()" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>
                        </select>
                        <button onclick="toggleHeatmapIntensity()" style="padding: 10px 20px; border-radius: 8px; border: none; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                            üå°Ô∏è ÿ™ÿ®ÿØŸäŸÑ ŸÉÿ´ÿßŸÅÿ© ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ©
                        </button>
                        <button onclick="exportMapData()" style="padding: 10px 20px; border-radius: 8px; border: none; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                            üì• ÿ™ÿµÿØŸäÿ± ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©
                        </button>
                    </div>
                    
                    <!-- Map Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mapTotalShops">0</div>
                            <div style="font-size: 0.9em;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mapVisibleShops">0</div>
                            <div style="font-size: 0.9em;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ÿ©</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mapAreasCount">0</div>
                            <div style="font-size: 0.9em;">ÿπÿØÿØ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</div>
                        </div>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="shopsMapContainer" style="background: #f5f5f5; border-radius: 10px; padding: 20px; min-height: 500px; position: relative;">
                        <div id="mapLegend" style="position: absolute; top: 10px; right: 10px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100;">
                            <h4 style="margin: 0 0 10px 0; color: #2d3561;">ŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©</h4>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 20px; background: #667eea; border-radius: 50%;"></div>
                                    <span>ŸÖÿ≠ŸÑ ÿπÿßÿØŸä</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 20px; background: #dc3545; border-radius: 50%;"></div>
                                    <span>ÿ£ŸàŸÑŸàŸäÿ© ÿπÿßŸÑŸäÿ©</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 20px; background: #ffc107; border-radius: 50%;"></div>
                                    <span>ÿ£ŸàŸÑŸàŸäÿ© ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©</span>
                                </div>
                            </div>
                        </div>
                        <div id="mapCanvas" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 20px;">
                            <!-- Map items will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Shop Details Panel -->
                    <div id="shopDetailsPanel" style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px; display: none;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ ÿßŸÑŸÖÿ≠ÿØÿØ</h3>
                        <div id="shopDetailsContent"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate area filter with all unique areas from shopsDetails
            const areaFilter = document.getElementById('mapFilterArea');
            const uniqueAreas = new Set();
            
            // Get areas from shopsDetails
            if (shopsDetails) {
                Object.values(shopsDetails).forEach(shop => {
                    if (shop.area && shop.area !== 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ') {
                        uniqueAreas.add(shop.area);
                    }
                });
            }
            
            // Add areas from planData if available
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    uniqueAreas.add(area.name);
                });
            }
            
            // Sort and add to filter
            Array.from(uniqueAreas).sort().forEach((areaName, index) => {
                const option = document.createElement('option');
                option.value = areaName; // Use area name instead of ID for filtering
                option.textContent = areaName;
                areaFilter.appendChild(option);
            });
            
            // Initial map render
            updateMapView();
        }
        
        // Update map view based on selected mode
        window.updateMapView = function() {
            const mode = document.getElementById('mapViewMode').value;
            const filterAreaName = document.getElementById('mapFilterArea').value;
            const mapCanvas = document.getElementById('mapCanvas');
            
            // Convert shopsDetails object to array format (cache this in a global variable)
            if (!window.cachedAllShopsArray) {
                window.cachedAllShopsArray = [];
                window.cachedUniqueAreas = new Set();
                
                if (shopsDetails) {
                    // Create area lookup map for better performance
                    const areaLookup = new Map();
                    if (planData && planData.areas) {
                        planData.areas.forEach(area => {
                            areaLookup.set(area.name, area);
                        });
                    }
                    
                    Object.entries(shopsDetails).forEach(([shopName, shopData]) => {
                        const area = areaLookup.get(shopData.area);
                        const areaName = shopData.area || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                        
                        window.cachedAllShopsArray.push({
                            name: shopName,
                            areaId: area ? area.id : null,
                            areaName: areaName,
                            ...shopData
                        });
                        
                        if (areaName && areaName !== 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ') {
                            window.cachedUniqueAreas.add(areaName);
                        }
                    });
                }
            }
            
            const allShopsArray = window.cachedAllShopsArray;
            const uniqueAreas = window.cachedUniqueAreas;
            
            // Filter shops by area name
            let shopsToDisplay = allShopsArray;
            if (filterAreaName) {
                shopsToDisplay = shopsToDisplay.filter(s => s.areaName === filterAreaName);
            }
            
            // Update stats
            document.getElementById('mapTotalShops').textContent = allShopsArray.length;
            document.getElementById('mapVisibleShops').textContent = shopsToDisplay.length;
            document.getElementById('mapAreasCount').textContent = uniqueAreas.size;
            
            // Clear canvas
            mapCanvas.innerHTML = '';
            
            if (mode === 'interactive') {
                renderInteractiveMap(shopsToDisplay, mapCanvas);
            } else if (mode === 'heatmap') {
                renderHeatmap(shopsToDisplay, mapCanvas);
            } else if (mode === 'cluster') {
                renderClusterMap(shopsToDisplay, mapCanvas);
            }
        };
        
        // Render interactive map
        function renderInteractiveMap(shops, container) {
            shops.forEach((shop, index) => {
                // Use areaName directly from shop data
                const areaName = shop.areaName || shop.area || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                
                // Calculate priority color
                let color = '#667eea';
                let priorityLabel = 'ÿπÿßÿØŸä';
                
                // Check if shop has high priority based on last inspection
                const lastInspection = planData.inspectionData ? 
                    planData.inspectionData.filter(i => i.shops && i.shops.includes(shop.name))
                    .sort((a, b) => new Date(b.day) - new Date(a.day))[0] : null;
                
                if (lastInspection) {
                    const daysSince = Math.floor((new Date() - new Date(lastInspection.day)) / (1000 * 60 * 60 * 24));
                    if (daysSince > 30) {
                        color = '#dc3545';
                        priorityLabel = 'ÿπÿßŸÑŸäÿ©';
                    } else if (daysSince > 14) {
                        color = '#ffc107';
                        priorityLabel = 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©';
                    }
                }
                
                const shopCard = document.createElement('div');
                shopCard.style.cssText = `
                    background: white;
                    padding: 15px;
                    border-radius: 10px;
                    border: 3px solid ${color};
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                `;
                shopCard.onmouseover = function() {
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
                };
                shopCard.onmouseout = function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                };
                shopCard.onclick = function() {
                    showShopDetails(shop, lastInspection);
                };
                
                shopCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #2d3561; font-size: 1.1em;">${shop.name}</h4>
                        <span style="background: ${color}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75em;">${priorityLabel}</span>
                    </div>
                    <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">üìç ${areaName}</div>
                    <div style="color: #999; font-size: 0.85em;">
                        ${lastInspection ? `ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥: ${new Date(lastInspection.day).toLocaleDateString('ar-EG')}` : 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿ®ÿπÿØ'}
                    </div>
                `;
                
                container.appendChild(shopCard);
            });
        }
        
        // Render heatmap
        function renderHeatmap(shops, container) {
            // Group shops by area
            const areaGroups = {};
            shops.forEach(shop => {
                // Use areaName directly from shop data
                const areaName = shop.areaName || shop.area || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                if (!areaGroups[areaName]) {
                    areaGroups[areaName] = [];
                }
                areaGroups[areaName].push(shop);
            });
            
            // Find max count for heat intensity
            const maxCount = Math.max(...Object.values(areaGroups).map(g => g.length));
            
            // Render heat blocks
            Object.entries(areaGroups).forEach(([areaName, areaShops]) => {
                const intensity = areaShops.length / maxCount;
                const heatColor = getHeatColor(intensity);
                
                const heatBlock = document.createElement('div');
                heatBlock.style.cssText = `
                    background: ${heatColor};
                    padding: 20px;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                    min-height: 150px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    text-align: center;
                `;
                heatBlock.onmouseover = function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
                };
                heatBlock.onmouseout = function() {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                };
                
                heatBlock.innerHTML = `
                    <h3 style="margin: 0 0 15px 0; color: white; font-size: 1.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">${areaName}</h3>
                    <div style="font-size: 3em; font-weight: 700; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">${areaShops.length}</div>
                    <div style="color: white; font-size: 1em; margin-top: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">ŸÖÿ≠ŸÑ</div>
                    <div style="margin-top: 10px; color: white; font-size: 0.9em;">üî• ŸÉÿ´ÿßŸÅÿ©: ${Math.round(intensity * 100)}%</div>
                `;
                
                container.appendChild(heatBlock);
            });
        }
        
        // Render cluster map
        function renderClusterMap(shops, container) {
            // Similar to heatmap but with different visualization
            const areaGroups = {};
            shops.forEach(shop => {
                // Use areaName directly from shop data
                const areaName = shop.areaName || shop.area || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                if (!areaGroups[areaName]) {
                    areaGroups[areaName] = [];
                }
                areaGroups[areaName].push(shop);
            });
            
            Object.entries(areaGroups).forEach(([areaName, areaShops]) => {
                const clusterDiv = document.createElement('div');
                clusterDiv.style.cssText = `
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 20px;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                `;
                
                clusterDiv.innerHTML = `
                    <h3 style="margin: 0 0 15px 0; color: white;">${areaName}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 5px;">
                        ${areaShops.map((shop, idx) => `
                            <div style="width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; color: #667eea; font-weight: 700;" title="${shop.name}">
                                ${idx + 1}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(clusterDiv);
            });
        }
        
        // Get heat color based on intensity
        function getHeatColor(intensity) {
            const colors = [
                '#38ef7d',  // Low (green)
                '#11998e',  // Medium-low (teal)
                '#ffc107',  // Medium (yellow)
                '#fa709a',  // Medium-high (pink)
                '#dc3545'   // High (red)
            ];
            const index = Math.min(Math.floor(intensity * colors.length), colors.length - 1);
            return colors[index];
        }
        
        // Show shop details
        window.showShopDetails = function(shop, lastInspection) {
            const panel = document.getElementById('shopDetailsPanel');
            const content = document.getElementById('shopDetailsContent');
            const area = planData.areas.find(a => a.id === shop.areaId);
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <strong style="color: #667eea;">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ:</strong><br>
                        <span>${shop.name}</span>
                    </div>
                    <div>
                        <strong style="color: #667eea;">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:</strong><br>
                        <span>${area ? area.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</span>
                    </div>
                    <div>
                        <strong style="color: #667eea;">ÿßŸÑŸÖÿπÿ±ŸÅ:</strong><br>
                        <span style="font-family: monospace;">${shop.id}</span>
                    </div>
                    ${lastInspection ? `
                        <div>
                            <strong style="color: #667eea;">ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥:</strong><br>
                            <span>${new Date(lastInspection.day).toLocaleDateString('ar-EG')}</span>
                        </div>
                        <div>
                            <strong style="color: #667eea;">ÿßŸÑŸÖŸÅÿ™ÿ¥:</strong><br>
                            <span>${lastInspection.inspector}</span>
                        </div>
                    ` : ''}
                </div>
            `;
            
            panel.style.display = 'block';
        };
        
        // Toggle heatmap intensity
        window.toggleHeatmapIntensity = function() {
            alert('üå°Ô∏è ÿ™ŸÖ ÿ™ÿ®ÿØŸäŸÑ ŸÉÿ´ÿßŸÅÿ© ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ©!\n\nÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿßŸÑÿ≠ÿ±ÿßÿ±Ÿäÿ© ÿ™ÿπÿ±ÿ∂ ÿßŸÑÿ¢ŸÜ ŸÉÿ´ÿßŸÅÿßÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ© ÿ≠ÿ≥ÿ® ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÅŸä ŸÉŸÑ ŸÖŸÜÿ∑ŸÇÿ©.');
            updateMapView();
        };
        
        // Export map data
        window.exportMapData = function() {
            const mode = document.getElementById('mapViewMode').value;
            const filterAreaId = document.getElementById('mapFilterArea').value;
            
            let shopsToExport = planData.shops || [];
            if (filterAreaId) {
                shopsToExport = shopsToExport.filter(s => s.areaId === filterAreaId);
            }
            
            const exportData = {
                exportDate: new Date().toISOString(),
                mode: mode,
                totalShops: shopsToExport.length,
                shops: shopsToExport.map(shop => {
                    const area = planData.areas.find(a => a.id === shop.areaId);
                    return {
                        name: shop.name,
                        area: area ? area.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
                        id: shop.id
                    };
                })
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `map-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${shopsToExport.length} ŸÖÿ≠ŸÑ ŸÖŸÜ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!`);
        };
        
        
        // ============================================
        // MERGE AREAS FUNCTIONS
        // ============================================
        
        // Open merge areas modal
        function mergeAreas() {
            if (!planData || !planData.areas || planData.areas.length < 2) {
                alert('‚ö†Ô∏è Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ŸÑÿØŸäŸÉ ŸÖŸÜÿ∑ŸÇÿ™ŸäŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ ŸÑŸÑÿØŸÖÿ¨');
                return;
            }
            
            // Populate target area dropdown
            const targetSelect = document.getElementById('mergeTargetArea');
            targetSelect.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© --</option>';
            planData.areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.name;
                targetSelect.appendChild(option);
            });
            
            // Populate source areas checkboxes
            const container = document.getElementById('mergeSourceAreasContainer');
            container.innerHTML = '';
            planData.areas.forEach(area => {
                const shopsCount = planData.shops.filter(s => s.areaId === area.id).length;
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.padding = '8px';
                label.style.cursor = 'pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${area.id}" class="merge-source-checkbox" style="margin-left: 10px;">
                    ${area.name} (${shopsCount} ŸÖÿ≠ŸÑ)
                `;
                container.appendChild(label);
            });
            
            document.getElementById('mergeAreasModal').style.display = 'block';
            document.getElementById('mergeAreasStatus').innerHTML = '';
        }
        
        // Close merge areas modal
        function closeMergeAreasModal() {
            document.getElementById('mergeAreasModal').style.display = 'none';
        }
        
        // Execute merge areas
        async function executeMergeAreas() {
            const targetAreaId = document.getElementById('mergeTargetArea').value;
            const checkboxes = document.querySelectorAll('.merge-source-checkbox:checked');
            const sourceAreaIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (!targetAreaId) {
                showMessage('mergeAreasStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©');
                return;
            }
            
            if (sourceAreaIds.length === 0) {
                showMessage('mergeAreasStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÜÿ∑ŸÇÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ ŸÑŸÑÿØŸÖÿ¨');
                return;
            }
            
            if (sourceAreaIds.includes(targetAreaId)) {
                showMessage('mergeAreasStatus', 'error', '‚ùå ŸÑÿß ŸäŸÖŸÉŸÜ ÿØŸÖÿ¨ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÅŸä ŸÜŸÅÿ≥Ÿáÿß');
                return;
            }
            
            const targetArea = planData.areas.find(a => a.id === targetAreaId);
            const sourceAreas = planData.areas.filter(a => sourceAreaIds.includes(a.id));
            const sourceAreasNames = sourceAreas.map(a => a.name).join('ÿå ');
            
            if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿØŸÖÿ¨ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ:\n${sourceAreasNames}\n\nŸÅŸä ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: ${targetArea.name}ÿü\n\nÿ≥Ÿäÿ™ŸÖ ŸÜŸÇŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ Ÿàÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿØŸÖÿ¨ÿ©.`)) {
                return;
            }
            
            showMessage('mergeAreasStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿØŸÖÿ¨ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ...');
            
            try {
                // Move all shops from source areas to target area
                let movedShopsCount = 0;
                planData.shops.forEach(shop => {
                    if (sourceAreaIds.includes(shop.areaId)) {
                        shop.areaId = targetAreaId;
                        movedShopsCount++;
                    }
                });
                
                // Update inspections data
                let updatedInspections = 0;
                if (planData.inspectionData) {
                    planData.inspectionData.forEach(inspection => {
                        const sourceArea = sourceAreas.find(a => a.name === inspection.area);
                        if (sourceArea) {
                            inspection.area = targetArea.name;
                            updatedInspections++;
                        }
                    });
                }
                
                // Remove source areas
                planData.areas = planData.areas.filter(a => !sourceAreaIds.includes(a.id));
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('mergeAreasStatus', 'success', 
                    `‚úÖ ÿ™ŸÖ ÿØŸÖÿ¨ ${sourceAreas.length} ŸÖŸÜÿ∑ŸÇÿ© ÿ®ŸÜÿ¨ÿßÿ≠!\n` +
                    `‚Ä¢ ÿ™ŸÖ ŸÜŸÇŸÑ ${movedShopsCount} ŸÖÿ≠ŸÑ\n` +
                    `‚Ä¢ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${updatedInspections} ÿ™ŸÅÿ™Ÿäÿ¥`);
                
                setTimeout(() => {
                    closeMergeAreasModal();
                    displayAreasList();
                    populateAreas();
                    populateShopAreaFilter();
                }, 2000);
                
            } catch (error) {
                showMessage('mergeAreasStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿØŸÖÿ¨ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ: ' + error.message);
            }
        }
        
        // ============================================
        // ASSIGN SHOPS TO AREAS FUNCTIONS
        // ============================================
        
        // Open assign shops modal
        function assignShopsToAreas() {
            if (!planData || !planData.areas || planData.areas.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿßÿ∑ŸÇ ŸÖÿ™ÿßÿ≠ÿ©');
                return;
            }
            
            if (!planData.shops || planData.shops.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©');
                return;
            }
            
            // Populate current area filter
            const currentAreaSelect = document.getElementById('assignShopsCurrentArea');
            currentAreaSelect.innerHTML = '<option value="">-- ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ --</option>';
            planData.areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.name;
                currentAreaSelect.appendChild(option);
            });
            
            // Populate target area dropdown
            const targetSelect = document.getElementById('assignShopsTargetArea');
            targetSelect.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© --</option>';
            planData.areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.name;
                targetSelect.appendChild(option);
            });
            
            // Load shops
            loadShopsForAssignment();
            
            document.getElementById('assignShopsModal').style.display = 'block';
            document.getElementById('assignShopsStatus').innerHTML = '';
        }
        
        // Close assign shops modal
        function closeAssignShopsModal() {
            document.getElementById('assignShopsModal').style.display = 'none';
        }
        
        // Load shops for assignment
        function loadShopsForAssignment() {
            const currentAreaId = document.getElementById('assignShopsCurrentArea').value;
            const container = document.getElementById('assignShopsContainer');
            
            let shopsToShow = planData.shops;
            if (currentAreaId) {
                shopsToShow = planData.shops.filter(s => s.areaId === currentAreaId);
            }
            
            container.innerHTML = '';
            if (shopsToShow.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™</p>';
                return;
            }
            
            shopsToShow.forEach(shop => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                const areaName = area ? area.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.padding = '8px';
                label.style.cursor = 'pointer';
                label.className = 'shop-assignment-label';
                label.innerHTML = `
                    <input type="checkbox" value="${shop.id}" class="assign-shop-checkbox" style="margin-left: 10px;">
                    ${shop.name} <span style="color: #999; font-size: 0.9em;">(${areaName})</span>
                `;
                container.appendChild(label);
            });
        }
        
        // Filter shops for assignment
        function filterShopsForAssignment() {
            const searchTerm = document.getElementById('searchShopsForAssignment').value.toLowerCase();
            const labels = document.querySelectorAll('.shop-assignment-label');
            
            labels.forEach(label => {
                const text = label.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    label.style.display = 'block';
                } else {
                    label.style.display = 'none';
                }
            });
        }
        
        // Select all shops for assignment
        function selectAllShopsForAssignment() {
            const checkboxes = document.querySelectorAll('.assign-shop-checkbox');
            checkboxes.forEach(cb => {
                if (cb.parentElement.style.display !== 'none') {
                    cb.checked = true;
                }
            });
        }
        
        // Deselect all shops for assignment
        function deselectAllShopsForAssignment() {
            const checkboxes = document.querySelectorAll('.assign-shop-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        // Execute assign shops
        async function executeAssignShops() {
            const targetAreaId = document.getElementById('assignShopsTargetArea').value;
            const checkboxes = document.querySelectorAll('.assign-shop-checkbox:checked');
            const shopIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (!targetAreaId) {
                showMessage('assignShopsStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©');
                return;
            }
            
            if (shopIds.length === 0) {
                showMessage('assignShopsStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿ≠ŸÑ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                return;
            }
            
            const targetArea = planData.areas.find(a => a.id === targetAreaId);
            
            if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÜŸÇŸÑ ${shopIds.length} ŸÖÿ≠ŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: ${targetArea.name}ÿü`)) {
                return;
            }
            
            showMessage('assignShopsStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™...');
            
            try {
                // Update shops area
                const updatedShops = [];
                planData.shops.forEach(shop => {
                    if (shopIds.includes(shop.id)) {
                        const oldArea = planData.areas.find(a => a.id === shop.areaId);
                        shop.areaId = targetAreaId;
                        updatedShops.push({
                            name: shop.name,
                            oldArea: oldArea ? oldArea.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
                            newArea: targetArea.name
                        });
                    }
                });
                
                // Update inspections
                let updatedInspections = 0;
                if (planData.inspectionData) {
                    updatedShops.forEach(shopInfo => {
                        planData.inspectionData.forEach(inspection => {
                            if (inspection.shops && inspection.shops.includes(shopInfo.name)) {
                                if (inspection.area === shopInfo.oldArea) {
                                    inspection.area = shopInfo.newArea;
                                    updatedInspections++;
                                }
                            }
                        });
                    });
                }
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('assignShopsStatus', 'success', 
                    `‚úÖ ÿ™ŸÖ ÿ™ÿπŸäŸäŸÜ ${shopIds.length} ŸÖÿ≠ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!\n` +
                    `‚Ä¢ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©: ${targetArea.name}\n` +
                    `‚Ä¢ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${updatedInspections} ÿ™ŸÅÿ™Ÿäÿ¥`);
                
                setTimeout(() => {
                    closeAssignShopsModal();
                    displayShopsList();
                    displayAreasList();
                }, 2000);
                
            } catch (error) {
                showMessage('assignShopsStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™: ' + error.message);
            }
        }
        
        // Export Areas Data
        function exportAreasData() {
            if (!planData || !planData.areas) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜÿßÿ∑ŸÇ ŸÑŸÑÿ™ÿµÿØŸäÿ±');
                return;
            }
            
            const dataStr = JSON.stringify(planData.areas, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `areas-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${planData.areas.length} ŸÖŸÜÿ∑ŸÇÿ© ÿ®ŸÜÿ¨ÿßÿ≠!`);
        }
        
        // Import Areas from File
        function importAreasFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedAreas = JSON.parse(event.target.result);
                        if (!Array.isArray(importedAreas)) {
                            alert('‚ùå ÿµŸäÿ∫ÿ© ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©. Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ŸÖÿµŸÅŸàŸÅÿ© ŸÖŸÜ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ.');
                            return;
                        }
                        
                        alert(`üì• ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${importedAreas.length} ŸÖŸÜÿ∑ŸÇÿ©!\n\nÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸäÿ≤ÿ© ÿßŸÑÿØŸÖÿ¨ ŸÇÿ±Ÿäÿ®ÿßŸã.`);
                    } catch (error) {
                        alert('‚ùå ŸÅÿ¥ŸÑ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // ============================================
        // BULK EDIT AREAS FUNCTIONS
        // ============================================
        
        // Open bulk edit modal
        function bulkEditAreas() {
            if (!planData || !planData.areas || planData.areas.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿßÿ∑ŸÇ ŸÖÿ™ÿßÿ≠ÿ©');
                return;
            }
            
            // Populate areas checkboxes
            const container = document.getElementById('bulkEditAreasContainer');
            container.innerHTML = '';
            planData.areas.forEach(area => {
                const shopsCount = planData.shops.filter(s => s.areaId === area.id).length;
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.padding = '8px';
                label.style.cursor = 'pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${area.id}" class="bulk-edit-checkbox" style="margin-left: 10px;">
                    ${area.name} (${shopsCount} ŸÖÿ≠ŸÑ)
                `;
                container.appendChild(label);
            });
            
            document.getElementById('bulkEditModal').style.display = 'block';
            document.getElementById('bulkEditStatus').innerHTML = '';
            document.getElementById('bulkEditPreview').style.display = 'none';
        }
        
        // Close bulk edit modal
        function closeBulkEditModal() {
            document.getElementById('bulkEditModal').style.display = 'none';
        }
        
        // Toggle bulk edit options
        function toggleBulkEditOptions() {
            const editType = document.getElementById('bulkEditType').value;
            const prefixSuffixDiv = document.getElementById('bulkEditPrefixSuffix');
            const replaceDiv = document.getElementById('bulkEditReplace');
            
            if (editType === 'replace') {
                prefixSuffixDiv.style.display = 'none';
                replaceDiv.style.display = 'block';
            } else {
                prefixSuffixDiv.style.display = 'block';
                replaceDiv.style.display = 'none';
            }
        }
        
        // Select all areas for bulk edit
        function selectAllAreasForBulkEdit() {
            const checkboxes = document.querySelectorAll('.bulk-edit-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
        }
        
        // Deselect all areas for bulk edit
        function deselectAllAreasForBulkEdit() {
            const checkboxes = document.querySelectorAll('.bulk-edit-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        // Preview bulk edit
        function previewBulkEdit() {
            const checkboxes = document.querySelectorAll('.bulk-edit-checkbox:checked');
            const areaIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (areaIds.length === 0) {
                showMessage('bulkEditStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÜÿ∑ŸÇÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                return;
            }
            
            const editType = document.getElementById('bulkEditType').value;
            const changes = [];
            
            if (editType === 'prefix') {
                const prefix = document.getElementById('bulkEditText').value.trim();
                if (!prefix) {
                    showMessage('bulkEditStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ÿßÿØÿ¶ÿ©');
                    return;
                }
                
                areaIds.forEach(areaId => {
                    const area = planData.areas.find(a => a.id === areaId);
                    if (area) {
                        changes.push({
                            old: area.name,
                            new: prefix + ' ' + area.name
                        });
                    }
                });
            } else if (editType === 'suffix') {
                const suffix = document.getElementById('bulkEditText').value.trim();
                if (!suffix) {
                    showMessage('bulkEditStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÑÿßÿ≠ŸÇÿ©');
                    return;
                }
                
                areaIds.forEach(areaId => {
                    const area = planData.areas.find(a => a.id === areaId);
                    if (area) {
                        changes.push({
                            old: area.name,
                            new: area.name + ' ' + suffix
                        });
                    }
                });
            } else if (editType === 'replace') {
                const findText = document.getElementById('bulkEditFindText').value.trim();
                const replaceText = document.getElementById('bulkEditReplaceText').value.trim();
                
                if (!findText) {
                    showMessage('bulkEditStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿ±ÿßÿØ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑŸá');
                    return;
                }
                
                areaIds.forEach(areaId => {
                    const area = planData.areas.find(a => a.id === areaId);
                    if (area && area.name.includes(findText)) {
                        changes.push({
                            old: area.name,
                            new: area.name.replace(new RegExp(findText, 'g'), replaceText)
                        });
                    }
                });
            }
            
            if (changes.length === 0) {
                showMessage('bulkEditStatus', 'warning', '‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÑÿ™ÿ∑ÿ®ŸäŸÇŸáÿß');
                return;
            }
            
            // Display preview
            const previewDiv = document.getElementById('bulkEditPreview');
            const previewContent = document.getElementById('bulkEditPreviewContent');
            previewContent.innerHTML = '';
            
            changes.forEach(change => {
                const changeDiv = document.createElement('div');
                changeDiv.style.padding = '10px';
                changeDiv.style.borderBottom = '1px solid #e0e0e0';
                changeDiv.innerHTML = `
                    <div style="color: #dc3545;">ÿßŸÑŸÇÿØŸäŸÖ: ${change.old}</div>
                    <div style="color: #28a745;">ÿßŸÑÿ¨ÿØŸäÿØ: ${change.new}</div>
                `;
                previewContent.appendChild(changeDiv);
            });
            
            previewDiv.style.display = 'block';
            showMessage('bulkEditStatus', 'success', `‚úÖ ŸÖÿπÿßŸäŸÜÿ© ${changes.length} ÿ™ÿ∫ŸäŸäÿ±`);
        }
        
        // Execute bulk edit
        async function executeBulkEdit() {
            const checkboxes = document.querySelectorAll('.bulk-edit-checkbox:checked');
            const areaIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (areaIds.length === 0) {
                showMessage('bulkEditStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÜÿ∑ŸÇÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                return;
            }
            
            const editType = document.getElementById('bulkEditType').value;
            
            if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ÿπŸÑŸâ ${areaIds.length} ŸÖŸÜÿ∑ŸÇÿ©ÿü`)) {
                return;
            }
            
            showMessage('bulkEditStatus', 'info', '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™...');
            
            try {
                let changesCount = 0;
                const updates = [];
                
                if (editType === 'prefix') {
                    const prefix = document.getElementById('bulkEditText').value.trim();
                    if (!prefix) {
                        showMessage('bulkEditStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ÿßÿØÿ¶ÿ©');
                        return;
                    }
                    
                    areaIds.forEach(areaId => {
                        const area = planData.areas.find(a => a.id === areaId);
                        if (area) {
                            const oldName = area.name;
                            area.name = prefix + ' ' + area.name;
                            updates.push({ oldName, newName: area.name });
                            changesCount++;
                        }
                    });
                } else if (editType === 'suffix') {
                    const suffix = document.getElementById('bulkEditText').value.trim();
                    if (!suffix) {
                        showMessage('bulkEditStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÑÿßÿ≠ŸÇÿ©');
                        return;
                    }
                    
                    areaIds.forEach(areaId => {
                        const area = planData.areas.find(a => a.id === areaId);
                        if (area) {
                            const oldName = area.name;
                            area.name = area.name + ' ' + suffix;
                            updates.push({ oldName, newName: area.name });
                            changesCount++;
                        }
                    });
                } else if (editType === 'replace') {
                    const findText = document.getElementById('bulkEditFindText').value.trim();
                    const replaceText = document.getElementById('bulkEditReplaceText').value.trim();
                    
                    if (!findText) {
                        showMessage('bulkEditStatus', 'error', '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿ±ÿßÿØ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑŸá');
                        return;
                    }
                    
                    areaIds.forEach(areaId => {
                        const area = planData.areas.find(a => a.id === areaId);
                        if (area && area.name.includes(findText)) {
                            const oldName = area.name;
                            area.name = area.name.replace(new RegExp(findText, 'g'), replaceText);
                            updates.push({ oldName, newName: area.name });
                            changesCount++;
                        }
                    });
                }
                
                // Update inspections to match new area names
                let updatedInspections = 0;
                if (planData.inspectionData) {
                    updates.forEach(update => {
                        planData.inspectionData.forEach(inspection => {
                            if (inspection.area === update.oldName) {
                                inspection.area = update.newName;
                                updatedInspections++;
                            }
                        });
                    });
                }
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('bulkEditStatus', 'success', 
                    `‚úÖ ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ${changesCount} ÿ™ÿπÿØŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!\n` +
                    `‚Ä¢ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${updatedInspections} ÿ™ŸÅÿ™Ÿäÿ¥`);
                
                setTimeout(() => {
                    closeBulkEditModal();
                    displayAreasList();
                    populateAreas();
                }, 2000);
                
            } catch (error) {
                showMessage('bulkEditStatus', 'error', '‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™: ' + error.message);
            }
        }
        
        // Generate Areas Report
        function generateAreasReport() {
            if (!planData || !planData.areas || !planData.shops) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÉÿßŸÅŸäÿ© ŸÑŸÑÿ™ŸÇÿ±Ÿäÿ±');
                return;
            }
            
            let report = 'üìä ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ\n';
            report += '=' .repeat(50) + '\n\n';
            
            planData.areas.forEach(area => {
                const shopsInArea = planData.shops.filter(s => s.areaId === area.id).length;
                const inspectionsInArea = planData.inspectionData.filter(i => i.area === area.name).length;
                
                report += `üó∫Ô∏è ${area.name}\n`;
                report += `   ‚Ä¢ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™: ${shopsInArea}\n`;
                report += `   ‚Ä¢ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™: ${inspectionsInArea}\n\n`;
            });
            
            const dataBlob = new Blob([report], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `areas-report-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ!');
        }
        
        // ==================== Smart Shop List Functions ====================
        
        /**
         * Calculate shop rating based on multiple criteria
         * Rating criteria:
         * 1. Compliance (ÿßŸÑÿßŸÑÿ™ÿ≤ÿßŸÖ) - 30 points
         * 2. Last inspection date (ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥) - 25 points
         * 3. Inspection frequency (ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥) - 20 points
         * 4. Data completeness (ÿßŸÉÿ™ŸÖÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™) - 15 points
         * 5. Activity type priority (ÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑŸÜÿ¥ÿßÿ∑) - 10 points
         */
        function calculateShopRating(shopName) {
            let rating = 0;
            let details = {
                compliance: 0,
                lastInspection: 0,
                frequency: 0,
                dataCompleteness: 0,
                activityPriority: 0
            };
            
            // Get shop details
            const shopDetails = shopsDetails ? shopsDetails[shopName] : null;
            
            // 1. Data Completeness (15 points)
            if (shopDetails) {
                let completeness = 0;
                if (shopDetails.nameAr) completeness += 2;
                if (shopDetails.nameEn) completeness += 2;
                if (shopDetails.licenseNo) completeness += 3;
                if (shopDetails.admCode) completeness += 2;
                if (shopDetails.address) completeness += 2;
                if (shopDetails.contact) completeness += 2;
                if (shopDetails.activity) completeness += 2;
                details.dataCompleteness = completeness;
                rating += completeness;
            }
            
            // 2. Activity Type Priority (10 points)
            if (shopDetails && shopDetails.activity) {
                const activity = shopDetails.activity.toLowerCase();
                // High priority activities
                if (activity.includes('animal') || activity.includes('ÿ≠ŸäŸàÿßŸÜ') || 
                    activity.includes('veterinar') || activity.includes('ÿ®Ÿäÿ∑ÿ±')) {
                    details.activityPriority = 10;
                    rating += 10;
                } else if (activity.includes('pet') || activity.includes('ÿ£ŸÑŸäŸÅ')) {
                    details.activityPriority = 8;
                    rating += 8;
                } else if (activity.includes('bird') || activity.includes('ÿ∑ŸäŸàÿ±')) {
                    details.activityPriority = 7;
                    rating += 7;
                } else {
                    details.activityPriority = 5;
                    rating += 5;
                }
            }
            
            // 3. Last Inspection Date (25 points)
            const lastInspection = getLastInspectionForShop(shopName);
            if (lastInspection) {
                const daysSince = Math.floor((new Date() - new Date(lastInspection.day)) / (1000 * 60 * 60 * 24));
                if (daysSince <= 7) {
                    details.lastInspection = 25;
                    rating += 25;
                } else if (daysSince <= 14) {
                    details.lastInspection = 20;
                    rating += 20;
                } else if (daysSince <= 30) {
                    details.lastInspection = 15;
                    rating += 15;
                } else if (daysSince <= 60) {
                    details.lastInspection = 10;
                    rating += 10;
                } else {
                    details.lastInspection = 5;
                    rating += 5;
                }
            }
            
            // 4. Inspection Frequency (20 points)
            const inspectionCount = getInspectionCountForShop(shopName);
            if (inspectionCount >= 10) {
                details.frequency = 20;
                rating += 20;
            } else if (inspectionCount >= 7) {
                details.frequency = 16;
                rating += 16;
            } else if (inspectionCount >= 5) {
                details.frequency = 12;
                rating += 12;
            } else if (inspectionCount >= 3) {
                details.frequency = 8;
                rating += 8;
            } else if (inspectionCount >= 1) {
                details.frequency = 4;
                rating += 4;
            }
            
            // 5. Compliance Score (30 points) - Based on consistent inspections
            // Good compliance = regular inspections without long gaps
            if (inspectionCount > 0) {
                const inspections = getInspectionsForShop(shopName);
                if (inspections.length >= 2) {
                    // Calculate consistency
                    const dates = inspections.map(i => new Date(i.day)).sort((a, b) => b - a);
                    const gaps = [];
                    for (let i = 0; i < dates.length - 1; i++) {
                        gaps.push(Math.floor((dates[i] - dates[i + 1]) / (1000 * 60 * 60 * 24)));
                    }
                    const avgGap = gaps.reduce((a, b) => a + b, 0) / gaps.length;
                    
                    if (avgGap <= 14) {
                        details.compliance = 30;
                        rating += 30;
                    } else if (avgGap <= 21) {
                        details.compliance = 25;
                        rating += 25;
                    } else if (avgGap <= 30) {
                        details.compliance = 20;
                        rating += 20;
                    } else {
                        details.compliance = 15;
                        rating += 15;
                    }
                } else if (inspectionCount === 1) {
                    details.compliance = 10;
                    rating += 10;
                }
            }
            
            return { rating, details };
        }
        
        function getLastInspectionForShop(shopName) {
            if (!planData || !planData.inspectionData) return null;
            
            const inspections = planData.inspectionData
                .filter(i => i.shops && i.shops.includes(shopName))
                .sort((a, b) => new Date(b.day) - new Date(a.day));
            
            return inspections.length > 0 ? inspections[0] : null;
        }
        
        function getInspectionCountForShop(shopName) {
            if (!planData || !planData.inspectionData) return 0;
            
            return planData.inspectionData.filter(i => i.shops && i.shops.includes(shopName)).length;
        }
        
        function getInspectionsForShop(shopName) {
            if (!planData || !planData.inspectionData) return [];
            
            return planData.inspectionData.filter(i => i.shops && i.shops.includes(shopName));
        }
        
        // Open Smart Shop List Modal
        async function openSmartShopListModal() {
            // Load shops details if not loaded
            if (!shopsDetails) {
                try {
                    const response = await fetch('shops_details.json?' + new Date().getTime());
                    if (response.ok) {
                        shopsDetails = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading shops_details.json:', error);
                }
            }
            
            // Populate area filter
            const areaFilter = document.getElementById('smartListAreaFilter');
            areaFilter.innerHTML = '<option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>';
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    areaFilter.appendChild(option);
                });
            }
            
            // Show modal
            document.getElementById('smartShopListModal').style.display = 'block';
            
            // Generate initial list
            updateSmartShopList();
        }
        
        // Close Smart Shop List Modal
        function closeSmartShopListModal() {
            document.getElementById('smartShopListModal').style.display = 'none';
        }
        
        // Update Smart Shop List based on filters
        // Calculate smart priority score for a shop
        // Higher score = higher priority (needs attention)
        function calculateSmartPriorityScore(shop) {
            let score = 0;
            
            // 1. Rating factor (0-40 points) - Lower rating = higher priority
            // Invert the rating: 0% rating gets 40 points, 100% rating gets 0 points
            score += (100 - shop.rating) * 0.4;
            
            // 2. Last inspection factor (0-40 points) - Older inspection = higher priority
            if (shop.lastInspection) {
                const daysSinceInspection = (new Date() - new Date(shop.lastInspection.day)) / (1000 * 60 * 60 * 24);
                // More than 60 days = max 40 points, recent inspection = fewer points
                score += Math.min(daysSinceInspection / 60 * 40, 40);
            } else {
                // Never inspected = maximum priority
                score += 40;
            }
            
            // 3. Inspection count factor (0-20 points) - Fewer inspections = higher priority
            // 0 inspections = 20 points, 10+ inspections = 0 points
            const inspectionBonus = Math.max(20 - (shop.inspectionCount * 2), 0);
            score += inspectionBonus;
            
            return score;
        }
        
        function updateSmartShopList() {
            const primarySort = document.getElementById('primarySort').value;
            const areaFilter = document.getElementById('smartListAreaFilter').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            const tableView = document.getElementById('tableView').value;
            
            // Collect all shops
            let allShops = [];
            
            if (shopsDetails) {
                Object.entries(shopsDetails).forEach(([shopName, shopInfo]) => {
                    const area = planData?.areas?.find(a => a.name === shopInfo.address || a.id === shopInfo.areaId);
                    const ratingData = calculateShopRating(shopName);
                    
                    allShops.push({
                        name: shopInfo.nameAr || shopName,
                        nameEn: shopInfo.nameEn || '',
                        licenseNo: shopInfo.licenseNo || '',
                        admCode: shopInfo.admCode || '',
                        address: shopInfo.address || '',
                        contact: shopInfo.contact || '',
                        activity: shopInfo.activity || '',
                        area: area ? area.name : shopInfo.address || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
                        areaId: area ? area.id : '',
                        rating: ratingData.rating,
                        ratingDetails: ratingData.details,
                        lastInspection: getLastInspectionForShop(shopName),
                        inspectionCount: getInspectionCountForShop(shopName)
                    });
                });
            }
            
            // Apply filters
            if (areaFilter) {
                const selectedArea = planData?.areas?.find(a => a.id === areaFilter);
                if (selectedArea) {
                    allShops = allShops.filter(s => s.area === selectedArea.name || s.areaId === areaFilter);
                }
            }
            
            if (ratingFilter) {
                allShops = allShops.filter(shop => {
                    if (ratingFilter === 'excellent') return shop.rating >= 90;
                    if (ratingFilter === 'good') return shop.rating >= 70 && shop.rating < 90;
                    if (ratingFilter === 'fair') return shop.rating >= 50 && shop.rating < 70;
                    if (ratingFilter === 'poor') return shop.rating < 50;
                    return true;
                });
            }
            
            // Apply sorting
            if (primarySort === 'smartPriority') {
                // Smart priority sorting: combines rating, last inspection date, and inspection count
                allShops.sort((a, b) => {
                    // Calculate priority score (0-100, higher is more priority)
                    const scoreA = calculateSmartPriorityScore(a);
                    const scoreB = calculateSmartPriorityScore(b);
                    return scoreB - scoreA; // Higher priority first
                });
            } else if (primarySort === 'areaProximity') {
                // Area proximity sorting: groups by area and sorts by rating within each area
                allShops.sort((a, b) => {
                    // First sort by area
                    const areaCompare = a.area.localeCompare(b.area, 'ar');
                    if (areaCompare !== 0) return areaCompare;
                    // Then by rating within the same area (higher first)
                    return b.rating - a.rating;
                });
            } else if (primarySort === 'rating') {
                allShops.sort((a, b) => b.rating - a.rating);
            } else if (primarySort === 'area') {
                allShops.sort((a, b) => a.area.localeCompare(b.area, 'ar'));
            } else if (primarySort === 'activity') {
                allShops.sort((a, b) => (a.activity || '').localeCompare(b.activity || '', 'ar'));
            } else if (primarySort === 'alphabetical') {
                allShops.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            } else if (primarySort === 'lastInspection') {
                allShops.sort((a, b) => {
                    const dateA = a.lastInspection ? new Date(a.lastInspection.day) : new Date(0);
                    const dateB = b.lastInspection ? new Date(b.lastInspection.day) : new Date(0);
                    return dateB - dateA;
                });
            }
            
            // Update statistics
            const totalShops = allShops.length;
            const avgRating = totalShops > 0 ? (allShops.reduce((sum, s) => sum + s.rating, 0) / totalShops).toFixed(1) : 0;
            const uniqueAreas = new Set(allShops.map(s => s.area)).size;
            const highPriority = allShops.filter(s => s.rating >= 70).length;
            
            document.getElementById('smartListTotalShops').textContent = totalShops;
            document.getElementById('smartListAvgRating').textContent = avgRating;
            document.getElementById('smartListAreas').textContent = uniqueAreas;
            document.getElementById('smartListHighPriority').textContent = highPriority;
            
            // Update selected shops counter
            const selectedCounter = document.getElementById('selectedShopsCounter');
            const selectedCount = document.getElementById('smartListSelectedCount');
            if (selectedShopsForBatch.size > 0) {
                selectedCounter.style.display = 'block';
                selectedCount.textContent = selectedShopsForBatch.size;
            } else {
                selectedCounter.style.display = 'none';
            }
            
            // Generate tables based on view mode
            const content = document.getElementById('smartShopListContent');
            
            if (tableView === 'unified') {
                content.innerHTML = generateUnifiedTable(allShops);
            } else if (tableView === 'byArea') {
                content.innerHTML = generateTablesByArea(allShops);
            } else if (tableView === 'byActivity') {
                content.innerHTML = generateTablesByActivity(allShops);
            }
        }
        
        // Generate unified table
        function generateUnifiedTable(shops) {
            if (shops.length === 0) {
                return '<p style="text-align: center; padding: 40px; color: #999;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑŸÑŸÅŸÑÿßÿ™ÿ± ÿßŸÑŸÖÿ≠ÿØÿØÿ©</p>';
            }
            
            let html = '<div style="overflow-x: auto;">';
            html += '<table class="inspections-table" style="width: 100%;">';
            html += '<thead><tr>';
            html += '<th style="width: 50px;">‚òëÔ∏è</th>';
            html += '<th>#</th>';
            html += '<th>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ</th>';
            html += '<th>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>';
            html += '<th>ÿßŸÑŸÜÿ¥ÿßÿ∑</th>';
            html += '<th>ÿßŸÑÿ™ŸÇŸäŸäŸÖ</th>';
            html += '<th>ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥</th>';
            html += '<th>ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</th>';
            html += '<th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>';
            html += '</tr></thead><tbody>';
            
            shops.forEach((shop, idx) => {
                const ratingClass = shop.rating >= 90 ? 'excellent' : 
                                   shop.rating >= 70 ? 'good' : 
                                   shop.rating >= 50 ? 'fair' : 'poor';
                const ratingColor = shop.rating >= 90 ? '#27ae60' : 
                                   shop.rating >= 70 ? '#3498db' : 
                                   shop.rating >= 50 ? '#f39c12' : '#e74c3c';
                
                const lastInspectionText = shop.lastInspection ? 
                    new Date(shop.lastInspection.day).toLocaleDateString('ar-EG') : 'ŸÑŸÖ Ÿäÿ™ŸÖ';
                
                const activityShort = shop.activity ? 
                    (shop.activity.length > 50 ? shop.activity.substring(0, 50) + '...' : shop.activity) : 
                    'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                
                const isSelected = selectedShopsForBatch.has(shop.name);
                const checkboxStyle = isSelected ? 'background: #28a745; color: white;' : 'background: white; color: #666;';
                
                html += `<tr style="${isSelected ? 'background: #e8f5e9;' : ''}">`;
                html += `<td style="text-align: center;">
                    <input type="checkbox" 
                           ${isSelected ? 'checked' : ''} 
                           onchange="toggleShopSelection('${escapeJs(shop.name)}')"
                           style="width: 20px; height: 20px; cursor: pointer;">
                </td>`;
                html += `<td>${idx + 1}</td>`;
                html += `<td><strong>${escapeHtml(shop.name)}</strong><br><small style="color: #999;">${escapeHtml(shop.nameEn || '')}</small></td>`;
                html += `<td>${escapeHtml(shop.area)}</td>`;
                html += `<td title="${escapeHtml(shop.activity || '')}">${escapeHtml(activityShort)}</td>`;
                html += `<td><div style="background: ${ratingColor}; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; text-align: center;">${shop.rating.toFixed(0)}</div></td>`;
                html += `<td>${lastInspectionText}</td>`;
                html += `<td style="text-align: center;">${shop.inspectionCount}</td>`;
                html += `<td>
                    <button onclick="showShopRatingDetails('${escapeJs(shop.name)}')" class="btn btn-sm btn-info" style="padding: 5px 10px; margin: 2px;" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ">üëÅÔ∏è</button>
                    <button onclick="editShopFromSmartList('${escapeJs(shop.name)}')" class="btn btn-sm btn-warning" style="padding: 5px 10px; margin: 2px;" title="ÿ™ÿπÿØŸäŸÑ">‚úèÔ∏è</button>
                    <button onclick="deleteShopFromSmartList('${escapeJs(shop.name)}')" class="btn btn-sm btn-danger" style="padding: 5px 10px; margin: 2px;" title="ÿ≠ÿ∞ŸÅ">üóëÔ∏è</button>
                </td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        // Generate tables by area
        function generateTablesByArea(shops) {
            if (shops.length === 0) {
                return '<p style="text-align: center; padding: 40px; color: #999;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑŸÑŸÅŸÑÿßÿ™ÿ± ÿßŸÑŸÖÿ≠ÿØÿØÿ©</p>';
            }
            
            // Group shops by area
            const shopsByArea = {};
            shops.forEach(shop => {
                if (!shopsByArea[shop.area]) {
                    shopsByArea[shop.area] = [];
                }
                shopsByArea[shop.area].push(shop);
            });
            
            let html = '';
            Object.keys(shopsByArea).sort((a, b) => a.localeCompare(b, 'ar')).forEach(area => {
                const areaShops = shopsByArea[area];
                const avgRating = (areaShops.reduce((sum, s) => sum + s.rating, 0) / areaShops.length).toFixed(1);
                
                html += `<div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">`;
                html += `<h3 style="color: #667eea; margin-bottom: 15px;">üó∫Ô∏è ${escapeHtml(area)} <span style="color: #999; font-size: 0.8em;">(${areaShops.length} ŸÖÿ≠ŸÑ - ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ: ${avgRating})</span></h3>`;
                html += generateUnifiedTable(areaShops);
                html += '</div>';
            });
            
            return html;
        }
        
        // Generate tables by activity
        function generateTablesByActivity(shops) {
            if (shops.length === 0) {
                return '<p style="text-align: center; padding: 40px; color: #999;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑŸÑŸÅŸÑÿßÿ™ÿ± ÿßŸÑŸÖÿ≠ÿØÿØÿ©</p>';
            }
            
            // Group shops by main activity type
            const shopsByActivity = {};
            shops.forEach(shop => {
                let activityType = 'ÿ£ÿÆÿ±Ÿâ';
                const activity = (shop.activity || '').toLowerCase();
                
                if (activity.includes('animal') || activity.includes('ÿ≠ŸäŸàÿßŸÜ')) {
                    activityType = 'ÿ™ÿ¨ÿßÿ±ÿ© ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™';
                } else if (activity.includes('veterinar') || activity.includes('ÿ®Ÿäÿ∑ÿ±')) {
                    activityType = 'ÿÆÿØŸÖÿßÿ™ ÿ®Ÿäÿ∑ÿ±Ÿäÿ©';
                } else if (activity.includes('bird') || activity.includes('ÿ∑ŸäŸàÿ±')) {
                    activityType = 'ÿ™ÿ¨ÿßÿ±ÿ© ÿßŸÑÿ∑ŸäŸàÿ±';
                } else if (activity.includes('pet') || activity.includes('ÿ£ŸÑŸäŸÅ')) {
                    activityType = 'ÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿ£ŸÑŸäŸÅÿ©';
                } else if (activity.includes('fish') || activity.includes('ÿ£ÿ≥ŸÖÿßŸÉ')) {
                    activityType = 'ÿ£ÿ≥ŸÖÿßŸÉ ÿßŸÑÿ≤ŸäŸÜÿ©';
                }
                
                if (!shopsByActivity[activityType]) {
                    shopsByActivity[activityType] = [];
                }
                shopsByActivity[activityType].push(shop);
            });
            
            let html = '';
            Object.keys(shopsByActivity).sort((a, b) => a.localeCompare(b, 'ar')).forEach(activityType => {
                const activityShops = shopsByActivity[activityType];
                const avgRating = (activityShops.reduce((sum, s) => sum + s.rating, 0) / activityShops.length).toFixed(1);
                
                html += `<div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">`;
                html += `<h3 style="color: #667eea; margin-bottom: 15px;">üíº ${escapeHtml(activityType)} <span style="color: #999; font-size: 0.8em;">(${activityShops.length} ŸÖÿ≠ŸÑ - ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ: ${avgRating})</span></h3>`;
                html += generateUnifiedTable(activityShops);
                html += '</div>';
            });
            
            return html;
        }
        
        // Show shop rating details
        function showShopRatingDetails(shopName) {
            const ratingData = calculateShopRating(shopName);
            const shop = shopsDetails[shopName];
            
            let details = `üìä ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ: ${shopName}\n`;
            details += `${'='.repeat(50)}\n\n`;
            details += `üìà ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${ratingData.rating.toFixed(0)}/100\n\n`;
            details += `ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ÿßŸàÿ±:\n`;
            details += `‚Ä¢ ÿßŸÑÿßŸÑÿ™ÿ≤ÿßŸÖ: ${ratingData.details.compliance}/30\n`;
            details += `‚Ä¢ ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥: ${ratingData.details.lastInspection}/25\n`;
            details += `‚Ä¢ ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥: ${ratingData.details.frequency}/20\n`;
            details += `‚Ä¢ ÿßŸÉÿ™ŸÖÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ${ratingData.details.dataCompleteness}/15\n`;
            details += `‚Ä¢ ÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑŸÜÿ¥ÿßÿ∑: ${ratingData.details.activityPriority}/10\n\n`;
            
            const lastInspection = getLastInspectionForShop(shopName);
            if (lastInspection) {
                const daysSince = Math.floor((new Date() - new Date(lastInspection.day)) / (1000 * 60 * 60 * 24));
                details += `üìÖ ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥: ${new Date(lastInspection.day).toLocaleDateString('ar-EG')} (ŸÖŸÜÿ∞ ${daysSince} ŸäŸàŸÖ)\n`;
            } else {
                details += `üìÖ ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥: ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿ®ÿπÿØ\n`;
            }
            
            details += `üî¢ ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÉŸÑŸäÿ©: ${getInspectionCountForShop(shopName)}\n`;
            
            if (shop) {
                details += `\nüìç ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑ:\n`;
                if (shop.licenseNo) details += `‚Ä¢ ÿ±ŸÇŸÖ ÿßŸÑÿ±ÿÆÿµÿ©: ${shop.licenseNo}\n`;
                if (shop.admCode) details += `‚Ä¢ ŸÉŸàÿØ ADM: ${shop.admCode}\n`;
                if (shop.address) details += `‚Ä¢ ÿßŸÑÿπŸÜŸàÿßŸÜ: ${shop.address}\n`;
                if (shop.contact) details += `‚Ä¢ ÿßŸÑŸáÿßÿ™ŸÅ: ${shop.contact}\n`;
            }
            
            alert(details);
        }
        
        // Export Smart Shop List
        function exportSmartShopList(format) {
            const primarySort = document.getElementById('primarySort').value;
            const areaFilter = document.getElementById('smartListAreaFilter').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            
            // Get current filtered shops
            let allShops = [];
            
            if (shopsDetails) {
                Object.entries(shopsDetails).forEach(([shopName, shopInfo]) => {
                    const area = planData?.areas?.find(a => a.name === shopInfo.address || a.id === shopInfo.areaId);
                    const ratingData = calculateShopRating(shopName);
                    
                    allShops.push({
                        name: shopInfo.nameAr || shopName,
                        nameEn: shopInfo.nameEn || '',
                        licenseNo: shopInfo.licenseNo || '',
                        admCode: shopInfo.admCode || '',
                        address: shopInfo.address || '',
                        contact: shopInfo.contact || '',
                        activity: shopInfo.activity || '',
                        area: area ? area.name : shopInfo.address || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
                        rating: ratingData.rating,
                        lastInspection: getLastInspectionForShop(shopName),
                        inspectionCount: getInspectionCountForShop(shopName)
                    });
                });
            }
            
            // Apply same filters
            if (areaFilter) {
                const selectedArea = planData?.areas?.find(a => a.id === areaFilter);
                if (selectedArea) {
                    allShops = allShops.filter(s => s.area === selectedArea.name);
                }
            }
            
            if (ratingFilter) {
                allShops = allShops.filter(shop => {
                    if (ratingFilter === 'excellent') return shop.rating >= 90;
                    if (ratingFilter === 'good') return shop.rating >= 70 && shop.rating < 90;
                    if (ratingFilter === 'fair') return shop.rating >= 50 && shop.rating < 70;
                    if (ratingFilter === 'poor') return shop.rating < 50;
                    return true;
                });
            }
            
            // Check if there are shops to export
            if (allShops.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±');
                return;
            }
            
            if (format === 'json') {
                try {
                    const dataStr = JSON.stringify(allShops, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `smart-shop-list-${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                    alert(`‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${allShops.length} ŸÖÿ≠ŸÑ ÿ®ÿµŸäÿ∫ÿ© JSON ÿ®ŸÜÿ¨ÿßÿ≠!`);
                } catch (error) {
                    alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± JSON: ' + error.message);
                    console.error('JSON export error:', error);
                }
            } else if (format === 'excel') {
                try {
                    // Prepare data for Excel export
                    const exportData = allShops.map((shop, index) => ({
                        'ÿßŸÑÿ±ŸÇŸÖ': index + 1,
                        'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ': shop.name,
                        'ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©': shop.nameEn,
                        'ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©': shop.area,
                        'ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ': shop.licenseNo,
                        'ŸÉŸàÿØ ADM': shop.admCode,
                        'ÿßŸÑÿπŸÜŸàÿßŸÜ': shop.address,
                        'ÿ¨Ÿáÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ': shop.contact,
                        'ÿßŸÑŸÜÿ¥ÿßÿ∑': shop.activity,
                        'ÿßŸÑÿ™ŸÇŸäŸäŸÖ': shop.rating ? shop.rating.toFixed(1) + '%' : 'ŸÑÿß ŸäŸàÿ¨ÿØ',
                        'ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥': shop.lastInspection || 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥',
                        'ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™': shop.inspectionCount || 0
                    }));
                    
                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    
                    // Set column widths
                    ws['!cols'] = [
                        { wch: 8 },  // ÿßŸÑÿ±ŸÇŸÖ
                        { wch: 30 }, // ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ
                        { wch: 25 }, // ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
                        { wch: 20 }, // ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©
                        { wch: 15 }, // ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ
                        { wch: 12 }, // ŸÉŸàÿØ ADM
                        { wch: 30 }, // ÿßŸÑÿπŸÜŸàÿßŸÜ
                        { wch: 20 }, // ÿ¨Ÿáÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
                        { wch: 25 }, // ÿßŸÑŸÜÿ¥ÿßÿ∑
                        { wch: 12 }, // ÿßŸÑÿ™ŸÇŸäŸäŸÖ
                        { wch: 18 }, // ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥
                        { wch: 15 }  // ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™
                    ];
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©');
                    
                    // Generate filename with timestamp
                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `ŸÇÿßÿ¶ŸÖÿ©_ÿßŸÑŸÖÿ≠ŸÑÿßÿ™_ÿßŸÑÿ∞ŸÉŸäÿ©_${timestamp}.xlsx`;
                    
                    // Download file
                    XLSX.writeFile(wb, filename);
                    
                    alert(`‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${allShops.length} ŸÖÿ≠ŸÑ ÿ•ŸÑŸâ Excel ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüìÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ: ${filename}`);
                } catch (error) {
                    alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± Excel: ' + error.message);
                    console.error('Excel export error:', error);
                }
            } else if (format === 'pdf') {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Set font for better Arabic support (using default font)
                    doc.setFont('helvetica');
                    doc.setFontSize(16);
                    
                    // Add title
                    const title = 'ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ© - Smart Shop List';
                    doc.text(title, doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                    
                    // Add date
                    doc.setFontSize(10);
                    const dateText = `ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿµÿØŸäÿ±: ${new Date().toLocaleDateString('ar-EG')} - Export Date: ${new Date().toLocaleDateString('en-US')}`;
                    doc.text(dateText, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });
                    
                    // Prepare table data
                    const tableData = allShops.map((shop, index) => [
                        index + 1,
                        shop.name,
                        shop.area,
                        shop.licenseNo || '-',
                        shop.activity || '-',
                        shop.rating ? shop.rating.toFixed(1) + '%' : '-',
                        shop.inspectionCount || 0
                    ]);
                    
                    // Add table
                    doc.autoTable({
                        startY: 30,
                        head: [['#', 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ / Shop Name', 'ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© / Area', 'ÿßŸÑÿ™ÿ±ÿÆŸäÿµ / License', 'ÿßŸÑŸÜÿ¥ÿßÿ∑ / Activity', 'ÿßŸÑÿ™ŸÇŸäŸäŸÖ / Rating', 'ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ / Inspections']],
                        body: tableData,
                        styles: {
                            font: 'helvetica',
                            fontSize: 9,
                            cellPadding: 3,
                            halign: 'center'
                        },
                        headStyles: {
                            fillColor: [102, 126, 234],
                            textColor: 255,
                            fontStyle: 'bold',
                            halign: 'center'
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        margin: { top: 30, left: 10, right: 10 }
                    });
                    
                    // Add footer with statistics
                    const finalY = doc.lastAutoTable.finalY || 30;
                    doc.setFontSize(10);
                    const stats = `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ / Total Shops: ${allShops.length}`;
                    doc.text(stats, 15, finalY + 10);
                    
                    // Save PDF
                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `Smart_Shop_List_${timestamp}.pdf`;
                    doc.save(filename);
                    
                    alert(`‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${allShops.length} ŸÖÿ≠ŸÑ ÿ•ŸÑŸâ PDF ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüìÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ: ${filename}`);
                } catch (error) {
                    alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± PDF: ' + error.message);
                    console.error('PDF export error:', error);
                }
            }
        }
        
        // Print Smart Shop List
        function printSmartShopList() {
            try {
                const content = document.getElementById('smartShopListContent').innerHTML;
                
                // Check if there's content to print
                if (!content || content.trim() === '') {
                    alert('‚ö†Ô∏è ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≠ÿ™ŸàŸâ ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©');
                    return;
                }
                
                const printWindow = window.open('', '', 'height=800,width=1000');
                
                if (!printWindow) {
                    alert('‚ö†Ô∏è ÿ™ŸÖ ÿ≠ÿ∏ÿ± ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ©.');
                    return;
                }
                
                printWindow.document.write('<html><head><title>ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©</title>');
                printWindow.document.write('<meta charset="UTF-8">');
                printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">');
                printWindow.document.write('<style>');
                printWindow.document.write('* { margin: 0; padding: 0; box-sizing: border-box; }');
                printWindow.document.write('body { font-family: "Cairo", Arial, sans-serif; direction: rtl; padding: 20px; }');
                printWindow.document.write('h1 { text-align: center; color: #667eea; margin-bottom: 10px; }');
                printWindow.document.write('p { text-align: center; color: #666; margin-bottom: 20px; }');
                printWindow.document.write('table { width: 100%; border-collapse: collapse; margin: 20px 0; }');
                printWindow.document.write('th, td { border: 1px solid #ddd; padding: 10px; text-align: right; font-size: 12px; }');
                printWindow.document.write('th { background-color: #667eea; color: white; font-weight: bold; }');
                printWindow.document.write('tr:nth-child(even) { background-color: #f8f9fa; }');
                printWindow.document.write('h3 { color: #667eea; margin-top: 30px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }');
                printWindow.document.write('.priority-high { background-color: #ffe6e6; }');
                printWindow.document.write('.rating-excellent { background-color: #d4edda; }');
                printWindow.document.write('.rating-good { background-color: #cce5ff; }');
                printWindow.document.write('.rating-fair { background-color: #fff3cd; }');
                printWindow.document.write('.rating-poor { background-color: #f8d7da; }');
                printWindow.document.write('@media print { body { padding: 10px; } }');
                printWindow.document.write('</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write('<h1>üìã ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©</h1>');
                printWindow.document.write('<p>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©: ' + new Date().toLocaleDateString('ar-EG') + ' - ' + new Date().toLocaleTimeString('ar-EG') + '</p>');
                printWindow.document.write(content);
                printWindow.document.write('<div style="margin-top: 30px; text-align: center; color: #999; font-size: 11px; border-top: 1px solid #ddd; padding-top: 10px;">');
                printWindow.document.write('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° Ÿáÿ∞ÿß ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿ£ÿØÿßÿ© ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑ ÿßŸÑÿ∞ŸÉŸäÿ© ŸÑŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿä');
                printWindow.document.write('</div>');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                
                // Wait for content to load then print
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                }, 250);
                
            } catch (error) {
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ∑ÿ®ÿßÿπÿ©: ' + error.message);
                console.error('Print error:', error);
            }
        }
        
        // =========================================================================
        // Smart Shop Management Functions
        // =========================================================================
        
        // Track selected shops for batch operations
        let selectedShopsForBatch = new Set();
        
        // Open Add Shop modal from Smart List
        function openAddShopFromSmartList() {
            // Close smart list modal first
            closeSmartShopListModal();
            // Switch to shops tab
            switchTab('shops');
            // Open add shop modal
            setTimeout(() => {
                openAddShopModal();
            }, 300);
        }
        
        // Open Bulk Edit Shops
        function openBulkEditShops() {
            if (selectedShopsForBatch.size === 0) {
                alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿØ ŸÖÿ≠ŸÑ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ ŸÑŸÑÿ™ÿπÿØŸäŸÑ\n\nÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ£ÿ≤ÿ±ÿßÿ± "ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ" ÿ£Ÿà ÿ≠ÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸäÿØŸàŸäÿßŸã');
                return;
            }
            
            const shopNames = Array.from(selectedShopsForBatch).join('\n‚Ä¢ ');
            const confirm = window.confirm(`üìù ÿ™ÿπÿØŸäŸÑ ÿ¨ŸÖÿßÿπŸä ŸÑŸÄ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ\n\nÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©:\n‚Ä¢ ${shopNames}\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`);
            
            if (confirm) {
                // Open bulk edit interface
                showBulkEditInterface();
            }
        }
        
        // Show Bulk Edit Interface
        function showBulkEditInterface() {
            const operations = [
                '1. ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™',
                '2. ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ¥ÿßÿ∑ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™',
                '3. ÿ•ÿ∂ÿßŸÅÿ© ŸÜŸÅÿ≥ ÿßŸÑÿπŸÜŸàÿßŸÜ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™',
                '4. ÿ™ÿ≠ÿØŸäÿ´ ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ ÿ®ÿ¥ŸÉŸÑ ÿ¨ŸÖÿßÿπŸä',
                '5. ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàŸÇÿπ ÿÆÿ±ÿßÿ¶ÿ∑ ÿ¨Ÿàÿ¨ŸÑ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™'
            ].join('\n');
            
            const choice = prompt(`‚öôÔ∏è ÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ¨ŸÖÿßÿπŸä ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©:\n\n${operations}\n\nÿßÿÆÿ™ÿ± ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸÑŸäÿ© (1-5):`);
            
            if (!choice) return;
            
            switch(choice) {
                case '1':
                    bulkUpdateArea();
                    break;
                case '2':
                    bulkUpdateActivity();
                    break;
                case '3':
                    bulkUpdateAddress();
                    break;
                case '4':
                    bulkUpdateLicense();
                    break;
                case '5':
                    bulkUpdateMapsLocation();
                    break;
                default:
                    alert('‚ùå ÿßÿÆÿ™Ÿäÿßÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');
            }
        }
        
        // Bulk update area
        function bulkUpdateArea() {
            if (!planData || !planData.areas) {
                alert('‚ùå ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿßÿ∑ŸÇ ŸÖÿ≠ÿØÿØÿ©');
                return;
            }
            
            const areasList = planData.areas.map((a, i) => `${i + 1}. ${a.name}`).join('\n');
            const areaChoice = prompt(`üìç ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©:\n\n${areasList}\n\nÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:`);
            
            if (!areaChoice) return;
            
            const areaIndex = parseInt(areaChoice) - 1;
            if (areaIndex >= 0 && areaIndex < planData.areas.length) {
                const newArea = planData.areas[areaIndex];
                
                if (confirm(`‚úÖ ÿ™ÿ≠ÿØŸäÿ´ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: ${newArea.name}\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü`)) {
                    // Update shops
                    selectedShopsForBatch.forEach(shopName => {
                        // Update in shops_details.json
                        if (shopsDetails[shopName]) {
                            shopsDetails[shopName].area = newArea.name;
                            shopsDetails[shopName].areaId = newArea.id;
                        }
                    });
                    
                    alert(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüíæ ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub`);
                    updateSmartShopList();
                }
            } else {
                alert('‚ùå ÿßÿÆÿ™Ÿäÿßÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');
            }
        }
        
        // Bulk update activity
        function bulkUpdateActivity() {
            const newActivity = prompt('üíº ÿ£ÿØÿÆŸÑ ÿßŸÑŸÜÿ¥ÿßÿ∑ ÿßŸÑÿ¨ÿØŸäÿØ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©:\n\nŸÖÿ´ÿßŸÑ: ÿ®Ÿäÿπ ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿßŸÑÿ£ŸÑŸäŸÅÿ© Ÿàÿ£ÿ≥ŸÖÿßŸÉ ÿßŸÑÿ≤ŸäŸÜÿ©');
            
            if (!newActivity) return;
            
            if (confirm(`‚úÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÜÿ¥ÿßÿ∑ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ ÿ•ŸÑŸâ:\n"${newActivity}"\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü`)) {
                selectedShopsForBatch.forEach(shopName => {
                    if (shopsDetails[shopName]) {
                        shopsDetails[shopName].activity = newActivity;
                    }
                });
                
                alert(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüíæ ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub`);
                updateSmartShopList();
            }
        }
        
        // Bulk update address
        function bulkUpdateAddress() {
            const newAddress = prompt('üìç ÿ£ÿØÿÆŸÑ ÿßŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑÿ¨ÿØŸäÿØ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©:\n\nŸÖÿ´ÿßŸÑ: ÿ≠Ÿä ÿßŸÑŸàÿ±ŸàÿØÿå ÿ¥ÿßÿ±ÿπ ÿßŸÑÿ£ŸÖŸäÿ± ŸÖÿ≠ŸÖÿØ');
            
            if (!newAddress) return;
            
            if (confirm(`‚úÖ ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÜŸàÿßŸÜ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ ÿ•ŸÑŸâ:\n"${newAddress}"\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü`)) {
                selectedShopsForBatch.forEach(shopName => {
                    if (shopsDetails[shopName]) {
                        shopsDetails[shopName].address = newAddress;
                    }
                });
                
                alert(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüíæ ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub`);
                updateSmartShopList();
            }
        }
        
        // Bulk update license
        function bulkUpdateLicense() {
            alert('üîñ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ ÿßŸÑÿ¨ŸÖÿßÿπŸä\n\nÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ®ÿßÿØÿ¶ÿ© Ÿàÿ±ŸÇŸÖ ÿ™ÿ≥ŸÑÿ≥ŸÑŸä ŸÑŸÉŸÑ ŸÖÿ≠ŸÑ');
            
            const prefix = prompt('ÿ£ÿØÿÆŸÑ ÿ®ÿßÿØÿ¶ÿ© ÿßŸÑÿ™ÿ±ÿÆŸäÿµ (ŸÖÿ´ÿßŸÑ: CN):', 'CN');
            if (!prefix) return;
            
            const startNumber = prompt('ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ ÿßŸÑÿ®ÿØÿßŸäÿ© (ŸÖÿ´ÿßŸÑ: 1000):', '1000');
            if (!startNumber) return;
            
            if (confirm(`‚úÖ ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ±ŸÇŸäŸÖ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ ÿ®ÿØÿ°ÿßŸã ŸÖŸÜ ${prefix}-${startNumber}\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü`)) {
                let counter = parseInt(startNumber);
                selectedShopsForBatch.forEach(shopName => {
                    if (shopsDetails[shopName]) {
                        shopsDetails[shopName].licenseNo = `${prefix}-${counter}`;
                        counter++;
                    }
                });
                
                alert(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüíæ ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub`);
                updateSmartShopList();
            }
        }
        
        // Bulk update maps location
        function bulkUpdateMapsLocation() {
            const baseUrl = prompt('üó∫Ô∏è ÿ£ÿØÿÆŸÑ ÿ±ÿßÿ®ÿ∑ ÿÆÿ±ÿßÿ¶ÿ∑ ÿ¨Ÿàÿ¨ŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä:\n\nŸÖÿ´ÿßŸÑ: https://maps.google.com/...');
            
            if (!baseUrl) return;
            
            if (confirm(`‚úÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸàŸÇÿπ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü`)) {
                selectedShopsForBatch.forEach(shopName => {
                    if (shopsDetails[shopName]) {
                        shopsDetails[shopName].locationMap = baseUrl;
                    }
                });
                
                alert(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüíæ ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub`);
                updateSmartShopList();
            }
        }
        
        // Open Bulk Delete Shops
        function openBulkDeleteShops() {
            if (selectedShopsForBatch.size === 0) {
                alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿØ ŸÖÿ≠ŸÑ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ ŸÑŸÑÿ≠ÿ∞ŸÅ');
                return;
            }
            
            const shopNames = Array.from(selectedShopsForBatch).join('\n‚Ä¢ ');
            const confirm = window.confirm(`‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ≠ÿ∞ŸÅ ÿ¨ŸÖÿßÿπŸä\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ ŸÜŸáÿßÿ¶ŸäÿßŸã:\n‚Ä¢ ${shopNames}\n\nŸáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá!\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ™ŸÖÿßŸÖÿßŸãÿü`);
            
            if (confirm) {
                const doubleConfirm = window.confirm(`‚ö†Ô∏è ÿ™ÿ£ŸÉŸäÿØ ŸÜŸáÿßÿ¶Ÿä\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ 100% ŸÖŸÜ ÿ≠ÿ∞ŸÅ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ ŸÅŸàÿ±ÿßŸã!`);
                
                if (doubleConfirm) {
                    deleteBulkShops();
                }
            }
        }
        
        // Delete Bulk Shops
        async function deleteBulkShops() {
            try {
                let deletedCount = 0;
                
                selectedShopsForBatch.forEach(shopName => {
                    if (shopsDetails[shopName]) {
                        delete shopsDetails[shopName];
                        deletedCount++;
                    }
                });
                
                // Clear selection
                selectedShopsForBatch.clear();
                
                alert(`‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${deletedCount} ŸÖÿ≠ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüíæ ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub`);
                updateSmartShopList();
                
            } catch (error) {
                console.error('Error deleting shops:', error);
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™: ' + error.message);
            }
        }
        
        // Open Import Shops from Excel
        function openImportShopsFromExcel() {
            const instructions = `üì• ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜ Excel\n\n`;
            const details = `ÿßŸÑÿÆÿ∑Ÿàÿßÿ™:\n1. ŸÇŸÖ ÿ®ÿ™ÿ≠ÿ∂Ÿäÿ± ŸÖŸÑŸÅ Excel Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ£ÿπŸÖÿØÿ©:\n   - ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ (nameAr)\n   - ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© (nameEn)\n   - ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© (area)\n   - ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ (licenseNo)\n   - ÿßŸÑÿπŸÜŸàÿßŸÜ (address)\n   - ÿßŸÑŸáÿßÿ™ŸÅ (contact)\n   - ÿßŸÑŸÜÿ¥ÿßÿ∑ (activity)\n   - ŸÉŸàÿØ ADM (admCode)\n\n2. ÿßÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ ÿ®ÿµŸäÿ∫ÿ© .xlsx\n\n3. ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÑŸÅ ŸÑŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`;
            
            if (confirm(instructions + details)) {
                // Create file input
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx,.xls';
                input.onchange = handleImportExcelFile;
                input.click();
            }
        }
        
        // Handle Import Excel File
        async function handleImportExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                if (jsonData.length === 0) {
                    alert('‚ùå ÿßŸÑŸÖŸÑŸÅ ŸÅÿßÿ±ÿ∫ ÿ£Ÿà ŸÑÿß Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿµÿ≠Ÿäÿ≠ÿ©');
                    return;
                }
                
                let importedCount = 0;
                let skippedCount = 0;
                
                jsonData.forEach(row => {
                    const shopName = row.nameAr || row['ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ'] || row.name;
                    
                    if (!shopName) {
                        skippedCount++;
                        return;
                    }
                    
                    // Check if shop already exists
                    if (shopsDetails[shopName]) {
                        const overwrite = confirm(`‚ö†Ô∏è ÿßŸÑŸÖÿ≠ŸÑ "${shopName}" ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü`);
                        if (!overwrite) {
                            skippedCount++;
                            return;
                        }
                    }
                    
                    // Import shop
                    shopsDetails[shopName] = {
                        nameAr: shopName,
                        nameEn: row.nameEn || row['ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©'] || '',
                        area: row.area || row['ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©'] || '',
                        licenseNo: row.licenseNo || row['ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ'] || '',
                        address: row.address || row['ÿßŸÑÿπŸÜŸàÿßŸÜ'] || '',
                        contact: row.contact || row['ÿßŸÑŸáÿßÿ™ŸÅ'] || '',
                        activity: row.activity || row['ÿßŸÑŸÜÿ¥ÿßÿ∑'] || '',
                        admCode: row.admCode || row['ŸÉŸàÿØ ADM'] || '',
                        locationMap: row.locationMap || row['ŸÖŸàŸÇÿπ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©'] || ''
                    };
                    
                    importedCount++;
                });
                
                alert(`‚úÖ ÿ™ŸÖ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüìä ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™:\n‚Ä¢ ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ: ${importedCount} ŸÖÿ≠ŸÑ\n‚Ä¢ ÿ™ŸÖ ÿ™ÿ¨ÿßŸáŸÑ: ${skippedCount} ŸÖÿ≠ŸÑ\n\nüíæ ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub`);
                updateSmartShopList();
                
            } catch (error) {
                console.error('Error importing Excel:', error);
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑŸÖŸÑŸÅ: ' + error.message);
            }
        }
        
        // Merge Duplicate Shops
        async function mergeDuplicateShops() {
            if (!confirm('üîÑ ÿØŸÖÿ¨ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©\n\nÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ© ŸàÿØŸÖÿ¨Ÿáÿß\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                return;
            }
            
            try {
                const shopNames = Object.keys(shopsDetails);
                const duplicates = [];
                const seen = new Map();
                
                // Find duplicates
                shopNames.forEach(shopName => {
                    const normalized = shopName.trim().toLowerCase();
                    
                    if (seen.has(normalized)) {
                        duplicates.push({
                            original: seen.get(normalized),
                            duplicate: shopName
                        });
                    } else {
                        seen.set(normalized, shopName);
                    }
                });
                
                if (duplicates.length === 0) {
                    alert('‚úÖ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÉÿ±ÿ±ÿ©!\n\nÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÅÿ±ŸäÿØÿ©.');
                    return;
                }
                
                // Show duplicates and merge
                const duplicatesList = duplicates.map(d => `‚Ä¢ ${d.duplicate} ‚Üí ${d.original}`).join('\n');
                
                if (confirm(`üîç ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${duplicates.length} ŸÖÿ≠ŸÑ ŸÖŸÉÿ±ÿ±:\n\n${duplicatesList}\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿØŸÖÿ¨Ÿáÿßÿü`)) {
                    duplicates.forEach(d => {
                        // Merge data from duplicate to original
                        const original = shopsDetails[d.original];
                        const duplicate = shopsDetails[d.duplicate];
                        
                        // Keep non-empty fields from duplicate
                        Object.keys(duplicate).forEach(key => {
                            if (duplicate[key] && !original[key]) {
                                original[key] = duplicate[key];
                            }
                        });
                        
                        // Delete duplicate
                        delete shopsDetails[d.duplicate];
                    });
                    
                    alert(`‚úÖ ÿ™ŸÖ ÿØŸÖÿ¨ ${duplicates.length} ŸÖÿ≠ŸÑ ŸÖŸÉÿ±ÿ± ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüíæ ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub`);
                    updateSmartShopList();
                }
                
            } catch (error) {
                console.error('Error merging duplicates:', error);
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿØŸÖÿ¨ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©: ' + error.message);
            }
        }
        
        // Sync Shops with GitHub
        async function syncShopsWithGitHub() {
            if (!githubToken) {
                alert('‚ö†Ô∏è Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã ŸÑŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub');
                return;
            }
            
            if (!confirm('‚òÅÔ∏è ŸÖÿ≤ÿßŸÖŸÜÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖÿπ GitHub\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÅŸä shops_details.json\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                return;
            }
            
            try {
                // Save shops_details.json
                const jsonContent = JSON.stringify(shopsDetails, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(jsonContent)));
                
                // Get current file SHA
                const getResponse = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = null;
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                }
                
                // Commit to GitHub
                const updateResponse = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ - ${new Date().toLocaleString('ar-EG')}`,
                        content: encodedContent,
                        sha: sha,
                        branch: 'main'
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™');
                }
                
                alert('‚úÖ ÿ™ŸÖÿ™ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub ÿ®ŸÜÿ¨ÿßÿ≠!\n\n‚òÅÔ∏è ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ©');
                
            } catch (error) {
                console.error('Error syncing with GitHub:', error);
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©: ' + error.message);
            }
        }
        
        // Refresh Smart Shop Data
        async function refreshSmartShopData() {
            if (confirm('üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ\n\nÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ© ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü')) {
                try {
                    // Reload shops_details.json
                    const response = await fetch('shops_details.json?' + new Date().getTime());
                    if (response.ok) {
                        shopsDetails = await response.json();
                    }
                    
                    // Reload plan-data.json
                    const planResponse = await fetch('plan-data.json?' + new Date().getTime());
                    if (planResponse.ok) {
                        planData = await planResponse.json();
                    }
                    
                    alert('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!');
                    updateSmartShopList();
                    
                } catch (error) {
                    console.error('Error refreshing data:', error);
                    alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message);
                }
            }
        }
        
        // Open Advanced Shop Search
        function openAdvancedShopSearch() {
            const searchOptions = [
                'üîç ÿ®ÿ≠ÿ´ ŸÖÿ™ŸÇÿØŸÖ ŸÅŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™',
                '',
                '1. ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ (ÿπÿ±ÿ®Ÿä/ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä)',
                '2. ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ',
                '3. ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ŸÉŸàÿØ ADM',
                '4. ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑŸÜÿ¥ÿßÿ∑',
                '5. ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿπŸÜŸàÿßŸÜ',
                '6. ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ',
                '',
                'ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ®ÿ≠ÿ´ (1-6):'
            ].join('\n');
            
            const choice = prompt(searchOptions);
            if (!choice) return;
            
            const searchTerm = prompt('üîç ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑÿ®ÿ≠ÿ´:');
            if (!searchTerm) return;
            
            performAdvancedSearch(parseInt(choice), searchTerm);
        }
        
        // Perform Advanced Search
        function performAdvancedSearch(searchType, searchTerm) {
            const results = [];
            const term = searchTerm.toLowerCase();
            
            Object.entries(shopsDetails).forEach(([shopName, shop]) => {
                let match = false;
                
                switch(searchType) {
                    case 1: // Name
                        match = shopName.toLowerCase().includes(term) || 
                               (shop.nameEn && shop.nameEn.toLowerCase().includes(term));
                        break;
                    case 2: // License
                        match = shop.licenseNo && shop.licenseNo.toLowerCase().includes(term);
                        break;
                    case 3: // ADM Code
                        match = shop.admCode && shop.admCode.toLowerCase().includes(term);
                        break;
                    case 4: // Activity
                        match = shop.activity && shop.activity.toLowerCase().includes(term);
                        break;
                    case 5: // Address
                        match = shop.address && shop.address.toLowerCase().includes(term);
                        break;
                    case 6: // Phone
                        match = shop.contact && shop.contact.includes(term);
                        break;
                }
                
                if (match) {
                    results.push(shopName);
                }
            });
            
            if (results.length === 0) {
                alert('üîç ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÖÿ∑ÿßÿ®ŸÇÿ©');
            } else {
                const resultsList = results.slice(0, 20).join('\n‚Ä¢ ');
                const more = results.length > 20 ? `\n\n... Ÿà ${results.length - 20} ŸÜÿ™Ÿäÿ¨ÿ© ÿ£ÿÆÿ±Ÿâ` : '';
                alert(`‚úÖ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${results.length} ŸÜÿ™Ÿäÿ¨ÿ©:\n\n‚Ä¢ ${resultsList}${more}`);
            }
        }
        
        // Create Shops Backup
        function createShopsBackup() {
            try {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `shops_backup_${timestamp}.json`;
                
                const dataStr = JSON.stringify(shopsDetails, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);
                
                alert(`‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüìÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ:\n${filename}\n\nüíæ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ${Object.keys(shopsDetails).length} ŸÖÿ≠ŸÑ`);
                
            } catch (error) {
                console.error('Error creating backup:', error);
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ' + error.message);
            }
        }
        
        // Select All Shops in List
        function selectAllShopsInList() {
            Object.keys(shopsDetails).forEach(shopName => {
                selectedShopsForBatch.add(shopName);
            });
            
            alert(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ\n\nŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ¨ŸÖÿßÿπŸäÿ©`);
            updateSmartShopList();
        }
        
        // Deselect All Shops in List
        function deselectAllShopsInList() {
            const count = selectedShopsForBatch.size;
            selectedShopsForBatch.clear();
            
            alert(`‚úÖ ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ™ÿ≠ÿØŸäÿØ ${count} ŸÖÿ≠ŸÑ`);
            updateSmartShopList();
        }
        
        // Select High Priority Shops in List
        function selectHighPriorityShopsInList() {
            selectedShopsForBatch.clear();
            
            Object.keys(shopsDetails).forEach(shopName => {
                const ratingData = calculateShopRating(shopName);
                if (ratingData.rating < 70) { // High priority = low rating
                    selectedShopsForBatch.add(shopName);
                }
            });
            
            alert(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ ÿ∞Ÿà ÿ£ŸàŸÑŸàŸäÿ© ÿπÿßŸÑŸäÿ©\n\n‚ö†Ô∏è ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ∞ÿßÿ™ ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÖŸÜÿÆŸÅÿ∂ (ÿ£ŸÇŸÑ ŸÖŸÜ 70)`);
            updateSmartShopList();
        }
        
        // Export Selected Shops
        function exportSelectedShops() {
            if (selectedShopsForBatch.size === 0) {
                alert('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿ£Ÿä ŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±');
                return;
            }
            
            try {
                const selectedData = {};
                selectedShopsForBatch.forEach(shopName => {
                    if (shopsDetails[shopName]) {
                        selectedData[shopName] = shopsDetails[shopName];
                    }
                });
                
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `selected_shops_${timestamp}.json`;
                
                const dataStr = JSON.stringify(selectedData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);
                
                alert(`‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ ŸÖÿ≠ÿØÿØ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüìÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ:\n${filename}`);
                
            } catch (error) {
                console.error('Error exporting selected shops:', error);
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿµÿØŸäÿ±: ' + error.message);
            }
        }
        
        // Apply Batch Operation
        function applyBatchOperation() {
            if (selectedShopsForBatch.size === 0) {
                alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿØ ŸÖÿ≠ŸÑÿßÿ™ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            
            const operations = [
                '‚öôÔ∏è ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ¨ŸÖÿßÿπŸäÿ© ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©:',
                '',
                '1. ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÖÿ≠ÿØÿØ ÿ•ŸÑŸâ Excel',
                '2. ÿ∑ÿ®ÿßÿπÿ© ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ÿØÿØ',
                '3. ŸÜÿ≥ÿÆ ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ≠ÿØÿØ',
                '4. ÿ≠ÿ≥ÿßÿ® ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØ',
                '5. ÿ™ÿ∑ÿ®ŸäŸÇ ÿ™ÿπÿØŸäŸÑ ÿ¨ŸÖÿßÿπŸä',
                '',
                'ÿßÿÆÿ™ÿ± ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸÑŸäÿ© (1-5):'
            ].join('\n');
            
            const choice = prompt(operations);
            if (!choice) return;
            
            switch(choice) {
                case '1':
                    exportSelectedToExcel();
                    break;
                case '2':
                    printSelectedShops();
                    break;
                case '3':
                    copySelectedShopNames();
                    break;
                case '4':
                    calculateSelectedStats();
                    break;
                case '5':
                    showBulkEditInterface();
                    break;
                default:
                    alert('‚ùå ÿßÿÆÿ™Ÿäÿßÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');
            }
        }
        
        // Export Selected to Excel
        function exportSelectedToExcel() {
            try {
                const exportData = [];
                
                selectedShopsForBatch.forEach(shopName => {
                    const shop = shopsDetails[shopName];
                    if (shop) {
                        exportData.push({
                            'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ': shopName,
                            'ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©': shop.nameEn || '',
                            'ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©': shop.area || '',
                            'ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ': shop.licenseNo || '',
                            'ŸÉŸàÿØ ADM': shop.admCode || '',
                            'ÿßŸÑÿπŸÜŸàÿßŸÜ': shop.address || '',
                            'ÿßŸÑŸáÿßÿ™ŸÅ': shop.contact || '',
                            'ÿßŸÑŸÜÿ¥ÿßÿ∑': shop.activity || ''
                        });
                    }
                });
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                XLSX.utils.book_append_sheet(wb, ws, 'ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©');
                
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `selected_shops_${timestamp}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                alert(`‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ ÿ•ŸÑŸâ Excel ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüìÑ ${filename}`);
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿµÿØŸäÿ±: ' + error.message);
            }
        }
        
        // Print Selected Shops
        function printSelectedShops() {
            const shopsList = Array.from(selectedShopsForBatch).map((name, i) => {
                const shop = shopsDetails[name];
                return `${i + 1}. ${name}\n   ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: ${shop.area || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}\n   ÿßŸÑÿ™ÿ±ÿÆŸäÿµ: ${shop.licenseNo || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}`;
            }).join('\n\n');
            
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`
                <html>
                <head>
                    <title>ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©</title>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: Arial, sans-serif; direction: rtl; padding: 20px; }
                        h1 { color: #667eea; text-align: center; }
                        pre { white-space: pre-wrap; line-height: 1.6; }
                    </style>
                </head>
                <body>
                    <h1>ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ© (${selectedShopsForBatch.size} ŸÖÿ≠ŸÑ)</h1>
                    <p>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©: ${new Date().toLocaleString('ar-EG')}</p>
                    <hr>
                    <pre>${shopsList}</pre>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Copy Selected Shop Names
        function copySelectedShopNames() {
            const names = Array.from(selectedShopsForBatch).join('\n');
            
            navigator.clipboard.writeText(names).then(() => {
                alert(`‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ${selectedShopsForBatch.size} ÿßÿ≥ŸÖ ŸÖÿ≠ŸÑ ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©!\n\nŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ŸÑÿµŸÇŸáÿß ŸÅŸä ÿ£Ÿä ŸÖŸÉÿßŸÜ`);
            }).catch(err => {
                alert('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ: ' + err.message);
            });
        }
        
        // Calculate Selected Stats
        function calculateSelectedStats() {
            const stats = {
                total: selectedShopsForBatch.size,
                withLicense: 0,
                withAdmCode: 0,
                withPhone: 0,
                withActivity: 0,
                withLocation: 0,
                avgRating: 0
            };
            
            let totalRating = 0;
            
            selectedShopsForBatch.forEach(shopName => {
                const shop = shopsDetails[shopName];
                if (!shop) return;
                
                if (shop.licenseNo) stats.withLicense++;
                if (shop.admCode) stats.withAdmCode++;
                if (shop.contact) stats.withPhone++;
                if (shop.activity) stats.withActivity++;
                if (shop.locationMap) stats.withLocation++;
                
                const ratingData = calculateShopRating(shopName);
                totalRating += ratingData.rating;
            });
            
            stats.avgRating = (totalRating / stats.total).toFixed(1);
            
            const report = `üìä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©\n\n` +
                          `üìà ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™: ${stats.total}\n` +
                          `üîñ ŸÑÿØŸäŸáÿß ÿ™ÿ±ÿÆŸäÿµ: ${stats.withLicense}\n` +
                          `üî¢ ŸÑÿØŸäŸáÿß ŸÉŸàÿØ ADM: ${stats.withAdmCode}\n` +
                          `üìû ŸÑÿØŸäŸáÿß Ÿáÿßÿ™ŸÅ: ${stats.withPhone}\n` +
                          `üíº ŸÑÿØŸäŸáÿß ŸÜÿ¥ÿßÿ∑ ŸÖÿ≠ÿØÿØ: ${stats.withActivity}\n` +
                          `üó∫Ô∏è ŸÑÿØŸäŸáÿß ŸÖŸàŸÇÿπ ÿÆÿ±ÿßÿ¶ÿ∑: ${stats.withLocation}\n` +
                          `‚≠ê ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ: ${stats.avgRating}%\n\n` +
                          `üìù ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿßŸÉÿ™ŸÖÿßŸÑ:\n` +
                          `‚Ä¢ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ: ${((stats.withLicense / stats.total) * 100).toFixed(1)}%\n` +
                          `‚Ä¢ ŸÉŸàÿØ ADM: ${((stats.withAdmCode / stats.total) * 100).toFixed(1)}%\n` +
                          `‚Ä¢ ÿßŸÑŸáÿßÿ™ŸÅ: ${((stats.withPhone / stats.total) * 100).toFixed(1)}%\n` +
                          `‚Ä¢ ÿßŸÑŸÜÿ¥ÿßÿ∑: ${((stats.withActivity / stats.total) * 100).toFixed(1)}%\n` +
                          `‚Ä¢ ÿßŸÑŸÖŸàŸÇÿπ: ${((stats.withLocation / stats.total) * 100).toFixed(1)}%`;
            
            alert(report);
        }
        
        // Toggle Shop Selection for batch operations
        function toggleShopSelection(shopName) {
            if (selectedShopsForBatch.has(shopName)) {
                selectedShopsForBatch.delete(shopName);
            } else {
                selectedShopsForBatch.add(shopName);
            }
            updateSmartShopList();
        }
        
        // Edit Shop from Smart List
        function editShopFromSmartList(shopName) {
            // Check if planData is loaded
            if (!planData) {
                alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿ≠ÿ™Ÿâ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                return;
            }
            
            // Initialize shops array if it doesn't exist
            if (!planData.shops) {
                planData.shops = [];
            }
            
            // Find the shop in planData.shops to get the ID
            const planShop = planData.shops.find(s => s.name === shopName);
            if (!planShop) {
                // Shop might be in shops_details.json but not in plan-data yet
                // Open edit modal with the shop name, it will create a new entry
                openEditShopModal(shopName);
                return;
            }
            
            // Open the edit modal using the existing openEditShopModal function
            openEditShopModal(planShop.id);
        }
        
        // Delete Shop from Smart List
        function deleteShopFromSmartList(shopName) {
            const shop = shopsDetails[shopName];
            if (!shop) {
                alert('‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑ');
                return;
            }
            
            const details = [
                `‚ö†Ô∏è ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑ`,
                '',
                `ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ: ${shopName}`,
                `ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: ${shop.area || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}`,
                `ÿßŸÑÿ™ÿ±ÿÆŸäÿµ: ${shop.licenseNo || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}`,
                '',
                `Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá!`,
                '',
                `ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ≠ÿ∞ŸÅÿü`
            ].join('\n');
            
            if (confirm(details)) {
                delete shopsDetails[shopName];
                selectedShopsForBatch.delete(shopName);
                
                alert('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüíæ ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub');
                updateSmartShopList();
            }
        }
        
        // =========================================================================
        // Bell Notifications Control Functions
        // =========================================================================
        
        // Open Bell Notifications Control Modal
        async function openBellNotificationsControl() {
            if (!githubToken) {
                alert('‚ö†Ô∏è Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã ŸÑŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
                return;
            }
            
            // Show modal
            document.getElementById('bellNotificationsModal').classList.add('show');
            
            // Load notifications from plan-data.json
            await loadBellNotifications();
        }
        
        // Close Bell Notifications Control Modal
        function closeBellNotificationsControl() {
            document.getElementById('bellNotificationsModal').classList.remove('show');
        }
        
        // Load Bell Notifications from plan-data.json
        async function loadBellNotifications() {
            try {
                showBellStatusMessage('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™...', 'info');
                
                // If planData is already loaded, use it
                if (planData && planData.bellNotes) {
                    console.log('Using already loaded planData');
                    displayBellNotifications();
                    loadBellSettings();
                    showBellStatusMessage('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ', 'success');
                    setTimeout(() => hideBellStatusMessage(), 2000);
                    return;
                }
                
                // Otherwise, fetch from server
                const response = await fetch('plan-data.json?' + new Date().getTime());
                if (!response.ok) {
                    throw new Error('ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                }
                
                const data = await response.json();
                planData = data;
                
                // Display notifications
                displayBellNotifications();
                loadBellSettings();
                
                showBellStatusMessage('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ', 'success');
                setTimeout(() => hideBellStatusMessage(), 2000);
            } catch (error) {
                console.error('Error loading bell notifications:', error);
                showBellStatusMessage('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™: ' + error.message + '\n\nÿ≥Ÿäÿ™ŸÖ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ...', 'error');
                
                // Retry with current planData if available
                if (planData) {
                    setTimeout(() => {
                        displayBellNotifications();
                        loadBellSettings();
                        showBellStatusMessage('ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÖŸÑÿ© ŸÖÿ≥ÿ®ŸÇÿßŸã ‚úÖ', 'success');
                    }, 1000);
                }
            }
        }
        
        // Display Bell Notifications
        function displayBellNotifications() {
            const container = document.getElementById('bellNotificationsList');
            
            // Initialize bellNotes if it doesn't exist
            if (!planData.bellNotes) {
                planData.bellNotes = { notifications: [] };
            }
            
            if (!planData.bellNotes.notifications) {
                planData.bellNotes.notifications = [];
            }
            
            // Check if there are no notifications
            if (planData.bellNotes.notifications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 3em; margin-bottom: 10px;">üì≠</div>
                        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ≠ÿßŸÑŸäÿßŸã</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ ÿ£ÿπŸÑÿßŸá ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ¥ÿπÿßÿ± ÿ¨ÿØŸäÿØ</p>
                    </div>
                `;
                return;
            }
            
            // Display notifications
            let html = '';
            planData.bellNotes.notifications.forEach((notification, index) => {
                const timestamp = notification.timestamp ? new Date(notification.timestamp).toLocaleString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                
                const author = notification.author || 'ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ';
                const priority = notification.priority || 'medium';
                const displayDuration = notification.displayDuration || 7;
                const expiryDate = notification.expiryDate || null;
                
                // Calculate if notification is expired
                const isExpired = expiryDate && new Date(expiryDate) < new Date();
                const expiredClass = isExpired ? 'opacity: 0.5; text-decoration: line-through;' : '';
                
                // Priority icons
                const priorityIcons = {
                    high: 'üî¥',
                    medium: 'üü°',
                    low: 'üü¢'
                };
                
                html += `
                    <div class="notification-item priority-${priority}" style="${expiredClass}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div class="notification-text" id="bellNotifText_${index}" onclick="editBellNotification(${index})">
                                    ${notification.text}
                                </div>
                                <textarea 
                                    class="notification-edit-textarea" 
                                    id="bellNotifEdit_${index}"
                                    dir="rtl"
                                >${notification.text}</textarea>
                            </div>
                            <div style="display: flex; gap: 5px; margin-right: 10px;">
                                ${index > 0 ? `<button class="notification-action-btn notification-move-btn" onclick="moveBellNotificationUp(${index})" title="ŸÜŸÇŸÑ ŸÑÿ£ÿπŸÑŸâ">‚¨ÜÔ∏è</button>` : ''}
                                ${index < planData.bellNotes.notifications.length - 1 ? `<button class="notification-action-btn notification-move-btn" onclick="moveBellNotificationDown(${index})" title="ŸÜŸÇŸÑ ŸÑÿ£ÿ≥ŸÅŸÑ">‚¨áÔ∏è</button>` : ''}
                            </div>
                        </div>
                        
                        <div id="bellAuthorEditContainer_${index}" style="display: none; margin-top: 10px;">
                            <label style="display: block; margin-bottom: 5px; color: #495057; font-weight: 500; font-size: 0.9em;">üë§ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ§ŸÑŸÅ/ÿßŸÑŸÖÿ±ÿ≥ŸÑ:</label>
                            <input 
                                type="text" 
                                id="bellAuthorEdit_${index}" 
                                value="${author}"
                                class="notification-author-input"
                                dir="rtl"
                            />
                        </div>
                        
                        <div id="bellSettingsContainer_${index}" style="display: none;" class="notification-settings">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label>üìå ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©:</label>
                                    <select id="bellPriorityEdit_${index}" style="width: 100%; padding: 8px; border: 2px solid #ced4da; border-radius: 8px;">
                                        <option value="high" ${priority === 'high' ? 'selected' : ''}>ÿπÿßŸÑŸäÿ© üî¥</option>
                                        <option value="medium" ${priority === 'medium' ? 'selected' : ''}>ŸÖÿ™Ÿàÿ≥ÿ∑ÿ© üü°</option>
                                        <option value="low" ${priority === 'low' ? 'selected' : ''}>ŸÖŸÜÿÆŸÅÿ∂ÿ© üü¢</option>
                                    </select>
                                </div>
                                <div>
                                    <label>‚è±Ô∏è ŸÖÿØÿ© ÿßŸÑÿπÿ±ÿ∂ (ÿ®ÿßŸÑÿ£ŸäÿßŸÖ):</label>
                                    <input type="number" id="bellDurationEdit_${index}" value="${displayDuration}" min="1" max="365" 
                                           style="width: 100%; padding: 8px; border: 2px solid #ced4da; border-radius: 8px;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="notification-meta">
                            <span>üìÖ ${timestamp}</span>
                            <span>üë§ ${author}</span>
                            <span>${priorityIcons[priority]} ${priority === 'high' ? 'ÿ£ŸàŸÑŸàŸäÿ© ÿπÿßŸÑŸäÿ©' : priority === 'medium' ? 'ÿ£ŸàŸÑŸàŸäÿ© ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©' : 'ÿ£ŸàŸÑŸàŸäÿ© ŸÖŸÜÿÆŸÅÿ∂ÿ©'}</span>
                            ${isExpired ? '<span style="color: #dc3545;">‚è∞ ŸÖŸÜÿ™ŸáŸä</span>' : `<span>‚è±Ô∏è ${displayDuration} ÿ£ŸäÿßŸÖ</span>`}
                        </div>
                        
                        <div class="notification-actions">
                            <button class="notification-action-btn notification-save-btn" id="bellSaveBtn_${index}" onclick="saveBellNotificationEdit(${index})">
                                ‚úÖ ÿ≠ŸÅÿ∏
                            </button>
                            <button class="notification-action-btn notification-cancel-btn" id="bellCancelBtn_${index}" onclick="cancelBellNotificationEdit(${index})">
                                ‚ùå ÿ•ŸÑÿ∫ÿßÿ°
                            </button>
                            <button class="notification-action-btn notification-priority-btn" onclick="toggleBellSettings(${index})">
                                ‚öôÔ∏è ÿ•ÿπÿØÿßÿØÿßÿ™
                            </button>
                            <button class="notification-action-btn notification-delete-btn" onclick="deleteBellNotification(${index})">
                                üóëÔ∏è ÿ≠ÿ∞ŸÅ
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Add Bell Notification
        function addBellNotification() {
            const textInput = document.getElementById('newBellNotificationText');
            const authorInput = document.getElementById('newBellNotificationAuthor');
            const priorityInput = document.getElementById('newBellNotificationPriority');
            const durationInput = document.getElementById('newBellNotificationDuration');
            
            const text = textInput.value.trim();
            const author = authorInput.value.trim();
            const priority = priorityInput.value;
            const displayDuration = parseInt(durationInput.value);
            
            if (!text) {
                alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ŸÉÿ™ÿßÿ®ÿ© ŸÜÿµ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±');
                return;
            }
            
            if (!author) {
                alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ŸÉÿ™ÿßÿ®ÿ© ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ§ŸÑŸÅ');
                return;
            }
            
            // Initialize bellNotes if needed
            if (!planData.bellNotes) {
                planData.bellNotes = { notifications: [], settings: {} };
            }
            
            if (!planData.bellNotes.notifications) {
                planData.bellNotes.notifications = [];
            }
            
            // Calculate expiry date
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + displayDuration);
            
            // Create new notification
            const newNotification = {
                id: Date.now().toString(),
                text: text,
                timestamp: new Date().toISOString(),
                author: author,
                priority: priority,
                displayDuration: displayDuration,
                expiryDate: expiryDate.toISOString()
            };
            
            // Add to beginning of array (most recent first)
            planData.bellNotes.notifications.unshift(newNotification);
            
            // Clear inputs
            textInput.value = '';
            // Keep author for convenience
            priorityInput.value = 'medium';
            durationInput.value = '7';
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠! ‚úÖ ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ "ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™" ŸÑŸÑŸÖÿ≤ÿßŸÖŸÜÿ©', 'success');
        }
        
        // Edit Bell Notification
        function editBellNotification(index) {
            const textDiv = document.getElementById(`bellNotifText_${index}`);
            const editTextarea = document.getElementById(`bellNotifEdit_${index}`);
            const authorEditContainer = document.getElementById(`bellAuthorEditContainer_${index}`);
            const saveBtn = document.getElementById(`bellSaveBtn_${index}`);
            const cancelBtn = document.getElementById(`bellCancelBtn_${index}`);
            
            textDiv.style.display = 'none';
            editTextarea.style.display = 'block';
            authorEditContainer.style.display = 'block';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
            
            editTextarea.focus();
        }
        
        // Save Bell Notification Edit
        function saveBellNotificationEdit(index) {
            const textDiv = document.getElementById(`bellNotifText_${index}`);
            const editTextarea = document.getElementById(`bellNotifEdit_${index}`);
            const authorEditContainer = document.getElementById(`bellAuthorEditContainer_${index}`);
            const authorEdit = document.getElementById(`bellAuthorEdit_${index}`);
            const settingsContainer = document.getElementById(`bellSettingsContainer_${index}`);
            const priorityEdit = document.getElementById(`bellPriorityEdit_${index}`);
            const durationEdit = document.getElementById(`bellDurationEdit_${index}`);
            const saveBtn = document.getElementById(`bellSaveBtn_${index}`);
            const cancelBtn = document.getElementById(`bellCancelBtn_${index}`);
            
            const newText = editTextarea.value.trim();
            const newAuthor = authorEdit.value.trim();
            const newPriority = priorityEdit ? priorityEdit.value : (planData.bellNotes.notifications[index].priority || 'medium');
            const newDuration = durationEdit ? parseInt(durationEdit.value) : (planData.bellNotes.notifications[index].displayDuration || 7);
            
            if (!newText) {
                alert('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ŸÅÿßÿ±ÿ∫ÿßŸã');
                return;
            }
            
            if (!newAuthor) {
                alert('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ§ŸÑŸÅ ŸÅÿßÿ±ÿ∫ÿßŸã');
                return;
            }
            
            // Calculate new expiry date
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + newDuration);
            
            // Update notification
            planData.bellNotes.notifications[index].text = newText;
            planData.bellNotes.notifications[index].author = newAuthor;
            planData.bellNotes.notifications[index].priority = newPriority;
            planData.bellNotes.notifications[index].displayDuration = newDuration;
            planData.bellNotes.notifications[index].expiryDate = expiryDate.toISOString();
            planData.bellNotes.notifications[index].lastModified = new Date().toISOString();
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠! ‚úÖ ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ "ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™" ŸÑŸÑŸÖÿ≤ÿßŸÖŸÜÿ©', 'success');
        }
        
        // Cancel Bell Notification Edit
        function cancelBellNotificationEdit(index) {
            const textDiv = document.getElementById(`bellNotifText_${index}`);
            const editTextarea = document.getElementById(`bellNotifEdit_${index}`);
            const authorEditContainer = document.getElementById(`bellAuthorEditContainer_${index}`);
            const authorEdit = document.getElementById(`bellAuthorEdit_${index}`);
            const saveBtn = document.getElementById(`bellSaveBtn_${index}`);
            const cancelBtn = document.getElementById(`bellCancelBtn_${index}`);
            
            // Reset to original values
            editTextarea.value = planData.bellNotes.notifications[index].text;
            authorEdit.value = planData.bellNotes.notifications[index].author || 'ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ';
            
            textDiv.style.display = 'block';
            editTextarea.style.display = 'none';
            authorEditContainer.style.display = 'none';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }
        
        // Delete Bell Notification
        function deleteBellNotification(index) {
            if (!confirm('‚ö†Ô∏è ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅŸá ŸÜŸáÿßÿ¶ŸäÿßŸã ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿ®ÿπÿØ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©.')) {
                return;
            }
            
            // Remove notification
            planData.bellNotes.notifications.splice(index, 1);
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠! ‚úÖ ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ "ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™" ŸÑŸÑŸÖÿ≤ÿßŸÖŸÜÿ©', 'success');
        }
        
        // Save All Bell Notifications to GitHub
        async function saveAllBellNotifications() {
            if (!githubToken) {
                alert('‚ö†Ô∏è Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHubÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ŸÅŸàÿ±ÿßŸã.')) {
                return;
            }
            
            try {
                showBellStatusMessage('ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸàÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub...', 'info');
                
                // Get current file SHA
                const getResponse = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error('ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÑŸÅ');
                }
                
                const fileData = await getResponse.json();
                const sha = fileData.sha;
                
                // Update lastUpdate
                planData.lastUpdate = new Date().toISOString();
                
                // Convert to JSON
                const jsonContent = JSON.stringify(planData, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(jsonContent)));
                
                // Commit to GitHub
                const updateResponse = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ¨ÿ±ÿ≥ - ${new Date().toLocaleString('ar-EG')}`,
                        content: encodedContent,
                        sha: sha,
                        branch: 'main'
                    })
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.message || 'ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™');
                }
                
                showBellStatusMessage('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nÿ≥ÿ™ÿ∏Ÿáÿ± ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÅŸàÿ±ÿßŸã ŸÅŸä ÿßŸÑÿ¨ÿ±ÿ≥ üîî ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©', 'success');
                
                // Reload notifications to confirm
                setTimeout(() => {
                    loadBellNotifications();
                }, 2000);
                
            } catch (error) {
                console.error('Error saving bell notifications:', error);
                showBellStatusMessage('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™: ' + error.message, 'error');
            }
        }
        
        // Show Bell Status Message
        function showBellStatusMessage(message, type) {
            const messageDiv = document.getElementById('bellStatusMessage');
            messageDiv.textContent = message;
            messageDiv.className = 'bell-status-message show ' + type;
        }
        
        // Hide Bell Status Message
        function hideBellStatusMessage() {
            const messageDiv = document.getElementById('bellStatusMessage');
            messageDiv.classList.remove('show');
        }
        
        // =========================================================================
        // Enhanced Bell Notification Functions
        // =========================================================================
        
        // Toggle Bell Settings
        function toggleBellSettings(index) {
            const settingsContainer = document.getElementById(`bellSettingsContainer_${index}`);
            if (settingsContainer.style.display === 'none') {
                settingsContainer.style.display = 'block';
            } else {
                settingsContainer.style.display = 'none';
            }
        }
        
        // Move Bell Notification Up
        function moveBellNotificationUp(index) {
            if (index === 0) return;
            
            // Swap with previous
            const temp = planData.bellNotes.notifications[index];
            planData.bellNotes.notifications[index] = planData.bellNotes.notifications[index - 1];
            planData.bellNotes.notifications[index - 1] = temp;
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('ÿ™ŸÖ ŸÜŸÇŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ŸÑÿ£ÿπŸÑŸâ ‚¨ÜÔ∏è ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™', 'success');
        }
        
        // Move Bell Notification Down
        function moveBellNotificationDown(index) {
            if (index >= planData.bellNotes.notifications.length - 1) return;
            
            // Swap with next
            const temp = planData.bellNotes.notifications[index];
            planData.bellNotes.notifications[index] = planData.bellNotes.notifications[index + 1];
            planData.bellNotes.notifications[index + 1] = temp;
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('ÿ™ŸÖ ŸÜŸÇŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ŸÑÿ£ÿ≥ŸÅŸÑ ‚¨áÔ∏è ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™', 'success');
        }
        
        // Sort Bell Notifications by Priority
        function sortBellNotificationsByPriority() {
            const priorityOrder = { high: 0, medium: 1, low: 2 };
            
            planData.bellNotes.notifications.sort((a, b) => {
                const priorityA = priorityOrder[a.priority || 'medium'];
                const priorityB = priorityOrder[b.priority || 'medium'];
                return priorityA - priorityB;
            });
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('ÿ™ŸÖ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© üîΩ ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™', 'success');
        }
        
        // Sort Bell Notifications by Date
        function sortBellNotificationsByDate() {
            planData.bellNotes.notifications.sort((a, b) => {
                const dateA = new Date(a.timestamp || 0);
                const dateB = new Date(b.timestamp || 0);
                return dateB - dateA; // Most recent first
            });
            
            // Refresh display
            displayBellNotifications();
            
            showBellStatusMessage('ÿ™ŸÖ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ üìÖ ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™', 'success');
        }
        
        // Delete Expired Notifications
        function deleteExpiredNotifications() {
            const now = new Date();
            const before = planData.bellNotes.notifications.length;
            
            planData.bellNotes.notifications = planData.bellNotes.notifications.filter(notification => {
                if (!notification.expiryDate) return true;
                return new Date(notification.expiryDate) >= now;
            });
            
            const after = planData.bellNotes.notifications.length;
            const deleted = before - after;
            
            if (deleted === 0) {
                showBellStatusMessage('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖŸÜÿ™ŸáŸäÿ© ŸÑŸÑÿ≠ÿ∞ŸÅ ‚úÖ', 'success');
            } else {
                displayBellNotifications();
                showBellStatusMessage(`ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${deleted} ÿ•ÿ¥ÿπÿßÿ± ŸÖŸÜÿ™ŸáŸä üóëÔ∏è ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™`, 'success');
            }
        }
        
        // Load Bell Settings
        function loadBellSettings() {
            // Initialize settings if they don't exist
            if (!planData.bellNotes.settings) {
                planData.bellNotes.settings = {
                    bubbleDuration: 24,
                    soundEnabled: true,
                    displayStyle: 'modern'
                };
            }
            
            // Load settings into UI
            const bubbleDurationInput = document.getElementById('bellBubbleDuration');
            const soundEnabledSelect = document.getElementById('bellSoundEnabled');
            const displayStyleSelect = document.getElementById('bellDisplayStyle');
            
            if (bubbleDurationInput) {
                bubbleDurationInput.value = planData.bellNotes.settings.bubbleDuration || 24;
            }
            
            if (soundEnabledSelect) {
                soundEnabledSelect.value = planData.bellNotes.settings.soundEnabled !== false ? 'true' : 'false';
            }
            
            if (displayStyleSelect) {
                displayStyleSelect.value = planData.bellNotes.settings.displayStyle || 'modern';
            }
        }
        
        // Update Bell Bubble Duration
        function updateBellBubbleDuration() {
            const bubbleDurationInput = document.getElementById('bellBubbleDuration');
            const duration = parseInt(bubbleDurationInput.value);
            
            if (duration < 5 || duration > 120) {
                alert('‚ö†Ô∏è ŸÖÿØÿ© ÿßŸÑÿ∏ŸáŸàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ®ŸäŸÜ 5 Ÿà 120 ÿ´ÿßŸÜŸäÿ©');
                bubbleDurationInput.value = planData.bellNotes.settings.bubbleDuration || 24;
                return;
            }
            
            if (!planData.bellNotes.settings) {
                planData.bellNotes.settings = {};
            }
            
            planData.bellNotes.settings.bubbleDuration = duration;
            showBellStatusMessage(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿØÿ© ÿ∏ŸáŸàÿ± ÿßŸÑŸÅŸÇÿßÿπÿ© ÿ•ŸÑŸâ ${duration} ÿ´ÿßŸÜŸäÿ© ‚è±Ô∏è ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™`, 'success');
        }
        
        // Update Bell Sound Setting
        function updateBellSoundSetting() {
            const soundEnabledSelect = document.getElementById('bellSoundEnabled');
            const soundEnabled = soundEnabledSelect.value === 'true';
            
            if (!planData.bellNotes.settings) {
                planData.bellNotes.settings = {};
            }
            
            planData.bellNotes.settings.soundEnabled = soundEnabled;
            showBellStatusMessage(`ÿ™ŸÖ ${soundEnabled ? 'ÿ™ŸÅÿπŸäŸÑ' : 'ÿ™ÿπÿ∑ŸäŸÑ'} ÿµŸàÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ üîî ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™`, 'success');
        }
        
        // Update Bell Display Style
        function updateBellDisplayStyle() {
            const displayStyleSelect = document.getElementById('bellDisplayStyle');
            const displayStyle = displayStyleSelect.value;
            
            if (!planData.bellNotes.settings) {
                planData.bellNotes.settings = {};
            }
            
            planData.bellNotes.settings.displayStyle = displayStyle;
            showBellStatusMessage(`ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ŸÜŸÖÿ∑ ÿßŸÑÿπÿ±ÿ∂ ÿ•ŸÑŸâ ${displayStyle === 'modern' ? 'ÿπÿµÿ±Ÿä' : displayStyle === 'classic' ? 'ŸÉŸÑÿßÿ≥ŸäŸÉŸä' : 'ÿ®ÿ≥Ÿäÿ∑'} üé® ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™`, 'success');
        }
    </script>
    
    <!-- Hand Gesture Control Modal -->
    <div id="gestureModal" class="gesture-modal">
        <div class="gesture-modal-content">
            <span class="gesture-close" onclick="closeGestureControl()">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px; font-size: 2em;">
                ‚úã ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ∞ŸÉŸä ÿ®ÿ≠ÿ±ŸÉÿ© ÿßŸÑŸäÿØ
            </h2>
            
            <div class="gesture-video-container">
                <video id="gestureVideo" class="gesture-video" autoplay playsinline></video>
                <canvas id="gestureCanvas" class="gesture-canvas"></canvas>
            </div>
            
            <div class="gesture-status">
                <h3>ÿßŸÑÿ≠ÿßŸÑÿ©: <span id="gestureStatusText">ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿØÿ° ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß...</span></h3>
                <div class="gesture-detected" id="gestureDetected">---</div>
                <p id="gestureAction" style="font-size: 1.2em; margin-top: 10px;">ŸÑÿß ŸäŸàÿ¨ÿØ ÿ•ÿ¨ÿ±ÿßÿ°</p>
            </div>
            
            <div class="gesture-guide">
                <h3>üéØ ÿØŸÑŸäŸÑ ÿ≠ÿ±ŸÉÿßÿ™ ÿßŸÑŸäÿØ</h3>
                
                <div class="gesture-item">
                    <div class="gesture-icon">üëâ</div>
                    <div class="gesture-description">
                        <strong>ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑŸäŸÖŸäŸÜ</strong>
                        <span>ÿ≠ÿ±ŸÉ ŸäÿØŸÉ ŸÖŸÜ ÿßŸÑŸäÿ≥ÿßÿ± ÿ•ŸÑŸâ ÿßŸÑŸäŸÖŸäŸÜ ‚Üí ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÑÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿ™ÿßŸÑŸä</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">üëà</div>
                    <div class="gesture-description">
                        <strong>ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑŸäÿ≥ÿßÿ±</strong>
                        <span>ÿ≠ÿ±ŸÉ ŸäÿØŸÉ ŸÖŸÜ ÿßŸÑŸäŸÖŸäŸÜ ÿ•ŸÑŸâ ÿßŸÑŸäÿ≥ÿßÿ± ‚Üí ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÑÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿ≥ÿßÿ®ŸÇ</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">üëÜ</div>
                    <div class="gesture-description">
                        <strong>ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑÿ£ÿπŸÑŸâ</strong>
                        <span>ÿ≠ÿ±ŸÉ ŸäÿØŸÉ ŸÖŸÜ ÿßŸÑÿ£ÿ≥ŸÅŸÑ ÿ•ŸÑŸâ ÿßŸÑÿ£ÿπŸÑŸâ ‚Üí ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑÿ£ÿπŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ©</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">üëá</div>
                    <div class="gesture-description">
                        <strong>ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑÿ£ÿ≥ŸÅŸÑ</strong>
                        <span>ÿ≠ÿ±ŸÉ ŸäÿØŸÉ ŸÖŸÜ ÿßŸÑÿ£ÿπŸÑŸâ ÿ•ŸÑŸâ ÿßŸÑÿ£ÿ≥ŸÅŸÑ ‚Üí ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑÿ£ÿ≥ŸÅŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">‚úã</div>
                    <div class="gesture-description">
                        <strong>ÿ±ÿßÿ≠ÿ© ÿßŸÑŸäÿØ ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ©</strong>
                        <span>ÿßŸÅÿ™ÿ≠ ŸÉŸÅ ŸäÿØŸÉ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ ‚Üí ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÖÿ§ŸÇÿ™ÿßŸã</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">‚úä</div>
                    <div class="gesture-description">
                        <strong>ŸÇÿ®ÿ∂ÿ© ÿßŸÑŸäÿØ ÿßŸÑŸÖÿ∫ŸÑŸÇÿ©</strong>
                        <span>ÿ£ÿ∫ŸÑŸÇ ŸÇÿ®ÿ∂ÿ© ŸäÿØŸÉ ‚Üí ÿßŸÑŸÜŸÇÿ± ÿ£Ÿà ÿßŸÑÿ™ŸÅÿπŸäŸÑ</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">‚òùÔ∏è</div>
                    <div class="gesture-description">
                        <strong>ÿßŸÑÿ•ÿ¥ÿßÿ±ÿ© ÿ®ÿßŸÑÿ≥ÿ®ÿßÿ®ÿ©</strong>
                        <span>ÿ£ÿ¥ÿ± ÿ®ÿ•ÿµÿ®ÿπ ÿßŸÑÿ≥ÿ®ÿßÿ®ÿ© ŸÅŸÇÿ∑ ‚Üí ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿØŸÇŸäŸÇ ŸàÿßŸÑÿ™ŸÜŸÇŸÑ</span>
                    </div>
                </div>
                
                <div class="gesture-item">
                    <div class="gesture-icon">‚úåÔ∏è</div>
                    <div class="gesture-description">
                        <strong>ÿπŸÑÿßŸÖÿ© ÿßŸÑŸÜÿµÿ± (ÿ•ÿµÿ®ÿπÿßŸÜ)</strong>
                        <span>ÿ£ÿ¥ÿ± ÿ®ÿ•ÿµÿ®ÿπŸäŸÜ ‚Üí ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-danger" onclick="closeGestureControl()" style="padding: 15px 40px; font-size: 1.2em;">
                    ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿ®ÿ≠ÿ±ŸÉÿ© ÿßŸÑŸäÿØ
                </button>
            </div>
        </div>
    </div>
    
    <!-- Background Music Volume Control Modal -->
    <div id="volumeModal" class="volume-modal">
        <div class="volume-modal-content">
            <span class="volume-close" onclick="closeVolumeControl()">&times;</span>
            <h2 style="text-align: center; margin-bottom: 10px; font-size: 2em;">
                üéµ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿµŸàÿ™ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ÿßŸÑÿÆŸÑŸÅŸäÿ©
            </h2>
            <p style="text-align: center; font-size: 0.95em; opacity: 0.9; margin-bottom: 20px;">
                ÿßÿ∂ÿ®ÿ∑ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿµŸàÿ™ ÿ≠ÿ≥ÿ® ÿ™ŸÅÿ∂ŸäŸÑÿßÿ™ŸÉ
            </p>
            
            <div class="volume-slider-container">
                <div class="volume-display-big" id="volumeDisplayBig">
                    üîä 1%
                </div>
                
                <input type="range" id="mainVolumeSlider" class="volume-slider" 
                       min="0" max="100" value="1" 
                       oninput="updateMainVolumeDisplay(this.value)">
                
                <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 1.1em;">
                    <span>üîá ÿµÿßŸÖÿ™</span>
                    <span>üîä ÿπÿßŸÑŸä</span>
                </div>
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px; margin: 20px 0;">
                <h3 style="margin: 0 0 15px 0; text-align: center; font-size: 1.3em;">ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ©</h3>
                <div class="volume-presets">
                    <button class="volume-preset-btn" onclick="setVolumePreset(0)">
                        üîá<br>ÿµÿßŸÖÿ™<br>0%
                    </button>
                    <button class="volume-preset-btn" onclick="setVolumePreset(1)">
                        üîâ<br>ŸÖŸÜÿÆŸÅÿ∂ ÿ¨ÿØÿßŸã<br>1%
                    </button>
                    <button class="volume-preset-btn" onclick="setVolumePreset(5)">
                        üîâ<br>ŸÖŸÜÿÆŸÅÿ∂<br>5%
                    </button>
                    <button class="volume-preset-btn" onclick="setVolumePreset(10)">
                        üîä<br>ŸÖÿ™Ÿàÿ≥ÿ∑<br>10%
                    </button>
                    <button class="volume-preset-btn" onclick="setVolumePreset(25)">
                        üîä<br>ŸÖÿ±ÿ™ŸÅÿπ<br>25%
                    </button>
                    <button class="volume-preset-btn" onclick="setVolumePreset(50)">
                        üîä<br>ÿπÿßŸÑŸä<br>50%
                    </button>
                </div>
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin: 20px 0;">
                <h4 style="margin: 0 0 10px 0; font-size: 1.1em;">üí° ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖŸáŸÖÿ©:</h4>
                <ul style="margin: 0; padding-right: 20px; line-height: 1.8; font-size: 0.95em;">
                    <li>ÿßŸÑÿ•ÿπÿØÿßÿØ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä: 1% (ŸÖŸÜÿÆŸÅÿ∂ ÿ¨ÿØÿßŸã - ŸÖŸàÿµŸâ ÿ®Ÿá)</li>
                    <li>Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ŸÉ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÅŸä GitHub</li>
                    <li>ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ™ÿ∑ÿ®ŸÇ ŸÅŸàÿ±ÿßŸã ÿπŸÑŸâ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</li>
                    <li>ŸÑŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ£ŸÖÿ´ŸÑ: ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸÜÿ≥ÿ®ÿ© ÿ®ŸäŸÜ 1-5%</li>
                </ul>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap; justify-content: center;">
                <button onclick="saveVolumeSettings()" 
                        style="background: white; color: #f5576c; border: none; padding: 15px 30px; 
                               border-radius: 10px; font-weight: bold; font-size: 1.1em; 
                               cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
                               font-family: 'Cairo', sans-serif; transition: all 0.3s ease;">
                    üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
                </button>
                
                <button onclick="testBackgroundMusic()" 
                        style="background: rgba(255, 255, 255, 0.2); color: white; 
                               border: 2px solid white; padding: 15px 30px; 
                               border-radius: 10px; font-weight: bold; font-size: 1.1em; 
                               cursor: pointer; font-family: 'Cairo', sans-serif; 
                               transition: all 0.3s ease;">
                    ‚ñ∂Ô∏è ÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑÿµŸàÿ™
                </button>
                
                <button onclick="closeVolumeControl()" 
                        style="background: rgba(255, 255, 255, 0.2); color: white; 
                               border: 2px solid white; padding: 15px 30px; 
                               border-radius: 10px; font-weight: bold; font-size: 1.1em; 
                               cursor: pointer; font-family: 'Cairo', sans-serif; 
                               transition: all 0.3s ease;">
                    ‚úñÔ∏è ÿ•ÿ∫ŸÑÿßŸÇ
                </button>
            </div>
        </div>
    </div>
    
    <!-- MediaPipe Hands Library -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <!-- Hand Gesture Control Script -->
    <script>
        // Global variables for gesture control
        let gestureControlActive = false;
        let camera = null;
        let hands = null;
        let lastGestureTime = 0;
        let gestureDebounceDelay = 800; // milliseconds between gestures
        let previousHandPosition = null;
        let gestureThreshold = 0.15; // Movement threshold for gesture detection
        
        // Tab management
        const tabs = ['add', 'view', 'stats', 'calendar', 'shops', 'areas', 'maintenance'];
        let currentTabIndex = 0;
        
        // Toggle gesture control
        function toggleGestureControl() {
            const modal = document.getElementById('gestureModal');
            const btn = document.getElementById('gestureControlBtn');
            
            if (!gestureControlActive) {
                modal.style.display = 'block';
                btn.classList.add('active');
                initializeGestureControl();
            } else {
                closeGestureControl();
            }
        }
        
        // Close gesture control
        function closeGestureControl() {
            const modal = document.getElementById('gestureModal');
            const btn = document.getElementById('gestureControlBtn');
            
            modal.style.display = 'none';
            btn.classList.remove('active');
            gestureControlActive = false;
            
            // Stop camera and cleanup
            if (camera) {
                camera.stop();
                camera = null;
            }
            
            const video = document.getElementById('gestureVideo');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            updateGestureStatus('ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿ®ÿ≠ÿ±ŸÉÿ© ÿßŸÑŸäÿØ', '---', '');
        }
        
        // Initialize gesture control
        async function initializeGestureControl() {
            try {
                gestureControlActive = true;
                updateGestureStatus('ÿ¨ÿßÿ±Ÿê ÿ™ÿ≠ŸÖŸäŸÑ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä...', '‚è≥', '');
                
                // Initialize MediaPipe Hands
                hands = new Hands({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    }
                });
                
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.7,
                    minTrackingConfidence: 0.7
                });
                
                hands.onResults(onHandsResults);
                
                // Setup camera
                const video = document.getElementById('gestureVideo');
                
                updateGestureStatus('ÿ¨ÿßÿ±Ÿê ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß...', 'üìπ', '');
                
                camera = new Camera(video, {
                    onFrame: async () => {
                        if (gestureControlActive) {
                            await hands.send({image: video});
                        }
                    },
                    width: 640,
                    height: 480
                });
                
                await camera.start();
                
                updateGestureStatus('ÿ¨ÿßŸáÿ≤! ÿ≠ÿ±ŸÉ ŸäÿØŸÉ ÿ£ŸÖÿßŸÖ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß', '‚úÖ', '');
                
            } catch (error) {
                console.error('Error initializing gesture control:', error);
                updateGestureStatus('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß', '‚ùå', 'ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß');
                
                // Show alert
                alert('ŸÅÿ¥ŸÑ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß. Ÿäÿ±ÿ¨Ÿâ:\n1. ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß\n2. ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿπÿØŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ŸÅŸä ÿ™ÿ∑ÿ®ŸäŸÇ ÿ¢ÿÆÿ±\n3. ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸäÿØÿπŸÖ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ©');
                
                closeGestureControl();
            }
        }
        
        // Process hand detection results
        function onHandsResults(results) {
            const canvas = document.getElementById('gestureCanvas');
            const canvasCtx = canvas.getContext('2d');
            
            // Set canvas size to match video
            canvas.width = results.image.width;
            canvas.height = results.image.height;
            
            // Clear canvas
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw hand landmarks
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                for (const landmarks of results.multiHandLandmarks) {
                    // Draw connections
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {
                        color: '#00FF00',
                        lineWidth: 3
                    });
                    
                    // Draw landmarks
                    drawLandmarks(canvasCtx, landmarks, {
                        color: '#FF0000',
                        lineWidth: 1,
                        radius: 4
                    });
                }
                
                // Detect gesture
                detectGesture(results.multiHandLandmarks[0]);
            } else {
                updateGestureStatus('ÿ¨ÿßŸáÿ≤! ÿ≠ÿ±ŸÉ ŸäÿØŸÉ ÿ£ŸÖÿßŸÖ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß', '‚úã', '');
                previousHandPosition = null;
            }
        }
        
        // Detect and process gestures
        function detectGesture(landmarks) {
            const now = Date.now();
            
            // Debounce gestures
            if (now - lastGestureTime < gestureDebounceDelay) {
                return;
            }
            
            // Get key landmarks
            const wrist = landmarks[0];
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const thumbTip = landmarks[4];
            const pinkyTip = landmarks[20];
            
            // Calculate hand center (wrist position)
            const currentPosition = {
                x: wrist.x,
                y: wrist.y,
                z: wrist.z
            };
            
            // Detect gestures based on movement and hand shape
            if (previousHandPosition) {
                const deltaX = currentPosition.x - previousHandPosition.x;
                const deltaY = currentPosition.y - previousHandPosition.y;
                
                // Swipe Right (Hand moves right)
                if (deltaX > gestureThreshold) {
                    executeGesture('swipe-right', 'ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑŸäŸÖŸäŸÜ üëâ', 'ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÑÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿ™ÿßŸÑŸä');
                    lastGestureTime = now;
                }
                // Swipe Left (Hand moves left)
                else if (deltaX < -gestureThreshold) {
                    executeGesture('swipe-left', 'ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑŸäÿ≥ÿßÿ± üëà', 'ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÑÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿ≥ÿßÿ®ŸÇ');
                    lastGestureTime = now;
                }
                // Swipe Up (Hand moves up)
                else if (deltaY < -gestureThreshold) {
                    executeGesture('swipe-up', 'ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑÿ£ÿπŸÑŸâ üëÜ', 'ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑÿ£ÿπŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ©');
                    lastGestureTime = now;
                }
                // Swipe Down (Hand moves down)
                else if (deltaY > gestureThreshold) {
                    executeGesture('swipe-down', 'ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑÿ£ÿ≥ŸÅŸÑ üëá', 'ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑÿ£ÿ≥ŸÅŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©');
                    lastGestureTime = now;
                }
            }
            
            // Detect hand shapes
            const fingersExtended = countExtendedFingers(landmarks);
            
            // Open palm (all 5 fingers extended)
            if (fingersExtended === 5) {
                if (now - lastGestureTime > gestureDebounceDelay * 2) {
                    updateGestureStatus('ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿ™ÿ≠ŸÉŸÖ', 'ÿ±ÿßÿ≠ÿ© ÿßŸÑŸäÿØ ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ© ‚úã', 'ÿ¨ÿßŸáÿ≤ ŸÑÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿßŸÑÿ≠ÿ±ŸÉÿ©');
                }
            }
            // Closed fist (no fingers extended)
            else if (fingersExtended === 0) {
                executeGesture('fist', 'ŸÇÿ®ÿ∂ÿ© ÿßŸÑŸäÿØ ‚úä', 'ÿßŸÑŸÜŸÇÿ±/ÿßŸÑÿ™ŸÅÿπŸäŸÑ');
                lastGestureTime = now;
            }
            // Index finger pointing (only index extended)
            else if (fingersExtended === 1 && isFingerExtended(landmarks, 8)) {
                if (now - lastGestureTime > gestureDebounceDelay * 2) {
                    updateGestureStatus('ÿ™ÿ≠ŸÉŸÖ ÿØŸÇŸäŸÇ', 'ÿßŸÑÿ•ÿ¥ÿßÿ±ÿ© ÿ®ÿßŸÑÿ≥ÿ®ÿßÿ®ÿ© ‚òùÔ∏è', 'ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿ™ŸÜŸÇŸÑ ÿßŸÑÿØŸÇŸäŸÇ');
                }
            }
            // Peace sign (index and middle extended)
            else if (fingersExtended === 2 && isFingerExtended(landmarks, 8) && isFingerExtended(landmarks, 12)) {
                executeGesture('peace', 'ÿπŸÑÿßŸÖÿ© ÿßŸÑŸÜÿµÿ± ‚úåÔ∏è', 'ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©');
                lastGestureTime = now;
            }
            
            // Update previous position
            previousHandPosition = currentPosition;
        }
        
        // Count extended fingers
        function countExtendedFingers(landmarks) {
            let count = 0;
            
            // Thumb (different calculation)
            if (landmarks[4].x < landmarks[3].x) count++;
            
            // Other fingers (8, 12, 16, 20 are tips; 6, 10, 14, 18 are middle joints)
            const fingerIndices = [
                [8, 6],   // Index
                [12, 10], // Middle
                [16, 14], // Ring
                [20, 18]  // Pinky
            ];
            
            for (const [tip, middle] of fingerIndices) {
                if (landmarks[tip].y < landmarks[middle].y) {
                    count++;
                }
            }
            
            return count;
        }
        
        // Check if specific finger is extended
        function isFingerExtended(landmarks, tipIndex) {
            const middleIndex = tipIndex - 2;
            return landmarks[tipIndex].y < landmarks[middleIndex].y;
        }
        
        // Execute gesture action
        function executeGesture(gestureType, gestureName, actionDescription) {
            updateGestureStatus('ÿ™ŸÖ ÿßŸÑŸÉÿ¥ŸÅ ÿπŸÜ ÿßŸÑÿ≠ÿ±ŸÉÿ©!', gestureName, actionDescription);
            
            // Perform action based on gesture
            switch(gestureType) {
                case 'swipe-right':
                    navigateToNextTab();
                    break;
                case 'swipe-left':
                    navigateToPreviousTab();
                    break;
                case 'swipe-up':
                    scrollPage(-300);
                    break;
                case 'swipe-down':
                    scrollPage(300);
                    break;
                case 'fist':
                    // Simulate click action
                    playClickSound();
                    break;
                case 'peace':
                    navigateToHome();
                    break;
            }
        }
        
        // Navigate to next tab
        function navigateToNextTab() {
            currentTabIndex = (currentTabIndex + 1) % tabs.length;
            switchTab(tabs[currentTabIndex]);
            playClickSound();
        }
        
        // Navigate to previous tab
        function navigateToPreviousTab() {
            currentTabIndex = (currentTabIndex - 1 + tabs.length) % tabs.length;
            switchTab(tabs[currentTabIndex]);
            playClickSound();
        }
        
        // Scroll page
        function scrollPage(amount) {
            window.scrollBy({
                top: amount,
                behavior: 'smooth'
            });
        }
        
        // Navigate to home
        function navigateToHome() {
            window.location.href = 'index.html';
        }
        
        // Play click sound (if available)
        function playClickSound() {
            try {
                const audio = new Audio();
                audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFA==';
                audio.volume = 0.05; // Very low volume (5%) - comfortable and non-annoying
                audio.play().catch(() => {});
            } catch (error) {
                // Ignore audio errors
            }
        }
        
        // Update gesture status display
        function updateGestureStatus(status, gesture, action) {
            document.getElementById('gestureStatusText').textContent = status;
            document.getElementById('gestureDetected').textContent = gesture;
            document.getElementById('gestureAction').textContent = action;
        }
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('gestureModal');
            if (event.target === modal) {
                closeGestureControl();
            }
        });
        
        // Find current tab index on page load
        function updateCurrentTabIndex() {
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab) {
                const tabText = activeTab.textContent;
                if (tabText.includes('ÿ•ÿ∂ÿßŸÅÿ©')) currentTabIndex = 0;
                else if (tabText.includes('ÿπÿ±ÿ∂')) currentTabIndex = 1;
                else if (tabText.includes('ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™')) currentTabIndex = 2;
                else if (tabText.includes('ÿßŸÑÿ™ŸÇŸàŸäŸÖ')) currentTabIndex = 3;
                else if (tabText.includes('ÿßŸÑŸÖÿ≠ŸÑÿßÿ™')) currentTabIndex = 4;
                else if (tabText.includes('ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ')) currentTabIndex = 5;
                else if (tabText.includes('ÿßŸÑÿµŸäÿßŸÜÿ©')) currentTabIndex = 6;
            }
        }
        
        // =========================================================================
        // Background Music Volume Control Functions
        // =========================================================================
        
        let currentBackgroundVolume = 1; // Default: 1% (very low, non-annoying)
        
        /**
         * Open volume control modal
         */
        function openVolumeControl() {
            // Load current volume from audio-config.json if available
            loadCurrentVolume();
            
            // Show modal
            document.getElementById('volumeModal').classList.add('show');
        }
        
        /**
         * Close volume control modal
         */
        function closeVolumeControl() {
            document.getElementById('volumeModal').classList.remove('show');
        }
        
        /**
         * Load current volume setting
         */
        async function loadCurrentVolume() {
            try {
                const response = await fetch('audio-config.json?t=' + Date.now());
                if (response.ok) {
                    const config = await response.json();
                    if (config.backgroundMusic && typeof config.backgroundMusic.volume !== 'undefined') {
                        currentBackgroundVolume = Math.round(config.backgroundMusic.volume * 100);
                        updateMainVolumeDisplay(currentBackgroundVolume);
                        document.getElementById('mainVolumeSlider').value = currentBackgroundVolume;
                    }
                }
            } catch (error) {
                console.log('Could not load audio config:', error);
                // Use default value
                currentBackgroundVolume = 1;
                updateMainVolumeDisplay(1);
                document.getElementById('mainVolumeSlider').value = 1;
            }
        }
        
        /**
         * Update volume display in the modal
         */
        function updateMainVolumeDisplay(value) {
            currentBackgroundVolume = parseInt(value);
            const displayElement = document.getElementById('volumeDisplayBig');
            
            let icon = 'üîá';
            if (value > 0 && value <= 5) {
                icon = 'üîâ';
            } else if (value > 5 && value <= 25) {
                icon = 'üîä';
            } else if (value > 25) {
                icon = 'üì¢';
            }
            
            displayElement.textContent = `${icon} ${value}%`;
        }
        
        /**
         * Set volume to a preset value
         */
        function setVolumePreset(value) {
            currentBackgroundVolume = value;
            document.getElementById('mainVolumeSlider').value = value;
            updateMainVolumeDisplay(value);
        }
        
        /**
         * Test background music with current volume
         */
        async function testBackgroundMusic() {
            // This will communicate with the main page
            const volume = currentBackgroundVolume / 100;
            
            alert(`üéµ ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿµŸàÿ™\n\n` +
                  `ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ≠ÿßŸÑŸä: ${currentBackgroundVolume}%\n\n` +
                  `ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿµŸàÿ™ ÿßŸÑŸÅÿπŸÑŸäÿå Ÿäÿ±ÿ¨Ÿâ:\n` +
                  `1. ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™\n` +
                  `2. ÿßŸÑÿ∞Ÿáÿßÿ® ÿ•ŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© (index.html)\n` +
                  `3. ÿßŸÑŸÜŸÇÿ± ŸÅŸä ÿ£Ÿä ŸÖŸÉÿßŸÜ ÿπŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ`);
        }
        
        /**
         * Save volume settings to GitHub
         */
        async function saveVolumeSettings() {
            if (!githubToken) {
                alert('‚ö†Ô∏è Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã ŸÑŸÑÿ≠ŸÅÿ∏ ÿπŸÑŸâ GitHub');
                return;
            }
            
            try {
                const volume = currentBackgroundVolume / 100; // Convert to decimal (0.0 - 1.0)
                
                // Load current audio-config.json
                const getResponse = await fetch(`https://api.github.com/repos/${repo}/contents/audio-config.json`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error('ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ audio-config.json');
                }
                
                const fileData = await getResponse.json();
                const sha = fileData.sha;
                
                // Decode and parse current config
                const currentContent = decodeURIComponent(escape(atob(fileData.content)));
                let audioConfig = JSON.parse(currentContent);
                
                // Update background music volume
                if (!audioConfig.backgroundMusic) {
                    audioConfig.backgroundMusic = {};
                }
                audioConfig.backgroundMusic.volume = volume;
                audioConfig.backgroundMusic.enabled = true; // Enable background music when volume is set
                audioConfig.lastUpdate = new Date().toISOString();
                
                // Encode and save
                const newContent = JSON.stringify(audioConfig, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(newContent)));
                
                const updateResponse = await fetch(`https://api.github.com/repos/${repo}/contents/audio-config.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ≥ÿ™ŸàŸâ ÿµŸàÿ™ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿ•ŸÑŸâ ${currentBackgroundVolume}%`,
                        content: encodedContent,
                        sha: sha,
                        branch: 'main'
                    })
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.message || 'ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™');
                }
                
                alert(`‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!\n\n` +
                      `ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿµŸàÿ™ ÿßŸÑÿ¨ÿØŸäÿØ: ${currentBackgroundVolume}%\n\n` +
                      `üí° ŸÑŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ÿ•ŸÑŸâ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™:\n` +
                      `1. ÿßŸÜÿ™ŸÇŸÑ ÿ•ŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© (index.html)\n` +
                      `2. ÿßŸÜŸÇÿ± ŸÅŸä ÿ£Ÿä ŸÖŸÉÿßŸÜ ÿπŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ\n` +
                      `3. ÿ≥ÿ™ÿ≥ŸÖÿπ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ÿ®ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ¨ÿØŸäÿØ`);
                
                // Close modal after successful save
                setTimeout(() => {
                    closeVolumeControl();
                }, 2000);
                
            } catch (error) {
                console.error('Error saving volume settings:', error);
                alert(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™: ${error.message}\n\n` +
                      `ÿ™ÿ£ŸÉÿØ ŸÖŸÜ:\n` +
                      `1. ÿµÿ≠ÿ© ÿ™ŸàŸÉŸÜ GitHub\n` +
                      `2. ÿßÿ™ÿµÿßŸÑŸÉ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™\n` +
                      `3. ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖÿ≥ÿ™ŸàÿØÿπ`);
            }
        }
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('volumeModal');
            if (event.target === modal) {
                closeVolumeControl();
            }
        });
        
        // Initialize volume control on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéµ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿßŸÑÿµŸàÿ™ ÿ¨ÿßŸáÿ≤');
        });
    </script>
</body>
</html>
