<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>خطة التفتيش الشهرية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- مكتبات التصدير -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Cairo', Arial, sans-serif; background: #f7f9fc; margin:0;}
        /* ... بقية الـ CSS كما هو ... */
    </style>
</head>
<body>
<div class="main-container">
    <!-- ... محتوى الصفحة كما هو ... -->
</div>
<script>
// --------- بيانات المفتشين ---------
let inspectorsData = [
    {id:"hager", name:"هاجر"}, {id:"amna", name:"آمنه"}, {id:"aya", name:"آيه"},
    {id:"faiz", name:"د. فايز المسالمة"}, {id:"amna2", name:"د.آمنه بن صرم"}
];
let inspectors = inspectorsData.map(i=>i.name);
let isDev = false;
let selectedInspector = "";
const DEV_PASSWORD = "1983";

// --------- جلب البيانات من GitHub inspection_plan.json ---------
let inspectionData = [];
let lastUpdate = "";

async function fetchInspectionData() {
    try {
        const res = await fetch('https://api.github.com/repos/aliabdelaal-adm/Monthly_inspection_plan/contents/inspection_plan.json');
        if (!res.ok) throw new Error("تعذر تحميل البيانات من GitHub");
        const json = await res.json();
        // فك التشفير بشكل يدعم العربية
        const planContent = decodeURIComponent(escape(atob(json.content.replace(/\n/g,''))));
        const planJson = JSON.parse(planContent);
        inspectionData = (planJson.plan || []);
        lastUpdate = planJson.lastUpdate || "";
    } catch (e) {
        inspectionData = [];
        lastUpdate = "";
        alert("تعذر تحميل بيانات خطة التفتيش من GitHub.\nيرجى المحاولة لاحقًا.");
    }
    fillInspectorsDropdowns();
    setLastUpdateDate();
    renderPlanTable();
}

function setLastUpdateDate() {
    let row = document.getElementById('lastUpdateRow');
    if (lastUpdate) {
        row.textContent = "آخر تحديث في الخطة  : " + lastUpdate;
    } else {
        let today = new Date();
        let year = today.getFullYear();
        let month = String(today.getMonth()+1).padStart(2,'0');
        let day = String(today.getDate()).padStart(2,'0');
        let hours = today.getHours();
        let minutes = String(today.getMinutes()).padStart(2,'0');
        let period = hours >= 12 ? 'مساءً' : 'صباحًا';
        let hour12 = hours % 12;
        if(hour12 === 0) hour12 = 12;
        let timeStr = hour12 + ':' + minutes + ' ' + period;
        let dateStr = year+'-'+month+'-'+day;
        row.textContent = "آخر تحديث في الخطة  : " + dateStr + "    " + timeStr;
    }
}

// --------- بقية الدوال كما هي مع اعتماد inspectionData فقط من GitHub ---------

function fillInspectorsDropdowns() {
    const selectInspect = document.getElementById('inspectorSelect');
    selectInspect.innerHTML = '<option value="">-- اختر المفتش --</option>';
    inspectorsData.forEach(inspector => {
        selectInspect.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
    });
    // مفتشين في نموذج المطور
    const select2 = document.getElementById('formInspector');
    if (select2) {
        select2.innerHTML = `<option value="">مفتش</option>`;
        inspectorsData.forEach(inspector => {
            select2.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('bellBtn').addEventListener('click', playBirdSound);
    fetchInspectionData();
    enableBirdSoundOnFirstInteraction();
});

document.getElementById('inspectorSelect').addEventListener('change', function() {
    selectedInspector = this.value;
    renderPlanTable();
    document.getElementById('inspectorReportDiv').style.display = "none";
});
// ... باقي السكربتات كما هي ...
</script>
</body>
</html>
