<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار إصلاح تحميل المحلات</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        h1 {
            color: #333;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <h1>🧪 اختبار إصلاح تحميل المحلات في Smart Planner</h1>
    
    <div class="test-section">
        <h2>نتائج الاختبار:</h2>
        <div id="results"></div>
    </div>

    <script>
        // Simulate planData structure
        const planData = {
            areas: [
                { id: 'area_1', name: 'المنطقة أ' },
                { id: 'area_2', name: 'المنطقة ب' },
                { id: 'area_3', name: 'المنطقة ج' }
            ],
            shops: [
                { id: 'shop_1', name: 'محل 1', areaId: 'area_1' },
                { id: 'shop_2', name: 'محل 2', areaId: 'area_1' },
                { id: 'shop_3', name: 'محل 3', areaId: 'area_1' },
                { id: 'shop_4', name: 'محل 4', areaId: 'area_2' },
                { id: 'shop_5', name: 'محل 5', areaId: 'area_2' },
                { id: 'shop_6', name: 'محل 6', areaId: 'area_3' }
            ],
            inspectionData: [
                {
                    inspector: 'مفتش 1',
                    day: '2025-10-10',
                    area: 'المنطقة أ',
                    shops: ['محل 1'] // Only one shop was inspected
                }
            ]
        };

        // The fixed function
        function getAllShopsInArea(area) {
            const shops = [];
            
            if (!planData) return shops;
            
            // First, try to get shops from the planData.shops array (primary source)
            if (planData.shops && planData.areas) {
                // Find the area ID for the given area name
                const areaObj = planData.areas.find(a => a.name === area);
                
                if (areaObj) {
                    // Get all shops that belong to this area
                    const shopsInArea = planData.shops
                        .filter(shop => shop.areaId === areaObj.id)
                        .map(shop => shop.name);
                    
                    if (shopsInArea.length > 0) {
                        return shopsInArea;
                    }
                }
            }
            
            // Fallback: Collect all unique shops from inspection history
            // This ensures backward compatibility if shops array is not available
            if (planData.inspectionData) {
                const shopSet = new Set();
                planData.inspectionData.forEach(inspection => {
                    if (inspection.area === area && inspection.shops) {
                        inspection.shops.forEach(shop => shopSet.add(shop));
                    }
                });
                
                return Array.from(shopSet);
            }
            
            return shops;
        }

        // Run tests
        function runTests() {
            const resultsDiv = document.getElementById('results');
            let allPassed = true;

            // Test 1: Should return all shops in area from shops array
            const test1Result = getAllShopsInArea('المنطقة أ');
            const test1Pass = test1Result.length === 3 && 
                             test1Result.includes('محل 1') && 
                             test1Result.includes('محل 2') && 
                             test1Result.includes('محل 3');
            
            resultsDiv.innerHTML += `
                <div class="test-result ${test1Pass ? 'pass' : 'fail'}">
                    <strong>اختبار 1:</strong> جلب جميع المحلات في المنطقة أ من shops array<br>
                    النتيجة: ${test1Result.length} محلات<br>
                    المحلات: ${test1Result.join(', ')}<br>
                    ${test1Pass ? '✅ نجح' : '❌ فشل - متوقع 3 محلات'}
                </div>
            `;
            allPassed = allPassed && test1Pass;

            // Test 2: Should return all shops in area B
            const test2Result = getAllShopsInArea('المنطقة ب');
            const test2Pass = test2Result.length === 2 && 
                             test2Result.includes('محل 4') && 
                             test2Result.includes('محل 5');
            
            resultsDiv.innerHTML += `
                <div class="test-result ${test2Pass ? 'pass' : 'fail'}">
                    <strong>اختبار 2:</strong> جلب جميع المحلات في المنطقة ب<br>
                    النتيجة: ${test2Result.length} محلات<br>
                    المحلات: ${test2Result.join(', ')}<br>
                    ${test2Pass ? '✅ نجح' : '❌ فشل - متوقع 2 محلات'}
                </div>
            `;
            allPassed = allPassed && test2Pass;

            // Test 3: Should return shops from area C (not in inspection history)
            const test3Result = getAllShopsInArea('المنطقة ج');
            const test3Pass = test3Result.length === 1 && test3Result.includes('محل 6');
            
            resultsDiv.innerHTML += `
                <div class="test-result ${test3Pass ? 'pass' : 'fail'}">
                    <strong>اختبار 3:</strong> جلب محلات من منطقة لم يتم تفتيشها من قبل<br>
                    النتيجة: ${test3Result.length} محلات<br>
                    المحلات: ${test3Result.join(', ')}<br>
                    ${test3Pass ? '✅ نجح - الإصلاح يعمل!' : '❌ فشل'}
                </div>
            `;
            allPassed = allPassed && test3Pass;

            // Test 4: Old behavior (fallback) - without shops array
            const planDataBackup = { ...planData };
            delete planData.shops;
            const test4Result = getAllShopsInArea('المنطقة أ');
            const test4Pass = test4Result.length === 1 && test4Result.includes('محل 1');
            planData.shops = planDataBackup.shops;
            
            resultsDiv.innerHTML += `
                <div class="test-result ${test4Pass ? 'pass' : 'fail'}">
                    <strong>اختبار 4:</strong> السلوك القديم (fallback) - بدون shops array<br>
                    النتيجة: ${test4Result.length} محلات (فقط المفتشة سابقاً)<br>
                    ${test4Pass ? '✅ نجح - التوافق العكسي يعمل' : '❌ فشل'}
                </div>
            `;
            allPassed = allPassed && test4Pass;

            // Summary
            resultsDiv.innerHTML += `
                <div class="test-result info">
                    <h3>📊 الملخص</h3>
                    ${allPassed ? 
                        '<strong>✅ جميع الاختبارات نجحت!</strong><br>الإصلاح يعمل بشكل صحيح.' : 
                        '<strong>❌ بعض الاختبارات فشلت</strong><br>يرجى مراجعة الكود.'}
                </div>
            `;
        }

        // Run tests on page load
        window.onload = runTests;
    </script>
</body>
</html>
