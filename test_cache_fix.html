<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار إصلاح مسح الكاش - Cache Clear Fix Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #e8f0fe 0%, #f0e8ff 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #234085;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            background: #f8f9fa;
        }
        .test-section h2 {
            color: #234085;
            margin-top: 0;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: linear-gradient(135deg, #234085 0%, #3b82f6 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', Arial, sans-serif;
            font-size: 1em;
            font-weight: 600;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(35, 64, 133, 0.3);
        }
        button:active {
            transform: translateY(0);
        }
        .info-box {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #1565c0;
        }
        .result-item {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: 6px;
            border-right: 4px solid #234085;
            font-size: 0.95em;
        }
        .emoji {
            font-size: 1.5em;
            margin-left: 10px;
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            direction: ltr;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            ✅ اختبار إصلاح مسح الكاش
            <br>
            <small style="font-size: 0.5em; color: #666;">Cache Clear Fix Test</small>
        </h1>

        <div class="info-box">
            <strong>📝 الهدف من الاختبار:</strong>
            <br>
            التحقق من أن وظيفة مسح الكاش تعمل بشكل صحيح في جميع البروتوكولات:
            <br>
            • file:// (فتح الملف مباشرة)
            <br>
            • http:// و https:// (الوصول عبر الخادم)
        </div>

        <!-- Test 1: Protocol Detection -->
        <div class="test-section">
            <h2>
                <span class="emoji">🔍</span>
                1. كشف البروتوكول
            </h2>
            <div id="protocolInfo">
                <div class="status info">⏳ جاري الفحص...</div>
            </div>
        </div>

        <!-- Test 2: ServiceWorker Availability -->
        <div class="test-section">
            <h2>
                <span class="emoji">⚙️</span>
                2. توفر ServiceWorker
            </h2>
            <div id="swAvailability">
                <div class="status info">⏳ جاري الفحص...</div>
            </div>
        </div>

        <!-- Test 3: Cache Clear Function Test -->
        <div class="test-section">
            <h2>
                <span class="emoji">🧪</span>
                3. اختبار وظيفة مسح الكاش
            </h2>
            <div id="cacheClearTest">
                <div class="info-box">
                    اضغط الزر لاختبار وظيفة مسح الكاش. يجب أن تعمل بدون أخطاء في جميع البروتوكولات.
                </div>
            </div>
            <button onclick="testCacheClear()">اختبار مسح الكاش</button>
        </div>

        <!-- Results Summary -->
        <div class="test-section">
            <h2>
                <span class="emoji">📊</span>
                ملخص النتائج
            </h2>
            <div id="summary">
                <div class="status info">انتظر اكتمال جميع الاختبارات...</div>
            </div>
        </div>
    </div>

    <script>
        // Test Results
        let testResults = {
            protocolOk: false,
            swAvailable: false,
            cacheClearOk: false
        };

        // Auto-run tests on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkProtocol();
                checkServiceWorkerAvailability();
                updateSummary();
            }, 500);
        });

        function checkProtocol() {
            const resultDiv = document.getElementById('protocolInfo');
            const protocol = location.protocol;
            const isSecureContext = window.isSecureContext || 
                                    protocol === 'https:' || 
                                    location.hostname === 'localhost' || 
                                    location.hostname === '127.0.0.1';
            
            testResults.protocolOk = true;
            
            resultDiv.innerHTML = `
                <div class="result-item">
                    <strong>البروتوكول:</strong> ${protocol}<br>
                    <strong>Secure Context:</strong> ${isSecureContext ? '✅ نعم' : '❌ لا'}<br>
                    <strong>Hostname:</strong> ${location.hostname || 'N/A'}<br>
                    <strong>Origin:</strong> ${location.origin}
                </div>
                <div class="status ${isSecureContext ? 'success' : 'warning'}">
                    ${isSecureContext ? '✅ بروتوكول آمن - ServiceWorker متاح' : '⚠️ بروتوكول غير آمن - ServiceWorker غير متاح'}
                </div>
            `;
        }

        function checkServiceWorkerAvailability() {
            const resultDiv = document.getElementById('swAvailability');
            const swSupported = 'serviceWorker' in navigator;
            const cachesSupported = 'caches' in window;
            
            testResults.swAvailable = swSupported;
            
            resultDiv.innerHTML = `
                <div class="result-item">
                    <strong>navigator.serviceWorker:</strong> ${swSupported ? '✅ مدعوم' : '❌ غير مدعوم'}<br>
                    <strong>window.caches:</strong> ${cachesSupported ? '✅ مدعوم' : '❌ غير مدعوم'}
                </div>
                <div class="status ${swSupported && cachesSupported ? 'success' : 'warning'}">
                    ${swSupported && cachesSupported ? '✅ ServiceWorker APIs متاحة' : '⚠️ ServiceWorker APIs غير متاحة'}
                </div>
            `;
        }

        async function testCacheClear() {
            const resultDiv = document.getElementById('cacheClearTest');
            resultDiv.innerHTML = '<div class="status info">⏳ جاري الاختبار...</div>';
            
            try {
                // Simulate the fixed emergencyClearCache function
                const isSecureContext = window.isSecureContext || 
                                        location.protocol === 'https:' || 
                                        location.hostname === 'localhost' || 
                                        location.hostname === '127.0.0.1';
                
                let clearedCaches = 0;
                let clearedSW = 0;
                
                // Clear service worker caches only if secure context
                if (isSecureContext && 'serviceWorker' in navigator && 'caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        await Promise.all(cacheNames.map(name => caches.delete(name)));
                        clearedCaches = cacheNames.length;
                        console.log('✅ Service Worker caches cleared');
                    } catch (cacheError) {
                        console.warn('⚠️ Could not clear Service Worker caches:', cacheError.message);
                    }
                } else if (!isSecureContext) {
                    console.log('ℹ️ Service Worker not available in file:// protocol - skipping cache clearing');
                }
                
                // Unregister service workers only if secure context
                if (isSecureContext && 'serviceWorker' in navigator) {
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        await Promise.all(registrations.map(reg => reg.unregister()));
                        clearedSW = registrations.length;
                        console.log('✅ Service Workers unregistered');
                    } catch (swError) {
                        console.warn('⚠️ Could not unregister Service Workers:', swError.message);
                    }
                }
                
                // Clear localStorage cache entries
                const keysToRemove = ['maintenanceStatusCache', 'maintenanceStatusCacheTime', 'dataVersion'];
                keysToRemove.forEach(key => {
                    if (localStorage.getItem(key)) {
                        localStorage.removeItem(key);
                    }
                });
                console.log('✅ LocalStorage caches cleared');
                
                // Clear sessionStorage
                sessionStorage.clear();
                console.log('✅ SessionStorage cleared');
                
                testResults.cacheClearOk = true;
                
                resultDiv.innerHTML = `
                    <div class="status success">✅ اختبار مسح الكاش نجح بدون أخطاء!</div>
                    <div class="result-item">
                        <strong>عدد الكاش المحذوف:</strong> ${clearedCaches}<br>
                        <strong>عدد ServiceWorkers المحذوف:</strong> ${clearedSW}<br>
                        <strong>localStorage:</strong> ✅ تم مسحه<br>
                        <strong>sessionStorage:</strong> ✅ تم مسحه
                    </div>
                    <div class="info-box">
                        <strong>✅ النتيجة:</strong> الوظيفة تعمل بشكل صحيح! لم تحدث أي أخطاء.
                        ${!isSecureContext ? '<br><strong>ملاحظة:</strong> ServiceWorker APIs غير متاحة في file:// protocol، لكن الوظيفة تعاملت مع ذلك بشكل صحيح.' : ''}
                    </div>
                `;
                
                updateSummary();
            } catch (error) {
                testResults.cacheClearOk = false;
                resultDiv.innerHTML = `
                    <div class="status error">❌ حدث خطأ أثناء الاختبار!</div>
                    <div class="result-item">
                        <strong>الخطأ:</strong> ${error.message}
                    </div>
                    <div class="code-block">${error.stack || error.toString()}</div>
                `;
                updateSummary();
            }
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            const totalTests = 3;
            const passedTests = Object.values(testResults).filter(v => v === true).length;
            const percentage = Math.round((passedTests / totalTests) * 100);
            
            const allPassed = passedTests === totalTests;
            
            summaryDiv.innerHTML = `
                <div class="status ${allPassed ? 'success' : 'info'}">
                    ${allPassed ? '✅' : 'ℹ️'} نجح ${passedTests} من ${totalTests} اختبار (${percentage}%)
                </div>
                <div class="result-item">
                    <strong>تفاصيل:</strong><br>
                    • كشف البروتوكول: ${testResults.protocolOk ? '✅' : '❌'}<br>
                    • توفر ServiceWorker: ${testResults.swAvailable ? '✅' : '⚠️ (متوقع في file://)'}<br>
                    • اختبار مسح الكاش: ${testResults.cacheClearOk ? '✅' : '⏳ (لم يتم بعد)'}
                </div>
                ${allPassed ? `
                    <div class="info-box">
                        <strong>🎉 ممتاز!</strong> جميع الاختبارات نجحت. الإصلاح يعمل بشكل صحيح.
                    </div>
                ` : ''}
            `;
        }
    </script>
</body>
</html>
