<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ - Instant Update Message Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Cache Control Meta Tags - Prevent browser caching for instant updates -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .info-box {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .info-box h3 {
            margin-top: 0;
            color: #1976D2;
        }
        
        .test-section {
            background: #f9f9f9;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .test-section h2 {
            color: #333;
            margin-top: 0;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-clear {
            background: #dc3545;
        }
        
        .btn-clear:hover {
            background: #c82333;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-success {
            color: #4ec9b0;
        }
        
        .log-error {
            color: #f48771;
        }
        
        .log-warning {
            color: #ce9178;
        }
        
        .log-info {
            color: #9cdcfe;
        }
        
        .status-display {
            background: #fff;
            border: 2px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
        }
        
        .status-display.active {
            background: #ffe5e5;
            border-color: #dc3545;
        }
        
        .status-display h3 {
            margin: 0;
            color: #333;
        }
        
        .highlight {
            background: #ffeb3b;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ</h1>
        <p class="subtitle">Instant Update Message Test - Cache Busting Verification</p>
        
        <div class="info-box">
            <h3>ğŸ“‹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± - About This Test</h3>
            <p><strong>Ø§Ù„ØºØ±Ø¶:</strong> Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø±Ø³Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†" ØªØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¯ÙˆÙ† ØªØ£Ø®ÙŠØ± Ø¨Ø³Ø¨Ø¨ Ø§Ù„ÙƒØ§Ø´.</p>
            <p><strong>Purpose:</strong> Verify that the "Updating now" message appears instantly on all devices without delay due to caching.</p>
            <p><strong>Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©:</strong></p>
            <ul>
                <li>âœ… Cache-Busting Ø§Ù„Ù…ØªÙ‚Ø¯Ù…: timestamp + random string</li>
                <li>âœ… HTTP Headers: Cache-Control, Pragma, Expires</li>
                <li>âœ… Fetch API: cache: 'no-store'</li>
                <li>âœ… HTML Meta Tags: Cache control headers</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h2>ğŸ§ª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 1: ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©</h2>
            <p>ÙŠØ®ØªØ¨Ø± ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ù…Ø¹ cache-busting Ù…ØªÙ‚Ø¯Ù…</p>
            <div class="btn-group">
                <button onclick="testLoadMaintenanceStatus()">â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
                <button onclick="testMultipleLoads()">ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ù…ØªØ¹Ø¯Ø¯ (5 Ù…Ø±Ø§Øª)</button>
            </div>
            <div id="statusDisplay" class="status-display">
                <h3>â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</h3>
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ§ª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 2: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Cache-Busting</h2>
            <p>ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† ÙƒÙ„ Ø·Ù„Ø¨ ÙŠØ³ØªØ®Ø¯Ù… Ù…Ø¹Ø§Ù…Ù„ ÙØ±ÙŠØ¯</p>
            <div class="btn-group">
                <button onclick="testCacheBusting()">â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª - Test Log</h2>
            <div class="btn-group">
                <button class="btn-clear" onclick="clearLog()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
                <button class="btn-success" onclick="runAllTests()">â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
            </div>
            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª - Test Log</div>
                <div class="log-entry log-info">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± - Ready for testing</div>
            </div>
        </div>
    </div>
    
    <script>
        // Implementation of the improved loadMaintenanceStatusFromGitHub function
        async function loadMaintenanceStatusFromGitHub(retries = 3, delayMs = 1000) {
            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    // Advanced cache-busting: timestamp + random to bypass all caching layers (CDN, browser, proxies)
                    const cacheBuster = `${Date.now()}_${Math.random().toString(36).substring(7)}`;
                    const url = `https://raw.githubusercontent.com/aliabdelaal-adm/Monthly_inspection_plan/main/maintenance-status.json?t=${cacheBuster}`;
                    
                    log(`ğŸŒ Fetching from: ${url}`, 'info');
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        },
                        cache: 'no-store' // Force fetch to bypass browser cache
                    });
                    
                    if (!response.ok) {
                        log(`âš ï¸ Could not load maintenance status from GitHub (attempt ${attempt}/${retries}): ${response.status}`, 'warning');
                        if (attempt < retries) {
                            await new Promise(resolve => setTimeout(resolve, delayMs * attempt));
                            continue;
                        }
                        return null;
                    }
                    
                    const status = await response.json();
                    log('ğŸ“¥ Loaded maintenance status from GitHub: ' + JSON.stringify(status, null, 2), 'success');
                    return status;
                } catch (error) {
                    log(`âŒ Error loading maintenance status from GitHub (attempt ${attempt}/${retries}): ${error.message}`, 'error');
                    if (attempt < retries) {
                        await new Promise(resolve => setTimeout(resolve, delayMs * attempt));
                    }
                }
            }
            
            log('âŒ Failed to load maintenance status after all retries', 'error');
            return null;
        }
        
        // Test function 1: Load maintenance status
        async function testLoadMaintenanceStatus() {
            log('=== ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 1: ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ===', 'info');
            const status = await loadMaintenanceStatusFromGitHub();
            
            if (status !== null) {
                log('âœ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¬Ø­: ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                log(`ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©: isMaintenanceMode = ${status.isMaintenanceMode}`, 'info');
                updateStatusDisplay(status);
            } else {
                log('âŒ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙØ´Ù„: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                updateStatusDisplay(null);
            }
        }
        
        // Test function 2: Multiple loads
        async function testMultipleLoads() {
            log('=== ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 2: ØªØ­Ù…ÙŠÙ„ Ù…ØªØ¹Ø¯Ø¯ (5 Ù…Ø±Ø§Øª) ===', 'info');
            
            for (let i = 1; i <= 5; i++) {
                log(`\nğŸ”„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${i} Ù…Ù† 5...`, 'info');
                const status = await loadMaintenanceStatusFromGitHub(1, 500);
                
                if (status !== null) {
                    log(`âœ… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${i}: Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ù…ÙŠÙ„`, 'success');
                } else {
                    log(`âŒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${i}: ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„`, 'error');
                }
                
                // Small delay between loads
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log('\nâœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª 5 Ù…Ø±Ø§Øª', 'success');
        }
        
        // Test function 3: Verify cache busting
        async function testCacheBusting() {
            log('=== ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 3: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Cache-Busting ===', 'info');
            
            const urls = [];
            
            for (let i = 1; i <= 5; i++) {
                const cacheBuster = `${Date.now()}_${Math.random().toString(36).substring(7)}`;
                const url = `https://raw.githubusercontent.com/aliabdelaal-adm/Monthly_inspection_plan/main/maintenance-status.json?t=${cacheBuster}`;
                urls.push(cacheBuster);
                log(`ğŸ”¢ Cache buster ${i}: ${cacheBuster}`, 'info');
                
                // Small delay to ensure different timestamps
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            // Check uniqueness
            const uniqueUrls = new Set(urls);
            if (uniqueUrls.size === urls.length) {
                log(`âœ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¬Ø­: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙØ±ÙŠØ¯Ø© (${urls.length}/${urls.length})`, 'success');
            } else {
                log(`âŒ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙØ´Ù„: ÙˆØ¬Ø¯Øª Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø© (${uniqueUrls.size}/${urls.length})`, 'error');
            }
        }
        
        // Run all tests
        async function runAllTests() {
            clearLog();
            log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª...', 'info');
            log('', 'info');
            
            await testLoadMaintenanceStatus();
            log('\n', 'info');
            
            await testCacheBusting();
            log('\n', 'info');
            
            await testMultipleLoads();
            log('\n', 'info');
            
            log('ğŸ‰ Ø§ÙƒØªÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª!', 'success');
        }
        
        // Update status display
        function updateStatusDisplay(status) {
            const display = document.getElementById('statusDisplay');
            
            if (status === null) {
                display.innerHTML = '<h3>âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</h3>';
                display.className = 'status-display';
            } else if (status.isMaintenanceMode) {
                display.innerHTML = `
                    <h3>ğŸ”´ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© Ù†Ø´Ø·</h3>
                    <p>Maintenance Mode Active</p>
                    <p>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date(status.lastUpdated).toLocaleString('ar-EG')}</p>
                `;
                display.className = 'status-display active';
            } else {
                display.innerHTML = `
                    <h3>âœ… Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ</h3>
                    <p>System Operating Normally</p>
                    <p>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date(status.lastUpdated).toLocaleString('ar-EG')}</p>
                `;
                display.className = 'status-display';
            }
        }
        
        // Logging function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = message;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Clear log
        function clearLog() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '';
            log('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ - Log cleared', 'info');
        }
    </script>
</body>
</html>
