<!DOCTYPE html>
<!-- Version 2.0.0 - ABSOLUTE ZERO-CACHE STRATEGY for instant updates -->
<!-- Last Updated: 2025-10-19 - Complete cache prevention for Safari, Chrome, Firefox (mobile/desktop) -->
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>أداة التخطيط الذكية للتفتيش الشهري</title>
    
    <!-- ABSOLUTE CACHE PREVENTION - Works on ALL browsers including Safari, Chrome and Firefox -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, max-stale=0, post-check=0, pre-check=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Safari-specific cache prevention -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Chrome mobile-specific cache prevention -->
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Additional cache control for aggressive browsers -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="cleartype" content="on">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .feature-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .feature-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .feature-card h3 {
            color: #2d3561;
            margin-bottom: 5px;
        }
        
        .feature-card p {
            color: #666;
            font-size: 0.9em;
        }
        
        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.8em;
            color: #2d3561;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #2d3561;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102,126,234,0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(17,153,142,0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(17,153,142,0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(250,112,154,0.3);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(250,112,154,0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 600;
            display: none;
        }
        
        .status-message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .status-message.warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
        }
        
        .shops-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .shop-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .shop-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.2);
        }
        
        .shop-card.selected {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .shop-card.very-high-priority {
            border-left: 5px solid #8b0000;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
        }
        
        .shop-card.high-priority {
            border-left: 5px solid #dc3545;
        }
        
        .shop-card.medium-priority {
            border-left: 5px solid #ffc107;
        }
        
        .shop-card.low-priority {
            border-left: 5px solid #28a745;
        }
        
        .shop-card .priority-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .shop-card .priority-badge.very-high {
            background: #8b0000;
            color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .shop-card .priority-badge.high {
            background: #dc3545;
            color: white;
        }
        
        .shop-card .priority-badge.medium {
            background: #ffc107;
            color: #212529;
        }
        
        .shop-card .priority-badge.low {
            background: #28a745;
            color: white;
        }
        
        .shop-card .shop-name {
            font-weight: 600;
            color: #2d3561;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .shop-card .shop-info {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .shop-card .last-inspection {
            font-size: 0.85em;
            color: #999;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }
        
        .selected-shops {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .selected-shops h3 {
            color: #1565c0;
            margin-bottom: 15px;
        }
        
        .selected-shops-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .selected-shop-tag {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .selected-shop-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .selected-shop-tag .remove:hover {
            color: #ffcccc;
        }
        
        .filter-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        
        .stat-box .value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-box .label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .inspection-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }
        
        .inspection-preview h3 {
            color: #2d3561;
            margin-bottom: 15px;
        }
        
        .inspection-preview .preview-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .inspection-preview .preview-item strong {
            color: #667eea;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* New styles for enhanced features */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 12px 24px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            background: #f0f0ff;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .inspections-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .inspections-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .inspections-table th,
        .inspections-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .inspections-table tbody tr:hover {
            background: #f5f5f5;
        }
        
        .action-icon {
            cursor: pointer;
            font-size: 1.3em;
            margin: 0 5px;
            transition: transform 0.2s;
        }
        
        .action-icon:hover {
            transform: scale(1.2);
        }
        
        .edit-icon { color: #ffc107; }
        .delete-icon { color: #dc3545; }
        .copy-icon { color: #17a2b8; }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        
        .inspector-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-card .stat-label {
            font-size: 1em;
            color: #2d3561;
            margin-top: 5px;
        }
        
        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .calendar-day {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            min-height: 100px;
            position: relative;
        }
        
        .calendar-day .day-number {
            font-weight: 700;
            color: #2d3561;
            margin-bottom: 10px;
        }
        
        .calendar-day .inspection-badge {
            background: #667eea;
            color: white;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            margin-bottom: 5px;
            display: block;
        }
        
        .calendar-day.has-inspection {
            border-color: #667eea;
            background: #f0f0ff;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #2d3561;
        }
        
        .modal-close {
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
        }
        
        .search-box .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(231,76,60,0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(231,76,60,0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(52,152,219,0.3);
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52,152,219,0.4);
        }
    </style>
    
    <!-- SheetJS library for Excel import/export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 أداة التخطيط الذكية للتفتيش الشهري</h1>
            <p>نظام ذكي ومرن لتحديث خطة التفتيش مباشرة وفوراً مع فلترة المحلات ذات الأولوية</p>
        </div>
        
        <div class="features">
            <div class="feature-card">
                <div class="icon">⚡</div>
                <h3>تحديث فوري</h3>
                <p>التحديثات تظهر مباشرة دون رفع ملفات</p>
            </div>
            <div class="feature-card">
                <div class="icon">🎯</div>
                <h3>الأولوية الذكية</h3>
                <p>المحلات ذات الأولوية العالية تظهر أولاً</p>
            </div>
            <div class="feature-card">
                <div class="icon">🚫</div>
                <h3>منع التكرار</h3>
                <p>تجنب المحلات المكررة في نفس اليوم</p>
            </div>
            <div class="feature-card">
                <div class="icon">📅</div>
                <h3>فترة الانتظار</h3>
                <p>أسبوع واحد قبل إعادة التفتيش</p>
            </div>
            <div class="feature-card">
                <div class="icon">📝</div>
                <h3>تحرير التفتيشات</h3>
                <p>إمكانية تعديل التفتيشات السابقة</p>
            </div>
            <div class="feature-card">
                <div class="icon">👁️</div>
                <h3>عرض التفتيشات</h3>
                <p>مشاهدة جميع التفتيشات لكل مفتش</p>
            </div>
            <div class="feature-card">
                <div class="icon">🗑️</div>
                <h3>حذف تلقائي</h3>
                <p>حذف التفتيشات المكررة تلقائياً</p>
            </div>
            <div class="feature-card">
                <div class="icon">📊</div>
                <h3>إحصائيات شاملة</h3>
                <p>تقارير تفصيلية لكل مفتش</p>
            </div>
        </div>
        
        <!-- Quick Links & Smart Actions Toolbar -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
            <h3 style="color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <span>⚡</span>
                <span>الإجراءات السريعة والذكية</span>
            </h3>
            
            <!-- Navigation Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <a href="admin-dashboard.html" style="text-decoration: none;">
                    <button class="btn btn-warning" style="background: white; color: #667eea;">
                        <span>📊</span>
                        <span>لوحة التحكم الرئيسية</span>
                    </button>
                </a>
                <a href="index.html" style="text-decoration: none;">
                    <button class="btn btn-info" style="background: white; color: #3498db;">
                        <span>🏠</span>
                        <span>الصفحة الرئيسية</span>
                    </button>
                </a>
                <button class="btn btn-success" onclick="openQuickAddInspection()" style="background: white; color: #11998e;">
                    <span>⚡</span>
                    <span>إضافة تفتيش سريع</span>
                </button>
            </div>
            
            <!-- Data Management Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="importFromExcel()" style="background: white; color: #667eea;">
                    <span>📥</span>
                    <span>استيراد من Excel</span>
                </button>
                <button class="btn btn-primary" onclick="exportAllData()" style="background: white; color: #667eea;">
                    <span>📤</span>
                    <span>تصدير جميع البيانات</span>
                </button>
                <button class="btn btn-primary" onclick="syncWithGitHub()" style="background: white; color: #667eea;">
                    <span>🔄</span>
                    <span>مزامنة مع GitHub</span>
                </button>
                <button class="btn btn-danger" onclick="createBackup()" style="background: white; color: #e74c3c;">
                    <span>💾</span>
                    <span>نسخة احتياطية</span>
                </button>
            </div>
            
            <!-- Analysis & Reports Buttons -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="generateFullReport()" style="background: white; color: #11998e;">
                    <span>📈</span>
                    <span>تقرير شامل</span>
                </button>
                <button class="btn btn-warning" onclick="checkDataQuality()" style="background: white; color: #fa709a;">
                    <span>🔍</span>
                    <span>فحص جودة البيانات</span>
                </button>
                <button class="btn btn-info" onclick="viewSystemLogs()" style="background: white; color: #3498db;">
                    <span>📋</span>
                    <span>سجل النظام</span>
                </button>
                <button class="btn btn-success" onclick="bulkOperations()" style="background: white; color: #11998e;">
                    <span>⚙️</span>
                    <span>عمليات جماعية</span>
                </button>
            </div>
        </div>
        
        <!-- Login Section -->
        <div class="section" id="loginSection">
            <h2 class="section-title">🔐 تسجيل الدخول كمطور</h2>
            <div class="form-group">
                <label class="form-label">GitHub Token (للحفظ المباشر)</label>
                <input type="password" id="githubToken" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <small style="color: #666; display: block; margin-top: 5px;">
                    احصل على التوكن من: GitHub Settings → Developer Settings → Personal Access Tokens
                </small>
            </div>
            <button class="btn btn-primary" onclick="loginDeveloper()">
                <span>✓</span>
                <span>تسجيل الدخول</span>
            </button>
            <div class="status-message" id="loginStatus"></div>
        </div>
        
        <!-- Main Interface with Tabs -->
        <div id="mainInterface" style="display: none;">
            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('add')">
                    <span>➕</span> إضافة تفتيش جديد
                </button>
                <button class="tab-button" onclick="switchTab('view')">
                    <span>👁️</span> عرض التفتيشات
                </button>
                <button class="tab-button" onclick="switchTab('stats')">
                    <span>📊</span> إحصائيات المفتشين
                </button>
                <button class="tab-button" onclick="switchTab('calendar')">
                    <span>📅</span> التقويم الشهري
                </button>
                <button class="tab-button" onclick="switchTab('shops')">
                    <span>🏪</span> إدارة المحلات
                </button>
                <button class="tab-button" onclick="switchTab('areas')">
                    <span>🗺️</span> إدارة المناطق
                </button>
                <button class="tab-button" onclick="switchTab('maintenance')">
                    <span>🔧</span> التحكم الذكي في رسالة التحديث
                </button>
            </div>
            
            <!-- Tab Content: Add Inspection -->
            <div id="addTab" class="tab-content active">
                <div class="section">
            <h2 class="section-title">📝 إضافة تفتيش جديد</h2>
            
            <div class="form-group">
                <label class="form-label">المفتش</label>
                <select id="inspectorSelect" class="form-control" onchange="updateAvailableShops()">
                    <option value="">اختر المفتش...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">التاريخ</label>
                <input type="date" id="inspectionDate" class="form-control" onchange="updateAvailableShops()">
            </div>
            
            <div class="form-group">
                <label class="form-label">المناوبة</label>
                <select id="shiftSelect" class="form-control">
                    <option value="صباحية">صباحية</option>
                    <option value="مسائية">مسائية</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">المنطقة</label>
                <select id="areaSelect" class="form-control" onchange="updateAvailableShops()">
                    <option value="">اختر المنطقة...</option>
                </select>
            </div>
            
            <!-- Filter Statistics -->
            <div class="filter-stats">
                <div class="stat-box">
                    <div class="value" id="totalShopsCount">0</div>
                    <div class="label">إجمالي المحلات</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="availableShopsCount">0</div>
                    <div class="label">المحلات المتاحة</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="highPriorityCount">0</div>
                    <div class="label">أولوية عالية</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="selectedShopsCount">0</div>
                    <div class="label">المحلات المختارة</div>
                </div>
            </div>
            
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label class="form-label" style="margin-bottom: 0;">المحلات المتاحة (مرتبة حسب الأولوية)</label>
                    <button id="showHighPriorityBtn" class="btn btn-warning btn-sm" onclick="toggleHighPriorityShops()" style="display: none; padding: 8px 16px;">
                        <span id="highPriorityBtnIcon">👁️</span>
                        <span id="highPriorityBtnText">عرض المحلات ذات الأولوية العالية</span>
                    </button>
                </div>
                <div id="shopsListContainer">
                    <p style="text-align: center; color: #999; padding: 20px;">
                        اختر المفتش والتاريخ والمنطقة لعرض المحلات المتاحة
                    </p>
                </div>
            </div>
            
            <!-- Selected Shops -->
            <div class="selected-shops" id="selectedShopsContainer" style="display: none;">
                <h3>المحلات المختارة للتفتيش</h3>
                <div class="selected-shops-list" id="selectedShopsList"></div>
            </div>
            
            <!-- Inspection Preview -->
            <div class="inspection-preview" id="inspectionPreview" style="display: none;">
                <h3>معاينة التفتيش</h3>
                <div class="preview-item">
                    <strong>المفتش:</strong> <span id="previewInspector">-</span>
                </div>
                <div class="preview-item">
                    <strong>التاريخ:</strong> <span id="previewDate">-</span>
                </div>
                <div class="preview-item">
                    <strong>المناوبة:</strong> <span id="previewShift">-</span>
                </div>
                <div class="preview-item">
                    <strong>المنطقة:</strong> <span id="previewArea">-</span>
                </div>
                <div class="preview-item">
                    <strong>عدد المحلات:</strong> <span id="previewShopsCount">0</span>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveInspection()" id="saveBtn" disabled>
                    <span>💾</span>
                    <span>حفظ التفتيش فوراً</span>
                </button>
                <button class="btn btn-warning" onclick="resetForm()">
                    <span>🔄</span>
                    <span>إعادة تعيين</span>
                </button>
            </div>
            
            <div class="status-message" id="planningStatus"></div>
                </div>
            </div>
            
            <!-- Tab Content: View Inspections -->
            <div id="viewTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">👁️ عرض وإدارة التفتيشات</h2>
                    
                    <!-- Filter Bar -->
                    <div class="filter-bar">
                        <div class="filter-item">
                            <label class="form-label">فلترة حسب المفتش</label>
                            <select id="filterInspector" class="form-control" onchange="filterInspections()">
                                <option value="">جميع المفتشين</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">فلترة حسب المنطقة</label>
                            <select id="filterArea" class="form-control" onchange="filterInspections()">
                                <option value="">جميع المناطق</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">من تاريخ</label>
                            <input type="date" id="filterDateFrom" class="form-control" onchange="filterInspections()">
                        </div>
                        <div class="filter-item">
                            <label class="form-label">إلى تاريخ</label>
                            <input type="date" id="filterDateTo" class="form-control" onchange="filterInspections()">
                        </div>
                    </div>
                    
                    <!-- Search Box -->
                    <div class="search-box">
                        <input type="text" id="searchBox" class="form-control" 
                               placeholder="بحث في التفتيشات (اسم المفتش، المنطقة، المحلات...)" 
                               oninput="filterInspections()">
                        <span class="search-icon">🔍</span>
                    </div>
                    
                    <!-- Inspections Table -->
                    <div id="inspectionsTableContainer">
                        <p style="text-align: center; color: #999; padding: 40px;">جاري تحميل التفتيشات...</p>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-danger btn-sm" onclick="deleteSelectedInspections()">
                            <span>🗑️</span> حذف المحدد
                        </button>
                        <button class="btn btn-info btn-sm" onclick="exportInspections()">
                            <span>📥</span> تصدير البيانات
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Statistics -->
            <div id="statsTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">📊 إحصائيات المفتشين</h2>
                    
                    <div class="form-group">
                        <label class="form-label">اختر المفتش</label>
                        <select id="statsInspector" class="form-control" onchange="loadInspectorStats()">
                            <option value="">اختر المفتش...</option>
                        </select>
                    </div>
                    
                    <div id="statsContainer">
                        <div class="empty-state">
                            <div class="icon">📊</div>
                            <p>اختر مفتشاً لعرض الإحصائيات</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Calendar -->
            <div id="calendarTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">📅 التقويم الشهري</h2>
                    
                    <div class="form-group">
                        <label class="form-label">اختر الشهر</label>
                        <input type="month" id="calendarMonth" class="form-control" onchange="loadCalendar()">
                    </div>
                    
                    <div id="calendarContainer">
                        <div class="empty-state">
                            <div class="icon">📅</div>
                            <p>اختر الشهر لعرض التقويم</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Shops Management -->
            <div id="shopsTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">🏪 إدارة المحلات الكاملة</h2>
                    
                    <!-- Smart Action Buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="openAddShopModal()">
                            <span>➕</span> إضافة محل جديد
                        </button>
                        <button class="btn btn-primary" onclick="refreshShopsList()">
                            <span>🔄</span> تحديث القائمة
                        </button>
                        <button class="btn btn-primary" onclick="reloadShopsFromExcel()">
                            <span>📥</span> تحميل من Excel
                        </button>
                        <button class="btn btn-warning" onclick="exportShopsData()">
                            <span>📤</span> تصدير JSON
                        </button>
                        <button class="btn btn-info" onclick="exportShopsToExcel()">
                            <span>📊</span> تصدير Excel
                        </button>
                        <button class="btn btn-danger" onclick="bulkEditShops()">
                            <span>✏️</span> تعديل جماعي
                        </button>
                        <button class="btn btn-danger" onclick="bulkDeleteShops()">
                            <span>🗑️</span> حذف جماعي
                        </button>
                        <button class="btn btn-success" onclick="mergeShopsData()">
                            <span>🔗</span> دمج بيانات
                        </button>
                        <button class="btn btn-info" onclick="validateShopsData()">
                            <span>✅</span> التحقق من البيانات
                        </button>
                        <button class="btn btn-warning" onclick="viewShopsOnMap()">
                            <span>🗺️</span> عرض على الخريطة
                        </button>
                        <button class="btn btn-success" onclick="openSmartShopListModal()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; font-weight: bold;">
                            <span>📋</span> قائمة المحلات الذكية
                        </button>
                    </div>
                    
                    <!-- Filter and Search -->
                    <div class="filter-bar">
                        <div class="filter-item">
                            <label class="form-label">البحث عن محل</label>
                            <input type="text" id="searchShop" class="form-control" 
                                   placeholder="ابحث بالاسم..." oninput="filterShopsList()">
                        </div>
                        <div class="filter-item">
                            <label class="form-label">فلترة حسب المنطقة</label>
                            <select id="filterShopArea" class="form-control" onchange="filterShopsList()">
                                <option value="">جميع المناطق</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Shops Stats -->
                    <div class="inspector-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalShopsManagement">0</div>
                            <div class="stat-label">إجمالي المحلات</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="filteredShopsCount">0</div>
                            <div class="stat-label">المحلات المعروضة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalAreasInShops">0</div>
                            <div class="stat-label">عدد المناطق</div>
                        </div>
                    </div>
                    
                    <!-- Shops List Table -->
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table class="inspections-table" id="shopsManagementTable">
                            <thead>
                                <tr>
                                    <th>اسم المحل</th>
                                    <th>المنطقة</th>
                                    <th>رقم التعريف</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="shopsManagementBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 40px;">
                                        جاري تحميل البيانات...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="status-message" id="shopsManagementStatus"></div>
                </div>
            </div>
            
            <!-- Tab Content: Maintenance Control -->
            <div id="maintenanceTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">🔧 التحكم الذكي المطلق في رسالة التحديث والكاش</h2>
                    
                    <!-- Cache Control Section -->
                    <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>🚀</span>
                            <span>التحديث الفوري ومسح الكاش والذاكرة</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            زر قوي لمسح كل الكاش والذاكرة المؤقتة فوراً في GitHub والمتصفحات (Safari, Chrome, Firefox)
                        </p>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button id="clearCacheBtn" class="btn btn-danger" onclick="forceCacheClear()" style="background: white; color: #ff6b6b; font-weight: bold;">
                                <span id="clearCacheIcon">🚀</span>
                                <span id="clearCacheText">مسح قوي وفوري للكاش (Safari + Chrome + Firefox)</span>
                            </button>
                            <button id="updateSWBtn" class="btn btn-warning" onclick="updateServiceWorker()" style="background: white; color: #ee5a6f;">
                                <span id="updateSWIcon">🔄</span>
                                <span id="updateSWText">تحديث Service Worker فوراً</span>
                            </button>
                        </div>
                        <div class="status-message" id="cacheControlStatus"></div>
                    </div>
                    
                    <!-- Maintenance Message Control Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>📺</span>
                            <span>التحكم الذكي في شاشة التحديث المؤقتة</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            تحكم كامل ومباشر 100% في ظهور وإخفاء وتفعيل وإغلاق رسالة "جاري التحديث الآن"
                        </p>
                        
                        <!-- Enable/Disable Toggle -->
                        <div class="form-group">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>🔘</span> حالة رسالة التحديث
                            </label>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <button id="enableMaintenanceBtn" class="btn btn-success" onclick="toggleMaintenanceMessage(true)" style="flex: 1;">
                                    <span>✅</span>
                                    <span>تفعيل رسالة التحديث</span>
                                </button>
                                <button id="disableMaintenanceBtn" class="btn btn-danger" onclick="toggleMaintenanceMessage(false)" style="flex: 1;">
                                    <span>❌</span>
                                    <span>إيقاف رسالة التحديث</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Current Status Display -->
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">الحالة الحالية:</span>
                                <span id="maintenanceStatusLabel" style="font-size: 1.1em; font-weight: 700;">⏳ جاري التحميل...</span>
                            </div>
                        </div>
                        
                        <div class="status-message" id="maintenanceToggleStatus"></div>
                    </div>
                    
                    <!-- Music Control Section -->
                    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>🎵</span>
                            <span>التحكم الذكي المطلق في الموسيقى</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            تحكم فوري ومباشر 100% في صوت الموسيقى وتمكينها/تعطيلها مع الانعكاس المباشر في GitHub
                        </p>
                        
                        <!-- Music Enable/Disable -->
                        <div class="form-group">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>🔊</span> حالة الموسيقى
                            </label>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <button id="enableMusicBtn" class="btn btn-success" onclick="toggleMusic(true)" style="flex: 1;">
                                    <span>🔊</span>
                                    <span>تفعيل الموسيقى</span>
                                </button>
                                <button id="disableMusicBtn" class="btn btn-danger" onclick="toggleMusic(false)" style="flex: 1;">
                                    <span>🔇</span>
                                    <span>إيقاف الموسيقى</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Volume Control -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>🎚️</span> مستوى الصوت (حجم الموسيقى)
                            </label>
                            <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin-top: 10px;">
                                <input type="range" id="volumeSlider" min="0" max="100" value="10" 
                                       style="width: 100%; height: 8px; border-radius: 5px; cursor: pointer;"
                                       oninput="updateVolumeDisplay(this.value)"
                                       onchange="saveVolumeChange(this.value)">
                                <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9em;">
                                    <span>🔇 0%</span>
                                    <span id="volumeDisplay" style="font-size: 1.3em; font-weight: 700;">🔊 10%</span>
                                    <span>🔊 100%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Volume Presets -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" style="color: white; font-size: 1.1em;">
                                <span>⚡</span> إعدادات سريعة للصوت
                            </label>
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <button class="btn btn-sm" onclick="setVolumePreset(0)" style="background: white; color: #11998e;">
                                    <span>🔇</span> كتم الصوت
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(10)" style="background: white; color: #11998e;">
                                    <span>🔉</span> 10%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(25)" style="background: white; color: #11998e;">
                                    <span>🔉</span> 25%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(40)" style="background: white; color: #11998e;">
                                    <span>🔊</span> 40%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(50)" style="background: white; color: #11998e;">
                                    <span>🔊</span> 50%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(75)" style="background: white; color: #11998e;">
                                    <span>🔊</span> 75%
                                </button>
                                <button class="btn btn-sm" onclick="setVolumePreset(100)" style="background: white; color: #11998e;">
                                    <span>🔊</span> 100%
                                </button>
                            </div>
                        </div>
                        
                        <!-- Music Duration Control -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label" style="color: white; font-size: 1.2em;">
                                <span>⏱️</span> مدة تشغيل الموسيقى
                            </label>
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <button class="btn btn-sm" onclick="setMusicDuration(60)" style="background: white; color: #11998e;">
                                    <span>⏱️</span> دقيقة واحدة
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(300)" style="background: white; color: #11998e;">
                                    <span>⏱️</span> 5 دقائق
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(600)" style="background: white; color: #11998e;">
                                    <span>⏱️</span> 10 دقائق
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(1800)" style="background: white; color: #11998e;">
                                    <span>⏱️</span> 30 دقيقة
                                </button>
                                <button class="btn btn-sm" onclick="setMusicDuration(-1)" style="background: white; color: #11998e;">
                                    <span>♾️</span> مستمر (غير محدود)
                                </button>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; margin-top: 10px;">
                                <span style="font-weight: 600;">المدة الحالية:</span>
                                <span id="musicDurationLabel" style="font-weight: 700; margin-right: 10px;">⏳ جاري التحميل...</span>
                            </div>
                        </div>
                        
                        <!-- Current Music Status -->
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">حالة الموسيقى:</span>
                                <span id="musicStatusLabel" style="font-size: 1.1em; font-weight: 700;">⏳ جاري التحميل...</span>
                            </div>
                        </div>
                        
                        <div class="status-message" id="musicControlStatus"></div>
                    </div>
                    
                    <!-- Live Preview Section -->
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 25px; border-radius: 15px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>👁️</span>
                            <span>معاينة مباشرة وحية 100%</span>
                        </h3>
                        <p style="margin-bottom: 20px; opacity: 0.95;">
                            جميع التغييرات تنعكس فوراً ومباشرة في GitHub وعلى جميع الأجهزة والمتصفحات
                        </p>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                            <div style="margin-bottom: 10px;">
                                <span style="font-weight: 600;">آخر تحديث:</span>
                                <span id="lastUpdateLabel" style="font-weight: 700; margin-right: 10px;">⏳ جاري التحميل...</span>
                            </div>
                            <div>
                                <span style="font-weight: 600;">تم التحديث بواسطة:</span>
                                <span id="updatedByLabel" style="font-weight: 700; margin-right: 10px;">⏳ جاري التحميل...</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="loadMaintenanceConfig()" style="margin-top: 15px; background: white; color: #fa709a;">
                            <span>🔄</span>
                            <span>تحديث البيانات المباشرة</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Areas Management -->
            <div id="areasTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">🗺️ إدارة المناطق الكاملة</h2>
                    
                    <!-- Smart Action Buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="openAddAreaModal()">
                            <span>➕</span> إضافة منطقة جديدة
                        </button>
                        <button class="btn btn-primary" onclick="refreshAreasList()">
                            <span>🔄</span> تحديث القائمة
                        </button>
                        <button class="btn btn-warning" onclick="sortAreasByName()">
                            <span>🔤</span> ترتيب أبجدياً
                        </button>
                        <button class="btn btn-info" onclick="mergeAreas()">
                            <span>🔗</span> دمج مناطق
                        </button>
                        <button class="btn btn-success" onclick="assignShopsToAreas()">
                            <span>📍</span> تعيين المحلات
                        </button>
                        <button class="btn btn-warning" onclick="exportAreasData()">
                            <span>📤</span> تصدير البيانات
                        </button>
                        <button class="btn btn-info" onclick="importAreasFromFile()">
                            <span>📥</span> استيراد مناطق
                        </button>
                        <button class="btn btn-danger" onclick="bulkEditAreas()">
                            <span>✏️</span> تعديل جماعي
                        </button>
                        <button class="btn btn-success" onclick="generateAreasReport()">
                            <span>📊</span> تقرير المناطق
                        </button>
                    </div>
                    
                    <!-- Search -->
                    <div class="search-box">
                        <input type="text" id="searchArea" placeholder="ابحث عن منطقة..." oninput="filterAreasList()">
                        <span class="search-icon">🔍</span>
                    </div>
                    
                    <!-- Areas Stats -->
                    <div class="inspector-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalAreasManagement">0</div>
                            <div class="stat-label">إجمالي المناطق</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="filteredAreasCount">0</div>
                            <div class="stat-label">المناطق المعروضة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalShopsInAreas">0</div>
                            <div class="stat-label">إجمالي المحلات</div>
                        </div>
                    </div>
                    
                    <!-- Areas List Table -->
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table class="inspections-table" id="areasManagementTable">
                            <thead>
                                <tr>
                                    <th>اسم المنطقة</th>
                                    <th>رقم التعريف</th>
                                    <th>عدد المحلات</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="areasManagementBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 40px;">
                                        جاري تحميل البيانات...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="status-message" id="areasManagementStatus"></div>
                </div>
            </div>
        </div>
        
        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>✏️ تحرير التفتيش</h2>
                    <span class="modal-close" onclick="closeEditModal()">&times;</span>
                </div>
                <input type="hidden" id="editInspectionIndex">
                <div class="form-group">
                    <label class="form-label">المفتش</label>
                    <select id="editInspector" class="form-control">
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">التاريخ</label>
                    <input type="date" id="editDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">المناوبة</label>
                    <select id="editShift" class="form-control">
                        <option value="صباحية">صباحية</option>
                        <option value="مسائية">مسائية</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">المنطقة</label>
                    <select id="editArea" class="form-control">
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">المحلات (مفصولة بفواصل)</label>
                    <textarea id="editShops" class="form-control" rows="6" 
                              placeholder="محل 1، محل 2، محل 3..."></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveEditedInspection()">
                        <span>💾</span> حفظ التغييرات
                    </button>
                    <button class="btn btn-warning" onclick="closeEditModal()">
                        <span>✕</span> إلغاء
                    </button>
                </div>
                <div class="status-message" id="editStatus"></div>
            </div>
        </div>
        
        <!-- Add/Edit Shop Modal -->
        <div id="shopModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="shopModalTitle">➕ إضافة محل جديد</h2>
                    <span class="modal-close" onclick="closeShopModal()">&times;</span>
                </div>
                <input type="hidden" id="shopModalId">
                <div class="form-group">
                    <label class="form-label">اسم المحل <span style="color: red;">*</span></label>
                    <input type="text" id="shopModalName" class="form-control" placeholder="أدخل اسم المحل">
                </div>
                <div class="form-group">
                    <label class="form-label">المنطقة <span style="color: red;">*</span></label>
                    <select id="shopModalArea" class="form-control">
                        <option value="">اختر المنطقة...</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveShop()">
                        <span>💾</span> حفظ
                    </button>
                    <button class="btn btn-warning" onclick="closeShopModal()">
                        <span>✕</span> إلغاء
                    </button>
                </div>
                <div class="status-message" id="shopModalStatus"></div>
            </div>
        </div>
        
        <!-- Add/Edit Area Modal -->
        <div id="areaModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="areaModalTitle">➕ إضافة منطقة جديدة</h2>
                    <span class="modal-close" onclick="closeAreaModal()">&times;</span>
                </div>
                <input type="hidden" id="areaModalId">
                <div class="form-group">
                    <label class="form-label">اسم المنطقة <span style="color: red;">*</span></label>
                    <input type="text" id="areaModalName" class="form-control" placeholder="أدخل اسم المنطقة">
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveArea()">
                        <span>💾</span> حفظ
                    </button>
                    <button class="btn btn-warning" onclick="closeAreaModal()">
                        <span>✕</span> إلغاء
                    </button>
                </div>
                <div class="status-message" id="areaModalStatus"></div>
            </div>
        </div>
        
        <!-- Smart Shop List Modal -->
        <div id="smartShopListModal" class="modal">
            <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>📋 قائمة المحلات الذكية</h2>
                    <span class="modal-close" onclick="closeSmartShopListModal()">&times;</span>
                </div>
                
                <!-- Filters and Controls -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                    <h3 style="margin-bottom: 15px;">⚙️ خيارات التنظيم والترتيب</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">الترتيب الرئيسي:</label>
                            <select id="primarySort" class="form-control" onchange="updateSmartShopList()">
                                <option value="rating">حسب التقييم (الأعلى أولاً)</option>
                                <option value="area">حسب المنطقة</option>
                                <option value="activity">حسب النشاط</option>
                                <option value="alphabetical">أبجدي (أ-ي)</option>
                                <option value="lastInspection">حسب آخر تفتيش</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">فلترة حسب المنطقة:</label>
                            <select id="smartListAreaFilter" class="form-control" onchange="updateSmartShopList()">
                                <option value="">جميع المناطق</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">فلترة حسب التقييم:</label>
                            <select id="ratingFilter" class="form-control" onchange="updateSmartShopList()">
                                <option value="">جميع التقييمات</option>
                                <option value="excellent">ممتاز (90+)</option>
                                <option value="good">جيد (70-89)</option>
                                <option value="fair">مقبول (50-69)</option>
                                <option value="poor">ضعيف (أقل من 50)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">عرض الجداول:</label>
                            <select id="tableView" class="form-control" onchange="updateSmartShopList()">
                                <option value="unified">جدول موحد</option>
                                <option value="byArea">جدول لكل منطقة</option>
                                <option value="byActivity">جدول حسب النشاط</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="exportSmartShopList('excel')" style="background: white; color: #667eea;">
                            <span>📊</span> تصدير Excel
                        </button>
                        <button class="btn btn-primary" onclick="exportSmartShopList('pdf')" style="background: white; color: #667eea;">
                            <span>📄</span> تصدير PDF
                        </button>
                        <button class="btn btn-info" onclick="exportSmartShopList('json')" style="background: white; color: #667eea;">
                            <span>💾</span> تصدير JSON
                        </button>
                        <button class="btn btn-warning" onclick="printSmartShopList()" style="background: white; color: #667eea;">
                            <span>🖨️</span> طباعة
                        </button>
                    </div>
                </div>
                
                <!-- Statistics Summary -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div style="background: #667eea; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListTotalShops">0</div>
                        <div>إجمالي المحلات</div>
                    </div>
                    <div style="background: #11998e; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListAvgRating">0</div>
                        <div>متوسط التقييم</div>
                    </div>
                    <div style="background: #3498db; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListAreas">0</div>
                        <div>عدد المناطق</div>
                    </div>
                    <div style="background: #e74c3c; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;" id="smartListHighPriority">0</div>
                        <div>أولوية عالية</div>
                    </div>
                </div>
                
                <!-- Shop List Content -->
                <div id="smartShopListContent" style="margin-top: 20px;">
                    <p style="text-align: center; padding: 40px; color: #999;">
                        جاري تحميل القائمة الذكية...
                    </p>
                </div>
                
                <div class="status-message" id="smartShopListStatus"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let planData = null;
        let shopsDetails = null;
        let selectedShops = [];
        let githubToken = null;
        const repo = "aliabdelaal-adm/Monthly_inspection_plan";
        let currentEditingIndex = -1;
        let selectedInspectionsForDelete = [];
        let showingHighPriority = false;
        let currentAvailableShops = [];
        let currentHighPriorityShops = [];
        
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'view') {
                loadInspectionsView();
            } else if (tabName === 'stats') {
                populateStatsInspector();
            } else if (tabName === 'calendar') {
                // Set default month to current month
                const now = new Date();
                document.getElementById('calendarMonth').value = 
                    `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                loadCalendar();
            } else if (tabName === 'shops') {
                loadShopsManagement();
            } else if (tabName === 'areas') {
                loadAreasManagement();
            }
        }
        
        // Login developer
        async function loginDeveloper() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                showMessage('loginStatus', 'error', '❌ يرجى إدخال GitHub Token');
                return;
            }
            
            githubToken = token;
            localStorage.setItem('devToken', token);
            
            showMessage('loginStatus', 'info', '⏳ جاري التحقق من الصلاحيات...');
            
            try {
                // Load data from GitHub
                await loadPlanData();
                await loadShopsDetails();
                
                // Initialize UI
                populateInspectors();
                populateAreas();
                populateFilterDropdowns();
                
                // Set default date to today
                document.getElementById('inspectionDate').valueAsDate = new Date();
                
                // Hide login section and show main interface
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainInterface').style.display = 'block';
                
                showMessage('loginStatus', 'success', '✅ تم تسجيل الدخول بنجاح!');
                
            } catch (error) {
                showMessage('loginStatus', 'error', '❌ فشل تحميل البيانات: ' + error.message);
                githubToken = null;
            }
        }
        
        // Load plan data from GitHub
        async function loadPlanData() {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!res.ok) {
                throw new Error('فشل تحميل plan-data.json');
            }
            
            const file = await res.json();
            planData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
        }
        
        // Load shops details from GitHub
        async function loadShopsDetails() {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!res.ok) {
                throw new Error('فشل تحميل shops_details.json');
            }
            
            const file = await res.json();
            shopsDetails = JSON.parse(decodeURIComponent(escape(atob(file.content))));
        }
        
        // Populate inspectors dropdown
        function populateInspectors() {
            const select = document.getElementById('inspectorSelect');
            select.innerHTML = '<option value="">اختر المفتش...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const option = document.createElement('option');
                    option.value = inspector.name;
                    option.textContent = inspector.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Populate areas dropdown
        function populateAreas() {
            const select = document.getElementById('areaSelect');
            select.innerHTML = '<option value="">اختر المنطقة...</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.name;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Update available shops based on selection
        function updateAvailableShops() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector || !date || !area) {
                document.getElementById('shopsListContainer').innerHTML = 
                    '<p style="text-align: center; color: #999; padding: 20px;">اختر المفتش والتاريخ والمنطقة لعرض المحلات المتاحة</p>';
                document.getElementById('showHighPriorityBtn').style.display = 'none';
                return;
            }
            
            // Get all shops for the selected area
            const allShops = getAllShopsInArea(area);
            
            // Filter shops based on smart rules
            const availableShops = filterSmartShops(allShops, inspector, date);
            
            // Sort shops by priority
            const sortedShops = sortShopsByPriority(availableShops, inspector, date);
            
            // Get high-priority shops that were filtered out
            const unavailableShops = allShops.filter(shop => !availableShops.includes(shop));
            const highPriorityUnavailable = sortShopsByPriority(unavailableShops, inspector, date)
                .filter(shop => shop.priority === 'very-high' || shop.priority === 'high');
            
            // Store for later use
            currentAvailableShops = sortedShops;
            currentHighPriorityShops = highPriorityUnavailable;
            
            // Show/hide the high priority button based on availability
            const highPriorityBtn = document.getElementById('showHighPriorityBtn');
            if (currentHighPriorityShops.length > 0) {
                highPriorityBtn.style.display = 'inline-flex';
            } else {
                highPriorityBtn.style.display = 'none';
            }
            
            // Reset showing state
            showingHighPriority = false;
            document.getElementById('highPriorityBtnText').textContent = 'عرض المحلات ذات الأولوية العالية';
            document.getElementById('highPriorityBtnIcon').textContent = '👁️';
            
            // Update statistics
            updateStatistics(allShops.length, availableShops.length, sortedShops);
            
            // Display shops
            displayShops(sortedShops);
        }
        
        // Get all shops in an area
        function getAllShopsInArea(area) {
            const shops = [];
            
            if (!planData) return shops;
            
            // First, try to get shops from the planData.shops array (primary source)
            if (planData.shops && planData.areas) {
                // Find the area ID for the given area name
                const areaObj = planData.areas.find(a => a.name === area);
                
                if (areaObj) {
                    // Get all shops that belong to this area
                    const shopsInArea = planData.shops
                        .filter(shop => shop.areaId === areaObj.id)
                        .map(shop => shop.name);
                    
                    if (shopsInArea.length > 0) {
                        return shopsInArea;
                    }
                }
            }
            
            // Fallback: Collect all unique shops from inspection history
            // This ensures backward compatibility if shops array is not available
            if (planData.inspectionData) {
                const shopSet = new Set();
                planData.inspectionData.forEach(inspection => {
                    if (inspection.area === area && inspection.shops) {
                        inspection.shops.forEach(shop => shopSet.add(shop));
                    }
                });
                
                return Array.from(shopSet);
            }
            
            return shops;
        }
        
        // Filter shops based on smart rules
        function filterSmartShops(shops, inspector, date) {
            const available = [];
            
            shops.forEach(shop => {
                // Rule 1: Check if shop is already assigned to ANY inspector on the same day
                const assignedToday = isShopAssignedToday(shop, date);
                
                // Rule 2: Check if shop was inspected by THIS inspector in the last 7 days
                const recentlyInspected = wasShopRecentlyInspected(shop, inspector, date);
                
                // If shop passes both rules, it's available
                if (!assignedToday && !recentlyInspected) {
                    available.push(shop);
                }
            });
            
            return available;
        }
        
        // Check if shop is already assigned to any inspector on the same day
        function isShopAssignedToday(shop, date) {
            if (!planData || !planData.inspectionData) return false;
            
            return planData.inspectionData.some(inspection => {
                return inspection.day === date && 
                       inspection.shops && 
                       inspection.shops.includes(shop);
            });
        }
        
        // Check if shop was recently inspected by the same inspector (within 7 days)
        function wasShopRecentlyInspected(shop, inspector, date) {
            if (!planData || !planData.inspectionData) return false;
            
            const targetDate = new Date(date);
            const sevenDaysAgo = new Date(targetDate);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            return planData.inspectionData.some(inspection => {
                if (inspection.inspector !== inspector) return false;
                if (!inspection.shops || !inspection.shops.includes(shop)) return false;
                
                const inspectionDate = new Date(inspection.day);
                return inspectionDate > sevenDaysAgo && inspectionDate < targetDate;
            });
        }
        
        // Sort shops by priority
        function sortShopsByPriority(shops, inspector, date) {
            return shops.map(shop => {
                const priority = calculateShopPriority(shop, inspector, date);
                return { name: shop, priority: priority.level, score: priority.score, reason: priority.reason };
            }).sort((a, b) => b.score - a.score);
        }
        
        // Calculate shop priority
        function calculateShopPriority(shop, inspector, date) {
            let score = 0;
            let reasons = [];
            
            // Find last inspection date for this shop (by any inspector)
            const lastInspection = getLastInspectionDate(shop);
            
            if (!lastInspection) {
                score += 100; // Never inspected = highest priority
                reasons.push('لم يتم تفتيشه من قبل');
            } else {
                const targetDate = new Date(date);
                const lastDate = new Date(lastInspection);
                const daysSince = Math.floor((targetDate - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysSince > 30) {
                    score += 80;
                    reasons.push(`آخر تفتيش قبل ${daysSince} يوم`);
                } else if (daysSince > 21) {
                    score += 60;
                    reasons.push(`آخر تفتيش قبل ${daysSince} يوم`);
                } else if (daysSince > 14) {
                    score += 40;
                    reasons.push(`آخر تفتيش قبل ${daysSince} يوم`);
                } else {
                    score += 20;
                    reasons.push(`آخر تفتيش قبل ${daysSince} يوم`);
                }
            }
            
            // Priority based on shop type (if available in shops_details)
            if (shopsDetails && shopsDetails[shop]) {
                const activity = shopsDetails[shop].activity || '';
                if (activity.includes('يجب تسجيلها')) {
                    score += 30;
                    reasons.push('نشاط يتطلب التسجيل');
                }
            }
            
            // Check if we're in the second half of the month (from 15th onwards)
            // Boost priority for high-priority shops to ensure they're inspected before month end
            const targetDate = new Date(date);
            const dayOfMonth = targetDate.getDate();
            if (dayOfMonth >= 15) {
                // From the 15th onwards, boost high priority shops to "very high"
                if (score >= 80) {
                    score += 50; // Boost very high priority shops even more
                    reasons.push('أولوية النصف الثاني من الشهر');
                } else if (score >= 50) {
                    score += 20; // Moderate boost for medium priority
                }
            }
            
            // Determine priority level
            let level = 'low';
            if (score >= 130) level = 'very-high'; // Very high priority (from 15th onwards)
            else if (score >= 80) level = 'high';
            else if (score >= 50) level = 'medium';
            
            return { level, score, reason: reasons.join(' - ') };
        }
        
        // Get last inspection date for a shop
        function getLastInspectionDate(shop) {
            if (!planData || !planData.inspectionData) return null;
            
            let lastDate = null;
            
            planData.inspectionData.forEach(inspection => {
                if (inspection.shops && inspection.shops.includes(shop)) {
                    if (!lastDate || inspection.day > lastDate) {
                        lastDate = inspection.day;
                    }
                }
            });
            
            return lastDate;
        }
        
        // Update statistics
        function updateStatistics(total, available, sortedShops) {
            document.getElementById('totalShopsCount').textContent = total;
            document.getElementById('availableShopsCount').textContent = available;
            
            const veryHighPriority = sortedShops.filter(s => s.priority === 'very-high').length;
            const highPriority = sortedShops.filter(s => s.priority === 'high').length;
            document.getElementById('highPriorityCount').textContent = veryHighPriority + highPriority;
            
            document.getElementById('selectedShopsCount').textContent = selectedShops.length;
        }
        
        // HTML escape function to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Display shops
        function displayShops(shops, showingHighPriority = false) {
            const container = document.getElementById('shopsListContainer');
            
            if (shops.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">لا توجد محلات متاحة حسب المعايير المحددة</p>';
                return;
            }
            
            // Clear container (except info message if it exists)
            const infoDiv = document.getElementById('highPriorityInfo');
            container.innerHTML = '';
            if (infoDiv && showingHighPriority) {
                container.appendChild(infoDiv);
            }
            
            // Create shops list container
            const shopsListDiv = document.createElement('div');
            shopsListDiv.className = 'shops-list';
            
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            
            shops.forEach(shop => {
                const isSelected = selectedShops.includes(shop.name);
                const lastInspection = getLastInspectionDate(shop.name);
                
                // Check if this shop is from the high-priority unavailable list
                const isHighPriorityUnavailable = currentHighPriorityShops.some(s => s.name === shop.name);
                
                // Create shop card element
                const shopCard = document.createElement('div');
                shopCard.className = `shop-card ${shop.priority}-priority ${isSelected ? 'selected' : ''}`;
                
                // Add visual indicator for high-priority unavailable shops
                if (isHighPriorityUnavailable) {
                    shopCard.style.border = '3px solid #ff6b6b';
                    shopCard.style.opacity = '0.85';
                }
                
                shopCard.onclick = function() { toggleShop(shop.name); };
                
                // Priority badge
                const priorityBadge = document.createElement('div');
                priorityBadge.className = `priority-badge ${shop.priority}`;
                priorityBadge.textContent = shop.priority === 'very-high' ? 'أولوية عالية جداً' :
                                            shop.priority === 'high' ? 'أولوية عالية' : 
                                            shop.priority === 'medium' ? 'أولوية متوسطة' : 'أولوية منخفضة';
                
                // Shop name
                const shopName = document.createElement('div');
                shopName.className = 'shop-name';
                shopName.textContent = shop.name;
                
                // Shop info - score
                const shopScore = document.createElement('div');
                shopScore.className = 'shop-info';
                shopScore.textContent = '📊 النقاط: ' + shop.score;
                
                // Shop info - reason
                const shopReason = document.createElement('div');
                shopReason.className = 'shop-info';
                shopReason.textContent = '📝 ' + shop.reason;
                
                // Warning for high-priority unavailable shops
                let warningDiv = null;
                if (isHighPriorityUnavailable) {
                    warningDiv = document.createElement('div');
                    warningDiv.style.cssText = 'background: #fff3cd; color: #856404; padding: 8px; border-radius: 5px; font-size: 0.85em; margin-top: 8px;';
                    
                    // Check why it's unavailable
                    const assignedToday = isShopAssignedToday(shop.name, date);
                    const recentlyInspected = wasShopRecentlyInspected(shop.name, inspector, date);
                    
                    if (assignedToday) {
                        warningDiv.textContent = '⚠️ مكرر: تم تعيينه لمفتش آخر اليوم';
                    } else if (recentlyInspected) {
                        warningDiv.textContent = '⚠️ تم التفتيش: آخر 7 أيام';
                    }
                }
                
                // Last inspection
                const lastInspectionDiv = document.createElement('div');
                lastInspectionDiv.className = 'last-inspection';
                lastInspectionDiv.textContent = '📅 آخر تفتيش: ' + (lastInspection || 'لم يتم التفتيش بعد');
                
                // Append all elements
                shopCard.appendChild(priorityBadge);
                shopCard.appendChild(shopName);
                shopCard.appendChild(shopScore);
                shopCard.appendChild(shopReason);
                if (warningDiv) {
                    shopCard.appendChild(warningDiv);
                }
                shopCard.appendChild(lastInspectionDiv);
                
                shopsListDiv.appendChild(shopCard);
            });
            
            container.appendChild(shopsListDiv);
        }
        
        // Toggle shop selection
        function toggleShop(shopName) {
            const index = selectedShops.indexOf(shopName);
            
            if (index > -1) {
                selectedShops.splice(index, 1);
            } else {
                selectedShops.push(shopName);
            }
            
            updateSelectedShopsDisplay();
            updateAvailableShops();
            updatePreview();
        }
        
        // Update selected shops display
        function updateSelectedShopsDisplay() {
            const container = document.getElementById('selectedShopsContainer');
            const list = document.getElementById('selectedShopsList');
            
            if (selectedShops.length === 0) {
                container.style.display = 'none';
                document.getElementById('saveBtn').disabled = true;
                return;
            }
            
            container.style.display = 'block';
            document.getElementById('saveBtn').disabled = false;
            
            // Clear list
            list.innerHTML = '';
            
            // Create shop tags safely
            selectedShops.forEach(shop => {
                const tag = document.createElement('div');
                tag.className = 'selected-shop-tag';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = shop;
                
                const removeSpan = document.createElement('span');
                removeSpan.className = 'remove';
                removeSpan.textContent = '×';
                removeSpan.onclick = function() { toggleShop(shop); };
                
                tag.appendChild(nameSpan);
                tag.appendChild(removeSpan);
                list.appendChild(tag);
            });
            
            document.getElementById('selectedShopsCount').textContent = selectedShops.length;
        }
        
        // Update preview
        function updatePreview() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const shift = document.getElementById('shiftSelect').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector || !date || !area || selectedShops.length === 0) {
                document.getElementById('inspectionPreview').style.display = 'none';
                return;
            }
            
            document.getElementById('inspectionPreview').style.display = 'block';
            document.getElementById('previewInspector').textContent = inspector;
            document.getElementById('previewDate').textContent = date;
            document.getElementById('previewShift').textContent = shift;
            document.getElementById('previewArea').textContent = area;
            document.getElementById('previewShopsCount').textContent = selectedShops.length;
        }
        
        // Toggle high priority shops display
        function toggleHighPriorityShops() {
            showingHighPriority = !showingHighPriority;
            
            if (showingHighPriority) {
                // Show both available and high-priority shops
                const combinedShops = [...currentAvailableShops, ...currentHighPriorityShops];
                displayShops(combinedShops, true);
                
                // Update button text
                document.getElementById('highPriorityBtnText').textContent = 'إخفاء المحلات ذات الأولوية العالية';
                document.getElementById('highPriorityBtnIcon').textContent = '🚫';
                
                // Show info message
                const container = document.getElementById('shopsListContainer');
                const infoDiv = document.createElement('div');
                infoDiv.id = 'highPriorityInfo';
                infoDiv.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;';
                infoDiv.innerHTML = `
                    <strong>⚠️ تنبيه:</strong> يتم عرض المحلات ذات الأولوية العالية بجانب المحلات المتاحة.
                    <br>
                    <small style="color: #856404;">هذه المحلات قد لا تتوافق مع قواعد التوزيع الذكي (تم تفتيشها مؤخراً أو مكررة في نفس اليوم)</small>
                `;
                container.insertBefore(infoDiv, container.firstChild);
            } else {
                // Show only available shops
                displayShops(currentAvailableShops);
                
                // Update button text
                document.getElementById('highPriorityBtnText').textContent = 'عرض المحلات ذات الأولوية العالية';
                document.getElementById('highPriorityBtnIcon').textContent = '👁️';
                
                // Remove info message
                const infoDiv = document.getElementById('highPriorityInfo');
                if (infoDiv) {
                    infoDiv.remove();
                }
            }
        }
        
        // Populate filter dropdowns
        function populateFilterDropdowns() {
            // Populate inspector filter
            const filterInspector = document.getElementById('filterInspector');
            const statsInspector = document.getElementById('statsInspector');
            const editInspector = document.getElementById('editInspector');
            
            filterInspector.innerHTML = '<option value="">جميع المفتشين</option>';
            statsInspector.innerHTML = '<option value="">اختر المفتش...</option>';
            editInspector.innerHTML = '<option value="">اختر المفتش...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const opt1 = document.createElement('option');
                    opt1.value = inspector.name;
                    opt1.textContent = inspector.name;
                    filterInspector.appendChild(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = inspector.name;
                    opt2.textContent = inspector.name;
                    statsInspector.appendChild(opt2);
                    
                    const opt3 = document.createElement('option');
                    opt3.value = inspector.name;
                    opt3.textContent = inspector.name;
                    editInspector.appendChild(opt3);
                });
            }
            
            // Populate area filter
            const filterArea = document.getElementById('filterArea');
            const editArea = document.getElementById('editArea');
            
            filterArea.innerHTML = '<option value="">جميع المناطق</option>';
            editArea.innerHTML = '<option value="">اختر المنطقة...</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const opt1 = document.createElement('option');
                    opt1.value = area.name;
                    opt1.textContent = area.name;
                    filterArea.appendChild(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = area.name;
                    opt2.textContent = area.name;
                    editArea.appendChild(opt2);
                });
            }
        }
        
        // Load inspections view
        function loadInspectionsView() {
            filterInspections();
        }
        
        // Filter inspections
        function filterInspections() {
            if (!planData || !planData.inspectionData) {
                document.getElementById('inspectionsTableContainer').innerHTML = 
                    '<div class="empty-state"><div class="icon">📭</div><p>لا توجد تفتيشات متاحة</p></div>';
                return;
            }
            
            const filterInspector = document.getElementById('filterInspector').value;
            const filterArea = document.getElementById('filterArea').value;
            const filterDateFrom = document.getElementById('filterDateFrom').value;
            const filterDateTo = document.getElementById('filterDateTo').value;
            const searchText = document.getElementById('searchBox').value.toLowerCase();
            
            let filtered = planData.inspectionData.filter(inspection => {
                // Filter by inspector
                if (filterInspector && inspection.inspector !== filterInspector) return false;
                
                // Filter by area
                if (filterArea && inspection.area !== filterArea) return false;
                
                // Filter by date range
                if (filterDateFrom && inspection.day < filterDateFrom) return false;
                if (filterDateTo && inspection.day > filterDateTo) return false;
                
                // Filter by search text
                if (searchText) {
                    const searchIn = `${inspection.inspector} ${inspection.area} ${inspection.shops.join(' ')}`.toLowerCase();
                    if (!searchIn.includes(searchText)) return false;
                }
                
                return true;
            });
            
            // Sort by date (newest first)
            filtered.sort((a, b) => b.day.localeCompare(a.day));
            
            displayInspectionsTable(filtered);
        }
        
        // Display inspections table
        function displayInspectionsTable(inspections) {
            const container = document.getElementById('inspectionsTableContainer');
            
            if (inspections.length === 0) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">🔍</div><p>لا توجد نتائج مطابقة للفلترة</p></div>';
                return;
            }
            
            let html = '<table class="inspections-table">';
            html += '<thead><tr>';
            html += '<th><input type="checkbox" onchange="toggleAllCheckboxes(this)"></th>';
            html += '<th>المفتش</th>';
            html += '<th>التاريخ</th>';
            html += '<th>المناوبة</th>';
            html += '<th>المنطقة</th>';
            html += '<th>عدد المحلات</th>';
            html += '<th>الإجراءات</th>';
            html += '</tr></thead><tbody>';
            
            inspections.forEach((inspection, index) => {
                // Find original index in planData
                const originalIndex = planData.inspectionData.indexOf(inspection);
                
                html += '<tr>';
                html += `<td><input type="checkbox" class="inspection-checkbox" value="${originalIndex}"></td>`;
                html += `<td>${escapeHtml(inspection.inspector)}</td>`;
                html += `<td>${inspection.day}</td>`;
                html += `<td>${escapeHtml(inspection.shift || 'صباحية')}</td>`;
                html += `<td>${escapeHtml(inspection.area)}</td>`;
                html += `<td>${inspection.shops ? inspection.shops.length : 0}</td>`;
                html += `<td>
                    <span class="action-icon edit-icon" onclick="openEditModal(${originalIndex})" title="تحرير">✏️</span>
                    <span class="action-icon delete-icon" onclick="deleteInspection(${originalIndex})" title="حذف">🗑️</span>
                    <span class="action-icon copy-icon" onclick="copyInspection(${originalIndex})" title="نسخ">📋</span>
                </td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Toggle all checkboxes
        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('.inspection-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = source.checked;
            });
        }
        
        // Open edit modal
        function openEditModal(index) {
            const inspection = planData.inspectionData[index];
            
            document.getElementById('editInspectionIndex').value = index;
            document.getElementById('editInspector').value = inspection.inspector;
            document.getElementById('editDate').value = inspection.day;
            document.getElementById('editShift').value = inspection.shift || 'صباحية';
            document.getElementById('editArea').value = inspection.area;
            document.getElementById('editShops').value = inspection.shops.join('، ');
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editStatus').className = 'status-message';
        }
        
        // Save edited inspection
        async function saveEditedInspection() {
            const index = parseInt(document.getElementById('editInspectionIndex').value);
            const inspector = document.getElementById('editInspector').value;
            const date = document.getElementById('editDate').value;
            const shift = document.getElementById('editShift').value;
            const area = document.getElementById('editArea').value;
            const shopsText = document.getElementById('editShops').value;
            
            if (!inspector || !date || !area || !shopsText) {
                showMessage('editStatus', 'error', '❌ يرجى ملء جميع الحقول');
                return;
            }
            
            // Parse shops
            const shops = shopsText.split('،').map(s => s.trim()).filter(s => s);
            
            if (shops.length === 0) {
                showMessage('editStatus', 'error', '❌ يرجى إضافة محل واحد على الأقل');
                return;
            }
            
            showMessage('editStatus', 'info', '⏳ جاري حفظ التعديلات...');
            
            try {
                // Check for duplicates (excluding current inspection)
                const duplicateIndex = planData.inspectionData.findIndex((insp, idx) => 
                    idx !== index && 
                    insp.inspector === inspector && 
                    insp.day === date
                );
                
                if (duplicateIndex !== -1) {
                    if (confirm('يوجد تفتيش مكرر لنفس المفتش في نفس اليوم. هل تريد حذف التفتيش القديم؟')) {
                        // Delete the duplicate
                        planData.inspectionData.splice(duplicateIndex, 1);
                        // Adjust index if needed
                        if (duplicateIndex < index) {
                            index--;
                        }
                    } else {
                        showMessage('editStatus', 'error', '❌ تم إلغاء الحفظ لتجنب التكرار');
                        return;
                    }
                }
                
                // Update inspection
                planData.inspectionData[index] = {
                    inspector: inspector,
                    day: date,
                    shift: shift,
                    area: area,
                    shops: shops
                };
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`تحديث تفتيش - ${inspector} - ${date}`);
                
                showMessage('editStatus', 'success', '✅ تم حفظ التعديلات بنجاح!');
                
                setTimeout(() => {
                    closeEditModal();
                    filterInspections();
                }, 2000);
                
            } catch (error) {
                showMessage('editStatus', 'error', '❌ فشل حفظ التعديلات: ' + error.message);
            }
        }
        
        // Delete inspection
        async function deleteInspection(index) {
            const inspection = planData.inspectionData[index];
            
            if (!confirm(`هل أنت متأكد من حذف هذا التفتيش؟\n\nالمفتش: ${inspection.inspector}\nالتاريخ: ${inspection.day}\nالمحلات: ${inspection.shops.length}`)) {
                return;
            }
            
            try {
                // Remove inspection
                planData.inspectionData.splice(index, 1);
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`حذف تفتيش - ${inspection.inspector} - ${inspection.day}`);
                
                alert('✅ تم حذف التفتيش بنجاح!');
                filterInspections();
                
            } catch (error) {
                alert('❌ فشل حذف التفتيش: ' + error.message);
            }
        }
        
        // Copy inspection
        function copyInspection(index) {
            const inspection = planData.inspectionData[index];
            
            // Switch to add tab
            document.querySelectorAll('.tab-button')[0].click();
            
            // Fill form with copied data
            document.getElementById('inspectorSelect').value = inspection.inspector;
            document.getElementById('areaSelect').value = inspection.area;
            document.getElementById('shiftSelect').value = inspection.shift || 'صباحية';
            
            // Set date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('inspectionDate').valueAsDate = tomorrow;
            
            // Pre-select shops (if they're available)
            selectedShops = [...inspection.shops];
            
            updateAvailableShops();
            
            alert('✅ تم نسخ بيانات التفتيش! يمكنك الآن تعديل التاريخ والمحلات وحفظ التفتيش الجديد.');
        }
        
        // Delete selected inspections
        async function deleteSelectedInspections() {
            const checkboxes = document.querySelectorAll('.inspection-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('⚠️ يرجى تحديد التفتيشات المراد حذفها');
                return;
            }
            
            if (!confirm(`هل أنت متأكد من حذف ${checkboxes.length} تفتيش؟`)) {
                return;
            }
            
            try {
                // Get indices and sort in descending order (to delete from end to start)
                const indices = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => b - a);
                
                // Delete inspections
                indices.forEach(index => {
                    planData.inspectionData.splice(index, 1);
                });
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`حذف ${indices.length} تفتيش`);
                
                alert(`✅ تم حذف ${indices.length} تفتيش بنجاح!`);
                filterInspections();
                
            } catch (error) {
                alert('❌ فشل حذف التفتيشات: ' + error.message);
            }
        }
        
        // Export inspections
        function exportInspections() {
            const filterInspector = document.getElementById('filterInspector').value;
            const dataToExport = filterInspector ? 
                planData.inspectionData.filter(i => i.inspector === filterInspector) : 
                planData.inspectionData;
            
            const jsonStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inspections-${filterInspector || 'all'}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Load inspector statistics
        function loadInspectorStats() {
            const inspector = document.getElementById('statsInspector').value;
            const container = document.getElementById('statsContainer');
            
            if (!inspector) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">📊</div><p>اختر مفتشاً لعرض الإحصائيات</p></div>';
                return;
            }
            
            // Calculate statistics
            const inspections = planData.inspectionData.filter(i => i.inspector === inspector);
            const totalInspections = inspections.length;
            const totalShops = inspections.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0);
            const areas = new Set(inspections.map(i => i.area)).size;
            const uniqueShops = new Set();
            inspections.forEach(i => i.shops && i.shops.forEach(s => uniqueShops.add(s)));
            
            // Get date range
            const dates = inspections.map(i => new Date(i.day)).sort((a, b) => a - b);
            const firstDate = dates.length > 0 ? dates[0].toLocaleDateString('ar-EG') : '-';
            const lastDate = dates.length > 0 ? dates[dates.length - 1].toLocaleDateString('ar-EG') : '-';
            
            // Calculate inspections per area
            const areaCount = {};
            inspections.forEach(i => {
                areaCount[i.area] = (areaCount[i.area] || 0) + 1;
            });
            
            let html = '<div class="inspector-stats">';
            html += `<div class="stat-card"><div class="stat-value">${totalInspections}</div><div class="stat-label">إجمالي التفتيشات</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${totalShops}</div><div class="stat-label">إجمالي المحلات</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${uniqueShops.size}</div><div class="stat-label">محلات فريدة</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${areas}</div><div class="stat-label">المناطق المغطاة</div></div>`;
            html += '</div>';
            
            html += '<div style="margin-top: 30px;">';
            html += '<h3 style="color: #2d3561; margin-bottom: 15px;">📅 الفترة الزمنية</h3>';
            html += `<p><strong>أول تفتيش:</strong> ${firstDate}</p>`;
            html += `<p><strong>آخر تفتيش:</strong> ${lastDate}</p>`;
            html += '</div>';
            
            html += '<div style="margin-top: 30px;">';
            html += '<h3 style="color: #2d3561; margin-bottom: 15px;">🗺️ توزيع التفتيشات حسب المنطقة</h3>';
            for (const [area, count] of Object.entries(areaCount).sort((a, b) => b[1] - a[1])) {
                html += `<div style="padding: 10px; background: #f8f9fa; margin-bottom: 5px; border-radius: 8px;">`;
                html += `<strong>${escapeHtml(area)}:</strong> ${count} تفتيش`;
                html += `</div>`;
            }
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Populate stats inspector dropdown
        function populateStatsInspector() {
            const select = document.getElementById('statsInspector');
            select.innerHTML = '<option value="">اختر المفتش...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const option = document.createElement('option');
                    option.value = inspector.name;
                    option.textContent = inspector.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load calendar
        function loadCalendar() {
            const monthInput = document.getElementById('calendarMonth').value;
            const container = document.getElementById('calendarContainer');
            
            if (!monthInput) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">📅</div><p>اختر الشهر لعرض التقويم</p></div>';
                return;
            }
            
            const [year, month] = monthInput.split('-').map(Number);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const daysInMonth = lastDay.getDate();
            
            // Get inspections for this month
            const monthStr = monthInput;
            const monthInspections = planData.inspectionData.filter(i => 
                i.day.startsWith(monthStr)
            );
            
            // Group by date
            const inspectionsByDate = {};
            monthInspections.forEach(i => {
                if (!inspectionsByDate[i.day]) {
                    inspectionsByDate[i.day] = [];
                }
                inspectionsByDate[i.day].push(i);
            });
            
            let html = '<div style="margin-bottom: 20px;">';
            html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; font-weight: bold; text-align: center; color: #667eea;">';
            const daysOfWeek = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            daysOfWeek.forEach(day => {
                html += `<div style="padding: 10px;">${day}</div>`;
            });
            html += '</div>';
            html += '<div class="calendar-view">';
            
            // Add empty cells for days before first day of month
            const startDay = firstDay.getDay();
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day" style="opacity: 0.3;"></div>';
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayInspections = inspectionsByDate[dateStr] || [];
                const hasInspection = dayInspections.length > 0;
                
                html += `<div class="calendar-day ${hasInspection ? 'has-inspection' : ''}">`;
                html += `<div class="day-number">${day}</div>`;
                
                dayInspections.forEach(insp => {
                    html += `<div class="inspection-badge" title="${escapeHtml(insp.inspector)} - ${escapeHtml(insp.area)}">`;
                    html += `${escapeHtml(insp.inspector.split(' ')[1] || insp.inspector)}`;
                    html += `</div>`;
                });
                
                html += '</div>';
            }
            
            html += '</div></div>';
            
            // Add summary
            html += '<div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">';
            html += `<h3 style="color: #2d3561; margin-bottom: 15px;">📊 ملخص الشهر</h3>`;
            html += `<p><strong>إجمالي التفتيشات:</strong> ${monthInspections.length}</p>`;
            html += `<p><strong>إجمالي المحلات:</strong> ${monthInspections.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0)}</p>`;
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Save inspection to GitHub
        async function saveInspection() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const shift = document.getElementById('shiftSelect').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector || !date || !area || selectedShops.length === 0) {
                showMessage('planningStatus', 'error', '❌ يرجى ملء جميع الحقول واختيار المحلات');
                return;
            }
            
            // Check for duplicate inspection (same inspector and date)
            const duplicateIndex = planData.inspectionData.findIndex(insp => 
                insp.inspector === inspector && insp.day === date
            );
            
            let confirmMessage = `هل أنت متأكد من إضافة هذا التفتيش؟\n\nالمفتش: ${inspector}\nالتاريخ: ${date}\nالمحلات: ${selectedShops.length}`;
            
            if (duplicateIndex !== -1) {
                confirmMessage = `⚠️ تنبيه: يوجد تفتيش مكرر لنفس المفتش في نفس اليوم!\n\nهل تريد حذف التفتيش القديم وإضافة التفتيش الجديد؟\n\nالمفتش: ${inspector}\nالتاريخ: ${date}\nالمحلات الجديدة: ${selectedShops.length}`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            showMessage('planningStatus', 'info', '⏳ جاري حفظ التفتيش...');
            document.getElementById('saveBtn').disabled = true;
            
            try {
                // Delete duplicate if exists
                if (duplicateIndex !== -1) {
                    planData.inspectionData.splice(duplicateIndex, 1);
                    showMessage('planningStatus', 'info', '⏳ تم حذف التفتيش المكرر... جاري حفظ التفتيش الجديد...');
                }
                
                // Create new inspection entry
                const newInspection = {
                    inspector: inspector,
                    day: date,
                    shift: shift,
                    area: area,
                    shops: [...selectedShops]
                };
                
                // Add to plan data
                planData.inspectionData.push(newInspection);
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`إضافة تفتيش جديد - ${inspector} - ${date}`);
                
                let successMsg = `✅ تم حفظ التفتيش بنجاح!\n\n📊 المفتش: ${inspector}\n📅 التاريخ: ${date}\n🏪 عدد المحلات: ${selectedShops.length}`;
                
                if (duplicateIndex !== -1) {
                    successMsg += '\n\n🗑️ تم حذف التفتيش المكرر تلقائياً';
                }
                
                successMsg += '\n\n✨ التحديثات ستظهر فوراً في الموقع!';
                
                showMessage('planningStatus', 'success', successMsg);
                
                // Reset form
                setTimeout(() => {
                    resetForm();
                }, 3000);
                
            } catch (error) {
                showMessage('planningStatus', 'error', '❌ فشل حفظ التفتيش: ' + error.message);
                document.getElementById('saveBtn').disabled = false;
            }
        }
        
        // Save plan data to GitHub
        async function savePlanDataToGitHub(commitMessage = null) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('فشل الحصول على ملف plan-data.json');
            }
            
            const file = await getRes.json();
            const sha = file.sha;
            
            // Prepare content
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(planData, null, 2))));
            
            // Default commit message if not provided
            if (!commitMessage) {
                const inspector = document.getElementById('inspectorSelect').value;
                const date = document.getElementById('inspectionDate').value;
                commitMessage = `إضافة تفتيش جديد - ${inspector} - ${date}`;
            }
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateRes.ok) {
                throw new Error('فشل تحديث ملف plan-data.json');
            }
        }
        
        // Reset form
        function resetForm() {
            document.getElementById('inspectorSelect').value = '';
            document.getElementById('inspectionDate').valueAsDate = new Date();
            document.getElementById('shiftSelect').value = 'صباحية';
            document.getElementById('areaSelect').value = '';
            selectedShops = [];
            
            document.getElementById('shopsListContainer').innerHTML = 
                '<p style="text-align: center; color: #999; padding: 20px;">اختر المفتش والتاريخ والمنطقة لعرض المحلات المتاحة</p>';
            
            document.getElementById('selectedShopsContainer').style.display = 'none';
            document.getElementById('inspectionPreview').style.display = 'none';
            document.getElementById('saveBtn').disabled = true;
            
            updateStatistics(0, 0, []);
        }
        
        // Show message
        function showMessage(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.className = `status-message ${type} show`;
            el.textContent = message;
            
            setTimeout(() => {
                el.classList.remove('show');
            }, type === 'success' ? 5000 : 10000);
        }
        
        // Check if user is already logged in
        window.onload = function() {
            const savedToken = localStorage.getItem('devToken');
            if (savedToken) {
                document.getElementById('githubToken').value = savedToken;
                // Auto-set the token in the global variable
                githubToken = savedToken;
                // Load maintenance config immediately if we have a token
                loadMaintenanceConfig();
            }
        };
        
        // ============================================
        // SHOPS MANAGEMENT FUNCTIONS
        // ============================================
        
        // Load shops management tab
        function loadShopsManagement() {
            populateShopAreaFilter();
            displayShopsList();
        }
        
        // Populate area filter for shops
        function populateShopAreaFilter() {
            const select = document.getElementById('filterShopArea');
            select.innerHTML = '<option value="">جميع المناطق</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Display shops list with full details from shops_details.json
        async function displayShopsList() {
            const tbody = document.getElementById('shopsManagementBody');
            const searchTerm = document.getElementById('searchShop').value.toLowerCase();
            const filterAreaId = document.getElementById('filterShopArea').value;
            
            // Load shops_details.json for complete information
            let shopsDetails = {};
            try {
                const response = await fetch('shops_details.json?' + new Date().getTime());
                if (response.ok) {
                    shopsDetails = await response.json();
                }
            } catch (error) {
                console.error('Error loading shops_details.json:', error);
            }
            
            const totalShopsInDetails = Object.keys(shopsDetails).length;
            
            // Create combined shop list from both sources
            const allShops = [];
            
            // Add shops from shops_details.json
            Object.entries(shopsDetails).forEach(([shopName, shopInfo]) => {
                allShops.push({
                    name: shopInfo.nameAr || shopName,
                    nameEn: shopInfo.nameEn || '',
                    licenseNo: shopInfo.licenseNo || '',
                    admCode: shopInfo.admCode || '',
                    address: shopInfo.address || '',
                    contact: shopInfo.contact || '',
                    locationMap: shopInfo.locationMap || '',
                    activity: shopInfo.activity || '',
                    area: shopInfo.area || '',
                    areaId: shopInfo.areaId || '',
                    source: 'shops_details'
                });
            });
            
            // Add shops from plan-data.json if not already in list
            if (planData && planData.shops) {
                planData.shops.forEach(shop => {
                    if (!allShops.find(s => s.name === shop.name)) {
                        allShops.push({
                            ...shop,
                            source: 'plan_data'
                        });
                    }
                });
            }
            
            // Filter shops
            let filteredShops = allShops.filter(shop => {
                const matchesSearch = shop.name.toLowerCase().includes(searchTerm) ||
                                    (shop.nameEn && shop.nameEn.toLowerCase().includes(searchTerm)) ||
                                    (shop.licenseNo && shop.licenseNo.toLowerCase().includes(searchTerm)) ||
                                    (shop.admCode && shop.admCode.toLowerCase().includes(searchTerm));
                const matchesArea = !filterAreaId || shop.areaId === filterAreaId || shop.area === filterAreaId;
                return matchesSearch && matchesArea;
            });
            
            // Update statistics
            document.getElementById('totalShopsManagement').textContent = allShops.length;
            document.getElementById('filteredShopsCount').textContent = filteredShops.length;
            document.getElementById('totalAreasInShops').textContent = planData?.areas ? planData.areas.length : 0;
            
            if (filteredShops.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">لا توجد محلات مطابقة</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            filteredShops.forEach((shop, idx) => {
                const area = planData?.areas?.find(a => a.id === shop.areaId || a.name === shop.area);
                const tr = document.createElement('tr');
                
                // Create detailed shop info popup
                let shopDetails = `<strong>${shop.name}</strong>`;
                if (shop.nameEn) shopDetails += `<br><small style="color: #666;">${shop.nameEn}</small>`;
                if (shop.licenseNo) shopDetails += `<br><small>🔖 رخصة: ${shop.licenseNo}</small>`;
                if (shop.admCode) shopDetails += `<br><small>🔢 كود ADM: ${shop.admCode}</small>`;
                if (shop.address) shopDetails += `<br><small>📍 ${shop.address}</small>`;
                if (shop.contact) shopDetails += `<br><small>📞 ${shop.contact}</small>`;
                if (shop.activity) shopDetails += `<br><small>💼 ${shop.activity}</small>`;
                if (shop.locationMap) shopDetails += `<br><small><a href="${shop.locationMap}" target="_blank">🗺️ عرض على الخريطة</a></small>`;
                
                tr.innerHTML = `
                    <td>
                        <div style="cursor: help;" title="${shop.nameEn || ''}">${shop.name}</div>
                        ${shop.licenseNo ? `<small style="color: #999; display: block;">🔖 ${shop.licenseNo}</small>` : ''}
                        ${shop.admCode ? `<small style="color: #999; display: block;">🔢 ${shop.admCode}</small>` : ''}
                    </td>
                    <td>${area ? area.name : (shop.area || 'غير محدد')}</td>
                    <td style="font-family: monospace; font-size: 0.85em;">${shop.id || shop.admCode || idx}</td>
                    <td>
                        <span class="action-icon" onclick="viewShopDetails('${escapeHtml(shop.name)}')" title="عرض التفاصيل" style="color: #3498db;">👁️</span>
                        <span class="action-icon edit-icon" onclick="openEditShopModal('${shop.id || idx}')" title="تعديل">✏️</span>
                        <span class="action-icon delete-icon" onclick="deleteShop('${shop.id || idx}')" title="حذف">🗑️</span>
                        <span class="action-icon copy-icon" onclick="copyShopInfo('${escapeHtml(shop.name)}')" title="نسخ المعلومات">📋</span>
                        ${shop.locationMap ? `<span class="action-icon" onclick="window.open('${shop.locationMap}', '_blank')" title="موقع على الخريطة" style="color: #27ae60;">🗺️</span>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Show success message if we loaded shops from details
            if (totalShopsInDetails > 0) {
                console.log(`✅ تم تحميل ${totalShopsInDetails} محل من shops_details.json`);
            }
        }
        
        // View shop full details
        function viewShopDetails(shopName) {
            fetch('shops_details.json?' + new Date().getTime())
                .then(response => response.json())
                .then(shopsDetails => {
                    const shop = shopsDetails[shopName];
                    if (!shop) {
                        alert('❌ لم يتم العثور على تفاصيل المحل');
                        return;
                    }
                    
                    let details = `🏪 تفاصيل المحل الكاملة\n`;
                    details += `${'='.repeat(50)}\n\n`;
                    details += `📝 الاسم بالعربي: ${shop.nameAr || shopName}\n`;
                    if (shop.nameEn) details += `📝 الاسم بالإنجليزي: ${shop.nameEn}\n`;
                    if (shop.licenseNo) details += `🔖 رقم الرخصة: ${shop.licenseNo}\n`;
                    if (shop.admCode) details += `🔢 كود ADM: ${shop.admCode}\n`;
                    if (shop.address) details += `📍 العنوان: ${shop.address}\n`;
                    if (shop.contact) details += `📞 الهاتف: ${shop.contact}\n`;
                    if (shop.activity) details += `💼 النشاط: ${shop.activity}\n`;
                    if (shop.locationMap) details += `🗺️ الموقع: متوفر على الخريطة\n`;
                    
                    alert(details);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('❌ فشل تحميل تفاصيل المحل');
                });
        }
        
        // Copy shop info
        function copyShopInfo(shopName) {
            fetch('shops_details.json?' + new Date().getTime())
                .then(response => response.json())
                .then(shopsDetails => {
                    const shop = shopsDetails[shopName];
                    if (!shop) {
                        navigator.clipboard.writeText(shopName).then(() => {
                            alert('✅ تم نسخ اسم المحل');
                        });
                        return;
                    }
                    
                    let info = `${shop.nameAr || shopName}`;
                    if (shop.nameEn) info += ` | ${shop.nameEn}`;
                    if (shop.licenseNo) info += ` | رخصة: ${shop.licenseNo}`;
                    if (shop.admCode) info += ` | ADM: ${shop.admCode}`;
                    
                    navigator.clipboard.writeText(info).then(() => {
                        alert('✅ تم نسخ معلومات المحل');
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    navigator.clipboard.writeText(shopName).then(() => {
                        alert('✅ تم نسخ اسم المحل');
                    });
                });
        }
        
        // Filter shops list
        function filterShopsList() {
            displayShopsList();
        }
        
        // Refresh shops list
        async function refreshShopsList() {
            showMessage('shopsManagementStatus', 'info', '⏳ جاري تحديث البيانات...');
            try {
                await loadPlanData();
                displayShopsList();
                showMessage('shopsManagementStatus', 'success', '✅ تم تحديث القائمة بنجاح');
            } catch (error) {
                showMessage('shopsManagementStatus', 'error', '❌ فشل تحديث البيانات: ' + error.message);
            }
        }
        
        // Open add shop modal
        function openAddShopModal() {
            document.getElementById('shopModalTitle').innerHTML = '➕ إضافة محل جديد';
            document.getElementById('shopModalId').value = '';
            document.getElementById('shopModalName').value = '';
            document.getElementById('shopModalArea').value = '';
            
            // Populate areas dropdown
            const select = document.getElementById('shopModalArea');
            select.innerHTML = '<option value="">اختر المنطقة...</option>';
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
            
            document.getElementById('shopModal').style.display = 'block';
        }
        
        // Open edit shop modal
        function openEditShopModal(shopId) {
            const shop = planData.shops.find(s => s.id === shopId);
            if (!shop) return;
            
            document.getElementById('shopModalTitle').innerHTML = '✏️ تعديل محل';
            document.getElementById('shopModalId').value = shop.id;
            document.getElementById('shopModalName').value = shop.name;
            
            // Populate areas dropdown
            const select = document.getElementById('shopModalArea');
            select.innerHTML = '<option value="">اختر المنطقة...</option>';
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
            select.value = shop.areaId;
            
            document.getElementById('shopModal').style.display = 'block';
        }
        
        // Close shop modal
        function closeShopModal() {
            document.getElementById('shopModal').style.display = 'none';
        }
        
        // Save shop (add or edit)
        async function saveShop() {
            const shopId = document.getElementById('shopModalId').value;
            const shopName = document.getElementById('shopModalName').value.trim();
            const areaId = document.getElementById('shopModalArea').value;
            
            if (!shopName) {
                showMessage('shopModalStatus', 'error', '❌ يرجى إدخال اسم المحل');
                return;
            }
            
            if (!areaId) {
                showMessage('shopModalStatus', 'error', '❌ يرجى اختيار المنطقة');
                return;
            }
            
            showMessage('shopModalStatus', 'info', '⏳ جاري الحفظ...');
            
            try {
                if (shopId) {
                    // Edit existing shop
                    const shopIndex = planData.shops.findIndex(s => s.id === shopId);
                    if (shopIndex !== -1) {
                        planData.shops[shopIndex].name = shopName;
                        planData.shops[shopIndex].areaId = areaId;
                    }
                } else {
                    // Add new shop
                    const newShop = {
                        id: 'shop_' + Date.now(),
                        name: shopName,
                        areaId: areaId
                    };
                    planData.shops.push(newShop);
                }
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('shopModalStatus', 'success', '✅ تم الحفظ بنجاح');
                setTimeout(() => {
                    closeShopModal();
                    displayShopsList();
                    populateAreas(); // Refresh main form areas
                }, 1000);
                
            } catch (error) {
                showMessage('shopModalStatus', 'error', '❌ فشل الحفظ: ' + error.message);
            }
        }
        
        // Delete shop
        async function deleteShop(shopId) {
            const shop = planData.shops.find(s => s.id === shopId);
            if (!shop) return;
            
            if (!confirm(`هل أنت متأكد من حذف المحل "${shop.name}"؟`)) {
                return;
            }
            
            showMessage('shopsManagementStatus', 'info', '⏳ جاري الحذف...');
            
            try {
                // Remove shop from array
                planData.shops = planData.shops.filter(s => s.id !== shopId);
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('shopsManagementStatus', 'success', '✅ تم حذف المحل بنجاح');
                displayShopsList();
                populateAreas(); // Refresh main form areas
                
            } catch (error) {
                showMessage('shopsManagementStatus', 'error', '❌ فشل الحذف: ' + error.message);
            }
        }
        
        // Copy shop ID
        function copyShopId(shopId) {
            navigator.clipboard.writeText(shopId).then(() => {
                showMessage('shopsManagementStatus', 'success', '✅ تم نسخ المعرف');
            });
        }
        
        // Export shops data
        function exportShopsData() {
            if (!planData || !planData.shops) return;
            
            const dataStr = JSON.stringify(planData.shops, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'shops-export-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
            
            showMessage('shopsManagementStatus', 'success', '✅ تم تصدير البيانات');
        }
        
        // ============================================
        // AREAS MANAGEMENT FUNCTIONS
        // ============================================
        
        // Load areas management tab
        function loadAreasManagement() {
            displayAreasList();
        }
        
        // Display areas list
        function displayAreasList() {
            const tbody = document.getElementById('areasManagementBody');
            const searchTerm = document.getElementById('searchArea').value.toLowerCase();
            
            if (!planData || !planData.areas) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">لا توجد بيانات</td></tr>';
                return;
            }
            
            let filteredAreas = planData.areas.filter(area => {
                return area.name.toLowerCase().includes(searchTerm);
            });
            
            // Update statistics
            const totalShops = planData.shops ? planData.shops.length : 0;
            document.getElementById('totalAreasManagement').textContent = planData.areas.length;
            document.getElementById('filteredAreasCount').textContent = filteredAreas.length;
            document.getElementById('totalShopsInAreas').textContent = totalShops;
            
            if (filteredAreas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">لا توجد مناطق مطابقة</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            filteredAreas.forEach(area => {
                const shopsCount = planData.shops.filter(s => s.areaId === area.id).length;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${area.name}</td>
                    <td style="font-family: monospace; font-size: 0.85em;">${area.id}</td>
                    <td>${shopsCount} محل</td>
                    <td>
                        <span class="action-icon edit-icon" onclick="openEditAreaModal('${area.id}')" title="تعديل">✏️</span>
                        <span class="action-icon delete-icon" onclick="deleteArea('${area.id}')" title="حذف">🗑️</span>
                        <span class="action-icon copy-icon" onclick="copyAreaId('${area.id}')" title="نسخ المعرف">📋</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Filter areas list
        function filterAreasList() {
            displayAreasList();
        }
        
        // Refresh areas list
        async function refreshAreasList() {
            showMessage('areasManagementStatus', 'info', '⏳ جاري تحديث البيانات...');
            try {
                await loadPlanData();
                displayAreasList();
                showMessage('areasManagementStatus', 'success', '✅ تم تحديث القائمة بنجاح');
            } catch (error) {
                showMessage('areasManagementStatus', 'error', '❌ فشل تحديث البيانات: ' + error.message);
            }
        }
        
        // Sort areas by name
        function sortAreasByName() {
            if (!planData || !planData.areas) return;
            
            planData.areas.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            displayAreasList();
            showMessage('areasManagementStatus', 'success', '✅ تم ترتيب المناطق أبجدياً');
        }
        
        // Open add area modal
        function openAddAreaModal() {
            document.getElementById('areaModalTitle').innerHTML = '➕ إضافة منطقة جديدة';
            document.getElementById('areaModalId').value = '';
            document.getElementById('areaModalName').value = '';
            document.getElementById('areaModal').style.display = 'block';
        }
        
        // Open edit area modal
        function openEditAreaModal(areaId) {
            const area = planData.areas.find(a => a.id === areaId);
            if (!area) return;
            
            document.getElementById('areaModalTitle').innerHTML = '✏️ تعديل منطقة';
            document.getElementById('areaModalId').value = area.id;
            document.getElementById('areaModalName').value = area.name;
            document.getElementById('areaModal').style.display = 'block';
        }
        
        // Close area modal
        function closeAreaModal() {
            document.getElementById('areaModal').style.display = 'none';
        }
        
        // Save area (add or edit)
        async function saveArea() {
            const areaId = document.getElementById('areaModalId').value;
            const areaName = document.getElementById('areaModalName').value.trim();
            
            if (!areaName) {
                showMessage('areaModalStatus', 'error', '❌ يرجى إدخال اسم المنطقة');
                return;
            }
            
            showMessage('areaModalStatus', 'info', '⏳ جاري الحفظ...');
            
            try {
                if (areaId) {
                    // Edit existing area
                    const areaIndex = planData.areas.findIndex(a => a.id === areaId);
                    if (areaIndex !== -1) {
                        planData.areas[areaIndex].name = areaName;
                    }
                } else {
                    // Add new area
                    const newArea = {
                        id: 'area_' + Date.now(),
                        name: areaName
                    };
                    planData.areas.push(newArea);
                }
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('areaModalStatus', 'success', '✅ تم الحفظ بنجاح');
                setTimeout(() => {
                    closeAreaModal();
                    displayAreasList();
                    populateAreas(); // Refresh main form areas
                    populateShopAreaFilter(); // Refresh shops filter
                }, 1000);
                
            } catch (error) {
                showMessage('areaModalStatus', 'error', '❌ فشل الحفظ: ' + error.message);
            }
        }
        
        // Delete area
        async function deleteArea(areaId) {
            const area = planData.areas.find(a => a.id === areaId);
            if (!area) return;
            
            // Check if area has shops
            const shopsInArea = planData.shops.filter(s => s.areaId === areaId).length;
            if (shopsInArea > 0) {
                if (!confirm(`المنطقة "${area.name}" تحتوي على ${shopsInArea} محل. هل أنت متأكد من الحذف؟\nسيتم نقل المحلات إلى "غير محدد".`)) {
                    return;
                }
            } else {
                if (!confirm(`هل أنت متأكد من حذف المنطقة "${area.name}"؟`)) {
                    return;
                }
            }
            
            showMessage('areasManagementStatus', 'info', '⏳ جاري الحذف...');
            
            try {
                // Remove area from array
                planData.areas = planData.areas.filter(a => a.id !== areaId);
                
                // Update shops that belong to this area (set to null or empty)
                planData.shops.forEach(shop => {
                    if (shop.areaId === areaId) {
                        shop.areaId = '';
                    }
                });
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                showMessage('areasManagementStatus', 'success', '✅ تم حذف المنطقة بنجاح');
                displayAreasList();
                populateAreas(); // Refresh main form areas
                
            } catch (error) {
                showMessage('areasManagementStatus', 'error', '❌ فشل الحذف: ' + error.message);
            }
        }
        
        // Copy area ID
        function copyAreaId(areaId) {
            navigator.clipboard.writeText(areaId).then(() => {
                showMessage('areasManagementStatus', 'success', '✅ تم نسخ المعرف');
            });
        }
        
        // ============================================
        // MAINTENANCE CONTROL FUNCTIONS
        // ============================================
        
        let maintenanceConfigData = null;
        let maintenanceStatusData = null;
        
        // Load maintenance configuration
        async function loadMaintenanceConfig() {
            try {
                // Load maintenance-config.json
                const configRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-config.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (configRes.ok) {
                    const configFile = await configRes.json();
                    maintenanceConfigData = JSON.parse(decodeURIComponent(escape(atob(configFile.content))));
                }
                
                // Load maintenance-status.json
                const statusRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (statusRes.ok) {
                    const statusFile = await statusRes.json();
                    maintenanceStatusData = JSON.parse(decodeURIComponent(escape(atob(statusFile.content))));
                }
                
                // Update UI with loaded data
                updateMaintenanceUI();
                
            } catch (error) {
                console.error('Error loading maintenance config:', error);
            }
        }
        
        // Update maintenance UI with current values
        function updateMaintenanceUI() {
            if (!maintenanceConfigData || !maintenanceStatusData) return;
            
            // Update maintenance status
            const isEnabled = maintenanceStatusData.enabled === true;
            document.getElementById('maintenanceStatusLabel').textContent = isEnabled ? '🟢 مفعلة' : '🔴 متوقفة';
            document.getElementById('maintenanceStatusLabel').style.color = isEnabled ? '#38ef7d' : '#ff6b6b';
            
            // Update buttons
            if (isEnabled) {
                document.getElementById('enableMaintenanceBtn').style.opacity = '0.5';
                document.getElementById('disableMaintenanceBtn').style.opacity = '1';
            } else {
                document.getElementById('enableMaintenanceBtn').style.opacity = '1';
                document.getElementById('disableMaintenanceBtn').style.opacity = '0.5';
            }
            
            // Update music status
            const musicEnabled = maintenanceConfigData.musicEnabled === true;
            document.getElementById('musicStatusLabel').textContent = musicEnabled ? '🔊 مفعلة' : '🔇 متوقفة';
            document.getElementById('musicStatusLabel').style.color = musicEnabled ? '#38ef7d' : '#ff6b6b';
            
            // Update buttons
            if (musicEnabled) {
                document.getElementById('enableMusicBtn').style.opacity = '0.5';
                document.getElementById('disableMusicBtn').style.opacity = '1';
            } else {
                document.getElementById('enableMusicBtn').style.opacity = '1';
                document.getElementById('disableMusicBtn').style.opacity = '0.5';
            }
            
            // Update volume slider
            const volume = Math.round((maintenanceConfigData.musicVolume || 0.1) * 100);
            document.getElementById('volumeSlider').value = volume;
            document.getElementById('volumeDisplay').textContent = `🔊 ${volume}%`;
            
            // Update music duration
            const duration = maintenanceConfigData.musicDuration || 600000;
            let durationText = '';
            if (duration === -1) {
                durationText = '♾️ مستمر (غير محدود)';
            } else {
                const minutes = Math.floor(duration / 60000);
                if (minutes === 1) {
                    durationText = '⏱️ دقيقة واحدة';
                } else {
                    durationText = `⏱️ ${minutes} دقيقة`;
                }
            }
            document.getElementById('musicDurationLabel').textContent = durationText;
            
            // Update last update info
            const lastUpdate = maintenanceConfigData.lastUpdated || 'غير محدد';
            const updatedBy = maintenanceConfigData.updatedBy || 'غير محدد';
            document.getElementById('lastUpdateLabel').textContent = new Date(lastUpdate).toLocaleString('ar-EG');
            document.getElementById('updatedByLabel').textContent = updatedBy;
        }
        
        // Toggle maintenance message on/off
        async function toggleMaintenanceMessage(enable) {
            if (!githubToken) {
                showMessage('maintenanceToggleStatus', 'error', '❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            // Disable buttons and show immediate feedback
            const enableBtn = document.getElementById('enableMaintenanceBtn');
            const disableBtn = document.getElementById('disableMaintenanceBtn');
            
            if (enableBtn) enableBtn.disabled = true;
            if (disableBtn) disableBtn.disabled = true;
            
            showMessage('maintenanceToggleStatus', 'info', '⏳ جاري التحديث...');
            
            try {
                // Update maintenance-status.json
                maintenanceStatusData.enabled = enable;
                maintenanceStatusData.disabledAt = new Date().toISOString();
                maintenanceStatusData.disabledBy = 'المطور - Smart Planner';
                
                await saveMaintenanceStatus(`${enable ? 'تفعيل' : 'إيقاف'} رسالة التحديث من Smart Planner`);
                
                // Re-enable buttons
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('maintenanceToggleStatus', 'success', 
                    `✅ تم ${enable ? 'تفعيل' : 'إيقاف'} رسالة التحديث بنجاح! التغييرات انعكست فوراً في GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                // Re-enable buttons on error
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('maintenanceToggleStatus', 'error', '❌ فشل التحديث: ' + error.message);
            }
        }
        
        // Toggle music on/off
        async function toggleMusic(enable) {
            if (!githubToken) {
                showMessage('musicControlStatus', 'error', '❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            // Disable buttons and show immediate feedback
            const enableBtn = document.getElementById('enableMusicBtn');
            const disableBtn = document.getElementById('disableMusicBtn');
            
            if (enableBtn) enableBtn.disabled = true;
            if (disableBtn) disableBtn.disabled = true;
            
            showMessage('musicControlStatus', 'info', '⏳ جاري التحديث...');
            
            try {
                // Update maintenance-config.json
                maintenanceConfigData.musicEnabled = enable;
                maintenanceConfigData.lastUpdated = new Date().toISOString();
                maintenanceConfigData.updatedBy = 'المطور - Smart Planner';
                
                await saveMaintenanceConfig(`${enable ? 'تفعيل' : 'إيقاف'} الموسيقى من Smart Planner`);
                
                // Re-enable buttons
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('musicControlStatus', 'success', 
                    `✅ تم ${enable ? 'تفعيل' : 'إيقاف'} الموسيقى بنجاح! التغييرات انعكست فوراً في GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                // Re-enable buttons on error
                if (enableBtn) enableBtn.disabled = false;
                if (disableBtn) disableBtn.disabled = false;
                
                showMessage('musicControlStatus', 'error', '❌ فشل التحديث: ' + error.message);
            }
        }
        
        // Update volume display
        function updateVolumeDisplay(value) {
            document.getElementById('volumeDisplay').textContent = `🔊 ${value}%`;
        }
        
        // Save volume change
        async function saveVolumeChange(value) {
            if (!githubToken) {
                showMessage('musicControlStatus', 'error', '❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            showMessage('musicControlStatus', 'info', '⏳ جاري حفظ مستوى الصوت...');
            
            try {
                // Update maintenance-config.json
                maintenanceConfigData.musicVolume = parseInt(value) / 100;
                maintenanceConfigData.lastUpdated = new Date().toISOString();
                maintenanceConfigData.updatedBy = 'المطور - Smart Planner';
                
                await saveMaintenanceConfig(`تحديث مستوى الصوت إلى ${value}% من Smart Planner`);
                
                showMessage('musicControlStatus', 'success', 
                    `✅ تم تحديث مستوى الصوت إلى ${value}% بنجاح! التغييرات انعكست فوراً في GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                showMessage('musicControlStatus', 'error', '❌ فشل التحديث: ' + error.message);
            }
        }
        
        // Set volume preset
        function setVolumePreset(value) {
            document.getElementById('volumeSlider').value = value;
            updateVolumeDisplay(value);
            saveVolumeChange(value);
        }
        
        // Set music duration
        async function setMusicDuration(seconds) {
            if (!githubToken) {
                showMessage('musicControlStatus', 'error', '❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            showMessage('musicControlStatus', 'info', '⏳ جاري تحديث مدة الموسيقى...');
            
            try {
                // Update maintenance-config.json
                const duration = seconds === -1 ? -1 : seconds * 1000;
                maintenanceConfigData.musicDuration = duration;
                maintenanceConfigData.lastUpdated = new Date().toISOString();
                maintenanceConfigData.updatedBy = 'المطور - Smart Planner';
                
                let durationLabel = '';
                if (seconds === -1) {
                    durationLabel = 'غير محدود';
                    maintenanceConfigData.musicDurationLabel = 'مستمر (غير محدود)';
                } else {
                    const minutes = Math.floor(seconds / 60);
                    durationLabel = minutes === 1 ? 'دقيقة واحدة' : `${minutes} دقيقة`;
                    maintenanceConfigData.musicDurationLabel = durationLabel;
                }
                
                await saveMaintenanceConfig(`تحديث مدة الموسيقى إلى ${durationLabel} من Smart Planner`);
                
                showMessage('musicControlStatus', 'success', 
                    `✅ تم تحديث مدة الموسيقى إلى ${durationLabel} بنجاح! التغييرات انعكست فوراً في GitHub`);
                
                // Update UI
                updateMaintenanceUI();
                
                // Force cache clear
                setTimeout(() => forceCacheClear(), 1000);
                
            } catch (error) {
                showMessage('musicControlStatus', 'error', '❌ فشل التحديث: ' + error.message);
            }
        }
        
        // Save maintenance config to GitHub
        async function saveMaintenanceConfig(commitMessage) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-config.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('فشل الحصول على ملف maintenance-config.json');
            }
            
            const file = await getRes.json();
            const sha = file.sha;
            
            // Prepare content
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(maintenanceConfigData, null, 2))));
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-config.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateRes.ok) {
                throw new Error('فشل تحديث ملف maintenance-config.json');
            }
        }
        
        // Save maintenance status to GitHub
        async function saveMaintenanceStatus(commitMessage) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('فشل الحصول على ملف maintenance-status.json');
            }
            
            const file = await getRes.json();
            const sha = file.sha;
            
            // Prepare content
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(maintenanceStatusData, null, 2))));
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateRes.ok) {
                throw new Error('فشل تحديث ملف maintenance-status.json');
            }
        }
        
        // Force cache clear - AGGRESSIVE IMPLEMENTATION for all browsers
        async function forceCacheClear() {
            // Disable button and show immediate feedback
            const btn = document.getElementById('clearCacheBtn');
            const icon = document.getElementById('clearCacheIcon');
            const text = document.getElementById('clearCacheText');
            
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            }
            if (icon) icon.textContent = '⏳';
            if (text) text.textContent = 'جاري المسح الفوري...';
            
            showMessage('cacheControlStatus', 'info', '⏳ جاري مسح الكاش والذاكرة بشكل فوري وقوي...');
            
            try {
                let clearedItems = [];
                
                // 1. Clear local storage (preserve devToken)
                const keysToKeep = ['devToken'];
                const allKeys = Object.keys(localStorage);
                let localStorageCount = 0;
                allKeys.forEach(key => {
                    if (!keysToKeep.includes(key)) {
                        localStorage.removeItem(key);
                        localStorageCount++;
                    }
                });
                clearedItems.push(`💾 LocalStorage: تم مسح ${localStorageCount} عنصر`);
                
                // 2. Clear session storage
                const sessionStorageCount = sessionStorage.length;
                sessionStorage.clear();
                clearedItems.push(`📦 SessionStorage: تم مسح ${sessionStorageCount} عنصر`);
                
                // 3. Unregister all service workers
                let swCount = 0;
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        swCount++;
                        console.log('✅ Service Worker unregistered:', registration);
                    }
                }
                clearedItems.push(`🔄 Service Workers: تم إلغاء تسجيل ${swCount} خدمة`);
                
                // 4. Clear all caches
                let cacheCount = 0;
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        cacheCount++;
                        console.log('✅ Cache deleted:', cacheName);
                    }
                }
                clearedItems.push(`🗑️ Caches: تم مسح ${cacheCount} كاش`);
                
                // 5. Clear cookies (if possible)
                try {
                    document.cookie.split(";").forEach(function(c) { 
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                    });
                    clearedItems.push(`🍪 Cookies: تم المسح`);
                } catch (e) {
                    console.warn('Could not clear cookies:', e);
                }
                
                // 6. Clear IndexedDB (if exists)
                if ('indexedDB' in window) {
                    try {
                        const databases = await indexedDB.databases();
                        for (const db of databases) {
                            indexedDB.deleteDatabase(db.name);
                        }
                        clearedItems.push(`📊 IndexedDB: تم المسح`);
                    } catch (e) {
                        console.warn('Could not clear IndexedDB:', e);
                    }
                }
                
                // Re-enable button with success state
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                if (icon) icon.textContent = '✅';
                if (text) text.textContent = 'تم المسح بنجاح!';
                
                // Show success message
                showMessage('cacheControlStatus', 'success', 
                    '✅ تم مسح جميع الكاش والذاكرة بنجاح!\n\n' +
                    clearedItems.join('\n') + '\n\n' +
                    '✨ التحديثات ستنعكس فوراً في جميع المتصفحات (Safari, Chrome, Firefox)\n' +
                    '🔄 سيتم إعادة تحميل الصفحة بشكل قوي خلال 3 ثوانٍ...');
                
                // Reset button text after a moment
                setTimeout(() => {
                    if (icon) icon.textContent = '🚀';
                    if (text) text.textContent = 'مسح قوي وفوري للكاش (Safari + Chrome + Firefox)';
                }, 2000);
                
                // 7. Force hard reload after 3 seconds
                setTimeout(() => {
                    console.log('🔄 Performing hard reload...');
                    // Try multiple reload methods for maximum compatibility
                    if (window.location.reload) {
                        // Hard reload with cache bypass
                        window.location.reload(true);
                    }
                    // Fallback: Force reload by changing URL
                    setTimeout(() => {
                        window.location.href = window.location.href.split('?')[0] + '?t=' + new Date().getTime();
                    }, 500);
                }, 3000);
                
            } catch (error) {
                // Re-enable button on error
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                if (icon) icon.textContent = '❌';
                if (text) text.textContent = 'فشل المسح - حاول مرة أخرى';
                
                showMessage('cacheControlStatus', 'error', '❌ فشل مسح الكاش: ' + error.message);
                console.error('Cache clear error:', error);
                
                // Reset button text after a moment
                setTimeout(() => {
                    if (icon) icon.textContent = '🚀';
                    if (text) text.textContent = 'مسح قوي وفوري للكاش (Safari + Chrome + Firefox)';
                }, 3000);
            }
        }
        
        // Update service worker
        async function updateServiceWorker() {
            // Disable button and show immediate feedback
            const btn = document.getElementById('updateSWBtn');
            const icon = document.getElementById('updateSWIcon');
            const text = document.getElementById('updateSWText');
            
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            }
            if (icon) icon.textContent = '⏳';
            if (text) text.textContent = 'جاري التحديث...';
            
            showMessage('cacheControlStatus', 'info', '⏳ جاري تحديث Service Worker...');
            
            try {
                if ('serviceWorker' in navigator) {
                    // Get all registrations
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    
                    if (registrations.length === 0) {
                        // Re-enable button
                        if (btn) {
                            btn.disabled = false;
                            btn.style.opacity = '1';
                        }
                        if (icon) icon.textContent = '⚠️';
                        if (text) text.textContent = 'لا توجد Service Workers';
                        
                        showMessage('cacheControlStatus', 'warning', '⚠️ لا توجد Service Workers مسجلة');
                        
                        // Reset button text
                        setTimeout(() => {
                            if (icon) icon.textContent = '🔄';
                            if (text) text.textContent = 'تحديث Service Worker فوراً';
                        }, 2000);
                        return;
                    }
                    
                    // Update all service workers
                    for (let registration of registrations) {
                        await registration.update();
                        console.log('✅ Service Worker updated:', registration);
                    }
                    
                    // Re-enable button with success state
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    }
                    if (icon) icon.textContent = '✅';
                    if (text) text.textContent = 'تم التحديث بنجاح!';
                    
                    showMessage('cacheControlStatus', 'success', 
                        `✅ تم تحديث ${registrations.length} Service Worker بنجاح!\n` +
                        '🔄 التحديثات ستنعكس فوراً في جميع علامات التبويب');
                    
                    // Reset button text after a moment
                    setTimeout(() => {
                        if (icon) icon.textContent = '🔄';
                        if (text) text.textContent = 'تحديث Service Worker فوراً';
                    }, 2000);
                    
                } else {
                    // Re-enable button
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    }
                    if (icon) icon.textContent = '❌';
                    if (text) text.textContent = 'المتصفح لا يدعم SW';
                    
                    showMessage('cacheControlStatus', 'error', '❌ المتصفح لا يدعم Service Workers');
                    
                    // Reset button text
                    setTimeout(() => {
                        if (icon) icon.textContent = '🔄';
                        if (text) text.textContent = 'تحديث Service Worker فوراً';
                    }, 2000);
                }
                
            } catch (error) {
                // Re-enable button on error
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                if (icon) icon.textContent = '❌';
                if (text) text.textContent = 'فشل التحديث';
                
                showMessage('cacheControlStatus', 'error', '❌ فشل تحديث Service Worker: ' + error.message);
                
                // Reset button text after a moment
                setTimeout(() => {
                    if (icon) icon.textContent = '🔄';
                    if (text) text.textContent = 'تحديث Service Worker فوراً';
                }, 3000);
            }
        }
        
        // Update switchTab function to load maintenance config when switching to maintenance tab
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab.call(this, tabName);
            
            if (tabName === 'maintenance') {
                loadMaintenanceConfig();
            }
        };
        
        // ============================================
        // NEW SMART PLANNER ENHANCED FUNCTIONS
        // ============================================
        
        // Quick Add Inspection
        function openQuickAddInspection() {
            // Switch to add tab and focus on first field
            document.querySelectorAll('.tab-button')[0].click();
            setTimeout(() => {
                document.getElementById('inspectorSelect').focus();
            }, 300);
            alert('✨ اختصار: اختر المفتش والتاريخ والمنطقة بسرعة لإضافة تفتيش جديد');
        }
        
        // Import from Excel
        function importFromExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                alert('📥 جاري استيراد البيانات من Excel...\n\nملاحظة: هذه الميزة تتطلب مكتبة معالجة Excel. سيتم إضافتها قريباً.');
                // TODO: Implement Excel import functionality
            };
            input.click();
        }
        
        // Export All Data
        function exportAllData() {
            if (!planData) {
                alert('⚠️ لا توجد بيانات للتصدير');
                return;
            }
            
            const exportData = {
                inspections: planData.inspectionData,
                inspectors: planData.inspectors,
                areas: planData.areas,
                shops: planData.shops,
                exportDate: new Date().toISOString(),
                exportedBy: 'Smart Planner'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `smart-planner-full-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('✅ تم تصدير جميع البيانات بنجاح!\n\n' +
                  `📊 التفتيشات: ${planData.inspectionData.length}\n` +
                  `👥 المفتشون: ${planData.inspectors.length}\n` +
                  `🗺️ المناطق: ${planData.areas.length}\n` +
                  `🏪 المحلات: ${planData.shops.length}`);
        }
        
        // Sync with GitHub
        async function syncWithGitHub() {
            if (!githubToken) {
                alert('❌ يرجى تسجيل الدخول أولاً للمزامنة مع GitHub');
                return;
            }
            
            if (confirm('🔄 هل تريد مزامنة البيانات مع GitHub؟\n\nسيتم تحميل أحدث البيانات من المستودع.')) {
                try {
                    await loadPlanData();
                    alert('✅ تمت المزامنة بنجاح! تم تحميل أحدث البيانات.');
                    
                    // Refresh current tab
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab && activeTab.id === 'shopsTab') {
                        displayShopsList();
                    } else if (activeTab && activeTab.id === 'areasTab') {
                        displayAreasList();
                    }
                } catch (error) {
                    alert('❌ فشلت المزامنة: ' + error.message);
                }
            }
        }
        
        // Create Backup
        function createBackup() {
            if (!planData) {
                alert('⚠️ لا توجد بيانات للنسخ الاحتياطي');
                return;
            }
            
            const backupData = {
                ...planData,
                backupDate: new Date().toISOString(),
                backupVersion: '1.0'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup-plan-data-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('✅ تم إنشاء النسخة الاحتياطية بنجاح!\n\n💾 احتفظ بهذا الملف في مكان آمن.');
        }
        
        // Generate Full Report
        function generateFullReport() {
            if (!planData || !planData.inspectionData) {
                alert('⚠️ لا توجد بيانات لإنشاء التقرير');
                return;
            }
            
            const totalInspections = planData.inspectionData.length;
            const totalShops = planData.inspectionData.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0);
            const inspectorCounts = {};
            const areaCounts = {};
            
            planData.inspectionData.forEach(insp => {
                inspectorCounts[insp.inspector] = (inspectorCounts[insp.inspector] || 0) + 1;
                areaCounts[insp.area] = (areaCounts[insp.area] || 0) + 1;
            });
            
            let report = '📊 التقرير الشامل لنظام التفتيش\n';
            report += '=' .repeat(50) + '\n\n';
            report += `📅 تاريخ التقرير: ${new Date().toLocaleString('ar-EG')}\n\n`;
            report += `📈 الإحصائيات العامة:\n`;
            report += `   • إجمالي التفتيشات: ${totalInspections}\n`;
            report += `   • إجمالي المحلات المفتشة: ${totalShops}\n`;
            report += `   • عدد المفتشين: ${Object.keys(inspectorCounts).length}\n`;
            report += `   • عدد المناطق: ${Object.keys(areaCounts).length}\n\n`;
            
            report += `👥 تفتيشات المفتشين:\n`;
            Object.entries(inspectorCounts).sort((a, b) => b[1] - a[1]).forEach(([inspector, count]) => {
                report += `   • ${inspector}: ${count} تفتيش\n`;
            });
            
            report += `\n🗺️ تفتيشات المناطق:\n`;
            Object.entries(areaCounts).sort((a, b) => b[1] - a[1]).forEach(([area, count]) => {
                report += `   • ${area}: ${count} تفتيش\n`;
            });
            
            // Create downloadable report
            const dataBlob = new Blob([report], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `report-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('✅ تم إنشاء التقرير الشامل!\n\n' + report);
        }
        
        // Check Data Quality
        function checkDataQuality() {
            if (!planData) {
                alert('⚠️ لا توجد بيانات للفحص');
                return;
            }
            
            const issues = [];
            
            // Check inspections
            if (planData.inspectionData) {
                planData.inspectionData.forEach((insp, idx) => {
                    if (!insp.inspector) issues.push(`تفتيش ${idx + 1}: مفتش غير محدد`);
                    if (!insp.day) issues.push(`تفتيش ${idx + 1}: تاريخ غير محدد`);
                    if (!insp.area) issues.push(`تفتيش ${idx + 1}: منطقة غير محددة`);
                    if (!insp.shops || insp.shops.length === 0) issues.push(`تفتيش ${idx + 1}: لا توجد محلات`);
                });
            }
            
            // Check duplicates
            const inspectionKeys = new Set();
            planData.inspectionData.forEach(insp => {
                const key = `${insp.inspector}-${insp.day}`;
                if (inspectionKeys.has(key)) {
                    issues.push(`تفتيش مكرر: ${insp.inspector} في ${insp.day}`);
                }
                inspectionKeys.add(key);
            });
            
            if (issues.length === 0) {
                alert('✅ جودة البيانات ممتازة!\n\nلا توجد مشاكل في البيانات.');
            } else {
                alert(`⚠️ تم العثور على ${issues.length} مشكلة:\n\n` + issues.slice(0, 10).join('\n') + 
                      (issues.length > 10 ? `\n\n... و ${issues.length - 10} مشكلة أخرى` : ''));
            }
        }
        
        // View System Logs
        function viewSystemLogs() {
            const logs = [
                `[${new Date().toLocaleString('ar-EG')}] النظام يعمل بشكل طبيعي`,
                `[${new Date().toLocaleString('ar-EG')}] آخر تحديث: ${planData?.lastUpdate || 'غير محدد'}`,
                `[${new Date().toLocaleString('ar-EG')}] إجمالي التفتيشات: ${planData?.inspectionData?.length || 0}`,
                `[${new Date().toLocaleString('ar-EG')}] إجمالي المحلات: ${planData?.shops?.length || 0}`,
            ];
            
            alert('📋 سجل النظام:\n\n' + logs.join('\n'));
        }
        
        // Bulk Operations
        function bulkOperations() {
            const operations = [
                '1. تعديل جماعي للتفتيشات',
                '2. حذف جماعي للتفتيشات',
                '3. نسخ جماعي للتفتيشات',
                '4. إعادة تعيين المفتشين',
                '5. إعادة تعيين المناطق',
                '6. دمج التفتيشات المكررة'
            ];
            
            alert('⚙️ العمليات الجماعية المتاحة:\n\n' + operations.join('\n') + 
                  '\n\nاختر العملية من القائمة أعلاه (قريباً)');
        }
        
        // Reload Shops from Excel - REAL IMPLEMENTATION
        async function reloadShopsFromExcel() {
            if (!githubToken) {
                alert('❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            // Create file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.multiple = false;
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    // Show merge options modal
                    showExcelImportModal(file);
                } catch (error) {
                    alert('❌ خطأ في قراءة الملف: ' + error.message);
                }
            };
            
            input.click();
        }
        
        // Show Excel Import Modal with merge options
        async function showExcelImportModal(file) {
            const modal = document.createElement('div');
            modal.id = 'excelImportModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 800px; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">📥 تحميل المحلات من Excel</h2>
                        <button onclick="document.getElementById('excelImportModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 10px 0;">📋 معلومات الملف</h3>
                        <p style="margin: 0;">📄 <strong>اسم الملف:</strong> ${file.name}</p>
                        <p style="margin: 5px 0 0 0;">📊 <strong>الحجم:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">⚙️ خيارات الدمج</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="add" checked style="width: 20px; height: 20px;">
                                <div>
                                    <strong>إضافة فقط</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">إضافة المحلات الجديدة فقط وتجاهل المكرر</p>
                                </div>
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="update" style="width: 20px; height: 20px;">
                                <div>
                                    <strong>تحديث الموجود</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">تحديث بيانات المحلات الموجودة بالبيانات الجديدة</p>
                                </div>
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="replace" style="width: 20px; height: 20px;">
                                <div>
                                    <strong>استبدال كامل</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">حذف جميع المحلات الحالية واستبدالها بالبيانات الجديدة</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ffc107;">
                        <h4 style="color: #856404; margin: 0 0 10px 0;">📌 متطلبات ملف Excel</h4>
                        <ul style="margin: 0; padding-right: 20px; color: #856404;">
                            <li>يجب أن يحتوي الملف على الأعمدة التالية: اسم المحل، المنطقة، رقم الترخيص</li>
                            <li>يمكن إضافة أعمدة اختيارية: رقم التعريف ADM، العنوان، جهة الاتصال، النشاط</li>
                            <li>يجب أن تكون البيانات في الصف الثاني وما بعده (الصف الأول للعناوين)</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="processExcelImport('${file.name}')" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ✅ بدء التحميل
                        </button>
                        <button onclick="document.getElementById('excelImportModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ❌ إلغاء
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store file data for processing
            window.excelImportFile = file;
        }
        
        // Process Excel Import
        async function processExcelImport(fileName) {
            const file = window.excelImportFile;
            if (!file) {
                alert('❌ خطأ: لم يتم العثور على الملف');
                return;
            }
            
            // Get merge mode
            const mergeMode = document.querySelector('input[name="mergeMode"]:checked').value;
            
            // Close modal
            document.getElementById('excelImportModal').remove();
            
            // Show loading message
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingExcelImport';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10001;
                text-align: center;
            `;
            loadingDiv.innerHTML = `
                <h3 style="color: #2d3561; margin-bottom: 15px;">⏳ جاري معالجة الملف...</h3>
                <p style="color: #666;">يرجى الانتظار</p>
            `;
            document.body.appendChild(loadingDiv);
            
            try {
                // Read file
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get first sheet
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                
                if (!jsonData || jsonData.length === 0) {
                    throw new Error('الملف فارغ أو لا يحتوي على بيانات صالحة');
                }
                
                // Process the data
                const result = await processShopsData(jsonData, mergeMode);
                
                // Remove loading
                document.getElementById('loadingExcelImport').remove();
                
                // Show result
                alert(`✅ تم معالجة الملف بنجاح!\n\n` +
                      `📊 المحلات المعالجة: ${result.processed}\n` +
                      `➕ المحلات المضافة: ${result.added}\n` +
                      `🔄 المحلات المحدثة: ${result.updated}\n` +
                      `⏭️  المحلات المتجاهلة: ${result.skipped}\n\n` +
                      `سيتم حفظ البيانات الآن...`);
                
                // Save to GitHub
                await savePlanData();
                
                // Refresh the list
                refreshShopsList();
                
            } catch (error) {
                document.getElementById('loadingExcelImport')?.remove();
                alert('❌ خطأ في معالجة الملف: ' + error.message);
                console.error('Excel import error:', error);
            }
        }
        
        // Process shops data from Excel
        async function processShopsData(jsonData, mergeMode) {
            let processed = 0;
            let added = 0;
            let updated = 0;
            let skipped = 0;
            
            // Ensure planData.shops exists
            if (!planData.shops) {
                planData.shops = [];
            }
            
            // If replace mode, clear existing shops
            if (mergeMode === 'replace') {
                planData.shops = [];
            }
            
            // Get existing shop names for duplicate checking
            const existingShops = new Set(planData.shops.map(shop => shop.name));
            
            // Process each row
            for (const row of jsonData) {
                processed++;
                
                // Extract shop data (try different possible column names)
                const shopName = row['اسم المحل'] || row['name'] || row['shopName'] || row['الاسم'];
                const area = row['المنطقة'] || row['area'] || row['المنطقة'];
                const licenseNo = row['رقم الترخيص'] || row['license'] || row['licenseNo'] || '';
                const admCode = row['رقم التعريف'] || row['admCode'] || row['ADM'] || '';
                const address = row['العنوان'] || row['address'] || '';
                const contact = row['جهة الاتصال'] || row['contact'] || '';
                const activity = row['النشاط'] || row['activity'] || '';
                
                if (!shopName) {
                    skipped++;
                    continue;
                }
                
                // Check if shop exists
                const existingIndex = planData.shops.findIndex(s => s.name === shopName);
                const exists = existingIndex !== -1;
                
                if (exists && mergeMode === 'add') {
                    // Skip existing shops in add mode
                    skipped++;
                    continue;
                }
                
                // Create shop object
                const shopData = {
                    name: shopName,
                    area: area || 'غير محدد',
                    id: admCode || licenseNo || `SHOP${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                };
                
                // Add optional fields if available
                if (licenseNo) shopData.licenseNo = licenseNo;
                if (address) shopData.address = address;
                if (contact) shopData.contact = contact;
                if (activity) shopData.activity = activity;
                
                if (exists && mergeMode === 'update') {
                    // Update existing shop
                    planData.shops[existingIndex] = { ...planData.shops[existingIndex], ...shopData };
                    updated++;
                } else {
                    // Add new shop
                    planData.shops.push(shopData);
                    added++;
                }
            }
            
            return { processed, added, updated, skipped };
        }
        
        // Export Shops to Excel - REAL IMPLEMENTATION
        function exportShopsToExcel() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('⚠️ لا توجد محلات للتصدير');
                return;
            }
            
            try {
                // Prepare data for export
                const exportData = planData.shops.map(shop => ({
                    'اسم المحل': shop.name,
                    'المنطقة': shop.area,
                    'رقم التعريف': shop.id || '',
                    'رقم الترخيص': shop.licenseNo || '',
                    'العنوان': shop.address || '',
                    'جهة الاتصال': shop.contact || '',
                    'النشاط': shop.activity || ''
                }));
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 30 }, // اسم المحل
                    { wch: 20 }, // المنطقة
                    { wch: 15 }, // رقم التعريف
                    { wch: 15 }, // رقم الترخيص
                    { wch: 25 }, // العنوان
                    { wch: 20 }, // جهة الاتصال
                    { wch: 25 }  // النشاط
                ];
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'المحلات');
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `محلات_${timestamp}.xlsx`;
                
                // Download file
                XLSX.writeFile(wb, filename);
                
                alert(`✅ تم تصدير ${exportData.length} محل إلى ملف Excel بنجاح!\n\n` +
                      `📄 اسم الملف: ${filename}`);
                
            } catch (error) {
                alert('❌ خطأ في تصدير البيانات: ' + error.message);
                console.error('Excel export error:', error);
            }
        }
        
        // Bulk Edit Shops - FULL IMPLEMENTATION
        async function bulkEditShops() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('⚠️ لا توجد محلات للتعديل');
                return;
            }
            
            // Create modal for bulk edit
            const modal = document.createElement('div');
            modal.id = 'bulkEditModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">✏️ التعديل الجماعي للمحلات</h2>
                        <button onclick="document.getElementById('bulkEditModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <!-- Selection Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 15px 0;">📋 تحديد المحلات للتعديل</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button onclick="selectAllShopsForEdit()" style="padding: 10px 20px; border: none; border-radius: 8px; background: white; color: #667eea; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                ☑️ تحديد الكل
                            </button>
                            <button onclick="deselectAllShopsForEdit()" style="padding: 10px 20px; border: none; border-radius: 8px; background: white; color: #667eea; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                ☐ إلغاء تحديد الكل
                            </button>
                            <select id="bulkEditAreaFilter" onchange="filterShopsForBulkEdit()" style="padding: 10px; border-radius: 8px; border: none; font-family: 'Cairo', sans-serif;">
                                <option value="">جميع المناطق</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Shops Selection List -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
                        <div id="bulkEditShopsList"></div>
                    </div>
                    
                    <!-- Edit Operations -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">⚙️ عمليات التعديل</h3>
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">نقل إلى منطقة:</label>
                                <select id="bulkEditNewArea" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                                    <option value="">-- اختر منطقة --</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">إضافة بادئة للأسماء:</label>
                                <input type="text" id="bulkEditPrefix" placeholder="مثال: محل -" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #2d3561; margin-bottom: 8px;">إضافة لاحقة للأسماء:</label>
                                <input type="text" id="bulkEditSuffix" placeholder="مثال: - الفرع الرئيسي" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="bulkEditSelectedCount">0</div>
                            <div style="font-size: 0.9em;">المحلات المحددة</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="applyBulkEdit()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ✅ تطبيق التعديلات
                        </button>
                        <button onclick="document.getElementById('bulkEditModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ❌ إلغاء
                        </button>
                    </div>
                    
                    <div id="bulkEditStatus" style="margin-top: 20px;"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate area filters and dropdowns
            const areaFilter = document.getElementById('bulkEditAreaFilter');
            const newAreaSelect = document.getElementById('bulkEditNewArea');
            
            if (planData.areas) {
                planData.areas.forEach(area => {
                    const filterOption = document.createElement('option');
                    filterOption.value = area.id;
                    filterOption.textContent = area.name;
                    areaFilter.appendChild(filterOption);
                    
                    const editOption = document.createElement('option');
                    editOption.value = area.id;
                    editOption.textContent = area.name;
                    newAreaSelect.appendChild(editOption);
                });
            }
            
            // Initialize shops list
            filterShopsForBulkEdit();
        }
        
        // Filter shops for bulk edit
        window.filterShopsForBulkEdit = function() {
            const filterAreaId = document.getElementById('bulkEditAreaFilter').value;
            const shopsList = document.getElementById('bulkEditShopsList');
            
            let shopsToShow = planData.shops;
            if (filterAreaId) {
                shopsToShow = shopsToShow.filter(s => s.areaId === filterAreaId);
            }
            
            shopsList.innerHTML = shopsToShow.map((shop, index) => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #e0e0e0;">
                        <input type="checkbox" id="shop_${shop.id}" value="${shop.id}" onchange="updateBulkEditCount()" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="shop_${shop.id}" style="flex: 1; cursor: pointer;">
                            <strong>${shop.name}</strong>
                            <span style="color: #666; font-size: 0.9em;"> - ${area ? area.name : 'غير محدد'}</span>
                        </label>
                    </div>
                `;
            }).join('');
            
            updateBulkEditCount();
        };
        
        // Select all shops for edit
        window.selectAllShopsForEdit = function() {
            document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateBulkEditCount();
        };
        
        // Deselect all shops for edit
        window.deselectAllShopsForEdit = function() {
            document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateBulkEditCount();
        };
        
        // Update bulk edit count
        window.updateBulkEditCount = function() {
            const count = document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]:checked').length;
            document.getElementById('bulkEditSelectedCount').textContent = count;
        };
        
        // Apply bulk edit
        window.applyBulkEdit = async function() {
            const selectedShopIds = Array.from(document.querySelectorAll('#bulkEditShopsList input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedShopIds.length === 0) {
                alert('⚠️ يرجى تحديد محل واحد على الأقل');
                return;
            }
            
            const newAreaId = document.getElementById('bulkEditNewArea').value;
            const prefix = document.getElementById('bulkEditPrefix').value.trim();
            const suffix = document.getElementById('bulkEditSuffix').value.trim();
            
            if (!newAreaId && !prefix && !suffix) {
                alert('⚠️ يرجى تحديد عملية تعديل واحدة على الأقل');
                return;
            }
            
            if (!githubToken) {
                alert('❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            if (!confirm(`🔄 هل أنت متأكد من تعديل ${selectedShopIds.length} محل؟\n\nسيتم حفظ التغييرات مباشرة في GitHub.`)) {
                return;
            }
            
            const statusDiv = document.getElementById('bulkEditStatus');
            statusDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; border: 2px solid #bee5eb;">⏳ جاري التعديل...</div>';
            
            try {
                let editedCount = 0;
                
                planData.shops.forEach(shop => {
                    if (selectedShopIds.includes(shop.id)) {
                        if (newAreaId) {
                            shop.areaId = newAreaId;
                        }
                        if (prefix) {
                            shop.name = prefix + shop.name;
                        }
                        if (suffix) {
                            shop.name = shop.name + suffix;
                        }
                        editedCount++;
                    }
                });
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; border: 2px solid #c3e6cb;">
                        ✅ تم تعديل ${editedCount} محل بنجاح!
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('bulkEditModal').remove();
                    displayShopsList();
                    alert(`✅ تم تعديل ${editedCount} محل بنجاح!`);
                }, 2000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">❌ فشل التعديل: ${error.message}</div>`;
            }
        };
        
        // Bulk Delete Shops - FULL IMPLEMENTATION
        async function bulkDeleteShops() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('⚠️ لا توجد محلات للحذف');
                return;
            }
            
            // Create modal for bulk delete
            const modal = document.createElement('div');
            modal.id = 'bulkDeleteModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">🗑️ الحذف الجماعي للمحلات</h2>
                        <button onclick="document.getElementById('bulkDeleteModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <!-- Warning -->
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 10px 0;">⚠️ تحذير هام</h3>
                        <p style="margin: 0;">عملية الحذف نهائية ولا يمكن التراجع عنها. تأكد من اختيار المحلات الصحيحة قبل التأكيد.</p>
                    </div>
                    
                    <!-- Selection Section -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                            <button onclick="selectAllShopsForDelete()" style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                ☑️ تحديد الكل
                            </button>
                            <button onclick="deselectAllShopsForDelete()" style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                                ☐ إلغاء تحديد الكل
                            </button>
                            <select id="bulkDeleteAreaFilter" onchange="filterShopsForBulkDelete()" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                                <option value="">جميع المناطق</option>
                            </select>
                        </div>
                        <div id="bulkDeleteShopsList" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    
                    <!-- Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #dc3545 0%, #c0392b 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="bulkDeleteSelectedCount">0</div>
                            <div style="font-size: 0.9em;">المحلات المحددة للحذف</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="applyBulkDelete()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            🗑️ حذف نهائي
                        </button>
                        <button onclick="document.getElementById('bulkDeleteModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ❌ إلغاء
                        </button>
                    </div>
                    
                    <div id="bulkDeleteStatus" style="margin-top: 20px;"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate area filter
            const areaFilter = document.getElementById('bulkDeleteAreaFilter');
            if (planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    areaFilter.appendChild(option);
                });
            }
            
            // Initialize shops list
            filterShopsForBulkDelete();
        }
        
        // Filter shops for bulk delete
        window.filterShopsForBulkDelete = function() {
            const filterAreaId = document.getElementById('bulkDeleteAreaFilter').value;
            const shopsList = document.getElementById('bulkDeleteShopsList');
            
            let shopsToShow = planData.shops;
            if (filterAreaId) {
                shopsToShow = shopsToShow.filter(s => s.areaId === filterAreaId);
            }
            
            shopsList.innerHTML = shopsToShow.map(shop => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #e0e0e0;">
                        <input type="checkbox" id="delshop_${shop.id}" value="${shop.id}" onchange="updateBulkDeleteCount()" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="delshop_${shop.id}" style="flex: 1; cursor: pointer;">
                            <strong>${shop.name}</strong>
                            <span style="color: #666; font-size: 0.9em;"> - ${area ? area.name : 'غير محدد'}</span>
                        </label>
                    </div>
                `;
            }).join('');
            
            updateBulkDeleteCount();
        };
        
        // Select all shops for delete
        window.selectAllShopsForDelete = function() {
            document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateBulkDeleteCount();
        };
        
        // Deselect all shops for delete
        window.deselectAllShopsForDelete = function() {
            document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateBulkDeleteCount();
        };
        
        // Update bulk delete count
        window.updateBulkDeleteCount = function() {
            const count = document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]:checked').length;
            document.getElementById('bulkDeleteSelectedCount').textContent = count;
        };
        
        // Apply bulk delete
        window.applyBulkDelete = async function() {
            const selectedShopIds = Array.from(document.querySelectorAll('#bulkDeleteShopsList input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedShopIds.length === 0) {
                alert('⚠️ يرجى تحديد محل واحد على الأقل للحذف');
                return;
            }
            
            if (!githubToken) {
                alert('❌ يرجى تسجيل الدخول أولاً');
                return;
            }
            
            if (!confirm(`⚠️ هل أنت متأكد تماماً من حذف ${selectedShopIds.length} محل نهائياً؟\n\nهذه العملية لا يمكن التراجع عنها!\n\nسيتم حفظ التغييرات مباشرة في GitHub.`)) {
                return;
            }
            
            const statusDiv = document.getElementById('bulkDeleteStatus');
            statusDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; border: 2px solid #bee5eb;">⏳ جاري الحذف...</div>';
            
            try {
                const initialCount = planData.shops.length;
                planData.shops = planData.shops.filter(shop => !selectedShopIds.includes(shop.id));
                const deletedCount = initialCount - planData.shops.length;
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; border: 2px solid #c3e6cb;">
                        ✅ تم حذف ${deletedCount} محل بنجاح!
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('bulkDeleteModal').remove();
                    displayShopsList();
                    alert(`✅ تم حذف ${deletedCount} محل بنجاح!`);
                }, 2000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">❌ فشل الحذف: ${error.message}</div>`;
            }
        };
        
        
        // Merge Shops Data - FULL IMPLEMENTATION
        async function mergeShopsData() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('⚠️ لا توجد بيانات محلات للدمج');
                return;
            }
            
            // Create modal for merge operation
            const modal = document.createElement('div');
            modal.id = 'mergeModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">🔗 دمج بيانات المحلات</h2>
                        <button onclick="document.getElementById('mergeModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <!-- Merge Options -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0 0 15px 0;">⚙️ خيارات الدمج</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="duplicates" checked onchange="updateMergePreview()">
                                <span>دمج المحلات المكررة فقط</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="similar" onchange="updateMergePreview()">
                                <span>دمج المحلات المتشابهة</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="radio" name="mergeMode" value="fromFile" onchange="updateMergePreview()">
                                <span>دمج من ملف خارجي</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- File Upload for External Merge -->
                    <div id="fileUploadSection" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">📥 استيراد ملف للدمج</h3>
                        <input type="file" id="mergeFileInput" accept=".json" onchange="loadMergeFile(this)" style="padding: 10px; border: 2px solid #667eea; border-radius: 8px; width: 100%; font-family: 'Cairo', sans-serif;">
                        <p style="color: #666; margin-top: 10px; font-size: 0.9em;">قم برفع ملف JSON يحتوي على قائمة المحلات للدمج</p>
                    </div>
                    
                    <!-- Merge Preview -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">👁️ معاينة الدمج</h3>
                        <div id="mergePreviewContent">
                            <p style="text-align: center; color: #999;">جاري تحليل البيانات...</p>
                        </div>
                    </div>
                    
                    <!-- Merge Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mergeCurrentCount">0</div>
                            <div style="font-size: 0.9em;">المحلات الحالية</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mergeDuplicatesCount">0</div>
                            <div style="font-size: 0.9em;">المكررات المكتشفة</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mergeAfterCount">0</div>
                            <div style="font-size: 0.9em;">المحلات بعد الدمج</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="performMerge()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ✅ تنفيذ الدمج
                        </button>
                        <button onclick="document.getElementById('mergeModal').remove()" style="padding: 15px 30px; border: none; border-radius: 10px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 1.1em; cursor: pointer;">
                            ❌ إلغاء
                        </button>
                    </div>
                    
                    <div id="mergeStatus" style="margin-top: 20px;"></div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initial preview update
            setTimeout(() => updateMergePreview(), 100);
        }
        
        // Update merge preview based on selected mode
        window.updateMergePreview = function() {
            const mode = document.querySelector('input[name="mergeMode"]:checked').value;
            const fileUploadSection = document.getElementById('fileUploadSection');
            const previewContent = document.getElementById('mergePreviewContent');
            
            // Show/hide file upload section
            fileUploadSection.style.display = mode === 'fromFile' ? 'block' : 'none';
            
            // Update stats
            document.getElementById('mergeCurrentCount').textContent = planData.shops.length;
            
            if (mode === 'duplicates') {
                findDuplicates(previewContent);
            } else if (mode === 'similar') {
                findSimilar(previewContent);
            } else if (mode === 'fromFile') {
                previewContent.innerHTML = '<p style="text-align: center; color: #999;">قم برفع ملف JSON للمعاينة</p>';
                document.getElementById('mergeDuplicatesCount').textContent = '0';
                document.getElementById('mergeAfterCount').textContent = planData.shops.length;
            }
        };
        
        // Find duplicate shops
        function findDuplicates(container) {
            const duplicates = [];
            const nameMap = {};
            
            planData.shops.forEach((shop, index) => {
                const normalizedName = shop.name.trim().toLowerCase();
                if (nameMap[normalizedName]) {
                    duplicates.push({
                        original: nameMap[normalizedName],
                        duplicate: shop,
                        index: index
                    });
                } else {
                    nameMap[normalizedName] = shop;
                }
            });
            
            document.getElementById('mergeDuplicatesCount').textContent = duplicates.length;
            document.getElementById('mergeAfterCount').textContent = planData.shops.length - duplicates.length;
            
            if (duplicates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #11998e;">
                        <div style="font-size: 3em; margin-bottom: 10px;">✅</div>
                        <p style="font-size: 1.2em; font-weight: 600;">لا توجد محلات مكررة!</p>
                        <p style="color: #666;">جميع أسماء المحلات فريدة ومنظمة.</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea; color: white; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 10px; text-align: right;">المحل الأصلي</th>
                                    <th style="padding: 10px; text-align: right;">المحل المكرر</th>
                                    <th style="padding: 10px; text-align: right;">المنطقة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${duplicates.map(dup => {
                                    const origArea = planData.areas.find(a => a.id === dup.original.areaId);
                                    const dupArea = planData.areas.find(a => a.id === dup.duplicate.areaId);
                                    return `
                                        <tr style="border-bottom: 1px solid #e0e0e0;">
                                            <td style="padding: 10px;">${dup.original.name}</td>
                                            <td style="padding: 10px; color: #dc3545;">${dup.duplicate.name}</td>
                                            <td style="padding: 10px;">${origArea ? origArea.name : 'غير محدد'} / ${dupArea ? dupArea.name : 'غير محدد'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                        💡 سيتم الاحتفاظ بالمحل الأول وحذف النسخ المكررة
                    </p>
                `;
            }
            
            // Store duplicates for later use
            window.currentDuplicates = duplicates;
        }
        
        // Find similar shops (with fuzzy matching)
        function findSimilar(container) {
            const similar = [];
            const shops = planData.shops;
            
            for (let i = 0; i < shops.length; i++) {
                for (let j = i + 1; j < shops.length; j++) {
                    const similarity = calculateSimilarity(shops[i].name, shops[j].name);
                    if (similarity > 0.7) { // 70% similarity threshold
                        similar.push({
                            shop1: shops[i],
                            shop2: shops[j],
                            similarity: similarity
                        });
                    }
                }
            }
            
            document.getElementById('mergeDuplicatesCount').textContent = similar.length;
            document.getElementById('mergeAfterCount').textContent = planData.shops.length - similar.length;
            
            if (similar.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #11998e;">
                        <div style="font-size: 3em; margin-bottom: 10px;">✅</div>
                        <p style="font-size: 1.2em; font-weight: 600;">لا توجد محلات متشابهة!</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #667eea; color: white; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 10px; text-align: right;">المحل 1</th>
                                    <th style="padding: 10px; text-align: right;">المحل 2</th>
                                    <th style="padding: 10px; text-align: right;">نسبة التشابه</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${similar.map(sim => `
                                    <tr style="border-bottom: 1px solid #e0e0e0;">
                                        <td style="padding: 10px;">${sim.shop1.name}</td>
                                        <td style="padding: 10px;">${sim.shop2.name}</td>
                                        <td style="padding: 10px; color: #ffc107;">${Math.round(sim.similarity * 100)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            window.currentSimilar = similar;
        }
        
        // Calculate string similarity (Levenshtein distance)
        function calculateSimilarity(str1, str2) {
            const s1 = str1.toLowerCase().trim();
            const s2 = str2.toLowerCase().trim();
            
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }
        
        // Levenshtein distance algorithm
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        // Load merge file
        window.loadMergeFile = function(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileData = JSON.parse(e.target.result);
                    
                    // Validate file format
                    if (!Array.isArray(fileData) && !fileData.shops) {
                        throw new Error('صيغة الملف غير صحيحة');
                    }
                    
                    const externalShops = Array.isArray(fileData) ? fileData : fileData.shops;
                    window.externalShopsToMerge = externalShops;
                    
                    // Update preview
                    const previewContent = document.getElementById('mergePreviewContent');
                    previewContent.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #11998e;">
                            <div style="font-size: 3em; margin-bottom: 10px;">📥</div>
                            <p style="font-size: 1.2em; font-weight: 600;">تم تحميل ${externalShops.length} محل من الملف</p>
                            <p style="color: #666;">سيتم دمج هذه المحلات مع القائمة الحالية</p>
                        </div>
                    `;
                    
                    document.getElementById('mergeDuplicatesCount').textContent = externalShops.length;
                    document.getElementById('mergeAfterCount').textContent = planData.shops.length + externalShops.length;
                    
                } catch (error) {
                    alert('❌ خطأ في قراءة الملف: ' + error.message);
                }
            };
            reader.readAsText(file);
        };
        
        // Perform merge operation
        window.performMerge = async function() {
            const mode = document.querySelector('input[name="mergeMode"]:checked').value;
            const statusDiv = document.getElementById('mergeStatus');
            
            if (!githubToken) {
                statusDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">❌ يرجى تسجيل الدخول أولاً</div>';
                return;
            }
            
            if (!confirm('🔗 هل أنت متأكد من تنفيذ عملية الدمج؟\n\nسيتم حفظ التغييرات مباشرة في GitHub.')) {
                return;
            }
            
            statusDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; border: 2px solid #bee5eb;">⏳ جاري تنفيذ عملية الدمج...</div>';
            
            try {
                let mergedShops = [...planData.shops];
                let removedCount = 0;
                let addedCount = 0;
                
                if (mode === 'duplicates') {
                    // Remove duplicates
                    if (window.currentDuplicates && window.currentDuplicates.length > 0) {
                        const duplicateIndices = window.currentDuplicates.map(d => d.index);
                        mergedShops = planData.shops.filter((shop, index) => !duplicateIndices.includes(index));
                        removedCount = window.currentDuplicates.length;
                    }
                } else if (mode === 'similar') {
                    // Remove similar shops (keep first occurrence)
                    if (window.currentSimilar && window.currentSimilar.length > 0) {
                        const toRemove = new Set();
                        window.currentSimilar.forEach(sim => {
                            const idx2 = planData.shops.indexOf(sim.shop2);
                            toRemove.add(idx2);
                        });
                        mergedShops = planData.shops.filter((shop, index) => !toRemove.has(index));
                        removedCount = toRemove.size;
                    }
                } else if (mode === 'fromFile') {
                    // Merge external shops
                    if (window.externalShopsToMerge && window.externalShopsToMerge.length > 0) {
                        window.externalShopsToMerge.forEach(extShop => {
                            // Check if shop already exists
                            const exists = mergedShops.some(s => 
                                s.name.toLowerCase().trim() === extShop.name.toLowerCase().trim()
                            );
                            
                            if (!exists) {
                                mergedShops.push({
                                    id: extShop.id || 'shop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                    name: extShop.name,
                                    areaId: extShop.areaId || ''
                                });
                                addedCount++;
                            }
                        });
                    }
                }
                
                // Update plan data
                planData.shops = mergedShops;
                
                // Save to GitHub
                await savePlanDataToGitHub();
                
                statusDiv.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; border: 2px solid #c3e6cb;">
                        ✅ تم الدمج بنجاح!<br>
                        ${removedCount > 0 ? `🗑️ تم حذف ${removedCount} محل مكرر<br>` : ''}
                        ${addedCount > 0 ? `➕ تم إضافة ${addedCount} محل جديد<br>` : ''}
                        📊 إجمالي المحلات الآن: ${mergedShops.length}
                    </div>
                `;
                
                // Refresh shops list
                setTimeout(() => {
                    document.getElementById('mergeModal').remove();
                    displayShopsList();
                    alert(`✅ تم دمج البيانات بنجاح!\n\n${removedCount > 0 ? `تم حذف ${removedCount} محل مكرر\n` : ''}${addedCount > 0 ? `تم إضافة ${addedCount} محل جديد\n` : ''}إجمالي المحلات: ${mergedShops.length}`);
                }, 2000);
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; border: 2px solid #f5c6cb;">❌ فشل الدمج: ${error.message}</div>`;
            }
        };
        
        
        // Validate Shops Data
        function validateShopsData() {
            if (!planData || !planData.shops) {
                alert('⚠️ لا توجد بيانات محلات للتحقق منها');
                return;
            }
            
            const issues = [];
            planData.shops.forEach((shop, idx) => {
                if (!shop.name) issues.push(`محل ${idx + 1}: اسم غير محدد`);
                if (!shop.areaId) issues.push(`${shop.name}: منطقة غير محددة`);
            });
            
            if (issues.length === 0) {
                alert('✅ جميع بيانات المحلات صحيحة!\n\n' +
                      `📊 إجمالي المحلات: ${planData.shops.length}`);
            } else {
                alert(`⚠️ تم العثور على ${issues.length} مشكلة:\n\n` + 
                      issues.slice(0, 10).join('\n') +
                      (issues.length > 10 ? `\n\n... و ${issues.length - 10} مشكلة أخرى` : ''));
            }
        }
        
        // View Shops on Map - INTERACTIVE AND HEATMAP IMPLEMENTATION
        function viewShopsOnMap() {
            if (!planData || !planData.shops || planData.shops.length === 0) {
                alert('⚠️ لا توجد محلات لعرضها على الخريطة');
                return;
            }
            
            // Create modal for map
            const modal = document.createElement('div');
            modal.id = 'mapModal';
            modal.style.cssText = `
                display: block;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                overflow: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; margin: 2% auto; padding: 30px; border-radius: 15px; max-width: 95%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2d3561; margin: 0;">🗺️ الخريطة التفاعلية والحرارية للمحلات</h2>
                        <button onclick="document.getElementById('mapModal').remove()" style="font-size: 2em; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    </div>
                    
                    <!-- Map Controls -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <select id="mapViewMode" onchange="updateMapView()" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            <option value="interactive">📍 عرض تفاعلي</option>
                            <option value="heatmap">🔥 خريطة حرارية</option>
                            <option value="cluster">🎯 عرض مجموعات</option>
                        </select>
                        <select id="mapFilterArea" onchange="updateMapView()" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-family: 'Cairo', sans-serif;">
                            <option value="">جميع المناطق</option>
                        </select>
                        <button onclick="toggleHeatmapIntensity()" style="padding: 10px 20px; border-radius: 8px; border: none; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                            🌡️ تبديل كثافة الحرارة
                        </button>
                        <button onclick="exportMapData()" style="padding: 10px 20px; border-radius: 8px; border: none; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-family: 'Cairo', sans-serif; cursor: pointer;">
                            📥 تصدير بيانات الخريطة
                        </button>
                    </div>
                    
                    <!-- Map Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mapTotalShops">0</div>
                            <div style="font-size: 0.9em;">إجمالي المحلات</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mapVisibleShops">0</div>
                            <div style="font-size: 0.9em;">المحلات المعروضة</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;" id="mapAreasCount">0</div>
                            <div style="font-size: 0.9em;">عدد المناطق</div>
                        </div>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="shopsMapContainer" style="background: #f5f5f5; border-radius: 10px; padding: 20px; min-height: 500px; position: relative;">
                        <div id="mapLegend" style="position: absolute; top: 10px; right: 10px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100;">
                            <h4 style="margin: 0 0 10px 0; color: #2d3561;">مفتاح الخريطة</h4>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 20px; background: #667eea; border-radius: 50%;"></div>
                                    <span>محل عادي</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 20px; background: #dc3545; border-radius: 50%;"></div>
                                    <span>أولوية عالية</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 20px; background: #ffc107; border-radius: 50%;"></div>
                                    <span>أولوية متوسطة</span>
                                </div>
                            </div>
                        </div>
                        <div id="mapCanvas" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 20px;">
                            <!-- Map items will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Shop Details Panel -->
                    <div id="shopDetailsPanel" style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px; display: none;">
                        <h3 style="color: #2d3561; margin-bottom: 15px;">تفاصيل المحل المحدد</h3>
                        <div id="shopDetailsContent"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate area filter
            const areaFilter = document.getElementById('mapFilterArea');
            if (planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    areaFilter.appendChild(option);
                });
            }
            
            // Initial map render
            updateMapView();
        }
        
        // Update map view based on selected mode
        window.updateMapView = function() {
            const mode = document.getElementById('mapViewMode').value;
            const filterAreaId = document.getElementById('mapFilterArea').value;
            const mapCanvas = document.getElementById('mapCanvas');
            
            // Filter shops
            let shopsToDisplay = planData.shops || [];
            if (filterAreaId) {
                shopsToDisplay = shopsToDisplay.filter(s => s.areaId === filterAreaId);
            }
            
            // Update stats
            document.getElementById('mapTotalShops').textContent = planData.shops.length;
            document.getElementById('mapVisibleShops').textContent = shopsToDisplay.length;
            document.getElementById('mapAreasCount').textContent = new Set(planData.shops.map(s => s.areaId)).size;
            
            // Clear canvas
            mapCanvas.innerHTML = '';
            
            if (mode === 'interactive') {
                renderInteractiveMap(shopsToDisplay, mapCanvas);
            } else if (mode === 'heatmap') {
                renderHeatmap(shopsToDisplay, mapCanvas);
            } else if (mode === 'cluster') {
                renderClusterMap(shopsToDisplay, mapCanvas);
            }
        };
        
        // Render interactive map
        function renderInteractiveMap(shops, container) {
            shops.forEach((shop, index) => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                const areaName = area ? area.name : 'غير محدد';
                
                // Calculate priority color
                let color = '#667eea';
                let priorityLabel = 'عادي';
                
                // Check if shop has high priority based on last inspection
                const lastInspection = planData.inspectionData ? 
                    planData.inspectionData.filter(i => i.shops && i.shops.includes(shop.name))
                    .sort((a, b) => new Date(b.day) - new Date(a.day))[0] : null;
                
                if (lastInspection) {
                    const daysSince = Math.floor((new Date() - new Date(lastInspection.day)) / (1000 * 60 * 60 * 24));
                    if (daysSince > 30) {
                        color = '#dc3545';
                        priorityLabel = 'عالية';
                    } else if (daysSince > 14) {
                        color = '#ffc107';
                        priorityLabel = 'متوسطة';
                    }
                }
                
                const shopCard = document.createElement('div');
                shopCard.style.cssText = `
                    background: white;
                    padding: 15px;
                    border-radius: 10px;
                    border: 3px solid ${color};
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                `;
                shopCard.onmouseover = function() {
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
                };
                shopCard.onmouseout = function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                };
                shopCard.onclick = function() {
                    showShopDetails(shop, lastInspection);
                };
                
                shopCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #2d3561; font-size: 1.1em;">${shop.name}</h4>
                        <span style="background: ${color}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75em;">${priorityLabel}</span>
                    </div>
                    <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">📍 ${areaName}</div>
                    <div style="color: #999; font-size: 0.85em;">
                        ${lastInspection ? `آخر تفتيش: ${new Date(lastInspection.day).toLocaleDateString('ar-EG')}` : 'لم يتم التفتيش بعد'}
                    </div>
                `;
                
                container.appendChild(shopCard);
            });
        }
        
        // Render heatmap
        function renderHeatmap(shops, container) {
            // Group shops by area
            const areaGroups = {};
            shops.forEach(shop => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                const areaName = area ? area.name : 'غير محدد';
                if (!areaGroups[areaName]) {
                    areaGroups[areaName] = [];
                }
                areaGroups[areaName].push(shop);
            });
            
            // Find max count for heat intensity
            const maxCount = Math.max(...Object.values(areaGroups).map(g => g.length));
            
            // Render heat blocks
            Object.entries(areaGroups).forEach(([areaName, areaShops]) => {
                const intensity = areaShops.length / maxCount;
                const heatColor = getHeatColor(intensity);
                
                const heatBlock = document.createElement('div');
                heatBlock.style.cssText = `
                    background: ${heatColor};
                    padding: 20px;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                    min-height: 150px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    text-align: center;
                `;
                heatBlock.onmouseover = function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
                };
                heatBlock.onmouseout = function() {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                };
                
                heatBlock.innerHTML = `
                    <h3 style="margin: 0 0 15px 0; color: white; font-size: 1.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">${areaName}</h3>
                    <div style="font-size: 3em; font-weight: 700; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">${areaShops.length}</div>
                    <div style="color: white; font-size: 1em; margin-top: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">محل</div>
                    <div style="margin-top: 10px; color: white; font-size: 0.9em;">🔥 كثافة: ${Math.round(intensity * 100)}%</div>
                `;
                
                container.appendChild(heatBlock);
            });
        }
        
        // Render cluster map
        function renderClusterMap(shops, container) {
            // Similar to heatmap but with different visualization
            const areaGroups = {};
            shops.forEach(shop => {
                const area = planData.areas.find(a => a.id === shop.areaId);
                const areaName = area ? area.name : 'غير محدد';
                if (!areaGroups[areaName]) {
                    areaGroups[areaName] = [];
                }
                areaGroups[areaName].push(shop);
            });
            
            Object.entries(areaGroups).forEach(([areaName, areaShops]) => {
                const clusterDiv = document.createElement('div');
                clusterDiv.style.cssText = `
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 20px;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                `;
                
                clusterDiv.innerHTML = `
                    <h3 style="margin: 0 0 15px 0; color: white;">${areaName}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 5px;">
                        ${areaShops.map((shop, idx) => `
                            <div style="width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; color: #667eea; font-weight: 700;" title="${shop.name}">
                                ${idx + 1}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(clusterDiv);
            });
        }
        
        // Get heat color based on intensity
        function getHeatColor(intensity) {
            const colors = [
                '#38ef7d',  // Low (green)
                '#11998e',  // Medium-low (teal)
                '#ffc107',  // Medium (yellow)
                '#fa709a',  // Medium-high (pink)
                '#dc3545'   // High (red)
            ];
            const index = Math.min(Math.floor(intensity * colors.length), colors.length - 1);
            return colors[index];
        }
        
        // Show shop details
        window.showShopDetails = function(shop, lastInspection) {
            const panel = document.getElementById('shopDetailsPanel');
            const content = document.getElementById('shopDetailsContent');
            const area = planData.areas.find(a => a.id === shop.areaId);
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <strong style="color: #667eea;">اسم المحل:</strong><br>
                        <span>${shop.name}</span>
                    </div>
                    <div>
                        <strong style="color: #667eea;">المنطقة:</strong><br>
                        <span>${area ? area.name : 'غير محدد'}</span>
                    </div>
                    <div>
                        <strong style="color: #667eea;">المعرف:</strong><br>
                        <span style="font-family: monospace;">${shop.id}</span>
                    </div>
                    ${lastInspection ? `
                        <div>
                            <strong style="color: #667eea;">آخر تفتيش:</strong><br>
                            <span>${new Date(lastInspection.day).toLocaleDateString('ar-EG')}</span>
                        </div>
                        <div>
                            <strong style="color: #667eea;">المفتش:</strong><br>
                            <span>${lastInspection.inspector}</span>
                        </div>
                    ` : ''}
                </div>
            `;
            
            panel.style.display = 'block';
        };
        
        // Toggle heatmap intensity
        window.toggleHeatmapIntensity = function() {
            alert('🌡️ تم تبديل كثافة الحرارة!\n\nالخريطة الحرارية تعرض الآن كثافات مختلفة حسب عدد المحلات في كل منطقة.');
            updateMapView();
        };
        
        // Export map data
        window.exportMapData = function() {
            const mode = document.getElementById('mapViewMode').value;
            const filterAreaId = document.getElementById('mapFilterArea').value;
            
            let shopsToExport = planData.shops || [];
            if (filterAreaId) {
                shopsToExport = shopsToExport.filter(s => s.areaId === filterAreaId);
            }
            
            const exportData = {
                exportDate: new Date().toISOString(),
                mode: mode,
                totalShops: shopsToExport.length,
                shops: shopsToExport.map(shop => {
                    const area = planData.areas.find(a => a.id === shop.areaId);
                    return {
                        name: shop.name,
                        area: area ? area.name : 'غير محدد',
                        id: shop.id
                    };
                })
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `map-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert(`✅ تم تصدير ${shopsToExport.length} محل من الخريطة بنجاح!`);
        };
        
        
        // Merge Areas
        function mergeAreas() {
            alert('🔗 دمج المناطق\n\nسيتم إضافة هذه الميزة قريباً.\n\nستتمكن من:\n• دمج منطقتين أو أكثر\n• نقل المحلات تلقائياً\n• تحديث التفتيشات');
        }
        
        // Assign Shops to Areas
        function assignShopsToAreas() {
            alert('📍 تعيين المحلات للمناطق\n\nسيتم إضافة هذه الميزة قريباً.\n\nستتمكن من:\n• تعيين محلات متعددة لمنطقة\n• إعادة تعيين المحلات\n• التعيين التلقائي حسب الموقع');
        }
        
        // Export Areas Data
        function exportAreasData() {
            if (!planData || !planData.areas) {
                alert('⚠️ لا توجد بيانات مناطق للتصدير');
                return;
            }
            
            const dataStr = JSON.stringify(planData.areas, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `areas-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert(`✅ تم تصدير ${planData.areas.length} منطقة بنجاح!`);
        }
        
        // Import Areas from File
        function importAreasFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedAreas = JSON.parse(event.target.result);
                        if (!Array.isArray(importedAreas)) {
                            alert('❌ صيغة الملف غير صحيحة. يجب أن يكون مصفوفة من المناطق.');
                            return;
                        }
                        
                        alert(`📥 تم استيراد ${importedAreas.length} منطقة!\n\nسيتم إضافة ميزة الدمج قريباً.`);
                    } catch (error) {
                        alert('❌ فشل قراءة الملف: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // Bulk Edit Areas
        function bulkEditAreas() {
            alert('✏️ التعديل الجماعي للمناطق\n\nسيتم إضافة هذه الميزة قريباً.\n\nستتمكن من:\n• إعادة تسمية عدة مناطق\n• تحديث المعلومات\n• إعادة ترتيب المناطق');
        }
        
        // Generate Areas Report
        function generateAreasReport() {
            if (!planData || !planData.areas || !planData.shops) {
                alert('⚠️ لا توجد بيانات كافية للتقرير');
                return;
            }
            
            let report = '📊 تقرير المناطق\n';
            report += '=' .repeat(50) + '\n\n';
            
            planData.areas.forEach(area => {
                const shopsInArea = planData.shops.filter(s => s.areaId === area.id).length;
                const inspectionsInArea = planData.inspectionData.filter(i => i.area === area.name).length;
                
                report += `🗺️ ${area.name}\n`;
                report += `   • المحلات: ${shopsInArea}\n`;
                report += `   • التفتيشات: ${inspectionsInArea}\n\n`;
            });
            
            const dataBlob = new Blob([report], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `areas-report-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('✅ تم إنشاء تقرير المناطق!');
        }
        
        // ==================== Smart Shop List Functions ====================
        
        /**
         * Calculate shop rating based on multiple criteria
         * Rating criteria:
         * 1. Compliance (الالتزام) - 30 points
         * 2. Last inspection date (آخر تفتيش) - 25 points
         * 3. Inspection frequency (تكرار التفتيش) - 20 points
         * 4. Data completeness (اكتمال البيانات) - 15 points
         * 5. Activity type priority (أولوية النشاط) - 10 points
         */
        function calculateShopRating(shopName) {
            let rating = 0;
            let details = {
                compliance: 0,
                lastInspection: 0,
                frequency: 0,
                dataCompleteness: 0,
                activityPriority: 0
            };
            
            // Get shop details
            const shopDetails = shopsDetails ? shopsDetails[shopName] : null;
            
            // 1. Data Completeness (15 points)
            if (shopDetails) {
                let completeness = 0;
                if (shopDetails.nameAr) completeness += 2;
                if (shopDetails.nameEn) completeness += 2;
                if (shopDetails.licenseNo) completeness += 3;
                if (shopDetails.admCode) completeness += 2;
                if (shopDetails.address) completeness += 2;
                if (shopDetails.contact) completeness += 2;
                if (shopDetails.activity) completeness += 2;
                details.dataCompleteness = completeness;
                rating += completeness;
            }
            
            // 2. Activity Type Priority (10 points)
            if (shopDetails && shopDetails.activity) {
                const activity = shopDetails.activity.toLowerCase();
                // High priority activities
                if (activity.includes('animal') || activity.includes('حيوان') || 
                    activity.includes('veterinar') || activity.includes('بيطر')) {
                    details.activityPriority = 10;
                    rating += 10;
                } else if (activity.includes('pet') || activity.includes('أليف')) {
                    details.activityPriority = 8;
                    rating += 8;
                } else if (activity.includes('bird') || activity.includes('طيور')) {
                    details.activityPriority = 7;
                    rating += 7;
                } else {
                    details.activityPriority = 5;
                    rating += 5;
                }
            }
            
            // 3. Last Inspection Date (25 points)
            const lastInspection = getLastInspectionForShop(shopName);
            if (lastInspection) {
                const daysSince = Math.floor((new Date() - new Date(lastInspection.day)) / (1000 * 60 * 60 * 24));
                if (daysSince <= 7) {
                    details.lastInspection = 25;
                    rating += 25;
                } else if (daysSince <= 14) {
                    details.lastInspection = 20;
                    rating += 20;
                } else if (daysSince <= 30) {
                    details.lastInspection = 15;
                    rating += 15;
                } else if (daysSince <= 60) {
                    details.lastInspection = 10;
                    rating += 10;
                } else {
                    details.lastInspection = 5;
                    rating += 5;
                }
            }
            
            // 4. Inspection Frequency (20 points)
            const inspectionCount = getInspectionCountForShop(shopName);
            if (inspectionCount >= 10) {
                details.frequency = 20;
                rating += 20;
            } else if (inspectionCount >= 7) {
                details.frequency = 16;
                rating += 16;
            } else if (inspectionCount >= 5) {
                details.frequency = 12;
                rating += 12;
            } else if (inspectionCount >= 3) {
                details.frequency = 8;
                rating += 8;
            } else if (inspectionCount >= 1) {
                details.frequency = 4;
                rating += 4;
            }
            
            // 5. Compliance Score (30 points) - Based on consistent inspections
            // Good compliance = regular inspections without long gaps
            if (inspectionCount > 0) {
                const inspections = getInspectionsForShop(shopName);
                if (inspections.length >= 2) {
                    // Calculate consistency
                    const dates = inspections.map(i => new Date(i.day)).sort((a, b) => b - a);
                    const gaps = [];
                    for (let i = 0; i < dates.length - 1; i++) {
                        gaps.push(Math.floor((dates[i] - dates[i + 1]) / (1000 * 60 * 60 * 24)));
                    }
                    const avgGap = gaps.reduce((a, b) => a + b, 0) / gaps.length;
                    
                    if (avgGap <= 14) {
                        details.compliance = 30;
                        rating += 30;
                    } else if (avgGap <= 21) {
                        details.compliance = 25;
                        rating += 25;
                    } else if (avgGap <= 30) {
                        details.compliance = 20;
                        rating += 20;
                    } else {
                        details.compliance = 15;
                        rating += 15;
                    }
                } else if (inspectionCount === 1) {
                    details.compliance = 10;
                    rating += 10;
                }
            }
            
            return { rating, details };
        }
        
        function getLastInspectionForShop(shopName) {
            if (!planData || !planData.inspectionData) return null;
            
            const inspections = planData.inspectionData
                .filter(i => i.shops && i.shops.includes(shopName))
                .sort((a, b) => new Date(b.day) - new Date(a.day));
            
            return inspections.length > 0 ? inspections[0] : null;
        }
        
        function getInspectionCountForShop(shopName) {
            if (!planData || !planData.inspectionData) return 0;
            
            return planData.inspectionData.filter(i => i.shops && i.shops.includes(shopName)).length;
        }
        
        function getInspectionsForShop(shopName) {
            if (!planData || !planData.inspectionData) return [];
            
            return planData.inspectionData.filter(i => i.shops && i.shops.includes(shopName));
        }
        
        // Open Smart Shop List Modal
        async function openSmartShopListModal() {
            // Load shops details if not loaded
            if (!shopsDetails) {
                try {
                    const response = await fetch('shops_details.json?' + new Date().getTime());
                    if (response.ok) {
                        shopsDetails = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading shops_details.json:', error);
                }
            }
            
            // Populate area filter
            const areaFilter = document.getElementById('smartListAreaFilter');
            areaFilter.innerHTML = '<option value="">جميع المناطق</option>';
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    areaFilter.appendChild(option);
                });
            }
            
            // Show modal
            document.getElementById('smartShopListModal').style.display = 'block';
            
            // Generate initial list
            updateSmartShopList();
        }
        
        // Close Smart Shop List Modal
        function closeSmartShopListModal() {
            document.getElementById('smartShopListModal').style.display = 'none';
        }
        
        // Update Smart Shop List based on filters
        function updateSmartShopList() {
            const primarySort = document.getElementById('primarySort').value;
            const areaFilter = document.getElementById('smartListAreaFilter').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            const tableView = document.getElementById('tableView').value;
            
            // Collect all shops
            let allShops = [];
            
            if (shopsDetails) {
                Object.entries(shopsDetails).forEach(([shopName, shopInfo]) => {
                    const area = planData?.areas?.find(a => a.name === shopInfo.address || a.id === shopInfo.areaId);
                    const ratingData = calculateShopRating(shopName);
                    
                    allShops.push({
                        name: shopInfo.nameAr || shopName,
                        nameEn: shopInfo.nameEn || '',
                        licenseNo: shopInfo.licenseNo || '',
                        admCode: shopInfo.admCode || '',
                        address: shopInfo.address || '',
                        contact: shopInfo.contact || '',
                        activity: shopInfo.activity || '',
                        area: area ? area.name : shopInfo.address || 'غير محدد',
                        areaId: area ? area.id : '',
                        rating: ratingData.rating,
                        ratingDetails: ratingData.details,
                        lastInspection: getLastInspectionForShop(shopName),
                        inspectionCount: getInspectionCountForShop(shopName)
                    });
                });
            }
            
            // Apply filters
            if (areaFilter) {
                const selectedArea = planData?.areas?.find(a => a.id === areaFilter);
                if (selectedArea) {
                    allShops = allShops.filter(s => s.area === selectedArea.name || s.areaId === areaFilter);
                }
            }
            
            if (ratingFilter) {
                allShops = allShops.filter(shop => {
                    if (ratingFilter === 'excellent') return shop.rating >= 90;
                    if (ratingFilter === 'good') return shop.rating >= 70 && shop.rating < 90;
                    if (ratingFilter === 'fair') return shop.rating >= 50 && shop.rating < 70;
                    if (ratingFilter === 'poor') return shop.rating < 50;
                    return true;
                });
            }
            
            // Apply sorting
            if (primarySort === 'rating') {
                allShops.sort((a, b) => b.rating - a.rating);
            } else if (primarySort === 'area') {
                allShops.sort((a, b) => a.area.localeCompare(b.area, 'ar'));
            } else if (primarySort === 'activity') {
                allShops.sort((a, b) => (a.activity || '').localeCompare(b.activity || '', 'ar'));
            } else if (primarySort === 'alphabetical') {
                allShops.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            } else if (primarySort === 'lastInspection') {
                allShops.sort((a, b) => {
                    const dateA = a.lastInspection ? new Date(a.lastInspection.day) : new Date(0);
                    const dateB = b.lastInspection ? new Date(b.lastInspection.day) : new Date(0);
                    return dateB - dateA;
                });
            }
            
            // Update statistics
            const totalShops = allShops.length;
            const avgRating = totalShops > 0 ? (allShops.reduce((sum, s) => sum + s.rating, 0) / totalShops).toFixed(1) : 0;
            const uniqueAreas = new Set(allShops.map(s => s.area)).size;
            const highPriority = allShops.filter(s => s.rating >= 70).length;
            
            document.getElementById('smartListTotalShops').textContent = totalShops;
            document.getElementById('smartListAvgRating').textContent = avgRating;
            document.getElementById('smartListAreas').textContent = uniqueAreas;
            document.getElementById('smartListHighPriority').textContent = highPriority;
            
            // Generate tables based on view mode
            const content = document.getElementById('smartShopListContent');
            
            if (tableView === 'unified') {
                content.innerHTML = generateUnifiedTable(allShops);
            } else if (tableView === 'byArea') {
                content.innerHTML = generateTablesByArea(allShops);
            } else if (tableView === 'byActivity') {
                content.innerHTML = generateTablesByActivity(allShops);
            }
        }
        
        // Generate unified table
        function generateUnifiedTable(shops) {
            if (shops.length === 0) {
                return '<p style="text-align: center; padding: 40px; color: #999;">لا توجد محلات مطابقة للفلاتر المحددة</p>';
            }
            
            let html = '<div style="overflow-x: auto;">';
            html += '<table class="inspections-table" style="width: 100%;">';
            html += '<thead><tr>';
            html += '<th>#</th>';
            html += '<th>اسم المحل</th>';
            html += '<th>المنطقة</th>';
            html += '<th>النشاط</th>';
            html += '<th>التقييم</th>';
            html += '<th>آخر تفتيش</th>';
            html += '<th>عدد التفتيشات</th>';
            html += '<th>التفاصيل</th>';
            html += '</tr></thead><tbody>';
            
            shops.forEach((shop, idx) => {
                const ratingClass = shop.rating >= 90 ? 'excellent' : 
                                   shop.rating >= 70 ? 'good' : 
                                   shop.rating >= 50 ? 'fair' : 'poor';
                const ratingColor = shop.rating >= 90 ? '#27ae60' : 
                                   shop.rating >= 70 ? '#3498db' : 
                                   shop.rating >= 50 ? '#f39c12' : '#e74c3c';
                
                const lastInspectionText = shop.lastInspection ? 
                    new Date(shop.lastInspection.day).toLocaleDateString('ar-EG') : 'لم يتم';
                
                const activityShort = shop.activity ? 
                    (shop.activity.length > 50 ? shop.activity.substring(0, 50) + '...' : shop.activity) : 
                    'غير محدد';
                
                html += '<tr>';
                html += `<td>${idx + 1}</td>`;
                html += `<td><strong>${escapeHtml(shop.name)}</strong><br><small style="color: #999;">${escapeHtml(shop.nameEn || '')}</small></td>`;
                html += `<td>${escapeHtml(shop.area)}</td>`;
                html += `<td title="${escapeHtml(shop.activity || '')}">${escapeHtml(activityShort)}</td>`;
                html += `<td><div style="background: ${ratingColor}; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; text-align: center;">${shop.rating.toFixed(0)}</div></td>`;
                html += `<td>${lastInspectionText}</td>`;
                html += `<td style="text-align: center;">${shop.inspectionCount}</td>`;
                html += `<td><button onclick="showShopRatingDetails('${escapeHtml(shop.name)}')" class="btn btn-sm btn-info" style="padding: 5px 10px;">عرض</button></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        // Generate tables by area
        function generateTablesByArea(shops) {
            if (shops.length === 0) {
                return '<p style="text-align: center; padding: 40px; color: #999;">لا توجد محلات مطابقة للفلاتر المحددة</p>';
            }
            
            // Group shops by area
            const shopsByArea = {};
            shops.forEach(shop => {
                if (!shopsByArea[shop.area]) {
                    shopsByArea[shop.area] = [];
                }
                shopsByArea[shop.area].push(shop);
            });
            
            let html = '';
            Object.keys(shopsByArea).sort((a, b) => a.localeCompare(b, 'ar')).forEach(area => {
                const areaShops = shopsByArea[area];
                const avgRating = (areaShops.reduce((sum, s) => sum + s.rating, 0) / areaShops.length).toFixed(1);
                
                html += `<div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">`;
                html += `<h3 style="color: #667eea; margin-bottom: 15px;">🗺️ ${escapeHtml(area)} <span style="color: #999; font-size: 0.8em;">(${areaShops.length} محل - متوسط التقييم: ${avgRating})</span></h3>`;
                html += generateUnifiedTable(areaShops);
                html += '</div>';
            });
            
            return html;
        }
        
        // Generate tables by activity
        function generateTablesByActivity(shops) {
            if (shops.length === 0) {
                return '<p style="text-align: center; padding: 40px; color: #999;">لا توجد محلات مطابقة للفلاتر المحددة</p>';
            }
            
            // Group shops by main activity type
            const shopsByActivity = {};
            shops.forEach(shop => {
                let activityType = 'أخرى';
                const activity = (shop.activity || '').toLowerCase();
                
                if (activity.includes('animal') || activity.includes('حيوان')) {
                    activityType = 'تجارة الحيوانات';
                } else if (activity.includes('veterinar') || activity.includes('بيطر')) {
                    activityType = 'خدمات بيطرية';
                } else if (activity.includes('bird') || activity.includes('طيور')) {
                    activityType = 'تجارة الطيور';
                } else if (activity.includes('pet') || activity.includes('أليف')) {
                    activityType = 'حيوانات أليفة';
                } else if (activity.includes('fish') || activity.includes('أسماك')) {
                    activityType = 'أسماك الزينة';
                }
                
                if (!shopsByActivity[activityType]) {
                    shopsByActivity[activityType] = [];
                }
                shopsByActivity[activityType].push(shop);
            });
            
            let html = '';
            Object.keys(shopsByActivity).sort((a, b) => a.localeCompare(b, 'ar')).forEach(activityType => {
                const activityShops = shopsByActivity[activityType];
                const avgRating = (activityShops.reduce((sum, s) => sum + s.rating, 0) / activityShops.length).toFixed(1);
                
                html += `<div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">`;
                html += `<h3 style="color: #667eea; margin-bottom: 15px;">💼 ${escapeHtml(activityType)} <span style="color: #999; font-size: 0.8em;">(${activityShops.length} محل - متوسط التقييم: ${avgRating})</span></h3>`;
                html += generateUnifiedTable(activityShops);
                html += '</div>';
            });
            
            return html;
        }
        
        // Show shop rating details
        function showShopRatingDetails(shopName) {
            const ratingData = calculateShopRating(shopName);
            const shop = shopsDetails[shopName];
            
            let details = `📊 تفاصيل التقييم: ${shopName}\n`;
            details += `${'='.repeat(50)}\n\n`;
            details += `📈 التقييم الإجمالي: ${ratingData.rating.toFixed(0)}/100\n\n`;
            details += `تفاصيل المحاور:\n`;
            details += `• الالتزام: ${ratingData.details.compliance}/30\n`;
            details += `• آخر تفتيش: ${ratingData.details.lastInspection}/25\n`;
            details += `• تكرار التفتيش: ${ratingData.details.frequency}/20\n`;
            details += `• اكتمال البيانات: ${ratingData.details.dataCompleteness}/15\n`;
            details += `• أولوية النشاط: ${ratingData.details.activityPriority}/10\n\n`;
            
            const lastInspection = getLastInspectionForShop(shopName);
            if (lastInspection) {
                const daysSince = Math.floor((new Date() - new Date(lastInspection.day)) / (1000 * 60 * 60 * 24));
                details += `📅 آخر تفتيش: ${new Date(lastInspection.day).toLocaleDateString('ar-EG')} (منذ ${daysSince} يوم)\n`;
            } else {
                details += `📅 آخر تفتيش: لم يتم التفتيش بعد\n`;
            }
            
            details += `🔢 عدد التفتيشات الكلية: ${getInspectionCountForShop(shopName)}\n`;
            
            if (shop) {
                details += `\n📍 معلومات المحل:\n`;
                if (shop.licenseNo) details += `• رقم الرخصة: ${shop.licenseNo}\n`;
                if (shop.admCode) details += `• كود ADM: ${shop.admCode}\n`;
                if (shop.address) details += `• العنوان: ${shop.address}\n`;
                if (shop.contact) details += `• الهاتف: ${shop.contact}\n`;
            }
            
            alert(details);
        }
        
        // Export Smart Shop List
        function exportSmartShopList(format) {
            const primarySort = document.getElementById('primarySort').value;
            const areaFilter = document.getElementById('smartListAreaFilter').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            
            // Get current filtered shops
            let allShops = [];
            
            if (shopsDetails) {
                Object.entries(shopsDetails).forEach(([shopName, shopInfo]) => {
                    const area = planData?.areas?.find(a => a.name === shopInfo.address || a.id === shopInfo.areaId);
                    const ratingData = calculateShopRating(shopName);
                    
                    allShops.push({
                        name: shopInfo.nameAr || shopName,
                        nameEn: shopInfo.nameEn || '',
                        licenseNo: shopInfo.licenseNo || '',
                        admCode: shopInfo.admCode || '',
                        address: shopInfo.address || '',
                        contact: shopInfo.contact || '',
                        activity: shopInfo.activity || '',
                        area: area ? area.name : shopInfo.address || 'غير محدد',
                        rating: ratingData.rating,
                        lastInspection: getLastInspectionForShop(shopName),
                        inspectionCount: getInspectionCountForShop(shopName)
                    });
                });
            }
            
            // Apply same filters
            if (areaFilter) {
                const selectedArea = planData?.areas?.find(a => a.id === areaFilter);
                if (selectedArea) {
                    allShops = allShops.filter(s => s.area === selectedArea.name);
                }
            }
            
            if (ratingFilter) {
                allShops = allShops.filter(shop => {
                    if (ratingFilter === 'excellent') return shop.rating >= 90;
                    if (ratingFilter === 'good') return shop.rating >= 70 && shop.rating < 90;
                    if (ratingFilter === 'fair') return shop.rating >= 50 && shop.rating < 70;
                    if (ratingFilter === 'poor') return shop.rating < 50;
                    return true;
                });
            }
            
            if (format === 'json') {
                const dataStr = JSON.stringify(allShops, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `smart-shop-list-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                alert(`✅ تم تصدير ${allShops.length} محل بصيغة JSON`);
            } else if (format === 'excel' || format === 'pdf') {
                alert(`📊 تصدير ${format.toUpperCase()}\n\nسيتم إضافة هذه الميزة قريباً.\n\nيمكنك حالياً:\n• تصدير JSON\n• طباعة القائمة`);
            }
        }
        
        // Print Smart Shop List
        function printSmartShopList() {
            const content = document.getElementById('smartShopListContent').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>قائمة المحلات الذكية</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('body { font-family: "Cairo", Arial, sans-serif; direction: rtl; }');
            printWindow.document.write('table { width: 100%; border-collapse: collapse; margin: 20px 0; }');
            printWindow.document.write('th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }');
            printWindow.document.write('th { background-color: #667eea; color: white; }');
            printWindow.document.write('h3 { color: #667eea; }');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h1 style="text-align: center;">📋 قائمة المحلات الذكية</h1>');
            printWindow.document.write('<p style="text-align: center;">تاريخ الطباعة: ' + new Date().toLocaleDateString('ar-EG') + '</p>');
            printWindow.document.write(content);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>
