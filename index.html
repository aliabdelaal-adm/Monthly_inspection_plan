<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø®Ø·Ø© Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</title>
    <script>
        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± isDev
        var isDev = true; // Ù‚Ù… Ø¨ØªØºÙŠÙŠØ± Ø°Ù„Ùƒ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
        var inspectionData = {}; // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù„Ø¯ÙŠÙƒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØªÙŠØ´ Ù‡Ù†Ø§

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        // Ø²Ø± Ø§Ù„Ø­ÙØ¸ ÙÙŠ GitHub ÙˆÙ†Ø§ÙØ°Ø© Ø§Ù„ØªÙˆÙƒÙ†
        
        <div id="githubSaveBar" style="display:none; margin: 15px 0;">
          <button id="saveToGitHubBtn" style="background:#222;color:#fff;padding:8px 25px;border-radius:8px;border:none;font-size:16px;cursor:pointer">
            ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ GitHub
          </button>
          <span id="githubSaveMsg" style="margin-right:15px;color:green;font-weight:bold"></span>
        </div>
        <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø³Ø±ÙŠ -->
        <div id="githubTokenModal" style="display:none; position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;z-index:1000;justify-content:center;align-items:center">
          <div style="background:#fff;padding:30px 25px;border-radius:12px;max-width:350px">
            <h4 style="margin-bottom:10px">Ø¥Ø¯Ø®Ø§Ù„ GitHub Token</h4>
            <input type="password" id="githubTokenInput" style="width:100%;padding:8px" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„ØªÙˆÙƒÙ† Ù‡Ù†Ø§" />
            <div id="githubTokenMsg" style="color:red;margin:7px 0 0"></div>
            <button onclick="saveGithubToken()" style="margin-top:10px;padding:6px 25px;border-radius:7px;background:#1976d2;color:#fff">Ø­ÙØ¸</button>
          </div>
        </div>

        // =============================================
        //   Ø£ÙƒÙˆØ§Ø¯ Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ GitHub (Ø¬Ø¯ÙŠØ¯Ø©)
        // =============================================

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub
        const GITHUB_REPO = "aliabdelaal-adm/Monthly_inspection_plan"; // ØºÙŠØ±Ù‡ Ù„Ùˆ Ø§Ù„Ø±ÙŠØ¨Ùˆ Ù…Ø®ØªÙ„Ù
        const PLAN_FILE = "plan-data.json"; // ØºÙŠØ±Ù‡ Ù„Ùˆ ØªØ±ÙŠØ¯ Ø§Ø³Ù… Ù…Ù„Ù Ø¢Ø®Ø±

        function getGithubToken() {
            return localStorage.getItem("github_token") || "";
        }
        function setGithubToken(token) {
            localStorage.setItem("github_token", token);
        }
        function showGithubTokenModal(msg="") {
            document.getElementById("githubTokenModal").style.display = "flex";
            document.getElementById("githubTokenInput").value = "";
            document.getElementById("githubTokenMsg").innerText = msg;
            document.getElementById("githubTokenInput").focus();
        }
        function saveGithubToken() {
            const token = document.getElementById("githubTokenInput").value.trim();
            if(token.length < 10) {
                document.getElementById("githubTokenMsg").innerText = "ØªÙˆÙƒÙ† ØºÙŠØ± ØµØ­ÙŠØ­!";
                return;
            }
            setGithubToken(token);
            document.getElementById("githubTokenModal").style.display = "none";
            document.getElementById("githubSaveMsg").innerText = "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¢Ù†.";
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø­ÙØ¸ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·ÙˆØ±
        function showGithubSaveIfDeveloper() {
            if(isDev) {
                document.getElementById('githubSaveBar').style.display = '';
            } else {
                document.getElementById('githubSaveBar').style.display = 'none';
            }
        }
        // Ø­Ø¯Ø« Ø¸Ù‡ÙˆØ± Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø·ÙˆØ±
        // Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø³Ø·Ø± Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¸Ù‡ÙˆØ±/Ø¥Ø®ÙØ§Ø¡ Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø·ÙˆØ±:
        let origDevLoginBtn = document.getElementById("devLoginBtn").onclick;
        document.getElementById("devLoginBtn").onclick = function() {
            if(origDevLoginBtn) origDevLoginBtn();
            setTimeout(showGithubSaveIfDeveloper, 50);
        };
        let origDevLogoutBtn = document.getElementById("devLogoutBtn").onclick;
        document.getElementById("devLogoutBtn").onclick = function() {
            if(origDevLogoutBtn) origDevLogoutBtn();
            setTimeout(showGithubSaveIfDeveloper, 50);
        };
        // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø£ÙŠØ¶Ù‹Ø§
        document.addEventListener('DOMContentLoaded', function(){
            showGithubSaveIfDeveloper();
        });

        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­ÙØ¸
        document.getElementById("saveToGitHubBtn").onclick = async function() {
            let token = getGithubToken();
            if (!token) { showGithubTokenModal(); return; }
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª inspectionData ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ Ù…Ø´Ø±ÙˆØ¹Ùƒ
            let planData = inspectionData;
            if (!planData) {
                document.getElementById("githubSaveMsg").innerText = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸!";
                return;
            }
            document.getElementById("githubSaveMsg").innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
            // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ø­ÙØ¸
            let nowDate = new Date();
            planData.lastUpdate = nowDate.getFullYear()+"-"+String(nowDate.getMonth()+1).padStart(2,'0')+"-"+String(nowDate.getDate()).padStart(2,'0')
                +" "+String(nowDate.getHours()).padStart(2,'0')+":"+String(nowDate.getMinutes()).padStart(2,'0');
            let planContent = JSON.stringify(planData,null,2);
            // Ø§Ø­Ø¶Ø± sha Ù„Ù„Ù…Ù„Ù (Ø¥Ù† ÙˆØ¬Ø¯)
            let sha = null;
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${PLAN_FILE}`);
                if(res.ok) {
                    const json = await res.json();
                    sha = json.sha;
                }
            } catch {}
            // Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const putRes = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${PLAN_FILE}`, {
                method: "PUT",
                headers: {
                    "Authorization": `token ${token}`,
                    "Accept": "application/vnd.github+json"
                },
                body: JSON.stringify({
                    message: "ØªØ­Ø¯ÙŠØ« Ø®Ø·Ø© Ø§Ù„ØªÙØªÙŠØ´ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…Ø·ÙˆØ±",
                    content: btoa(unescape(encodeURIComponent(planContent))),
                    sha: sha
                })
            });
            if(putRes.ok) {
                document.getElementById("githubSaveMsg").innerText = "âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ GitHub!";
            } else {
                document.getElementById("githubSaveMsg").innerText = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ (ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ†/Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª)!";
                if(putRes.status === 401) showGithubTokenModal("ØªÙˆÙƒÙ† ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ!");
            }
        } 
    </script>
</head>
<body>
    <div id="devSection">
        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ† Ù‡Ù†Ø§ -->
    </div>
    <!-- Ø¨Ù‚ÙŠØ© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© -->
</body>
</html>
