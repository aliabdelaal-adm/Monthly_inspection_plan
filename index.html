<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>خطة التفتيش الشهرية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Optimization Meta Tags -->
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <meta name="bingbot" content="index, follow">
    <meta name="description" content="خطة التفتيش الشهرية - نظام إدارة وتنظيم خطط التفتيش الشهرية للمفتشين والمناطق والمحلات. Monthly Inspection Plan - Management system for organizing monthly inspection schedules for inspectors, areas and shops.">
    <meta name="keywords" content="خطة التفتيش الشهرية, Monthly Inspection Plan, تفتيش, inspection, خطة, plan, مفتش, inspector, منطقة, area, محل, shop">
    <meta name="author" content="علي عبدالعال - Ali Abdelaal">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="خطة التفتيش الشهرية - Monthly Inspection Plan">
    <meta property="og:description" content="نظام إدارة وتنظيم خطط التفتيش الشهرية للمفتشين والمناطق والمحلات - Management system for organizing monthly inspection schedules">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://aliabdelaal-adm.github.io/Monthly_inspection_plan/">
    <meta property="og:site_name" content="خطة التفتيش الشهرية">
    <meta property="og:locale" content="ar_AE">
    <meta property="og:locale:alternate" content="en_US">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="خطة التفتيش الشهرية - Monthly Inspection Plan">
    <meta name="twitter:description" content="نظام إدارة وتنظيم خطط التفتيش الشهرية للمفتشين والمناطق والمحلات">
    
    <!-- Additional SEO Tags -->
    <link rel="canonical" href="https://aliabdelaal-adm.github.io/Monthly_inspection_plan/">
    <meta name="theme-color" content="#2336a0">
    
    <!-- Structured Data JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "خطة التفتيش الشهرية",
      "alternateName": "Monthly Inspection Plan",
      "description": "نظام إدارة وتنظيم خطط التفتيش الشهرية للمفتشين والمناطق والمحلات",
      "url": "https://aliabdelaal-adm.github.io/Monthly_inspection_plan/",
      "applicationCategory": "BusinessApplication",
      "operatingSystem": "Web Browser",
      "inLanguage": ["ar", "en"],
      "author": {
        "@type": "Person",
        "name": "علي عبدالعال",
        "alternateName": "Ali Abdelaal"
      },
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "5.0",
        "ratingCount": "1"
      }
    }
    </script>
    
    <!-- مكتبات التصدير -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Cairo', Arial, sans-serif; background: #f7f9fc; margin:0;}
        .main-container {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 2px 16px #dadce0;
            padding: 36px 18px 24px 18px;
            max-width: 900px;
            min-width:320px;
            margin: 64px auto 0 auto;
            display: flex; flex-direction: column; align-items: center;
        }
        .header-top-bar {
            width:100%;
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom: 8px;
            position: relative;
        }
        .last-update-row {
            color: #666;
            font-size: 0.97em;
            margin-right: 8px;
            margin-top: 0;
            text-align: right;
            direction: ltr;
        }
        .bell-container {
            margin-left:8px;
            margin-top:0;
        }
        .bell-btn {
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
            padding: 8px;
            transition: transform 0.2s;
            font-size: 28px;
        }
        .bell-btn:hover {
            transform: scale(1.1);
        }
        .bell-btn:active {
            transform: scale(0.95);
        }
        
        /* Enhanced Realistic 3D Bell Design */
        .bell-3d {
            width: 50px;
            height: 50px;
            position: relative;
            display: inline-block;
            perspective: 200px;
        }
        
        .bell-body {
            width: 42px;
            height: 38px;
            background: linear-gradient(145deg, #ffd700 0%, #ffed4e 15%, #ffc107 45%, #b8860b 80%, #8b6914 100%);
            border-radius: 22px 22px 6px 6px;
            position: relative;
            box-shadow: 
                inset -6px -6px 12px rgba(0,0,0,0.25),
                inset 6px 6px 12px rgba(255,255,255,0.4),
                0 10px 20px rgba(0,0,0,0.4),
                0 2px 8px rgba(0,0,0,0.3);
            transform-style: preserve-3d;
            transform: rotateX(12deg) rotateY(-2deg);
            transition: all 0.3s ease;
        }
        
        /* Bell top handle */
        .bell-body::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 10px;
            background: linear-gradient(145deg, #b8860b 0%, #daa520 50%, #8b6914 100%);
            border-radius: 18px 18px 2px 2px;
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.3),
                0 3px 8px rgba(0,0,0,0.3);
        }
        
        /* Bell clapper */
        .bell-body::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 12px;
            background: linear-gradient(145deg, #8b4513 0%, #a0522d 50%, #654321 100%);
            border-radius: 0 0 60% 60%;
            box-shadow: 
                0 3px 6px rgba(0,0,0,0.5),
                inset 1px 1px 2px rgba(255,255,255,0.2);
        }
        
        /* Enhanced bell shine effect */
        .bell-shine {
            position: absolute;
            top: 6px;
            left: 6px;
            width: 14px;
            height: 18px;
            background: linear-gradient(135deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0.1) 100%);
            border-radius: 60% 40% 50% 70%;
            transform: rotate(-18deg);
            opacity: 0.8;
        }
        
        /* Additional metallic shine */
        .bell-body:hover {
            box-shadow: 
                inset -6px -6px 12px rgba(0,0,0,0.2),
                inset 6px 6px 12px rgba(255,255,255,0.5),
                0 12px 24px rgba(0,0,0,0.3),
                0 0 15px rgba(255,215,0,0.3);
        }
        
        @keyframes bellRing {
            0% { transform: rotateX(12deg) rotateY(-2deg) rotateZ(0deg); }
            10% { transform: rotateX(12deg) rotateY(-2deg) rotateZ(-12deg); }
            20% { transform: rotateX(12deg) rotateY(-2deg) rotateZ(12deg); }
            30% { transform: rotateX(12deg) rotateY(-2deg) rotateZ(-8deg); }
            40% { transform: rotateX(12deg) rotateY(-2deg) rotateZ(8deg); }
            50% { transform: rotateX(12deg) rotateY(-2deg) rotateZ(-4deg); }
            60% { transform: rotateX(12deg) rotateY(-2deg) rotateZ(4deg); }
            70% { transform: rotateX(12deg) rotateY(-2deg) rotateZ(-2deg); }
            80% { transform: rotateX(12deg) rotateY(-2deg) rotateZ(2deg); }
            100% { transform: rotateX(12deg) rotateY(-2deg) rotateZ(0deg); }
        }
        
        .bell-ringing .bell-body {
            animation: bellRing 0.8s ease-in-out;
        }
        
        /* Bell Notes Modal */
        .bell-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .bell-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .bell-bubble {
            background: #fff;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.1);
            position: relative;
            transform: scale(0.8);
            animation: bubbleAppear 0.3s ease forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes bubbleAppear {
            from { 
                transform: scale(0.8);
                opacity: 0;
            }
            to { 
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .bell-bubble::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50px;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 15px solid #fff;
        }
        
        .bell-bubble h3 {
            margin: 0 0 20px 0;
            color: #234085;
            font-size: 1.4em;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .bell-bubble h3::before {
            content: '🔔';
            font-size: 1.2em;
        }
        
        .bell-notes-textarea {
            width: 100%;
            min-height: 200px;
            border: 2px solid #e0e3ea;
            border-radius: 12px;
            padding: 15px;
            font-size: 1.1em;
            font-family: inherit;
            resize: vertical;
            outline: none;
            transition: border-color 0.3s;
            line-height: 1.6;
            font-weight: 500;
        }
        
        .bell-notes-textarea:focus {
            border-color: #234085;
            box-shadow: 0 0 0 3px rgba(35, 64, 133, 0.1);
        }
        
        .bell-bubble-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .bell-action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 100px;
        }
        
        .bell-save-btn {
            background: #28a745;
            color: white;
        }
        
        .bell-save-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .bell-clear-btn {
            background: #ffc107;
            color: #212529;
        }
        
        .bell-clear-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .bell-close-btn {
            background: #6c757d;
            color: white;
        }
        
        .bell-close-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .bell-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #1565c0;
            text-align: center;
        }
        .horizontal-line {
            width: 100%;
            border: none;
            border-top: 1.5px solid #e0e3ea;
            margin: 16px 0 0 0;
        }
        .title-bar {
            width:100%;
            display:flex;
            justify-content:center;
            align-items:center;
            margin-top: 18px;
            margin-bottom: 24px;
        }
        .main-title-box {
            background:#234085;
            color:#fff;
            padding:28px 0 28px 0;
            border-radius:14px;
            width: 96%;
            max-width: 600px;
            min-height: 56px;
            font-size:2.12em;
            text-align:center;
            font-weight: bold;
            letter-spacing: 1px;
            margin:0 auto;
            box-shadow:0 2px 14px #e0e2f5;
        }
        .login-section, .inspector-select-section {margin: 10px 0 18px 0; width: 100%; display:flex;justify-content:center;align-items:center;gap:10px;}
        select, input[type="text"], input[type="date"], input[type="password"] {padding:7px 16px;font-size:1em;border-radius:6px;border:1px solid #b6b6b6;min-width:130px;max-width:210px;}
        .actions-row {
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0 18px;
        }
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            width: 100%;
            max-width: 900px;
            justify-items: center;
            align-items: start;
        }
        .action-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            background: #f8f9fa;
            padding: 18px 15px;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            min-width: 180px;
            width: 100%;
            max-width: 280px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        .action-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        .action-group-title {
            font-size: 1em;
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 6px;
            width: 100%;
        }
        .action-group button {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .action-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .refresh-btn {background:#28a745;color:#fff;}
        .refresh-btn:hover {background:#218838;}
        .inspector-report-btn {background:#234085;color:#fff;}
        .inspector-report-btn:hover {background:#1a2f5f;}
        .monthly-report-btn {background:#ff9800;color:#fff;}
        .monthly-report-btn:hover {background:#e68900;}
        .enhanced-report-btn {background:#17a2b8;color:#fff;}
        .enhanced-report-btn:hover {background:#138496;}
        .pdf-btn {background:#d63384;color:#fff;}
        .pdf-btn:hover {background:#b02a5b;}
        .excel-btn {background:#198754;color:#fff;}
        .excel-btn:hover {background:#146c43;}
        .print-btn {background:#6c757d;color:#fff;}
        .print-btn:hover {background:#545b62;}
        .plan-table-container {width:100%;margin:18px 0;}
        .plan-table {width:100%;border-collapse:collapse;border-radius:13px;overflow:hidden;box-shadow:0 2px 14px #eee;}
        .plan-table th,.plan-table td {padding:10px 8px;text-align:center;}
        .plan-table th {
            background:#234085;
            color:#fff;
            font-weight:bold;
            font-size:1.12em;
        }
        .plan-table tr:nth-child(even) {background:#f5f7fb;}
        .plan-table td {
            border-bottom:1px solid #d7dcef;
            font-size:1em;
        }
        .dropdown-shops-btn {
            background:#234085;
            color:#fff;
            border:none;
            border-radius:6px;
            padding:6px 18px;
            cursor:pointer;
            font-size:0.98em;
            min-width:90px;
        }
        .shops-dropdown-list {
            display:none;
            position:fixed;
            background:#90EE90;
            border:2px solid #234085;
            border-radius:8px;
            margin-top:5px;
            min-width:180px;
            max-height:250px;
            box-shadow:0 4px 16px rgba(0,0,0,0.2);
            z-index:1000;
            right:unset;
            left:unset;
            text-align:right;
            overflow-y:auto;
        }
        .shops-dropdown-list ul {
            list-style: none;
            margin:0; padding:7px 5px;
        }
        .shops-dropdown-list ul li {
            padding:8px 12px;
            border-bottom:1px solid #e0e0e0;
            font-size:0.97em;
            transition: background-color 0.2s;
        }
        .shops-dropdown-list ul li:hover {
            background-color:#f0f8ff;
        }
        .shops-dropdown-list ul li:last-child {border-bottom:none;}
        .shops-dropdown-wrap {position:relative; display:inline-block;}
        .inspector-report-div {margin:16px 0 0 0;background:#f7f9fc;border-radius:10px;padding:18px 12px;width:100%;color:#234085;font-size:1.1em;box-shadow:0 1px 5px #e2e2e2;}
        /* تنسيق قسم البحث */
        .search-filters-section {
            background:#f8f9fa;
            padding:15px;
            border-radius:8px;
            margin:15px 0;
            border:1px solid #dee2e6;
        }
        .search-filters-grid {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
            gap:15px;
            align-items:end;
        }
        .modal-overlay {
            display:none; position:fixed;z-index:9999;right:0;left:0;top:0;bottom:0; background:rgba(0,0,0,0.18);align-items:center;justify-content:center;
        }
        .modal-content {
            background:#fff; border-radius:16px; box-shadow:0 2px 16px #23409333;
            padding:32px 18px; margin:50px auto; max-width:95vw; min-width:70vw; position:relative; text-align:center;
        }
        .modal-content button.close-btn {
            position:absolute; left:10px; top:10px; border:none; background:#d32f2f; color:#fff; border-radius:50%; font-size:1.4em;width:38px;height:38px;cursor:pointer;
        }
        .modal-actions {
            margin: 16px 0 0 0;
            display:flex;
            justify-content:center;
            gap:10px;
        }
        .stats-title {color:#134093;font-size:1.18em;text-align:center;margin-bottom:15px;}
        .stats-table {width:100%;border-collapse:collapse;margin-bottom:0;font-size:1.04em;}
        .stats-table th, .stats-table td {border:1px solid #234093;padding:10px 6px;text-align:center;}
        .stats-table th {background:#234093;color:#fff;}
        .stats-table tr:nth-child(even) {background:#f3f5fa;}
        .footer {text-align:center;margin-top:22px;color:#234085;font-size:0.85em;}
        .red-total {
            color: #d32f2f !important;
            font-weight: bold !important;
            background: #fffbe9;
        }
        .pdf-title-arabic {
            font-size: 1.18em;
            text-align: center;
            color: #234085;
            font-weight: bold;
            margin-bottom: 10px;
            width: 100%;
            margin-top: 0;
        }
        .edit-btn, .delete-btn {
            background: #6c757d; color: #fff; border: none; border-radius: 5px; padding: 6px 12px; margin: 2px; cursor: pointer; font-size: 0.95em;
        }
        .edit-btn:hover { background: #495057; }
        .delete-btn { background: #d32f2f; }
        .delete-btn:hover { background: #b71c1c; }
        .dev-section {background:#e9ecef;border-radius:8px;padding:16px 11px;margin:14px 0 14px 0;}
        .dev-section .close-btn {background:#d32f2f;color:#fff;border:none;border-radius:5px;padding:0 13px;font-size:1.1em;cursor:pointer;float:left;}
        #devPasswordForm {margin-bottom:6px;}
        @media (max-width:600px) {
            .main-container {
                padding:10px 2vw 7px 2vw;
                margin: 20px auto 0 auto;
                border-radius: 12px;
                max-width: 100%;
                min-width: unset;
            }
            .main-title-box {
                font-size:1.2em;
                padding:18px 8px;
                margin-bottom: 16px;
            }
            .login-section, .inspector-select-section {
                flex-direction: column;
                gap: 8px;
                margin: 15px 0;
            }
            .login-section label, .inspector-select-section label {
                font-size: 0.95em;
                margin-bottom: 4px;
            }
            select, input[type="text"], input[type="date"], input[type="password"] {
                padding: 8px 12px;
                font-size: 0.95em;
                min-width: 200px;
                max-width: 280px;
                width: 100%;
                box-sizing: border-box;
            }
            .actions-row {
                margin: 15px 0;
            }
            .actions-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                width: 100%;
            }
            .action-group {
                min-width: unset;
                width: 100%;
                max-width: none;
                padding: 14px 10px;
            }
            .action-group-title {
                font-size: 0.9em;
            }
            .action-group button {
                min-width: 120px;
                padding: 10px 14px;
                font-size: 0.85em;
            }
            .plan-table th, .plan-table td {
                padding:6px 4px;
                font-size:0.85em;
            }
            .dropdown-shops-btn {
                padding:6px 10px;
                font-size:0.85em;
                min-width: 80px;
            }
            .modal-content {
                padding:15px 3vw;
                min-width:unset;
                max-width:95vw;
                margin: 20px auto;
            }
            .stats-table th, .stats-table td {
                padding:6px 3px;
                font-size: 0.85em;
            }
            .edit-btn, .delete-btn {
                padding: 4px 8px;
                margin: 1px;
                font-size: 0.8em;
            }
            .bell-3d {
                width: 42px;
                height: 42px;
            }
            .bell-body {
                width: 35px;
                height: 30px;
            }
            .last-update-row {
                font-size: 0.85em;
                margin-right: 4px;
            }
            .search-filters-grid {
                grid-template-columns:1fr;
                gap:10px;
            }
            .footer {
                font-size: 0.8em;
                margin-top: 16px;
            }
        }
        @media (max-width:400px) {
            .main-container {
                padding: 8px 1vw 5px 1vw;
                margin: 10px auto 0 auto;
                border-radius: 8px;
            }
            .main-title-box {
                font-size: 1.1em;
                padding: 14px 6px;
                margin-bottom: 12px;
            }
            .bell-3d {
                width: 38px;
                height: 38px;
            }
            .bell-body {
                width: 32px;
                height: 28px;
            }
            .bell-bubble {
                width: 95%;
                padding: 20px 15px;
                border-radius: 15px;
            }
            .bell-action-btn {
                padding: 10px 20px;
                font-size: 0.9em;
                min-width: 90px;
            }
            .login-section, .inspector-select-section {
                margin: 10px 0;
            }
            select, input[type="text"], input[type="date"], input[type="password"] {
                padding: 6px 10px;
                font-size: 0.9em;
                min-width: 180px;
                max-width: 100%;
            }
            .actions-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .action-group {
                max-width: 320px;
                margin: 0 auto;
            }
            .action-group button {
                padding: 8px 12px;
                font-size: 0.8em;
                min-width: 110px;
            }
            .plan-table th, .plan-table td {
                padding: 4px 2px;
                font-size: 0.8em;
            }
            .dropdown-shops-btn {
                padding: 4px 8px;
                font-size: 0.8em;
            }
            .modal-content {
                padding: 12px 2vw;
                max-width: 98vw;
            }
            .edit-btn, .delete-btn {
                padding: 3px 6px;
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
<div class="main-container">
    <div class="header-top-bar">
        <div class="bell-container">
            <button class="bell-btn" id="bellBtn" title="الجرس - اضغط للكتابة">
                🔔
            </button>
        </div>
        <div class="last-update-row" id="lastUpdateRow"></div>
    </div>
    <!-- Click sound will be generated using Web Audio API -->
    </div>
    <hr class="horizontal-line">
    <div class="title-bar">
        <div class="main-title-box">خطة التفتيش الشهرية</div>
    </div>
    <div class="login-section">
        <label for="loginRole">تسجيل الدخول:</label>
        <select id="loginRole">
            <option value="">-- اختر --</option>
            <option value="inspector">مفتش</option>
            <option value="developer">المطور</option>
        </select>
        <input type="password" id="devPassword" placeholder="كلمة سر المطور" style="display:none;">
        <button id="devLoginBtn" style="display:none;background:#198754;color:#fff;border:none;padding:7px 20px;border-radius:6px;font-size:1em;cursor:pointer;">دخول المطور</button>
        <button id="devLogoutBtn" style="display:none;background:#d32f2f;color:#fff;border:none;padding:7px 20px;border-radius:6px;font-size:1em;cursor:pointer;">إغلاق المطور</button>
        <span id="devError" style="color:#d32f2f;margin-right:10px;"></span>
        <div id="refreshStatus" style="color:#28a745;font-size:0.9em;margin-top:5px;display:none;">🔄 جاري تحديث البيانات...</div>
    </div>
    <div class="inspector-select-section">
        <label for="inspectorSelect">اختر المفتش :</label>
        <select id="inspectorSelect">
            <option value="">-- اختر المفتش --</option>
        </select>
        <button id="searchToggleBtn" style="background:#234085;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;margin-right:10px;font-size:0.9em;" title="البحث">
            🔍 البحث
        </button>
    </div>
    
    <!-- قسم البحث -->
    <div id="searchFiltersSection" class="search-filters-section" style="background:#f8f9fa;padding:15px;border-radius:8px;margin:15px 0;border:1px solid #dee2e6;display:none;">
        <h3 style="margin:0 0 15px 0;color:#234085;text-align:center;">🔍 البحث</h3>
        <div class="search-filters-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;align-items:end;">
            <div>
                <label for="searchFromDate" style="display:block;margin-bottom:5px;font-weight:bold;">من تاريخ:</label>
                <input type="date" id="searchFromDate" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
            </div>
            <div>
                <label for="searchToDate" style="display:block;margin-bottom:5px;font-weight:bold;">إلى تاريخ:</label>
                <input type="date" id="searchToDate" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
            </div>
            <div>
                <label for="searchArea" style="display:block;margin-bottom:5px;font-weight:bold;">المنطقة:</label>
                <select id="searchArea" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                    <option value="">-- جميع المناطق --</option>
                </select>
            </div>
            <div>
                <label for="searchShift" style="display:block;margin-bottom:5px;font-weight:bold;">وقت المناوبة:</label>
                <select id="searchShift" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                    <option value="">-- جميع المناوبات --</option>
                    <option value="صباحية">صباحية</option>
                    <option value="مسائية">مسائية</option>
                </select>
            </div>
            <div style="display:flex;gap:10px;">
                <button id="applySearchBtn" style="background:#28a745;color:#fff;border:none;padding:10px 15px;border-radius:4px;cursor:pointer;font-weight:bold;">تطبيق البحث</button>
                <button id="clearSearchBtn" style="background:#6c757d;color:#fff;border:none;padding:10px 15px;border-radius:4px;cursor:pointer;">مسح البحث</button>
            </div>
        </div>
        <div id="searchResultsInfo" style="margin-top:10px;padding:8px;background:#e9ecef;border-radius:4px;display:none;">
            <strong>نتائج البحث:</strong> <span id="searchResultsCount">0</span> تفتيش
        </div>
    </div>
    <!-- قسم المطور: إضافة/تعديل خطة -->
    <div id="devSection" class="dev-section" style="display:none;">
        <!-- إدارة البيانات الأساسية -->
        <div id="dataManagementSection" style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6;">
            <h3 style="margin:0 0 15px 0;color:#234085;text-align:center;">إدارة البيانات الأساسية</h3>
            <div style="display:flex;gap:15px;justify-content:center;flex-wrap:wrap;">
                <button id="manageInspectorsBtn" class="management-btn" style="background:#17a2b8;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">إدارة المفتشين</button>
                <button id="manageAreasBtn" class="management-btn" style="background:#fd7e14;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">إدارة المناطق</button>
                <button id="manageShopsBtn" class="management-btn" style="background:#20c997;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">إدارة المحلات</button>
            </div>
            <div style="margin-top:15px;padding-top:15px;border-top:1px solid #dee2e6;text-align:center;">
                <button id="exportDataBtn" onclick="saveToExternalFile()" style="background:#dc3545;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:bold;">تصدير البيانات إلى ملف JSON</button>
                <p style="margin:8px 0 0 0;font-size:0.9em;color:#666;">احفظ التغييرات في ملف plan-data.json جديد</p>
            </div>
        </div>

        <form id="addEditForm" style="width:100%;max-width:700px;display:flex;flex-wrap:wrap;gap:12px 20px;align-items:center;justify-content:center;margin-bottom:12px;">
            <!-- مفتش مع إمكانية الإضافة -->
            <div style="position:relative;">
                <select id="formInspector" required style="min-width:150px;">
                    <option value="">اختر مفتش</option>
                </select>
                <input type="text" id="newInspectorInput" placeholder="أو أدخل اسم مفتش جديد" style="display:none;min-width:150px;">
                <button type="button" id="toggleInspectorInput" style="position:absolute;left:-30px;top:0;background:#007bff;color:#fff;border:none;padding:7px 8px;border-radius:4px;cursor:pointer;font-size:0.8em;">+</button>
            </div>
            
            <input type="date" id="formDay" required>
            
            <select id="formShift" required>
                <option value="">وقت المناوبة</option>
                <option value="صباحية">صباحية</option>
                <option value="مسائية">مسائية</option>
            </select>
            
            <!-- منطقة مع إمكانية الإضافة -->
            <div style="position:relative;">
                <select id="formArea" required style="min-width:150px;">
                    <option value="">اختر منطقة</option>
                </select>
                <input type="text" id="newAreaInput" placeholder="أو أدخل منطقة جديدة" style="display:none;min-width:150px;">
                <button type="button" id="toggleAreaInput" style="position:absolute;left:-30px;top:0;background:#007bff;color:#fff;border:none;padding:7px 8px;border-radius:4px;cursor:pointer;font-size:0.8em;">+</button>
            </div>
            
            <!-- محلات مع اختيار متعدد -->
            <div style="position:relative;min-width:200px;">
                <select id="formShops" multiple style="min-height:60px;min-width:200px;" required>
                    <option value="">اختر المحلات</option>
                </select>
                <button type="button" id="addNewShop" style="position:absolute;left:-30px;top:0;background:#007bff;color:#fff;border:none;padding:7px 8px;border-radius:4px;cursor:pointer;font-size:0.8em;">+</button>
                <small style="display:block;margin-top:4px;color:#666;font-size:0.85em;">اضغط Ctrl للاختيار المتعدد</small>
            </div>
            
            <button type="submit" style="background:#198754;color:#fff;border:none;padding:8px 22px;border-radius:7px;font-size:1em;cursor:pointer;">إضافة / تعديل</button>
            <input type="hidden" id="formEditingIndex" value="">
        </form>
    </div>
    <div id="planTableContainer" class="plan-table-container"></div>
    <div class="actions-row">
        <div class="actions-grid">
            <!-- Data Management Group -->
            <div class="action-group">
                <div class="action-group-title">📊 إدارة البيانات</div>
                <button class="refresh-btn" onclick="loadInspectionData()">
                    🔄 تحديث البيانات
                </button>
            </div>
            
            <!-- Reports Group -->
            <div class="action-group">
                <div class="action-group-title">📋 التقارير</div>
                <button class="inspector-report-btn" onclick="showInspectorReport()">
                    👤 تقرير المفتش
                </button>
                <button class="monthly-report-btn" onclick="showMonthlyReport()">
                    📅 التقرير الشهري
                </button>
                <button class="enhanced-report-btn" onclick="showEnhancedReportsModal()">
                    📈 التقارير المتقدمة
                </button>
            </div>
            
            <!-- Export & Print Group -->
            <div class="action-group">
                <div class="action-group-title">💾 حفظ و طباعة</div>
                <button class="pdf-btn" onclick="exportTableToPDF()">
                    📄 حفظ كـ PDF
                </button>
                <button class="excel-btn" onclick="exportTableToExcel()">
                    📊 حفظ كـ Excel
                </button>
                <button class="print-btn" onclick="printTable()">
                    🖨️ طباعة
                </button>
            </div>
        </div>
    </div>
    <div id="inspectorReportDiv" class="inspector-report-div" style="display:none;"></div>
    <div id="monthlyReportModal" class="modal-overlay">
      <div class="modal-content">
        <button class="close-btn" onclick="closeMonthlyReportModal()">×</button>
        <div class="stats-title">التقرير الشهري</div>
        <div class="modal-actions">
            <button class="pdf-btn" onclick="exportMonthlyReportToPDF()">حفظ التقرير كـ PDF</button>
            <button class="excel-btn" onclick="exportMonthlyReportToExcel()">حفظ التقرير كـ Excel</button>
        </div>
        <div id="monthlyReportContent"></div>
      </div>
    </div>

    <!-- مودال التقارير المتقدمة -->
    <div id="enhancedReportsModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <button class="close-btn" onclick="closeEnhancedReportsModal()">×</button>
        <div class="stats-title">التقارير المتقدمة</div>
        
        <!-- خيارات التقرير -->
        <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
            <h4 style="margin:0 0 15px 0;color:#234085;">نوع التقرير:</h4>
            <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;">
                <label style="display:flex;align-items:center;gap:5px;">
                    <input type="radio" name="reportType" value="inspector-monthly" checked>
                    تقرير شهري لمفتش محدد
                </label>
                <label style="display:flex;align-items:center;gap:5px;">
                    <input type="radio" name="reportType" value="inspector-yearly">
                    تقرير سنوي لمفتش محدد
                </label>
                <label style="display:flex;align-items:center;gap:5px;">
                    <input type="radio" name="reportType" value="all-monthly">
                    تقرير شهري لجميع المفتشين
                </label>
                <label style="display:flex;align-items:center;gap:5px;">
                    <input type="radio" name="reportType" value="all-yearly">
                    تقرير سنوي لجميع المفتشين
                </label>
                <label style="display:flex;align-items:center;gap:5px;">
                    <input type="radio" name="reportType" value="shop-analytics">
                    📊 تحليلات المحلات الذكية
                </label>
            </div>
        </div>
        
        <!-- خيارات التاريخ والمفتش -->
        <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">المفتش:</label>
                    <select id="reportInspectorSelect" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                        <option value="">-- جميع المفتشين --</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">السنة:</label>
                    <select id="reportYear" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">الشهر:</label>
                    <select id="reportMonth" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                        <option value="">-- جميع الشهور --</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- أزرار التوليد والحفظ -->
        <div style="margin-bottom:15px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
            <button onclick="generateEnhancedReport()" style="background:#28a745;color:#fff;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;font-weight:bold;">توليد التقرير</button>
            <button onclick="exportEnhancedReportToPDF()" style="background:#dc3545;color:#fff;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;">حفظ كـ PDF</button>
            <button onclick="exportEnhancedReportToExcel()" style="background:#28a745;color:#fff;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;">حفظ كـ Excel</button>
        </div>
        
        <!-- محتوى التقرير -->
        <div id="enhancedReportContent" style="max-height:400px;overflow-y:auto;"></div>
      </div>
    </div>

    <!-- مودال إدارة المفتشين -->
    <div id="inspectorsModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <button class="close-btn" onclick="closeInspectorsModal()">×</button>
        <div class="stats-title">إدارة المفتشين</div>
        <div style="margin-bottom:15px;">
            <input type="text" id="newInspectorName" placeholder="اسم المفتش الجديد" style="padding:8px;border:1px solid #ccc;border-radius:4px;margin-left:10px;">
            <button onclick="addNewInspector()" style="background:#28a745;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">إضافة مفتش</button>
        </div>
        <div id="inspectorsList" style="max-height:300px;overflow-y:auto;"></div>
      </div>
    </div>

    <!-- مودال إدارة المناطق -->
    <div id="areasModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <button class="close-btn" onclick="closeAreasModal()">×</button>
        <div class="stats-title">إدارة المناطق</div>
        <div style="margin-bottom:15px;">
            <input type="text" id="newAreaName" placeholder="اسم المنطقة الجديدة" style="padding:8px;border:1px solid #ccc;border-radius:4px;margin-left:10px;">
            <button onclick="addNewArea()" style="background:#28a745;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">إضافة منطقة</button>
        </div>
        <div id="areasList" style="max-height:300px;overflow-y:auto;"></div>
      </div>
    </div>

    <!-- مودال إدارة المحلات -->
    <div id="shopsModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <button class="close-btn" onclick="closeShopsModal()">×</button>
        <div class="stats-title">إدارة المحلات</div>
        <div style="margin-bottom:15px;">
            <input type="text" id="newShopName" placeholder="اسم المحل الجديد" style="padding:8px;border:1px solid #ccc;border-radius:4px;margin-left:10px;">
            <select id="newShopArea" style="padding:8px;border:1px solid #ccc;border-radius:4px;margin-left:10px;">
                <option value="">اختر المنطقة</option>
            </select>
            <button onclick="addNewShop()" style="background:#28a745;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">إضافة محل</button>
        </div>
        <div id="shopsList" style="max-height:300px;overflow-y:auto;"></div>
      </div>
    </div>
    <div class="footer">
        تم التطوير بواسطة &copy; المطور د. علي عبدالعال
    </div>
</div>

<!-- Bell Notes Modal -->
<div class="bell-modal" id="bellModal">
    <div class="bell-bubble">
        <h3>توجيهات وإشعارات</h3>
        <div class="bell-info" id="bellInfo">
            <div id="bellInfoText" style="cursor: pointer;">توجيهات وإشعارات للمفتشين - يتم حفظها مركزياً لجميع المفتشين</div>
            <input type="text" id="bellInfoEdit" style="display: none; width: 100%; border: none; background: transparent; font: inherit; color: inherit; text-align: center;" value="توجيهات وإشعارات للمفتشين - يتم حفظها مركزياً لجميع المفتشين">
        </div>
        <textarea 
            class="bell-notes-textarea" 
            id="bellNotesTextarea" 
            placeholder="اكتب توجيهاتك وإشعاراتك هنا..."
            dir="rtl"
        ></textarea>
        <div class="bell-bubble-actions">
            <button class="bell-action-btn bell-save-btn" id="bellSaveBtn">💾 حفظ</button>
            <button class="bell-action-btn bell-clear-btn" id="bellClearBtn">🗑️ مسح</button>
            <button class="bell-action-btn bell-export-btn" id="bellExportBtn" style="background:#dc3545;display:none;">📤 حفظ نهائي</button>
            <button class="bell-action-btn bell-close-btn" id="bellCloseBtn">✖️ إغلاق</button>
        </div>
    </div>
</div>

<script>
// بيانات المفتشين من ملف البيانات
let inspectorsData = [
    {id:"insp_1758813880098", name:"د. علي عبدالعال"},
    {id:"insp_1758830925093", name:"د. محمد إسماعيل"},
    {id:"insp_1758830939296", name:"د. محمد سعيد"},
    {id:"insp_1758830950586", name:"د. فايز المسالمة"},
    {id:"insp_1758830963007", name:"د. آيه سلامة"},
    {id:"insp_1758830974747", name:"د. آمنه بن صرم"},
    {id:"insp_1758830985608", name:"د. حصة العلي"},
    {id:"insp_1758830999876", name:"د. حسينة العامري"},
    {id:"insp_1758831014928", name:"د. هاجر الغافري"}
];
let inspectors = inspectorsData.map(i=>i.name);

// بيانات المناطق والمحلات
let areasData = [
    {id:"musaffah", name:"المصفح"},
    {id:"khalifa", name:"مدينة خليفة"},
    {id:"area_a", name:"المنطقة أ"},
    {id:"area_c", name:"المنطقة ج"}
];

let shopsData = [
    {id:"shop1", name:"محل 1", areaId:"musaffah"},
    {id:"shop2", name:"محل 2", areaId:"musaffah"},
    {id:"shop3", name:"محل 3", areaId:"khalifa"},
    {id:"shop4", name:"محل 4", areaId:"khalifa"},
    {id:"shop5", name:"محل 5", areaId:"musaffah"},
    {id:"shop7", name:"محل 7", areaId:"musaffah"},
    {id:"shop8", name:"محل 8", areaId:"area_a"},
    {id:"shop9", name:"محل 9", areaId:"area_a"},
    {id:"shop11", name:"محل 11", areaId:"area_c"}
];

let isDev = false;
let selectedInspector = "";
const DEV_PASSWORD = "1983";
// بيانات افتراضية
let defaultInspectionData = [
    { inspector: "هاجر", day: "2025-09-22", shift: "صباحية", area: "المصفح", shops: ["محل 1", "محل 2"] },
    { inspector: "هاجر", day: "2025-09-28", shift: "مسائية", area: "المصفح", shops: ["محل 5"] },
    { inspector: "آمنه", day: "2025-09-25", shift: "مسائية", area: "مدينة خليفة", shops: ["محل 3", "محل 4"] },
    { inspector: "آيه", day: "2025-09-22", shift: "صباحية", area: "المصفح", shops: ["محل 7"] },
    { inspector: "د. فايز المسالمة", day: "2025-09-21", shift: "صباحية", area: "المنطقة أ", shops: ["محل 8", "محل 9"] },
    { inspector: "د.آمنه بن صرم", day: "2025-09-21", shift: "مسائية", area: "المنطقة ج", shops: ["محل 11"] },
];
let inspectionData = defaultInspectionData.slice();
let bellNotesData = { infoText: "توجيهات وإشعارات للمفتشين - يتم حفظها مركزياً لجميع المفتشين", notes: "" };
let lastUpdateTime = null;

// Auto-refresh functionality
function startAutoRefresh() {
    setInterval(async () => {
        try {
            const response = await fetch('./plan-data.json?t=' + Date.now());
            if (response.ok) {
                const data = await response.json();
                if (data.lastUpdate && data.lastUpdate !== lastUpdateTime) {
                    await loadInspectionData();
                    showUpdateMessage('تم تحديث البيانات تلقائياً');
                }
            }
        } catch (error) {
            console.log('Auto-refresh check failed:', error);
        }
    }, 30000); // Check every 30 seconds
}

// Daily auto-refresh functionality at midnight
function startDailyRefresh() {
    let lastCheckedDay = new Date().getDate(); // Keep track of the current day
    
    // Check every 30 seconds for day change (including midnight transition)
    setInterval(() => {
        const now = new Date();
        const currentDay = now.getDate();
        
        // Check if the day has changed (this handles midnight transition)
        if (currentDay !== lastCheckedDay) {
            console.log('Day change detected - refreshing daily inspections');
            console.log('Previous day:', lastCheckedDay, 'Current day:', currentDay);
            
            lastCheckedDay = currentDay;
            
            // Clear any active search filters to show today's inspections
            if (Object.keys(currentSearchFilters).length > 0) {
                clearSearchFilters();
            } else {
                // Just refresh the table to show new day's inspections
                renderPlanTable();
            }
            
            const todayStr = now.toLocaleDateString('ar-EG');
            showUpdateMessage(`تم تحديث التفتيشات اليومية - عرض تفتيشات ${todayStr}`);
        }
        
        // Also check specifically for midnight for immediate response
        if (now.getHours() === 0 && now.getMinutes() === 0 && now.getSeconds() < 30) {
            console.log('Midnight detected - ensuring daily inspections are current');
            
            // Clear any active search filters to show today's inspections
            if (Object.keys(currentSearchFilters).length > 0) {
                clearSearchFilters();
            } else {
                // Just refresh the table to show new day's inspections
                renderPlanTable();
            }
            
            const todayStr = now.toLocaleDateString('ar-EG');
            showUpdateMessage(`🌙 منتصف الليل - تم تحديث التفتيشات لليوم الجديد ${todayStr}`);
        }
    }, 30000); // Check every 30 seconds (same as auto-refresh)
}

// Load data from JSON file
async function loadInspectionData() {
    const statusDiv = document.getElementById('refreshStatus');
    try {
        if (statusDiv) {
            statusDiv.style.display = 'block';
        }
        
        const response = await fetch('./plan-data.json?t=' + Date.now());
        if (response.ok) {
            const data = await response.json();
            if (data.inspectionData && Array.isArray(data.inspectionData)) {
                inspectionData = data.inspectionData;
                lastUpdateTime = data.lastUpdate;
                if (data.inspectors && Array.isArray(data.inspectors)) {
                    inspectorsData = data.inspectors;
                    inspectors = inspectorsData.map(i=>i.name);
                }
                if (data.areas && Array.isArray(data.areas)) {
                    areasData = data.areas;
                }
                if (data.shops && Array.isArray(data.shops)) {
                    shopsData = data.shops;
                }
                // Load bell notes data if available
                if (data.bellNotes) {
                    bellNotesData = data.bellNotes;
                }
                // Display last update date/time for all users
                displayLastUpdateFromData(data.lastUpdate);
                renderPlanTable();
                fillInspectorsDropdowns();
                fillAreasDropdowns();
                fillShopsDropdowns();
            }
        } else {
            console.warn('Failed to fetch plan data - response not ok:', response.status);
        }
    } catch (error) {
        console.warn('Failed to load plan data, using fallback data:', error);
        // First try to load complete data from localStorage
        const allLocalData = localStorage.getItem('allPlanData');
        if (allLocalData) {
            try {
                const allData = JSON.parse(allLocalData);
                if (allData.inspectionData) inspectionData = allData.inspectionData;
                if (allData.inspectors) {
                    inspectorsData = allData.inspectors;
                    inspectors = inspectorsData.map(i => i.name);
                }
                if (allData.areas) areasData = allData.areas;
                if (allData.shops) shopsData = allData.shops;
                if (allData.bellNotes) bellNotesData = allData.bellNotes;
                // Display last update from localStorage backup
                displayLastUpdateFromData(allData.lastUpdate);
                console.log('Loaded complete data from localStorage backup');
            } catch (parseError) {
                console.warn('Failed to parse localStorage data, using individual fallback');
                // Fall back to individual localStorage items
                const localInspectionData = localStorage.getItem('inspectionData');
                if (localInspectionData) {
                    inspectionData = JSON.parse(localInspectionData);
                }
                // No lastUpdate available in individual fallback
                displayLastUpdateFromData(null);
            }
        } else {
            // Fall back to individual localStorage item
            const localInspectionData = localStorage.getItem('inspectionData');
            if (localInspectionData) {
                inspectionData = JSON.parse(localInspectionData);
            }
            // No lastUpdate available in individual fallback
            displayLastUpdateFromData(null);
        }
    } finally {
        // Always ensure dropdowns are populated and table is rendered
        fillInspectorsDropdowns();
        fillAreasDropdowns();
        fillShopsDropdowns();
        renderPlanTable();
        if (statusDiv) {
            setTimeout(() => statusDiv.style.display = 'none', 1000);
        }
    }
}

// تحميل البيانات من plan-data.json
async function loadPlanData() {
    try {
        const response = await fetch('./plan-data.json');
        if (response.ok) {
            const planData = await response.json();
            if (Array.isArray(planData) && planData.length > 0) {
                inspectionData = planData;
                saveInspectionData();
                renderPlanTable();
                console.log('تم تحميل بيانات الخطة من plan-data.json بنجاح');
                return true;
            }
        }
    } catch (error) {
        console.warn('تعذر تحميل plan-data.json، سيتم استخدام البيانات الافتراضية:', error);
    }
    return false;
}

function saveInspectionData() {
    // Save to localStorage as backup
    localStorage.setItem('inspectionData', JSON.stringify(inspectionData));
    setLastUpdateDate();
    
    // Note: File export is now manual only via the "تصدير البيانات إلى ملف JSON" button
    // This prevents excessive downloads on every developer action
}

// Function to save data to external JSON file (for developer mode)
async function saveToExternalFile() {
    try {
        const planData = {
            inspectionData: inspectionData,
            inspectors: inspectorsData,
            areas: areasData,
            shops: shopsData,
            bellNotes: bellNotesData,
            lastUpdate: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(planData, null, 2);
        
        // Method 1: Direct file write (works in local file:// protocol)
        try {
            const response = await fetch('./plan-data.json', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: dataStr
            });
            
            if (response.ok) {
                showUpdateMessage('✅ تم حفظ البيانات في plan-data.json بنجاح!');
                console.log('✅ Data saved directly to plan-data.json:', planData);
                return;
            }
        } catch (fetchError) {
            console.log('Direct file write not available (expected in browser):', fetchError.message);
        }
        
        // Method 2: Use File System Access API (Chrome/Edge)
        if ('showSaveFilePicker' in window) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: 'plan-data.json',
                    types: [{
                        description: 'JSON files',
                        accept: {'application/json': ['.json']},
                    }],
                });
                const writable = await fileHandle.createWritable();
                await writable.write(dataStr);
                await writable.close();
                showUpdateMessage('✅ تم حفظ ملف plan-data.json بنجاح!');
                console.log('✅ Data saved using File System Access API:', planData);
                return;
            } catch (err) {
                if (err.name === 'AbortError') {
                    // User cancelled the file picker - don't proceed with automatic download
                    showUpdateMessage('تم إلغاء عملية الحفظ');
                    console.log('File save cancelled by user');
                    return;
                } else {
                    console.log('File System Access API error:', err);
                    // Continue to Method 3 only if there was a real error (not user cancellation)
                }
            }
        }
        
        // Method 3: Automatic download + helper script (only as last resort)
        // Download the updated plan-data.json file
        const jsonBlob = new Blob([dataStr], {type: 'application/json'});
        const jsonUrl = URL.createObjectURL(jsonBlob);
        
        const jsonLink = document.createElement('a');
        jsonLink.href = jsonUrl;
        jsonLink.download = 'plan-data.json';
        jsonLink.style.display = 'none';
        document.body.appendChild(jsonLink);
        jsonLink.click();
        document.body.removeChild(jsonLink);
        URL.revokeObjectURL(jsonUrl);
        
        // Store the data for potential script access
        localStorage.setItem('latestPlanData', dataStr);
        localStorage.setItem('latestPlanDataTimestamp', new Date().toISOString());
        
        // Create and show detailed instructions only for automatic download
        const instructions = `
📋 تعليمات حفظ البيانات:

الطريقة الأولى (الأسهل):
1. تم تنزيل ملف plan-data.json جديد
2. انسخ الملف المنزل إلى مجلد المشروع (استبدل الملف الموجود)

الطريقة الثانية (استخدام سكريبت Python):
1. افتح سطر الأوامر في مجلد المشروع
2. شغل الأمر: python save_from_browser.py
3. الصق البيانات JSON عندما يطلب منك

الطريقة الثالثة (يدوياً):
1. انسخ البيانات من وحدة التحكم (console)
2. افتح plan-data.json في محرر النصوص
3. استبدل المحتوى والصق البيانات الجديدة
        `;
        
        console.log('📋 تعليمات الحفظ:', instructions);
        console.log('📊 البيانات الجديدة:', dataStr);
        
        showUpdateMessage(`✅ تم تصدير plan-data.json - راجع وحدة التحكم (F12) للتعليمات التفصيلية`);
        
        // Show instructions only if user wants them
        setTimeout(() => {
            if (confirm('تم تصدير البيانات بنجاح!\n\nهل تريد عرض التعليمات التفصيلية؟')) {
                alert(instructions.trim());
            }
        }, 100);
        
    } catch (error) {
        console.error('❌ Failed to save to external file:', error);
        showUpdateMessage('❌ خطأ في التصدير - تم الحفظ محلياً فقط');
    }
}

function showUpdateMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = 'position:fixed;top:20px;right:20px;background:#28a745;color:white;padding:10px 15px;border-radius:5px;z-index:1000;';
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    setTimeout(() => document.body.removeChild(messageDiv), 3000);
}
function setLastUpdateDate() {
    // Only update the date/time dynamically if user is a developer making changes
    if (!isDev && !window.isDev) return;
    
    let row = document.getElementById('lastUpdateRow');
    let today = new Date();
    let year = today.getFullYear();
    let month = String(today.getMonth()+1).padStart(2,'0');
    let day = String(today.getDate()).padStart(2,'0');
    let hours = today.getHours();
    let minutes = String(today.getMinutes()).padStart(2,'0');
    let period = hours >= 12 ? 'مساءً' : 'صباحًا';
    let hour12 = hours % 12;
    if(hour12 === 0) hour12 = 12;
    let timeStr = hour12 + ':' + minutes + ' ' + period;
    let dateStr = year+'-'+month+'-'+day;
    row.textContent = "آخر تحديث للخطة: " + dateStr + "    " + timeStr;
}

function displayLastUpdateFromData(lastUpdateISO) {
    // Display the last update date/time from loaded data - visible to all users
    let row = document.getElementById('lastUpdateRow');
    
    if (!lastUpdateISO) {
        row.textContent = "آخر تحديث للخطة: غير متاح";
        return;
    }
    
    try {
        let updateDate = new Date(lastUpdateISO);
        let year = updateDate.getFullYear();
        let month = String(updateDate.getMonth()+1).padStart(2,'0');
        let day = String(updateDate.getDate()).padStart(2,'0');
        let hours = updateDate.getHours();
        let minutes = String(updateDate.getMinutes()).padStart(2,'0');
        let period = hours >= 12 ? 'مساءً' : 'صباحًا';
        let hour12 = hours % 12;
        if(hour12 === 0) hour12 = 12;
        let timeStr = hour12 + ':' + minutes + ' ' + period;
        let dateStr = year+'-'+month+'-'+day;
        row.textContent = "آخر تحديث للخطة: " + dateStr + "    " + timeStr;
    } catch (error) {
        console.warn('Error parsing last update date:', error);
        row.textContent = "آخر تحديث للخطة: غير متاح";
    }
}

function initializeLastUpdateDate() {
    // Initialize the last update display on page load with a loading message
    let row = document.getElementById('lastUpdateRow');
    row.textContent = "آخر تحديث للخطة: جاري التحميل...";
}
function fillInspectorsDropdowns() {
    // مفتشين لأداة الاختيار
    const selectInspect = document.getElementById('inspectorSelect');
    selectInspect.innerHTML = '<option value="">-- اختر المفتش --</option>';
    inspectorsData.forEach(inspector => {
        selectInspect.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
    });
    // مفتشين في نموذج المطور
    const select2 = document.getElementById('formInspector');
    if (select2) {
        select2.innerHTML = `<option value="">اختر مفتش</option>`;
        inspectorsData.forEach(inspector => {
            select2.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
        });
    }
}
function fillAreasDropdowns() {
    // منطقة في نموذج المطور
    const areaSelect = document.getElementById('formArea');
    if (areaSelect) {
        areaSelect.innerHTML = '<option value="">اختر منطقة</option>';
        areasData.forEach(area => {
            areaSelect.innerHTML += `<option value="${area.name}">${area.name}</option>`;
        });
    }
    
    // منطقة في مودال إضافة محل جديد
    const newShopAreaSelect = document.getElementById('newShopArea');
    if (newShopAreaSelect) {
        newShopAreaSelect.innerHTML = '<option value="">اختر المنطقة</option>';
        areasData.forEach(area => {
            newShopAreaSelect.innerHTML += `<option value="${area.id}">${area.name}</option>`;
        });
    }
    
    // منطقة في مربع البحث
    const searchAreaSelect = document.getElementById('searchArea');
    if (searchAreaSelect) {
        searchAreaSelect.innerHTML = '<option value="">-- جميع المناطق --</option>';
        areasData.forEach(area => {
            searchAreaSelect.innerHTML += `<option value="${area.name}">${area.name}</option>`;
        });
    }
}

function fillShopsDropdowns(selectedAreaId = null) {
    const shopsSelect = document.getElementById('formShops');
    if (shopsSelect) {
        shopsSelect.innerHTML = '';
        
        // Get the selected area name if not provided
        let selectedAreaName = null;
        if (!selectedAreaId) {
            const areaSelect = document.getElementById('formArea');
            selectedAreaName = areaSelect ? areaSelect.value : null;
        } else {
            const selectedArea = areasData.find(a => a.id === selectedAreaId);
            selectedAreaName = selectedArea ? selectedArea.name : null;
        }
        
        if (selectedAreaName) {
            // First, add shops from the selected area
            const selectedAreaShops = shopsData.filter(shop => {
                const area = areasData.find(a => a.id === shop.areaId);
                return area && area.name === selectedAreaName;
            });
            
            // Add selected area shops with a special label
            if (selectedAreaShops.length > 0) {
                const selectedAreaGroup = document.createElement('optgroup');
                selectedAreaGroup.label = `محلات ${selectedAreaName} (المنطقة المحددة)`;
                selectedAreaShops.forEach(shop => {
                    const option = document.createElement('option');
                    option.value = shop.name;
                    option.textContent = shop.name;
                    selectedAreaGroup.appendChild(option);
                });
                shopsSelect.appendChild(selectedAreaGroup);
            }
            
            // Then, add shops from other areas
            const otherAreaShops = shopsData.filter(shop => {
                const area = areasData.find(a => a.id === shop.areaId);
                return !area || area.name !== selectedAreaName;
            });
            
            if (otherAreaShops.length > 0) {
                const otherAreasGroup = document.createElement('optgroup');
                otherAreasGroup.label = 'محلات من مناطق أخرى (اختياري)';
                otherAreaShops.forEach(shop => {
                    const area = areasData.find(a => a.id === shop.areaId);
                    const areaName = area ? area.name : 'غير محدد';
                    const option = document.createElement('option');
                    option.value = shop.name;
                    option.textContent = `${shop.name} (${areaName})`;
                    otherAreasGroup.appendChild(option);
                });
                shopsSelect.appendChild(otherAreasGroup);
            }
        } else {
            // No area selected - show all shops grouped by area
            const groupedShops = {};
            shopsData.forEach(shop => {
                const area = areasData.find(a => a.id === shop.areaId);
                const areaName = area ? area.name : 'غير محدد';
                if (!groupedShops[areaName]) {
                    groupedShops[areaName] = [];
                }
                groupedShops[areaName].push(shop);
            });
            
            // Add each area group
            Object.keys(groupedShops).sort().forEach(areaName => {
                const areaGroup = document.createElement('optgroup');
                areaGroup.label = areaName;
                groupedShops[areaName].forEach(shop => {
                    const option = document.createElement('option');
                    option.value = shop.name;
                    option.textContent = shop.name;
                    areaGroup.appendChild(option);
                });
                shopsSelect.appendChild(areaGroup);
            });
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    initializeLastUpdateDate();
    // Removed automatic playback - sound only plays on user touch/click interactions
    loadInspectionData(); // Load data from JSON file - will call fillInspectorsDropdowns() when complete
    startAutoRefresh(); // Start auto-refresh functionality
    startDailyRefresh(); // Start daily midnight refresh functionality
    
    // Ensure dropdowns are filled on page load
    fillInspectorsDropdowns();
    fillAreasDropdowns();
    fillShopsDropdowns();
    
    // Add event listeners for toggle buttons and management buttons
    
    // Inspector toggle
    document.getElementById('toggleInspectorInput').addEventListener('click', function() {
        const select = document.getElementById('formInspector');
        const input = document.getElementById('newInspectorInput');
        if (select.style.display === 'none') {
            select.style.display = 'inline-block';
            select.setAttribute('required', 'required'); // Re-enable validation for select
            input.style.display = 'none';
            input.removeAttribute('required'); // Remove validation from input
            this.textContent = '+';
            this.title = 'إضافة مفتش جديد';
        } else {
            select.style.display = 'none';
            select.removeAttribute('required'); // Remove validation from hidden select
            input.style.display = 'inline-block';
            input.setAttribute('required', 'required'); // Enable validation for input
            input.focus();
            this.textContent = '×';
            this.title = 'إلغاء إدخال مفتش جديد';
        }
    });
    
    // Area toggle
    document.getElementById('toggleAreaInput').addEventListener('click', function() {
        const select = document.getElementById('formArea');
        const input = document.getElementById('newAreaInput');
        if (select.style.display === 'none') {
            select.style.display = 'inline-block';
            select.setAttribute('required', 'required'); // Re-enable validation for select
            input.style.display = 'none';
            input.removeAttribute('required'); // Remove validation from input
            this.textContent = '+';
            this.title = 'إضافة منطقة جديدة';
        } else {
            select.style.display = 'none';
            select.removeAttribute('required'); // Remove validation from hidden select
            input.style.display = 'inline-block';
            input.setAttribute('required', 'required'); // Enable validation for input
            input.focus();
            this.textContent = '×';
            this.title = 'إلغاء إدخال منطقة جديدة';
        }
    });
    
    // Area change handler - no longer filters shops, always show all shops for free selection
    document.getElementById('formArea').addEventListener('change', function() {
        // Just refresh the shops dropdown without filtering
        fillShopsDropdowns();
    });
    
    // Management buttons
    document.getElementById('manageInspectorsBtn').addEventListener('click', function() {
        document.getElementById('inspectorsModal').style.display = 'flex';
        displayInspectorsList();
    });
    
    document.getElementById('manageAreasBtn').addEventListener('click', function() {
        document.getElementById('areasModal').style.display = 'flex';
        displayAreasList();
    });
    
    document.getElementById('manageShopsBtn').addEventListener('click', function() {
        document.getElementById('shopsModal').style.display = 'flex';
        displayShopsList();
    });
    
    // Add new shop button  
    document.getElementById('addNewShop').addEventListener('click', function() {
        document.getElementById('shopsModal').style.display = 'flex';
        displayShopsList();
    });
    
    // Search functionality
    document.getElementById('applySearchBtn').addEventListener('click', applySearchFilters);
    document.getElementById('clearSearchBtn').addEventListener('click', clearSearchFilters);
    
    // Search toggle functionality
    document.getElementById('searchToggleBtn').addEventListener('click', function() {
        const searchSection = document.getElementById('searchFiltersSection');
        if (searchSection.style.display === 'none' || searchSection.style.display === '') {
            searchSection.style.display = 'block';
            this.innerHTML = '🔍 إخفاء البحث';
            this.style.background = '#dc3545';
        } else {
            searchSection.style.display = 'none';
            this.innerHTML = '🔍 البحث';
            this.style.background = '#234085';
        }
    });
    
    // Real-time search on input changes
    document.getElementById('searchFromDate').addEventListener('change', applySearchFilters);
    document.getElementById('searchToDate').addEventListener('change', applySearchFilters);
    document.getElementById('searchArea').addEventListener('change', applySearchFilters);
    document.getElementById('searchShift').addEventListener('change', applySearchFilters);
});

// التحكم في تسجيل الدخول وصلاحيات المطور
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById("loginRole").addEventListener("change", function() {
        let role = this.value;
        document.getElementById("devError").innerText = "";
        if(role === "developer") {
            document.getElementById("devPassword").style.display = "inline-block";
            document.getElementById("devLoginBtn").style.display = "inline-block";
            document.getElementById("devLogoutBtn").style.display = "none";
            document.getElementById("devSection").style.display = "none";
            isDev = false;
        } else {
            document.getElementById("devPassword").style.display = "none";
            document.getElementById("devLoginBtn").style.display = "none";
            document.getElementById("devLogoutBtn").style.display = "none";
            document.getElementById("devSection").style.display = "none";
            isDev = false;
            renderPlanTable();
        }
    });
});
document.getElementById("devLoginBtn").onclick = function() {
    let pw = document.getElementById("devPassword").value.trim();
    if (pw === DEV_PASSWORD) {
        isDev = true;
        setLastUpdateDate();
        document.getElementById("devSection").style.display = "block";
        document.getElementById("devLogoutBtn").style.display = "inline-block";
        document.getElementById("devPassword").style.display = "none";
        document.getElementById("devLoginBtn").style.display = "none";
        document.getElementById("devError").innerText = "";
        fillInspectorsDropdowns();
        renderPlanTable();
    } else {
        document.getElementById("devError").innerText = "كلمة السر غير صحيحة!";
    }
}
document.getElementById("devLogoutBtn").onclick = function() {
    isDev = false;
    document.getElementById("devSection").style.display = "none";
    document.getElementById("devLogoutBtn").style.display = "none";
    document.getElementById("devPassword").style.display = "none";
    document.getElementById("devLoginBtn").style.display = "none";
    document.getElementById("loginRole").value = "";
    document.getElementById("devError").innerText = "";
    renderPlanTable();
};

// التغيير على اختيار المفتش
document.getElementById('inspectorSelect').addEventListener('change', function() {
    selectedInspector = this.value;
    renderPlanTable();
    document.getElementById('inspectorReportDiv').style.display = "none";
});

document.getElementById("addEditForm").addEventListener("submit", function(e){
    e.preventDefault();
    if (!isDev) return;
    
    // Get inspector (from dropdown or new input)
    let inspector = document.getElementById("formInspector").value;
    const newInspectorInput = document.getElementById("newInspectorInput");
    if (newInspectorInput.style.display !== 'none' && newInspectorInput.value.trim()) {
        inspector = newInspectorInput.value.trim();
    }
    
    let day = document.getElementById("formDay").value;
    let shift = document.getElementById("formShift").value;
    
    // Get area (from dropdown or new input)
    let area = document.getElementById("formArea").value;
    const newAreaInput = document.getElementById("newAreaInput");
    if (newAreaInput.style.display !== 'none' && newAreaInput.value.trim()) {
        area = newAreaInput.value.trim();
    }
    
    // Get selected shops from multi-select
    const shopsSelect = document.getElementById("formShops");
    let shops = Array.from(shopsSelect.selectedOptions).map(option => option.value);
    
    let editingIdx = document.getElementById("formEditingIndex").value;

    if(!inspector || !day || !shift || !area || shops.length === 0) {
        alert("يرجى تعبئة جميع الحقول!");
        return;
    }
    
    // If new inspector, add to inspectorsData
    if (!inspectorsData.find(insp => insp.name === inspector)) {
        const newId = 'insp_' + Date.now();
        inspectorsData.push({id: newId, name: inspector});
        inspectors = inspectorsData.map(i => i.name);
        fillInspectorsDropdowns();
    }
    
    // If new area, add to areasData
    if (!areasData.find(ar => ar.name === area)) {
        const newId = 'area_' + Date.now();
        areasData.push({id: newId, name: area});
        fillAreasDropdowns();
    }
    
    let newPlan = {inspector, day, shift, area, shops};
    if(editingIdx==="") {
        inspectionData.push(newPlan);
    } else {
        inspectionData[editingIdx] = newPlan;
    }
    saveInspectionData();
    renderPlanTable();
    this.reset();
    document.getElementById("formEditingIndex").value = "";
    
    // Reset toggle states
    resetFormToggles();
});

// --- البحث والتصفية ---
let currentSearchFilters = {};

function applySearchFilters() {
    const fromDate = document.getElementById('searchFromDate').value;
    const toDate = document.getElementById('searchToDate').value;
    const area = document.getElementById('searchArea').value;
    const shift = document.getElementById('searchShift').value;
    
    currentSearchFilters = {
        fromDate: fromDate || null,
        toDate: toDate || null,
        area: area || null,
        shift: shift || null
    };
    
    renderPlanTable();
}

function clearSearchFilters() {
    document.getElementById('searchFromDate').value = '';
    document.getElementById('searchToDate').value = '';
    document.getElementById('searchArea').value = '';
    document.getElementById('searchShift').value = '';
    
    currentSearchFilters = {};
    
    // Hide search results info
    document.getElementById('searchResultsInfo').style.display = 'none';
    
    renderPlanTable();
}

function filterInspectionData(data) {
    if (!currentSearchFilters || Object.keys(currentSearchFilters).length === 0) {
        return data;
    }
    
    return data.filter(item => {
        // Filter by date range
        if (currentSearchFilters.fromDate && item.day < currentSearchFilters.fromDate) {
            return false;
        }
        if (currentSearchFilters.toDate && item.day > currentSearchFilters.toDate) {
            return false;
        }
        
        // Filter by area
        if (currentSearchFilters.area && item.area !== currentSearchFilters.area) {
            return false;
        }
        
        // Filter by shift
        if (currentSearchFilters.shift && item.shift !== currentSearchFilters.shift) {
            return false;
        }
        
        return true;
    });
}

// --- عرض جدول الخطط مع صلاحيات المطور ---
function renderPlanTable() {
    const container = document.getElementById('planTableContainer');
    let rows = inspectionData;
    
    // إذا تم اختيار مفتش معيّن
    if(selectedInspector) {
        rows = inspectionData.filter(item => item.inspector === selectedInspector);
    }
    
    // تطبيق فلتر اليوم الحالي كافتراضي (إلا إذا كان المستخدم يستخدم البحث)
    const hasActiveSearchFilters = Object.keys(currentSearchFilters).length > 0 && 
        (currentSearchFilters.fromDate || currentSearchFilters.toDate || 
         currentSearchFilters.area || currentSearchFilters.shift);
    
    if (!hasActiveSearchFilters) {
        // عرض تفتيشات اليوم الحالي فقط (بالتوقيت المحلي)
        const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD format in local timezone
        rows = rows.filter(item => item.day === today);
    }
    
    // Apply search filters
    rows = filterInspectionData(rows);
    
    // Update search results info
    const searchResultsInfo = document.getElementById('searchResultsInfo');
    const searchResultsCount = document.getElementById('searchResultsCount');
    if (hasActiveSearchFilters) {
        searchResultsInfo.style.display = 'block';
        searchResultsCount.textContent = rows.length;
    } else {
        // عرض معلومات التفتيشات اليومية
        if (rows.length > 0) {
            searchResultsInfo.style.display = 'block';
            const today = new Date().toLocaleDateString('ar-EG');
            searchResultsInfo.innerHTML = `<strong>تفتيشات اليوم (${today}):</strong> <span id="searchResultsCount">${rows.length}</span> تفتيش`;
        } else {
            searchResultsInfo.style.display = 'none';
        }
    }
    
    if (rows.length === 0) {
        if (hasActiveSearchFilters) {
            container.innerHTML = '<div style="text-align:center;color:#c00;font-weight:bold;margin:30px 0;">لا توجد نتائج للبحث المحدد.</div>';
        } else {
            container.innerHTML = '<div style="text-align:center;color:#666;font-weight:bold;margin:30px 0;">لا توجد تفتيشات لليوم الحالي.<br><small style="font-weight:normal;">استخدم البحث للعثور على تفتيشات الأيام السابقة</small></div>';
        }
        return;
    }
    let html = `
    <table class="plan-table" id="inspectorPlanTable">
        <thead>
            <tr>
                <th>اسم المفتش</th>
                <th>اليوم</th>
                <th>وقت المناوبة</th>
                <th>المنطقة</th>
                <th>المحلات</th>
                ${isDev?'<th>تعديل/حذف</th>':''}
            </tr>
        </thead>
        <tbody>
    `;
    rows.forEach((row, idx) => {
        let shopsStr = row.shops.map(shop=>`<li>${shop}</li>`).join('');
        let realIdx = inspectionData.indexOf(row);
        html += `
            <tr>
                <td>${row.inspector}</td>
                <td>${row.day}</td>
                <td>${row.shift}</td>
                <td>${row.area}</td>
                <td>
                    <div class="shops-dropdown-wrap" id="shopsDropdownWrap${idx}">
                        <button class="dropdown-shops-btn" onclick="toggleShopsDropdown(event, ${idx})">عرض المحلات</button>
                        <div class="shops-dropdown-list" id="shopsDropdownList${idx}">
                            <ul>
                                ${shopsStr}
                            </ul>
                        </div>
                    </div>
                </td>
                ${isDev?`
                <td>
                    <button class="edit-btn" onclick="editPlan(${realIdx})">تعديل</button>
                    <button class="delete-btn" onclick="deletePlan(${realIdx})">حذف</button>
                </td>
                `:``}
            </tr>
        `;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
}

function editPlan(idx) {
    if (!isDev) return;
    let plan = inspectionData[idx];
    
    // Reset toggles to show dropdowns
    resetFormToggles();
    
    // Set inspector
    document.getElementById("formInspector").value = plan.inspector;
    document.getElementById("formDay").value = plan.day;
    document.getElementById("formShift").value = plan.shift;
    
    // Set area and update shops accordingly
    document.getElementById("formArea").value = plan.area;
    // Always show all shops regardless of area selection
    fillShopsDropdowns();
    
    // Set selected shops in multi-select
    const shopsSelect = document.getElementById("formShops");
    setTimeout(() => {
        for (let option of shopsSelect.options) {
            option.selected = plan.shops.includes(option.value);
        }
    }, 100);
    
    document.getElementById("formEditingIndex").value = idx;
    window.scrollTo({top:0,behavior:'smooth'});
}
function deletePlan(idx) {
    if (!isDev) return;
    if(!confirm("هل تريد حذف هذه الخطة نهائياً؟")) return;
    inspectionData.splice(idx,1);
    saveInspectionData();
    renderPlanTable();
}

// --- المحلات المنسدلة ---
window.toggleShopsDropdown = function(event, idx) {
    event.stopPropagation();
    document.querySelectorAll('.shops-dropdown-list').forEach((el,i)=>{
        if(i!==idx) el.style.display='none';
    });
    let btn = event.target;
    let rect = btn.getBoundingClientRect();
    let list = document.getElementById('shopsDropdownList'+idx);
    list.style.display = 'block';
    let top = rect.bottom + window.scrollY + 2;
    let left = rect.right - list.offsetWidth + window.scrollX;
    if ((top + list.offsetHeight) > (window.innerHeight + window.scrollY)) {
        top = rect.top + window.scrollY - list.offsetHeight - 2;
    }
    list.style.top = top+"px";
    list.style.left = (rect.left + window.scrollX) + "px";
};
document.addEventListener('click', function(e){
    if (![...document.querySelectorAll('.shops-dropdown-wrap *')].includes(e.target)) {
        document.querySelectorAll('.shops-dropdown-list').forEach(el=>el.style.display='none');
    }
});

// --- صوت النقر الشامل ---
let lastClickSoundTime = 0;
const CLICK_SOUND_COOLDOWN = 100; // 100ms between clicks to prevent spam

function playClickSound() {
    const currentTime = Date.now();
    // Check cooldown to prevent too frequent sounds
    if (currentTime - lastClickSoundTime < CLICK_SOUND_COOLDOWN) {
        return;
    }
    
    lastClickSoundTime = currentTime;
    
    // Generate keyboard-like click sound using Web Audio API
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Configure keyboard-like click sound
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
        
        // Quick attack and decay (keyboard-like)
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.15, audioContext.currentTime + 0.005);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.05);
        
        // Start and stop
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.05);
        
        console.log('Click sound played');
        
    } catch (error) {
        console.log('Failed to play click sound:', error);
    }
}

function playBellSound() {
    // Play click sound instead of bell sound
    playClickSound();
    
    // Add visual bell animation
    const bell3d = document.getElementById('bell3d');
    if (bell3d) {
        bell3d.classList.add('bell-ringing');
        setTimeout(function() {
            bell3d.classList.remove('bell-ringing');
        }, 800);
    }
    
    // Show the bell modal after a short delay
    setTimeout(function() {
        showBellModal();
    }, 200);
}

// --- وظائف نافذة الجرس ---
function showBellModal() {
    const modal = document.getElementById('bellModal');
    const textarea = document.getElementById('bellNotesTextarea');
    const bellInfoText = document.getElementById('bellInfoText');
    const bellInfoEdit = document.getElementById('bellInfoEdit');
    
    // Load saved notes from central storage (bellNotesData)
    const savedNotes = bellNotesData.notes || '';
    textarea.value = savedNotes;
    
    // Load saved bell info text from central storage
    const savedBellInfo = bellNotesData.infoText || 'توجيهات وإشعارات للمفتشين - يتم حفظها مركزياً لجميع المفتشين';
    bellInfoText.textContent = savedBellInfo;
    bellInfoEdit.value = savedBellInfo;
    
    // Check if user is developer to enable/disable editing
    // Use window.isDev to ensure we get the global variable
    const isDevUser = window.isDev || isDev || false;
    if (isDevUser) {
        textarea.disabled = false;
        textarea.placeholder = 'اكتب توجيهاتك وإشعاراتك هنا... (وضع المطور)';
        textarea.style.backgroundColor = '#fff';
        textarea.style.cursor = 'text';
        // Show save, clear, and export buttons for developer
        document.getElementById('bellSaveBtn').style.display = 'inline-block';
        document.getElementById('bellClearBtn').style.display = 'inline-block';
        document.getElementById('bellExportBtn').style.display = 'inline-block';
        
        // Make bell info text editable for developer
        bellInfoText.style.cursor = 'pointer';
        bellInfoText.onclick = function() {
            bellInfoText.style.display = 'none';
            bellInfoEdit.style.display = 'block';
            bellInfoEdit.focus();
        };
        
        bellInfoEdit.onblur = function() {
            const newText = bellInfoEdit.value.trim() || 'توجيهات وإشعارات للمفتشين - يتم حفظها مركزياً لجميع المفتشين';
            bellInfoText.textContent = newText;
            bellNotesData.infoText = newText;
            // Save to central file
            saveDataToJSON();
            bellInfoText.style.display = 'block';
            bellInfoEdit.style.display = 'none';
        };
        
        bellInfoEdit.onkeypress = function(e) {
            if (e.key === 'Enter') {
                bellInfoEdit.blur();
            }
        };
    } else {
        textarea.disabled = true;
        textarea.placeholder = 'عرض التوجيهات والإشعارات فقط - يمكن للمطور فقط التعديل';
        textarea.style.backgroundColor = '#f5f5f5';
        textarea.style.cursor = 'not-allowed';
        // Hide save, clear, and export buttons for non-developers
        document.getElementById('bellSaveBtn').style.display = 'none';
        document.getElementById('bellClearBtn').style.display = 'none';
        document.getElementById('bellExportBtn').style.display = 'none';
        
        // Make bell info text non-editable for non-developers
        bellInfoText.style.cursor = 'default';
        bellInfoText.onclick = null;
    }
    
    modal.classList.add('show');
    
    // Focus on textarea only if developer
    if (isDevUser) {
        setTimeout(function() {
            textarea.focus();
        }, 100);
    }
}

function hideBellModal() {
    const modal = document.getElementById('bellModal');
    modal.classList.remove('show');
}

function saveBellNotes() {
    const textarea = document.getElementById('bellNotesTextarea');
    const notes = textarea.value.trim();
    
    // Save to central storage instead of localStorage
    bellNotesData.notes = notes;
    saveDataToJSON();
    
    // Show success feedback with clearer messaging
    const saveBtn = document.getElementById('bellSaveBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '✅ تم الحفظ مؤقتاً';
    saveBtn.style.background = '#28a745';
    
    // Show more prominent message about permanent saving
    showBellSaveMessage('تم حفظ التوجيهات مؤقتاً! لحفظها نهائياً، اضغط على زر "تصدير البيانات" أسفل الصفحة.');
    
    setTimeout(function() {
        saveBtn.innerHTML = originalText;
        saveBtn.style.background = '#28a745';
    }, 3000);
}

function showBellSaveMessage(message) {
    // Create or update the message div
    let messageDiv = document.getElementById('bellSaveMessage');
    if (!messageDiv) {
        messageDiv = document.createElement('div');
        messageDiv.id = 'bellSaveMessage';
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2196F3;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 400px;
            font-size: 14px;
            line-height: 1.4;
            text-align: right;
            direction: rtl;
        `;
        document.body.appendChild(messageDiv);
    }
    
    messageDiv.innerHTML = `
        <div style="margin-bottom: 10px;">
            📝 ${message}
        </div>
        <button onclick="hideBellSaveMessage()" style="
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        ">إغلاق</button>
    `;
    
    // Auto-hide after 8 seconds
    setTimeout(function() {
        hideBellSaveMessage();
    }, 8000);
}

function hideBellSaveMessage() {
    const messageDiv = document.getElementById('bellSaveMessage');
    if (messageDiv) {
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateY(-10px)';
        messageDiv.style.transition = 'all 0.3s ease';
        setTimeout(function() {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 300);
    }
}

function clearBellNotes() {
    if (confirm('هل أنت متأكد من مسح جميع التوجيهات والإشعارات؟')) {
        const textarea = document.getElementById('bellNotesTextarea');
        textarea.value = '';
        // Clear from central storage instead of localStorage
        bellNotesData.notes = '';
        saveDataToJSON();
        
        // Show clear feedback
        const clearBtn = document.getElementById('bellClearBtn');
        const originalText = clearBtn.innerHTML;
        clearBtn.innerHTML = '✅ تم المسح';
        
        setTimeout(function() {
            clearBtn.innerHTML = originalText;
        }, 2000);
    }
}

// Event listeners for bell modal
document.addEventListener('DOMContentLoaded', function() {
    // Add global click sound to document
    document.addEventListener('click', function(e) {
        // Play click sound on any click/touch
        playClickSound();
    });
    
    // Add global touch sound to document  
    document.addEventListener('touchstart', function(e) {
        // Play click sound on any touch
        playClickSound();
    });
    
    // Bell button specific functionality
    document.getElementById('bellBtn').addEventListener('click', function(e) {
        // Prevent double click sound (already handled by global listener)
        e.stopPropagation();
        playBellSound();
    });
    
    document.getElementById('bellBtn').addEventListener('touchstart', function(e) {
        // Prevent double click sound (already handled by global listener)  
        e.stopPropagation();
        playBellSound();
    });
    
    // Bell modal event listeners
    document.getElementById('bellSaveBtn').addEventListener('click', saveBellNotes);
    document.getElementById('bellClearBtn').addEventListener('click', clearBellNotes);
    document.getElementById('bellExportBtn').addEventListener('click', function() {
        // First save the current data, then export
        saveBellNotes();
        // Wait a bit for the save to complete, then export
        setTimeout(function() {
            saveToExternalFile();
        }, 500);
    });
    document.getElementById('bellCloseBtn').addEventListener('click', hideBellModal);
    
    // Close modal when clicking outside
    document.getElementById('bellModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideBellModal();
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideBellModal();
        }
    });
});

// --- دوال التصدير والتقارير بالكامل ---
function exportTableToPDF() {
    let table = document.getElementById('inspectorPlanTable');
    if (!table) { alert("لا يوجد جدول للتصدير"); return; }
    let wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '18px';
    wrap.style.width = table.offsetWidth + 'px';
    let titleBox = document.createElement('div');
    titleBox.className = "pdf-title-arabic";
    titleBox.innerText = "خطة التفتيش الشهرية";
    wrap.appendChild(titleBox);
    let tableClone = table.cloneNode(true);
    tableClone.style.marginTop = '10px';
    wrap.appendChild(tableClone);
    document.body.appendChild(wrap);
    html2canvas(wrap, {backgroundColor:'#fff', scale:2}).then(function(canvas) {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:"landscape",unit:"pt",format:"a4"});
        let pageWidth = doc.internal.pageSize.getWidth();
        let imgProps = doc.getImageProperties(imgData);
        let pdfWidth = pageWidth - 80;
        let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'PNG', 40, 35, pdfWidth, pdfHeight);
        doc.save(`خطة_التفتيش.pdf`);
        document.body.removeChild(wrap);
    });
}
function exportTableToExcel() {
    let table = document.getElementById('inspectorPlanTable');
    if (!table) { alert("لا يوجد جدول للتصدير"); return; }
    let ws_data = [];
    for(let r of table.rows) {
        let row = [];
        for(let c of r.cells) row.push(c.textContent);
        ws_data.push(row);
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "الخطة");
    XLSX.writeFile(wb, `خطة_التفتيش.xlsx`);
}
function printTable() {
    let table = document.getElementById('inspectorPlanTable');
    if (!table) { alert("لا يوجد جدول لطباعته"); return; }
    
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    const tableClone = table.cloneNode(true);
    
    // Create the print document
    printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>خطة التفتيش الشهرية - طباعة</title>
            <style>
                body { font-family: 'Cairo', Arial, sans-serif; margin: 20px; }
                .print-title { text-align: center; color: #234085; font-size: 1.5em; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #234093; padding: 8px; text-align: center; }
                th { background: #234093; color: #fff; }
                tr:nth-child(even) { background: #f3f5fa; }
                @media print {
                    body { margin: 0; }
                    .print-title { font-size: 1.2em; }
                }
            </style>
        </head>
        <body>
            <div class="print-title">خطة التفتيش الشهرية</div>
            ${tableClone.outerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    
    // Wait for content to load then print
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 500);
}
function showInspectorReport() {
    let inspectorName = selectedInspector || "";
    if (!inspectorName) { alert("يرجى اختيار مفتش أولاً."); return; }
    const div = document.getElementById('inspectorReportDiv');
    const rows = inspectionData.filter(item => item.inspector === inspectorName);
    
    // Count total shops assigned to this inspector
    let totalShops = 0;
    let morningShops = 0;
    let eveningShops = 0;
    let weekendShops = 0;
    
    rows.forEach(r => {
        const shopsCount = r.shops ? r.shops.length : 0;
        totalShops += shopsCount;
        
        if (r.shift === "صباحية") {
            morningShops += shopsCount;
        } else if (r.shift === "مسائية") {
            eveningShops += shopsCount;
        }
        
        // Check if it's a weekend day
        const dayOfWeek = new Date(r.day).getDay();
        if ([5,6,0].includes(dayOfWeek)) {
            weekendShops += shopsCount;
        }
    });
    
    let table = `
    <div class="pdf-title-arabic" id="inspectorReportTitle">تقرير المفتش: ${inspectorName}</div>
    <div class="save-box" style="margin-bottom:8px;">
        <button class="pdf-btn" onclick="exportInspectorReportToPDF()">حفظ التقرير كـ PDF</button>
        <button class="excel-btn" onclick="exportInspectorReportToExcel()">حفظ التقرير كـ Excel</button>
    </div>
    <table class="stats-table" id="inspectorStatsTable">
        <thead>
            <tr>
                <th>عدد التفتيشات</th>
                <th>الصباحية</th>
                <th>المسائية</th>
                <th>العطلة</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>${totalShops}</td>
                <td>${morningShops}</td>
                <td>${eveningShops}</td>
                <td>${weekendShops}</td>
            </tr>
        </tbody>
    </table>
    `;
    div.innerHTML = table;
    div.style.display = "block";
}
function exportInspectorReportToPDF() {
    let titleBox = document.getElementById('inspectorReportTitle');
    let table = document.getElementById('inspectorStatsTable');
    if (!table || !titleBox) return;
    let wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '18px';
    wrap.style.width = table.offsetWidth + 'px';
    let titleClone = titleBox.cloneNode(true);
    let tableClone = table.cloneNode(true);
    tableClone.style.marginTop = '10px';
    wrap.appendChild(titleClone);
    wrap.appendChild(tableClone);
    document.body.appendChild(wrap);
    html2canvas(wrap, {backgroundColor:'#fff', scale:2}).then(function(canvas){
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:"p",unit:"pt",format:"a4"});
        let pageWidth = doc.internal.pageSize.getWidth();
        let imgProps = doc.getImageProperties(imgData);
        let pdfWidth = pageWidth - 80;
        let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'PNG', 40, 35, pdfWidth, pdfHeight);
        doc.save(`تقرير_${selectedInspector}.pdf`);
        document.body.removeChild(wrap);
    });
}
function exportInspectorReportToExcel() {
    let table = document.getElementById("inspectorStatsTable");
    if (!table) return;
    let ws_data = [];
    for(let r of table.rows) {
        let row = [];
        for(let c of r.cells) row.push(c.textContent);
        ws_data.push(row);
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "تقرير المفتش");
    XLSX.writeFile(wb, `تقرير_${selectedInspector}.xlsx`);
}
function showMonthlyReport() {
    let allDays = Array.from(new Set(inspectionData.map(r => r.day))).sort();
    let html = `<div class="pdf-title-arabic" id="monthlyReportTitle">التقرير الشهري</div>`;
    html += `<table class="stats-table" id="monthlyStatsTable"><thead><tr>
        <th>المفتش</th>`;
    allDays.forEach(day => html += `<th>${day}</th>`);
    html += `<th>الإجمالي</th><th>الصباحية</th><th>المسائية</th><th>العطلة</th></tr></thead><tbody>`;
    let totals = { total:0, morning:0, evening:0, weekend:0, days: Array(allDays.length).fill(0) };
    inspectors.forEach(inspector => {
        const rows = inspectionData.filter(item => item.inspector === inspector);
        html += `<tr><td>${inspector}</td>`;
        allDays.forEach((day,i) => {
            let dayRows = rows.filter(r=>r.day===day);
            let shopsCount = 0;
            dayRows.forEach(row => {
                shopsCount += row.shops ? row.shops.length : 0;
            });
            html += `<td>${shopsCount||''}</td>`;
            totals.days[i] += shopsCount;
        });
        
        // Calculate totals based on shops, not days
        let totalShops = 0;
        let morningShops = 0;
        let eveningShops = 0;
        let weekendShops = 0;
        
        rows.forEach(r => {
            const shopsCount = r.shops ? r.shops.length : 0;
            totalShops += shopsCount;
            
            if (r.shift === "صباحية") {
                morningShops += shopsCount;
            } else if (r.shift === "مسائية") {
                eveningShops += shopsCount;
            }
            
            // Check if it's a weekend day
            const dow = new Date(r.day).getDay();
            if ([5,6,0].includes(dow)) {
                weekendShops += shopsCount;
            }
        });
        
        html += `<td>${totalShops}</td><td>${morningShops}</td><td>${eveningShops}</td><td>${weekendShops}</td></tr>`;
        totals.total += totalShops; totals.morning += morningShops; totals.evening += eveningShops; totals.weekend += weekendShops;
    });
    html += `<tr class="red-total">
        <td>الإجمالي</td>`;
    totals.days.forEach(sum=>html+=`<td>${sum}</td>`);
    html += `<td>${totals.total}</td><td>${totals.morning}</td><td>${totals.evening}</td><td>${totals.weekend}</td></tr>`;
    html += `</tbody></table>`;
    document.getElementById('monthlyReportContent').innerHTML = html;
    document.getElementById('monthlyReportModal').style.display = 'flex';
}
function closeMonthlyReportModal() {
    document.getElementById('monthlyReportModal').style.display = 'none';
}
function exportMonthlyReportToPDF() {
    let titleBox = document.getElementById('monthlyReportTitle');
    let table = document.getElementById("monthlyStatsTable");
    if (!table || !titleBox) return;
    let wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '18px';
    wrap.style.width = table.offsetWidth + 'px';
    let titleClone = titleBox.cloneNode(true);
    let tableClone = table.cloneNode(true);
    tableClone.style.marginTop = '10px';
    wrap.appendChild(titleClone);
    wrap.appendChild(tableClone);
    document.body.appendChild(wrap);
    html2canvas(wrap, {backgroundColor:'#fff', scale:2}).then(function(canvas){
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:"landscape",unit:"pt",format:"a4"});
        let pageWidth = doc.internal.pageSize.getWidth();
        let imgProps = doc.getImageProperties(imgData);
        let pdfWidth = pageWidth - 80;
        let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'PNG', 40, 35, pdfWidth, pdfHeight);
        doc.save(`التقرير_الشهري.pdf`);
        document.body.removeChild(wrap);
    });
}
function exportMonthlyReportToExcel() {
    let table = document.getElementById("monthlyStatsTable");
    if (!table) return;
    let ws_data = [];
    for(let r of table.rows) {
        let row = [];
        for(let c of r.cells) row.push(c.textContent);
        ws_data.push(row);
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "التقرير الشهري");
    XLSX.writeFile(wb, `التقرير_الشهري.xlsx`);
}

// --- Enhanced Reporting Functions ---
function showEnhancedReportsModal() {
    // Populate inspector dropdown in the modal
    const reportInspectorSelect = document.getElementById('reportInspectorSelect');
    reportInspectorSelect.innerHTML = '<option value="">-- جميع المفتشين --</option>';
    inspectorsData.forEach(inspector => {
        reportInspectorSelect.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
    });
    
    // Set current year as default
    const currentYear = new Date().getFullYear();
    document.getElementById('reportYear').value = currentYear;
    
    // Set current month as default
    const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0');
    document.getElementById('reportMonth').value = currentMonth;
    
    document.getElementById('enhancedReportsModal').style.display = 'flex';
}

function closeEnhancedReportsModal() {
    document.getElementById('enhancedReportsModal').style.display = 'none';
}

function generateEnhancedReport() {
    const reportType = document.querySelector('input[name="reportType"]:checked').value;
    const selectedInspector = document.getElementById('reportInspectorSelect').value;
    const selectedYear = document.getElementById('reportYear').value;
    const selectedMonth = document.getElementById('reportMonth').value;
    
    let filteredData = inspectionData.slice();
    
    // Filter by year
    if (selectedYear) {
        filteredData = filteredData.filter(item => item.day.startsWith(selectedYear));
    }
    
    // Filter by month (for monthly reports)
    if ((reportType === 'inspector-monthly' || reportType === 'all-monthly') && selectedMonth) {
        filteredData = filteredData.filter(item => {
            const month = item.day.substring(5, 7);
            return month === selectedMonth;
        });
    }
    
    // Filter by inspector (for inspector-specific reports)
    if ((reportType === 'inspector-monthly' || reportType === 'inspector-yearly') && selectedInspector) {
        filteredData = filteredData.filter(item => item.inspector === selectedInspector);
    }
    
    let reportHtml = '';
    let reportTitle = '';
    
    if (reportType === 'inspector-monthly') {
        reportTitle = `تقرير شهري للمفتش: ${selectedInspector || 'جميع المفتشين'} - ${getMonthName(selectedMonth)} ${selectedYear}`;
        reportHtml = generateInspectorMonthlyReport(filteredData, selectedInspector);
    } else if (reportType === 'inspector-yearly') {
        reportTitle = `تقرير سنوي للمفتش: ${selectedInspector || 'جميع المفتشين'} - ${selectedYear}`;
        reportHtml = generateInspectorYearlyReport(filteredData, selectedInspector);
    } else if (reportType === 'all-monthly') {
        reportTitle = `تقرير شهري لجميع المفتشين - ${getMonthName(selectedMonth)} ${selectedYear}`;
        reportHtml = generateAllInspectorsMonthlyReport(filteredData);
    } else if (reportType === 'all-yearly') {
        reportTitle = `تقرير سنوي لجميع المفتشين - ${selectedYear}`;
        reportHtml = generateAllInspectorsYearlyReport(filteredData);
    } else if (reportType === 'shop-analytics') {
        reportTitle = `📊 تحليلات المحلات الذكية - ${selectedYear}`;
        reportHtml = generateShopAnalyticsReport(filteredData, selectedYear, selectedMonth);
    }
    
    const fullReportHtml = `
        <div class="pdf-title-arabic" id="enhancedReportTitle">${reportTitle}</div>
        ${reportHtml}
    `;
    
    document.getElementById('enhancedReportContent').innerHTML = fullReportHtml;
}

function generateInspectorMonthlyReport(data, inspectorName) {
    const inspectorData = data.filter(item => !inspectorName || item.inspector === inspectorName);
    const groupedByDate = {};
    
    inspectorData.forEach(item => {
        if (!groupedByDate[item.day]) {
            groupedByDate[item.day] = [];
        }
        groupedByDate[item.day].push(item);
    });
    
    let html = `
        <table class="stats-table" id="enhancedReportTable">
            <thead>
                <tr>
                    <th>التاريخ</th>
                    <th>المنطقة</th>
                    <th>وقت المناوبة</th>
                    <th>عدد المحلات</th>
                    <th>المحلات</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalInspections = 0;
    let totalShops = 0;
    
    Object.keys(groupedByDate).sort().forEach(date => {
        groupedByDate[date].forEach(item => {
            const shopsCount = item.shops ? item.shops.length : 0;
            totalInspections++;
            totalShops += shopsCount;
            
            html += `
                <tr>
                    <td>${item.day}</td>
                    <td>${item.area}</td>
                    <td>${item.shift}</td>
                    <td>${shopsCount}</td>
                    <td>${item.shops ? item.shops.join(', ') : ''}</td>
                </tr>
            `;
        });
    });
    
    html += `
            <tr style="background:#e9ecef;font-weight:bold;">
                <td colspan="3">الإجمالي</td>
                <td>${totalShops}</td>
                <td>إجمالي التفتيشات: ${totalInspections}</td>
            </tr>
        </tbody>
        </table>
    `;
    
    return html;
}

function generateInspectorYearlyReport(data, inspectorName) {
    const inspectorData = data.filter(item => !inspectorName || item.inspector === inspectorName);
    const groupedByMonth = {};
    
    inspectorData.forEach(item => {
        const month = item.day.substring(0, 7); // YYYY-MM
        if (!groupedByMonth[month]) {
            groupedByMonth[month] = {
                count: 0,
                shops: 0,
                morning: 0,
                evening: 0
            };
        }
        
        groupedByMonth[month].count++;
        groupedByMonth[month].shops += item.shops ? item.shops.length : 0;
        
        if (item.shift === 'صباحية') {
            groupedByMonth[month].morning++;
        } else if (item.shift === 'مسائية') {
            groupedByMonth[month].evening++;
        }
    });
    
    let html = `
        <table class="stats-table" id="enhancedReportTable">
            <thead>
                <tr>
                    <th>الشهر</th>
                    <th>عدد التفتيشات</th>
                    <th>عدد المحلات</th>
                    <th>الصباحية</th>
                    <th>المسائية</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalInspections = 0;
    let totalShops = 0;
    let totalMorning = 0;
    let totalEvening = 0;
    
    Object.keys(groupedByMonth).sort().forEach(month => {
        const data = groupedByMonth[month];
        totalInspections += data.count;
        totalShops += data.shops;
        totalMorning += data.morning;
        totalEvening += data.evening;
        
        const monthName = getMonthName(month.substring(5, 7));
        
        html += `
            <tr>
                <td>${monthName} ${month.substring(0, 4)}</td>
                <td>${data.count}</td>
                <td>${data.shops}</td>
                <td>${data.morning}</td>
                <td>${data.evening}</td>
            </tr>
        `;
    });
    
    html += `
            <tr style="background:#e9ecef;font-weight:bold;">
                <td>الإجمالي السنوي</td>
                <td>${totalInspections}</td>
                <td>${totalShops}</td>
                <td>${totalMorning}</td>
                <td>${totalEvening}</td>
            </tr>
        </tbody>
        </table>
    `;
    
    return html;
}

function generateAllInspectorsMonthlyReport(data) {
    const groupedByInspector = {};
    
    data.forEach(item => {
        if (!groupedByInspector[item.inspector]) {
            groupedByInspector[item.inspector] = {
                count: 0,
                shops: 0,
                morning: 0,
                evening: 0
            };
        }
        
        groupedByInspector[item.inspector].count++;
        groupedByInspector[item.inspector].shops += item.shops ? item.shops.length : 0;
        
        if (item.shift === 'صباحية') {
            groupedByInspector[item.inspector].morning++;
        } else if (item.shift === 'مسائية') {
            groupedByInspector[item.inspector].evening++;
        }
    });
    
    let html = `
        <table class="stats-table" id="enhancedReportTable">
            <thead>
                <tr>
                    <th>المفتش</th>
                    <th>عدد التفتيشات</th>
                    <th>عدد المحلات</th>
                    <th>الصباحية</th>
                    <th>المسائية</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalInspections = 0;
    let totalShops = 0;
    let totalMorning = 0;
    let totalEvening = 0;
    
    Object.keys(groupedByInspector).sort().forEach(inspector => {
        const data = groupedByInspector[inspector];
        totalInspections += data.count;
        totalShops += data.shops;
        totalMorning += data.morning;
        totalEvening += data.evening;
        
        html += `
            <tr>
                <td>${inspector}</td>
                <td>${data.count}</td>
                <td>${data.shops}</td>
                <td>${data.morning}</td>
                <td>${data.evening}</td>
            </tr>
        `;
    });
    
    html += `
            <tr style="background:#e9ecef;font-weight:bold;">
                <td>الإجمالي</td>
                <td>${totalInspections}</td>
                <td>${totalShops}</td>
                <td>${totalMorning}</td>
                <td>${totalEvening}</td>
            </tr>
        </tbody>
        </table>
    `;
    
    return html;
}

function generateAllInspectorsYearlyReport(data) {
    const groupedByInspectorMonth = {};
    
    data.forEach(item => {
        const month = item.day.substring(5, 7);
        const key = `${item.inspector}-${month}`;
        
        if (!groupedByInspectorMonth[key]) {
            groupedByInspectorMonth[key] = {
                inspector: item.inspector,
                month: month,
                count: 0,
                shops: 0
            };
        }
        
        groupedByInspectorMonth[key].count++;
        groupedByInspectorMonth[key].shops += item.shops ? item.shops.length : 0;
    });
    
    // Get all unique months
    const allMonths = Array.from(new Set(data.map(item => item.day.substring(5, 7)))).sort();
    const allInspectors = Array.from(new Set(data.map(item => item.inspector))).sort();
    
    let html = `
        <table class="stats-table" id="enhancedReportTable">
            <thead>
                <tr>
                    <th>المفتش</th>
    `;
    
    allMonths.forEach(month => {
        html += `<th>${getMonthName(month)}</th>`;
    });
    
    html += `
                    <th>الإجمالي</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let monthTotals = {};
    let grandTotal = 0;
    
    allInspectors.forEach(inspector => {
        html += `<tr><td>${inspector}</td>`;
        let inspectorTotal = 0;
        
        allMonths.forEach(month => {
            const key = `${inspector}-${month}`;
            const monthData = groupedByInspectorMonth[key];
            const count = monthData ? monthData.count : 0;
            
            html += `<td>${count || ''}</td>`;
            inspectorTotal += count;
            
            if (!monthTotals[month]) monthTotals[month] = 0;
            monthTotals[month] += count;
        });
        
        html += `<td>${inspectorTotal}</td></tr>`;
        grandTotal += inspectorTotal;
    });
    
    // Add totals row
    html += `<tr style="background:#e9ecef;font-weight:bold;"><td>الإجمالي</td>`;
    allMonths.forEach(month => {
        html += `<td>${monthTotals[month] || 0}</td>`;
    });
    html += `<td>${grandTotal}</td></tr>`;
    
    html += `</tbody></table>`;
    
    return html;
}

function generateShopAnalyticsReport(data, selectedYear, selectedMonth) {
    // Create comprehensive shop analytics with intelligent recommendations
    const shopAnalytics = {};
    const areaAnalytics = {};
    
    // Process inspection data to extract shop statistics
    data.forEach(item => {
        if (!item.shops || !Array.isArray(item.shops)) return;
        
        const weekOfYear = getWeekOfYear(item.day);
        const area = item.area;
        
        // Initialize area if not exists
        if (!areaAnalytics[area]) {
            areaAnalytics[area] = {
                totalInspections: 0,
                shops: new Set(),
                weeks: new Set()
            };
        }
        
        areaAnalytics[area].totalInspections++;
        areaAnalytics[area].weeks.add(weekOfYear);
        
        item.shops.forEach(shop => {
            // Initialize shop analytics
            if (!shopAnalytics[shop]) {
                shopAnalytics[shop] = {
                    name: shop,
                    area: area,
                    totalInspections: 0,
                    weeks: new Set(),
                    inspectors: new Set(),
                    shifts: { morning: 0, evening: 0 },
                    lastInspected: null
                };
            }
            
            // Update shop statistics
            shopAnalytics[shop].totalInspections++;
            shopAnalytics[shop].weeks.add(weekOfYear);
            shopAnalytics[shop].inspectors.add(item.inspector);
            shopAnalytics[shop].area = area;
            
            // Update shift counts
            if (item.shift === 'صباحية') {
                shopAnalytics[shop].shifts.morning++;
            } else if (item.shift === 'مسائية') {
                shopAnalytics[shop].shifts.evening++;
            }
            
            // Update last inspection date
            if (!shopAnalytics[shop].lastInspected || item.day > shopAnalytics[shop].lastInspected) {
                shopAnalytics[shop].lastInspected = item.day;
            }
            
            areaAnalytics[area].shops.add(shop);
        });
    });
    
    // Convert shop analytics to array and calculate additional metrics
    const shopsArray = Object.values(shopAnalytics).map(shop => {
        const weekCount = shop.weeks.size;
        const inspectionRate = weekCount > 0 ? (shop.totalInspections / weekCount).toFixed(2) : 0;
        const daysSinceLastInspection = shop.lastInspected ? 
            Math.floor((new Date() - new Date(shop.lastInspected)) / (1000 * 60 * 60 * 24)) : 999;
        
        return {
            ...shop,
            weekCount,
            inspectionRate: parseFloat(inspectionRate),
            daysSinceLastInspection,
            weeks: Array.from(shop.weeks),
            inspectors: Array.from(shop.inspectors)
        };
    });
    
    // Sort by inspection count (high to low as requested)
    shopsArray.sort((a, b) => b.totalInspections - a.totalInspections);
    
    // Calculate statistics
    const totalShops = shopsArray.length;
    const avgInspectionRate = totalShops > 0 ? 
        (shopsArray.reduce((sum, shop) => sum + shop.totalInspections, 0) / totalShops).toFixed(2) : 0;
    
    // Identify under-inspected shops (bottom 30%)
    const threshold = Math.ceil(totalShops * 0.3);
    const underInspectedShops = shopsArray.slice(-threshold);
    
    // Generate HTML report
    let html = `
        <!-- Digital Statistics Dashboard -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0;padding:15px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:12px;color:white;">
            <div style="text-align:center;">
                <div style="font-size:2em;font-weight:bold;margin-bottom:5px;">${totalShops}</div>
                <div style="font-size:0.9em;opacity:0.9;">إجمالي المحلات</div>
            </div>
            <div style="text-align:center;">
                <div style="font-size:2em;font-weight:bold;margin-bottom:5px;">${avgInspectionRate}</div>
                <div style="font-size:0.9em;opacity:0.9;">متوسط التفتيشات</div>
            </div>
            <div style="text-align:center;">
                <div style="font-size:2em;font-weight:bold;margin-bottom:5px;">${Object.keys(areaAnalytics).length}</div>
                <div style="font-size:0.9em;opacity:0.9;">عدد المناطق</div>
            </div>
            <div style="text-align:center;">
                <div style="font-size:2em;font-weight:bold;margin-bottom:5px;">${underInspectedShops.length}</div>
                <div style="font-size:0.9em;opacity:0.9;">محلات تحتاج أولوية</div>
            </div>
        </div>
        
        <!-- Intelligence Recommendations -->
        <div style="margin:20px 0;padding:15px;background:#fff3cd;border:1px solid #ffeaa7;border-radius:8px;">
            <h4 style="margin:0 0 10px 0;color:#856404;display:flex;align-items:center;gap:8px;">
                🧠 التوصيات الذكية
            </h4>
            <div style="font-size:0.95em;line-height:1.6;">
                <p style="margin:5px 0;"><strong>الأولوية العالية:</strong> زيادة تفتيش المحلات التالية:</p>
                <ul style="margin:5px 0;padding-right:20px;">`;
    
    underInspectedShops.slice(0, 5).forEach(shop => {
        const urgencyLevel = shop.daysSinceLastInspection > 14 ? '🔴 عاجل' : 
                            shop.daysSinceLastInspection > 7 ? '🟡 متوسط' : '🟢 عادي';
        html += `<li>${shop.name} (${shop.area}) - ${shop.totalInspections} تفتيش ${urgencyLevel}</li>`;
    });
    
    html += `
                </ul>
                <p style="margin:10px 0 5px 0;"><strong>توصيات عامة:</strong></p>
                <p style="margin:5px 0;">• يُنصح بتوزيع التفتيشات بشكل أكثر عدالة عبر جميع المحلات</p>
                <p style="margin:5px 0;">• التركيز على المحلات التي لم يتم تفتيشها منذ أكثر من أسبوعين</p>
                <p style="margin:5px 0;">• تحسين التغطية الأسبوعية للمناطق ذات التفتيش المنخفض</p>
            </div>
        </div>
        
        <!-- Visual Statistics Chart -->
        <div style="margin:20px 0;padding:15px;background:#f8f9fa;border-radius:8px;">
            <h4 style="margin:0 0 15px 0;color:#234085;">📊 الإحصائيات المرئية</h4>
            <div id="shopChartContainer" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;">`;
    
    // Create simple visual bars for top shops
    const maxInspections = Math.max(...shopsArray.map(s => s.totalInspections));
    shopsArray.slice(0, 10).forEach(shop => {
        const percentage = (shop.totalInspections / maxInspections) * 100;
        const color = shop.totalInspections >= avgInspectionRate ? '#28a745' : 
                     shop.totalInspections >= avgInspectionRate * 0.5 ? '#ffc107' : '#dc3545';
        
        html += `
            <div style="text-align:center;margin:5px;">
                <div style="width:40px;height:${Math.max(20, percentage * 2)}px;background:${color};border-radius:4px;margin:0 auto 5px;position:relative;">
                    <span style="position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:0.8em;font-weight:bold;">${shop.totalInspections}</span>
                </div>
                <div style="font-size:0.7em;max-width:80px;word-wrap:break-word;">${shop.name.substring(0, 15)}${shop.name.length > 15 ? '...' : ''}</div>
            </div>`;
    });
    
    html += `
            </div>
            <div style="display:flex;justify-content:center;gap:20px;margin-top:15px;font-size:0.9em;">
                <span><span style="display:inline-block;width:12px;height:12px;background:#28a745;border-radius:2px;margin-left:5px;"></span>مرتفع</span>
                <span><span style="display:inline-block;width:12px;height:12px;background:#ffc107;border-radius:2px;margin-left:5px;"></span>متوسط</span>
                <span><span style="display:inline-block;width:12px;height:12px;background:#dc3545;border-radius:2px;margin-left:5px;"></span>منخفض</span>
            </div>
        </div>
        
        <!-- Detailed Shop Analytics Table -->
        <table class="stats-table" id="enhancedReportTable">
            <thead>
                <tr>
                    <th>المحل</th>
                    <th>المنطقة</th>
                    <th>إجمالي التفتيشات</th>
                    <th>عدد الأسابيع</th>
                    <th>معدل التفتيش الأسبوعي</th>
                    <th>آخر تفتيش</th>
                    <th>عدد المفتشين</th>
                    <th>صباحي/مسائي</th>
                    <th>الحالة</th>
                </tr>
            </thead>
            <tbody>`;
    
    shopsArray.forEach(shop => {
        const status = shop.totalInspections >= avgInspectionRate ? '🟢 جيد' : 
                      shop.totalInspections >= avgInspectionRate * 0.5 ? '🟡 متوسط' : '🔴 يحتاج أولوية';
        const statusColor = shop.totalInspections >= avgInspectionRate ? '#d4edda' : 
                           shop.totalInspections >= avgInspectionRate * 0.5 ? '#fff3cd' : '#f8d7da';
        
        html += `
            <tr style="background:${statusColor};">
                <td style="font-weight:bold;">${shop.name}</td>
                <td>${shop.area}</td>
                <td style="text-align:center;font-weight:bold;">${shop.totalInspections}</td>
                <td style="text-align:center;">${shop.weekCount}</td>
                <td style="text-align:center;">${shop.inspectionRate}</td>
                <td style="text-align:center;">${shop.lastInspected || 'غير محدد'}</td>
                <td style="text-align:center;">${shop.inspectors.length}</td>
                <td style="text-align:center;">${shop.shifts.morning}/${shop.shifts.evening}</td>
                <td style="text-align:center;">${status}</td>
            </tr>`;
    });
    
    html += `
            </tbody>
        </table>
        
        <!-- Area Summary -->
        <div style="margin-top:25px;">
            <h4 style="color:#234085;margin-bottom:15px;">📍 ملخص المناطق</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;">`;
    
    Object.entries(areaAnalytics).forEach(([area, stats]) => {
        const shopCount = stats.shops.size;
        const avgInspectionsPerShop = shopCount > 0 ? (stats.totalInspections / shopCount).toFixed(1) : 0;
        
        html += `
            <div style="padding:15px;background:#ffffff;border:1px solid #e0e0e0;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                <h5 style="margin:0 0 10px 0;color:#234085;">${area}</h5>
                <p style="margin:5px 0;font-size:0.9em;"><strong>المحلات:</strong> ${shopCount}</p>
                <p style="margin:5px 0;font-size:0.9em;"><strong>إجمالي التفتيشات:</strong> ${stats.totalInspections}</p>
                <p style="margin:5px 0;font-size:0.9em;"><strong>متوسط التفتيش:</strong> ${avgInspectionsPerShop}/محل</p>
                <p style="margin:5px 0;font-size:0.9em;"><strong>الأسابيع المغطاة:</strong> ${stats.weeks.size}</p>
            </div>`;
    });
    
    html += `
            </div>
        </div>`;
    
    return html;
}

// Helper function to get week number of year
function getWeekOfYear(dateString) {
    const date = new Date(dateString);
    const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
    const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
    return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
}

function getMonthName(monthNumber) {
    const months = {
        '01': 'يناير', '02': 'فبراير', '03': 'مارس', '04': 'أبريل',
        '05': 'مايو', '06': 'يونيو', '07': 'يوليو', '08': 'أغسطس',
        '09': 'سبتمبر', '10': 'أكتوبر', '11': 'نوفمبر', '12': 'ديسمبر'
    };
    return months[monthNumber] || monthNumber;
}

function exportEnhancedReportToPDF() {
    const titleElement = document.getElementById('enhancedReportTitle');
    const tableElement = document.getElementById('enhancedReportTable');
    
    if (!titleElement || !tableElement) {
        alert('يرجى توليد التقرير أولاً');
        return;
    }
    
    const wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '18px';
    wrap.style.width = tableElement.offsetWidth + 'px';
    
    const titleClone = titleElement.cloneNode(true);
    const tableClone = tableElement.cloneNode(true);
    tableClone.style.marginTop = '10px';
    
    wrap.appendChild(titleClone);
    wrap.appendChild(tableClone);
    document.body.appendChild(wrap);
    
    html2canvas(wrap).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const doc = new jsPDF({orientation: "landscape", unit: "pt", format: "a4"});
        const pageWidth = doc.internal.pageSize.getWidth();
        const imgProps = doc.getImageProperties(imgData);
        const pdfWidth = pageWidth - 80;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        doc.addImage(imgData, 'PNG', 40, 35, pdfWidth, pdfHeight);
        doc.save(`تقرير_متقدم_${Date.now()}.pdf`);
        document.body.removeChild(wrap);
    });
}

function exportEnhancedReportToExcel() {
    const tableElement = document.getElementById('enhancedReportTable');
    
    if (!tableElement) {
        alert('يرجى توليد التقرير أولاً');
        return;
    }
    
    let ws_data = [];
    for (let r of tableElement.rows) {
        let row = [];
        for (let c of r.cells) row.push(c.textContent);
        ws_data.push(row);
    }
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "تقرير متقدم");
    XLSX.writeFile(wb, `تقرير_متقدم_${Date.now()}.xlsx`);
}
</script>
   <script>
// --- Toggle Functions for Inspector/Area Input Fields ---
function resetFormToggles() {
    // Reset inspector toggle
    const inspectorSelect = document.getElementById('formInspector');
    const inspectorInput = document.getElementById('newInspectorInput');
    inspectorSelect.style.display = 'inline-block';
    inspectorSelect.setAttribute('required', 'required'); // Ensure select has required
    inspectorInput.style.display = 'none';
    inspectorInput.removeAttribute('required'); // Remove required from input
    inspectorInput.value = '';
    
    // Reset area toggle
    const areaSelect = document.getElementById('formArea');
    const areaInput = document.getElementById('newAreaInput');
    areaSelect.style.display = 'inline-block';
    areaSelect.setAttribute('required', 'required'); // Ensure select has required
    areaInput.style.display = 'none';
    areaInput.removeAttribute('required'); // Remove required from input
    areaInput.value = '';
    
    // Update area-based shops
    fillShopsDropdowns();
}

// --- Modal Management Functions ---
function closeInspectorsModal() {
    document.getElementById('inspectorsModal').style.display = 'none';
}

function closeAreasModal() {
    document.getElementById('areasModal').style.display = 'none';
}

function closeShopsModal() {
    document.getElementById('shopsModal').style.display = 'none';
}

function addNewInspector() {
    const nameInput = document.getElementById('newInspectorName');
    const name = nameInput.value.trim();
    if (!name) {
        alert('يرجى إدخال اسم المفتش');
        return;
    }
    
    if (inspectorsData.find(insp => insp.name === name)) {
        alert('هذا المفتش موجود بالفعل');
        return;
    }
    
    const newId = 'insp_' + Date.now();
    inspectorsData.push({id: newId, name: name});
    inspectors = inspectorsData.map(i => i.name);
    
    fillInspectorsDropdowns();
    displayInspectorsList();
    nameInput.value = '';
    saveDataToJSON();
}

function addNewArea() {
    const nameInput = document.getElementById('newAreaName');
    const name = nameInput.value.trim();
    if (!name) {
        alert('يرجى إدخال اسم المنطقة');
        return;
    }
    
    if (areasData.find(area => area.name === name)) {
        alert('هذه المنطقة موجودة بالفعل');
        return;
    }
    
    const newId = 'area_' + Date.now();
    areasData.push({id: newId, name: name});
    
    fillAreasDropdowns();
    displayAreasList();
    nameInput.value = '';
    saveDataToJSON();
}

function addNewShop() {
    const nameInput = document.getElementById('newShopName');
    const areaSelect = document.getElementById('newShopArea');
    const name = nameInput.value.trim();
    const areaId = areaSelect.value;
    
    if (!name || !areaId) {
        alert('يرجى إدخال اسم المحل واختيار المنطقة');
        return;
    }
    
    if (shopsData.find(shop => shop.name === name)) {
        alert('هذا المحل موجود بالفعل');
        return;
    }
    
    const newId = 'shop_' + Date.now();
    shopsData.push({id: newId, name: name, areaId: areaId});
    
    fillShopsDropdowns();
    displayShopsList();
    nameInput.value = '';
    areaSelect.value = '';
    saveDataToJSON();
}

function displayInspectorsList() {
    const container = document.getElementById('inspectorsList');
    let html = '';
    inspectorsData.forEach((inspector, index) => {
        html += `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee;">
                <span>${inspector.name}</span>
                <div style="display:flex;gap:4px;">
                    <button onclick="editInspector(${index})" style="background:#6c757d;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">تعديل</button>
                    <button onclick="deleteInspector(${index})" style="background:#dc3545;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">حذف</button>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function displayAreasList() {
    const container = document.getElementById('areasList');
    let html = '';
    areasData.forEach((area, index) => {
        html += `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee;">
                <span>${area.name}</span>
                <div style="display:flex;gap:4px;">
                    <button onclick="editArea(${index})" style="background:#6c757d;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">تعديل</button>
                    <button onclick="deleteArea(${index})" style="background:#dc3545;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">حذف</button>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function displayShopsList() {
    const container = document.getElementById('shopsList');
    let html = '';
    shopsData.forEach((shop, index) => {
        const area = areasData.find(a => a.id === shop.areaId);
        const areaName = area ? area.name : 'غير محدد';
        html += `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee;">
                <span>${shop.name} - ${areaName}</span>
                <div style="display:flex;gap:4px;">
                    <button onclick="editShop(${index})" style="background:#6c757d;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">تعديل</button>
                    <button onclick="deleteShop(${index})" style="background:#dc3545;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">حذف</button>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function deleteInspector(index) {
    if (confirm('هل أنت متأكد من حذف هذا المفتش؟')) {
        inspectorsData.splice(index, 1);
        inspectors = inspectorsData.map(i => i.name);
        fillInspectorsDropdowns();
        displayInspectorsList();
        saveDataToJSON();
    }
}

function editInspector(index) {
    const inspector = inspectorsData[index];
    const newName = prompt('تعديل اسم المفتش:', inspector.name);
    
    if (newName === null) return; // User cancelled
    
    const newNameTrimmed = newName.trim();
    if (!newNameTrimmed) {
        alert('يرجى إدخال اسم صحيح للمفتش');
        return;
    }
    
    // Check if name already exists (but not for the same inspector)
    const existingInspector = inspectorsData.find((i, idx) => i.name === newNameTrimmed && idx !== index);
    if (existingInspector) {
        alert('هذا المفتش موجود بالفعل');
        return;
    }
    
    // Update inspector data
    inspector.name = newNameTrimmed;
    inspectors = inspectorsData.map(i => i.name); // Update the inspectors array too
    
    fillInspectorsDropdowns();
    displayInspectorsList();
    saveDataToJSON();
}

function deleteArea(index) {
    if (confirm('هل أنت متأكد من حذف هذه المنطقة؟')) {
        areasData.splice(index, 1);
        fillAreasDropdowns();
        displayAreasList();
        saveDataToJSON();
    }
}

function editArea(index) {
    const area = areasData[index];
    const newName = prompt('تعديل اسم المنطقة:', area.name);
    
    if (newName === null) return; // User cancelled
    
    const newNameTrimmed = newName.trim();
    if (!newNameTrimmed) {
        alert('يرجى إدخال اسم صحيح للمنطقة');
        return;
    }
    
    // Check if name already exists (but not for the same area)
    const existingArea = areasData.find((a, i) => a.name === newNameTrimmed && i !== index);
    if (existingArea) {
        alert('هذه المنطقة موجودة بالفعل');
        return;
    }
    
    // Update area data
    area.name = newNameTrimmed;
    
    fillAreasDropdowns();
    displayAreasList();
    saveDataToJSON();
}

function deleteShop(index) {
    if (confirm('هل أنت متأكد من حذف هذا المحل؟')) {
        shopsData.splice(index, 1);
        fillShopsDropdowns();
        displayShopsList();
        saveDataToJSON();
    }
}

function editShop(index) {
    const shop = shopsData[index];
    const area = areasData.find(a => a.id === shop.areaId);
    
    const newName = prompt('تعديل اسم المحل:', shop.name);
    if (newName === null) return; // User cancelled
    
    const newNameTrimmed = newName.trim();
    if (!newNameTrimmed) {
        alert('يرجى إدخال اسم صحيح للمحل');
        return;
    }
    
    // Check if name already exists (but not for the same shop)
    const existingShop = shopsData.find((s, i) => s.name === newNameTrimmed && i !== index);
    if (existingShop) {
        alert('هذا المحل موجود بالفعل');
        return;
    }
    
    // Get new area
    const areaNames = areasData.map(a => a.name);
    const currentAreaName = area ? area.name : 'غير محدد';
    let selectedAreaName = currentAreaName;
    
    // Simple area selection using confirm dialogs (basic approach)
    let areaChoice = confirm(`المنطقة الحالية: ${currentAreaName}\nهل تريد تغيير المنطقة؟`);
    if (areaChoice) {
        let areaOptions = areaNames.join('\n');
        let newAreaName = prompt(`اختر المنطقة الجديدة:\n${areaOptions}`, currentAreaName);
        if (newAreaName !== null) {
            const newArea = areasData.find(a => a.name === newAreaName.trim());
            if (newArea) {
                selectedAreaName = newArea.name;
            } else {
                alert('المنطقة غير موجودة');
                return;
            }
        }
    }
    
    // Update shop data
    shop.name = newNameTrimmed;
    const selectedArea = areasData.find(a => a.name === selectedAreaName);
    if (selectedArea) {
        shop.areaId = selectedArea.id;
    }
    
    fillShopsDropdowns();
    displayShopsList();
    saveDataToJSON();
}

function saveDataToJSON() {
    // Save all data to localStorage as backup
    const allData = {
        inspectionData: inspectionData,
        inspectors: inspectorsData,
        areas: areasData,
        shops: shopsData,
        bellNotes: bellNotesData,
        lastUpdate: new Date().toISOString()
    };
    localStorage.setItem('allPlanData', JSON.stringify(allData));
    
    // In developer mode, also trigger external file save
    if (isDev) {
        // Show a notification that data needs to be saved externally
        showUpdateMessage('تم الحفظ محلياً - استخدم زر "تصدير البيانات" لحفظ التغييرات نهائياً');
        console.log('Data saved to localStorage - developer should export for permanent save');
    } else {
        console.log('Data saved to localStorage');
    }
}

// Call loadInspectionData when the DOM is ready  
// Note: This is already handled in the main DOMContentLoaded event listener above
</script>

<!-- Backup initialization script to ensure functionality works -->
<script>
(function() {
    // Backup inspector data in case main script fails
    if (typeof inspectorsData === 'undefined') {
        window.inspectorsData = [
            {id:"insp_1758813880098", name:"د. علي عبدالعال"},
            {id:"insp_1758830925093", name:"د. محمد إسماعيل"},
            {id:"insp_1758830939296", name:"د. محمد سعيد"},
            {id:"insp_1758830950586", name:"د. فايز المسالمة"},
            {id:"insp_1758830963007", name:"د. آيه سلامة"},
            {id:"insp_1758830974747", name:"د. آمنه بن صرم"},
            {id:"insp_1758830985608", name:"د. حصة العلي"},
            {id:"insp_1758830999876", name:"د. حسينة العامري"},
            {id:"insp_1758831014928", name:"د. هاجر الغافري"}
        ];
        window.inspectors = window.inspectorsData.map(i => i.name);
    }
    
    // Backup function to fill inspector dropdown
    function ensureInspectorDropdownFilled() {
        const inspectorSelect = document.getElementById('inspectorSelect');
        if (inspectorSelect && inspectorSelect.options.length <= 1) {
            inspectorSelect.innerHTML = '<option value="">-- اختر المفتش --</option>';
            window.inspectorsData.forEach(inspector => {
                inspectorSelect.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
            });
        }
    }
    
    // Backup function to ensure developer login functionality
    function ensureDeveloperLoginWorks() {
        const loginRole = document.getElementById('loginRole');
        const devPassword = document.getElementById('devPassword');
        const devLoginBtn = document.getElementById('devLoginBtn');
        
        if (loginRole && !loginRole.onchangeBackup) {
            loginRole.onchangeBackup = true;
            loginRole.addEventListener('change', function() {
                const role = this.value;
                document.getElementById('devError').innerText = '';
                
                if(role === 'developer') {
                    document.getElementById('devPassword').style.display = 'inline-block';
                    document.getElementById('devLoginBtn').style.display = 'inline-block';
                    document.getElementById('devLogoutBtn').style.display = 'none';
                    document.getElementById('devSection').style.display = 'none';
                    window.isDev = false;
                } else {
                    document.getElementById('devPassword').style.display = 'none';
                    document.getElementById('devLoginBtn').style.display = 'none';
                    document.getElementById('devLogoutBtn').style.display = 'none';
                    document.getElementById('devSection').style.display = 'none';
                    window.isDev = false;
                }
            });
        }
        
        if (devLoginBtn && !devLoginBtn.onclickBackup) {
            devLoginBtn.onclickBackup = true;
            devLoginBtn.onclick = function() {
                const pw = document.getElementById('devPassword').value.trim();
                const DEV_PASSWORD = '1983';
                
                if (pw === DEV_PASSWORD) {
                    window.isDev = true;
                    isDev = true;
                    setLastUpdateDate();
                    document.getElementById('devSection').style.display = 'block';
                    document.getElementById('devLogoutBtn').style.display = 'inline-block';
                    document.getElementById('devPassword').style.display = 'none';
                    document.getElementById('devLoginBtn').style.display = 'none';
                    document.getElementById('devError').innerText = '';
                } else {
                    document.getElementById('devError').innerText = 'كلمة السر غير صحيحة!';
                }
            };
        }
        
        const devLogoutBtn = document.getElementById('devLogoutBtn');
        if (devLogoutBtn && !devLogoutBtn.onclickBackup) {
            devLogoutBtn.onclickBackup = true;
            devLogoutBtn.onclick = function() {
                window.isDev = false;
                document.getElementById('devSection').style.display = 'none';
                document.getElementById('devLogoutBtn').style.display = 'none';
                document.getElementById('devPassword').style.display = 'none';
                document.getElementById('devLoginBtn').style.display = 'none';
                document.getElementById('loginRole').value = '';
                document.getElementById('devError').innerText = '';
            };
        }
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                ensureInspectorDropdownFilled();
                ensureDeveloperLoginWorks();
            }, 100);
        });
    } else {
        setTimeout(function() {
            ensureInspectorDropdownFilled();
            ensureDeveloperLoginWorks();
        }, 100);
    }
})();
</script> 
</body>
</html>
