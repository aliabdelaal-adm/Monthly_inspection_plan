<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    
    <!-- Cache Control Meta Tags - Prevent browser caching for instant updates -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- SEO Optimization Meta Tags -->
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <meta name="bingbot" content="index, follow">
    <meta name="description" content="ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© - ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© Ÿàÿ™ŸÜÿ∏ŸäŸÖ ÿÆÿ∑ÿ∑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© ŸÑŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸàÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ŸàÿßŸÑŸÖÿ≠ŸÑÿßÿ™. Monthly Inspection Plan - Management system for organizing monthly inspection schedules for inspectors, areas and shops.">
    <meta name="keywords" content="ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©, Monthly Inspection Plan, ÿ™ŸÅÿ™Ÿäÿ¥, inspection, ÿÆÿ∑ÿ©, plan, ŸÖŸÅÿ™ÿ¥, inspector, ŸÖŸÜÿ∑ŸÇÿ©, area, ŸÖÿ≠ŸÑ, shop">
    <meta name="author" content="ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ - Ali Abdelaal">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© - Monthly Inspection Plan">
    <meta property="og:description" content="ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© Ÿàÿ™ŸÜÿ∏ŸäŸÖ ÿÆÿ∑ÿ∑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© ŸÑŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸàÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ŸàÿßŸÑŸÖÿ≠ŸÑÿßÿ™ - Management system for organizing monthly inspection schedules">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://aliabdelaal-adm.github.io/Monthly_inspection_plan/">
    <meta property="og:site_name" content="ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©">
    <meta property="og:locale" content="ar_AE">
    <meta property="og:locale:alternate" content="en_US">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© - Monthly Inspection Plan">
    <meta name="twitter:description" content="ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© Ÿàÿ™ŸÜÿ∏ŸäŸÖ ÿÆÿ∑ÿ∑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© ŸÑŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸàÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ŸàÿßŸÑŸÖÿ≠ŸÑÿßÿ™">
    
    <!-- Additional SEO Tags -->
    <link rel="canonical" href="https://aliabdelaal-adm.github.io/Monthly_inspection_plan/">
    <meta name="theme-color" content="#2336a0">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json?v=1.1.0">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="./icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿä">
    
    <!-- Structured Data JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©",
      "alternateName": "Monthly Inspection Plan",
      "description": "ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© Ÿàÿ™ŸÜÿ∏ŸäŸÖ ÿÆÿ∑ÿ∑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© ŸÑŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸàÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ŸàÿßŸÑŸÖÿ≠ŸÑÿßÿ™",
      "url": "https://aliabdelaal-adm.github.io/Monthly_inspection_plan/",
      "applicationCategory": "BusinessApplication",
      "operatingSystem": "Web Browser",
      "inLanguage": ["ar", "en"],
      "author": {
        "@type": "Person",
        "name": "ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ",
        "alternateName": "Ali Abdelaal"
      },
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "5.0",
        "ratingCount": "1"
      }
    }
    </script>
    
    <!-- ÿÆÿ∑ Cairo ŸÖŸÜ Google Fonts ŸÖÿπ ÿÆÿ∑Ÿàÿ∑ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿπŸÜŸàÿßŸÜ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Amiri:wght@400;700&family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    
    <!-- ŸÖŸÉÿ™ÿ®ÿßÿ™ ÿßŸÑÿ™ÿµÿØŸäÿ± -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- ŸÖŸÉÿ™ÿ®ÿ© PDF.js ŸÑŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅÿßÿ™ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { 
            font-family: 'Cairo', Arial, sans-serif; 
            background: linear-gradient(135deg, #e8f0fe 0%, #f0e8ff 50%, #e8fff0 100%);
            margin:0;
            position: relative;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Animated Background Shapes */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                /* Lock icons */
                radial-gradient(circle at 10% 20%, rgba(66, 133, 244, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.08) 0%, transparent 50%);
            animation: backgroundShift 20s ease-in-out infinite;
        }
        
        @keyframes backgroundShift {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            50% {
                transform: translate(20px, 20px) scale(1.05);
                opacity: 0.8;
            }
        }
        
        /* Floating AI-themed shapes */
        .bg-shape {
            position: fixed;
            opacity: 0.12;
            z-index: -1;
            pointer-events: none;
        }
        
        /* Cloud shapes */
        .cloud {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            animation: float 25s ease-in-out infinite;
        }
        
        .cloud-1 {
            width: 80px;
            height: 80px;
            top: 15%;
            left: 10%;
            animation-delay: 0s;
        }
        
        .cloud-2 {
            width: 100px;
            height: 100px;
            top: 60%;
            right: 15%;
            animation-delay: 5s;
        }
        
        .cloud-3 {
            width: 60px;
            height: 60px;
            bottom: 20%;
            left: 20%;
            animation-delay: 10s;
        }
        
        /* Lock shapes */
        .lock {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 20%;
            animation: float 30s ease-in-out infinite;
        }
        
        .lock-1 {
            width: 50px;
            height: 50px;
            top: 25%;
            right: 20%;
            animation-delay: 2s;
        }
        
        .lock-2 {
            width: 40px;
            height: 40px;
            bottom: 30%;
            right: 10%;
            animation-delay: 7s;
        }
        
        /* AI/Brain shapes */
        .ai-shape {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            animation: morphFloat 28s ease-in-out infinite;
        }
        
        .ai-1 {
            width: 90px;
            height: 90px;
            top: 40%;
            left: 8%;
            animation-delay: 3s;
        }
        
        .ai-2 {
            width: 70px;
            height: 70px;
            bottom: 15%;
            right: 25%;
            animation-delay: 8s;
        }
        
        /* Gear/Tech shapes */
        .tech-shape {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 20%;
            animation: rotate360 40s linear infinite;
        }
        
        .tech-1 {
            width: 60px;
            height: 60px;
            top: 70%;
            left: 30%;
            animation-delay: 4s;
        }
        
        .tech-2 {
            width: 45px;
            height: 45px;
            top: 10%;
            right: 30%;
            animation-delay: 9s;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                transform: translate(30px, -30px) rotate(5deg);
            }
            50% {
                transform: translate(-20px, -50px) rotate(-5deg);
            }
            75% {
                transform: translate(20px, -30px) rotate(3deg);
            }
        }
        
        @keyframes morphFloat {
            0%, 100% {
                transform: translate(0, 0);
                border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            }
            25% {
                transform: translate(40px, -40px);
                border-radius: 70% 30% 30% 70% / 70% 70% 30% 30%;
            }
            50% {
                transform: translate(-30px, -60px);
                border-radius: 50% 50% 50% 50% / 50% 50% 50% 50%;
            }
            75% {
                transform: translate(30px, -40px);
                border-radius: 40% 60% 60% 40% / 60% 40% 40% 60%;
            }
        }
        
        @keyframes rotate360 {
            from {
                transform: rotate(0deg) translate(20px, 20px);
            }
            to {
                transform: rotate(360deg) translate(20px, 20px);
            }
        }
        .main-container {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 2px 16px #dadce0;
            padding: 36px 24px 24px 24px;
            max-width: 1200px;
            min-width:320px;
            margin: 48px auto 24px auto;
            display: flex; flex-direction: column; align-items: center;
            width: 95%;
        }
        .header-top-bar {
            width:100%;
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom: 8px;
            position: relative;
        }
        .last-update-row {
            color: #666;
            font-size: 0.97em;
            margin-right: 8px;
            margin-top: 0;
            text-align: right;
            direction: ltr;
        }
        .bell-container {
            margin-left:8px;
            margin-top:0;
        }
        .bell-btn {
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
            padding: 8px;
            transition: transform 0.2s;
            font-size: 28px;
        }
        .bell-btn:hover {
            transform: scale(1.1);
        }
        .bell-btn:active {
            transform: scale(0.95);
        }
        
        /* Simple Bell Animation */
        @keyframes bellRing {
            0% { transform: rotate(0deg); }
            10% { transform: rotate(-10deg); }
            20% { transform: rotate(10deg); }
            30% { transform: rotate(-8deg); }
            40% { transform: rotate(8deg); }
            50% { transform: rotate(-4deg); }
            60% { transform: rotate(4deg); }
            70% { transform: rotate(-2deg); }
            80% { transform: rotate(2deg); }
            100% { transform: rotate(0deg); }
        }
        
        .bell-ringing {
            animation: bellRing 0.8s ease-in-out;
        }
        
        /* Bell Notes Modal */
        .bell-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .bell-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .bell-bubble {
            background: #fff;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.1);
            position: relative;
            transform: scale(0.8);
            animation: bubbleAppear 0.3s ease forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes bubbleAppear {
            from { 
                transform: scale(0.8);
                opacity: 0;
            }
            to { 
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .bell-bubble::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50px;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 15px solid #fff;
        }
        
        .bell-bubble h3 {
            margin: 0 0 20px 0;
            color: #234085;
            font-size: 1.4em;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .bell-bubble h3::before {
            content: 'üîî';
            font-size: 1.2em;
        }
        
        .bell-notes-textarea {
            width: 100%;
            min-height: 200px;
            border: 2px solid #e0e3ea;
            border-radius: 12px;
            padding: 15px;
            font-size: 1.1em;
            font-family: inherit;
            resize: vertical;
            outline: none;
            transition: border-color 0.3s;
            line-height: 1.6;
            font-weight: 500;
        }
        
        .bell-notes-textarea:focus {
            border-color: #234085;
            box-shadow: 0 0 0 3px rgba(35, 64, 133, 0.1);
        }
        
        .bell-bubble-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .bell-action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 100px;
        }
        
        .bell-save-btn {
            background: #28a745;
            color: white;
        }
        
        .bell-save-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .bell-clear-btn {
            background: #ffc107;
            color: #212529;
        }
        
        .bell-clear-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .bell-close-btn {
            background: #6c757d;
            color: white;
        }
        
        .bell-close-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .bell-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #1565c0;
            text-align: center;
        }
        .horizontal-line {
            width: 100%;
            border: none;
            border-top: 1.5px solid #e0e3ea;
            margin: 16px 0 0 0;
        }
        .title-bar {
            width:100%;
            display:flex;
            justify-content:center;
            align-items:center;
            margin-top: 6px;
            margin-bottom: 8px;
        }
        .main-title-box {
            background: linear-gradient(145deg, #1a2c5b 0%, #234085 25%, #2d4d99 50%, #3f5aa6 75%, #4a67b3 100%);
            color:#fff;
            padding:18px 16px;
            border-radius:16px;
            width: 96%;
            max-width: 620px;
            min-height: 64px;
            font-size:2.6em;
            font-family: 'Tajawal', 'Amiri', 'Cairo', Arial, sans-serif;
            text-align:center;
            font-weight: 800;
            letter-spacing: 0.5px;
            word-spacing: 2px;
            margin:0 auto;
            box-shadow: 0 8px 32px rgba(26, 44, 91, 0.4), 
                        0 4px 16px rgba(35, 64, 133, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            line-height: 1.3;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3),
                        0 1px 2px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        .main-title-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.8s ease;
        }
        
        .main-title-box:hover::before {
            left: 100%;
        }
        
        .main-title-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(26, 44, 91, 0.5), 
                        0 6px 20px rgba(35, 64, 133, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Glittering and shimmer animations for main title */
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 8px 32px rgba(26, 44, 91, 0.4), 
                            0 4px 16px rgba(35, 64, 133, 0.3),
                            inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }
            50% { 
                box-shadow: 0 12px 48px rgba(26, 44, 91, 0.8), 
                            0 6px 24px rgba(35, 64, 133, 0.7),
                            inset 0 1px 0 rgba(255, 255, 255, 0.3),
                            0 0 40px rgba(74, 103, 179, 0.8),
                            0 0 60px rgba(74, 103, 179, 0.5);
            }
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        .main-title-box::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.4), 
                transparent);
            animation: shimmer 3s ease-in-out infinite;
            z-index: 1;
        }
        
        /* Sheikh Zayed Audio Message Styles */
        .sheikh-zayed-message-container {
            width: auto;
            max-width: 300px;
            margin: 0 auto 6px auto;
            padding: 0;
            background: transparent;
            border-radius: 0;
            border: none;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
        }
        
        .sheikh-zayed-label {
            display: none;
        }
        
        .play-sheikh-zayed-btn {
            background: linear-gradient(145deg, #28a745 0%, #218838 100%);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            transition: all 0.3s ease;
            font-family: 'Cairo', Arial, sans-serif;
        }
        
        .play-sheikh-zayed-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
            background: linear-gradient(145deg, #218838 0%, #1e7e34 100%);
        }
        
        .play-sheikh-zayed-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        
        .login-section, .inspector-select-section {margin: 5px 0 6px 0; width: 100%; display:flex;justify-content:center;align-items:center;gap:10px;}
        
        /* Login and Inspector labels - desktop only */
        .login-label, .inspector-label {
            font-weight: 600;
            color: #234085;
            font-size: 1.1em;
            display: none; /* Hidden by default (mobile) */
        }
        
        /* Show labels on desktop */
        @media (min-width: 769px) {
            .login-label, .inspector-label {
                display: inline-block;
            }
        }
        
        /* Hide labels on mobile */
        @media (max-width: 768px) {
            .login-label, .inspector-label {
                display: none;
            }
        }
        select, input[type="text"], input[type="date"], input[type="password"] {padding:7px 16px;font-size:1em;border-radius:6px;border:1px solid #b6b6b6;min-width:130px;max-width:210px;}
        
        /* Remove yellow background from login and inspector dropdowns - keep only for shop dropdowns */
        #loginRole, #inspectorSelect, #formInspector, #cloneInspector,
        #reportInspectorSelect, #scheduleInspectorFilter, #shopsPerInspector,
        #batchOldInspector, #batchNewInspector {
            background: #ffffff;
        }
        
        /* Add yellow background to dropdown options for login and inspector selects */
        /* Exclude first option (value="") to keep it white */
        #loginRole option:not([value=""]), 
        #inspectorSelect option:not([value=""]),
        #formInspector option:not([value=""]),
        #cloneInspector option:not([value=""]),
        #reportInspectorSelect option:not([value=""]),
        #scheduleInspectorFilter option:not([value=""]),
        #shopsPerInspector option:not([value=""]),
        #batchOldInspector option:not([value=""]),
        #batchNewInspector option:not([value=""]) {
            background: #ffff00 !important;
            background-color: #ffff00 !important;
            color: #000000 !important;
        }
        
        /* Ensure first option (placeholder) stays white */
        #loginRole option[value=""], 
        #inspectorSelect option[value=""],
        #formInspector option[value=""],
        #cloneInspector option[value=""],
        #reportInspectorSelect option[value=""],
        #scheduleInspectorFilter option[value=""],
        #shopsPerInspector option[value=""],
        #batchOldInspector option[value=""],
        #batchNewInspector option[value=""] {
            background: #ffffff !important;
            background-color: #ffffff !important;
            color: #333333 !important;
        }
        
        /* Enhanced multi-select styling for better visibility */
        select[multiple] {
            padding: 8px;
            font-size: 1.05em;
            line-height: 1.6;
            border: 2px solid #007bff;
            background: #f8f9fa;
            font-family: 'Cairo', Arial, sans-serif;
        }
        
        select[multiple] option {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            background: #fff;
            border: 1px solid #e0e0e0;
            white-space: normal;
            word-wrap: break-word;
            min-height: 2.5em;
        }
        
        select[multiple] option:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        select[multiple] option:checked {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            font-weight: 600;
            border-color: #0056b3;
        }
        
        select[multiple] optgroup {
            font-weight: 700;
            font-size: 1.05em;
            color: #234085;
            background: #e8f4f8;
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
        }
        
        select[multiple] optgroup option {
            font-weight: 500;
            margin-right: 15px;
            background: #fff;
        }
        
        /* Custom dropdown for form shops selection - Overflows container */
        .custom-shops-dropdown {
            position: relative;
            width: 100%;
        }
        
        .custom-shops-trigger {
            width: 100%;
            min-height: 48px;
            padding: 10px 40px 10px 12px;
            background: #f8f9fa;
            border: 2px solid #007bff;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cairo', Arial, sans-serif;
            font-size: 1em;
            text-align: right;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .custom-shops-trigger:hover {
            background: #e3f2fd;
            border-color: #0056b3;
        }
        
        .custom-shops-trigger.active {
            border-color: #0056b3;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .custom-shops-trigger-text {
            flex: 1;
            color: #495057;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .custom-shops-trigger-text.placeholder {
            color: #6c757d;
        }
        
        .custom-shops-trigger-icon {
            margin-left: 8px;
            font-size: 0.8em;
            transition: transform 0.2s ease;
        }
        
        .custom-shops-trigger.active .custom-shops-trigger-icon {
            transform: rotate(180deg);
        }
        
        .custom-shops-dropdown-menu {
            display: none;
            position: fixed;
            background: #ffff00;
            border: 2px solid #007bff;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.2);
            z-index: 10000;
            max-height: 400px;
            min-width: 350px;
            max-width: 600px;
            overflow-y: auto;
            font-family: 'Cairo', Arial, sans-serif;
        }
        
        .custom-shops-dropdown-menu.show {
            display: block;
        }
        
        .custom-shops-search {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
        }
        
        .custom-shops-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: 'Cairo', Arial, sans-serif;
            font-size: 0.9em;
        }
        
        .custom-shops-group {
            margin: 0;
        }
        
        .custom-shops-group-label {
            padding: 10px 15px;
            background: #e8f4f8;
            color: #234085;
            font-weight: 700;
            font-size: 0.95em;
            border-bottom: 1px solid #d0e8f0;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .custom-shops-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .custom-shops-option:hover {
            background: #e3f2fd;
        }
        
        .custom-shops-option.selected {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            font-weight: 600;
        }
        
        .custom-shops-option-text {
            flex: 1;
            word-wrap: break-word;
            white-space: normal;
        }
        
        .custom-shops-option-check {
            margin-left: 10px;
            font-size: 1.2em;
            display: none;
        }
        
        .custom-shops-option.selected .custom-shops-option-check {
            display: inline;
        }
        
        .custom-shops-dropdown-footer {
            padding: 10px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            bottom: 0;
            z-index: 1;
        }
        
        .custom-shops-dropdown-footer button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Cairo', Arial, sans-serif;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }
        
        .custom-shops-select-all {
            background: #17a2b8;
            color: white;
        }
        
        .custom-shops-select-all:hover {
            background: #138496;
        }
        
        .custom-shops-clear {
            background: #6c757d;
            color: white;
        }
        
        .custom-shops-clear:hover {
            background: #5a6268;
        }
        
        .custom-shops-close {
            background: #28a745;
            color: white;
            padding: 6px 16px;
        }
        
        .custom-shops-close:hover {
            background: #218838;
        }
        
        .actions-row {
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0 18px;
        }
        .actions-line {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            width: 100%;
            max-width: 900px;
        }
        
        /* Smart Icon Button Design */
        .icon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 90px;
            height: 90px;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 0.75em;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        .icon-btn:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.6s;
            opacity: 0;
        }
        
        .icon-btn:hover:before {
            animation: shimmer 0.6s ease-in-out;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); opacity: 0; }
        }
        
        .icon-btn:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25);
        }
        
        .icon-btn:active {
            transform: translateY(-4px) scale(1.02);
            transition: all 0.1s;
        }
        
        /* Enhanced 3D and animation effects for icon buttons */
        @keyframes bounce-icon {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes rotate-icon {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse-shadow {
            0%, 100% { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
            50% { box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 255, 255, 0.2); }
        }
        
        .icon-btn {
            animation: pulse-shadow 3s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        
        .icon-btn:hover {
            transform: translateY(-8px) scale(1.05) rotateX(5deg);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25), 
                        0 0 30px rgba(255, 255, 255, 0.15);
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }
        
        .icon-btn .icon {
            font-size: 2.2em;
            margin-bottom: 6px;
            display: block;
            transition: all 0.4s ease;
        }
        
        .icon-btn:hover .icon {
            animation: bounce-icon 0.6s ease-in-out;
        }
        
        .icon-btn .label {
            font-size: 0.85em;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        /* Individual Icon Button Colors */
        .refresh-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: #fff;
        }
        .refresh-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1ba085 100%);
        }
        
        .inspector-report-btn {
            background: linear-gradient(135deg, #234085 0%, #3b82f6 100%);
            color: #fff;
        }
        .inspector-report-btn:hover {
            background: linear-gradient(135deg, #1a2f5f 0%, #2563eb 100%);
        }
        
        .monthly-report-btn {
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
            color: #fff;
        }
        .monthly-report-btn:hover {
            background: linear-gradient(135deg, #e68900 0%, #ff9800 100%);
        }
        
        .enhanced-report-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            color: #fff;
        }
        .enhanced-report-btn:hover {
            background: linear-gradient(135deg, #138496 0%, #1ba085 100%);
        }
        
        /* Enhanced Shop Priority Icon Button - ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿ£ŸäŸÇŸàŸÜÿ© ÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ */
        @keyframes shop-priority-glow {
            0%, 100% { 
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4),
                            0 0 15px rgba(118, 75, 162, 0.3),
                            0 0 25px rgba(102, 126, 234, 0.2);
            }
            50% { 
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.8),
                            0 0 30px rgba(118, 75, 162, 0.6),
                            0 0 40px rgba(255, 215, 0, 0.5),
                            0 0 50px rgba(102, 126, 234, 0.4);
            }
        }
        
        @keyframes shop-priority-icon-sparkle {
            0%, 100% { 
                transform: translateY(0) scale(1) rotate(0deg);
                filter: brightness(1) drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
            }
            25% { 
                transform: translateY(-3px) scale(1.15) rotate(-5deg);
                filter: brightness(1.3) drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
            }
            50% { 
                transform: translateY(0) scale(1.2) rotate(5deg);
                filter: brightness(1.5) drop-shadow(0 0 15px rgba(255, 215, 0, 1));
            }
            75% { 
                transform: translateY(-3px) scale(1.15) rotate(-5deg);
                filter: brightness(1.3) drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
            }
        }
        
        @keyframes shop-priority-shine-sweep {
            0% { 
                left: -100%;
                opacity: 0;
            }
            40% { 
                opacity: 1;
            }
            100% { 
                left: 200%;
                opacity: 0;
            }
        }
        
        @keyframes shop-priority-border-pulse {
            0%, 100% { 
                border-color: rgba(255, 215, 0, 0.6);
            }
            50% { 
                border-color: rgba(255, 215, 0, 1);
            }
        }
        
        @keyframes shop-priority-sparkles-orbit {
            0% { 
                transform: rotate(0deg) translateX(45px) rotate(0deg);
                opacity: 0;
            }
            10%, 90% {
                opacity: 1;
            }
            100% { 
                transform: rotate(360deg) translateX(45px) rotate(-360deg);
                opacity: 0;
            }
        }
        
        .shop-priority-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            position: relative;
            overflow: visible !important; /* Allow sparkles to show outside */
            border: 2px solid rgba(255, 215, 0, 0.6) !important;
            animation: shop-priority-glow 2s ease-in-out infinite,
                       shop-priority-border-pulse 2s ease-in-out infinite;
        }
        
        /* Shine sweep effect overlay */
        .shop-priority-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 80%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.7), 
                transparent);
            animation: shop-priority-shine-sweep 3s ease-in-out infinite;
            z-index: 1;
            pointer-events: none;
        }
        
        /* Orbiting sparkles around button */
        .shop-priority-btn::after {
            content: '‚ú®';
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 1.2em;
            animation: shop-priority-sparkles-orbit 4s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        
        /* Make icon sparkle continuously */
        .shop-priority-btn .icon {
            animation: shop-priority-icon-sparkle 2s ease-in-out infinite;
            position: relative;
            z-index: 2;
        }
        
        /* Make label stand out */
        .shop-priority-btn .label {
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3),
                         0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .shop-priority-btn:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f92 100%);
            transform: translateY(-10px) scale(1.1) !important;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 1),
                        0 0 50px rgba(118, 75, 162, 0.9),
                        0 0 60px rgba(255, 215, 0, 0.7) !important;
            border-color: rgba(255, 215, 0, 1) !important;
        }
        
        .shop-priority-btn:hover .icon {
            animation: shop-priority-icon-sparkle 0.5s ease-in-out infinite;
            transform: scale(1.3) rotate(10deg) !important;
        }
        
        .monthly-schedule-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%);
            color: #fff;
        }
        .monthly-schedule-btn:hover {
            background: linear-gradient(135deg, #5936a3 0%, #7d3c98 100%);
        }
        
        .smart-rotation-btn {
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
            color: #fff;
        }
        .smart-rotation-btn:hover {
            background: linear-gradient(135deg, #1ba085 0%, #138496 100%);
        }
        
        .vacation-tracker-btn {
            background: linear-gradient(135deg, #ff8c00 0%, #ff6b35 100%);
            color: #fff;
        }
        .vacation-tracker-btn:hover {
            background: linear-gradient(135deg, #e6750a 0%, #e55a30 100%);
        }
        
        .shops-management-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #9c27b0 100%);
            color: #fff;
        }
        .shops-management-btn:hover {
            background: linear-gradient(135deg, #5936a3 0%, #8e24aa 100%);
        }
        
        .pdf-btn {
            background: linear-gradient(135deg, #d63384 0%, #e91e63 100%);
            color: #fff;
        }
        .pdf-btn:hover {
            background: linear-gradient(135deg, #b02a5b 0%, #c2185b 100%);
        }
        
        .excel-btn {
            background: linear-gradient(135deg, #198754 0%, #28a745 100%);
            color: #fff;
        }
        .excel-btn:hover {
            background: linear-gradient(135deg, #146c43 0%, #218838 100%);
        }
        
        .preview-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #8a2be2 100%);
            color: #fff;
        }
        .preview-btn:hover {
            background: linear-gradient(135deg, #5a37a1 0%, #7b1fa2 100%);
        }
        
        .print-btn {
            background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
            color: #fff;
        }
        .print-btn:hover {
            background: linear-gradient(135deg, #5a6268 0%, #6c757d 100%);
        }
        
        .files-btn {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            color: #fff;
        }
        .files-btn:hover {
            background: linear-gradient(135deg, #7d3c98 0%, #8e4ec6 100%);
        }
        
        /* System Services Management Styles */
        .system-services-container {
            width: 100%;
            margin: 25px 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid #dee2e6;
        }
        
        .system-services-header {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 12px 20px;
            background: linear-gradient(135deg, #234085 0%, #3b82f6 100%);
            color: white;
            border-radius: 12px;
            transition: all 0.3s ease;
            user-select: none;
            font-weight: 600;
            font-size: 1.1em;
            position: relative;
        }
        
        .system-services-header::after {
            content: '‚ñº'; /* ŸÖÿ§ÿ¥ÿ± ÿ≥ŸáŸÖ ŸÑŸÑÿ£ÿ≥ŸÅŸÑ */
            position: absolute;
            right: 15px;
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }
        
        .system-services-header.collapsed::after {
            transform: rotate(-90deg); /* ÿ≥ŸáŸÖ ŸÑŸÑŸäŸÖŸäŸÜ ÿπŸÜÿØ ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ */
        }
        
        .system-services-header:hover {
            background: linear-gradient(135deg, #1a2f5f 0%, #2563eb 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(35, 64, 133, 0.3);
        }
        
        .system-services-icon {
            font-size: 1.5em;
            margin-left: 10px;
            transition: transform 0.3s ease;
        }
        
        .system-services-content {
            max-height: 800px; /* ÿ™ŸÖ ÿ™Ÿàÿ≥Ÿäÿπ ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäÿßŸã */
            padding: 20px; /* ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≠ÿ¥Ÿà ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäÿßŸã */
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
            background: white;
            border-radius: 0 0 12px 12px;
            margin-top: 2px;
        }
        
        .system-services-content.expanded {
            max-height: 800px;
            padding: 20px;
        }
        
        .services-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding: 10px;
        }
        
        .service-category {
            display: contents; /* Remove the category container, let icons flow directly */
        }
        
        .service-category.developer-only-category {
            display: none; /* Hide developer-only categories by default */
        }
        
        .service-category-title {
            display: none; /* Hide category titles to create a single row layout */
        }
        
        .service-icons-grid {
            display: contents; /* Remove the grid container, let icons flow directly */
        }
        
        /* Tooltip Styles */
        .tooltip {
            position: relative;
        }
        
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8em;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 1000;
            pointer-events: none;
        }
        
        .tooltip::before {
            content: '';
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-bottom-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .tooltip:hover::after,
        .tooltip:hover::before {
            opacity: 1;
            visibility: visible;
        }
        
        /* Separate Page Styles within System Services */
        .service-page {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid #dee2e6;
            position: relative;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .service-page.active {
            display: block;
        }
        
        .service-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .service-page-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #234085;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .service-page-close {
            background: #dc3545;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-weight: bold;
            line-height: 1;
            padding: 0;
            flex-shrink: 0;
            z-index: 5;
        }
        
        .service-page-close:hover {
            background: #c82333;
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .plan-table-container {
            width:100%;
            margin:6px auto;
            overflow-x:auto;
            overflow-y:visible;
            display: flex;
            justify-content: center;
            padding-right: 20px; /* ÿ•ÿ≤ÿßÿ≠ÿ© ÿßŸÑÿ¨ÿØŸàŸÑ ŸÇŸÑŸäŸÑÿßŸã ŸÜÿßÿ≠Ÿäÿ© ÿßŸÑŸäŸÖŸäŸÜ */
        }
        .plan-table {
            width:100%;
            max-width: 1150px;
            margin: 0 auto;
            border-collapse:collapse;
            border-radius:13px;
            overflow:visible;
            box-shadow:0 4px 20px rgba(35, 64, 133, 0.15);
            border:1px solid #e1e8ff;
            font-family: 'Cairo', Arial, sans-serif;
        }
        .plan-table th {
            background:linear-gradient(135deg, #234085 0%, #2d4d99 100%);
            color:#fff;
            font-weight:600;
            font-size:0.9em;
            padding:10px 8px;
            text-align:center;
            border-bottom:2px solid #1a2f5f;
            position:relative;
            text-shadow:0 1px 2px rgba(0,0,0,0.2);
        }
        .plan-table th:not(:last-child):after {
            content:'';
            position:absolute;
            right:0;
            top:25%;
            height:50%;
            width:1px;
            background:rgba(255,255,255,0.2);
        }
        
        /* Enhanced borders for specific header columns */
        .plan-table th:nth-child(1), 
        .plan-table th:nth-child(2), 
        .plan-table th:nth-child(3), 
        .plan-table th:nth-child(4) {
            border-right: 2px solid rgba(255,255,255,0.3);
        }
        .plan-table td {
            padding:8px 6px;
            border-bottom:1px solid #e6ecf5;
            font-size:0.85em;
            vertical-align:middle;
            transition:background-color 0.2s ease;
            height: auto;
        }
        .plan-table tr:hover {
            background:linear-gradient(90deg, #f0f4ff 0%, #fafbff 100%);
            transform:translateY(-1px);
            box-shadow:0 2px 8px rgba(35, 64, 133, 0.1);
        }
        .plan-table tbody tr:nth-child(even) {
            background:#fffacd;
        }
        .plan-table tbody tr:nth-child(odd) {
            background:#ffffff;
        }
        
        /* Desktop column widths - optimized for content */
        .plan-table th:nth-child(1), .plan-table td:nth-child(1) { /* ÿßŸÑŸÖŸÅÿ™ÿ¥ */
            width: 25%;
            min-width: 160px;
            white-space: nowrap;
            font-size: 0.75em;
            border-right: 1px solid rgba(35, 64, 133, 0.12);
        }
        .plan-table th:nth-child(2), .plan-table td:nth-child(2) { /* ÿßŸÑÿ™ÿßÿ±ŸäÿÆ */
            width: 14%;
            min-width: 110px;
            white-space: nowrap;
            font-size: 0.75em;
            border-right: 1px solid rgba(35, 64, 133, 0.12);
        }
        .plan-table th:nth-child(3), .plan-table td:nth-child(3) { /* ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ© */
            width: 12%;
            min-width: 85px;
            white-space: nowrap;
            font-size: 0.82em;
            border-right: 1px solid rgba(35, 64, 133, 0.12);
            text-align: center;
        }
        .plan-table th:nth-child(4), .plan-table td:nth-child(4) { /* ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© */
            width: 22%;
            min-width: 180px;
            white-space: normal;
            word-wrap: break-word;
            font-size: 0.82em;
            border-right: 1px solid rgba(35, 64, 133, 0.12);
        }
        .plan-table th:nth-child(5), .plan-table td:nth-child(5) { /* ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ */
            width: 32%;
            min-width: 130px;
            overflow: visible;
            position: relative;
            font-size: 0.82em;
        }
        
        /* Desktop table data cell backgrounds - only for td elements */
        .plan-table td:nth-child(1) { /* ÿßŸÑŸÖŸÅÿ™ÿ¥ */
            background: linear-gradient(135deg, rgba(250, 251, 255, 0.5) 0%, rgba(245, 248, 255, 0.6) 100%);
        }
        .plan-table td:nth-child(2) { /* ÿßŸÑÿ™ÿßÿ±ŸäÿÆ */
            background: linear-gradient(135deg, rgba(245, 248, 255, 0.6) 0%, rgba(238, 243, 255, 0.7) 100%);
        }
        .plan-table td:nth-child(3) { /* ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ© */
            background: linear-gradient(135deg, rgba(250, 251, 255, 0.5) 0%, rgba(245, 248, 255, 0.6) 100%);
        }
        .plan-table td:nth-child(4) { /* ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© */
            background: linear-gradient(135deg, rgba(252, 253, 255, 0.4) 0%, rgba(248, 250, 255, 0.5) 100%);
        }

        
        /* Dropdown shops styles removed - now using inline display */

        /* Simple dropdown styles for shops list - Enhanced for smart display */
        .shops-dropdown-list {
            display:none;
            position:fixed;
            background:#ffff00;
            border:2px solid #234085;
            border-radius:12px;
            margin-top:5px;
            min-width:250px;
            max-width:380px;
            max-height:280px;
            box-shadow:0 8px 25px rgba(35, 64, 133, 0.15);
            z-index:9999;
            text-align:right;
            overflow-y:auto;
            white-space:normal;
            font-family: 'Cairo', Arial, sans-serif;
        }
        .shops-dropdown-list::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid #234085;
        }
        .shops-dropdown-header {
            background: linear-gradient(135deg, #234085 0%, #2e5bb8 100%);
            color: white;
            padding: 12px 15px;
            margin: 0;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            font-size: 0.95em;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        .shops-dropdown-list ul {
            list-style: none;
            margin:0; 
            padding:10px 8px;
        }
        .shops-dropdown-list ul li {
            padding:10px 15px;
            border-bottom:1px solid #f0f0f0;
            font-size:0.92em;
            transition: all 0.3s ease;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
            border-radius: 6px;
            margin-bottom: 4px;
            position: relative;
        }
        .shops-dropdown-list ul li:hover {
            background-color:#f8faff;
            transform: translateX(-3px);
            box-shadow: 3px 0 8px rgba(35, 64, 133, 0.1);
        }
        .shops-dropdown-list ul li:last-child {
            border-bottom:none;
            margin-bottom: 0;
        }
        .shops-dropdown-list ul li::before {
            content: 'üè™';
            margin-left: 8px;
            font-size: 0.9em;
        }
        .shops-count-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 8px;
        }
        .shops-dropdown-wrap {position:relative; display:inline-block;}
        .show-shops-btn {
            touch-action: manipulation;
            user-select: none;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
        }
        
        /* Enhanced shop button animations */
        @keyframes glow-pulse {
            0%, 100% { 
                box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
            }
            50% { 
                box-shadow: 0 4px 15px rgba(0, 123, 255, 0.6),
                            0 0 20px rgba(0, 123, 255, 0.4);
            }
        }
        
        @keyframes shine-effect {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .show-shops-btn {
            animation: glow-pulse 2s ease-in-out infinite;
        }
        
        .show-shops-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shine-effect 3s ease-in-out infinite;
        }
        
        .show-shops-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.5),
                        0 0 30px rgba(0, 123, 255, 0.3);
            background: linear-gradient(135deg, #0056b3 0%, #007bff 100%) !important;
        }
        
        .show-shops-btn:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }
        .inspector-report-div {margin:16px 0 0 0;background:#f7f9fc;border-radius:10px;padding:18px 12px;width:100%;color:#234085;font-size:1.1em;box-shadow:0 1px 5px #e2e2e2;}
        /* ÿ™ŸÜÿ≥ŸäŸÇ ŸÇÿ≥ŸÖ ÿßŸÑÿ®ÿ≠ÿ´ */
        .search-filters-section {
            background:#f8f9fa;
            padding:15px;
            border-radius:8px;
            margin:15px 0;
            border:1px solid #dee2e6;
        }
        .search-filters-grid {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
            gap:15px;
            align-items:end;
        }
        .modal-overlay {
            display:none; 
            position:fixed;
            z-index:99999;
            right:0;left:0;top:0;bottom:0; 
            background:rgba(0,0,0,0.35);
            align-items:center;
            justify-content:center;
            backdrop-filter: blur(3px);
        }
        
        /* Higher z-index for nested modals */
        .modal-overlay.nested-modal {
            z-index:999999;
            background:rgba(0,0,0,0.45);
        }
        .modal-content {
            background:#fff; 
            border-radius:16px; 
            box-shadow:0 8px 32px rgba(0,0,0,0.15);
            padding:32px 18px; 
            margin:20px auto; 
            max-width:95vw; 
            min-width:70vw; 
            max-height:88vh; 
            position:relative; 
            text-align:center; 
            overflow-y:auto;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .modal-content button.close-btn {
            position:absolute; 
            right:12px; 
            top:12px; 
            border:none; 
            background:#dc3545; 
            color:#fff; 
            border-radius:50%; 
            font-size:1.5em;
            width:42px;
            height:42px;
            cursor:pointer;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 10;
        }
        .modal-content button.close-btn:hover {
            background: #c82333;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        .modal-content button.close-btn:active {
            transform: scale(0.98);
        }
        .modal-actions {
            margin: 16px 0 0 0;
            display:flex;
            justify-content:center;
            gap:10px;
        }
        .stats-title {color:#134093;font-size:1.18em;text-align:center;margin-bottom:15px;}
        
        /* ÿ™ŸÜÿ≥ŸäŸÇ ŸÜŸÖŸàÿ∞ÿ¨ ÿ™ÿ≠ÿ±Ÿäÿ± ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ */
        .shop-edit-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            font-family: inherit;
            direction: ltr;
            text-align: left;
        }
        .shop-edit-input.arabic {
            direction: rtl;
            text-align: right;
        }
        .shop-edit-input:focus {
            outline: none;
            border-color: #234085;
            box-shadow: 0 0 0 2px rgba(35, 64, 133, 0.2);
        }
        .shop-save-status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .shop-save-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .shop-save-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b0b7;
        }
        
        /* ÿ™ŸÜÿ≥ŸäŸÇ ŸÖŸàÿØÿßŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ */
        .shop-detail-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .shop-detail-card:hover {
            border-color: #234085;
            box-shadow: 0 6px 12px rgba(35, 64, 133, 0.15);
        }
        .shop-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 1em;
        }
        .shop-detail-row:last-child {
            border-bottom: none;
        }
        .shop-detail-label {
            font-weight: 600;
            color: #495057;
            min-width: 100px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shop-detail-value {
            color: #234085;
            font-weight: 500;
            text-align: left;
            direction: ltr;
        }
        .shop-detail-value.arabic {
            direction: rtl;
            text-align: right;
        }
        .location-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .location-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        .shop-icon {
            font-size: 1.2em;
            margin-left: 5px;
        }
        .stats-table {
            width:100%;
            border-collapse:collapse;
            margin-bottom:0;
            font-size:1.04em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        .stats-table th, .stats-table td {
            border:1px solid #234093;
            padding:12px 8px;
            text-align:center;
            vertical-align: middle;
        }
        .stats-table th {
            background:#234093;
            color:#fff;
            font-weight: bold;
            font-size: 1.05em;
        }
        .stats-table tr:nth-child(even) {background:#f3f5fa;}
        .stats-table tr:hover {background:#e8f0fe;}
        
        /* Inspector Report Specific Styling */
        .inspector-report-div {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e0e6ed;
            position: relative;
            z-index: 1;
        }
        
        .save-box {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .save-box button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 140px;
        }
        
        .save-box button:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        .footer {text-align:center;margin-top:22px;color:#234085;font-size:0.85em;}
        .red-total {
            color: #d32f2f !important;
            font-weight: bold !important;
            background: #fffbe9;
        }
        .pdf-title-arabic {
            font-size: 1.18em;
            text-align: center;
            color: #234085;
            font-weight: bold;
            margin-bottom: 10px;
            width: 100%;
            margin-top: 0;
        }
        .edit-btn, .delete-btn {
            background: #6c757d; color: #fff; border: none; border-radius: 5px; padding: 6px 12px; margin: 2px; cursor: pointer; font-size: 0.95em;
        }
        .edit-btn:hover { background: #495057; }
        .delete-btn { background: #d32f2f; }
        .delete-btn:hover { background: #b71c1c; }
        .dev-section {background:#e9ecef;border-radius:8px;padding:16px 11px;margin:14px 0 14px 0;}
        .dev-section .close-btn {background:#d32f2f;color:#fff;border:none;border-radius:5px;padding:0 13px;font-size:1.1em;cursor:pointer;float:left;}
        #devPasswordForm {margin-bottom:6px;}
        /* Mobile-specific improvements */
        @media (hover: none) and (pointer: coarse) {
            /* This targets touch devices specifically */
            button:hover {
                transform: none; /* Disable hover transforms on touch devices */
            }
            /* Better tap feedback */
            button:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }
            .plan-table button:active {
                background-color: rgba(35, 64, 133, 0.8);
            }
        }
        
        /* Additional mobile polish */
        @media (max-width: 600px) {
            /* Smooth scrolling improvements */
            html {
                scroll-behavior: smooth;
            }
            
            /* Better focus states for accessibility */
            button:focus, 
            select:focus, 
            input:focus {
                outline: 2px solid #234085;
                outline-offset: 2px;
            }
            
            /* Loading state improvements */
            .loading-spinner {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 2px solid #f3f3f3;
                border-top: 2px solid #234085;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        }
        
        /* Tablet optimization for better screen usage */
        @media (max-width: 900px) and (min-width: 601px) {
            .main-container {
                max-width: 95%;
                width: 95%;
                padding: 28px 20px 20px 20px;
                margin: 32px auto 16px auto;
            }
        }
        
        @media (max-width:600px) {
            .main-container {
                padding:12px 3vw 10px 3vw;
                margin: 16px auto 0 auto;
                border-radius: 12px;
                max-width: 98%;
                min-width: unset;
                width: 98%;
            }
            .main-title-box {
                font-size:1.6em;
                font-weight: 800;
                padding:14px 12px;
                margin-bottom: 8px;
                letter-spacing: 0.3px;
                word-spacing: 1.5px;
                line-height: 1.25;
                border-radius: 14px;
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 56px;
            }
            .login-section, .inspector-select-section {
                flex-direction: row;
                margin: 6px 0;
            }
            select, input[type="text"], input[type="date"], input[type="password"] {
                padding: 8px 12px;
                font-size: 0.95em;
                min-width: 200px;
                max-width: 280px;
                width: 100%;
                box-sizing: border-box;
            }

            .actions-row {
                margin: 15px 0;
            }
            .actions-line {
                gap: 12px;
            }
            .icon-btn {
                width: 75px;
                height: 75px;
                font-size: 0.7em;
            }
            .icon-btn .icon {
                font-size: 1.8em;
                margin-bottom: 4px;
            }
            .icon-btn .label {
                font-size: 0.75em;
            }
            
            /* Mobile styles for system services */
            .system-services-container {
                margin: 20px 0;
                padding: 15px;
            }
            .system-services-header {
                font-size: 1em;
                padding: 10px 15px;
            }
            .services-grid {
                gap: 12px;
                justify-content: center;
            }
            .service-icons-grid {
                display: contents;
            }
            .service-category {
                display: contents;
            }
            .service-category-title {
                display: none;
            }
            
            .plan-table-container {
                overflow-x:auto;
                -webkit-overflow-scrolling:touch;
                padding-right: 10px; /* ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ•ÿ≤ÿßÿ≠ÿ© ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© */
            }
            .plan-table {
                width:100%;
                table-layout:fixed; /* Force table to respect column widths */
            }
            .plan-table th, .plan-table td {
                padding:6px 4px;
                font-size:0.8em;
                min-width:50px;
            }

            /* Optimized column widths for mobile - total ~100% */
            .plan-table th:nth-child(1), .plan-table td:nth-child(1) { /* ÿßŸÑŸÖŸÅÿ™ÿ¥ */
                width: 26%;
                min-width: 26%;
                font-size: 0.7em;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                border-right: 1px solid rgba(35, 64, 133, 0.12);
            }
            .plan-table th:nth-child(2), .plan-table td:nth-child(2) { /* ÿßŸÑÿ™ÿßÿ±ŸäÿÆ */
                width: 17%;
                min-width: 17%;
                font-size: 0.7em;
                white-space: nowrap;
                border-right: 1px solid rgba(35, 64, 133, 0.12);
            }
            .plan-table th:nth-child(3), .plan-table td:nth-child(3) { /* ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ© */
                width: 13%;
                min-width: 13%;
                font-size: 0.75em;
                white-space: nowrap;
                border-right: 1px solid rgba(35, 64, 133, 0.12);
                text-align: center;
            }
            .plan-table th:nth-child(4), .plan-table td:nth-child(4) { /* ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© */
                width: 24%;
                min-width: 24%;
                font-size: 0.75em;
                white-space: normal;
                word-wrap: break-word;
                overflow: visible;
                border-right: 1px solid rgba(35, 64, 133, 0.12);
            }
            .plan-table th:nth-child(5), .plan-table td:nth-child(5) { /* ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ */
                width: 24%;
                min-width: 24%;
                font-size: 0.75em;
            }
            
            /* Mobile table data cell backgrounds - only for td elements */
            
            .plan-table td:nth-child(2) { /* ÿßŸÑÿ™ÿßÿ±ŸäÿÆ */
                background: linear-gradient(135deg, rgba(245, 248, 255, 0.6) 0%, rgba(238, 243, 255, 0.7) 100%);
            }
            .plan-table td:nth-child(3) { /* ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ© */
                background: linear-gradient(135deg, rgba(250, 251, 255, 0.5) 0%, rgba(245, 248, 255, 0.6) 100%);
            }
            .plan-table td:nth-child(4) { /* ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© */
                background: linear-gradient(135deg, rgba(252, 253, 255, 0.4) 0%, rgba(248, 250, 255, 0.5) 100%);
            }

            /* Dropdown mobile styles removed */
            .modal-content {
                padding:15px 3vw;
                min-width:unset;
                max-width:95vw;
                margin: 20px auto;
            }
            .stats-table th, .stats-table td {
                padding:8px 4px;
                font-size: 0.85em;
            }
            .edit-btn, .delete-btn {
                padding: 4px 8px;
                margin: 1px;
                font-size: 0.8em;
            }
            .bell-3d {
                width: 42px;
                height: 42px;
            }
            .bell-body {
                width: 35px;
                height: 30px;
            }
            .last-update-row {
                font-size: 0.85em;
                margin-right: 4px;
            }
            .search-filters-grid {
                grid-template-columns:1fr;
                gap:12px;
            }
            .footer {
                font-size: 0.8em;
                margin-top: 16px;
            }
            
            /* Mobile modal improvements */
            .modal-content {
                padding: 20px 12px;
                min-width: 90vw;
                max-height: 85vh;
            }
            .modal-content button.close-btn {
                width: 44px;
                height: 44px;
                font-size: 1.5em;
                right: 8px;
                top: 8px;
                border: 2px solid #fff;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                z-index: 10;
            }
        }

        @media (max-width:400px) {
            .main-container {
                padding: 10px 2vw 8px 2vw;
                margin: 8px auto 0 auto;
                border-radius: 8px;
                max-width: 98%;
                width: 98%;
            }
            .main-title-box {
                font-size: 1.4em;
                font-weight: 800;
                padding: 12px 10px;
                margin-bottom: 6px;
                letter-spacing: 0.2px;
                word-spacing: 1px;
                line-height: 1.2;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 48px;
            }
            .bell-3d {
                width: 38px;
                height: 38px;
            }
            .bell-body {
                width: 32px;
                height: 28px;
            }
            .bell-bubble {
                width: 95%;
                padding: 20px 15px;
                border-radius: 15px;
            }
            .bell-action-btn {
                padding: 10px 20px;
                font-size: 0.9em;
                min-width: 90px;
            }
            .login-section, .inspector-select-section {
                margin: 5px 0;
            }
            select, input[type="text"], input[type="date"], input[type="password"] {
                padding: 6px 10px;
                font-size: 0.9em;
                min-width: 180px;
                max-width: 100%;
            }
            
            /* Very small mobile styles for system services */
            .system-services-container {
                margin: 15px 0;
                padding: 12px;
            }
            .system-services-header {
                font-size: 0.95em;
                padding: 8px 12px;
            }
            .system-services-icon {
                font-size: 1.3em;
            }
            .services-grid {
                gap: 8px;
                flex-wrap: wrap;
            }
            .service-icons-grid {
                display: contents;
            }
            .service-category {
                display: contents;
            }
            .service-category-title {
                display: none;
            }
            
            .actions-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .action-group {
                max-width: 320px;
                margin: 0 auto;
            }
            .action-group button {
                padding: 8px 12px;
                font-size: 0.8em;
                min-width: 110px;
            }
            .plan-table th, .plan-table td {
                padding: 6px 3px;
                font-size: 0.75em;
                min-width:45px;
            }

            /* Optimized column widths for very small mobile - total ~100% */
            .plan-table th:nth-child(1), .plan-table td:nth-child(1) { /* ÿßŸÑŸÖŸÅÿ™ÿ¥ */
                width: 28%;
                min-width: 28%;
                font-size: 0.65em;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                border-right: 1px solid rgba(35, 64, 133, 0.12);
            }
            .plan-table th:nth-child(2), .plan-table td:nth-child(2) { /* ÿßŸÑÿ™ÿßÿ±ŸäÿÆ */
                width: 19%;
                min-width: 19%;
                font-size: 0.65em;
                white-space: nowrap;
                border-right: 1px solid rgba(35, 64, 133, 0.12);
            }
            .plan-table th:nth-child(3), .plan-table td:nth-child(3) { /* ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ© */
                width: 15%;
                min-width: 15%;
                font-size: 0.7em;
                white-space: nowrap;
                border-right: 1px solid rgba(35, 64, 133, 0.12);
                text-align: center;
            }
            .plan-table th:nth-child(4), .plan-table td:nth-child(4) { /* ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© */
                width: 24%;
                min-width: 24%;
                font-size: 0.7em;
                white-space: normal;
                word-wrap: break-word;
                overflow: visible;
                border-right: 1px solid rgba(35, 64, 133, 0.12);
            }
            .plan-table th:nth-child(5), .plan-table td:nth-child(5) { /* ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ */
                width: 18%;
                min-width: 18%;
                font-size: 0.7em;
            }
            
            /* Very small mobile table data cell backgrounds - only for td elements */
            
            .plan-table td:nth-child(2) { /* ÿßŸÑÿ™ÿßÿ±ŸäÿÆ */
                background: linear-gradient(135deg, rgba(245, 248, 255, 0.6) 0%, rgba(238, 243, 255, 0.7) 100%);
            }
            .plan-table td:nth-child(3) { /* ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ© */
                background: linear-gradient(135deg, rgba(250, 251, 255, 0.5) 0%, rgba(245, 248, 255, 0.6) 100%);
            }
            .plan-table td:nth-child(4) { /* ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© */
                background: linear-gradient(135deg, rgba(252, 253, 255, 0.4) 0%, rgba(248, 250, 255, 0.5) 100%);
            }

            /* Dropdown mobile styles removed */
            .modal-content {
                padding: 12px 2vw;
                max-width: 98vw;
            }
            .edit-btn, .delete-btn {
                padding: 3px 6px;
                font-size: 0.75em;
            }
            
            /* Very small mobile modal improvements */
            .modal-content {
                padding: 16px 8px;
                min-width: 95vw;
                max-height: 82vh;
                margin: 10px auto;
            }
            .modal-content button.close-btn {
                width: 40px;
                height: 40px;
                font-size: 1.4em;
                right: 6px;
                top: 6px;
                border: 2px solid #fff;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                min-width: 40px;
                min-height: 40px;
                z-index: 10;
            }


        }

        /* News Ticker Styles */
        .news-ticker-container {
            background: linear-gradient(135deg, rgba(250, 251, 255, 0.8) 0%, rgba(245, 248, 255, 0.9) 100%);
            border-bottom: 2px solid #ffd700;
            overflow: hidden;
            height: 45px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none; /* Hidden by default, shown when notifications exist */
            transition: all 0.3s ease;
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            border-radius: 0 0 8px 8px;
        }

        .news-ticker-container.show {
            display: block;
            animation: slideInFromTop 0.6s ease-out;
        }

        @keyframes slideInFromTop {
            0% {
                transform: translateY(-100%);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .news-ticker-container:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            transform: translateY(-1px);
        }

        .news-ticker-label {
            position: absolute;
            left: 0;
            top: 0;
            background: #ffd700;
            color: #1e3c72;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 14px;
            z-index: 2;
            border-radius: 0 8px 8px 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            animation: ticker-pulse-glow 2s ease-in-out infinite;
        }

        @keyframes ticker-pulse-glow {
            0%, 100% {
                box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            }
            50% {
                box-shadow: 2px 0 10px rgba(255,215,0,0.6), 0 0 15px rgba(255,215,0,0.4);
            }
        }

        .news-ticker-label:hover {
            transform: scale(1.05);
        }

        .news-ticker-content {
            margin-left: 120px;
            height: 100%;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        /* Add gradient fade effect on edges */
        .news-ticker-content::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 50px;
            background: linear-gradient(to right, rgba(245, 248, 255, 0.9) 0%, transparent 100%);
            z-index: 1;
            pointer-events: none;
        }

        .news-ticker-content::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 50px;
            background: linear-gradient(to left, rgba(245, 248, 255, 0.9) 0%, transparent 100%);
            z-index: 1;
            pointer-events: none;
        }

        .news-ticker-text {
            white-space: nowrap;
            color: #234085;
            font-size: 16px;
            font-weight: 600;
            line-height: 45px;
            padding-right: 50px;
            display: inline-block;
            animation: scroll-ticker 220s linear infinite;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
            transition: opacity 0.5s ease, transform 0.3s ease;
        }

        /* Pause animation on hover for better readability */
        .news-ticker-content:hover .news-ticker-text {
            animation-play-state: paused;
        }

        @keyframes scroll-ticker {
            0% {
                transform: translateX(-100%);
                opacity: 0;
            }
            5% {
                opacity: 1;
            }
            95% {
                opacity: 1;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .news-ticker-separator {
            color: #ffd700;
            margin: 0 3cm;
            font-weight: bold;
        }

        /* Responsive design for news ticker */
        @media (max-width: 768px) {
            .news-ticker-container {
                height: 40px;
                max-width: 100%;
            }
            
            .news-ticker-label {
                padding: 10px 12px;
                font-size: 12px;
            }
            
            .news-ticker-content {
                margin-left: 100px;
            }
            
            .news-ticker-text {
                font-size: 14px;
                line-height: 40px;
                animation: scroll-ticker 180s linear infinite;
            }
        }

        @media (max-width: 480px) {
            .news-ticker-container {
                height: 35px;
                max-width: 100%;
            }
            
            .news-ticker-label {
                padding: 8px 10px;
                font-size: 11px;
            }
            
            .news-ticker-content {
                margin-left: 85px;
            }
            
            .news-ticker-text {
                font-size: 13px;
                line-height: 35px;
                animation: scroll-ticker 160s linear infinite;
            }
        }
        
        /* Token Popup Styles */
        .token-popup-bg {
            position:fixed;top:0;left:0;right:0;bottom:0;
            background:rgba(0,0,0,0.5);z-index:10000;
            display:flex;align-items:center;justify-content:center;
        }
        .token-popup-box {
            background:#fff;padding:26px 22px;border-radius:12px;box-shadow:0 0 22px #aaa;
            min-width:320px;max-width:500px;text-align:center;position:relative;
        }
        .token-popup-box h3 {
            color:#2336a0;margin:0 0 15px 0;
        }
        .token-popup-box label {color:#2336a0;}
        .token-popup-close {
            position:absolute;right:8px;top:8px;border:none;background:#dc3545;color:#fff;border-radius:50%;
            font-size:1.3em;width:32px;height:32px;cursor:pointer;box-shadow:0 2px 8px rgba(220,53,69,0.3);
            transition:all 0.2s ease;display:flex;align-items:center;justify-content:center;font-weight:bold;z-index:10;
        }
        .token-popup-close:hover {
            background:#c82333;transform:scale(1.05);box-shadow:0 4px 12px rgba(220,53,69,0.4);
        }
        .token-popup-box input[type="password"] {
            font-size:1.1em;padding:10px;border-radius:6px;border:1px solid #bbb;
            width:100%;box-sizing:border-box;margin:10px 0;
        }
        .token-popup-box button {
            background:#2336a0;color:#fff;border:none;border-radius:6px;
            padding:10px 28px;font-size:1.08em;cursor:pointer;margin:5px;
        }
        .token-popup-box button:hover {
            background:#1a2870;
        }
        
        /* Maintenance Mode Overlay Styles - Now replaces main content instead of full overlay */
        #maintenanceOverlay {
            width: 100%;
            min-height: 600px;
            background: linear-gradient(135deg, 
                rgba(35, 54, 160, 0.95) 0%,
                rgba(76, 175, 80, 0.95) 50%,
                rgba(33, 150, 243, 0.95) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.5s ease-in-out;
            border-radius: 18px;
            margin: 24px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .maintenance-content {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 30px;
            padding: 60px 50px;
            text-align: center;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            animation: slideUp 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .maintenance-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.4), 
                transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 200%; }
        }
        
        .maintenance-icon {
            position: relative;
            margin: 0 auto 30px;
            width: 120px;
            height: 120px;
        }
        
        .shield-icon {
            font-size: 80px;
            animation: pulse 2s ease-in-out infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }
        
        .lock-icon {
            font-size: 40px;
            position: absolute;
            top: 60%;
            left: 55%;
            transform: translate(-50%, -50%);
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translate(-50%, -50%) translateY(0); }
            50% { transform: translate(-50%, -50%) translateY(-10px); }
        }
        
        .maintenance-title {
            font-family: 'Tajawal', 'Cairo', sans-serif;
            font-size: 2.5em;
            font-weight: 800;
            color: #2336a0;
            margin: 20px 0 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            animation: colorShift 4s ease-in-out infinite;
        }
        
        @keyframes colorShift {
            0%, 100% { color: #2336a0; }
            50% { color: #4caf50; }
        }
        
        .maintenance-message {
            font-family: 'Cairo', sans-serif;
            font-size: 1.8em;
            font-weight: 600;
            color: #333;
            margin: 10px 0;
        }
        
        .maintenance-submessage {
            font-family: 'Cairo', sans-serif;
            font-size: 1.3em;
            color: #666;
            margin: 10px 0 30px;
        }
        
        .maintenance-spinner {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 30px auto;
        }
        
        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }
        
        .spinner-ring:nth-child(1) {
            border-top-color: #2336a0;
            animation-delay: 0s;
        }
        
        .spinner-ring:nth-child(2) {
            border-right-color: #4caf50;
            animation-delay: 0.3s;
            width: 80%;
            height: 80%;
            top: 10%;
            left: 10%;
        }
        
        .spinner-ring:nth-child(3) {
            border-bottom-color: #2196f3;
            animation-delay: 0.6s;
            width: 60%;
            height: 60%;
            top: 20%;
            left: 20%;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .maintenance-details {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #fff3cd 0%, #ffe4b3 100%);
            border-radius: 15px;
            border: 2px solid #ffc107;
            font-family: 'Cairo', sans-serif;
            font-size: 0.95em;
            color: #856404;
            line-height: 1.8;
            text-align: right;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }
        
        .maintenance-details strong {
            color: #d32f2f;
            font-weight: 700;
        }
        
        /* Developer close button for maintenance mode */
        .maintenance-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .maintenance-close-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #a71d2a 100%);
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
        }
        
        .maintenance-close-btn:active {
            transform: scale(0.95) rotate(90deg);
        }
        
        /* Show close button only for developers */
        .maintenance-close-btn.show-for-dev {
            display: flex;
        }
        
        /* Responsive design for maintenance mode */
        @media (max-width: 768px) {
            .maintenance-content {
                padding: 40px 30px;
                margin: 20px;
            }
            
            .maintenance-title {
                font-size: 2em;
            }
            
            .maintenance-message {
                font-size: 1.5em;
            }
            
            .maintenance-submessage {
                font-size: 1.1em;
            }
        }

        /* Shop Priority Button Animations - ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿ≤ÿ± ÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ */
        @keyframes priority-glow-pulse {
            0%, 100% { 
                box-shadow: 0 2px 5px rgba(102, 126, 234, 0.4),
                            0 0 10px rgba(118, 75, 162, 0.3);
            }
            50% { 
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.8),
                            0 0 30px rgba(118, 75, 162, 0.6),
                            0 0 40px rgba(255, 215, 0, 0.4);
            }
        }

        @keyframes priority-icon-bounce {
            0%, 100% { 
                transform: translateY(0) scale(1);
            }
            25% { 
                transform: translateY(-3px) scale(1.1);
            }
            50% { 
                transform: translateY(0) scale(1.15);
            }
            75% { 
                transform: translateY(-3px) scale(1.1);
            }
        }

        @keyframes priority-shine {
            0% { 
                left: -150%;
                opacity: 0;
            }
            50% { 
                opacity: 1;
            }
            100% { 
                left: 150%;
                opacity: 0;
            }
        }

        @keyframes priority-border-glow {
            0%, 100% { 
                border-color: rgba(255, 215, 0, 0.5);
            }
            50% { 
                border-color: rgba(255, 215, 0, 1);
            }
        }

        #shopPriorityBtn {
            position: relative;
            overflow: hidden;
            animation: priority-glow-pulse 2s ease-in-out infinite;
            border: 2px solid rgba(255, 215, 0, 0.5) !important;
            animation: priority-glow-pulse 2s ease-in-out infinite, 
                       priority-border-glow 2s ease-in-out infinite;
            transition: all 0.3s ease;
            font-size: 1em !important;
        }

        #shopPriorityBtn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.6), 
                transparent);
            animation: priority-shine 3s ease-in-out infinite;
            z-index: 1;
        }

        #shopPriorityBtn::after {
            content: '‚ú®';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
            animation: priority-icon-bounce 1.5s ease-in-out infinite;
            z-index: 2;
        }

        #shopPriorityBtn:hover {
            transform: translateY(-4px) scale(1.08);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 1),
                        0 0 40px rgba(118, 75, 162, 0.8),
                        0 0 50px rgba(255, 215, 0, 0.6) !important;
            border-color: rgba(255, 215, 0, 1) !important;
        }

        #shopPriorityBtn:active {
            transform: translateY(-2px) scale(1.05);
        }

        /* Add sparkle effect to the icon inside button */
        #shopPriorityBtn > * {
            position: relative;
            z-index: 2;
        }

        /* Developer Splash Screen Animations */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
        }

        @keyframes progressAnimation {
            0% {
                width: 0%;
            }
            50% {
                width: 100%;
            }
            100% {
                width: 0%;
            }
        }

        @keyframes rotate360 {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -300px 0;
            }
            100% {
                background-position: 300px 0;
            }
        }

        @keyframes musicNote {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-10px) scale(1.1);
            }
        }

        #devSplashScreen.show {
            display: flex !important;
            opacity: 1 !important;
        }

        #devSplashScreen.hide {
            opacity: 0 !important;
        }
    </style>
</head>
<body>
<!-- Developer Splash Screen Overlay -->
<div id="devSplashScreen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index:999999; opacity:0; transition:opacity 0.5s ease;">
    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:white; font-family:'Cairo', Arial, sans-serif; text-align:center; padding:20px;">
        <div style="font-size:100px; margin-bottom:25px; animation:pulse 1.5s ease-in-out infinite, rotate360 3s linear infinite;">üí´</div>
        <h1 style="font-size:3em; margin:0 0 20px 0; font-weight:900; text-shadow:0 6px 12px rgba(0,0,0,0.4); letter-spacing:2px; animation:slideInDown 0.8s ease-out;">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¢ŸÜ</h1>
        <p style="font-size:1.8em; margin:0 0 35px 0; opacity:0.95; font-weight:600; animation:fadeInUp 1s ease-out;">ŸäŸèÿ±ÿ¨Ÿä ÿßŸÑÿ•ŸÜÿ™ÿ∏ÿßÿ±</p>
        <div style="width:300px; height:6px; background:rgba(255,255,255,0.3); border-radius:3px; overflow:hidden; margin-bottom:25px; box-shadow:0 4px 10px rgba(0,0,0,0.2);">
            <div id="splashProgressBar" style="width:0%; height:100%; background:linear-gradient(90deg, #fff 0%, #ffd700 50%, #fff 100%); border-radius:3px; transition:width 0.3s ease; animation:progressAnimation 2s ease-in-out infinite, shimmer 1.5s linear infinite;"></div>
        </div>
        <div style="display:flex; align-items:center; gap:15px; margin-top:10px;">
            <div style="font-size:2.5em; animation:musicNote 1s ease-in-out infinite;">üéµ</div>
            <p style="font-size:1.3em; opacity:0.9; margin:0; font-weight:500;">ÿßÿ≥ÿ™ŸÖÿ™ÿπ ÿ®ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</p>
            <div style="font-size:2.5em; animation:musicNote 1s ease-in-out infinite 0.5s;">üé∂</div>
        </div>
    </div>
</div>

<!-- Hidden Audio Element for Developer Splash Screen -->
<audio id="splashAudio" preload="metadata" playsinline webkit-playsinline style="display:none;" loop crossorigin="anonymous">
    <source src="Classical-Music-for-Relaxation-Mozart-Bach-Tchaikovsky...-128Kbps-44KHz(mp3)1ÿßŸÑÿ¨ÿ≤ÿ°(4).mp3" type="audio/mpeg">
    <source src="Classical-Music-for-Relaxation-Mozart-Bach-Tchaikovsky...-128Kbps-44KHz(mp3)1ÿßŸÑÿ¨ÿ≤ÿ°(4).mp3" type="audio/mp3">
    ŸÖÿ™ÿµŸÅÿ≠ŸÉ ŸÑÿß ŸäÿØÿπŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿµŸàÿ™Ÿäÿ©.
</audio>

<!-- Hidden Audio Element for Maintenance Mode -->
<audio id="maintenanceAudio" preload="metadata" playsinline webkit-playsinline style="display:none;" loop crossorigin="anonymous">
    <source src="music.mp3" type="audio/mpeg">
    <source src="music.mp3" type="audio/mp3">
    ŸÖÿ™ÿµŸÅÿ≠ŸÉ ŸÑÿß ŸäÿØÿπŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿµŸàÿ™Ÿäÿ©.
</audio>

<!-- Animated Background Shapes -->
<div class="bg-shape cloud cloud-1"></div>
<div class="bg-shape cloud cloud-2"></div>
<div class="bg-shape cloud cloud-3"></div>
<div class="bg-shape lock lock-1"></div>
<div class="bg-shape lock lock-2"></div>
<div class="bg-shape ai-shape ai-1"></div>
<div class="bg-shape ai-shape ai-2"></div>
<div class="bg-shape tech-shape tech-1"></div>
<div class="bg-shape tech-shape tech-2"></div>

<!-- Token Input Popup -->
<div class="token-popup-bg" id="tokenPopup" style="display:none;">
    <div class="token-popup-box">
        <button class="token-popup-close" onclick="hideTokenPopup()" title="ÿ•ÿ∫ŸÑÿßŸÇ">√ó</button>
        <h3 style="color:#2336a0;">üîë ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿ≥ÿ±Ÿä</h3>
        <p style="font-size:0.95em;color:#333;margin:10px 0;font-weight:bold;">ÿßŸÑÿ™ŸàŸÉŸÜ ŸÖÿ∑ŸÑŸàÿ® ŸÑÿ≠ŸÅÿ∏ Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ÿπŸÑŸâ GitHub ŸàŸÖÿ≤ÿßŸÖŸÜÿ™Ÿá ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ©</p>
        
        <!-- Instructions for creating token -->
        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 10px; margin: 10px 0; text-align: right; font-size: 0.85em;">
            <strong>üìã ŸÉŸäŸÅŸäÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿ™ŸàŸÉŸÜ ÿ¨ÿØŸäÿØ:</strong>
            <ol style="margin: 8px 0; padding-right: 20px; line-height: 1.6;">
                <li>ÿßÿ∞Ÿáÿ® ÿ•ŸÑŸâ: <a href="https://github.com/settings/tokens" target="_blank" style="color: #0066cc;text-decoration:underline;">GitHub Settings ‚Üí Tokens</a></li>
                <li>ÿßŸÜŸÇÿ± "<strong>Generate new token (classic)</strong>"</li>
                <li><strong>ŸÖŸáŸÖ ÿ¨ÿØÿßŸã:</strong> ÿßÿÆÿ™ÿ± ÿµŸÑÿßÿ≠Ÿäÿ© <code style="background:#f5f5f5;padding:2px 5px;border-radius:3px;color:#d63384;">repo</code></li>
                <li>ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ™ŸàŸÉŸÜ Ÿàÿ£ŸÑÿµŸÇŸá ŸÅŸä ÿßŸÑÿ≠ŸÇŸÑ ÿ£ÿØŸÜÿßŸá</li>
            </ol>
        </div>
        
        <input id="tokenInput" type="password" placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" style="width:100%;box-sizing:border-box;padding:8px;border:1px solid #ccc;border-radius:4px;margin:10px 0;"><br>
        <button onclick="saveTokenFromPopup()" style="background:#28a745;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:bold;margin:5px;">üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸàŸÉŸÜ</button>
        <button onclick="useDefaultToken()" style="background:#6c757d;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;margin:5px;">ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä</button>
        <div style="color:#dc3545;font-size:0.95em;margin-top:10px;font-weight:bold;" id="tokenError"></div>
    </div>
</div>

<div class="main-container">
    <div class="header-top-bar">
        <div class="bell-container">
            <button class="bell-btn" id="bellBtn" title="ÿßŸÑÿ¨ÿ±ÿ≥ - ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑŸÉÿ™ÿßÿ®ÿ©">
                üîî
            </button>
        </div>
        <div class="last-update-row" id="lastUpdateRow"></div>
    </div>
    <!-- Click sound will be generated using Web Audio API -->
    <hr class="horizontal-line">
    
    <!-- News Ticker for Bell Notifications -->
    <div class="news-ticker-container" id="newsTicker">
        <div class="news-ticker-label">üîî ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</div>
        <div class="news-ticker-content">
            <div class="news-ticker-text" id="newsTickerText"></div>
        </div>
    </div>
    
    <div class="title-bar">
        <div class="main-title-box"><span style="position: relative; z-index: 2;">ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©</span></div>
    </div>
    
    <!-- ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ¥ŸäÿÆ ÿ≤ÿßŸäÿØ ÿßŸÑÿµŸàÿ™Ÿäÿ© -->
    <div class="sheikh-zayed-message-container">
        <div class="sheikh-zayed-label">üé§ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ¥ŸäÿÆ ÿ≤ÿßŸäÿØ</div>
        <audio id="sheikhZayedAudio" preload="metadata" playsinline webkit-playsinline crossorigin="anonymous">
            <source src="AUD-20251004-WA0028.mp3" type="audio/mpeg">
            <source src="AUD-20251004-WA0028.mp3" type="audio/mp3">
            ŸÖÿ™ÿµŸÅÿ≠ŸÉ ŸÑÿß ŸäÿØÿπŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿµŸàÿ™Ÿäÿ©.
        </audio>
        <button id="playSheikhZayedBtn" class="play-sheikh-zayed-btn">ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ¥ŸäÿÆ ÿ≤ÿßŸäÿØ</button>
    </div>
    
    <div class="login-section">
        <span class="login-label">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ:</span>
        <select id="loginRole">
            <option value="">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</option>
            <option value="inspector">ŸÖŸÅÿ™ÿ¥</option>
            <option value="developer">ÿßŸÑŸÖÿ∑Ÿàÿ±</option>
        </select>
        <input type="password" id="devPassword" placeholder="ŸÉŸÑŸÖÿ© ÿ≥ÿ± ÿßŸÑŸÖÿ∑Ÿàÿ±" style="display:none;">
        <button id="devLoginBtn" style="display:none;background:#198754;color:#fff;border:none;padding:7px 20px;border-radius:6px;font-size:1em;cursor:pointer;">ÿØÿÆŸàŸÑ ÿßŸÑŸÖÿ∑Ÿàÿ±</button>
        <button id="devLogoutBtn" style="display:none;background:#d32f2f;color:#fff;border:none;padding:7px 20px;border-radius:6px;font-size:1em;cursor:pointer;">ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖÿ∑Ÿàÿ±</button>
        <span id="devError" style="color:#d32f2f;margin-right:10px;"></span>
        <div id="refreshStatus" style="color:#28a745;font-size:0.9em;margin-top:5px;display:none;">üîÑ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>
    </div>
    <div class="inspector-select-section">
        <span class="inspector-label">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥ :</span>
        <select id="inspectorSelect">
            <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥ --</option>
        </select>
        <button id="viewInspectorDetailsBtn" onclick="viewSelectedInspectorDetails()" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;margin-right:10px;font-size:0.9em;display:none;" title="ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿ™ŸÅÿßÿµŸäŸÑ Ÿàÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥">
            üë§ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÅÿ™ÿ¥
        </button>
        <button id="searchToggleBtn" style="background:#234085;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;margin-right:10px;font-size:0.9em;" title="ÿßŸÑÿ®ÿ≠ÿ´">
            üîç ÿßŸÑÿ®ÿ≠ÿ´
        </button>
    </div>
    
    <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿ®ÿ≠ÿ´ -->
    <div id="searchFiltersSection" class="search-filters-section" style="background:#f8f9fa;padding:15px;border-radius:8px;margin:15px 0;border:1px solid #dee2e6;display:none;">
        <h3 style="margin:0 0 15px 0;color:#234085;text-align:center;">üîç ÿßŸÑÿ®ÿ≠ÿ´</h3>
        <div class="search-filters-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;align-items:end;">
            <div>
                <label for="searchFromDate" style="display:block;margin-bottom:5px;font-weight:bold;">ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ:</label>
                <input type="date" id="searchFromDate" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
            </div>
            <div>
                <label for="searchToDate" style="display:block;margin-bottom:5px;font-weight:bold;">ÿ•ŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ:</label>
                <input type="date" id="searchToDate" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
            </div>
            <div>
                <label for="searchArea" style="display:block;margin-bottom:5px;font-weight:bold;">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:</label>
                <select id="searchArea" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                    <option value="">-- ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ --</option>
                </select>
            </div>
            <div>
                <label for="searchShift" style="display:block;margin-bottom:5px;font-weight:bold;">ŸàŸÇÿ™ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©:</label>
                <select id="searchShift" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                    <option value="">-- ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ --</option>
                    <option value="ÿµÿ®ÿßÿ≠Ÿäÿ©">ÿµÿ®ÿßÿ≠Ÿäÿ©</option>
                    <option value="ŸÖÿ≥ÿßÿ¶Ÿäÿ©">ŸÖÿ≥ÿßÿ¶Ÿäÿ©</option>
                </select>
            </div>
            <div style="display:flex;gap:10px;">
                <button id="applySearchBtn" style="background:#28a745;color:#fff;border:none;padding:10px 15px;border-radius:4px;cursor:pointer;font-weight:bold;">ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ®ÿ≠ÿ´</button>
                <button id="clearSearchBtn" style="background:#6c757d;color:#fff;border:none;padding:10px 15px;border-radius:4px;cursor:pointer;">ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´</button>
            </div>
        </div>
        <div id="searchResultsInfo" style="margin-top:10px;padding:8px;background:#e9ecef;border-radius:4px;display:none;">
            <strong>ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´:</strong> <span id="searchResultsCount">0</span> ÿ™ŸÅÿ™Ÿäÿ¥
        </div>
    </div>
    <!-- ŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ∑Ÿàÿ±: ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ÿÆÿ∑ÿ© -->
    <div id="devSection" class="dev-section" style="display:none;">
        <!-- ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© -->
        <div id="dataManagementSection" style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6;">
            <h3 style="margin:0 0 15px 0;color:#234085;text-align:center;">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©</h3>
            <div style="display:flex;gap:15px;justify-content:center;flex-wrap:wrap;">
                <button id="manageInspectorsBtn" class="management-btn" style="background:#17a2b8;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</button>
                <button id="manageAreasBtn" class="management-btn" style="background:#fd7e14;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</button>
                <button id="manageShopsBtn" class="management-btn" style="background:#20c997;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</button>
                <button id="shopPriorityBtn" onclick="showShopPriorityModal()" class="management-btn" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:bold;box-shadow:0 2px 5px rgba(0,0,0,0.15);">üìä ÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÅŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥</button>
            </div>
            <div style="margin-top:15px;padding-top:15px;border-top:1px solid #dee2e6;text-align:center;">
                <button id="exportDataBtn" onclick="saveToExternalFile()" style="background:#dc3545;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:bold;">ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ ŸÖŸÑŸÅ JSON</button>
                <p style="margin:8px 0 0 0;font-size:0.9em;color:#666;">ÿßÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÅŸä ŸÖŸÑŸÅ plan-data.json ÿ¨ÿØŸäÿØ</p>
            </div>
            <!-- Maintenance Mode Controls -->
            <div style="margin-top:15px;padding-top:15px;border-top:1px solid #dee2e6;text-align:center;">
                <h4 style="margin:0 0 10px 0;color:#856404;font-size:1em;">üõ°Ô∏è ÿ•ÿØÿßÿ±ÿ© Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ©</h4>
                <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                    <button id="enableMaintenanceBtn" onclick="enableMaintenanceModeForAll()" style="background:#ffc107;color:#000;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;font-weight:bold;box-shadow:0 2px 5px rgba(0,0,0,0.2);min-height:44px;font-size:1em;">
                        üîí ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ
                    </button>
                    <button id="disableMaintenanceBtn" onclick="disableMaintenanceModeForAll()" style="background:#28a745;color:#fff;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;font-weight:bold;box-shadow:0 2px 5px rgba(0,0,0,0.2);min-height:44px;font-size:1em;">
                        ‚úÖ ÿ•ŸÑÿ∫ÿßÿ° Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ
                    </button>
                    <button onclick="showTokenPopup()" style="background:#007bff;color:#fff;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;font-weight:bold;box-shadow:0 2px 5px rgba(0,0,0,0.2);min-height:44px;font-size:1em;">
                        üîë ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸàŸÉŸÜ
                    </button>
                    <button id="hideUpdateMessageBtn" onclick="hideMaintenanceProgress()" style="background:#dc3545;color:#fff;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;font-weight:bold;box-shadow:0 2px 5px rgba(0,0,0,0.2);min-height:44px;font-size:1em;">
                        ‚ùå ÿ•ÿÆŸÅÿßÿ° ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´
                    </button>
                </div>
                <p style="margin:8px 0 0 0;font-size:0.85em;color:#666;">
                    üí° ÿπŸÜÿØ ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ©ÿå ÿ≥Ÿäÿ±Ÿâ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ (ÿπÿØÿß ÿßŸÑŸÖÿ∑Ÿàÿ±) ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸàŸÑŸÜ Ÿäÿ™ŸÖŸÉŸÜŸàÿß ŸÖŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ<br>
                    ÿπŸÜÿØ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÉŸÖÿ∑Ÿàÿ±ÿå ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã<br>
                    üì± ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ© ŸÖŸÜ ÿ£Ÿä ÿ¨Ÿáÿßÿ≤ (Ÿáÿßÿ™ŸÅÿå ÿ™ÿßÿ®ŸÑÿ™ÿå ÿ£Ÿà ŸÉŸÖÿ®ŸäŸàÿ™ÿ±)<br>
                    üîë ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ÿπŸÖŸÑ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿµŸäÿßŸÜÿ©ÿå ÿßŸÜŸÇÿ± ÿπŸÑŸâ "ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸàŸÉŸÜ" ŸÑÿ•ÿØÿÆÿßŸÑ ÿ™ŸàŸÉŸÜ GitHub ÿµÿßŸÑÿ≠
                </p>
            </div>
        </div>

        <form id="addEditForm" style="width:100%;max-width:700px;display:flex;flex-wrap:wrap;gap:12px 20px;align-items:center;justify-content:center;margin-bottom:12px;">
            <!-- ŸÖŸÅÿ™ÿ¥ ŸÖÿπ ÿ•ŸÖŸÉÿßŸÜŸäÿ© ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© -->
            <div style="position:relative;">
                <select id="formInspector" required style="min-width:150px;">
                    <option value="">ÿßÿÆÿ™ÿ± ŸÖŸÅÿ™ÿ¥</option>
                </select>
                <input type="text" id="newInspectorInput" placeholder="ÿ£Ÿà ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ŸÖŸÅÿ™ÿ¥ ÿ¨ÿØŸäÿØ" style="display:none;min-width:150px;">
                <button type="button" id="toggleInspectorInput" style="position:absolute;left:-30px;top:0;background:#007bff;color:#fff;border:none;padding:7px 8px;border-radius:4px;cursor:pointer;font-size:0.8em;">+</button>
            </div>
            
            <input type="date" id="formDay" required>
            
            <select id="formShift" required>
                <option value="">ŸàŸÇÿ™ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©</option>
                <option value="ÿµÿ®ÿßÿ≠Ÿäÿ©">ÿµÿ®ÿßÿ≠Ÿäÿ©</option>
                <option value="ŸÖÿ≥ÿßÿ¶Ÿäÿ©">ŸÖÿ≥ÿßÿ¶Ÿäÿ©</option>
            </select>
            
            <!-- ŸÖŸÜÿ∑ŸÇÿ© - ÿßÿÆÿ™Ÿäÿßÿ± ŸÅŸÇÿ∑ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© (ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿßÿ∑ŸÇ ÿ¨ÿØŸäÿØÿ© ŸÖŸÜ ŸáŸÜÿß) -->
            <div style="position:relative;">
                <select id="formArea" required style="min-width:150px;">
                    <option value="">ÿßÿÆÿ™ÿ± ŸÖŸÜÿ∑ŸÇÿ©</option>
                </select>
                <input type="text" id="newAreaInput" placeholder="ÿ£Ÿà ÿ£ÿØÿÆŸÑ ŸÖŸÜÿ∑ŸÇÿ© ÿ¨ÿØŸäÿØÿ©" style="display:none;min-width:150px;">
                <!-- Button hidden - areas can only be added through area management panel -->
                <button type="button" id="toggleAreaInput" style="display:none;position:absolute;left:-30px;top:0;background:#007bff;color:#fff;border:none;padding:7px 8px;border-radius:4px;cursor:pointer;font-size:0.8em;">+</button>
            </div>
            
            <!-- ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿπ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿ™ÿπÿØÿØ - Custom Dropdown with Overflow -->
            <div style="position:relative;min-width:350px;max-width:600px;flex:1;">
                <label style="display:block;margin-bottom:6px;font-weight:600;color:#234085;font-size:0.95em;">
                    üè™ ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß:
                </label>
                <div style="position:relative;">
                    <div class="custom-shops-dropdown">
                        <div class="custom-shops-trigger" id="customShopsTrigger">
                            <span class="custom-shops-trigger-text placeholder" id="customShopsTriggerText">
                                ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
                            </span>
                            <span class="custom-shops-trigger-icon">‚ñº</span>
                        </div>
                        <div class="custom-shops-dropdown-menu" id="customShopsDropdownMenu">
                            <div class="custom-shops-search">
                                <input type="text" id="customShopsSearch" placeholder="üîç ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≠ŸÑ..." autocomplete="off">
                            </div>
                            <div id="customShopsContent" style="max-height: 300px; overflow-y: auto;">
                                <!-- Shops will be populated here -->
                            </div>
                            <div class="custom-shops-dropdown-footer">
                                <div>
                                    <button type="button" class="custom-shops-select-all" onclick="customSelectAllShops()">ÿßÿÆÿ™ÿ± ÿßŸÑŸÉŸÑ</button>
                                    <button type="button" class="custom-shops-clear" onclick="customClearShopsSelection()">ŸÖÿ≥ÿ≠</button>
                                </div>
                                <button type="button" class="custom-shops-close" onclick="closeCustomShopsDropdown()">ÿ™ŸÖ ‚úì</button>
                            </div>
                        </div>
                    </div>
                    <!-- Hidden select for form submission -->
                    <select id="formShops" multiple style="display:none;" required>
                    </select>
                    <button type="button" id="addNewShop" style="position:absolute;left:-35px;top:0;background:#28a745;color:#fff;border:none;padding:10px 12px;border-radius:6px;cursor:pointer;font-size:1em;box-shadow:0 2px 5px rgba(0,0,0,0.2);" title="ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ">
                        ‚ûï
                    </button>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
                    <small style="color:#666;font-size:0.85em;">üí° ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÑÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿ™ÿπÿØÿØ</small>
                    <small id="selectedShopsCount" style="color:#007bff;font-weight:600;font-size:0.9em;">0 ŸÖÿ≠ŸÑ</small>
                </div>
            </div>
            
            <button type="submit" style="background:#198754;color:#fff;border:none;padding:8px 22px;border-radius:7px;font-size:1em;cursor:pointer;">ÿ•ÿ∂ÿßŸÅÿ© / ÿ™ÿπÿØŸäŸÑ</button>
            <input type="hidden" id="formEditingIndex" value="">
        </form>
        
        <!-- Enhanced Quick Data Entry Tools -->
        <div id="enhancedDataTools" style="margin-top:20px;padding:20px;background:#fff;border-radius:12px;border:2px solid #007bff;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
            <h3 style="margin:0 0 20px 0;color:#007bff;text-align:center;font-size:1.4em;">‚ö° ÿ£ÿØŸàÿßÿ™ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ©</h3>
            
            <!-- Quick Action Buttons -->
            <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:20px;">
                <button onclick="showQuickBulkImport()" style="background:linear-gradient(135deg, #28a745 0%, #20c997 100%);color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:bold;box-shadow:0 4px 8px rgba(0,0,0,0.2);">
                    üìã ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿ¨ŸÖÿßÿπŸä (Bulk Import)
                </button>
                <button onclick="showQuickClone()" style="background:linear-gradient(135deg, #17a2b8 0%, #138496 100%);color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:bold;box-shadow:0 4px 8px rgba(0,0,0,0.2);">
                    üìë ŸÜÿ≥ÿÆ ÿÆÿ∑ÿ© ŸÖŸàÿ¨ŸàÿØÿ©
                </button>
                <button onclick="showBatchOperations()" style="background:linear-gradient(135deg, #ffc107 0%, #ff9800 100%);color:#000;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:bold;box-shadow:0 4px 8px rgba(0,0,0,0.2);">
                    üîÑ ÿπŸÖŸÑŸäÿßÿ™ ÿØŸÅÿπŸäÿ©
                </button>
                <button onclick="saveDirectToGitHub()" style="background:linear-gradient(135deg, #dc3545 0%, #c82333 100%);color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:bold;box-shadow:0 4px 8px rgba(0,0,0,0.2);">
                    üíæ ÿ≠ŸÅÿ∏ ŸÖÿ®ÿßÿ¥ÿ± ÿ•ŸÑŸâ GitHub
                </button>
            </div>
            
            <!-- Bulk Import Section (Hidden by default) -->
            <div id="bulkImportSection" style="display:none;margin-top:20px;padding:20px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6;">
                <h4 style="color:#28a745;margin:0 0 15px 0;">üìã ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ¨ŸÖÿßÿπŸä</h4>
                <p style="margin:0 0 15px 0;color:#666;font-size:0.95em;">
                    ÿßŸÑÿµŸÇ ÿ®ŸäÿßŸÜÿßÿ™ JSON ÿ£Ÿà ÿ£ÿØÿÆŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ© ÿ®ÿ≥ÿ±ÿπÿ©. ŸäŸÖŸÉŸÜŸÉ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿµŸäÿ∫ÿ© JSON ŸÉÿßŸÖŸÑÿ© ÿ£Ÿà ŸÇÿßÿ¶ŸÖÿ© ÿ®ÿ≥Ÿäÿ∑ÿ©.
                </p>
                
                <!-- Format Selection -->
                <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:8px;font-weight:bold;color:#333;">ÿßÿÆÿ™ÿ± ÿßŸÑÿµŸäÿ∫ÿ©:</label>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button onclick="setBulkImportFormat('json')" id="formatJsonBtn" style="background:#007bff;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">
                            JSON Format
                        </button>
                        <button onclick="setBulkImportFormat('csv')" id="formatCsvBtn" style="background:#6c757d;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">
                            CSV Format
                        </button>
                    </div>
                </div>
                
                <!-- Format Examples -->
                <div id="formatExample" style="margin-bottom:15px;padding:15px;background:#e7f3ff;border-radius:6px;border:1px solid #007bff;">
                    <strong style="color:#007bff;">ŸÖÿ´ÿßŸÑ JSON:</strong>
                    <pre style="margin:10px 0 0 0;padding:10px;background:#fff;border-radius:4px;overflow-x:auto;font-size:0.85em;">[
  {
    "inspector": "ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ",
    "day": "2025-10-01",
    "shift": "ÿµÿ®ÿßÿ≠Ÿäÿ©",
    "area": "ÿ≥ŸàŸÇ ÿßŸÑŸÖŸäŸÜÿßÿ°",
    "shops": ["ŸÖÿ≠ŸÑ 1", "ŸÖÿ≠ŸÑ 2"]
  }
]</pre>
                </div>
                
                <textarea id="bulkImportData" rows="12" placeholder="ÿßŸÑÿµŸÇ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸáŸÜÿß..." style="width:100%;padding:12px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;font-family:monospace;font-size:0.95em;"></textarea>
                
                <div style="margin-top:15px;display:flex;gap:10px;justify-content:center;">
                    <button onclick="processBulkImport()" style="background:#28a745;color:#fff;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;font-weight:bold;">
                        ‚úÖ ŸÖÿπÿßŸÑÿ¨ÿ© Ÿàÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ
                    </button>
                    <button onclick="validateBulkImport()" style="background:#17a2b8;color:#fff;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;">
                        üîç ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÅŸÇÿ∑
                    </button>
                    <button onclick="closeBulkImport()" style="background:#6c757d;color:#fff;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;">
                        ‚ùå ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
                
                <div id="bulkImportStatus" style="margin-top:15px;padding:10px;border-radius:6px;font-weight:bold;"></div>
            </div>
            
            <!-- Clone Section (Hidden by default) -->
            <div id="cloneSection" style="display:none;margin-top:20px;padding:20px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6;">
                <h4 style="color:#17a2b8;margin:0 0 15px 0;">üìë ŸÜÿ≥ÿÆ ÿÆÿ∑ÿ© ŸÖŸàÿ¨ŸàÿØÿ©</h4>
                <p style="margin:0 0 15px 0;color:#666;font-size:0.95em;">
                    ÿßÿÆÿ™ÿ± ÿÆÿ∑ÿ© ŸÖŸàÿ¨ŸàÿØÿ© ŸàÿßŸÜÿ≥ÿÆŸáÿß ÿ®ÿ™Ÿàÿßÿ±ŸäÿÆ ŸÖÿÆÿ™ŸÑŸÅÿ© ÿ®ÿ≥ÿ±ÿπÿ©
                </p>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:8px;font-weight:bold;color:#333;">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥:</label>
                    <select id="cloneInspector" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                        <option value="">ÿßÿÆÿ™ÿ± ŸÖŸÅÿ™ÿ¥</option>
                    </select>
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:8px;font-weight:bold;color:#333;">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ£ÿµŸÑŸä:</label>
                    <select id="cloneSourceDate" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                        <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</option>
                    </select>
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:8px;font-weight:bold;color:#333;">ŸÜÿ≥ÿÆ ÿ•ŸÑŸâ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ (ŸÖŸÅÿµŸàŸÑÿ© ÿ®ŸÅŸàÿßÿµŸÑ):</label>
                    <input type="text" id="cloneTargetDates" placeholder="2025-10-05, 2025-10-12, 2025-10-19" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;">
                    <small style="color:#666;font-size:0.85em;">ŸÖÿ´ÿßŸÑ: 2025-10-05, 2025-10-12, 2025-10-19</small>
                </div>
                
                <div style="margin-top:15px;display:flex;gap:10px;justify-content:center;">
                    <button onclick="processClone()" style="background:#17a2b8;color:#fff;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;font-weight:bold;">
                        ‚úÖ ŸÜÿ≥ÿÆ ÿßŸÑÿÆÿ∑ÿ©
                    </button>
                    <button onclick="closeClone()" style="background:#6c757d;color:#fff;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;">
                        ‚ùå ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
                
                <div id="cloneStatus" style="margin-top:15px;padding:10px;border-radius:6px;font-weight:bold;"></div>
            </div>
            
            <!-- Batch Operations Section (Hidden by default) -->
            <div id="batchOperationsSection" style="display:none;margin-top:20px;padding:20px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6;">
                <h4 style="color:#ffc107;margin:0 0 15px 0;">üîÑ ÿπŸÖŸÑŸäÿßÿ™ ÿØŸÅÿπŸäÿ© ÿπŸÑŸâ ŸÜÿ∑ÿßŸÇ ÿ™ÿßÿ±ŸäÿÆŸä</h4>
                <p style="margin:0 0 15px 0;color:#666;font-size:0.95em;">
                    ŸÜŸÅÿ∞ ÿπŸÖŸÑŸäÿßÿ™ ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿÆÿ∑ÿ∑ ŸÅŸä ŸÜÿ∑ÿßŸÇ ÿ≤ŸÖŸÜŸä ŸÖÿ≠ÿØÿØ
                </p>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:bold;color:#333;">ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ:</label>
                        <input type="date" id="batchFromDate" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:bold;color:#333;">ÿ•ŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ:</label>
                        <input type="date" id="batchToDate" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                    </div>
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:8px;font-weight:bold;color:#333;">ÿßŸÑÿπŸÖŸÑŸäÿ©:</label>
                    <select id="batchOperation" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                        <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿπŸÖŸÑŸäÿ©</option>
                        <option value="delete">ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿÆÿ∑ÿ∑ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÜÿ∑ÿßŸÇ</option>
                        <option value="changeShift">ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©</option>
                        <option value="changeInspector">ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÖŸÅÿ™ÿ¥</option>
                        <option value="addShops">ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑÿßÿ™</option>
                    </select>
                </div>
                
                <!-- Operation-specific fields (shown based on selection) -->
                <div id="batchOperationFields" style="margin-bottom:15px;"></div>
                
                <div style="margin-top:15px;display:flex;gap:10px;justify-content:center;">
                    <button onclick="processBatchOperation()" style="background:#ffc107;color:#000;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;font-weight:bold;">
                        ‚úÖ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿπŸÖŸÑŸäÿ©
                    </button>
                    <button onclick="closeBatchOperations()" style="background:#6c757d;color:#fff;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;">
                        ‚ùå ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
                
                <div id="batchOperationStatus" style="margin-top:15px;padding:10px;border-radius:6px;font-weight:bold;"></div>
            </div>
        </div>
    </div>
    
    <!-- Data Table Container - Hidden when maintenance is active -->
    <div id="planTableContainer" class="plan-table-container"></div>
    
    <!-- Maintenance Mode Overlay - Replaces table when active -->
    <div id="maintenanceOverlay" style="display:none;">
        <div class="maintenance-content">
            <button id="maintenanceCloseBtn" class="maintenance-close-btn" onclick="closeMaintenance()" title="ÿ•ÿ∫ŸÑÿßŸÇ (ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑)">√ó</button>
            <div class="maintenance-icon">
                <div class="shield-icon">üõ°Ô∏è</div>
                <div class="lock-icon">üîí</div>
            </div>
            <h2 class="maintenance-title">ÿßŸÑÿ≤ŸÖŸÑÿßÿ° ÿßŸÑÿ£ÿπÿ≤ÿßÿ°</h2>
            <p class="maintenance-message">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¢ŸÜ</p>
            <p class="maintenance-submessage">ŸäŸèÿ±ÿ¨Ÿä ÿßŸÑÿ•ŸÜÿ™ÿ∏ÿßÿ±</p>
            <div class="maintenance-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <div class="maintenance-details" id="maintenanceDetails"></div>
        </div>
    </div>
    
    <!-- Main Quick Actions -->
    <div class="actions-row">
        <div class="actions-line">
            <button class="icon-btn refresh-btn tooltip" onclick="loadInspectionData()" data-tooltip="ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ">
                <span class="icon">üîÑ</span>
                <span class="label">ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
            </button>
            
            <button class="icon-btn pdf-btn tooltip" onclick="exportTableToPDF()" data-tooltip="ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ¨ÿØŸàŸÑ ŸÉŸÖŸÑŸÅ PDF">
                <span class="icon">üìÑ</span>
                <span class="label">ÿ≠ŸÅÿ∏ ŸÉŸÄ PDF</span>
            </button>
            
            <button class="icon-btn excel-btn tooltip" onclick="exportTableToExcel()" data-tooltip="ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ¨ÿØŸàŸÑ ŸÉŸÖŸÑŸÅ Excel">
                <span class="icon">üìà</span>
                <span class="label">ÿ≠ŸÅÿ∏ ŸÉŸÄ Excel</span>
            </button>
            
            <button class="icon-btn print-btn tooltip" onclick="printTable()" data-tooltip="ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ¨ÿØŸàŸÑ ŸÖÿ®ÿßÿ¥ÿ±ÿ©">
                <span class="icon">üñ®Ô∏è</span>
                <span class="label">ÿ∑ÿ®ÿßÿπÿ©</span>
            </button>
            
            <button id="fileLibraryBtn" class="icon-btn files-btn tooltip" onclick="toggleFileManagement()" data-tooltip="ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸàÿßŸÑŸàÿ´ÿßÿ¶ŸÇ" style="display: none;">
                <span class="icon">üìÇ</span>
                <span class="label">ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™</span>
            </button>
        </div>
    </div>

    <!-- System Services Management -->
    <div class="system-services-container" id="systemServicesContainer" style="display: block;">
        <div class="system-services-header" onclick="toggleSystemServices()">
            <span class="system-services-icon" id="systemServicesIcon">‚öôÔ∏è</span>
            <span>ÿ•ÿØÿßÿ±ÿ© ÿÆÿØŸÖÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ</span>
            <small style="margin-right: 10px; font-size: 0.8em; opacity: 0.9;">ÿßŸÜŸÇÿ± ŸÑŸÑŸàÿµŸàŸÑ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿØŸàÿßÿ™</small>
        </div>
        <div class="system-services-content" id="systemServicesContent">
            <div class="services-grid">
                <!-- Reports & Analytics Category -->
                <div class="service-category" id="reportsCategory">
                    <div class="service-category-title">üìä ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ŸàÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™</div>
                    <div class="service-icons-grid">
                        <button class="icon-btn inspector-report-btn tooltip" onclick="showInspectorReport()" data-tooltip="ÿπÿ±ÿ∂ ÿ™ŸÇÿ±Ÿäÿ± ŸÖŸÅÿµŸÑ ŸÑŸÑŸÖŸÅÿ™ÿ¥">
                            <span class="icon">üë§</span>
                            <span class="label">ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥</span>
                        </button>
                        
                        <button class="icon-btn monthly-report-btn tooltip" onclick="showMonthlyReport()" data-tooltip="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¥Ÿáÿ±Ÿä ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä">
                            <span class="icon">üìÖ</span>
                            <span class="label">ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¥Ÿáÿ±Ÿä</span>
                        </button>
                        
                        <button class="icon-btn enhanced-report-btn tooltip" onclick="showEnhancedReportsModal()" data-tooltip="ÿ™ŸÇÿßÿ±Ÿäÿ± ŸÖÿ™ŸÇÿØŸÖÿ© Ÿàÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿ∞ŸÉŸäÿ©">
                            <span class="icon">üìä</span>
                            <span class="label">ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©</span>
                        </button>
                        
                        <button class="icon-btn smart-stats-btn tooltip" onclick="showSmartMonthlyStatsReport()" data-tooltip="ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ¥Ÿáÿ±Ÿäÿ© ÿ∞ŸÉŸäÿ© ŸàŸÖÿ®ÿ™ŸÉÿ±ÿ©">
                            <span class="icon">üéØ</span>
                            <span class="label">ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©</span>
                        </button>
                        
                        <button class="icon-btn shop-priority-btn tooltip" onclick="showShopPriorityModal()" data-tooltip="ÿπÿ±ÿ∂ ÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÅŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ (ŸÑŸÑÿπÿ±ÿ∂ ŸÅŸÇÿ∑)">
                            <span class="icon">üìä</span>
                            <span class="label">ÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</span>
                        </button>
                    </div>
                </div>

                <!-- Schedule Management Category -->
                <div class="service-category developer-only-category" id="scheduleCategory">
                    <div class="service-category-title">üìã ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ¨ÿØÿßŸàŸÑ</div>
                    <div class="service-icons-grid">
                        <button class="icon-btn monthly-schedule-btn tooltip" onclick="showMonthlyScheduleModal()" data-tooltip="ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿä ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ">
                            <span class="icon">üìã</span>
                            <span class="label">ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™</span>
                        </button>
                        
                        <button class="icon-btn smart-rotation-btn tooltip" onclick="showSmartRotationModal()" data-tooltip="ÿ™Ÿàÿ≤Ÿäÿπ ÿ∞ŸÉŸä ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™ ÿπŸÑŸâ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ">
                            <span class="icon">üîÑ</span>
                            <span class="label">ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ∞ŸÉŸä</span>
                        </button>
                        
                        <button class="icon-btn vacation-tracker-btn tooltip" onclick="showVacationTrackerModal()" data-tooltip="ÿ™ÿ™ÿ®ÿπ ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ">
                            <span class="icon">üèñÔ∏è</span>
                            <span class="label">ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™</span>
                        </button>
                    </div>
                </div>

                <!-- Data Management Category -->
                <div class="service-category developer-only-category" id="dataManagementCategory">
                    <div class="service-category-title">üè™ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</div>
                    <div class="service-icons-grid">
                        <button class="icon-btn shops-management-btn tooltip" onclick="showShopsManagementModal()" data-tooltip="ÿ•ÿØÿßÿ±ÿ© ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸàÿßŸÑŸÖŸÜÿßÿ∑ŸÇ">
                            <span class="icon">üè™</span>
                            <span class="label">ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</span>
                        </button>
                        
                        <button class="icon-btn preview-btn tooltip" onclick="showFilePreviewModal()" data-tooltip="ŸÖÿπÿßŸäŸÜÿ© ŸÖŸÑŸÅÿßÿ™ PDF Ÿà Excel">
                            <span class="icon">üëÅÔ∏è</span>
                            <span class="label">ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Separate Pages within System Services -->
        <!-- Smart Distribution Page -->
        <div id="smartDistributionPage" class="service-page">
            <div class="service-page-header">
                <div class="service-page-title">
                    <span>üîÑ</span>
                    <span>ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ∞ŸÉŸä ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™ ÿπŸÑŸâ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</span>
                </div>
                <button class="service-page-close" onclick="closeServicePage('smartDistributionPage')" title="ÿ•ÿ∫ŸÑÿßŸÇ">√ó</button>
            </div>
            <div id="smartDistributionPageContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
        
        <!-- Vacation Tracking Page -->
        <div id="vacationTrackingPage" class="service-page">
            <div class="service-page-header">
                <div class="service-page-title">
                    <span>üèñÔ∏è</span>
                    <span>ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸàÿßŸÑÿπÿ∑ŸÑ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©</span>
                </div>
                <button class="service-page-close" onclick="closeServicePage('vacationTrackingPage')" title="ÿ•ÿ∫ŸÑÿßŸÇ">√ó</button>
            </div>
            <div id="vacationTrackingPageContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
        
        <!-- Shops Management Page -->
        <div id="shopsManagementPage" class="service-page">
            <div class="service-page-header">
                <div class="service-page-title">
                    <span>üè™</span>
                    <span>ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿÆÿßÿ∂ÿπÿ© ŸÑŸÑÿ±ŸÇÿßÿ®ÿ© ŸàÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥</span>
                </div>
                <button class="service-page-close" onclick="closeServicePage('shopsManagementPage')" title="ÿ•ÿ∫ŸÑÿßŸÇ">√ó</button>
            </div>
            <div id="shopsManagementPageContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
    <div id="inspectorReportDiv" class="inspector-report-div" style="display:none;"></div>
    <div id="monthlyReportModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <button class="close-btn" onclick="closeMonthlyReportModal()">√ó</button>
        <div class="stats-title">ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¥Ÿáÿ±Ÿä</div>
        <div class="modal-actions">
            <button class="pdf-btn" onclick="exportMonthlyReportToPDF()">ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ŸÉŸÄ PDF</button>
            <button class="excel-btn" onclick="exportMonthlyReportToExcel()">ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ŸÉŸÄ Excel</button>
        </div>
        <div id="monthlyReportContent"></div>
      </div>
    </div>

    <!-- ŸÖŸàÿØÿßŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ© -->
    <div id="smartStatsModal" class="modal-overlay" style="display:none;">
      <div class="modal-content" style="max-width: 1200px;">
        <button class="close-btn" onclick="closeSmartStatsModal()">√ó</button>
        <div class="stats-title">üìä ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© ÿßŸÑÿ∞ŸÉŸäÿ©</div>
        <div class="modal-actions">
            <button class="pdf-btn" onclick="exportSmartStatsToPDF()">ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ŸÉŸÄ PDF</button>
            <button class="excel-btn" onclick="exportSmartStatsToExcel()">ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ŸÉŸÄ Excel</button>
        </div>
        
        <!-- ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ± -->
        <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">ÿßŸÑÿ¥Ÿáÿ±:</label>
                    <select id="smartStatsMonth" onchange="refreshSmartStats()" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                        <option value="">-- ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¥Ÿáÿ± --</option>
                        <option value="1">ŸäŸÜÿßŸäÿ±</option>
                        <option value="2">ŸÅÿ®ÿ±ÿßŸäÿ±</option>
                        <option value="3">ŸÖÿßÿ±ÿ≥</option>
                        <option value="4">ÿ£ÿ®ÿ±ŸäŸÑ</option>
                        <option value="5">ŸÖÿßŸäŸà</option>
                        <option value="6">ŸäŸàŸÜŸäŸà</option>
                        <option value="7">ŸäŸàŸÑŸäŸà</option>
                        <option value="8">ÿ£ÿ∫ÿ≥ÿ∑ÿ≥</option>
                        <option value="9">ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±</option>
                        <option value="10">ÿ£ŸÉÿ™Ÿàÿ®ÿ±</option>
                        <option value="11">ŸÜŸàŸÅŸÖÿ®ÿ±</option>
                        <option value="12">ÿØŸäÿ≥ŸÖÿ®ÿ±</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">ÿßŸÑÿ≥ŸÜÿ©:</label>
                    <select id="smartStatsYear" onchange="refreshSmartStats()" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                        <option value="2025">2025</option>
                        <option value="2024" selected>2024</option>
                        <option value="2023">2023</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div id="smartStatsContent"></div>
      </div>
    </div>

    <!-- ŸÖŸàÿØÿßŸÑ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ© -->
    <div id="enhancedReportsModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <button class="close-btn" onclick="closeEnhancedReportsModal()">√ó</button>
        <div class="stats-title">ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©</div>
        
        <!-- ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± -->
        <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
            <h4 style="margin:0 0 15px 0;color:#234085;">ŸÜŸàÿπ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±:</h4>
            <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;">
                <label style="display:flex;align-items:center;gap:5px;">
                    <input type="radio" name="reportType" value="inspector-monthly" checked>
                    ÿ™ŸÇÿ±Ÿäÿ± ÿ¥Ÿáÿ±Ÿä ŸÑŸÖŸÅÿ™ÿ¥ ŸÖÿ≠ÿØÿØ
                </label>
                <label style="display:flex;align-items:center;gap:5px;">
                    <input type="radio" name="reportType" value="inspector-yearly">
                    ÿ™ŸÇÿ±Ÿäÿ± ÿ≥ŸÜŸàŸä ŸÑŸÖŸÅÿ™ÿ¥ ŸÖÿ≠ÿØÿØ
                </label>
                <label style="display:flex;align-items:center;gap:5px;">
                    <input type="radio" name="reportType" value="all-monthly">
                    ÿ™ŸÇÿ±Ÿäÿ± ÿ¥Ÿáÿ±Ÿä ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ
                </label>
                <label style="display:flex;align-items:center;gap:5px;">
                    <input type="radio" name="reportType" value="all-yearly">
                    ÿ™ŸÇÿ±Ÿäÿ± ÿ≥ŸÜŸàŸä ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ
                </label>
                <label style="display:flex;align-items:center;gap:5px;">
                    <input type="radio" name="reportType" value="shop-analytics">
                    üìä ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©
                </label>
            </div>
        </div>
        
        <!-- ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸÖŸÅÿ™ÿ¥ -->
        <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">ÿßŸÑŸÖŸÅÿ™ÿ¥:</label>
                    <select id="reportInspectorSelect" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                        <option value="">-- ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ --</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">ÿßŸÑÿ≥ŸÜÿ©:</label>
                    <select id="reportYear" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">ÿßŸÑÿ¥Ÿáÿ±:</label>
                    <select id="reportMonth" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                        <option value="">-- ÿ¨ŸÖŸäÿπ ÿßŸÑÿ¥ŸáŸàÿ± --</option>
                        <option value="01">ŸäŸÜÿßŸäÿ±</option>
                        <option value="02">ŸÅÿ®ÿ±ÿßŸäÿ±</option>
                        <option value="03">ŸÖÿßÿ±ÿ≥</option>
                        <option value="04">ÿ£ÿ®ÿ±ŸäŸÑ</option>
                        <option value="05">ŸÖÿßŸäŸà</option>
                        <option value="06">ŸäŸàŸÜŸäŸà</option>
                        <option value="07">ŸäŸàŸÑŸäŸà</option>
                        <option value="08">ÿ£ÿ∫ÿ≥ÿ∑ÿ≥</option>
                        <option value="09">ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±</option>
                        <option value="10">ÿ£ŸÉÿ™Ÿàÿ®ÿ±</option>
                        <option value="11">ŸÜŸàŸÅŸÖÿ®ÿ±</option>
                        <option value="12">ÿØŸäÿ≥ŸÖÿ®ÿ±</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ŸàŸÑŸäÿØ ŸàÿßŸÑÿ≠ŸÅÿ∏ -->
        <div style="margin-bottom:15px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
            <button onclick="generateEnhancedReport()" style="background:#28a745;color:#fff;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;font-weight:bold;">ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</button>
            <button onclick="exportEnhancedReportToPDF()" style="background:#dc3545;color:#fff;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;">ÿ≠ŸÅÿ∏ ŸÉŸÄ PDF</button>
            <button onclick="exportEnhancedReportToExcel()" style="background:#28a745;color:#fff;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;">ÿ≠ŸÅÿ∏ ŸÉŸÄ Excel</button>
        </div>
        
        <!-- ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± -->
        <div id="enhancedReportContent" style="max-height:400px;overflow-y:auto;"></div>
      </div>
    </div>

    <!-- ŸÖŸàÿØÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ -->
    <div id="inspectorsModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <button class="close-btn" onclick="closeInspectorsModal()">√ó</button>
        <div class="stats-title">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</div>
        <div style="margin-bottom:15px;">
            <input type="text" id="newInspectorName" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿßŸÑÿ¨ÿØŸäÿØ" style="padding:8px;border:1px solid #ccc;border-radius:4px;margin-left:10px;">
            <button onclick="addNewInspector()" style="background:#28a745;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÅÿ™ÿ¥</button>
        </div>
        <div id="inspectorsList" style="max-height:300px;overflow-y:auto;"></div>
      </div>
    </div>

    <!-- ŸÖŸàÿØÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ -->
    <div id="areasModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <button class="close-btn" onclick="closeAreasModal()">√ó</button>
        <div class="stats-title">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</div>
        <div style="margin-bottom:15px;">
            <input type="text" id="newAreaName" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©" style="padding:8px;border:1px solid #ccc;border-radius:4px;margin-left:10px;">
            <button onclick="addNewArea()" style="background:#28a745;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇÿ©</button>
        </div>
        <div id="areasList" style="max-height:300px;overflow-y:auto;"></div>
      </div>
    </div>

    <!-- ŸÖŸàÿØÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ -->
    <div id="shopsModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <button class="close-btn" onclick="closeShopsModal()">√ó</button>
        <div class="stats-title">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px dashed #dee2e6;">
            <h4 style="margin: 0 0 10px 0; color: #234085; font-size: 1em;">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ ÿ®ÿ≥ÿ±ÿπÿ©:</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.9em; color: #495057;">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ:</label>
                    <input type="text" id="newShopName" placeholder="ŸÖÿ´ÿßŸÑ: ŸÖÿ≠ŸÑ ÿßŸÑÿ∑ŸäŸàÿ± ÿßŸÑÿ≥ÿπŸäÿØÿ©" style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.95em;">
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.9em; color: #495057;">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:</label>
                    <select id="newShopArea" style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.95em;">
                        <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</option>
                    </select>
                </div>
                <button onclick="addNewShopQuick()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap; box-shadow: 0 2px 5px rgba(40,167,69,0.3);">
                    ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ
                </button>
            </div>
        </div>
        <div id="shopsList" style="max-height:300px;overflow-y:auto;"></div>
      </div>
    </div>

    <!-- ŸÖŸàÿØÿßŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ ÿßŸÑŸÖÿ≠ÿ≥ŸÜ -->
    <!-- ŸÖŸàÿØÿßŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ ÿßŸÑŸÖÿ≠ÿ≥ŸÜ -->
    <div id="shopDetailsModal" class="modal-overlay" style="display:none;">
      <div class="modal-content" style="max-width: 700px; border-radius: 15px;">
        <button class="close-btn" onclick="closeShopDetailsModal()">√ó</button>
        <div class="stats-title" style="text-align: center; margin-bottom: 20px; color: #234085;">
          üè™ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ
        </div>
        
        <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿØÿßÿ±ÿ© ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑ -->
        <div id="shopEditControls" style="display: none; text-align: center; margin-bottom: 15px;">
          <button id="shopEditModeBtn" onclick="toggleShopEditMode()" 
                  style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 0 5px;">
            ‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ
          </button>
          <button id="shopSaveBtn" onclick="saveShopDetails()" 
                  style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 0 5px;">
            üíæ ÿ≠ŸÅÿ∏
          </button>
          <button id="shopCancelBtn" onclick="cancelShopEdit()" 
                  style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 0 5px;">
            ‚ùå ÿ•ŸÑÿ∫ÿßÿ°
          </button>
        </div>
        
        <!-- ÿ±ÿ≥ÿßŸÑÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ŸÅÿ∏ -->
        <div id="shopSaveStatus" style="text-align: center; margin-bottom: 10px; display: none;"></div>
        
        <div id="shopDetailsContent" style="padding: 20px 0;">
          <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸáŸÜÿß ÿ®ÿßŸÑŸÄ JavaScript -->
        </div>
      </div>
    </div>

    <div class="footer">
        ÿ™ŸÖ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿ®Ÿàÿßÿ≥ÿ∑ÿ© &copy; ÿßŸÑŸÖÿ∑Ÿàÿ± ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ
    </div>
</div>

<!-- Inspector Details Modal - ŸÖŸàÿØÿßŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿßŸÑÿ¥ÿßŸÖŸÑ -->
<div id="inspectorDetailsModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width: 1400px; max-height: 90vh; overflow-y: auto;">
    <button class="close-btn" onclick="closeInspectorDetailsModal()">√ó</button>
    <div class="stats-title" id="inspectorDetailsTitle" style="text-align: center; margin-bottom: 20px; color: #234085; font-size: 1.8em;">
      üë§ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿßŸÑÿ¥ÿßŸÖŸÑÿ©
    </div>
    
    <!-- Quick Stats Overview -->
    <div id="inspectorQuickStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
      <!-- Stats will be populated dynamically -->
    </div>
    
    <!-- Tab Navigation -->
    <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 2px solid #e0e6f0; padding-bottom: 10px;">
      <button class="inspector-tab-btn active" onclick="showInspectorTab('inspections')" data-tab="inspections" style="background: #234085; color: #fff; border: none; padding: 10px 20px; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s;">
        üìã ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ŸàÿßŸÑŸÇÿßÿØŸÖÿ©
      </button>
      <button class="inspector-tab-btn" onclick="showInspectorTab('report')" data-tab="report" style="background: #e0e6f0; color: #234085; border: none; padding: 10px 20px; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s;">
        üë§ ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥
      </button>
      <button class="inspector-tab-btn" onclick="showInspectorTab('statistics')" data-tab="statistics" style="background: #e0e6f0; color: #234085; border: none; padding: 10px 20px; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s;">
        üéØ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©
      </button>
      <button class="inspector-tab-btn" onclick="showInspectorTab('analytics')" data-tab="analytics" style="background: #e0e6f0; color: #234085; border: none; padding: 10px 20px; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s;">
        üìä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©
      </button>
    </div>
    
    <!-- Tab Content -->
    <div id="inspectorTabContent" style="min-height: 300px;">
      <!-- Content will be populated dynamically -->
    </div>
    
    <!-- Export Actions -->
    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
      <button onclick="exportInspectorDetailsToPDF()" style="background: #dc3545; color: #fff; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-weight: 600;">
        üìÑ ÿ™ÿµÿØŸäÿ± ŸÉŸÑ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ŸÑŸâ PDF
      </button>
      <button onclick="exportInspectorDetailsToExcel()" style="background: #28a745; color: #fff; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-weight: 600;">
        üìä ÿ™ÿµÿØŸäÿ± ŸÉŸÑ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ŸÑŸâ Excel
      </button>
    </div>
  </div>
</div>

<!-- Bell Notes Modal -->
<div class="bell-modal" id="bellModal">
    <div class="bell-bubble">
        <h3>ÿ™Ÿàÿ¨ŸäŸáÿßÿ™ Ÿàÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</h3>
        <div class="bell-info" id="bellInfo">
            <div id="bellInfoText" style="cursor: pointer;">ÿ™Ÿàÿ¨ŸäŸáÿßÿ™ Ÿàÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÑŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ - Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏Ÿáÿß ŸÖÿ±ŸÉÿ≤ŸäÿßŸã ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</div>
            <input type="text" id="bellInfoEdit" style="display: none; width: 100%; border: none; background: transparent; font: inherit; color: inherit; text-align: center;" value="ÿ™Ÿàÿ¨ŸäŸáÿßÿ™ Ÿàÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÑŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ - Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏Ÿáÿß ŸÖÿ±ŸÉÿ≤ŸäÿßŸã ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ">
        </div>
        
        <!-- Add new notification section -->
        <div class="add-notification-section" id="addNotificationSection" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="margin: 0 0 10px 0; color: #495057;">ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ¥ÿπÿßÿ± ÿ¨ÿØŸäÿØ:</h4>
            <textarea 
                id="newNotificationInput" 
                placeholder="ÿßŸÉÿ™ÿ® ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ¨ÿØŸäÿØ ŸáŸÜÿß..."
                style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-family: inherit;"
                dir="rtl"
            ></textarea>
            <div style="margin-top: 8px;">
                <label style="display: block; margin-bottom: 4px; color: #495057; font-weight: 500;">üë§ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ§ŸÑŸÅ/ÿßŸÑŸÖÿ±ÿ≥ŸÑ:</label>
                <input 
                    type="text" 
                    id="newNotificationAuthor" 
                    placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ§ŸÑŸÅ (ŸÖÿ´ÿßŸÑ: ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ)"
                    value="ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"
                    dir="rtl"
                />
            </div>
            <button onclick="addNewNotification()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-top: 8px;">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ¥ÿπÿßÿ±</button>
        </div>
        
        <!-- Notifications list -->
        <div class="notifications-list" id="notificationsList">
            <!-- Individual notifications will be displayed here -->
        </div>
        
        <!-- Legacy textarea for backward compatibility -->
        <textarea 
            class="bell-notes-textarea" 
            id="bellNotesTextarea" 
            placeholder="ÿ£Ÿà ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿ≥ÿßÿ≠ÿ© ÿßŸÑŸÉÿ®Ÿäÿ±ÿ© ŸáŸÜÿß ŸÑŸÉÿ™ÿßÿ®ÿ© ÿπÿØÿ© ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™..."
            dir="rtl"
            style="margin-top: 15px;"
        ></textarea>
        
        <div class="bell-bubble-actions">
            <button class="bell-action-btn bell-save-btn" id="bellSaveBtn">üíæ ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™</button>
            <button class="bell-action-btn bell-clear-btn" id="bellClearBtn">üóëÔ∏è ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ</button>
            <button class="bell-action-btn bell-export-btn" id="bellExportBtn" style="background:#dc3545;display:none;">üì§ ÿ≠ŸÅÿ∏ ŸÜŸáÿßÿ¶Ÿä</button>
            <button class="bell-action-btn bell-close-btn" id="bellCloseBtn">‚úñÔ∏è ÿ•ÿ∫ŸÑÿßŸÇ</button>
        </div>
    </div>
</div>

<!-- ŸÖŸàÿØÿßŸÑ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿä -->
<div id="monthlyScheduleModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width: 95%; width: 1200px;">
        <button class="close-btn" onclick="closeMonthlyScheduleModal()">√ó</button>
        <div class="stats-title">üìã ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿä ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</div>
        
        <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ -->
        <div class="modal-actions" style="margin-bottom: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; align-items: center;">
            <input type="file" id="scheduleFileInput" accept=".json,.xlsx,.pdf,.csv,.txt,.doc,.docx" style="display: none;" onchange="handleScheduleFileUpload(event)">
            
            <button id="scheduleUploadBtn" class="icon-btn tooltip" onclick="handleScheduleUploadRequest()" data-tooltip="ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white;">
                <span class="icon">üì§</span>
                <span class="label">ÿ±ŸÅÿπ ŸÖŸÑŸÅ</span>
            </button>
            
            <button class="icon-btn pdf-btn tooltip" onclick="confirmExportScheduleToPDF()" data-tooltip="ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ŸÉŸÖŸÑŸÅ PDF">
                <span class="icon">üìÑ</span>
                <span class="label">ÿ™ÿ≠ŸÖŸäŸÑ PDF</span>
            </button>
            
            <button class="icon-btn excel-btn tooltip" onclick="confirmExportScheduleToExcel()" data-tooltip="ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ŸÉŸÖŸÑŸÅ Excel">
                <span class="icon">üìä</span>
                <span class="label">ÿ™ÿ≠ŸÖŸäŸÑ Excel</span>
            </button>
            
            <button id="scheduleJsonBtn" class="icon-btn tooltip" onclick="downloadScheduleAsJSON()" data-tooltip="ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ŸÉŸÖŸÑŸÅ JSON (ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑)" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; display: none;">
                <span class="icon">üíæ</span>
                <span class="label">ÿ™ÿ≠ŸÖŸäŸÑ JSON</span>
            </button>
            
            <button class="icon-btn print-btn tooltip" onclick="printScheduleTable()" data-tooltip="ÿ∑ÿ®ÿßÿπÿ© ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™">
                <span class="icon">üñ®Ô∏è</span>
                <span class="label">ÿ∑ÿ®ÿßÿπÿ©</span>
            </button>
        </div>
        
        <!-- ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑŸÅŸÑÿ™ÿ±ÿ© -->
        <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; align-items: end;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ¨ÿØŸàŸÑ:</label>
                    <input type="text" id="scheduleSearchInput" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÅÿ™ÿ¥ ÿ£Ÿà ŸÖŸÜÿ∑ŸÇÿ©..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" oninput="filterScheduleTable()">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ¥Ÿáÿ±:</label>
                    <select id="scheduleMonthFilter" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" onchange="filterScheduleTable()">
                        <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ¥ŸáŸàÿ±</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸÅÿ™ÿ¥:</label>
                    <select id="scheduleInspectorFilter" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" onchange="filterScheduleTable()">
                        <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ±ŸÅŸàÿπÿ© -->
        <div id="uploadedFilesInfo" style="margin-bottom: 15px; padding: 10px; background: #e8f4f8; border-radius: 6px; display: none;">
            <h4 style="margin: 0 0 10px 0; color: #0c5460;">ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ±ŸÅŸàÿπÿ©:</h4>
            <div id="uploadedFilesList"></div>
        </div>
        
        <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ -->
        <div id="monthlyScheduleContent" style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px;">
            <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸáŸÜÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
        </div>
        
        <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© -->
        <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 0.9em; color: #0369a1;">
            <strong>ŸÖŸÑÿßÿ≠ÿ∏ÿ©:</strong> ŸäŸÖŸÉŸÜŸÉ ÿ±ŸÅÿπ ŸÖŸÑŸÅÿßÿ™ ÿ®ÿµŸäÿ∫ ŸÖÿ™ŸÜŸàÿπÿ©: JSONÿå Excelÿå PDFÿå CSVÿå TXTÿå DOC ŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿ£Ÿà ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿ¨ÿØÿßŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™. ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸäÿ∫ ŸÖÿØÿπŸàŸÖÿ© ÿßŸÑÿ¢ŸÜ!
        </div>
    </div>
</div>

<!-- ŸÖŸàÿØÿßŸÑ ÿßŸÑÿ™ÿØŸàŸäÿ± ÿßŸÑÿ∞ŸÉŸä ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™ ÿπŸÑŸâ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ -->
<div id="smartRotationModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width: 95%; width: 1200px;">
        <button class="close-btn" onclick="closeSmartRotationModal()">√ó</button>
        <div class="stats-title">üîÑ ÿßŸÑÿ™ÿØŸàŸäÿ± ÿßŸÑÿ∞ŸÉŸä ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™ ÿπŸÑŸâ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</div>
        
        <!-- ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ŸàŸÑŸäÿØ -->
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
            <h4 style="margin: 0 0 15px 0; color: #234085; text-align: center;">ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ∞ŸÉŸä</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©:</label>
                    <select id="rotationPeriod" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="day">ŸäŸàŸÖ Ÿàÿßÿ≠ÿØ</option>
                        <option value="week">ÿ£ÿ≥ÿ®Ÿàÿπ Ÿàÿßÿ≠ÿØ</option>
                        <option value="2weeks">ÿ£ÿ≥ÿ®ŸàÿπŸäŸÜ</option>
                        <option value="month" selected>ÿ¥Ÿáÿ± ŸÉÿßŸÖŸÑ</option>
                        <option value="quarter">ÿ´ŸÑÿßÿ´ÿ© ÿ£ÿ¥Ÿáÿ±</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ©:</label>
                    <input type="date" id="rotationStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÉŸÑ ŸÖŸÅÿ™ÿ¥ ŸäŸàŸÖŸäÿßŸã:</label>
                    <select id="shopsPerInspector" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="3">3 ŸÖÿ≠ŸÑÿßÿ™</option>
                        <option value="4">4 ŸÖÿ≠ŸÑÿßÿ™</option>
                        <option value="5" selected>5 ŸÖÿ≠ŸÑÿßÿ™</option>
                        <option value="6">6 ŸÖÿ≠ŸÑÿßÿ™</option>
                        <option value="7">7 ŸÖÿ≠ŸÑÿßÿ™</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÿßÿ≥ÿ™ÿ±ÿßÿ™Ÿäÿ¨Ÿäÿ© ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ:</label>
                    <select id="distributionStrategy" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="balanced" selected>ŸÖÿ™Ÿàÿßÿ≤ŸÜ (ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ)</option>
                        <option value="area_focused">ŸÖÿ±ŸÉÿ≤ ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>
                        <option value="random_fair">ÿπÿ¥Ÿàÿßÿ¶Ÿä ÿπÿßÿØŸÑ</option>
                        <option value="experience_based">ÿ≠ÿ≥ÿ® ÿßŸÑÿÆÿ®ÿ±ÿ©</option>
                        <option value="custom_inspectors">ŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÖÿÆÿµÿµŸäŸÜ</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ŸàŸÑŸäÿØ ÿßŸÑŸÖÿ™ÿÆÿµÿµ -->
        <div style="margin-bottom: 20px; padding: 15px; background: #fff8dc; border-radius: 8px; border: 1px solid #deb887;">
            <h4 style="margin: 0 0 15px 0; color: #8b4513; text-align: center;">üéØ ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ŸàŸÑŸäÿØ ÿßŸÑŸÖÿ™ÿÆÿµÿµ</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                <!-- ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ:</label>
                    <div id="inspectorSelection" style="max-height: 120px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: white;">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸáŸÜÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
                    </div>
                </div>
                
                <!-- ÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥:</label>
                    <select id="inspectionType" onchange="updateAreasBasedOnType()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>
                        <option value="external">ÿÆÿßÿ±ÿ¨Ÿä (ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑÿ£ÿÆÿ±Ÿâ)</option>
                        <option value="internal">ÿØÿßÿÆŸÑŸä (ŸÖŸÜÿßÿ∑ŸÇ ŸÖÿ≠ÿØÿØÿ©)</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÖÿ™ŸÇÿØŸÖÿ© -->
        <div style="margin-bottom: 20px; padding: 15px; background: #e8f4f8; border-radius: 8px; border: 1px solid #bee5eb;">
            <h5 style="margin: 0 0 10px 0; color: #0c5460;">‚öôÔ∏è ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÖÿ™ŸÇÿØŸÖÿ©</h5>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="avoidSameArea" checked>
                    <span>ÿ™ÿ¨ŸÜÿ® ŸÜŸÅÿ≥ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="balanceWorkload" checked>
                    <span>ÿ™Ÿàÿßÿ≤ŸÜ ÿ£ÿπÿ®ÿßÿ° ÿßŸÑÿπŸÖŸÑ</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="considerHistory" checked>
                    <span>ŸÖÿ±ÿßÿπÿßÿ© ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ≥ÿßÿ®ŸÇ</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="weekendRotation">
                    <span>ÿ™ÿ∂ŸÖŸäŸÜ ÿπÿ∑ŸÑÿ© ŸÜŸáÿßŸäÿ© ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</span>
                </label>
            </div>
        </div>
        
        <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿπŸÖŸÑ -->
        <div style="margin-bottom: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <button onclick="checkDeveloperAccess('smart-rotation', function() { generateSmartRotation(); })" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em;">
                üß† ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ÿØŸàŸäÿ± ÿßŸÑÿ∞ŸÉŸä
            </button>
            <button onclick="checkDeveloperAccess('smart-rotation', function() { previewRotation(); })" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                üëÅÔ∏è ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿÆÿ∑ÿ©
            </button>
            <button onclick="checkDeveloperAccess('smart-rotation', function() { analyzeCurrentDistribution(); })" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                üìä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ≠ÿßŸÑŸä
            </button>
        </div>
        
        <!-- ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ŸàÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ -->
        <div id="rotationResults" style="margin-top: 20px;">
            <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸáŸÜÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
        </div>
        
        <!-- ŸÖŸÜÿ∑ŸÇÿ© ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿÆÿ∑ÿ© ÿßŸÑŸÖŸàŸÑÿØÿ© -->
        <div id="rotationPreview" style="margin-top: 20px; display: none;">
            <h4 style="color: #234085; margin-bottom: 15px;">üìã ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿÆÿ∑ÿ© ÿßŸÑŸÖŸàŸÑÿØÿ©</h4>
            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; background: #fff;">
                <div id="rotationPreviewContent">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸáŸÜÿß -->
                </div>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                <button onclick="applyGeneratedRotation()" style="background: #dc3545; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                    ‚úÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿÆÿ∑ÿ©
                </button>
                <button onclick="exportRotationPlan()" style="background: #6c757d; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    üìÅ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿÆÿ∑ÿ©
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Initialize Smart Distribution Functions Early -->
<script>
// Define populateInspectorSelection function early so it's available when modal content is loaded
window.populateInspectorSelection = function() {
    const selectionDiv = document.getElementById('inspectorSelection');
    if (!selectionDiv) {
        console.log('Inspector selection div not found');
        return;
    }
    
    // Use multiple sources to get inspector data
    let availableInspectors = window.inspectorsData || (typeof inspectorsData !== 'undefined' ? inspectorsData : null) || [];
    
    // Try to get from localStorage
    if (!availableInspectors || availableInspectors.length === 0) {
        try {
            const planData = JSON.parse(localStorage.getItem('allPlanData') || '{}');
            availableInspectors = planData.inspectors || [];
        } catch (e) {
            console.log('Error parsing localStorage:', e);
        }
    }
    
    // Try to extract from the inspector dropdown if still no data
    if (!availableInspectors || availableInspectors.length === 0) {
        const inspectorSelect = document.querySelector('#inspectorSelect, select[id*="inspector"], #addInspectorSelect');
        if (inspectorSelect) {
            const options = Array.from(inspectorSelect.options).filter(opt => opt.value && opt.value !== '' && !opt.textContent.includes('ÿßÿÆÿ™ÿ±'));
            availableInspectors = options.map((opt, index) => ({
                id: opt.value || `inspector_${index + 1}`,
                name: opt.textContent.trim()
            }));
        }
    }
    
    // Fallback to hardcoded list based on actual data
    if (!availableInspectors || availableInspectors.length === 0) {
        availableInspectors = [
            { id: 'insp_1758830974747', name: 'ÿØ. ÿ¢ŸÖŸÜŸá ÿ®ŸÜ ÿµÿ±ŸÖ' },
            { id: 'insp_1758830963007', name: 'ÿØ. ÿ¢ŸäŸá ÿ≥ŸÑÿßŸÖÿ©' },
            { id: 'insp_1758830999876', name: 'ÿØ. ÿ≠ÿ≥ŸäŸÜÿ© ÿßŸÑÿπÿßŸÖÿ±Ÿä' },
            { id: 'insp_1758830985608', name: 'ÿØ. ÿ≠ÿµÿ© ÿßŸÑÿπŸÑŸä' },
            { id: 'insp_1758813880098', name: 'ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ' },
            { id: 'insp_1758830950586', name: 'ÿØ. ŸÅÿßŸäÿ≤ ÿßŸÑŸÖÿ≥ÿßŸÑŸÖÿ©' },
            { id: 'insp_1758830925093', name: 'ÿØ. ŸÖÿ≠ŸÖÿØ ÿ•ÿ≥ŸÖÿßÿπŸäŸÑ' },
            { id: 'insp_1758830939296', name: 'ÿØ. ŸÖÿ≠ŸÖÿØ ÿ≥ÿπŸäÿØ' },
            { id: 'insp_1758831014928', name: 'ÿØ. Ÿáÿßÿ¨ÿ± ÿßŸÑÿ∫ÿßŸÅÿ±Ÿä' }
        ];
    }
    
    console.log('Populating inspector selection, availableInspectors:', availableInspectors);
    
    if (availableInspectors.length === 0) {
        selectionDiv.innerHTML = '<p style="color: #666; text-align: center;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÖÿ™ÿßÿ≠ÿ©</p>';
        return;
    }
    
    let html = "";
    availableInspectors.forEach(inspector => {
        const inspectorId = inspector.id || inspector.name;
        const inspectorName = inspector.name || inspector;
        html += `
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                <input type="checkbox" name="selectedInspectors" value="${inspectorId}" checked 
                       style="margin: 0;">
                <span style="font-size: 0.9em;">${inspectorName}</span>
            </label>
        `;
    });
    
    // Add control buttons
    html += `
        <div style="margin-top: 10px; display: flex; gap: 8px; justify-content: center;">
            <button type="button" onclick="window.selectAllInspectors()" 
                    style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">
                ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ
            </button>
            <button type="button" onclick="window.deselectAllInspectors()" 
                    style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">
                ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ≠ÿØŸäÿØ
            </button>
        </div>
    `;
    
    console.log('Setting inspector selection HTML');
    selectionDiv.innerHTML = html;
};

// Also define helper functions early
window.selectAllInspectors = function() {
    const checkboxes = document.querySelectorAll('input[name="selectedInspectors"]');
    checkboxes.forEach(cb => cb.checked = true);
};

window.deselectAllInspectors = function() {
    const checkboxes = document.querySelectorAll('input[name="selectedInspectors"]');
    checkboxes.forEach(cb => cb.checked = false);
};

console.log('Smart distribution functions initialized');
</script>

<!-- ŸÖŸàÿØÿßŸÑ ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ -->
<div id="vacationTrackerModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width: 95%; width: 1200px;">
        <button class="close-btn" onclick="closeVacationTrackerModal()">√ó</button>
        <div class="stats-title">üèñÔ∏è ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸàÿßŸÑÿπÿ∑ŸÑ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©</div>
        
        <!-- ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ -->
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
            <h4 style="margin: 0 0 15px 0; color: #234085; text-align: center;">ÿÆŸäÿßÿ±ÿßÿ™ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©:</label>
                    <select id="vacationAnalysisPeriod" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="current_month" selected>ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä</option>
                        <option value="last_month">ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÖÿßÿ∂Ÿä</option>
                        <option value="custom_range">ŸÅÿ™ÿ±ÿ© ŸÖÿÆÿµÿµÿ©</option>
                        <option value="full_year">ÿßŸÑÿ≥ŸÜÿ© ŸÉÿßŸÖŸÑÿ©</option>
                    </select>
                </div>
                <div id="customDateRange" style="display: none;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ:</label>
                    <input type="date" id="vacationStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <label style="display: block; margin: 10px 0 5px 0; font-weight: bold;">ÿ•ŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ:</label>
                    <input type="date" id="vacationEndDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ŸÜŸàÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ:</label>
                    <select id="vacationAnalysisType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="weekly_offs" selected>ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©</option>
                        <option value="annual_leave">ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≥ŸÜŸàŸäÿ©</option>
                        <option value="sick_leave">ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ±ÿ∂Ÿäÿ©</option>
                        <option value="all_vacations">ÿ¨ŸÖŸäÿπ ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™</option>
                    </select>
                </div>
            </div>
            
            <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ -->
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="checkDeveloperAccess('vacation-tracking', analyzeVacations)" style="background: #ff8c00; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                    üîç ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
                </button>
                <button onclick="checkDeveloperAccess('vacation-tracking', importVacationSchedule)" style="background: #28a745; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    üì§ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿ¨ÿØŸàŸÑ ŸÖŸÜÿßŸàÿ®ÿßÿ™
                </button>
                <button onclick="checkDeveloperAccess('vacation-tracking', exportVacationReport)" style="background: #007bff; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    üìÅ ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
                </button>
            </div>
            
            <!-- ÿ±ŸÅÿπ ŸÖŸÑŸÅÿßÿ™ -->
            <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; border: 1px solid #1976d2;">
                <h5 style="margin: 0 0 10px 0; color: #1976d2;">ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™:</h5>
                <input type="file" id="vacationFileInput" accept=".xlsx,.pdf,.json,.csv,.txt,.doc,.docx" style="display: none;" onchange="handleVacationFileUpload(event)">
                <button onclick="checkDeveloperAccess('vacation-tracking', () => document.getElementById('vacationFileInput').click())" style="background: #1976d2; color: #fff; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                    üìé ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ (Excel, PDF, JSON, CSV, TXT, DOC)
                </button>
                <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #555;">ŸäŸÖŸÉŸÜŸÉ ÿ±ŸÅÿπ ŸÖŸÑŸÅÿßÿ™ ÿ®ÿµŸäÿ∫ ŸÖÿ™ŸÜŸàÿπÿ©: Excelÿå PDFÿå JSONÿå CSVÿå TXTÿå DOC ŸÑÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ£ŸäÿßŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã</p>
            </div>
        </div>
        
        <!-- ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ŸàÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ -->
        <div id="vacationAnalysisResults" style="margin-top: 20px;">
            <div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 3em;">üèñÔ∏è</div>
                <p>ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ŸàÿßŸÜŸÇÿ± ÿπŸÑŸâ "ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™" ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨</p>
            </div>
        </div>
        
        <!-- ÿ¨ÿØŸàŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ -->
        <div id="vacationManagementTable" style="margin-top: 20px; display: none;">
            <h4 style="color: #234085; margin-bottom: 15px;">üìã ÿ¨ÿØŸàŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™</h4>
            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; background: #fff;">
                <table id="vacationTable" style="width: 100%; border-collapse: collapse;">
                    <thead style="background: #f8f9fa; position: sticky; top: 0;">
                        <tr>
                            <th style="padding: 12px; border: 1px solid #dee2e6;">ÿßŸÑŸÖŸÅÿ™ÿ¥</th>
                            <th style="padding: 12px; border: 1px solid #dee2e6;">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                            <th style="padding: 12px; border: 1px solid #dee2e6;">ÿßŸÑŸäŸàŸÖ</th>
                            <th style="padding: 12px; border: 1px solid #dee2e6;">ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©</th>
                            <th style="padding: 12px; border: 1px solid #dee2e6;">ÿßŸÑŸÖÿØÿ©</th>
                            <th style="padding: 12px; border: 1px solid #dee2e6;">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</th>
                            <th style="padding: 12px; border: 1px solid #dee2e6;">ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                        </tr>
                    </thead>
                    <tbody id="vacationTableBody">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸáŸÜÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ¨ÿØŸàŸÑ -->
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="addVacationRecord()" style="background: #28a745; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¨ÿØŸäÿØÿ©
                </button>
                <button onclick="exportVacationTable()" style="background: #17a2b8; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    üìä ÿ™ÿµÿØŸäÿ± ÿ¨ÿØŸàŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
                </button>
                <button onclick="clearVacationData()" style="background: #dc3545; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                    üóëÔ∏è ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ŸÖŸàÿØÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ∞ŸÉŸä -->
<div id="shopsManagementModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width: 95%; width: 1200px;">
        <button class="close-btn" onclick="closeShopsManagementModal()">√ó</button>
        <div class="stats-title">üè™ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿÆÿßÿ∂ÿπÿ© ŸÑŸÑÿ±ŸÇÿßÿ®ÿ© ŸàÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥</div>
        
        <!-- ŸÖÿ§ÿ¥ÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± -->
        <div id="shopsEditingStatus" style="background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%); border: 2px solid #2196f3; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
                <div style="font-size: 1.5em;">‚ÑπÔ∏è</div>
                <h4 style="margin: 0; color: #1976d2; font-size: 1.1em;">ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖŸáŸÖÿ© ÿ≠ŸàŸÑ ÿ™ÿ≠ÿ±Ÿäÿ± ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</h4>
            </div>
            <div id="editingStatusContent" style="color: #1565c0; font-size: 0.95em; line-height: 1.5;">
                <div style="margin-bottom: 8px;"><strong>üîç Ÿàÿ∂ÿπ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑÿ≠ÿßŸÑŸä:</strong> ŸäŸÖŸÉŸÜŸÉ ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸàÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±</div>
                <div style="margin-bottom: 8px;"><strong>‚úèÔ∏è ŸÑŸÑÿ™ÿ≠ÿ±Ÿäÿ± ŸàÿßŸÑÿ≠ÿ∞ŸÅ ŸàÿßŸÑÿ•ÿ∂ÿßŸÅÿ©:</strong> Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÉŸÖÿ∑Ÿàÿ± ŸÖŸÜ ÿ£ÿπŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ©</div>
                <div style="background: #fff; padding: 8px; border-radius: 6px; border: 1px solid #bbdefb; margin-top: 10px;">
                    <span style="font-weight: 600;">ÿÆÿ∑Ÿàÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ©:</span>
                    ÿßÿÆÿ™ÿ± "ÿßŸÑŸÖÿ∑Ÿàÿ±" ŸÖŸÜ ŸÇÿßÿ¶ŸÖÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ‚Üí ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿßŸÑŸÖÿ∑Ÿàÿ± ‚Üí ÿßŸÜŸÇÿ± "ÿØÿÆŸàŸÑ"
                </div>
            </div>
        </div>
        
        <!-- ÿ•ÿ∂ÿßŸÅÿ© ÿ≥ÿ±Ÿäÿπÿ© ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™ -->
        <div id="quickAddShopSection" style="background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #4caf50; display: none;">
            <h4 style="margin: 0 0 12px 0; color: #2e7d32; font-size: 1.05em; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.3em;">‚ö°</span>
                <span>ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ ÿ®ÿ≥ÿ±ÿπÿ© (ÿ®ÿØŸàŸÜ ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜŸÅÿµŸÑÿ©)</span>
            </h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; color: #2e7d32;">
                        <span style="color: #d32f2f;">*</span> ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ:
                    </label>
                    <input type="text" id="quickAddShopName" placeholder="ŸÖÿ´ÿßŸÑ: ŸÖÿ≠ŸÑ ÿßŸÑÿ∑ŸäŸàÿ± ÿßŸÑÿ≥ÿπŸäÿØÿ©" 
                           style="width: 100%; padding: 8px 12px; border: 2px solid #81c784; border-radius: 6px; font-size: 0.95em; font-family: 'Cairo', Arial, sans-serif;"
                           onkeypress="if(event.key==='Enter'){quickAddShop()}">
                </div>
                <div style="flex: 1; min-width: 180px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; color: #2e7d32;">
                        <span style="color: #d32f2f;">*</span> ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:
                    </label>
                    <select id="quickAddShopArea" style="width: 100%; padding: 8px 12px; border: 2px solid #81c784; border-radius: 6px; font-size: 0.95em; font-family: 'Cairo', Arial, sans-serif;">
                        <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© --</option>
                    </select>
                </div>
                <button onclick="quickAddShop()" style="background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); color: #fff; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em; box-shadow: 0 3px 6px rgba(76,175,80,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÅŸàÿ±ÿßŸã
                </button>
            </div>
            <div style="margin-top: 10px; padding: 8px; background: #fff; border-radius: 6px; border-left: 4px solid #4caf50;">
                <small style="color: #555; font-size: 0.85em;">
                    üí° <strong>ŸÜÿµŸäÿ≠ÿ©:</strong> ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÑŸÑŸÇÿßÿ¶ŸÖÿ© ÿ®ÿØŸàŸÜ ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ£ÿÆÿ±Ÿâ. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿπÿØŸÖ ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿßÿ≥ŸÖ.
                </small>
            </div>
        </div>

        <!-- ÿ¥ÿ±Ÿäÿ∑ ÿ£ÿØŸàÿßÿ™ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ -->
        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #dee2e6;">
            <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; align-items: center;">
                
                <!-- ŸÇÿ≥ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ -->
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <h4 style="margin: 0; color: #234085; font-size: 0.9em;">ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h4>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="downloadShopsFromExternalSource()" style="background: #28a745; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                            üì• ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜ ÿßŸÑŸÖÿµÿØÿ± ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                        </button>
                        <button onclick="checkDeveloperAccess('shop-management', () => uploadShopsFile())" style="background: #17a2b8; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                            üìÅ ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
                        </button>
                    </div>
                </div>
                
                <!-- ŸÇÿ≥ŸÖ ŸÅŸÑÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© -->
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <h4 style="margin: 0; color: #234085; font-size: 0.9em;">ŸÅŸÑÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</h4>
                    <select id="shopsAreaFilter" onchange="applyShopsAreaFilter()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 0.85em; min-width: 150px;">
                        <option value="">-- ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ --</option>
                    </select>
                </div>
                
                <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ∞ŸÉŸä -->
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <h4 style="margin: 0; color: #234085; font-size: 0.9em;">ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ∞ŸÉŸä</h4>
                    <select id="shopsClassificationFilter" onchange="applyShopsClassification()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 0.85em;">
                        <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ --</option>
                        <option value="area">ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>
                        <option value="alphabetical">ÿ™ÿ±ÿ™Ÿäÿ® ÿ£ÿ®ÿ¨ÿØŸä</option>
                        <option value="activity">ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑŸÜÿ¥ÿßÿ∑</option>
                        <option value="inspection_frequency">ÿ≠ÿ≥ÿ® ŸÖÿπÿØŸÑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥</option>
                        <option value="last_inspection">ÿ≠ÿ≥ÿ® ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥</option>
                    </select>
                </div>
                
                <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑŸÅŸÑÿ™ÿ± -->
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <h4 style="margin: 0; color: #234085; font-size: 0.9em;">üîç ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</h4>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="shopsSearchInput" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≠ŸÑ..." onkeyup="filterShopsList()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 0.85em; width: 150px;">
                        <button onclick="clearShopsFilters()" style="background: #6c757d; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                            üóëÔ∏è ŸÖÿ≥ÿ≠
                        </button>
                    </div>
                </div>
                
                <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿ™ÿµÿØŸäÿ± -->
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <h4 style="margin: 0; color: #234085; font-size: 0.9em;">ÿßŸÑÿ™ÿµÿØŸäÿ±</h4>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="exportShopsToExcel()" style="background: #198754; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                            üìä Excel
                        </button>
                        <button onclick="exportShopsToPDF()" style="background: #dc3545; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                            üìÑ PDF
                        </button>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ© -->
        <div id="shopsStatsContainer" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 20px;">
            <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
        </div>
        
        <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ -->
        <div style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; background: #fff;">
            <table style="width: 100%; border-collapse: collapse; font-family: 'Cairo', Arial, sans-serif;">
                <thead style="background: linear-gradient(135deg, #234085 0%, #2d4d99 100%); color: white; position: sticky; top: 0; z-index: 10;">
                    <tr>
                        <th style="padding: 12px 8px; text-align: center; border-right: 1px solid rgba(255,255,255,0.2);">#</th>
                        <th style="padding: 12px 8px; text-align: center; border-right: 1px solid rgba(255,255,255,0.2);">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ</th>
                        <th style="padding: 12px 8px; text-align: center; border-right: 1px solid rgba(255,255,255,0.2);">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                        <th style="padding: 12px 8px; text-align: center; border-right: 1px solid rgba(255,255,255,0.2);">ŸÜŸàÿπ ÿßŸÑŸÜÿ¥ÿßÿ∑</th>
                        <th style="padding: 12px 8px; text-align: center; border-right: 1px solid rgba(255,255,255,0.2);">ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥</th>
                        <th style="padding: 12px 8px; text-align: center; border-right: 1px solid rgba(255,255,255,0.2);">ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</th>
                        <th style="padding: 12px 8px; text-align: center;">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                    </tr>
                </thead>
                <tbody id="shopsTableBody">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸáŸÜÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ -->
        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
            <button onclick="checkDeveloperAccess('shop-management', addNewShop)" style="background: #28a745; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ
            </button>
            <button onclick="checkDeveloperAccess('shop-management', bulkEditShops)" style="background: #ffc107; color: #000; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                ‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ŸÖÿ¨ŸÖÿπ
            </button>
            <button onclick="checkDeveloperAccess('shop-management', saveShopsToGitHub)" style="background: #007bff; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
            </button>
            <button onclick="checkDeveloperAccess('shop-management', refreshShopsData)" style="background: #6f42c1; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            </button>
        </div>
        
        <!-- ÿ±ÿ≥ÿßŸÑÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ -->
        <div id="shopsUpdateStatus" style="display: none; margin-top: 15px; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; color: #155724; text-align: center;">
            ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™...
        </div>
        
    </div>
</div>

<!-- ŸÖŸàÿØÿßŸÑ ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ŸÖÿ≠ŸÑ -->
<div id="editShopModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width: 550px; border-radius: 12px;">
        <button class="close-btn" onclick="closeEditShopModal()">√ó</button>
        <div class="stats-title" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 12px 12px 0 0;">
            <span style="font-size: 1.5em;">üè™</span> ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ŸÖÿ≠ŸÑ
        </div>
        
        <form id="editShopForm" style="padding: 20px;">
            <!-- Info box -->
            <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; margin-bottom: 20px; border-radius: 4px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.3em;">üí°</span>
                    <span style="color: #1565c0; font-weight: 500; font-size: 0.95em;">
                        ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸàŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸá ŸÅŸàÿ±ÿßŸã ŸÅŸä ÿßŸÑÿÆÿ∑ÿ∑
                    </span>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #234085; font-size: 1.05em;">
                    <span style="color: #dc3545;">*</span> ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ:
                </label>
                <input type="text" id="editShopName" required placeholder="ŸÖÿ´ÿßŸÑ: ŸÖÿ≠ŸÑ ÿßŸÑÿ∑ŸäŸàÿ± ÿßŸÑÿ≥ÿπŸäÿØÿ©" style="width: 100%; padding: 10px 14px; border-radius: 6px; border: 2px solid #dee2e6; font-size: 1em; transition: border-color 0.3s;" onfocus="this.style.borderColor='#007bff'" onblur="this.style.borderColor='#dee2e6'">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #234085; font-size: 1.05em;">
                    <span style="color: #dc3545;">*</span> ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ™ÿßÿ®ÿπ ŸÑŸáÿß:
                </label>
                <div style="position: relative;">
                    <select id="editShopArea" required style="width: 100%; padding: 10px 14px; border-radius: 6px; border: 2px solid #dee2e6; font-size: 1em; background: #fff; appearance: none; cursor: pointer; transition: border-color 0.3s;" onfocus="this.style.borderColor='#007bff'" onblur="this.style.borderColor='#dee2e6'">
                        <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© --</option>
                    </select>
                    <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; font-size: 0.8em;">‚ñº</span>
                </div>
                <small style="display: block; margin-top: 5px; color: #6c757d; font-size: 0.9em;">
                    üìç Ÿäÿ±ÿ®ÿ∑ ÿßŸÑŸÖÿ≠ŸÑ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ© ŸÑÿ™ÿ≥ŸáŸäŸÑ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ
                </small>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #234085; font-size: 1.05em;">
                    ŸÜŸàÿπ ÿßŸÑŸÜÿ¥ÿßÿ∑ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä):
                </label>
                <div style="position: relative;">
                    <select id="editShopActivity" style="width: 100%; padding: 10px 14px; border-radius: 6px; border: 2px solid #dee2e6; font-size: 1em; background: #fff; appearance: none; cursor: pointer; transition: border-color 0.3s;" onfocus="this.style.borderColor='#007bff'" onblur="this.style.borderColor='#dee2e6'">
                        <option value="">-- ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑŸÜÿ¥ÿßÿ∑ --</option>
                        <option value="pet_shop">üêæ ŸÖÿ≠ŸÑ ÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿ£ŸÑŸäŸÅÿ©</option>
                        <option value="veterinary_clinic">üè• ÿπŸäÿßÿØÿ© ÿ®Ÿäÿ∑ÿ±Ÿäÿ©</option>
                        <option value="pet_grooming">‚úÇÔ∏è ÿµÿßŸÑŸàŸÜ ÿ≠ŸäŸàÿßŸÜÿßÿ™</option>
                        <option value="aquarium">üê† ŸÖÿ≠ŸÑ ÿ£ÿ≥ŸÖÿßŸÉ</option>
                        <option value="bird_shop">ü¶ú ŸÖÿ≠ŸÑ ÿ∑ŸäŸàÿ±</option>
                        <option value="pet_supplies">üì¶ ŸÖÿ≥ÿ™ŸÑÿ≤ŸÖÿßÿ™ ÿ≠ŸäŸàÿßŸÜÿßÿ™</option>
                        <option value="other">üìã ÿ£ÿÆÿ±Ÿâ</option>
                    </select>
                    <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; font-size: 0.8em;">‚ñº</span>
                </div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #234085; font-size: 1.05em;">
                    ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä):
                </label>
                <textarea id="editShopNotes" rows="3" placeholder="ÿ£Ÿä ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ÿπŸÜ ÿßŸÑŸÖÿ≠ŸÑ..." style="width: 100%; padding: 10px 14px; border-radius: 6px; border: 2px solid #dee2e6; resize: vertical; font-size: 0.95em; font-family: 'Cairo', Arial, sans-serif; transition: border-color 0.3s;" onfocus="this.style.borderColor='#007bff'" onblur="this.style.borderColor='#dee2e6'"></textarea>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: center; padding-top: 10px; border-top: 2px solid #e9ecef;">
                <button type="submit" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: #fff; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1.05em; box-shadow: 0 2px 5px rgba(40,167,69,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    üíæ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≠ŸÑ
                </button>
                <button type="button" onclick="closeEditShopModal()" style="background: #6c757d; color: #fff; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1.05em; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ‚ùå ÿ•ŸÑÿ∫ÿßÿ°
                </button>
            </div>
        </form>
        
        <input type="hidden" id="editShopIndex" value="">
    </div>
</div>

<!-- ŸÖŸàÿØÿßŸÑ ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ -->
<div id="filePreviewModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width: 95%; width: 1200px; max-height: 90vh;">
        <button class="close-btn" onclick="closeFilePreviewModal()">√ó</button>
        <div class="stats-title">üëÅÔ∏è ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ - PDF Ÿà Excel</div>
        
        <!-- ŸÖŸÜÿ∑ŸÇÿ© ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ -->
        <div style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6; text-align: center;">
            <div style="margin-bottom: 15px;">
                <span style="font-size: 3em; color: #6c757d;">üìÅ</span>
            </div>
            <input type="file" id="previewFileInput" accept=".pdf,.xlsx,.xls,.csv" style="display: none;" onchange="handlePreviewFileUpload(event)">
            <button onclick="document.getElementById('previewFileInput').click()" style="background: linear-gradient(135deg, #6f42c1 0%, #8a2be2 100%); color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em; margin-bottom: 10px;">
                üìé ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ ŸÑŸÑŸÖÿπÿßŸäŸÜÿ©
            </button>
            <div style="color: #6c757d; font-size: 0.9em;">
                <p>ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿØÿπŸàŸÖÿ©: PDF, Excel (.xlsx, .xls), CSV</p>
                <p>ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ: 10 MB</p>
            </div>
        </div>
        
        <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ≠ŸÖŸÑ -->
        <div id="previewFileInfo" style="margin-bottom: 15px; padding: 10px; background: #e8f4f8; border-radius: 6px; display: none;">
            <h4 style="margin: 0 0 5px 0; color: #0c5460;">üìÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÑŸÅ:</h4>
            <div id="previewFileDetails"></div>
        </div>
        
        <!-- ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿπÿßŸäŸÜÿ© -->
        <div id="previewContent" style="border: 1px solid #dee2e6; border-radius: 8px; background: #fff; min-height: 400px; max-height: 500px; overflow: auto;">
            <div style="display: flex; align-items: center; justify-content: center; height: 400px; color: #6c757d; flex-direction: column;">
                <span style="font-size: 4em; margin-bottom: 20px;">üìã</span>
                <p style="font-size: 1.2em; margin: 0;">ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ ŸÑÿ®ÿØÿ° ÿßŸÑŸÖÿπÿßŸäŸÜÿ©</p>
                <p style="font-size: 0.9em; margin-top: 10px; color: #adb5bd;">ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÖŸÑŸÅ ŸáŸÜÿß</p>
            </div>
        </div>
        
        <!-- ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÉŸÖ -->
        <div id="previewControls" style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; display: none;">
            <button id="prevPageBtn" onclick="changePage(-1)" style="background: #007bff; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                ‚Üê ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
            </button>
            <span id="pageInfo" style="display: flex; align-items: center; padding: 8px 16px; background: #e9ecef; border-radius: 6px; color: #495057; font-weight: bold;">
                ÿµŸÅÿ≠ÿ© 1 ŸÖŸÜ 1
            </span>
            <button id="nextPageBtn" onclick="changePage(1)" style="background: #007bff; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ© ‚Üí
            </button>
        </div>
        
        <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿ•ÿ∂ÿßŸÅŸäÿ© -->
        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
            <button id="downloadPreviewBtn" onclick="downloadCurrentFile()" style="background: #28a745; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; display: none;">
                üì• ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ
            </button>
            <button onclick="printPreviewContent()" style="background: #17a2b8; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                üñ®Ô∏è ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
            </button>
            <button onclick="clearPreview()" style="background: #6c757d; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                üóëÔ∏è ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿπÿßŸäŸÜÿ©
            </button>
        </div>
    </div>
</div>

<!-- ŸÇÿ≥ŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÑŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ - ŸÖÿÆŸÅŸä ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäÿßŸã -->
<div id="fileManagementSection" style="max-width: 1000px; margin: 30px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: none;">
    <div style="text-align: center; margin-bottom: 25px;">
        <h2 style="color: #2336a0; margin-bottom: 10px;">üìÇ ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸàÿßŸÑŸàÿ´ÿßÿ¶ŸÇ</h2>
        <p style="color: #666; margin: 0;">ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸàÿßŸÑŸàÿ´ÿßÿ¶ŸÇ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑÿßÿ∑ŸÑÿßÿπ ŸàÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ</p>
    </div>
    
    <!-- ŸÇÿ≥ŸÖ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ - ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑ -->
    <div id="developerFileUploadSection" style="display: none; margin-bottom: 25px; padding: 20px; background: #f0f8ff; border: 2px solid #2336a0; border-radius: 8px;">
        <h3 style="color: #2336a0; margin: 0 0 15px 0;">‚ûï ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿ¨ÿØŸäÿØ</h3>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÑŸÅ:</label>
            <input type="file" id="mainFileUpload" accept=".pdf,.xlsx,.xls,.docx,.doc,.pptx,.ppt,.csv,.txt,.jpg,.jpeg,.png,.gif" style="padding: 8px; border: 1px solid #ccc; border-radius: 6px; width: 100%; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ÿßŸÑÿ™ÿµŸÜŸäŸÅ:</label>
            <select id="mainFileCategory" style="padding: 8px; border: 1px solid #ccc; border-radius: 6px; width: 100%; box-sizing: border-box;">
                <option value="documents">ÿßŸÑŸàÿ´ÿßÿ¶ŸÇ - Documents</option>
                <option value="reports">ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± - Reports</option>
                <option value="schedules">ÿßŸÑÿ¨ÿØÿßŸàŸÑ - Schedules</option>
                <option value="resources">ÿßŸÑŸÖŸàÿßÿ±ÿØ - Resources</option>
            </select>
        </div>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ŸàÿµŸÅ ÿßŸÑŸÖŸÑŸÅ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä):</label>
            <input type="text" id="mainFileDescription" placeholder="ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ± ŸÑŸÑŸÖŸÑŸÅ" style="padding: 8px; border: 1px solid #ccc; border-radius: 6px; width: 100%; box-sizing: border-box;">
        </div>
        <button onclick="uploadFileFromMain()" id="mainUploadBtn" style="background: #28a745; color: #fff; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: bold;">
            üì§ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ
        </button>
        <div id="mainFileUploadStatus" style="margin-top: 10px; font-weight: bold;"></div>
    </div>
    
    <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
        <button onclick="loadPublicFiles('all')" id="filesAllBtn" style="background: #2336a0; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
            üìÅ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™
        </button>
        <button onclick="loadPublicFiles('documents')" style="background: #17a2b8; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
            üìÑ ÿßŸÑŸàÿ´ÿßÿ¶ŸÇ
        </button>
        <button onclick="loadPublicFiles('reports')" style="background: #28a745; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
            üìä ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±
        </button>
        <button onclick="loadPublicFiles('schedules')" style="background: #ffc107; color: #333; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
            üìÖ ÿßŸÑÿ¨ÿØÿßŸàŸÑ
        </button>
        <button onclick="loadPublicFiles('resources')" style="background: #6f42c1; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
            üìö ÿßŸÑŸÖŸàÿßÿ±ÿØ
        </button>
    </div>
    
    <div id="publicFilesList" style="min-height: 200px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
        <div style="text-align: center; color: #666; padding: 40px 0;">
            <div style="font-size: 3em; margin-bottom: 15px;">üìÅ</div>
            <p style="font-size: 1.1em; margin: 0;">ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿ£ÿ≠ÿØ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿ£ÿπŸÑÿßŸá ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™</p>
        </div>
    </div>
    
    <div id="filesLoadingStatus" style="margin-top: 15px; text-align: center; color: #666;"></div>
</div>

<script>
// ===== Ÿàÿ∏ÿßÿ¶ŸÅ ÿ•ÿØÿßÿ±ÿ© ÿÆÿØŸÖÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¨ÿØŸäÿØÿ© =====

// Restore developer login state from localStorage if exists (moved here to prevent reference errors)
let isDev = localStorage.getItem('isDevLoggedIn') === 'true';

// ÿ™ÿ®ÿØŸäŸÑ ÿπÿ±ÿ∂/ÿ•ÿÆŸÅÿßÿ° ŸÇÿ≥ŸÖ ÿÆÿØŸÖÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ
function toggleSystemServices() {
    const content = document.getElementById('systemServicesContent');
    const icon = document.getElementById('systemServicesIcon');
    const header = document.querySelector('.system-services-header');
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        header.classList.add('collapsed');
        icon.style.transform = 'rotate(0deg)';
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ
        content.style.maxHeight = '0';
        content.style.padding = '0 20px';
    } else {
        content.classList.add('expanded');
        header.classList.remove('collapsed');
        icon.style.transform = 'rotate(180deg)';
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿ™ÿ≠
        content.style.maxHeight = '800px';
        content.style.padding = '20px';
    }
}

// ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿÆÿØŸÖÿ© ŸÖŸÜŸÅÿµŸÑÿ© ÿØÿßÿÆŸÑ ŸÇÿ≥ŸÖ ÿÆÿØŸÖÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ
function showServicePage(pageId, modalFunctionName) {
    // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÅÿ≠ÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâ
    const allPages = document.querySelectorAll('.service-page');
    allPages.forEach(page => page.classList.remove('active'));
    
    // ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
    const page = document.getElementById(pageId);
    if (page) {
        page.classList.add('active');
        
        // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿ®ÿπÿØÿå ŸÜÿ≥ÿ™ÿØÿπŸä ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ© ŸÑÿ™ÿ≠ŸÖŸäŸÑŸá
        const contentDiv = page.querySelector('[id$="PageContent"]');
        if (contentDiv && contentDiv.children.length === 0) {
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÖŸÜ ÿßŸÑŸÖŸàÿØÿßŸÑ ÿßŸÑÿ£ÿµŸÑŸä
            loadModalContentToPage(pageId, modalFunctionName);
        }
        
        // ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿ•ŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ©
        page.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// ÿ•ÿ∫ŸÑÿßŸÇ ÿµŸÅÿ≠ÿ© ÿßŸÑÿÆÿØŸÖÿ©
function closeServicePage(pageId) {
    const page = document.getElementById(pageId);
    if (page) {
        page.classList.remove('active');
    }
}

// ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÖŸàÿØÿßŸÑ ÿ•ŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑŸÖŸÜŸÅÿµŸÑÿ©
function loadModalContentToPage(pageId, modalFunctionName) {
    let modalId = '';
    let contentId = '';
    
    // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàÿØÿßŸÑ ÿßŸÑŸÖŸÜÿßÿ≥ÿ® ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ©
    if (pageId === 'smartDistributionPage') {
        modalId = 'smartRotationModal';
        contentId = 'smartDistributionPageContent';
    } else if (pageId === 'vacationTrackingPage') {
        modalId = 'vacationTrackerModal';
        contentId = 'vacationTrackingPageContent';
    } else if (pageId === 'shopsManagementPage') {
        modalId = 'shopsManagementModal';
        contentId = 'shopsManagementPageContent';
    }
    
    if (modalId && contentId) {
        const modal = document.getElementById(modalId);
        const pageContent = document.getElementById(contentId);
        
        if (modal && pageContent) {
            // ŸÜÿ≥ÿÆ ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÖŸàÿØÿßŸÑ (ŸÖÿß ÿπÿØÿß ÿßŸÑÿ≤ÿ± X ŸàÿßŸÑÿÆŸÑŸÅŸäÿ©)
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                // ŸÜÿ≥ÿÆ ŸÉŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÖÿß ÿπÿØÿß ÿ≤ÿ± ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ ŸàÿßŸÑÿπŸÜŸàÿßŸÜ
                const clonedContent = modalContent.cloneNode(true);
                
                // ÿ•ÿ≤ÿßŸÑÿ© ÿ≤ÿ± ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÇÿØŸäŸÖ
                const closeBtn = clonedContent.querySelector('.close-btn');
                if (closeBtn) {
                    closeBtn.remove();
                }
                
                // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑŸÇÿØŸäŸÖ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
                const oldTitle = clonedContent.querySelector('.stats-title');
                if (oldTitle) {
                    oldTitle.remove();
                }
                
                // ŸÜÿ≥ÿÆ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿ•ŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ©
                pageContent.innerHTML = clonedContent.innerHTML;
                
                // ÿßÿ≥ÿ™ÿØÿπÿßÿ° populateInspectorSelection ÿ®ÿπÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ Ÿáÿ∞Ÿá ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ∞ŸÉŸä
                if (pageId === 'smartDistributionPage') {
                    setTimeout(() => {
                        if (typeof window.populateInspectorSelection === 'function') {
                            window.populateInspectorSelection();
                        }
                        // ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
                        const rotationStartDate = document.getElementById('rotationStartDate');
                        if (rotationStartDate) {
                            const today = new Date();
                            rotationStartDate.value = today.toISOString().split('T')[0];
                        }
                    }, 100);
                }
            }
        }
    }
}

// ÿ™ÿ®ÿØŸäŸÑ ÿπÿ±ÿ∂/ÿ•ÿÆŸÅÿßÿ° ŸÇÿ≥ŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™
function toggleFileManagement() {
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ±
    if (!isDev && !window.isDev) {
        alert('‚ùå Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑');
        return;
    }
    
    const fileSection = document.getElementById('fileManagementSection');
    
    if (fileSection.style.display === 'none' || fileSection.style.display === '') {
        fileSection.style.display = 'block';
        fileSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // ÿ•ÿ∏Ÿáÿßÿ± ŸÇÿ≥ŸÖ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑
        const uploadSection = document.getElementById('developerFileUploadSection');
        if (uploadSection && (isDev || window.isDev)) {
            uploadSection.style.display = 'block';
        }
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖÿ≠ŸÖŸÑÿ©
        setTimeout(() => {
            const filesList = document.getElementById('publicFilesList');
            if (filesList && filesList.innerHTML.includes('ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿ£ÿ≠ÿØ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±')) {
                loadPublicFiles('all');
            }
        }, 500);
    } else {
        fileSection.style.display = 'none';
    }
}

// ÿ•ÿ∂ÿßŸÅÿ© ÿ£ÿµŸàÿßÿ™ ÿßŸÑŸÜŸÇÿ± ŸÑŸÑÿ™ÿ£ÿ´Ÿäÿ±
function playClickSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.15, audioContext.currentTime + 0.005);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.05);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.05);
    } catch (error) {
        // ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ÿßÿ™ ÿßŸÑÿ™Ÿä ŸÑÿß ÿ™ÿØÿπŸÖ Web Audio API
        console.log('Click sound not supported');
    }
}

// Note: isDev is already declared earlier in the file (line 4050)
// Restore developer login state and other variables - selectedInspector and DEV_PASSWORD
let selectedInspector = "";
const DEV_PASSWORD = "ali@1940";

// ========================================
// Smart Cache Management for Safari/Firefox
// ========================================
// This ensures browsers like Safari and Firefox always get fresh data
async function smartCacheClear() {
    try {
        const APP_VERSION = '1.1.0'; // Increment this when you want to force cache clear
        const lastVersion = localStorage.getItem('appVersion');
        
        // Check if this is a new version or first load
        if (lastVersion !== APP_VERSION) {
            console.log('üîÑ New app version detected. Clearing caches...');
            
            // 1. Clear Service Worker caches (if any)
            if ('serviceWorker' in navigator && 'caches' in window) {
                const cacheNames = await caches.keys();
                await Promise.all(
                    cacheNames.map(cacheName => caches.delete(cacheName))
                );
                console.log('‚úÖ Service Worker caches cleared');
            }
            
            // 2. Unregister old service workers
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                await Promise.all(
                    registrations.map(registration => registration.unregister())
                );
                console.log('‚úÖ Old service workers unregistered');
            }
            
            // 3. Store new version
            localStorage.setItem('appVersion', APP_VERSION);
            console.log(`‚úÖ App version updated to ${APP_VERSION}`);
            
            // 4. Force reload to apply changes (only once)
            if (!sessionStorage.getItem('versionReloadDone')) {
                sessionStorage.setItem('versionReloadDone', 'true');
                console.log('üîÑ Reloading to apply fresh cache...');
                window.location.reload(true); // Force reload from server
                return;
            }
        }
        
        // Clear the reload flag after successful load
        sessionStorage.removeItem('versionReloadDone');
        
    } catch (error) {
        console.error('‚ùå Smart cache clear failed:', error);
    }
}

// Run smart cache management immediately
smartCacheClear();

// ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπÿßÿ™ ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ŸÑÿ£ÿµŸàÿßÿ™ ÿßŸÑŸÜŸÇÿ±
document.addEventListener('DOMContentLoaded', function() {
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ£ÿµŸàÿßÿ™ ÿßŸÑŸÜŸÇÿ± ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
    document.querySelectorAll('button, .system-services-header').forEach(button => {
        button.addEventListener('click', playClickSound);
    });
    
    // Initialize audio elements for better cross-browser compatibility
    initializeAudioElements();
    
    // Clear the maintenance notification flag on page load
    // This ensures the "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´" message appears on every page reload
    // when maintenance is active, not just the first time
    sessionStorage.removeItem('maintenanceNotificationShown');
    console.log('üîÑ Cleared maintenance notification flag for fresh page load');
    
    // Restore developer UI state if logged in
    if (isDev) {
        console.log('‚úÖ Developer session restored from localStorage');
        // Show developer UI elements
        document.getElementById("devSection").style.display = "block";
        document.getElementById("devLogoutBtn").style.display = "inline-block";
        document.getElementById("systemServicesContainer").style.display = "block";
        
        // Show all categories including developer-only categories
        const developerCategories = document.querySelectorAll('.developer-only-category');
        console.log(`üìä PR#317: Restoring ${developerCategories.length} developer-only categories on page load`);
        developerCategories.forEach(cat => {
            cat.style.display = 'contents';
            console.log('üìä PR#317: Restored category:', cat.id);
        });
        
        // Update maintenance close button visibility
        updateMaintenanceCloseButton();
    }
    
    // Start periodic maintenance mode checker
    if (typeof startMaintenanceStatusChecker === 'function') {
        startMaintenanceStatusChecker();
    }
});

// Initialize audio elements with proper error handling and Safari compatibility
function initializeAudioElements() {
    const audioElements = [
        document.getElementById('maintenanceAudio'),
        document.getElementById('splashAudio'),
        document.getElementById('sheikhZayedAudio')
    ];
    
    audioElements.forEach(audio => {
        if (!audio) return;
        
        // Add error handling
        audio.addEventListener('error', function(e) {
            console.error('üéµ Audio error for', audio.id, ':', e);
            // Try to reload the audio
            if (audio.readyState === 0) {
                audio.load();
            }
        });
        
        // Handle stalling (common in Safari)
        audio.addEventListener('stalled', function() {
            console.warn('üéµ Audio stalled for', audio.id, '- attempting to resume');
            audio.load();
        });
        
        // Handle waiting/buffering
        audio.addEventListener('waiting', function() {
            console.log('üéµ Audio buffering for', audio.id);
        });
        
        // Handle when audio can play through
        audio.addEventListener('canplaythrough', function() {
            console.log('üéµ Audio ready for', audio.id);
        });
        
        // Safari-specific: Prevent interruptions
        audio.addEventListener('pause', function() {
            // If audio paused unexpectedly (not by user), try to resume
            if (audio.id === 'maintenanceAudio' && maintenanceConfig.musicEnabled) {
                const overlay = document.getElementById('maintenanceOverlay');
                if (overlay && overlay.style.display === 'flex') {
                    // Maintenance is active but audio paused - try to resume after short delay
                    setTimeout(() => {
                        if (audio.paused && overlay.style.display === 'flex') {
                            audio.play().catch(err => {
                                console.log('üéµ Could not resume audio:', err);
                            });
                        }
                    }, 500);
                }
            }
        });
        
        // Safari-specific: Handle ended event for loop
        audio.addEventListener('ended', function() {
            if (audio.id === 'splashAudio' || (audio.id === 'maintenanceAudio' && maintenanceConfig.musicDuration === 0)) {
                // Should loop, restart it
                audio.currentTime = 0;
                audio.play().catch(err => {
                    console.log('üéµ Could not loop audio:', err);
                });
            }
        });
        
        // Preload audio for faster playback
        if (audio.readyState < 2) {
            audio.load();
        }
    });
    
    console.log('‚úÖ Audio elements initialized with cross-browser compatibility');
}

</script>

<script>
// ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÖŸÜ ŸÖŸÑŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
let inspectorsData = [
    {id:"insp_1758813880098", name:"ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ"},
    {id:"insp_1758830925093", name:"ÿØ. ŸÖÿ≠ŸÖÿØ ÿ•ÿ≥ŸÖÿßÿπŸäŸÑ"},
    {id:"insp_1758830939296", name:"ÿØ. ŸÖÿ≠ŸÖÿØ ÿ≥ÿπŸäÿØ"},
    {id:"insp_1758830950586", name:"ÿØ. ŸÅÿßŸäÿ≤ ÿßŸÑŸÖÿ≥ÿßŸÑŸÖÿ©"},
    {id:"insp_1758830963007", name:"ÿØ. ÿ¢ŸäŸá ÿ≥ŸÑÿßŸÖÿ©"},
    {id:"insp_1758830974747", name:"ÿØ. ÿ¢ŸÖŸÜŸá ÿ®ŸÜ ÿµÿ±ŸÖ"},
    {id:"insp_1758830985608", name:"ÿØ. ÿ≠ÿµÿ© ÿßŸÑÿπŸÑŸä"},
    {id:"insp_1758830999876", name:"ÿØ. ÿ≠ÿ≥ŸäŸÜÿ© ÿßŸÑÿπÿßŸÖÿ±Ÿä"},
    {id:"insp_1758831014928", name:"ÿØ. Ÿáÿßÿ¨ÿ± ÿßŸÑÿ∫ÿßŸÅÿ±Ÿä"}
];
let inspectors = inspectorsData.map(i=>i.name);

// ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ŸàÿßŸÑŸÖÿ≠ŸÑÿßÿ™
let areasData = [
    {id:"musaffah", name:"ÿßŸÑŸÖÿµŸÅÿ≠"},
    {id:"khalifa", name:"ŸÖÿØŸäŸÜÿ© ÿÆŸÑŸäŸÅÿ©"},
    {id:"area_a", name:"ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ£"},
    {id:"area_c", name:"ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ¨"}
];

let shopsData = [
    {id:"shop1", name:"ŸÖÿ≠ŸÑ ÿ®Ÿäÿ™ ÿßŸÑÿ∑ŸäŸàÿ±", nameEn:"Pet Birds Shop", areaId:"musaffah", licenseNumber:"LIC-001", googleMapsUrl:"https://maps.google.com/?q=24.3771,54.5074"},
    {id:"shop2", name:"ŸÖÿ≠ŸÑ ÿßŸÑŸÖŸäŸÜÿßÿ° ŸÑŸÑÿ∑ŸäŸàÿ±", nameEn:"Port Birds Shop", areaId:"musaffah", licenseNumber:"LIC-002", googleMapsUrl:"https://maps.google.com/?q=24.3772,54.5075"},
    {id:"shop3", name:"ŸÖÿ≠ŸÑ ÿßŸÑÿ≥ÿ≠ÿ± ŸÑŸÑÿ∑ŸäŸàÿ±", nameEn:"Magic Birds Shop", areaId:"khalifa", licenseNumber:"LIC-003", googleMapsUrl:"https://maps.google.com/?q=24.4213,54.6095"},
    {id:"shop4", name:"ÿßŸÑÿπŸäÿßÿØÿ© ÿßŸÑŸÉŸÜÿØŸäÿ©", nameEn:"Canadian Clinic", areaId:"khalifa", licenseNumber:"LIC-004", googleMapsUrl:"https://maps.google.com/?q=24.4214,54.6096"},
    {id:"shop5", name:"ŸÖÿ≠ŸÑ ÿ®Ÿäÿ™ÿ≥ ÿßÿ≥ÿ™Ÿäÿ¥ŸÜ", nameEn:"Pets Station Shop", areaId:"musaffah", licenseNumber:"LIC-005", googleMapsUrl:"https://maps.google.com/?q=24.3773,54.5076"},
    {id:"shop7", name:"ŸÖÿ≠ŸÑ 7", nameEn:"Shop 7", areaId:"musaffah", licenseNumber:"LIC-007", googleMapsUrl:"https://maps.google.com/?q=24.3774,54.5077"},
    {id:"shop8", name:"ŸÖÿ≠ŸÑ 8", nameEn:"Shop 8", areaId:"area_a", licenseNumber:"LIC-008", googleMapsUrl:"https://maps.google.com/?q=24.4574,54.3775"},
    {id:"shop9", name:"ŸÖÿ≠ŸÑ 9", nameEn:"Shop 9", areaId:"area_a", licenseNumber:"LIC-009", googleMapsUrl:"https://maps.google.com/?q=24.4575,54.3776"},
    {id:"shop11", name:"ŸÖÿ≠ŸÑ 11", nameEn:"Shop 11", areaId:"area_c", licenseNumber:"LIC-011", googleMapsUrl:"https://maps.google.com/?q=24.4893,54.3514"}
];

// Note: isDev, selectedInspector, and DEV_PASSWORD are now declared earlier before DOMContentLoaded

// Global plan data variable - properly initialize to prevent undefined errors
let allPlanData = {
    inspectionData: [],
    inspectors: [],
    areas: [],
    shops: [],
    bellNotes: { notifications: [] },
    lastUpdate: null
};

// =============================================================================
// Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿßŸÑŸàÿµŸàŸÑ (Access Control Functions)
// =============================================================================

/**
 * Ÿàÿ∏ŸäŸÅÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± Ÿàÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ŸÖŸÜÿπ ŸÑŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ
 * @param {string} featureName - ÿßÿ≥ŸÖ ÿßŸÑŸÖŸäÿ≤ÿ© ÿßŸÑŸÖÿ±ÿßÿØ ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸäŸáÿß
 * @param {function} allowedAction - ÿßŸÑŸàÿ∏ŸäŸÅÿ© ÿßŸÑŸÖÿ±ÿßÿØ ÿ™ŸÜŸÅŸäÿ∞Ÿáÿß ŸÑŸÑŸÖÿ∑Ÿàÿ±
 * @returns {boolean} - true ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ∑Ÿàÿ±ÿå false ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸÅÿ™ÿ¥
 */
// Removed duplicate checkDeveloperAccess - using the more comprehensive version later in the file
// ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
let defaultInspectionData = [
    { inspector: "Ÿáÿßÿ¨ÿ±", day: "2025-09-22", shift: "ÿµÿ®ÿßÿ≠Ÿäÿ©", area: "ÿßŸÑŸÖÿµŸÅÿ≠", shops: ["ŸÖÿ≠ŸÑ 1", "ŸÖÿ≠ŸÑ 2"] },
    { inspector: "Ÿáÿßÿ¨ÿ±", day: "2025-09-28", shift: "ŸÖÿ≥ÿßÿ¶Ÿäÿ©", area: "ÿßŸÑŸÖÿµŸÅÿ≠", shops: ["ŸÖÿ≠ŸÑ 5"] },
    { inspector: "ÿ¢ŸÖŸÜŸá", day: "2025-09-25", shift: "ŸÖÿ≥ÿßÿ¶Ÿäÿ©", area: "ŸÖÿØŸäŸÜÿ© ÿÆŸÑŸäŸÅÿ©", shops: ["ŸÖÿ≠ŸÑ 3", "ŸÖÿ≠ŸÑ 4"] },
    { inspector: "ÿ¢ŸäŸá", day: "2025-09-22", shift: "ÿµÿ®ÿßÿ≠Ÿäÿ©", area: "ÿßŸÑŸÖÿµŸÅÿ≠", shops: ["ŸÖÿ≠ŸÑ 7"] },
    { inspector: "ÿØ. ŸÅÿßŸäÿ≤ ÿßŸÑŸÖÿ≥ÿßŸÑŸÖÿ©", day: "2025-09-21", shift: "ÿµÿ®ÿßÿ≠Ÿäÿ©", area: "ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ£", shops: ["ŸÖÿ≠ŸÑ 8", "ŸÖÿ≠ŸÑ 9"] },
    { inspector: "ÿØ.ÿ¢ŸÖŸÜŸá ÿ®ŸÜ ÿµÿ±ŸÖ", day: "2025-09-21", shift: "ŸÖÿ≥ÿßÿ¶Ÿäÿ©", area: "ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ¨", shops: ["ŸÖÿ≠ŸÑ 11"] },
];
let inspectionData = defaultInspectionData.slice();
let bellNotesData = { 
    infoText: "ÿ™Ÿàÿ¨ŸäŸáÿßÿ™ Ÿàÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÑŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ - Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏Ÿáÿß ŸÖÿ±ŸÉÿ≤ŸäÿßŸã ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ", 
    notes: "", // Legacy single text area
    notifications: [] // New array for individual notifications
};

// News Ticker Functions
function updateNewsTicker() {
    const newsTickerContainer = document.getElementById('newsTicker');
    const newsTickerText = document.getElementById('newsTickerText');
    
    if (!bellNotesData.notifications || bellNotesData.notifications.length === 0) {
        newsTickerContainer.classList.remove('show');
        return;
    }
    
    // Combine all notification texts with separators
    const tickerContent = bellNotesData.notifications
        .map(notification => {
            const cleanText = notification.text.replace(/\n/g, ' ').trim();
            const author = notification.author || 'ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ';
            return `${cleanText} [${author}]`;
        })
        .join('<span class="news-ticker-separator">‚¶ø</span>');
    
    // Duplicate content for seamless continuous scrolling
    newsTickerText.innerHTML = tickerContent + '<span class="news-ticker-separator">‚¶ø</span>' + tickerContent;
    newsTickerContainer.classList.add('show');
}

function restartTickerAnimation() {
    const newsTickerText = document.getElementById('newsTickerText');
    if (newsTickerText) {
        // Reset animation by removing and re-adding the class
        newsTickerText.style.animation = 'none';
        newsTickerText.offsetHeight; // Trigger reflow
        newsTickerText.style.animation = null;
    }
}
let lastUpdateTime = null;

// =============================================================================
// ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≠ŸÖÿßŸäÿ© ŸàÿßŸÑÿ£ŸÖÿßŸÜ - Security and Protection System
// =============================================================================

// Expected data structure signature - Updated by developer only
const EXPECTED_DATA_SIGNATURE = {
    hasInspectionData: true,
    hasInspectors: true,
    hasAreas: true,
    hasShops: true,
    hasBellNotes: true,
    hasLastUpdate: true,
    minInspectors: 5,  // Minimum expected number of inspectors (current: 9)
    minAreas: 35,      // Minimum expected number of areas (current: 38)
    minShops: 140      // Minimum expected number of shops (current: 149)
};

// Security check: Validate data integrity
function validateDataIntegrity(data) {
    const issues = [];
    
    // Check required fields exist
    if (!data.inspectionData || !Array.isArray(data.inspectionData)) {
        issues.push('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ŸÖŸÅŸÇŸàÿØÿ© ÿ£Ÿà ÿ™ÿßŸÑŸÅÿ©');
    }
    
    if (!data.inspectors || !Array.isArray(data.inspectors)) {
        issues.push('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÖŸÅŸÇŸàÿØÿ© ÿ£Ÿà ÿ™ÿßŸÑŸÅÿ©');
    } else if (data.inspectors.length < EXPECTED_DATA_SIGNATURE.minInspectors) {
        issues.push(`ÿπÿØÿØ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ÿ£ŸÇŸÑ ŸÖŸÜ ÿßŸÑŸÖÿ™ŸàŸÇÿπ (${data.inspectors.length} ŸÖŸÜ ${EXPECTED_DATA_SIGNATURE.minInspectors})`);
    }
    
    if (!data.areas || !Array.isArray(data.areas)) {
        issues.push('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ŸÖŸÅŸÇŸàÿØÿ© ÿ£Ÿà ÿ™ÿßŸÑŸÅÿ©');
    } else if (data.areas.length < EXPECTED_DATA_SIGNATURE.minAreas) {
        issues.push(`ÿπÿØÿØ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿ£ŸÇŸÑ ŸÖŸÜ ÿßŸÑŸÖÿ™ŸàŸÇÿπ (${data.areas.length} ŸÖŸÜ ${EXPECTED_DATA_SIGNATURE.minAreas})`);
    }
    
    if (!data.shops || !Array.isArray(data.shops)) {
        issues.push('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÅŸÇŸàÿØÿ© ÿ£Ÿà ÿ™ÿßŸÑŸÅÿ©');
    } else if (data.shops.length < EXPECTED_DATA_SIGNATURE.minShops) {
        issues.push(`ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ£ŸÇŸÑ ŸÖŸÜ ÿßŸÑŸÖÿ™ŸàŸÇÿπ (${data.shops.length} ŸÖŸÜ ${EXPECTED_DATA_SIGNATURE.minShops})`);
    }
    
    if (!data.lastUpdate) {
        issues.push('ÿ™ÿßÿ±ŸäÿÆ ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÅŸÇŸàÿØ');
    }
    
    // Validate lastUpdate timestamp is reasonable (not in future, not too old)
    if (data.lastUpdate) {
        const updateDate = new Date(data.lastUpdate);
        const now = new Date();
        const oneYearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
        const oneMonthInFuture = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
        
        if (updateDate > oneMonthInFuture) {
            issues.push('ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑ - ŸÇÿØ ŸäŸÉŸàŸÜ ŸáŸÜÿßŸÉ ÿ™ŸÑÿßÿπÿ®');
        } else if (updateDate < oneYearAgo) {
            issues.push('ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÇÿØŸäŸÖ ÿ¨ÿØÿßŸã - ŸÇÿØ ÿ™ŸÉŸàŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿ´ÿ©');
        }
    }
    
    return {
        isValid: issues.length === 0,
        issues: issues
    };
}

// Display security warning message
function showSecurityWarning(issues) {
    // Create a persistent warning banner at the top of the page
    const existingWarning = document.getElementById('securityWarning');
    if (existingWarning) {
        existingWarning.remove();
    }
    
    const warningDiv = document.createElement('div');
    warningDiv.id = 'securityWarning';
    warningDiv.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        color: white;
        padding: 20px;
        text-align: center;
        z-index: 10000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        font-family: 'Cairo', Arial, sans-serif;
        font-size: 18px;
        font-weight: bold;
        border-bottom: 3px solid #7f1d1d;
    `;
    
    const title = document.createElement('div');
    title.style.cssText = `
        font-size: 24px;
        margin-bottom: 10px;
        color: #fef2f2;
    `;
    title.innerHTML = '‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ± ÿ£ŸÖŸÜŸä: ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠ ÿ®Ÿáÿß ‚ö†Ô∏è';
    
    const message = document.createElement('div');
    message.style.cssText = `
        font-size: 16px;
        margin-top: 10px;
        color: #fee2e2;
        line-height: 1.8;
    `;
    message.innerHTML = `
        <strong>Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑŸÖÿµÿØÿ± ÿßŸÑÿ±ÿ≥ŸÖŸä</strong><br>
        ÿßŸÑŸÖÿ¥ÿßŸÉŸÑ ÿßŸÑŸÖŸÉÿ™ÿ¥ŸÅÿ©:<br>
        ${issues.map(issue => `‚Ä¢ ${issue}`).join('<br>')}
        <br><br>
        <span style="font-size: 14px;">
        ŸÑŸÑŸÖÿ∑Ÿàÿ±ŸäŸÜ: ÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´ ÿ±ÿ≥ŸÖŸä ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™
        </span>
    `;
    
    warningDiv.appendChild(title);
    warningDiv.appendChild(message);
    
    // Insert at the beginning of body
    document.body.insertBefore(warningDiv, document.body.firstChild);
    
    // Also add padding to body to prevent content from being hidden
    document.body.style.paddingTop = '200px';
    
    // Log to console for debugging
    console.error('üî¥ SECURITY WARNING: Data integrity check failed');
    console.error('Issues detected:', issues);
}

// Auto-refresh functionality with automatic maintenance mode on data changes
function startAutoRefresh() {
    setInterval(async () => {
        try {
            const response = await fetch('./plan-data.json?t=' + Date.now());
            if (response.ok) {
                const data = await response.json();
                
                // SECURITY CHECK: Validate data integrity on auto-refresh
                const integrityCheck = validateDataIntegrity(data);
                if (!integrityCheck.isValid) {
                    // Automatically show maintenance mode with issues
                    console.log('üî¥ Data integrity issues detected - showing maintenance mode automatically');
                    showMaintenanceModeWithNotification(integrityCheck.issues);
                    showSecurityWarning(integrityCheck.issues);
                    return; // Don't proceed with invalid data
                }
                
                // Quick version check from localStorage for faster comparison
                const cachedVersion = localStorage.getItem('dataVersion');
                const newVersion = data.lastUpdate;
                
                // Check for data changes (new inspections, updates)
                if (newVersion && newVersion !== lastUpdateTime && newVersion !== cachedVersion) {
                    console.log('üìä Data change detected - showing maintenance mode for update');
                    console.log('   Previous version:', lastUpdateTime || cachedVersion);
                    console.log('   New version:', newVersion);
                    
                    // Detect what changed
                    const changeDetails = detectDataChanges(allPlanData, data);
                    
                    // Show maintenance mode with change details
                    if (changeDetails.length > 0) {
                        showMaintenanceModeWithNotification([
                            'ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ŸÅŸä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™',
                            ...changeDetails,
                            'ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©...'
                        ]);
                        
                        // Wait 2 seconds before loading new data (reduced from 3 for faster updates)
                        setTimeout(async () => {
                            await loadInspectionData();
                            // Only hide maintenance mode if not in system maintenance
                            const systemMaintenanceActive = localStorage.getItem('systemMaintenanceMode') === 'true';
                            if (!systemMaintenanceActive) {
                                hideMaintenanceMode();
                            }
                            showUpdateMessage('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã - ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ∏ÿßŸáÿ±ÿ© ÿßŸÑÿ¢ŸÜ');
                        }, 2000);
                    } else {
                        // No specific changes detected, just update normally
                        await loadInspectionData();
                        showUpdateMessage('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã');
                    }
                }
            }
        } catch (error) {
            console.log('Auto-refresh check failed:', error);
        }
    }, 10000); // Check every 10 seconds - reduced from 30 seconds for faster sync across devices
}

// Detect what changed in the data
function detectDataChanges(oldData, newData) {
    const changes = [];
    
    if (!oldData || !oldData.inspectionData) {
        return ['ÿ®ŸäÿßŸÜÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸÖÿ™ÿßÿ≠ÿ©'];
    }
    
    try {
        // Check for new inspections
        if (newData.inspectionData && oldData.inspectionData) {
            const newCount = newData.inspectionData.length;
            const oldCount = oldData.inspectionData.length;
            
            if (newCount > oldCount) {
                const diff = newCount - oldCount;
                changes.push(`ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ${diff} ÿ™ŸÅÿ™Ÿäÿ¥ ÿ¨ÿØŸäÿØ`);
            } else if (newCount < oldCount) {
                const diff = oldCount - newCount;
                changes.push(`ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${diff} ÿ™ŸÅÿ™Ÿäÿ¥`);
            }
        }
        
        // Check for new inspectors
        if (newData.inspectors && oldData.inspectors) {
            const newInspectors = newData.inspectors.length;
            const oldInspectors = oldData.inspectors.length;
            
            if (newInspectors > oldInspectors) {
                const diff = newInspectors - oldInspectors;
                changes.push(`ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ${diff} ŸÖŸÅÿ™ÿ¥ ÿ¨ÿØŸäÿØ`);
            }
        }
        
        // Check for new shops
        if (newData.shops && oldData.shops) {
            const newShops = newData.shops.length;
            const oldShops = oldData.shops.length;
            
            if (newShops > oldShops) {
                const diff = newShops - oldShops;
                changes.push(`ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ${diff} ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ`);
            }
        }
        
        // Check for new areas
        if (newData.areas && oldData.areas) {
            const newAreas = newData.areas.length;
            const oldAreas = oldData.areas.length;
            
            if (newAreas > oldAreas) {
                const diff = newAreas - oldAreas;
                changes.push(`ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ${diff} ŸÖŸÜÿ∑ŸÇÿ© ÿ¨ÿØŸäÿØÿ©`);
            }
        }
        
        // If no specific changes detected, just say data updated
        if (changes.length === 0) {
            changes.push('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
        }
    } catch (e) {
        console.error('Error detecting changes:', e);
        changes.push('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
    }
    
    return changes;
}

// Daily auto-refresh functionality at midnight
function startDailyRefresh() {
    let lastCheckedDay = new Date().getDate(); // Keep track of the current day
    
    // Check every 10 seconds for day change (including midnight transition)
    setInterval(() => {
        const now = new Date();
        const currentDay = now.getDate();
        
        // Check if the day has changed (this handles midnight transition)
        if (currentDay !== lastCheckedDay) {
            console.log('Day change detected - refreshing daily inspections');
            console.log('Previous day:', lastCheckedDay, 'Current day:', currentDay);
            
            lastCheckedDay = currentDay;
            
            // Clear any active search filters to show today's inspections
            if (Object.keys(currentSearchFilters).length > 0) {
                clearSearchFilters();
            } else {
                // Just refresh the table to show new day's inspections
                renderPlanTable();
            }
            
            const todayStr = now.toLocaleDateString('ar-EG');
            showUpdateMessage(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸäŸàŸÖŸäÿ© - ÿπÿ±ÿ∂ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ${todayStr}`);
        }
        
        // Also check specifically for midnight for immediate response
        if (now.getHours() === 0 && now.getMinutes() === 0 && now.getSeconds() < 10) {
            console.log('Midnight detected - ensuring daily inspections are current');
            
            // Clear any active search filters to show today's inspections
            if (Object.keys(currentSearchFilters).length > 0) {
                clearSearchFilters();
            } else {
                // Just refresh the table to show new day's inspections
                renderPlanTable();
            }
            
            const todayStr = now.toLocaleDateString('ar-EG');
            showUpdateMessage(`üåô ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑŸÑŸäŸÑ - ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÑŸÑŸäŸàŸÖ ÿßŸÑÿ¨ÿØŸäÿØ ${todayStr}`);
        }
    }, 10000); // Check every 10 seconds - reduced from 30 seconds for faster sync
}

// Data Validation and Security Functions
function validateInspectorNames(inspectors) {
    // List of valid inspector name patterns
    const validInspectorPatterns = [
        /^ÿØ\.\s*.+$/,  // Must start with "ÿØ."
        /ÿπŸÑŸä\s*ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ/,  // Known inspectors
        /ÿ¢ŸÖŸÜŸá\s*ÿ®ŸÜ\s*ÿµÿ±ŸÖ/,
        /ÿ¢ŸäŸá\s*ÿ≥ŸÑÿßŸÖÿ©/,
        /ÿ≠ÿ≥ŸäŸÜÿ©\s*ÿßŸÑÿπÿßŸÖÿ±Ÿä/,
        /ÿ≠ÿµÿ©\s*ÿßŸÑÿπŸÑŸä/,
        /ŸÅÿßŸäÿ≤\s*ÿßŸÑŸÖÿ≥ÿßŸÑŸÖÿ©/,
        /ŸÖÿ≠ŸÖÿØ\s*ÿ•ÿ≥ŸÖÿßÿπŸäŸÑ/,
        /ŸÖÿ≠ŸÖÿØ\s*ÿ≥ÿπŸäÿØ/,
        /Ÿáÿßÿ¨ÿ±\s*ÿßŸÑÿ∫ÿßŸÅÿ±Ÿä/,
        /ÿ≥ÿπÿßÿØ\s*ÿßŸÑÿ≥ÿßŸÖÿ±ÿßÿ¶Ÿä/,
        /ÿ∑ÿßÿ±ŸÇ\s*ÿ≠ŸÖÿ≤ÿ©/,
        /Ÿàÿßÿ¶ŸÑ\s*ÿπÿ®ÿØÿßŸÑÿ±ÿ≠ŸäŸÖ/
    ];
    
    const invalidInspectors = [];
    
    for (const inspector of inspectors) {
        const name = inspector.name || inspector;
        
        // Check if name is too short or too long
        if (name.length < 5 || name.length > 50) {
            invalidInspectors.push({ name, reason: 'ÿ∑ŸàŸÑ ÿßŸÑÿßÿ≥ŸÖ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠' });
            continue;
        }
        
        // Check if name doesn't start with ÿØ.
        if (!name.startsWith('ÿØ.')) {
            invalidInspectors.push({ name, reason: 'ŸÑÿß Ÿäÿ®ÿØÿ£ ÿ®ŸÄ ÿØ.' });
            continue;
        }
        
        // Check if name contains numbers or suspicious special characters (excluding period after ÿØ)
        // Remove "ÿØ." prefix before checking for special characters
        const nameWithoutPrefix = name.substring(2).trim();
        if (/[0-9!@#$%^&*()_+=\[\]{};':"\\|<>\/?~`]/.test(nameWithoutPrefix)) {
            invalidInspectors.push({ name, reason: 'Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ£ÿ≠ÿ±ŸÅ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©' });
            continue;
        }
        
        // Check against valid patterns
        let isValid = validInspectorPatterns.some(pattern => pattern.test(name));
        if (!isValid) {
            invalidInspectors.push({ name, reason: 'ÿßÿ≥ŸÖ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ' });
        }
    }
    
    return {
        isValid: invalidInspectors.length === 0,
        invalidInspectors: invalidInspectors
    };
}

function validateDataIntegrity(data) {
    const issues = [];
    
    // Check if essential data exists
    if (!data.inspectors || !Array.isArray(data.inspectors)) {
        issues.push('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÖŸÅŸÇŸàÿØÿ© ÿ£Ÿà ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
    }
    
    if (!data.areas || !Array.isArray(data.areas)) {
        issues.push('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ŸÖŸÅŸÇŸàÿØÿ© ÿ£Ÿà ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
    }
    
    if (!data.shops || !Array.isArray(data.shops)) {
        issues.push('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÅŸÇŸàÿØÿ© ÿ£Ÿà ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
    }
    
    if (!data.inspectionData || !Array.isArray(data.inspectionData)) {
        issues.push('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ŸÖŸÅŸÇŸàÿØÿ© ÿ£Ÿà ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
    }
    
    // Check for duplicate inspector IDs
    if (data.inspectors && Array.isArray(data.inspectors)) {
        const ids = data.inspectors.map(i => i.id);
        const duplicateIds = ids.filter((id, index) => ids.indexOf(id) !== index);
        if (duplicateIds.length > 0) {
            issues.push(`ÿ™Ÿàÿ¨ÿØ ŸÖÿπÿ±ŸÅÿßÿ™ ŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÖŸÉÿ±ÿ±ÿ©: ${duplicateIds.length} ÿ≠ÿßŸÑÿ©`);
        }
    }
    
    // Validate inspector names
    if (data.inspectors && Array.isArray(data.inspectors)) {
        const validation = validateInspectorNames(data.inspectors);
        if (!validation.isValid) {
            validation.invalidInspectors.forEach(invalid => {
                issues.push(`ŸÖŸÅÿ™ÿ¥ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠: "${invalid.name}" - ${invalid.reason}`);
            });
        }
    }
    
    return {
        isValid: issues.length === 0,
        issues: issues
    };
}

// Wrapper function that shows update notification before maintenance overlay
async function showMaintenanceModeWithNotification(issues = [], skipNotification = false) {
    // Don't show maintenance overlay for developers - they should always have access
    if (isDev || window.isDev) {
        console.log('‚ö†Ô∏è Maintenance mode active, but developer has access - overlay not shown');
        return;
    }
    
    // Show the full maintenance mode overlay directly with music
    // This shows "ÿßŸÑÿ≤ŸÖŸÑÿßÿ° ÿßŸÑÿ£ÿπÿ≤ÿßÿ°" (Dear Colleagues) message with music
    console.log('üì¢ Showing full maintenance screen with music for all users...');
    showMaintenanceMode(issues);
}

// Force re-check maintenance status and clear session cache
window.forceCheckMaintenance = function() {
    console.log('üîÑ Force checking maintenance status...');
    sessionStorage.removeItem('maintenanceNotificationShown');
    console.log('‚úÖ Cleared notification flag');
    checkMaintenanceMode();
};

function showMaintenanceMode(issues = []) {
    // Don't show maintenance overlay for developers - they should always have access
    if (isDev || window.isDev) {
        console.log('‚ö†Ô∏è Maintenance mode active, but developer has access - overlay not shown');
        return;
    }
    
    const overlay = document.getElementById('maintenanceOverlay');
    const mainContainer = document.querySelector('.main-container');
    const detailsDiv = document.getElementById('maintenanceDetails');
    
    if (!overlay) return;
    
    // Update close button visibility based on developer status
    updateMaintenanceCloseButton();
    
    // Build details message
    let detailsHTML = '<strong>ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´:</strong><br>';
    if (issues.length > 0) {
        detailsHTML += '<ul style="text-align: right; margin: 10px 0; padding-right: 20px;">';
        issues.forEach(issue => {
            detailsHTML += `<li>${issue}</li>`;
        });
        detailsHTML += '</ul>';
        detailsHTML += '<br><strong>ÿ¨ÿßÿ±Ÿä ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑŸÖÿ¥ÿßŸÉŸÑ Ÿàÿ™ÿ£ŸÖŸäŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</strong>';
    } else {
        detailsHTML += 'ÿ¨ÿßÿ±Ÿä ŸÅÿ≠ÿµ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≥ŸÑÿßŸÖÿ™Ÿáÿß...';
    }
    
    detailsDiv.innerHTML = detailsHTML;
    
    // Hide entire main container and show maintenance overlay to replace it completely
    if (mainContainer) {
        mainContainer.style.display = 'none';
    }
    overlay.style.display = 'flex';
    
    // Save maintenance mode state
    localStorage.setItem('systemMaintenanceMode', 'true');
    
    // Start playing maintenance music automatically
    startMaintenanceMusic();
    
    // Log for developer
    console.log('‚ö†Ô∏è Maintenance Mode Activated - Main container hidden, maintenance screen shown');
    console.log('Issues found:', issues);
}

function hideMaintenanceMode() {
    const overlay = document.getElementById('maintenanceOverlay');
    const mainContainer = document.querySelector('.main-container');
    
    if (overlay) {
        overlay.style.display = 'none';
    }
    
    // Show main container again
    if (mainContainer) {
        mainContainer.style.display = 'flex';
    }
    
    // Stop maintenance music
    stopMaintenanceMusic();
    
    // Clear maintenance mode state
    localStorage.removeItem('systemMaintenanceMode');
    
    console.log('‚úÖ Maintenance Mode Deactivated - Main container restored, maintenance screen hidden');
}

// Global variable to store playback timer
let maintenanceMusicTimer = null;

// Global variable to store maintenance configuration
let maintenanceConfig = {
    checkInterval: 10000,
    musicEnabled: true,
    musicDuration: 0,
    musicVolume: 0.15
};

// Global variable to store the maintenance checker interval
let maintenanceCheckerInterval = null;

// Load maintenance configuration from GitHub
async function loadMaintenanceConfig() {
    try {
        const response = await fetch('https://raw.githubusercontent.com/aliabdelaal-adm/Monthly_inspection_plan/main/maintenance-config.json?t=' + Date.now());
        if (response.ok) {
            const config = await response.json();
            maintenanceConfig = config;
            console.log('‚úÖ Loaded maintenance config:', config);
            
            // Apply the new configuration
            applyMaintenanceConfig();
            
            return config;
        } else {
            console.log('‚ö†Ô∏è Could not load maintenance config, using defaults');
        }
    } catch (error) {
        console.log('‚ö†Ô∏è Error loading maintenance config:', error);
    }
    return maintenanceConfig;
}

// Apply maintenance configuration
function applyMaintenanceConfig() {
    console.log('üîß Applying maintenance configuration...');
    
    // Restart maintenance checker with new interval
    if (maintenanceConfig.checkInterval > 0) {
        restartMaintenanceChecker(maintenanceConfig.checkInterval);
    } else {
        // Stop checker if interval is 0 (disabled)
        if (maintenanceCheckerInterval) {
            clearInterval(maintenanceCheckerInterval);
            maintenanceCheckerInterval = null;
            console.log('‚è∏Ô∏è Maintenance checker STOPPED (disabled in config)');
        }
    }
    
    console.log(`‚úÖ Applied config - Check interval: ${maintenanceConfig.checkInterval}ms, Music: ${maintenanceConfig.musicEnabled ? 'enabled' : 'disabled'}`);
}

// Restart maintenance checker with new interval
function restartMaintenanceChecker(interval) {
    // Clear existing checker
    if (maintenanceCheckerInterval) {
        clearInterval(maintenanceCheckerInterval);
        console.log('üîÑ Cleared old maintenance checker');
    }
    
    // Start new checker with configured interval
    maintenanceCheckerInterval = setInterval(async () => {
        // Reload config periodically to get updates
        await loadMaintenanceConfig();
        await checkMaintenanceMode();
    }, interval);
    
    console.log(`‚úÖ Maintenance checker restarted with ${interval}ms interval`);
}

// Start maintenance music with 600 seconds duration
function startMaintenanceMusic() {
    // Check if music is enabled in config
    if (!maintenanceConfig.musicEnabled) {
        console.log('üéµ Maintenance music is DISABLED in config - skipping playback');
        return;
    }
    
    const audio = document.getElementById('maintenanceAudio');
    
    if (!audio) {
        console.log('‚ö†Ô∏è Audio element not found');
        return;
    }
    
    // Safari-specific: Load audio data first
    if (audio.readyState < 2) {
        audio.load();
    }
    
    // Enable loop for continuous playback
    audio.loop = true;
    
    // Reset audio to start from beginning
    audio.currentTime = 0;
    audio.volume = maintenanceConfig.musicVolume; // Use configured volume
    
    // Clear any existing timer
    if (maintenanceMusicTimer) {
        clearTimeout(maintenanceMusicTimer);
        maintenanceMusicTimer = null;
    }
    
    // Get duration from config (0 means unlimited)
    const duration = maintenanceConfig.musicDuration;
    
    // Enhanced four-tier autoplay strategy for maximum browser compatibility
    
    // Level 1: Try direct play with Safari optimization
    const playPromise = audio.play();
    
    if (playPromise !== undefined) {
        playPromise.then(() => {
            console.log(`üéµ Maintenance music started automatically (Level 1: Direct play) - Volume: ${Math.round(maintenanceConfig.musicVolume * 100)}%`);
            
            // Set timer to stop after configured duration (if not unlimited)
            // When duration is 0, music will loop indefinitely
            if (duration > 0) {
                maintenanceMusicTimer = setTimeout(() => {
                    audio.pause();
                    audio.currentTime = 0;
                    console.log(`üéµ Maintenance music stopped after ${duration}ms (${duration/1000} seconds)`);
                }, duration);
            } else {
                console.log('üéµ Music set to play continuously (unlimited duration with loop)');
            }
            
        }).catch(err => {
            console.log('‚ö†Ô∏è Level 1 failed, trying Level 2: Muted start then unmute');
            
            // Level 2: Start muted then unmute after short delay
            audio.muted = true;
            const mutedPromise = audio.play();
            
            if (mutedPromise !== undefined) {
                mutedPromise.then(() => {
                    // Wait for audio to actually start playing before unmuting
                    setTimeout(() => {
                        audio.muted = false;
                        audio.volume = maintenanceConfig.musicVolume;
                        console.log(`üéµ Maintenance music started (Level 2: Unmuted after start) - Volume: ${Math.round(maintenanceConfig.musicVolume * 100)}%`);
                        
                        // Set timer to stop after configured duration
                        if (duration > 0) {
                            maintenanceMusicTimer = setTimeout(() => {
                                audio.pause();
                                audio.currentTime = 0;
                                console.log(`üéµ Maintenance music stopped after ${duration}ms`);
                            }, duration);
                        } else {
                            console.log('üéµ Music set to play continuously (unlimited duration with loop)');
                        }
                        
                    }, 100);
                }).catch(err2 => {
                    console.log('‚ö†Ô∏è Level 2 failed, trying Level 3: Load then play');
                    
                    // Level 3: Force load then play (Safari-specific)
                    audio.load();
                    audio.addEventListener('canplaythrough', function playWhenReady() {
                        audio.muted = true;
                        audio.play().then(() => {
                            setTimeout(() => {
                                audio.muted = false;
                                audio.volume = maintenanceConfig.musicVolume;
                                console.log(`üéµ Maintenance music started (Level 3: After load) - Volume: ${Math.round(maintenanceConfig.musicVolume * 100)}%`);
                                
                                if (duration > 0) {
                                    maintenanceMusicTimer = setTimeout(() => {
                                        audio.pause();
                                        audio.currentTime = 0;
                                        console.log(`üéµ Maintenance music stopped after ${duration}ms`);
                                    }, duration);
                                } else {
                                    console.log('üéµ Music set to play continuously (unlimited duration with loop)');
                                }
                            }, 100);
                        }).catch(err3 => {
                            console.log('‚ö†Ô∏è Level 3 failed, waiting for user interaction (Level 4)');
                            setupUserInteractionPlayback(audio, duration);
                        });
                        audio.removeEventListener('canplaythrough', playWhenReady);
                    }, { once: true });
                });
            } else {
                setupUserInteractionPlayback(audio, duration);
            }
        });
    } else {
        setupUserInteractionPlayback(audio, duration);
    }
}

// Helper function to setup user interaction-based playback
function setupUserInteractionPlayback(audio, duration) {
    // Level 4: Wait for any user interaction
    const playOnInteraction = () => {
        audio.loop = true; // Enable loop for continuous playback
        audio.muted = false;
        audio.volume = maintenanceConfig.musicVolume;
        audio.currentTime = 0;
        audio.play().then(() => {
            console.log(`üéµ Maintenance music started (Level 4: After user interaction) - Volume: ${Math.round(maintenanceConfig.musicVolume * 100)}%`);
            
            // Set timer to stop after configured duration
            if (duration > 0) {
                maintenanceMusicTimer = setTimeout(() => {
                    audio.pause();
                    audio.currentTime = 0;
                    console.log(`üéµ Maintenance music stopped after ${duration}ms`);
                }, duration);
            } else {
                console.log('üéµ Music set to play continuously (unlimited duration with loop)');
            }
            
        }).catch(err4 => {
            console.log('‚ùå Failed to play maintenance music after user interaction:', err4);
        });
        
        // Remove listeners after first interaction
        document.removeEventListener('click', playOnInteraction);
        document.removeEventListener('touchstart', playOnInteraction);
        document.removeEventListener('keydown', playOnInteraction);
    };
    
    document.addEventListener('click', playOnInteraction);
    document.addEventListener('touchstart', playOnInteraction);
    document.addEventListener('keydown', playOnInteraction);
}

// Stop maintenance music
function stopMaintenanceMusic() {
    const audio = document.getElementById('maintenanceAudio');
    
    if (audio) {
        audio.pause();
        audio.currentTime = 0;
        console.log('üéµ Maintenance music stopped manually');
    }
    
    // Clear timer if exists
    if (maintenanceMusicTimer) {
        clearTimeout(maintenanceMusicTimer);
        maintenanceMusicTimer = null;
        console.log('‚è±Ô∏è Maintenance music timer cleared');
    }
}

// Update close button visibility based on developer status
function updateMaintenanceCloseButton() {
    const closeBtn = document.getElementById('maintenanceCloseBtn');
    if (closeBtn) {
        if (isDev || window.isDev) {
            closeBtn.classList.add('show-for-dev');
            console.log('üîì Maintenance close button now visible for developer');
        } else {
            closeBtn.classList.remove('show-for-dev');
            console.log('üîí Maintenance close button hidden for non-developer');
        }
    }
}

// Close maintenance mode with developer permission check
async function closeMaintenance() {
    // Only allow developers to close the maintenance mode
    if (isDev || window.isDev) {
        // First hide the overlay immediately for this device
        hideMaintenanceMode();
        console.log('‚úÖ Maintenance Mode closed by developer on this device');
        
        // Then sync with GitHub to close it for all devices
        console.log('‚è≥ Syncing maintenance mode closure with GitHub...');
        const saved = await saveMaintenanceStatusToGitHub(false, []);
        
        if (saved) {
            alert('‚úÖ ÿ™ŸÖ ÿ•ÿ∫ŸÑÿßŸÇ Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ÿ®ŸÜÿ¨ÿßÿ≠!\n\nŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ.\n\nüì± ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ©.');
            console.log('‚úÖ Maintenance Mode closed and synced with GitHub for all devices');
        } else {
            alert('‚úÖ ÿ™ŸÖ ÿ•ÿ∫ŸÑÿßŸÇ Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤!\n\n‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GitHub - ŸÇÿØ Ÿäÿ∏Ÿáÿ± ÿπŸÑŸâ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑÿ£ÿÆÿ±Ÿâ\n\nŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ.');
            console.log('‚ö†Ô∏è Maintenance Mode closed locally but GitHub sync failed');
        }
    } else {
        alert('üîí ÿπÿ∞ÿ±ÿßŸãÿå ÿ•ÿ∫ŸÑÿßŸÇ Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ŸÖÿÆÿµÿµ ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑\n\nŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ©:\n1. ŸÇŸÖ ÿ®ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÉŸÖÿ∑Ÿàÿ±\n2. ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸÉŸÑŸÖÿ© ÿ≥ÿ± ÿßŸÑŸÖÿ∑Ÿàÿ±\n3. ÿ´ŸÖ ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∫ŸÑÿßŸÇ Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ©');
        console.log('‚ö†Ô∏è Non-developer attempted to close maintenance mode');
    }
}

// Save maintenance status to GitHub (server-side storage)
async function saveMaintenanceStatusToGitHub(isEnabled, messages = [], retryCount = 3) {
    const repo = "aliabdelaal-adm/Monthly_inspection_plan";
    let token = localStorage.getItem("devToken");
    
    console.log(`üìù Saving maintenance status: ${isEnabled ? 'ENABLED' : 'DISABLED'}`);
    console.log(`üìã Messages: ${JSON.stringify(messages)}`);
    
    // Use default token if not set
    if (!token && (isDev || window.isDev)) {
        const defaultToken = "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";
        token = defaultToken;
    }
    
    if (!token) {
        console.error('‚ùå No GitHub token available');
        return false;
    }
    
    // Retry logic for network failures
    for (let attempt = 1; attempt <= retryCount; attempt++) {
        try {
            if (attempt > 1) {
                console.log(`üîÑ Retry attempt ${attempt}/${retryCount}...`);
                // Wait before retrying (exponential backoff)
                await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
            }
            
            const status = {
                isMaintenanceMode: isEnabled,
                lastUpdated: new Date().toISOString(),
                updatedBy: "ÿßŸÑŸÖÿ∑Ÿàÿ±",
                messages: messages
            };
            
            // Get current file SHA
            const getResponse = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                }
            });
            
            let sha = null;
            if (getResponse.ok) {
                const fileData = await getResponse.json();
                sha = fileData.sha;
            } else if (getResponse.status !== 404) {
                // If it's not a 404 (file not found), log the error
                console.error(`‚ùå Failed to get file SHA: ${getResponse.status}`, await getResponse.text());
            }
            
            // Create or update the file
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(status, null, 2))));
            const body = {
                message: isEnabled ? 'ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ' : 'ÿ•ŸÑÿ∫ÿßÿ° Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ',
                content: content
            };
            
            if (sha) {
                body.sha = sha;
            }
            
            const updateResponse = await fetch(`https://api.github.com/repos/${repo}/contents/maintenance-status.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body)
            });
            
            if (!updateResponse.ok) {
                const errorText = await updateResponse.text();
                let errorDetails = '';
                try {
                    const errorJson = JSON.parse(errorText);
                    errorDetails = errorJson.message || errorText;
                } catch {
                    errorDetails = errorText;
                }
                
                console.error(`‚ùå Failed to save maintenance status to GitHub (${updateResponse.status}):`, errorDetails);
                
                // Provide specific error messages for common issues
                if (updateResponse.status === 401) {
                    console.error('üîë Token is invalid or expired. Please update your GitHub token.');
                } else if (updateResponse.status === 403) {
                    console.error('üîë Token does not have sufficient permissions. Ensure "repo" scope is enabled.');
                } else if (updateResponse.status === 404) {
                    console.error('üìÇ Repository or file not found. Check repository name and file path.');
                } else if (updateResponse.status >= 500) {
                    console.error('üåê GitHub server error. Please try again later.');
                }
                
                // If this is not the last attempt, continue to retry
                if (attempt < retryCount) {
                    continue;
                }
                return false;
            }
            
            console.log('‚úÖ Maintenance status saved to GitHub successfully');
            return true;
        } catch (error) {
            console.error(`‚ùå Error saving maintenance status to GitHub (attempt ${attempt}/${retryCount}):`, error);
            
            // If this is the last attempt, return false
            if (attempt >= retryCount) {
                return false;
            }
        }
    }
    
    return false;
}

// Load maintenance status from GitHub (server-side storage)
// Clear all caches for instant update propagation
async function clearAllCaches() {
    try {
        console.log('üßπ Clearing all caches for instant update...');
        
        // 1. Clear Service Worker caches (if any)
        if ('serviceWorker' in navigator && 'caches' in window) {
            const cacheNames = await caches.keys();
            await Promise.all(
                cacheNames.map(cacheName => {
                    console.log(`üóëÔ∏è Deleting cache: ${cacheName}`);
                    return caches.delete(cacheName);
                })
            );
            console.log('‚úÖ Service Worker caches cleared');
        }
        
        // 2. Force service worker update (if registered)
        if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (let registration of registrations) {
                console.log('üîÑ Updating service worker...');
                await registration.update();
            }
        }
        
        // 3. Clear localStorage maintenance-related items to force refresh
        // (but keep user data intact)
        const maintenanceKeys = ['maintenanceStatusCache', 'maintenanceStatusCacheTime'];
        maintenanceKeys.forEach(key => {
            if (localStorage.getItem(key)) {
                localStorage.removeItem(key);
                console.log(`üóëÔ∏è Cleared localStorage: ${key}`);
            }
        });
        
        console.log('‚úÖ All caches cleared successfully');
        return true;
    } catch (error) {
        console.error('‚ö†Ô∏è Error clearing caches:', error);
        // Don't fail the operation if cache clearing fails
        return false;
    }
}

async function loadMaintenanceStatusFromGitHub(retries = 3, delayMs = 1000) {
    for (let attempt = 1; attempt <= retries; attempt++) {
        try {
            // Ultra-aggressive cache-busting: timestamp + random + version + attempt
            // This ensures ZERO chance of cache hits across all layers
            const timestamp = Date.now();
            const randomId = Math.random().toString(36).substring(2, 15);
            const randomId2 = Math.random().toString(36).substring(2, 15);
            const version = 'v' + Math.floor(timestamp / 1000); // Version changes every second
            const cacheBuster = `${timestamp}_${randomId}_${randomId2}_${version}_attempt${attempt}`;
            const url = `https://raw.githubusercontent.com/aliabdelaal-adm/Monthly_inspection_plan/main/maintenance-status.json?nocache=${cacheBuster}&_=${timestamp}`;
            
            console.log(`üì° Fetching maintenance status (attempt ${attempt}/${retries})...`);
            console.log(`üîó URL: ${url.substring(0, 120)}...`);
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate, max-age=0',
                    'Pragma': 'no-cache',
                    'Expires': '0',
                    'If-None-Match': '*', // Force bypass ETag validation
                    'If-Modified-Since': 'Thu, 01 Jan 1970 00:00:00 GMT' // Force bypass Last-Modified
                },
                cache: 'no-store', // Force fetch to bypass browser cache
                mode: 'cors',
                credentials: 'omit'
            });
            
            if (!response.ok) {
                console.log(`‚ö†Ô∏è Could not load maintenance status from GitHub (attempt ${attempt}/${retries}): ${response.status}`);
                if (attempt < retries) {
                    await new Promise(resolve => setTimeout(resolve, delayMs * attempt));
                    continue;
                }
                return null;
            }
            
            const status = await response.json();
            console.log('üì• Loaded maintenance status from GitHub:', status);
            
            // Validate the response structure
            if (typeof status.isMaintenanceMode !== 'boolean') {
                console.error('‚ùå Invalid maintenance status format:', status);
                return null;
            }
            
            return status;
        } catch (error) {
            console.error(`‚ùå Error loading maintenance status from GitHub (attempt ${attempt}/${retries}):`, error);
            if (attempt < retries) {
                await new Promise(resolve => setTimeout(resolve, delayMs * attempt));
            }
        }
    }
    
    console.error('‚ùå Failed to load maintenance status after all retries');
    return null;
}

// Verify maintenance status was actually saved by reading it back
async function verifyMaintenanceStatus(expectedStatus, maxWaitSeconds = 30) {
    console.log(`üîç Verifying maintenance status (expecting: ${expectedStatus})...`);
    const startTime = Date.now();
    
    // Try to verify for up to maxWaitSeconds
    while ((Date.now() - startTime) < maxWaitSeconds * 1000) {
        const status = await loadMaintenanceStatusFromGitHub(2, 500);
        
        if (status && status.isMaintenanceMode === expectedStatus) {
            console.log(`‚úÖ Verification successful! Status confirmed: ${expectedStatus}`);
            return true;
        }
        
        console.log(`‚è≥ Status not yet confirmed, waiting... (${Math.floor((Date.now() - startTime) / 1000)}s)`);
        await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds between checks
    }
    
    console.error(`‚ùå Verification failed after ${maxWaitSeconds} seconds`);
    return false;
}

// Validate and ensure token is available before maintenance operations
async function validateTokenForMaintenance() {
    const repo = "aliabdelaal-adm/Monthly_inspection_plan";
    let token = localStorage.getItem("devToken");
    
    // Use default token if not set
    if (!token && (isDev || window.isDev)) {
        const defaultToken = "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";
        token = defaultToken;
        localStorage.setItem("devToken", defaultToken);
        console.log('üîë ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã');
    }
    
    if (!token) {
        alert('‚ùå ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ŸàŸÉŸÜ GitHub!\n\n' +
              'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ™ŸàŸÉŸÜ ÿ£ŸàŸÑÿßŸã ŸÑŸÑÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿ≠ŸÅÿ∏ ÿ≠ÿßŸÑÿ© ÿßŸÑÿµŸäÿßŸÜÿ© ÿπŸÑŸâ GitHub\n' +
              'ÿ≥Ÿäÿ™ŸÖ ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿ¢ŸÜ...');
        showTokenPopup();
        return false;
    }
    
    // Test token validity
    try {
        const testResponse = await fetch(`https://api.github.com/repos/${repo}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            }
        });
        
        if (!testResponse.ok) {
            if (testResponse.status === 401) {
                localStorage.removeItem("devToken");
                alert('‚ùå ÿßŸÑÿ™ŸàŸÉŸÜ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ÿ£Ÿà ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©!\n\n' +
                      'ÿßŸÑÿ≠ŸÑ:\n' +
                      '1. ÿ≥Ÿäÿ™ŸÖ ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ŸÑÿ•ÿØÿÆÿßŸÑ ÿ™ŸàŸÉŸÜ ÿ¨ÿØŸäÿØ\n' +
                      '2. ÿßÿ∞Ÿáÿ® ÿ•ŸÑŸâ GitHub: Settings ‚Üí Developer settings ‚Üí Personal access tokens\n' +
                      '3. ÿ£ŸÜÿ¥ÿ¶ ÿ™ŸàŸÉŸÜ ÿ¨ÿØŸäÿØ ŸÖÿπ ÿµŸÑÿßÿ≠Ÿäÿ© "repo"\n' +
                      '4. ÿ£ÿØÿÆŸÑ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿ¨ÿØŸäÿØ ŸÅŸä ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ©');
                showTokenPopup();
                return false;
            } else if (testResponse.status === 403) {
                alert('‚ùå ÿßŸÑÿ™ŸàŸÉŸÜ ŸÑŸäÿ≥ ŸÑÿØŸäŸá ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ŸÉÿßŸÅŸäÿ©!\n\n' +
                      'ÿßŸÑÿ≠ŸÑ:\n' +
                      '1. ÿßÿ∞Ÿáÿ® ÿ•ŸÑŸâ GitHub: Settings ‚Üí Developer settings ‚Üí Personal access tokens\n' +
                      '2. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ™ŸàŸÉŸÜ ŸÑÿØŸäŸá ÿµŸÑÿßÿ≠Ÿäÿ© "repo"\n' +
                      '3. ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿ©ÿå ÿ£ŸÜÿ¥ÿ¶ ÿ™ŸàŸÉŸÜ ÿ¨ÿØŸäÿØ\n' +
                      '4. ÿßŸÜŸÇÿ± "ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ™ŸàŸÉŸÜ" Ÿàÿ£ÿØÿÆŸÑ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿ¨ÿØŸäÿØ');
                showTokenPopup();
                return false;
            }
        }
        
        console.log('‚úÖ ÿßŸÑÿ™ŸàŸÉŸÜ ÿµÿßŸÑÿ≠ Ÿàÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ');
        return true;
    } catch (error) {
        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ŸàŸÉŸÜ:', error);
        alert('‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ŸÑŸÖ ŸÜÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ŸàŸÉŸÜ\n\n' +
              'ŸÇÿØ ŸäŸÉŸàŸÜ ŸáŸÜÿßŸÉ ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™.\n' +
              'ÿ≥ŸÜÿ≠ÿßŸàŸÑ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿå ŸÑŸÉŸÜ ŸÇÿØ ŸÑÿß ÿ™ŸÜÿ¨ÿ≠ ÿßŸÑÿπŸÖŸÑŸäÿ©.');
        return true; // Continue anyway
    }
}

// Enable maintenance mode for all users (called by developer)
// Global flag to prevent concurrent execution
let isMaintenanceOperationInProgress = false;

async function enableMaintenanceModeForAll() {
    if (!isDev && !window.isDev) {
        alert('‚ùå ÿπÿ∞ÿ±ÿßŸãÿå Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑');
        return;
    }
    
    // Prevent concurrent execution (debouncing)
    if (isMaintenanceOperationInProgress) {
        console.log('‚ö†Ô∏è ÿπŸÖŸÑŸäÿ© ÿ£ÿÆÿ±Ÿâ ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞ - Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±');
        showMaintenanceProgress('‚ö†Ô∏è ÿπŸÖŸÑŸäÿ© ÿ£ÿÆÿ±Ÿâ ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞\nŸäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿ≠ÿ™Ÿâ ÿ™ŸÜÿ™ŸáŸä...', 'warning');
        setTimeout(() => hideMaintenanceProgress(), 2000);
        return;
    }
    
    // Disable buttons to prevent multiple clicks
    const enableBtn = document.getElementById('enableMaintenanceBtn');
    const disableBtn = document.getElementById('disableMaintenanceBtn');
    if (enableBtn) {
        enableBtn.disabled = true;
        enableBtn.style.opacity = '0.6';
        enableBtn.style.cursor = 'not-allowed';
    }
    if (disableBtn) {
        disableBtn.disabled = true;
        disableBtn.style.opacity = '0.6';
        disableBtn.style.cursor = 'not-allowed';
    }
    
    isMaintenanceOperationInProgress = true;
    
    try {
        // Step 1: Show initial progress message
        showMaintenanceProgress('üîê ÿ¨ÿßÿ±Ÿä ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ...\n‚è≥ Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±...', 'loading');
        console.log('üîê Starting maintenance mode activation...');
        
        // Step 2: Validate token before proceeding
        showMaintenanceProgress('üîë ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ŸàŸÉŸÜ...', 'loading');
        const tokenValid = await validateTokenForMaintenance();
        if (!tokenValid) {
            console.log('‚ö†Ô∏è ÿ•ŸÑÿ∫ÿßÿ° ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© - ÿßŸÑÿ™ŸàŸÉŸÜ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠');
            hideMaintenanceProgress();
            return;
        }
        
        // Step 3: Save to localStorage immediately for instant effect on current device
        showMaintenanceProgress('üíæ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤...', 'loading');
        localStorage.setItem('systemMaintenanceMode', 'true');
        console.log('‚úÖ Enabled locally');
        
        // Step 4: Save to GitHub for synchronization across all devices
        showMaintenanceProgress('‚òÅÔ∏è ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ÿßŸÑÿ≠ÿßŸÑÿ© ÿπŸÑŸâ GitHub...\n‚è≥ Ÿáÿ∞ÿß ŸÇÿØ Ÿäÿ≥ÿ™ÿ∫ÿ±ŸÇ ÿ®ÿ∂ÿπ ÿ´ŸàÿßŸÜ...', 'loading');
        const messages = ['ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ∏ÿßŸÖ', 'ŸäŸÇŸàŸÖ ÿßŸÑŸÖÿ∑Ÿàÿ± ÿ®ÿ•ÿ¨ÿ±ÿßÿ° ÿ™ÿπÿØŸäŸÑÿßÿ™', 'ÿ¥ŸÉÿ±ÿßŸã ÿπŸÑŸâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±'];
        const saved = await saveMaintenanceStatusToGitHub(true, messages);
        
        // Always show the message locally and trigger broadcast, regardless of GitHub sync status
        // Clear all possible caches to ensure instant propagation
        await clearAllCaches();
        
        // Clear the notification flag so users see the update message
        sessionStorage.removeItem('maintenanceNotificationShown');
        
        // üî• Trigger a broadcast signal to notify all tabs/devices immediately
        // This uses localStorage events to sync across tabs instantly
        localStorage.setItem('maintenanceBroadcast', Date.now().toString());
        console.log('üì° Broadcast signal sent to all tabs');
        
        hideMaintenanceProgress();
        
        if (saved) {
            // Show immediate success alert
            alert('‚úÖ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ ÿ®ŸÜÿ¨ÿßÿ≠!\n\n' +
                  'üì± ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ¢ŸÜ:\n' +
                  '‚Ä¢ ‚úì ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿπŸÑŸâ GitHub ÿ®ŸÜÿ¨ÿßÿ≠\n' +
                  '‚Ä¢ ‚úì ÿ™ŸÖ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÅŸàÿ±ÿßŸã\n' +
                  '‚Ä¢ ‚úì ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿßÿ±ÿ© ŸÅŸàÿ±Ÿäÿ© ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ©\n' +
                  '‚Ä¢ ‚úì ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÉÿßÿ¥ ŸÑÿ∂ŸÖÿßŸÜ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅŸàÿ±Ÿä\n' +
                  '‚Ä¢ ‚úì ÿ≥ÿ™ÿ∏Ÿáÿ± ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿµŸäÿßŸÜÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ© ŸÖÿπ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÅŸàÿ±ÿßŸã\n' +
                  '‚Ä¢ ‚úì ÿ≥Ÿäÿ∏Ÿáÿ± ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿÆŸÑÿßŸÑ 3-5 ÿ´ŸàÿßŸÜŸä\n' +
                  '‚Ä¢ ‚úì ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿ≥Ÿäÿ±ŸàŸÜ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿµŸäÿßŸÜÿ©');
            console.log('‚úÖ Maintenance mode enabled for all users on all devices');
            
            // Verification happens in background (no delay for user)
            verifyMaintenanceStatus(true, 15).then(verified => {
                if (verified) {
                    console.log('üõ°Ô∏è Verification successful - maintenance mode is active');
                } else {
                    console.log('‚ö†Ô∏è Could not verify, but status was saved successfully');
                }
            });
        } else {
            // Even if GitHub save failed, local mode is active and message will show
            alert('‚ö†Ô∏è ÿ™ŸÖ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸÖÿ≠ŸÑŸäÿßŸã ÿ®ŸÜÿ¨ÿßÿ≠!\n\n' +
                  'üì± ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©:\n' +
                  '‚Ä¢ ‚úì ÿ™ŸÖ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÅŸàÿ±ÿßŸã\n' +
                  '‚Ä¢ ‚úì ÿ≥ÿ™ÿ∏Ÿáÿ± ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿµŸäÿßŸÜÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ© ŸÖÿπ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©\n' +
                  '‚Ä¢ ‚úì ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿßÿ±ÿ© ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ©\n' +
                  '‚Ä¢ ‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿπŸÑŸâ GitHub (ŸÇÿØ ŸÑÿß Ÿäÿ∏Ÿáÿ± ŸÑŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑÿ£ÿÆÿ±Ÿâ)\n\n' +
                  'üí° ÿßŸÑÿ≥ÿ®ÿ® ÿßŸÑŸÖÿ≠ÿ™ŸÖŸÑ:\n' +
                  '‚Ä¢ ÿßŸÑÿ™ŸàŸÉŸÜ ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ© ÿ£Ÿà ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠\n' +
                  '‚Ä¢ ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™\n' +
                  '‚Ä¢ ÿÆÿ∑ÿ£ ŸÅŸä GitHub API\n\n' +
                  'üîß ÿßŸÑÿ≠ŸÑ:\n' +
                  '1. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™\n' +
                  '2. ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿ≤ÿ± "üîë ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸàŸÉŸÜ" ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸàŸÉŸÜ GitHub\n' +
                  '3. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ®ÿπÿØ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸàŸÉŸÜ');
            console.error('‚ö†Ô∏è Maintenance mode activated locally only - GitHub sync failed');
        }
    } catch (error) {
        console.error('‚ùå Error in enableMaintenanceModeForAll:', error);
        hideMaintenanceProgress();
        alert('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÇÿπ: ' + error.message);
    } finally {
        // Re-enable buttons after operation completes
        isMaintenanceOperationInProgress = false;
        if (enableBtn) {
            enableBtn.disabled = false;
            enableBtn.style.opacity = '1';
            enableBtn.style.cursor = 'pointer';
        }
        if (disableBtn) {
            disableBtn.disabled = false;
            disableBtn.style.opacity = '1';
            disableBtn.style.cursor = 'pointer';
        }
    }
}

// Disable maintenance mode for all users (called by developer)
async function disableMaintenanceModeForAll() {
    if (!isDev && !window.isDev) {
        alert('‚ùå ÿπÿ∞ÿ±ÿßŸãÿå Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑');
        return;
    }
    
    // Prevent concurrent execution (debouncing)
    if (isMaintenanceOperationInProgress) {
        console.log('‚ö†Ô∏è ÿπŸÖŸÑŸäÿ© ÿ£ÿÆÿ±Ÿâ ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞ - Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±');
        showMaintenanceProgress('‚ö†Ô∏è ÿπŸÖŸÑŸäÿ© ÿ£ÿÆÿ±Ÿâ ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞\nŸäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿ≠ÿ™Ÿâ ÿ™ŸÜÿ™ŸáŸä...', 'warning');
        setTimeout(() => hideMaintenanceProgress(), 2000);
        return;
    }
    
    // Disable buttons to prevent multiple clicks
    const enableBtn = document.getElementById('enableMaintenanceBtn');
    const disableBtn = document.getElementById('disableMaintenanceBtn');
    if (enableBtn) {
        enableBtn.disabled = true;
        enableBtn.style.opacity = '0.6';
        enableBtn.style.cursor = 'not-allowed';
    }
    if (disableBtn) {
        disableBtn.disabled = true;
        disableBtn.style.opacity = '0.6';
        disableBtn.style.cursor = 'not-allowed';
    }
    
    isMaintenanceOperationInProgress = true;
    
    try {
        // Step 1: Show initial progress message
        showMaintenanceProgress('üîì ÿ¨ÿßÿ±Ÿä ÿ•ŸÑÿ∫ÿßÿ° Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ...\n‚è≥ Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±...', 'loading');
        console.log('üîì Starting maintenance mode deactivation...');
        
        // Step 2: Validate token before proceeding
        showMaintenanceProgress('üîë ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ŸàŸÉŸÜ...', 'loading');
        const tokenValid = await validateTokenForMaintenance();
        if (!tokenValid) {
            console.log('‚ö†Ô∏è ÿ•ŸÑÿ∫ÿßÿ° ÿ•ŸäŸÇÿßŸÅ Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© - ÿßŸÑÿ™ŸàŸÉŸÜ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠');
            hideMaintenanceProgress();
            return;
        }
        
        // Step 3: Remove from localStorage immediately for instant effect on current device
        showMaintenanceProgress('üíæ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ŸÑÿ∫ÿßÿ° ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤...', 'loading');
        localStorage.removeItem('systemMaintenanceMode');
        sessionStorage.removeItem('maintenanceNotificationShown');
        hideMaintenanceMode();
        console.log('‚úÖ Disabled locally');
        
        // Step 4: Save to GitHub for synchronization across all devices
        showMaintenanceProgress('‚òÅÔ∏è ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ÿßŸÑÿ≠ÿßŸÑÿ© ÿπŸÑŸâ GitHub...\n‚è≥ Ÿáÿ∞ÿß ŸÇÿØ Ÿäÿ≥ÿ™ÿ∫ÿ±ŸÇ ÿ®ÿ∂ÿπ ÿ´ŸàÿßŸÜ...', 'loading');
        const saved = await saveMaintenanceStatusToGitHub(false, []);
        
        // Always clear caches and trigger broadcast, regardless of GitHub sync status
        // Clear all possible caches to ensure instant propagation
        await clearAllCaches();
        
        // üî• Trigger a broadcast signal to notify all tabs/devices immediately
        // This uses localStorage events to sync across tabs instantly
        localStorage.setItem('maintenanceBroadcast', Date.now().toString());
        console.log('üì° Broadcast signal sent to all tabs');
        
        hideMaintenanceProgress();
        
        if (saved) {
            // Show immediate success alert
            alert('‚úÖ ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ ÿ®ŸÜÿ¨ÿßÿ≠!\n\n' +
                  'üì± ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ¢ŸÜ:\n' +
                  '‚Ä¢ ‚úì ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿπŸÑŸâ GitHub ÿ®ŸÜÿ¨ÿßÿ≠\n' +
                  '‚Ä¢ ‚úì ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ° ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÅŸàÿ±ÿßŸã\n' +
                  '‚Ä¢ ‚úì ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿßÿ±ÿ© ŸÅŸàÿ±Ÿäÿ© ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ©\n' +
                  '‚Ä¢ ‚úì ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÉÿßÿ¥ ŸÑÿ∂ŸÖÿßŸÜ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅŸàÿ±Ÿä\n' +
                  '‚Ä¢ ‚úì ÿ≥ŸäÿÆÿ™ŸÅŸä ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿÆŸÑÿßŸÑ 3-5 ÿ´ŸàÿßŸÜŸä\n' +
                  '‚Ä¢ ‚úì ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸäŸÖŸÉŸÜŸáŸÖ ÿßŸÑÿ¢ŸÜ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÜÿ∏ÿßŸÖ');
            console.log('‚úÖ Maintenance mode disabled for all users on all devices');
            
            // Verification happens in background (no delay for user)
            verifyMaintenanceStatus(false, 15).then(verified => {
                if (verified) {
                    console.log('‚úÖ Verification successful - maintenance mode is disabled');
                } else {
                    console.log('‚ö†Ô∏è Could not verify, but status was saved successfully');
                }
            });
        } else {
            alert('‚ö†Ô∏è ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ° ŸÖÿ≠ŸÑŸäÿßŸã ÿ®ŸÜÿ¨ÿßÿ≠!\n\n' +
                  'üì± ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©:\n' +
                  '‚Ä¢ ‚úì ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ° ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÅŸàÿ±ÿßŸã\n' +
                  '‚Ä¢ ‚úì ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿµŸäÿßŸÜÿ© ŸÑŸÜ ÿ™ÿ∏Ÿáÿ± ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤\n' +
                  '‚Ä¢ ‚úì ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿßÿ±ÿ© ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ©\n' +
                  '‚Ä¢ ‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿπŸÑŸâ GitHub (ŸÇÿØ ŸÑÿß Ÿäÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ° ŸÑŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑÿ£ÿÆÿ±Ÿâ)\n\n' +
                  'üí° ÿßŸÑÿ≥ÿ®ÿ® ÿßŸÑŸÖÿ≠ÿ™ŸÖŸÑ:\n' +
                  '‚Ä¢ ÿßŸÑÿ™ŸàŸÉŸÜ ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ© ÿ£Ÿà ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠\n' +
                  '‚Ä¢ ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™\n' +
                  '‚Ä¢ ÿÆÿ∑ÿ£ ŸÅŸä GitHub API\n\n' +
                  'üîß ÿßŸÑÿ≠ŸÑ:\n' +
                  '1. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™\n' +
                  '2. ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿ≤ÿ± "üîë ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸàŸÉŸÜ" ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸàŸÉŸÜ GitHub\n' +
                  '3. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ®ÿπÿØ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸàŸÉŸÜ');
            console.error('‚ö†Ô∏è Maintenance mode disabled locally only - GitHub sync failed');
        }
    } catch (error) {
        console.error('‚ùå Error in disableMaintenanceModeForAll:', error);
        hideMaintenanceProgress();
        alert('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÇÿπ: ' + error.message);
    } finally {
        // Re-enable buttons after operation completes
        isMaintenanceOperationInProgress = false;
        if (enableBtn) {
            enableBtn.disabled = false;
            enableBtn.style.opacity = '1';
            enableBtn.style.cursor = 'pointer';
        }
        if (disableBtn) {
            disableBtn.disabled = false;
            disableBtn.style.opacity = '1';
            disableBtn.style.cursor = 'pointer';
        }
    }
}

// Check if system is in maintenance mode on page load
async function checkMaintenanceMode() {
    try {
        // First check GitHub for the global maintenance status
        const githubStatus = await loadMaintenanceStatusFromGitHub();
        
        if (githubStatus && githubStatus.isMaintenanceMode) {
            // Check if this is a NEW maintenance activation (wasn't active before)
            const wasAlreadyActive = localStorage.getItem('systemMaintenanceMode') === 'true';
            const wasAlreadyNotified = sessionStorage.getItem('maintenanceNotificationShown') === 'true';
            
            // Sync with localStorage
            localStorage.setItem('systemMaintenanceMode', 'true');
            
            // If user is not a developer, show maintenance overlay with notification
            if (!isDev && !window.isDev) {
                console.log('‚ö†Ô∏è System is in maintenance mode (from GitHub) - showing overlay for non-developer');
                
                const messages = githubStatus.messages && githubStatus.messages.length > 0 
                    ? githubStatus.messages 
                    : ['ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ∏ÿßŸÖ', 'ŸäŸÇŸàŸÖ ÿßŸÑŸÖÿ∑Ÿàÿ± ÿ®ÿ•ÿ¨ÿ±ÿßÿ° ÿ™ÿπÿØŸäŸÑÿßÿ™', 'ÿ¥ŸÉÿ±ÿßŸã ÿπŸÑŸâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±'];
                
                // Show the full maintenance screen with music directly for all non-developer users
                showMaintenanceModeWithNotification(messages);
            } else {
                console.log('‚ö†Ô∏è System is in maintenance mode (from GitHub) - developer has access');
            }
        } else {
            // If GitHub says no maintenance, remove from localStorage
            const localMode = localStorage.getItem('systemMaintenanceMode') === 'true';
            if (!githubStatus || !githubStatus.isMaintenanceMode) {
                localStorage.removeItem('systemMaintenanceMode');
                sessionStorage.removeItem('maintenanceNotificationShown');
                // If overlay was shown, hide it
                if (localMode) {
                    hideMaintenanceMode();
                    // Also hide any lingering progress messages
                    hideMaintenanceProgress();
                }
            }
        }
    } catch (error) {
        console.error('‚ùå Error in checkMaintenanceMode:', error);
        // On error, check localStorage as fallback
        const localMode = localStorage.getItem('systemMaintenanceMode') === 'true';
        if (localMode && !isDev && !window.isDev) {
            console.log('‚ö†Ô∏è Using local maintenance status as fallback');
            // Use wrapper function to show notification first
            showMaintenanceModeWithNotification(['ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ∏ÿßŸÖ', 'ŸäŸÇŸàŸÖ ÿßŸÑŸÖÿ∑Ÿàÿ± ÿ®ÿ•ÿ¨ÿ±ÿßÿ° ÿ™ÿπÿØŸäŸÑÿßÿ™', 'ÿ¥ŸÉÿ±ÿßŸã ÿπŸÑŸâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±']);
        }
    }
}

// Force an immediate maintenance status check (useful for debugging)
async function forceMaintenanceCheck() {
    console.log('üîÑ Forcing immediate maintenance status check...');
    await checkMaintenanceMode();
    console.log('‚úÖ Forced check completed');
}

// üî• NEW: Manual test function to show update message (for testing/debugging)


// Periodically check maintenance status with configurable interval
async function startMaintenanceStatusChecker() {
    // Load configuration first
    await loadMaintenanceConfig();
    
    // Check immediately on startup - this ensures instant notification on page load
    checkMaintenanceMode();
    
    // Start checker with configured interval
    if (maintenanceConfig.checkInterval > 0) {
        maintenanceCheckerInterval = setInterval(async () => {
            // Reload config to get updates
            await loadMaintenanceConfig();
            await checkMaintenanceMode();
        }, maintenanceConfig.checkInterval);
        
        console.log(`‚úÖ Maintenance status checker started with ${maintenanceConfig.checkInterval}ms interval`);
    } else {
        console.log('‚è∏Ô∏è Maintenance checker is DISABLED (interval = 0)');
    }
}

function performDataValidation(data) {
    console.log('üîç Performing data validation...');
    
    const validation = validateDataIntegrity(data);
    
    if (!validation.isValid) {
        console.error('‚ùå Data validation failed:', validation.issues);
        showMaintenanceModeWithNotification(validation.issues);
        return false;
    }
    
    console.log('‚úÖ Data validation passed');
    return true;
}

// Firewall Protection - Check data before allowing operations
function firewallCheck() {
    // Get current data
    const currentData = allPlanData || {};
    
    // Basic firewall checks
    if (!currentData.inspectors || currentData.inspectors.length === 0) {
        console.warn('üõ°Ô∏è Firewall: No inspectors data found');
        return false;
    }
    
    // Check for suspicious data
    const validation = validateDataIntegrity(currentData);
    if (!validation.isValid) {
        console.error('üõ°Ô∏è Firewall: Suspicious data detected!', validation.issues);
        showMaintenanceModeWithNotification(validation.issues);
        return false;
    }
    
    return true;
}

// Load data from JSON file
async function loadInspectionData() {
    const statusDiv = document.getElementById('refreshStatus');
    try {
        if (statusDiv) {
            statusDiv.style.display = 'block';
        }
        
        const response = await fetch('./plan-data.json?t=' + Date.now());
        if (response.ok) {
            const data = await response.json();
            
            // SECURITY CHECK: Validate data integrity
            const integrityCheck = validateDataIntegrity(data);
            if (!integrityCheck.isValid) {
                showSecurityWarning(integrityCheck.issues);
                // Continue loading but with warning displayed
            }

            // üõ°Ô∏è Firewall Protection: Validate data before loading
            console.log('üõ°Ô∏è Firewall: Validating incoming data...');
            const validation = validateDataIntegrity(data);
            
            if (!validation.isValid) {
                console.error('üõ°Ô∏è Firewall: Data validation failed!', validation.issues);
                showMaintenanceModeWithNotification(validation.issues);
                
                // Use cached data from localStorage instead
                const allLocalData = localStorage.getItem('allPlanData');
                if (allLocalData) {
                    const cachedData = JSON.parse(allLocalData);
                    console.log('üõ°Ô∏è Firewall: Using cached safe data from localStorage');
                    
                    if (cachedData.inspectionData) inspectionData = cachedData.inspectionData;
                    if (cachedData.inspectors) {
                        inspectorsData = cachedData.inspectors;
                        inspectors = inspectorsData.map(i => i.name);
                    }
                    if (cachedData.areas) areasData = cachedData.areas;
                    if (cachedData.shops) shopsData = cachedData.shops;
                    if (cachedData.bellNotes) bellNotesData = cachedData.bellNotes;
                    
                    allPlanData = cachedData;
                }
                
                // Don't proceed with corrupted data
                return;
            }
            
            console.log('‚úÖ Firewall: Data validation passed');
            // Only hide maintenance mode if it was triggered by data validation, not by system maintenance mode
            const systemMaintenanceActive = localStorage.getItem('systemMaintenanceMode') === 'true';
            if (!systemMaintenanceActive) {
                hideMaintenanceMode();
            } else {
                console.log('‚ÑπÔ∏è System maintenance mode is active - keeping maintenance overlay visible');
            }
            
            if (data.inspectionData && Array.isArray(data.inspectionData)) {
                inspectionData = data.inspectionData;
                lastUpdateTime = data.lastUpdate;
                if (data.inspectors && Array.isArray(data.inspectors)) {
                    inspectorsData = data.inspectors;
                    inspectors = inspectorsData.map(i=>i.name);
                }
                if (data.areas && Array.isArray(data.areas)) {
                    areasData = data.areas;
                }
                if (data.shops && Array.isArray(data.shops)) {
                    shopsData = data.shops;
                }
                // Load bell notes data if available - support both old and new format
                if (data.bellNotes) {
                    bellNotesData = data.bellNotes;
                    // Ensure notifications array exists
                    if (!bellNotesData.notifications) {
                        bellNotesData.notifications = [];
                    }
                    // Update news ticker with loaded notifications
                    updateNewsTicker();
                }
                // Update global allPlanData with loaded data
                allPlanData = {
                    inspectionData: inspectionData,
                    inspectors: inspectorsData,
                    areas: areasData,
                    shops: shopsData,
                    bellNotes: bellNotesData || { notifications: [] },
                    lastUpdate: data.lastUpdate
                };
                
                // Store in localStorage for comparison in next auto-refresh
                try {
                    localStorage.setItem('allPlanData', JSON.stringify(allPlanData));
                    // Store data version for quick comparison
                    localStorage.setItem('dataVersion', data.lastUpdate || new Date().toISOString());
                    console.log('‚úÖ Data cached in localStorage with version:', data.lastUpdate);
                } catch (e) {
                    console.warn('Failed to cache data in localStorage:', e);
                }
                
                // Display last update date/time for all users
                displayLastUpdateFromData(data.lastUpdate);
                renderPlanTable();
                fillInspectorsDropdowns();
                fillAreasDropdowns();
                fillShopsDropdowns();
            }
        } else {
            console.warn('Failed to fetch plan data - response not ok:', response.status);
        }
    } catch (error) {
        console.warn('Failed to load plan data, using fallback data:', error);
        
        // Show maintenance mode message to inform users about the update
        showMaintenanceModeWithNotification([
            'ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ',
            'ÿ¨ÿßÿ±Ÿä ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©',
            'ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã'
        ]);
        
        // Auto-hide maintenance mode after 5 seconds (only if not in system maintenance)
        setTimeout(() => {
            const systemMaintenanceActive = localStorage.getItem('systemMaintenanceMode') === 'true';
            if (!systemMaintenanceActive) {
                hideMaintenanceMode();
            } else {
                console.log('‚ÑπÔ∏è System maintenance mode is active - keeping maintenance overlay visible');
            }
        }, 5000);
        
        // First try to load complete data from localStorage
        const allLocalData = localStorage.getItem('allPlanData');
        if (allLocalData) {
            try {
                const allData = JSON.parse(allLocalData);
                if (allData.inspectionData) inspectionData = allData.inspectionData;
                if (allData.inspectors) {
                    inspectorsData = allData.inspectors;
                    inspectors = inspectorsData.map(i => i.name);
                }
                if (allData.areas) areasData = allData.areas;
                if (allData.shops) shopsData = allData.shops;
                if (allData.bellNotes) {
                    bellNotesData = allData.bellNotes;
                    // Update news ticker with localStorage data
                    updateNewsTicker();
                }
                
                // Update global allPlanData with loaded fallback data
                allPlanData = {
                    inspectionData: inspectionData,
                    inspectors: inspectorsData,
                    areas: areasData,
                    shops: shopsData,
                    bellNotes: bellNotesData || { notifications: [] },
                    lastUpdate: allData.lastUpdate
                };
                
                // Display last update from localStorage backup
                displayLastUpdateFromData(allData.lastUpdate);
                console.log('Loaded complete data from localStorage backup');
            } catch (parseError) {
                console.warn('Failed to parse localStorage data, using individual fallback');
                // Fall back to individual localStorage items
                const localInspectionData = localStorage.getItem('inspectionData');
                if (localInspectionData) {
                    inspectionData = JSON.parse(localInspectionData);
                }
                // No lastUpdate available in individual fallback
                displayLastUpdateFromData(null);
            }
        } else {
            // Fall back to individual localStorage item
            const localInspectionData = localStorage.getItem('inspectionData');
            if (localInspectionData) {
                inspectionData = JSON.parse(localInspectionData);
            }
            // No lastUpdate available in individual fallback
            displayLastUpdateFromData(null);
        }
    } finally {
        // Always ensure dropdowns are populated and table is rendered
        fillInspectorsDropdowns();
        fillAreasDropdowns();
        fillShopsDropdowns();
        renderPlanTable();
        if (statusDiv) {
            setTimeout(() => statusDiv.style.display = 'none', 1000);
        }
    }
}

// ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜ ŸÖŸÑŸÅ Excel ÿßŸÑŸÖÿ≥ÿ™ÿÆÿ±ÿ¨
let shopsDetailsData = {};
async function loadShopsDetails() {
    try {
        const response = await fetch('./shops_details.json?t=' + Date.now(), {
            cache: 'no-cache',
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache'
            }
        });
        if (response.ok) {
            shopsDetailsData = await response.json();
            console.log(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${Object.keys(shopsDetailsData).length} ŸÖÿ≠ŸÑ ŸÖŸÜ ŸÖŸÑŸÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™`);
            return true;
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ shops_details.json:', error);
    }
    return false;
}

// ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ plan-data.json
async function loadPlanData() {
    try {
        const response = await fetch('./plan-data.json?t=' + Date.now(), {
            cache: 'no-cache',
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache'
            }
        });
        if (response.ok) {
            const planData = await response.json();
            if (Array.isArray(planData) && planData.length > 0) {
                inspectionData = planData;
                saveInspectionData();
                renderPlanTable();
                console.log('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿÆÿ∑ÿ© ŸÖŸÜ plan-data.json ÿ®ŸÜÿ¨ÿßÿ≠');
                return true;
            }
        }
    } catch (error) {
        console.warn('ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ plan-data.jsonÿå ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©:', error);
    }
    return false;
}

/**
 * Validate that no shop is assigned to multiple inspectors on the same day
 * Returns: { isValid: boolean, duplicates: array }
 */
function validateShopDuplicates(inspectionDataToValidate, daysToCheck = null) {
    // Track shop assignments by day: {day: {shop: [inspector1, inspector2, ...]}}
    const dayShopInspectors = {};
    const duplicates = [];
    
    // Date cutoff: Only apply validation from October 7, 2024 onwards
    // ÿ®ÿØÿßŸäÿ© ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÇÿßÿπÿØÿ©: ŸÖŸÜ 7 ÿ£ŸÉÿ™Ÿàÿ®ÿ± 2024 ŸÅÿµÿßÿπÿØÿßŸã
    const VALIDATION_START_DATE = new Date('2024-10-07');
    
    for (const entry of inspectionDataToValidate) {
        const day = entry.day;
        const inspector = entry.inspector;
        const shops = entry.shops || [];
        
        if (!day || !inspector || shops.length === 0) {
            continue;
        }
        
        // If daysToCheck is specified, only process entries for those days
        if (daysToCheck !== null && !daysToCheck.includes(day)) {
            continue;
        }
        
        // Skip validation for dates before October 7, 2024
        // ÿ™ÿÆÿ∑Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÑŸÑÿ™Ÿàÿßÿ±ŸäÿÆ ŸÇÿ®ŸÑ 7 ÿ£ŸÉÿ™Ÿàÿ®ÿ± 2024
        const entryDate = new Date(day);
        if (entryDate < VALIDATION_START_DATE) {
            continue;
        }
        
        if (!dayShopInspectors[day]) {
            dayShopInspectors[day] = {};
        }
        
        for (const shop of shops) {
            if (!dayShopInspectors[day][shop]) {
                dayShopInspectors[day][shop] = [];
            }
            dayShopInspectors[day][shop].push(inspector);
        }
    }
    
    // Find duplicates (only for dates >= October 7, 2024)
    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ™ŸÉÿ±ÿßÿ±ÿßÿ™ (ŸÅŸÇÿ∑ ŸÑŸÑÿ™Ÿàÿßÿ±ŸäÿÆ >= 7 ÿ£ŸÉÿ™Ÿàÿ®ÿ± 2024)
    for (const [day, shopsDict] of Object.entries(dayShopInspectors)) {
        for (const [shop, inspectors] of Object.entries(shopsDict)) {
            if (inspectors.length > 1) {
                duplicates.push({
                    day: day,
                    shop: shop,
                    inspectors: inspectors
                });
            }
        }
    }
    
    return {
        isValid: duplicates.length === 0,
        duplicates: duplicates
    };
}

/**
 * Display duplicate shop validation error message
 */
function showDuplicateShopsError(duplicates) {
    let errorMessage = '‚ùå ÿÆÿ∑ÿ£: ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ™ŸÉÿ±ÿßÿ± ŸÖÿ≠ŸÑÿßÿ™ ŸÑÿπÿØÿ© ŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ!\n';
    errorMessage += '‚ùå Error: Duplicate shop assignments detected!\n\n';
    errorMessage += 'üìÖ ÿßŸÑŸÇÿßÿπÿØÿ©: ŸÑÿß ŸäŸèÿ≥ŸÖÿ≠ ÿ®ÿ™ŸÉÿ±ÿßÿ± ŸÜŸÅÿ≥ ÿßŸÑŸÖÿ≠ŸÑ ŸÑÿ£ŸÉÿ´ÿ± ŸÖŸÜ ŸÖŸÅÿ™ÿ¥ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ (ÿ®ÿØÿ°ÿßŸã ŸÖŸÜ 7 ÿ£ŸÉÿ™Ÿàÿ®ÿ± 2024)\n';
    errorMessage += 'üìÖ Policy: Same shop cannot be assigned to multiple inspectors on the same day (starting from October 7, 2024)\n\n';
    errorMessage += `üîî ÿπÿØÿØ ÿßŸÑÿ™ŸÉÿ±ÿßÿ±ÿßÿ™ / Number of duplicates: ${duplicates.length}\n\n`;
    errorMessage += 'üìã ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ™ŸÉÿ±ÿßÿ±ÿßÿ™ / Duplicate Details:\n';
    errorMessage += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
    
    duplicates.forEach((dup, index) => {
        const formattedDate = new Date(dup.day).toLocaleDateString('ar-EG', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        errorMessage += `${index + 1}. üìÖ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ / Date: ${formattedDate} (${dup.day})\n`;
        errorMessage += `   üè™ ÿßŸÑŸÖÿ≠ŸÑ / Shop: ${dup.shop}\n`;
        errorMessage += `   üë• ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ / Inspectors (${dup.inspectors.length}):\n`;
        dup.inspectors.forEach(inspector => {
            errorMessage += `      - ${inspector}\n`;
        });
        errorMessage += '\n';
    });
    
    errorMessage += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    errorMessage += '‚ö†Ô∏è  ÿ™ŸàÿµŸäÿßÿ™ / Recommendations:\n';
    errorMessage += '   1. Ÿäÿ±ÿ¨Ÿâ ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿÆÿ∑ÿ© Ÿàÿ™ÿπÿØŸäŸÑ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™\n';
    errorMessage += '   1. Please review the plan and modify shop assignments\n';
    errorMessage += '   2. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ŸÉŸÑ ŸÖÿ≠ŸÑ ŸÖÿÆÿµÿµ ŸÑŸÖŸÅÿ™ÿ¥ Ÿàÿßÿ≠ÿØ ŸÅŸÇÿ∑ ŸÅŸä ÿßŸÑŸäŸàŸÖ ÿßŸÑŸàÿßÿ≠ÿØ (ÿµÿ®ÿßÿ≠ÿßŸã ÿ£Ÿà ŸÖÿ≥ÿßÿ°Ÿã)\n';
    errorMessage += '   2. Ensure each shop is assigned to only one inspector per day (morning or evening)\n';
    errorMessage += '   3. ŸäŸÖŸÉŸÜ ÿ™ÿÆÿµŸäÿµ ŸÜŸÅÿ≥ ÿßŸÑŸÖÿ≠ŸÑ ŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÖÿÆÿ™ŸÑŸÅŸäŸÜ ŸÅŸä ÿ£ŸäÿßŸÖ ŸÖÿÆÿ™ŸÑŸÅÿ©\n';
    errorMessage += '   3. The same shop can be assigned to different inspectors on different days\n';
    errorMessage += '   4. ÿßŸÑŸÇÿßÿπÿØÿ© ÿ™ÿ∑ÿ®ŸÇ ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿ®ÿØÿ°ÿßŸã ŸÖŸÜ 7 ÿ£ŸÉÿ™Ÿàÿ®ÿ± 2024 ŸÅÿµÿßÿπÿØÿßŸã\n';
    errorMessage += '   4. Policy applies to all inspections starting from October 7, 2024 onwards\n';
    
    alert(errorMessage);
}

function saveInspectionData() {
    // Save to localStorage as backup
    localStorage.setItem('inspectionData', JSON.stringify(inspectionData));
    setLastUpdateDate();
    
    // Note: File export is now manual only via the "ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ ŸÖŸÑŸÅ JSON" button
    // This prevents excessive downloads on every developer action
}

// Function to save data to external JSON file automatically (for synchronization)
async function saveToExternalFileAutomatic(planData, silent = false) {
    try {
        const dataStr = JSON.stringify(planData, null, 2);
        
        // Method 1: Direct file write using fetch (works in local file:// protocol or development server)
        try {
            const response = await fetch('./plan-data.json', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: dataStr
            });
            
            if (response.ok) {
                console.log('‚úÖ Data automatically saved to plan-data.json for synchronization');
                return true;
            } else {
                console.log('‚ùå Could not save via fetch, response not ok:', response.status);
            }
        } catch (fetchError) {
            console.log('Direct file write not available (expected in browser environment):', fetchError.message);
        }
        
        // Method 2: Try File System Access API if available (Chrome/Edge) - with file picker on first use
        if ('showSaveFilePicker' in window && window.FileSystemHandle) {
            try {
                // Check if we have an existing file handle (for subsequent saves)
                if (window.bellDataFileHandle) {
                    const writable = await window.bellDataFileHandle.createWritable();
                    await writable.write(dataStr);
                    await writable.close();
                    console.log('‚úÖ Data automatically saved using existing file handle to local repository');
                    if (!silent) {
                        showUpdateMessage('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ ŸÅŸä ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑŸÖÿ≠ÿØÿØ ÿπŸÑŸâ ÿ¨Ÿáÿßÿ≤ŸÉ');
                    }
                    return true;
                } else {
                    // First time - prompt user to select the file location
                    // Only show file picker if not in silent mode
                    if (!silent) {
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: 'plan-data.json',
                            types: [{
                                description: 'JSON files',
                                accept: {'application/json': ['.json']},
                            }],
                        });
                        
                        // Store file handle for future automatic saves
                        window.bellDataFileHandle = fileHandle;
                        
                        const writable = await fileHandle.createWritable();
                        await writable.write(dataStr);
                        await writable.close();
                        console.log('‚úÖ Data saved to selected location and handle stored for future automatic saves');
                        showUpdateMessage('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ! ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÖŸàŸÇÿπ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑ');
                        return true;
                    }
                }
            } catch (err) {
                if (err.name === 'AbortError') {
                    console.log('File save cancelled by user');
                    if (!silent) {
                        showUpdateMessage('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ≠ŸÅÿ∏ - ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÅŸä localStorage ŸÅŸÇÿ∑');
                    }
                    return false;
                } else {
                    console.log('File System Access API error:', err);
                }
            }
        }
        
        // Method 3: Fallback - only save to localStorage, no auto-download
        // Auto-download has been removed to prevent unwanted downloads to Downloads/OneDrive folder
        console.log('‚ö†Ô∏è File System Access API not available - data saved to localStorage only');
        // Only show warning if not in silent mode
        if (!silent) {
            showUpdateMessage('‚ö†Ô∏è ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÅŸÇÿ∑ - Ÿäÿ±ÿ¨Ÿâ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ≤ÿ± "ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™" ŸÑÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ');
        }
        
        return false;
    } catch (error) {
        console.error('Error in automatic file save:', error);
        return false;
    }
}

// Function to save data to external JSON file (for developer mode)
async function saveToExternalFile() {
    try {
        const planData = {
            inspectionData: inspectionData,
            inspectors: inspectorsData,
            areas: areasData,
            shops: shopsData,
            bellNotes: bellNotesData,
            lastUpdate: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(planData, null, 2);
        
        // Method 1: Direct file write (works in local file:// protocol)
        try {
            const response = await fetch('./plan-data.json', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: dataStr
            });
            
            if (response.ok) {
                showUpdateMessage('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä plan-data.json ÿ®ŸÜÿ¨ÿßÿ≠!');
                console.log('‚úÖ Data saved directly to plan-data.json:', planData);
                return;
            }
        } catch (fetchError) {
            console.log('Direct file write not available (expected in browser):', fetchError.message);
        }
        
        // Method 2: Use File System Access API (Chrome/Edge)
        if ('showSaveFilePicker' in window) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: 'plan-data.json',
                    types: [{
                        description: 'JSON files',
                        accept: {'application/json': ['.json']},
                    }],
                });
                
                // Store file handle for future automatic saves
                window.bellDataFileHandle = fileHandle;
                
                const writable = await fileHandle.createWritable();
                await writable.write(dataStr);
                await writable.close();
                showUpdateMessage('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÖŸÑŸÅ plan-data.json ÿ®ŸÜÿ¨ÿßÿ≠! ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑ.');
                console.log('‚úÖ Data saved using File System Access API and handle stored for future saves:', planData);
                return;
            } catch (err) {
                if (err.name === 'AbortError') {
                    // User cancelled the file picker - don't proceed with automatic download
                    showUpdateMessage('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ≠ŸÅÿ∏');
                    console.log('File save cancelled by user');
                    return;
                } else {
                    console.log('File System Access API error:', err);
                    // Continue to Method 3 only if there was a real error (not user cancellation)
                }
            }
        }
        
        // Method 3: Automatic download + helper script (only as last resort)
        // Download the updated plan-data.json file
        const jsonBlob = new Blob([dataStr], {type: 'application/json'});
        const jsonUrl = URL.createObjectURL(jsonBlob);
        
        const jsonLink = document.createElement('a');
        jsonLink.href = jsonUrl;
        jsonLink.download = 'plan-data.json';
        jsonLink.style.display = 'none';
        document.body.appendChild(jsonLink);
        jsonLink.click();
        document.body.removeChild(jsonLink);
        URL.revokeObjectURL(jsonUrl);
        
        // Store the data for potential script access
        localStorage.setItem('latestPlanData', dataStr);
        localStorage.setItem('latestPlanDataTimestamp', new Date().toISOString());
        
        // Create and show detailed instructions only for automatic download
        const instructions = `
üìã ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:

ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ£ŸàŸÑŸâ (ÿßŸÑÿ£ÿ≥ŸáŸÑ):
1. ÿ™ŸÖ ÿ™ŸÜÿ≤ŸäŸÑ ŸÖŸÑŸÅ plan-data.json ÿ¨ÿØŸäÿØ
2. ÿßŸÜÿ≥ÿÆ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖŸÜÿ≤ŸÑ ÿ•ŸÑŸâ ŸÖÿ¨ŸÑÿØ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ (ÿßÿ≥ÿ™ÿ®ÿØŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖŸàÿ¨ŸàÿØ)

ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ© (ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ≥ŸÉÿ±Ÿäÿ®ÿ™ Python):
1. ÿßŸÅÿ™ÿ≠ ÿ≥ÿ∑ÿ± ÿßŸÑÿ£ŸàÿßŸÖÿ± ŸÅŸä ŸÖÿ¨ŸÑÿØ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ
2. ÿ¥ÿ∫ŸÑ ÿßŸÑÿ£ŸÖÿ±: python save_from_browser.py
3. ÿßŸÑÿµŸÇ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ JSON ÿπŸÜÿØŸÖÿß Ÿäÿ∑ŸÑÿ® ŸÖŸÜŸÉ

ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ´ÿßŸÑÿ´ÿ© (ŸäÿØŸàŸäÿßŸã):
1. ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Ÿàÿ≠ÿØÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ (console)
2. ÿßŸÅÿ™ÿ≠ plan-data.json ŸÅŸä ŸÖÿ≠ÿ±ÿ± ÿßŸÑŸÜÿµŸàÿµ
3. ÿßÿ≥ÿ™ÿ®ÿØŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸàÿßŸÑÿµŸÇ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
        `;
        
        console.log('üìã ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑÿ≠ŸÅÿ∏:', instructions);
        console.log('üìä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©:', dataStr);
        
        showUpdateMessage(`‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± plan-data.json - ÿ±ÿßÿ¨ÿπ Ÿàÿ≠ÿØÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ (F12) ŸÑŸÑÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸäÿ©`);
        
        // Show instructions only if user wants them
        setTimeout(() => {
            if (confirm('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿπÿ±ÿ∂ ÿßŸÑÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸäÿ©ÿü')) {
                alert(instructions.trim());
            }
        }, 100);
        
    } catch (error) {
        console.error('‚ùå Failed to save to external file:', error);
        showUpdateMessage('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿµÿØŸäÿ± - ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ŸÖÿ≠ŸÑŸäÿßŸã ŸÅŸÇÿ∑');
    }
}

function showUpdateMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = 'position:fixed;top:20px;right:20px;background:#28a745;color:white;padding:10px 15px;border-radius:5px;z-index:1000;';
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    setTimeout(() => document.body.removeChild(messageDiv), 3000);
}

// Show persistent progress message for maintenance mode operations
function showMaintenanceProgress(message, type = 'loading', persist = false) {
    // Remove any existing maintenance progress message
    const existing = document.getElementById('maintenanceProgressMsg');
    if (existing) {
        existing.remove();
    }
    
    // Create new progress message
    const messageDiv = document.createElement('div');
    messageDiv.id = 'maintenanceProgressMsg';
    
    // Store persist flag as data attribute
    messageDiv.setAttribute('data-persist', persist.toString());
    
    // Choose background color based on type
    let bgColor = '#ffc107'; // warning/loading color (yellow)
    if (type === 'success') bgColor = '#28a745'; // green
    if (type === 'error') bgColor = '#dc3545'; // red
    if (type === 'info') bgColor = '#17a2b8'; // blue
    if (type === 'warning') bgColor = '#ff9800'; // orange
    
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${bgColor};
        color: white;
        padding: 18px 30px;
        border-radius: 10px;
        z-index: 10001;
        font-size: 18px;
        font-weight: bold;
        box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        text-align: center;
        min-width: 350px;
        max-width: 550px;
        white-space: pre-line;
        animation: slideDown 0.3s ease-out, ${persist ? 'pulse 2s ease-in-out infinite' : 'none'};
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        border: 3px solid rgba(255,255,255,0.3);
    `;
    
    // Add loading spinner if type is 'loading' or 'warning'
    if (type === 'loading' || type === 'warning') {
        const spinner = document.createElement('div');
        spinner.className = 'progress-spinner';
        messageDiv.appendChild(spinner);
    }
    
    const textSpan = document.createElement('span');
    textSpan.textContent = message;
    messageDiv.appendChild(textSpan);
    
    document.body.appendChild(messageDiv);
    
    console.log(`üì¢ Maintenance progress message shown - persist: ${persist}`);
    console.log(`üìç Message position: top: 20px, z-index: 10001`);
    console.log(`üé® Message style: ${type} (${bgColor})`);
    console.log(`üìù Message text: ${message}`);
    
    // Verify the message is actually in the DOM
    setTimeout(() => {
        const check = document.getElementById('maintenanceProgressMsg');
        if (check) {
            console.log('‚úÖ Message confirmed in DOM');
        } else {
            console.error('‚ùå WARNING: Message not found in DOM after creation!');
        }
    }, 100);
    
    return messageDiv;
}

// Hide maintenance progress message
function hideMaintenanceProgress() {
    const existing = document.getElementById('maintenanceProgressMsg');
    if (existing) {
        const isPersistent = existing.getAttribute('data-persist') === 'true';
        console.log(`üóëÔ∏è Hiding maintenance progress message (was persistent: ${isPersistent})`);
        existing.style.animation = 'slideUp 0.3s ease-in';
        setTimeout(() => existing.remove(), 300);
    } else {
        console.log('‚ÑπÔ∏è No maintenance progress message to hide');
    }
}

// Add CSS animation for progress messages
if (!document.getElementById('maintenanceProgressStyles')) {
    const style = document.createElement('style');
    style.id = 'maintenanceProgressStyles';
    style.textContent = `
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 6px 20px rgba(0,0,0,0.4);
                transform: translateX(-50%) scale(1);
            }
            50% { 
                box-shadow: 0 8px 30px rgba(0,0,0,0.6);
                transform: translateX(-50%) scale(1.02);
            }
        }
        .progress-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
            flex-shrink: 0;
        }
    `;
    document.head.appendChild(style);
}
function setLastUpdateDate() {
    // Only update the date/time dynamically if user is a developer making changes
    if (!isDev && !window.isDev) return;
    
    let row = document.getElementById('lastUpdateRow');
    let today = new Date();
    let year = today.getFullYear();
    let month = String(today.getMonth()+1).padStart(2,'0');
    let day = String(today.getDate()).padStart(2,'0');
    let hours = today.getHours();
    let minutes = String(today.getMinutes()).padStart(2,'0');
    let period = hours >= 12 ? 'ŸÖÿ≥ÿßÿ°Ÿã' : 'ÿµÿ®ÿßÿ≠Ÿãÿß';
    let hour12 = hours % 12;
    if(hour12 === 0) hour12 = 12;
    let timeStr = hour12 + ':' + minutes + ' ' + period;
    let dateStr = year+'-'+month+'-'+day;
    row.textContent = "ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´ ŸÑŸÑÿÆÿ∑ÿ©: " + dateStr + "    " + timeStr;
}

function displayLastUpdateFromData(lastUpdateISO) {
    // Display the last update date/time from loaded data - visible to all users
    let row = document.getElementById('lastUpdateRow');
    
    if (!lastUpdateISO) {
        row.textContent = "ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´ ŸÑŸÑÿÆÿ∑ÿ©: ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠";
        return;
    }
    
    try {
        let updateDate = new Date(lastUpdateISO);
        let year = updateDate.getFullYear();
        let month = String(updateDate.getMonth()+1).padStart(2,'0');
        let day = String(updateDate.getDate()).padStart(2,'0');
        let hours = updateDate.getHours();
        let minutes = String(updateDate.getMinutes()).padStart(2,'0');
        let period = hours >= 12 ? 'ŸÖÿ≥ÿßÿ°Ÿã' : 'ÿµÿ®ÿßÿ≠Ÿãÿß';
        let hour12 = hours % 12;
        if(hour12 === 0) hour12 = 12;
        let timeStr = hour12 + ':' + minutes + ' ' + period;
        let dateStr = year+'-'+month+'-'+day;
        row.textContent = "ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´ ŸÑŸÑÿÆÿ∑ÿ©: " + dateStr + "    " + timeStr;
    } catch (error) {
        console.warn('Error parsing last update date:', error);
        row.textContent = "ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´ ŸÑŸÑÿÆÿ∑ÿ©: ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠";
    }
}

function initializeLastUpdateDate() {
    // Initialize the last update display on page load with a loading message
    let row = document.getElementById('lastUpdateRow');
    row.textContent = "ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´ ŸÑŸÑÿÆÿ∑ÿ©: ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...";
}
function fillInspectorsDropdowns() {
    // ŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÑÿ£ÿØÿßÿ© ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±
    const selectInspect = document.getElementById('inspectorSelect');
    selectInspect.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥ --</option>';
    inspectorsData.forEach(inspector => {
        selectInspect.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
    });
    // ŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÅŸä ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑŸÖÿ∑Ÿàÿ±
    const select2 = document.getElementById('formInspector');
    if (select2) {
        select2.innerHTML = `<option value="">ÿßÿÆÿ™ÿ± ŸÖŸÅÿ™ÿ¥</option>`;
        inspectorsData.forEach(inspector => {
            select2.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
        });
    }
}
function fillAreasDropdowns() {
    // ŸÖŸÜÿ∑ŸÇÿ© ŸÅŸä ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑŸÖÿ∑Ÿàÿ±
    const areaSelect = document.getElementById('formArea');
    if (areaSelect) {
        areaSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ŸÖŸÜÿ∑ŸÇÿ©</option>';
        areasData.forEach(area => {
            areaSelect.innerHTML += `<option value="${area.id}">${area.name}</option>`;
        });
    }
    
    // ŸÖŸÜÿ∑ŸÇÿ© ŸÅŸä ŸÖŸàÿØÿßŸÑ ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ
    const newShopAreaSelect = document.getElementById('newShopArea');
    if (newShopAreaSelect) {
        newShopAreaSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</option>';
        areasData.forEach(area => {
            newShopAreaSelect.innerHTML += `<option value="${area.id}">${area.name}</option>`;
        });
    }
    
    // ŸÖŸÜÿ∑ŸÇÿ© ŸÅŸä ŸÖÿ±ÿ®ÿπ ÿßŸÑÿ®ÿ≠ÿ´
    const searchAreaSelect = document.getElementById('searchArea');
    if (searchAreaSelect) {
        searchAreaSelect.innerHTML = '<option value="">-- ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ --</option>';
        areasData.forEach(area => {
            searchAreaSelect.innerHTML += `<option value="${area.id}">${area.name}</option>`;
        });
    }
}

// Store selected shops for custom dropdown
let customSelectedShops = [];

function fillShopsDropdowns(selectedAreaId = null) {
    const shopsSelect = document.getElementById('formShops');
    const customShopsContent = document.getElementById('customShopsContent');
    
    if (shopsSelect) {
        shopsSelect.innerHTML = '';
    }
    
    if (customShopsContent) {
        customShopsContent.innerHTML = '';
        
        // Get the selected area ID and name
        let selectedAreaIdValue = null;
        let selectedAreaName = null;
        if (!selectedAreaId) {
            const areaSelect = document.getElementById('formArea');
            selectedAreaIdValue = areaSelect ? areaSelect.value : null;
            // Find the area by ID to get its name
            if (selectedAreaIdValue) {
                const selectedArea = areasData.find(a => a.id === selectedAreaIdValue);
                selectedAreaName = selectedArea ? selectedArea.name : null;
            }
        } else {
            selectedAreaIdValue = selectedAreaId;
            const selectedArea = areasData.find(a => a.id === selectedAreaId);
            selectedAreaName = selectedArea ? selectedArea.name : null;
        }
        
        if (selectedAreaIdValue && selectedAreaName) {
            // First, add shops from the selected area
            const selectedAreaShops = shopsData.filter(shop => {
                return shop.areaId === selectedAreaIdValue;
            });
            
            // Add selected area shops with a special label
            if (selectedAreaShops.length > 0) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'custom-shops-group';
                
                const labelDiv = document.createElement('div');
                labelDiv.className = 'custom-shops-group-label';
                labelDiv.textContent = `ŸÖÿ≠ŸÑÿßÿ™ ${selectedAreaName} (ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©)`;
                groupDiv.appendChild(labelDiv);
                
                selectedAreaShops.forEach(shop => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'custom-shops-option';
                    optionDiv.dataset.value = shop.name;
                    optionDiv.innerHTML = `
                        <span class="custom-shops-option-text">${shop.name}</span>
                        <span class="custom-shops-option-check">‚úì</span>
                    `;
                    optionDiv.onclick = () => toggleShopSelection(shop.name, optionDiv);
                    groupDiv.appendChild(optionDiv);
                    
                    // Also add to hidden select
                    if (shopsSelect) {
                        const option = document.createElement('option');
                        option.value = shop.name;
                        option.textContent = shop.name;
                        shopsSelect.appendChild(option);
                    }
                });
                
                customShopsContent.appendChild(groupDiv);
            }
            
            // Then, add shops from other areas
            const otherAreaShops = shopsData.filter(shop => {
                return shop.areaId !== selectedAreaIdValue;
            });
            
            if (otherAreaShops.length > 0) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'custom-shops-group';
                
                const labelDiv = document.createElement('div');
                labelDiv.className = 'custom-shops-group-label';
                labelDiv.textContent = 'ŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜ ŸÖŸÜÿßÿ∑ŸÇ ÿ£ÿÆÿ±Ÿâ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)';
                groupDiv.appendChild(labelDiv);
                
                otherAreaShops.forEach(shop => {
                    const area = areasData.find(a => a.id === shop.areaId);
                    const areaName = area ? area.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'custom-shops-option';
                    optionDiv.dataset.value = shop.name;
                    optionDiv.innerHTML = `
                        <span class="custom-shops-option-text">${shop.name} (${areaName})</span>
                        <span class="custom-shops-option-check">‚úì</span>
                    `;
                    optionDiv.onclick = () => toggleShopSelection(shop.name, optionDiv);
                    groupDiv.appendChild(optionDiv);
                    
                    // Also add to hidden select
                    if (shopsSelect) {
                        const option = document.createElement('option');
                        option.value = shop.name;
                        option.textContent = `${shop.name} (${areaName})`;
                        shopsSelect.appendChild(option);
                    }
                });
                
                customShopsContent.appendChild(groupDiv);
            }
        } else {
            // No area selected - show all shops grouped by area
            const groupedShops = {};
            shopsData.forEach(shop => {
                const area = areasData.find(a => a.id === shop.areaId);
                const areaName = area ? area.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                if (!groupedShops[areaName]) {
                    groupedShops[areaName] = [];
                }
                groupedShops[areaName].push(shop);
            });
            
            // Add each area group
            Object.keys(groupedShops).sort().forEach(areaName => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'custom-shops-group';
                
                const labelDiv = document.createElement('div');
                labelDiv.className = 'custom-shops-group-label';
                labelDiv.textContent = areaName;
                groupDiv.appendChild(labelDiv);
                
                groupedShops[areaName].forEach(shop => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'custom-shops-option';
                    optionDiv.dataset.value = shop.name;
                    optionDiv.innerHTML = `
                        <span class="custom-shops-option-text">${shop.name}</span>
                        <span class="custom-shops-option-check">‚úì</span>
                    `;
                    optionDiv.onclick = () => toggleShopSelection(shop.name, optionDiv);
                    groupDiv.appendChild(optionDiv);
                    
                    // Also add to hidden select
                    if (shopsSelect) {
                        const option = document.createElement('option');
                        option.value = shop.name;
                        option.textContent = shop.name;
                        shopsSelect.appendChild(option);
                    }
                });
                
                customShopsContent.appendChild(groupDiv);
            });
        }
    }
    
    // Update shop counter when selection changes
    updateSelectedShopsCount();
}

// Function to toggle shop selection in custom dropdown
function toggleShopSelection(shopName, optionElement) {
    const index = customSelectedShops.indexOf(shopName);
    
    if (index > -1) {
        // Remove from selection
        customSelectedShops.splice(index, 1);
        optionElement.classList.remove('selected');
    } else {
        // Add to selection
        customSelectedShops.push(shopName);
        optionElement.classList.add('selected');
    }
    
    // Update hidden select
    syncCustomSelectionToHiddenSelect();
    
    // Update counter and trigger text
    updateSelectedShopsCount();
    updateCustomTriggerText();
}

// Sync custom dropdown selections to hidden select element
function syncCustomSelectionToHiddenSelect() {
    const shopsSelect = document.getElementById('formShops');
    if (shopsSelect) {
        // Clear all selections
        Array.from(shopsSelect.options).forEach(opt => opt.selected = false);
        
        // Select the shops that are in customSelectedShops
        Array.from(shopsSelect.options).forEach(opt => {
            if (customSelectedShops.includes(opt.value)) {
                opt.selected = true;
            }
        });
    }
}

// Update the trigger button text
function updateCustomTriggerText() {
    const triggerText = document.getElementById('customShopsTriggerText');
    if (triggerText) {
        if (customSelectedShops.length === 0) {
            triggerText.textContent = 'ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≠ŸÑÿßÿ™';
            triggerText.classList.add('placeholder');
        } else if (customSelectedShops.length === 1) {
            triggerText.textContent = customSelectedShops[0];
            triggerText.classList.remove('placeholder');
        } else {
            triggerText.textContent = `${customSelectedShops.length} ŸÖÿ≠ŸÑ ŸÖÿ≠ÿØÿØ`;
            triggerText.classList.remove('placeholder');
        }
    }
}

// Function to update selected shops count
function updateSelectedShopsCount() {
    const countDisplay = document.getElementById('selectedShopsCount');
    if (countDisplay) {
        const selectedCount = customSelectedShops.length;
        countDisplay.textContent = `${selectedCount} ŸÖÿ≠ŸÑ`;
        countDisplay.style.color = selectedCount > 0 ? '#28a745' : '#007bff';
    }
}

// Open/Close custom dropdown
function toggleCustomShopsDropdown() {
    const menu = document.getElementById('customShopsDropdownMenu');
    const trigger = document.getElementById('customShopsTrigger');
    
    if (menu.classList.contains('show')) {
        closeCustomShopsDropdown();
    } else {
        openCustomShopsDropdown();
    }
}

function openCustomShopsDropdown() {
    const menu = document.getElementById('customShopsDropdownMenu');
    const trigger = document.getElementById('customShopsTrigger');
    
    if (menu && trigger) {
        // Position the menu
        const rect = trigger.getBoundingClientRect();
        menu.style.left = rect.left + 'px';
        menu.style.top = (rect.bottom + 5) + 'px';
        menu.style.width = Math.max(350, rect.width) + 'px';
        
        // Show menu
        menu.classList.add('show');
        trigger.classList.add('active');
        
        // Focus search
        const searchInput = document.getElementById('customShopsSearch');
        if (searchInput) {
            setTimeout(() => searchInput.focus(), 100);
        }
    }
}

function closeCustomShopsDropdown() {
    const menu = document.getElementById('customShopsDropdownMenu');
    const trigger = document.getElementById('customShopsTrigger');
    
    if (menu && trigger) {
        menu.classList.remove('show');
        trigger.classList.remove('active');
        
        // Clear search
        const searchInput = document.getElementById('customShopsSearch');
        if (searchInput) {
            searchInput.value = '';
            filterCustomShops('');
        }
    }
}

// Filter shops based on search
function filterCustomShops(searchTerm) {
    const options = document.querySelectorAll('.custom-shops-option');
    const groups = document.querySelectorAll('.custom-shops-group');
    const term = searchTerm.toLowerCase().trim();
    
    options.forEach(option => {
        const text = option.dataset.value.toLowerCase();
        if (text.includes(term)) {
            option.style.display = 'flex';
        } else {
            option.style.display = 'none';
        }
    });
    
    // Hide groups that have no visible options
    groups.forEach(group => {
        const visibleOptions = group.querySelectorAll('.custom-shops-option[style*="display: flex"], .custom-shops-option:not([style*="display"])');
        if (visibleOptions.length === 0) {
            group.style.display = 'none';
        } else {
            group.style.display = 'block';
        }
    });
}

// Select all visible shops in custom dropdown
function customSelectAllShops() {
    const options = document.querySelectorAll('.custom-shops-option');
    
    options.forEach(option => {
        // Only select visible options
        if (option.style.display !== 'none') {
            const shopName = option.dataset.value;
            if (!customSelectedShops.includes(shopName)) {
                customSelectedShops.push(shopName);
                option.classList.add('selected');
            }
        }
    });
    
    syncCustomSelectionToHiddenSelect();
    updateSelectedShopsCount();
    updateCustomTriggerText();
}

// Clear all shop selections
function customClearShopsSelection() {
    const options = document.querySelectorAll('.custom-shops-option');
    
    options.forEach(option => {
        option.classList.remove('selected');
    });
    
    customSelectedShops = [];
    
    syncCustomSelectionToHiddenSelect();
    updateSelectedShopsCount();
    updateCustomTriggerText();
}

// Legacy functions - redirect to custom dropdown functions
function selectAllShops() {
    customSelectAllShops();
}

function clearShopsSelection() {
    customClearShopsSelection();
}

document.addEventListener('DOMContentLoaded', function() {
    initializeLastUpdateDate();
    
    // üõ°Ô∏è Initial data validation on page load
    console.log('üõ°Ô∏è Starting initial data validation...');
    console.log('‚ö° Fast Sync Mode: Data checks every 10 seconds (reduced from 30 seconds)');
    console.log('üîÑ Changes will appear on all devices within 10-20 seconds');
    
    // Removed automatic playback - sound only plays on user touch/click interactions
    loadInspectionData(); // Load data from JSON file - will call fillInspectorsDropdowns() when complete
    startAutoRefresh(); // Start auto-refresh functionality
    startDailyRefresh(); // Start daily midnight refresh functionality
    
    // Ensure dropdowns are filled on page load
    fillInspectorsDropdowns();
    fillAreasDropdowns();
    fillShopsDropdowns();
    
    // Add event listeners for custom shops dropdown
    const customShopsTrigger = document.getElementById('customShopsTrigger');
    if (customShopsTrigger) {
        customShopsTrigger.addEventListener('click', toggleCustomShopsDropdown);
    }
    
    // Search functionality
    const customShopsSearch = document.getElementById('customShopsSearch');
    if (customShopsSearch) {
        customShopsSearch.addEventListener('input', (e) => {
            filterCustomShops(e.target.value);
        });
        customShopsSearch.addEventListener('keydown', (e) => {
            e.stopPropagation();
        });
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        const menu = document.getElementById('customShopsDropdownMenu');
        const trigger = document.getElementById('customShopsTrigger');
        
        if (menu && trigger && 
            !menu.contains(e.target) && 
            !trigger.contains(e.target) &&
            menu.classList.contains('show')) {
            closeCustomShopsDropdown();
        }
    });
    
    // Prevent dropdown menu clicks from closing it
    const customShopsDropdownMenu = document.getElementById('customShopsDropdownMenu');
    if (customShopsDropdownMenu) {
        customShopsDropdownMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    }
    
    // Add event listeners for toggle buttons and management buttons
    
    // Inspector toggle
    document.getElementById('toggleInspectorInput').addEventListener('click', function() {
        const select = document.getElementById('formInspector');
        const input = document.getElementById('newInspectorInput');
        if (select.style.display === 'none') {
            select.style.display = 'inline-block';
            select.setAttribute('required', 'required'); // Re-enable validation for select
            input.style.display = 'none';
            input.removeAttribute('required'); // Remove validation from input
            this.textContent = '+';
            this.title = 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÅÿ™ÿ¥ ÿ¨ÿØŸäÿØ';
        } else {
            select.style.display = 'none';
            select.removeAttribute('required'); // Remove validation from hidden select
            input.style.display = 'inline-block';
            input.setAttribute('required', 'required'); // Enable validation for input
            input.focus();
            this.textContent = '√ó';
            this.title = 'ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÖŸÅÿ™ÿ¥ ÿ¨ÿØŸäÿØ';
        }
    });
    
    // Area toggle
    document.getElementById('toggleAreaInput').addEventListener('click', function() {
        const select = document.getElementById('formArea');
        const input = document.getElementById('newAreaInput');
        if (select.style.display === 'none') {
            select.style.display = 'inline-block';
            select.setAttribute('required', 'required'); // Re-enable validation for select
            input.style.display = 'none';
            input.removeAttribute('required'); // Remove validation from input
            this.textContent = '+';
            this.title = 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇÿ© ÿ¨ÿØŸäÿØÿ©';
        } else {
            select.style.display = 'none';
            select.removeAttribute('required'); // Remove validation from hidden select
            input.style.display = 'inline-block';
            input.setAttribute('required', 'required'); // Enable validation for input
            input.focus();
            this.textContent = '√ó';
            this.title = 'ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÖŸÜÿ∑ŸÇÿ© ÿ¨ÿØŸäÿØÿ©';
        }
    });
    
    // Area change handler - no longer filters shops, always show all shops for free selection
    document.getElementById('formArea').addEventListener('change', function() {
        // Just refresh the shops dropdown without filtering
        fillShopsDropdowns();
    });
    
    // Management buttons
    document.getElementById('manageInspectorsBtn').addEventListener('click', function() {
        document.getElementById('inspectorsModal').style.display = 'flex';
        displayInspectorsList();
    });
    
    document.getElementById('manageAreasBtn').addEventListener('click', function() {
        document.getElementById('areasModal').style.display = 'flex';
        displayAreasList();
    });
    
    document.getElementById('manageShopsBtn').addEventListener('click', function() {
        document.getElementById('shopsModal').style.display = 'flex';
        displayShopsList();
    });
    
    // Add new shop button  
    document.getElementById('addNewShop').addEventListener('click', function() {
        document.getElementById('shopsModal').style.display = 'flex';
        displayShopsList();
    });
    
    // Search functionality
    document.getElementById('applySearchBtn').addEventListener('click', applySearchFilters);
    document.getElementById('clearSearchBtn').addEventListener('click', clearSearchFilters);
    
    // Search toggle functionality
    document.getElementById('searchToggleBtn').addEventListener('click', function() {
        const searchSection = document.getElementById('searchFiltersSection');
        if (searchSection.style.display === 'none' || searchSection.style.display === '') {
            searchSection.style.display = 'block';
            this.innerHTML = 'üîç ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ®ÿ≠ÿ´';
            this.style.background = '#dc3545';
        } else {
            searchSection.style.display = 'none';
            this.innerHTML = 'üîç ÿßŸÑÿ®ÿ≠ÿ´';
            this.style.background = '#234085';
        }
    });
    
    // Real-time search on input changes
    document.getElementById('searchFromDate').addEventListener('change', applySearchFilters);
    document.getElementById('searchToDate').addEventListener('change', applySearchFilters);
    document.getElementById('searchArea').addEventListener('change', applySearchFilters);
    document.getElementById('searchShift').addEventListener('change', applySearchFilters);
});

// ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸàÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ±
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById("loginRole").addEventListener("change", function() {
        let role = this.value;
        document.getElementById("devError").innerText = "";
        if(role === "developer") {
            // Check if developer is already logged in
            const isAlreadyLoggedIn = isDev || localStorage.getItem('isDevLoggedIn') === 'true';
            
            if (isAlreadyLoggedIn) {
                // Developer is already logged in, just show the UI
                console.log('‚úÖ Developer already logged in - preserving session');
                document.getElementById("devSection").style.display = "block";
                document.getElementById("devLogoutBtn").style.display = "inline-block";
                document.getElementById("devPassword").style.display = "none";
                document.getElementById("devLoginBtn").style.display = "none";
                document.getElementById("systemServicesContainer").style.display = "block";
                
                // Show all categories including developer-only categories
                const developerCategories = document.querySelectorAll('.developer-only-category');
                console.log(`üìä PR#317: Found ${developerCategories.length} developer-only categories to show`);
                developerCategories.forEach(cat => {
                    cat.style.display = 'contents';
                    console.log('üìä PR#317: Shown category:', cat.id);
                });
                
                const fileLibraryBtn = document.getElementById("fileLibraryBtn");
                if (fileLibraryBtn) {
                    fileLibraryBtn.style.display = "inline-flex";
                }
            } else {
                // Show login form for new login
                document.getElementById("devPassword").style.display = "inline-block";
                document.getElementById("devLoginBtn").style.display = "inline-block";
                document.getElementById("devLogoutBtn").style.display = "none";
                document.getElementById("devSection").style.display = "none";
                // Keep system services visible (showing only reports for non-logged-in users)
                // document.getElementById("systemServicesContainer").style.display = "none";
                const fileLibraryBtn = document.getElementById("fileLibraryBtn");
                if (fileLibraryBtn) {
                    fileLibraryBtn.style.display = "none";
                }
            }
            // Hide file library section if open when showing login form
            const fileSection = document.getElementById('fileManagementSection');
            if (fileSection && !isAlreadyLoggedIn) {
                fileSection.style.display = 'none';
            }
        } else if (role === "inspector") {
            // Switching to inspector - clear developer session
            const wasLoggedIn = isDev || localStorage.getItem('isDevLoggedIn') === 'true';
            if (wasLoggedIn) {
                console.log('üö™ Logging out developer - switching to inspector');
            }
            isDev = false;
            localStorage.removeItem('isDevLoggedIn');
            
            document.getElementById("devPassword").style.display = "none";
            document.getElementById("devLoginBtn").style.display = "none";
            document.getElementById("devLogoutBtn").style.display = "none";
            document.getElementById("devSection").style.display = "none";
            
            // Show system services container for inspector (with only reports visible)
            document.getElementById("systemServicesContainer").style.display = "block";
            console.log('üìä PR#317: Showing System Services for Inspector');
            
            // Hide developer-only categories
            const developerCategories = document.querySelectorAll('.developer-only-category');
            console.log(`üìä PR#317: Found ${developerCategories.length} developer-only categories to hide`);
            developerCategories.forEach(cat => {
                cat.style.display = 'none';
                console.log('üìä PR#317: Hidden category:', cat.id);
            });
            
            // Hide file library button for inspectors
            const fileLibraryBtn = document.getElementById("fileLibraryBtn");
            if (fileLibraryBtn) {
                fileLibraryBtn.style.display = "none";
            }
            // Hide file library section if open
            const fileSection = document.getElementById('fileManagementSection');
            if (fileSection) {
                fileSection.style.display = 'none';
            }
            renderPlanTable();
        } else {
            // Empty selection - clear developer session
            isDev = false;
            localStorage.removeItem('isDevLoggedIn');
            
            document.getElementById("devPassword").style.display = "none";
            document.getElementById("devLoginBtn").style.display = "none";
            document.getElementById("devLogoutBtn").style.display = "none";
            document.getElementById("devSection").style.display = "none";
            // Keep system services visible (showing only reports for inspectors)
            document.getElementById("systemServicesContainer").style.display = "block";
            // Hide file library button
            const fileLibraryBtn = document.getElementById("fileLibraryBtn");
            if (fileLibraryBtn) {
                fileLibraryBtn.style.display = "none";
            }
            // Hide file library section if open
            const fileSection = document.getElementById('fileManagementSection');
            if (fileSection) {
                fileSection.style.display = 'none';
            }
            renderPlanTable();
        }
    });
});
document.getElementById("devLoginBtn").onclick = async function() {
    let pw = document.getElementById("devPassword").value.trim();
    if (pw === DEV_PASSWORD) {
        isDev = true;
        // Save developer login state to persist across page reloads
        localStorage.setItem('isDevLoggedIn', 'true');
        
        // ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
        if (!localStorage.getItem("devToken")) {
            const defaultToken = "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";
            localStorage.setItem("devToken", defaultToken);
        }
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ŸàŸÉŸÜ
        const token = localStorage.getItem("devToken");
        if (token) {
            try {
                const testResponse = await fetch('https://api.github.com/repos/aliabdelaal-adm/Monthly_inspection_plan', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!testResponse.ok && (testResponse.status === 401 || testResponse.status === 403)) {
                    // Token is invalid
                    alert('‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿ≠ÿßŸÑŸä ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ÿ£Ÿà ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©!\n\n' +
                          'üîë ŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ GitHubÿå ÿ≥ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ:\n' +
                          '1. ÿßŸÑÿ∞Ÿáÿßÿ® ÿ•ŸÑŸâ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ (ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™)\n' +
                          '2. ÿ•ÿØÿÆÿßŸÑ ÿ™ŸàŸÉŸÜ GitHub ÿ¨ÿØŸäÿØ\n' +
                          '3. ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸàŸÉŸÜ\n\n' +
                          'üí° ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ŸÅŸä ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇÿå ŸÑŸÉŸÜ ŸÑŸÜ ÿ™ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿπŸÑŸâ GitHub ÿ≠ÿ™Ÿâ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸàŸÉŸÜ.');
                }
            } catch (e) {
                console.log('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ŸàŸÉŸÜ:', e);
            }
        }
        
        // Try to update last update date if function is available
        if (typeof setLastUpdateDate === 'function') {
            try {
                setLastUpdateDate();
            } catch (e) {
                console.log('setLastUpdateDate error:', e);
            }
        }
        document.getElementById("devSection").style.display = "block";
        document.getElementById("devLogoutBtn").style.display = "inline-block";
        document.getElementById("devPassword").style.display = "none";
        document.getElementById("devLoginBtn").style.display = "none";
        document.getElementById("devError").innerText = "";
        // Show system services for developer
        document.getElementById("systemServicesContainer").style.display = "block";
        console.log('üìä PR#317: Developer logged in - showing all System Services');
        
        // Show all categories including developer-only categories
        const developerCategories = document.querySelectorAll('.developer-only-category');
        console.log(`üìä PR#317: Found ${developerCategories.length} developer-only categories to show`);
        developerCategories.forEach(cat => {
            cat.style.display = 'contents';
            console.log('üìä PR#317: Shown category:', cat.id);
        });
        
        // Show file library button for developer
        const fileLibraryBtn = document.getElementById("fileLibraryBtn");
        if (fileLibraryBtn) {
            fileLibraryBtn.style.display = "inline-flex";
        }
        fillInspectorsDropdowns();
        renderPlanTable();
        // Force table refresh to show edit/delete buttons
        setTimeout(function() { renderPlanTable(); }, 100);
        
        // ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸÅÿ™Ÿàÿ≠ÿ© ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± ŸàÿßŸÑÿ≠ÿ∞ŸÅ
        const fileSectionLogin = document.getElementById('fileManagementSection');
        if (fileSectionLogin && fileSectionLogin.style.display === 'block') {
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÖÿπ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ≠ÿßŸÑŸä
            const currentCategory = getCurrentFileCategory();
            setTimeout(function() { 
                loadPublicFiles(currentCategory);
                // ÿ•ÿ∏Ÿáÿßÿ± ŸÇÿ≥ŸÖ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÑŸÑŸÖÿ∑Ÿàÿ±
                const uploadSection = document.getElementById('developerFileUploadSection');
                if (uploadSection) {
                    uploadSection.style.display = 'block';
                }
            }, 150);
        }
        
        // Update maintenance close button visibility for developer
        updateMaintenanceCloseButton();
        
        // Hide maintenance overlay for developer if it's showing
        const overlay = document.getElementById('maintenanceOverlay');
        if (overlay && overlay.style.display === 'flex') {
            hideMaintenanceMode();
            console.log('‚úÖ Developer logged in - maintenance overlay hidden automatically');
        }
        
        console.log('‚úÖ Developer logged in - maintenance close button now visible');
    } else {
        document.getElementById("devError").innerText = "ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©!";
    }
}
document.getElementById("devLogoutBtn").onclick = async function() {
    isDev = false;
    // Remove developer login state from localStorage
    localStorage.removeItem('isDevLoggedIn');
    document.getElementById("devSection").style.display = "none";
    document.getElementById("devLogoutBtn").style.display = "none";
    document.getElementById("devPassword").style.display = "none";
    document.getElementById("devLoginBtn").style.display = "none";
    document.getElementById("loginRole").value = "";
    document.getElementById("devError").innerText = "";
    // Keep system services visible when developer logs out (inspectors can still see reports)
    document.getElementById("systemServicesContainer").style.display = "block";
    // Hide developer-only categories
    const developerCategories = document.querySelectorAll('.developer-only-category');
    developerCategories.forEach(cat => {
        cat.style.display = 'none';
    });
    // Hide file library button when developer logs out
    const fileLibraryBtn = document.getElementById("fileLibraryBtn");
    if (fileLibraryBtn) {
        fileLibraryBtn.style.display = "none";
    }
    // Hide file library section if open
    const fileSection = document.getElementById('fileManagementSection');
    if (fileSection) {
        fileSection.style.display = 'none';
    }
    renderPlanTable();
    
    // ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸÅÿ™Ÿàÿ≠ÿ© ŸÑÿ•ÿÆŸÅÿßÿ° ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± ŸàÿßŸÑÿ≠ÿ∞ŸÅ
    const fileSectionLogout = document.getElementById('fileManagementSection');
    if (fileSectionLogout && fileSectionLogout.style.display === 'block') {
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÖÿπ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ≠ÿßŸÑŸä
        const currentCategory = getCurrentFileCategory();
        setTimeout(function() { 
            loadPublicFiles(currentCategory);
            // ÿ•ÿÆŸÅÿßÿ° ŸÇÿ≥ŸÖ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™
            const uploadSection = document.getElementById('developerFileUploadSection');
            if (uploadSection) {
                uploadSection.style.display = 'none';
            }
        }, 150);
    }
    
    // Update maintenance close button visibility
    updateMaintenanceCloseButton();
    
    // Show maintenance overlay if maintenance mode is active (check GitHub status)
    const maintenanceStatus = localStorage.getItem('systemMaintenanceMode') === 'true';
    if (maintenanceStatus) {
        await checkMaintenanceMode();
        console.log('üö™ Developer logged out - maintenance overlay shown for non-developer');
    }
    
    console.log('üö™ Developer logged out - maintenance close button hidden');
};

// ŸÅÿ≠ÿµ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÖÿπ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ™Ÿàÿ∂Ÿäÿ≠Ÿäÿ© ŸÖÿ≠ÿ≥ŸÜÿ©
function checkDeveloperAccess(featureName, successCallback) {
    if (isDev || window.isDev) {
        if (typeof successCallback === 'function') {
            successCallback();
        }
        return true;
    }
    
    const messages = {
        'shop-management': 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™',
        'vacation-tracking': 'ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™',
        'schedule-management': 'ÿ•ÿØÿßÿ±ÿ© ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™',
        'smart-rotation': 'ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ∞ŸÉŸä',
        'data-export': 'ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™',
        'file-upload': 'ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™'
    };
    
    const feature = messages[featureName] || featureName;
    
    // Special message for shop management to provide clear instructions
    if (featureName === 'shop-management') {
        const message = `
            üîí ÿ™ÿ≠ÿ±Ÿäÿ± ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ Ÿäÿ™ÿ∑ŸÑÿ® ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ±
            
            ÿßŸÑŸÖŸäÿ≤ÿ©: ${feature}
            
            üìù ÿÆÿ∑Ÿàÿßÿ™ ÿßŸÑŸàÿµŸàŸÑ ŸÑÿ™ÿ≠ÿ±Ÿäÿ± ÿßŸÑŸÖÿ≠ŸÑÿßÿ™:
            
            1Ô∏è‚É£ ŸÅŸä ÿ£ÿπŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ©ÿå ÿßÿÆÿ™ÿ± "ÿßŸÑŸÖÿ∑Ÿàÿ±" ŸÖŸÜ ŸÇÿßÿ¶ŸÖÿ© "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ"
            2Ô∏è‚É£ ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿßŸÑŸÖÿ∑Ÿàÿ±
            3Ô∏è‚É£ ÿßŸÜŸÇÿ± ÿπŸÑŸâ "ÿØÿÆŸàŸÑ"
            4Ô∏è‚É£ ÿßŸÑÿ¢ŸÜ ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ≠ÿ±Ÿäÿ± Ÿàÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ‚úÖ
            
            üí° ÿ®ÿπÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÉŸÖÿ∑Ÿàÿ±ÿå ÿ≥ÿ™ÿ∏Ÿáÿ± ÿÆŸäÿßÿ±ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©:
            ‚Ä¢ ÿ™ÿ≠ÿ±Ÿäÿ± ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
            ‚Ä¢ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
            ‚Ä¢ ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑÿßÿ™ ÿ¨ÿØŸäÿØÿ©
            ‚Ä¢ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            
            üîç ŸÖÿ≥ŸÖŸàÿ≠ ŸÑŸÑÿ¨ŸÖŸäÿπ: ÿπÿ±ÿ∂ ŸÇŸàÿßÿ¶ŸÖ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸàÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±
            ‚úèÔ∏è ŸÖŸÇÿ™ÿµÿ± ÿπŸÑŸâ ÿßŸÑŸÖÿ∑Ÿàÿ±: ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± ŸàÿßŸÑÿ≠ÿ∞ŸÅ ŸàÿßŸÑÿ•ÿ∂ÿßŸÅÿ©
            
            ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ™ŸÅŸáŸÖŸÉ üôè
        `;
        
        alert(message);
        return false;
    }
    
    const message = `
        üîí ÿπÿ∞ÿ±ÿßŸãÿå Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÖÿÆÿµÿµ ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑
        
        ÿßŸÑŸÖŸäÿ≤ÿ©: ${feature}
        
        üìã ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ±:
        1. ÿßÿÆÿ™ÿ± "ÿßŸÑŸÖÿ∑Ÿàÿ±" ŸÖŸÜ ŸÇÿßÿ¶ŸÖÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ÿπŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ©
        2. ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿßŸÑŸÖÿ∑Ÿàÿ±
        3. ÿßŸÜŸÇÿ± "ÿØÿÆŸàŸÑ"
        
        ‚ú® ÿ≥ÿ™ÿ≠ÿµŸÑ ÿ®ÿπÿØŸáÿß ÿπŸÑŸâ ÿ•ŸÖŸÉÿßŸÜŸäÿ© ÿßŸÑŸàÿµŸàŸÑ ÿßŸÑŸÉÿßŸÖŸÑ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸäÿ≤ÿßÿ™!
    `;
    
    alert(message);
    return false;
}

// ÿßŸÑÿ™ÿ∫ŸäŸäÿ± ÿπŸÑŸâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥
document.getElementById('inspectorSelect').addEventListener('change', function() {
    selectedInspector = this.value;
    renderPlanTable();
    document.getElementById('inspectorReportDiv').style.display = "none";
    
    // Show/hide inspector details button based on selection
    const detailsBtn = document.getElementById('viewInspectorDetailsBtn');
    if (selectedInspector && selectedInspector !== '') {
        detailsBtn.style.display = 'inline-block';
    } else {
        detailsBtn.style.display = 'none';
    }
});

function viewSelectedInspectorDetails() {
    const inspectorName = selectedInspector;
    if (!inspectorName || inspectorName === '') {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÅÿ™ÿ¥ ÿ£ŸàŸÑÿßŸã');
        return;
    }
    showInspectorDetailsModal(inspectorName);
}

document.getElementById("addEditForm").addEventListener("submit", function(e){
    e.preventDefault();
    if (!isDev) return;
    
    // Get inspector (from dropdown or new input)
    let inspector = document.getElementById("formInspector").value;
    const newInspectorInput = document.getElementById("newInspectorInput");
    if (newInspectorInput.style.display !== 'none' && newInspectorInput.value.trim()) {
        inspector = newInspectorInput.value.trim();
    }
    
    let day = document.getElementById("formDay").value;
    let shift = document.getElementById("formShift").value;
    
    // Get area (from dropdown or new input)
    let area = document.getElementById("formArea").value;
    const newAreaInput = document.getElementById("newAreaInput");
    if (newAreaInput.style.display !== 'none' && newAreaInput.value.trim()) {
        area = newAreaInput.value.trim();
    } else if (area) {
        // Convert area ID to area name (dropdown uses IDs as values)
        const areaObj = areasData.find(a => a.id === area);
        if (areaObj) {
            area = areaObj.name;
        }
    }
    
    // Get selected shops from multi-select
    const shopsSelect = document.getElementById("formShops");
    let shops = Array.from(shopsSelect.selectedOptions).map(option => option.value);
    
    let editingIdx = document.getElementById("formEditingIndex").value;

    if(!inspector || !day || !shift || !area || shops.length === 0) {
        alert("Ÿäÿ±ÿ¨Ÿâ ÿ™ÿπÿ®ÿ¶ÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ!");
        return;
    }
    
    // If new inspector, add to inspectorsData
    if (!inspectorsData.find(insp => insp.name === inspector)) {
        const newId = 'insp_' + Date.now();
        inspectorsData.push({id: newId, name: inspector});
        inspectors = inspectorsData.map(i => i.name);
        fillInspectorsDropdowns();
    }
    
    // Check if area exists - do NOT auto-create new areas
    // Areas must be added through the area management panel only
    if (!areasData.find(ar => ar.name === area)) {
        alert("ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©. Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÖŸÜ ÿÆŸÑÿßŸÑ ŸÑŸàÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿ£ŸàŸÑÿßŸã.\n\nArea does not exist. Please add the area through the area management panel first.");
        return;
    }
    
    let newPlan = {inspector, day, shift, area, shops};
    
    // Create a temporary copy of inspectionData to validate
    let tempInspectionData = [...inspectionData];
    if(editingIdx==="") {
        tempInspectionData.push(newPlan);
    } else {
        tempInspectionData[editingIdx] = newPlan;
    }
    
    // Validate for duplicate shops on the same day
    // Only check for duplicates on the specific day being added/edited
    const validation = validateShopDuplicates(tempInspectionData, [day]);
    
    if (!validation.isValid) {
        // Show detailed error message with duplicate information
        showDuplicateShopsError(validation.duplicates);
        return; // Prevent saving
    }
    
    // If validation passed, save the data
    if(editingIdx==="") {
        inspectionData.push(newPlan);
    } else {
        inspectionData[editingIdx] = newPlan;
    }
    saveInspectionData();
    renderPlanTable();
    this.reset();
    document.getElementById("formEditingIndex").value = "";
    
    // Reset toggle states
    resetFormToggles();
});

// --- ÿßŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑÿ™ÿµŸÅŸäÿ© ---
let currentSearchFilters = {};

function applySearchFilters() {
    const fromDate = document.getElementById('searchFromDate').value;
    const toDate = document.getElementById('searchToDate').value;
    const area = document.getElementById('searchArea').value;
    const shift = document.getElementById('searchShift').value;
    
    currentSearchFilters = {
        fromDate: fromDate || null,
        toDate: toDate || null,
        area: area || null,
        shift: shift || null
    };
    
    renderPlanTable();
}

function clearSearchFilters() {
    document.getElementById('searchFromDate').value = '';
    document.getElementById('searchToDate').value = '';
    document.getElementById('searchArea').value = '';
    document.getElementById('searchShift').value = '';
    
    currentSearchFilters = {};
    
    // Hide search results info
    document.getElementById('searchResultsInfo').style.display = 'none';
    
    renderPlanTable();
}

function filterInspectionData(data) {
    if (!currentSearchFilters || Object.keys(currentSearchFilters).length === 0) {
        return data;
    }
    
    return data.filter(item => {
        // Filter by date range
        if (currentSearchFilters.fromDate && item.day < currentSearchFilters.fromDate) {
            return false;
        }
        if (currentSearchFilters.toDate && item.day > currentSearchFilters.toDate) {
            return false;
        }
        
        // Filter by area (compare area names, converting IDs if necessary)
        if (currentSearchFilters.area) {
            const itemAreaName = getAreaName(item.area);
            const filterAreaName = getAreaName(currentSearchFilters.area);
            if (itemAreaName !== filterAreaName) {
                return false;
            }
        }
        
        // Filter by shift
        if (currentSearchFilters.shift && item.shift !== currentSearchFilters.shift) {
            return false;
        }
        
        return true;
    });
}

// --- ÿπÿ±ÿ∂ ÿ¨ÿØŸàŸÑ ÿßŸÑÿÆÿ∑ÿ∑ ŸÖÿπ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± ---
function renderPlanTable() {
    const container = document.getElementById('planTableContainer');
    let rows = inspectionData;
    
    // ÿ•ÿ∞ÿß ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÅÿ™ÿ¥ ŸÖÿπŸäŸëŸÜ
    if(selectedInspector) {
        rows = inspectionData.filter(item => item.inspector === selectedInspector);
    }
    
    // ÿ™ÿ∑ÿ®ŸäŸÇ ŸÅŸÑÿ™ÿ± ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ≠ÿßŸÑŸä ŸÉÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä (ÿ•ŸÑÿß ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿäÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ®ÿ≠ÿ´)
    const hasActiveSearchFilters = Object.keys(currentSearchFilters).length > 0 && 
        (currentSearchFilters.fromDate || currentSearchFilters.toDate || 
         currentSearchFilters.area || currentSearchFilters.shift);
    
    if (!hasActiveSearchFilters) {
        const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD format in local timezone
        
        if (selectedInspector) {
            // ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÅÿ™ÿ¥: ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÖŸÜ ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ≠ÿßŸÑŸä ŸÅÿµÿßÿπÿØÿßŸã
            rows = rows.filter(item => item.day >= today);
        } else {
            // ÿ®ÿØŸàŸÜ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÅÿ™ÿ¥: ÿπÿ±ÿ∂ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ≠ÿßŸÑŸä ŸÅŸÇÿ∑
            rows = rows.filter(item => item.day === today);
        }
    }
    
    // Apply search filters
    rows = filterInspectionData(rows);
    
    // Update search results info
    const searchResultsInfo = document.getElementById('searchResultsInfo');
    const searchResultsCount = document.getElementById('searchResultsCount');
    if (hasActiveSearchFilters) {
        searchResultsInfo.style.display = 'block';
        searchResultsCount.textContent = rows.length;
    } else {
        // ÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™
        if (rows.length > 0) {
            searchResultsInfo.style.display = 'block';
            const today = new Date().toLocaleDateString('ar-EG');
            if (selectedInspector) {
                // ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÅÿ™ÿ¥: ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÇÿßÿØŸÖÿ©
                searchResultsInfo.innerHTML = `<strong>ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ${selectedInspector} ÿßŸÑŸÇÿßÿØŸÖÿ©:</strong> <span id="searchResultsCount">${rows.length}</span> ÿ™ŸÅÿ™Ÿäÿ¥`;
            } else {
                // ÿ®ÿØŸàŸÜ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÅÿ™ÿ¥: ÿπÿ±ÿ∂ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸäŸàŸÖ ŸÅŸÇÿ∑
                searchResultsInfo.innerHTML = `<strong>ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸäŸàŸÖ (${today}):</strong> <span id="searchResultsCount">${rows.length}</span> ÿ™ŸÅÿ™Ÿäÿ¥`;
            }
        } else {
            searchResultsInfo.style.display = 'none';
        }
    }
    
    if (rows.length === 0) {
        if (hasActiveSearchFilters) {
            container.innerHTML = '<div style="text-align:center;color:#c00;font-weight:bold;margin:30px 0;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÑŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ≠ÿØÿØ.</div>';
        } else if (selectedInspector) {
            container.innerHTML = `<div style="text-align:center;color:#666;font-weight:bold;margin:30px 0;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÇÿßÿØŸÖÿ© ŸÑŸÑŸÖŸÅÿ™ÿ¥ ${selectedInspector}</div>`;
        } else {
            container.innerHTML = '<div style="text-align:center;color:#666;font-weight:bold;margin:30px 0;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÑŸÑŸäŸàŸÖ ÿßŸÑÿ≠ÿßŸÑŸä.<br><small style="font-weight:normal;">ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ®ÿ≠ÿ´ ŸÑŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ÿ£Ÿà ÿßÿÆÿ™ÿ± ŸÖŸÅÿ™ÿ¥ÿßŸã ŸÑÿπÿ±ÿ∂ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™Ÿá ÿßŸÑŸÇÿßÿØŸÖÿ©</small></div>';
        }
        return;
    }
    // Sort by inspector name if requested
    if (window.sortByInspector === true) {
        rows = rows.sort((a, b) => a.inspector.localeCompare(b.inspector));
    } else if (window.sortByInspector === false) {
        rows = rows.sort((a, b) => b.inspector.localeCompare(a.inspector));
    }
    
    let html = `
    <table class="plan-table" id="inspectorPlanTable">
        <thead>
            <tr>
                <th style="cursor:pointer;" onclick="toggleInspectorSort()">ÿßŸÑŸÖŸÅÿ™ÿ¥ ${window.sortByInspector === true ? '‚Üë' : window.sortByInspector === false ? '‚Üì' : ''}</th>
                <th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                <th>ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©</th>
                <th>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                <th>ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</th>
                ${isDev?'<th>ÿ™ÿπÿØŸäŸÑ/ÿ≠ÿ∞ŸÅ</th>':''}
            </tr>
        </thead>
        <tbody>
    `;
    rows.forEach((row, idx) => {
        let realIdx = inspectionData.indexOf(row);
        let shopsDisplay = row.shops && row.shops.length > 0 ? 
            `<div class="shops-dropdown-wrap">
                <button class="show-shops-btn" 
                    onclick="toggleShopsDropdown('${realIdx}')" 
                    onmousedown="startLongPress('${realIdx}')" 
                    onmouseup="endLongPress()" 
                    onmouseleave="endLongPress()"
                    ontouchstart="startLongPress('${realIdx}')" 
                    ontouchend="endLongPress()"
                    style="background:#007bff;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:0.9em;">
                    ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ (${row.shops.length})
                </button>
                <div class="shops-dropdown-list" id="shops-dropdown-${realIdx}">
                    <div class="shops-dropdown-header">
                        <span class="shops-count-badge">${row.shops.length}</span>
                        ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß
                    </div>
                    <ul>
                        ${row.shops.slice().sort().map((shop, index) => `<li title="ŸÖÿ≠ŸÑ ÿ±ŸÇŸÖ ${index + 1}">${shop}</li>`).join('')}
                    </ul>
                </div>
            </div>` : 
            '<span style="color:#666;font-style:italic;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™</span>';
        
        html += `
            <tr style="border-bottom:1px solid #e0e6f0;">
                <td style="padding:12px 8px;color:#234085;background:#f8faff;">
                    <span class="inspector-name-link" onclick="showInspectorDetailsModal('${row.inspector}')" style="cursor:pointer;text-decoration:underline;color:#234085;font-weight:600;" title="ÿßŸÜŸÇÿ± ŸÑÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿ™ŸÅÿßÿµŸäŸÑ Ÿàÿ™ŸÇÿßÿ±Ÿäÿ± ${row.inspector}">
                        ${row.inspector}
                    </span>
                </td>
                <td style="padding:12px 8px;text-align:center;font-family:monospace;background:#fff;">
                    <div style="line-height:1.4;">
                        <div style="font-weight:normal;">${row.day}</div>
                        <div style="font-size:0.85em;color:#666;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;font-weight:normal;">${getArabicDayName(row.day)}</div>
                    </div>
                </td>
                <td style="padding:12px 8px;text-align:center;background:#f8faff;">
                    <span style="display:inline-block;vertical-align:middle;background:${row.shift === 'ÿµÿ®ÿßÿ≠Ÿäÿ©' ? '#e8f5e8' : '#fff3e0'};color:${row.shift === 'ÿµÿ®ÿßÿ≠Ÿäÿ©' ? '#2e7d32' : '#ef6c00'};padding:4px 8px;border-radius:12px;font-size:0.9em;border:1px solid ${row.shift === 'ÿµÿ®ÿßÿ≠Ÿäÿ©' ? '#c8e6c9' : '#ffcc02'};">
                        ${row.shift}
                    </span>
                </td>
                <td style="padding:12px 8px;font-weight:500;color:${getAreaName(row.area) === 'ÿ≥ŸàŸÇ ÿßŸÑŸÖŸäŸÜÿßÿ°' || getAreaName(row.area) === 'ÿ≥ŸàŸÇ ÿßŸÑÿ™ÿ±ÿßÿ´' ? '#1976d2' : '#d32f2f'};background:#fff;">${getAreaName(row.area)}</td>
                <td style="padding:12px 8px;background:#f8faff;max-width:300px;">${shopsDisplay}</td>
                ${isDev?`
                <td style="padding:8px;text-align:center;background:#fff;">
                    <button class="edit-btn" onclick="editPlan(${realIdx})" style="margin:2px;">ÿ™ÿπÿØŸäŸÑ</button>
                    <button class="delete-btn" onclick="deletePlan(${realIdx})" style="margin:2px;">ÿ≠ÿ∞ŸÅ</button>
                </td>
                `:``}
            </tr>
        `;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
}

function toggleInspectorSort() {
    if (window.sortByInspector === undefined || window.sortByInspector === false) {
        window.sortByInspector = true; // Ascending
    } else if (window.sortByInspector === true) {
        window.sortByInspector = false; // Descending
    } else {
        window.sortByInspector = undefined; // No sort
    }
    renderPlanTable(); // Re-render the table with new sorting
}

function editPlan(idx) {
    if (!isDev) return;
    let plan = inspectionData[idx];
    
    // Reset toggles to show dropdowns
    resetFormToggles();
    
    // Set inspector
    document.getElementById("formInspector").value = plan.inspector;
    document.getElementById("formDay").value = plan.day;
    document.getElementById("formShift").value = plan.shift;
    
    // Set area and update shops accordingly
    // Convert area name to area ID (dropdown uses IDs as values)
    const areaObj = areasData.find(a => a.name === plan.area);
    document.getElementById("formArea").value = areaObj ? areaObj.id : plan.area;
    // Always show all shops regardless of area selection
    fillShopsDropdowns();
    
    // Set selected shops in custom dropdown and hidden select
    setTimeout(() => {
        // Clear current selections
        customSelectedShops = [];
        
        // Set shops from plan
        customSelectedShops = [...plan.shops];
        
        // Update visual state in custom dropdown
        const options = document.querySelectorAll('.custom-shops-option');
        options.forEach(option => {
            const shopName = option.dataset.value;
            if (customSelectedShops.includes(shopName)) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
        });
        
        // Sync to hidden select
        syncCustomSelectionToHiddenSelect();
        
        // Update counter and trigger text
        updateSelectedShopsCount();
        updateCustomTriggerText();
    }, 100);
    
    document.getElementById("formEditingIndex").value = idx;
    window.scrollTo({top:0,behavior:'smooth'});
}
function deletePlan(idx) {
    if (!isDev) return;
    if(!confirm("ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿÆÿ∑ÿ© ŸÜŸáÿßÿ¶ŸäÿßŸãÿü")) return;
    inspectionData.splice(idx,1);
    saveInspectionData();
    renderPlanTable();
}

// --- Ÿàÿ∏ŸäŸÅÿ© ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ© - ŸÖÿ≠ÿØÿ´ÿ© ---
function toggleShopsDropdown(rowIndex) {
    const dropdownId = `shops-dropdown-${rowIndex}`;
    const dropdown = document.getElementById(dropdownId);
    const button = document.querySelector(`button[onclick="toggleShopsDropdown('${rowIndex}')"]`);
    
    if (!dropdown || !button) return;
    
    // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ© ÿßŸÑÿ£ÿÆÿ±Ÿâ Ÿàÿ•ÿπÿßÿØÿ™Ÿáÿß ŸÑŸÖŸÉÿßŸÜŸáÿß ÿßŸÑÿ£ÿµŸÑŸä
    document.querySelectorAll('.shops-dropdown-list').forEach(el => {
        if (el.id !== dropdownId) {
            el.style.display = 'none';
            el.removeAttribute('data-open');
            // ÿ•ÿπÿßÿØÿ© ÿßŸÑÿπŸÜÿµÿ± ŸÑŸÖŸÉÿßŸÜŸá ÿßŸÑÿ£ÿµŸÑŸä ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸÜŸÇŸàŸÑÿßŸã
            const originalParent = el.getAttribute('data-original-parent');
            if (originalParent) {
                const parent = document.querySelector(`[data-dropdown-parent="${el.id}"]`);
                if (parent) {
                    parent.appendChild(el);
                    el.removeAttribute('data-original-parent');
                }
            }
        }
    });
    
    // ÿ™ÿ®ÿØŸäŸÑ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
    if (dropdown.style.display === 'none' || dropdown.style.display === '') {
        // ŸÜŸÇŸÑ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ© ÿ•ŸÑŸâ body ŸÑÿ∂ŸÖÿßŸÜ ÿπÿ±ÿ∂Ÿáÿß ŸÉoverlay
        if (!dropdown.getAttribute('data-original-parent')) {
            dropdown.setAttribute('data-original-parent', 'true');
            dropdown.parentElement.setAttribute('data-dropdown-parent', dropdownId);
            document.body.appendChild(dropdown);
        }
        
        // ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÖŸàŸÇÿπ ÿßŸÑÿ≤ÿ± ŸÑŸàÿ∂ÿπ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ©
        const buttonRect = button.getBoundingClientRect();
        dropdown.style.position = 'fixed';
        dropdown.style.zIndex = '9999';
        dropdown.style.display = 'block';
        
        // ÿ≠ÿ≥ÿßÿ® ŸÖŸàŸÇÿπ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ© - ŸÜÿπÿ±ÿ∂Ÿáÿß ÿØÿßÿ¶ŸÖÿßŸã ÿ£ÿ≥ŸÅŸÑ ÿßŸÑÿ≤ÿ±
        const viewportHeight = window.innerHeight;
        const dropdownMaxHeight = 280; // ŸÖŸÜ CSS max-height ÿßŸÑŸÖÿ≠ÿØÿ´
        const spaceBelow = viewportHeight - buttonRect.bottom;
        
        // ŸÖŸàŸÇÿπ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ£ÿ≥ŸÅŸÑ ÿßŸÑÿ≤ÿ± ŸÖÿ®ÿßÿ¥ÿ±ÿ©
        let topPosition = buttonRect.bottom + 5;
        
        // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÑŸÜ ÿ™ÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØŸàÿØ ÿßŸÑÿ¥ÿßÿ¥ÿ©
        if (topPosition + dropdownMaxHeight > viewportHeight) {
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ≥ÿ™ÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑÿ¥ÿßÿ¥ÿ©ÿå ŸÜÿ∂ÿπŸáÿß ÿ£ÿπŸÑŸâ ÿßŸÑÿ≤ÿ±
            topPosition = Math.max(10, buttonRect.top - dropdownMaxHeight - 5);
        }
        
        dropdown.style.top = `${topPosition}px`;
        
        // ÿ™ÿ≠ÿØŸäÿØ ÿ£ŸÇÿµŸâ ÿßÿ±ÿ™ŸÅÿßÿπ ŸÑŸÑŸÇÿßÿ¶ŸÖÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ≥ÿßÿ≠ÿ© ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©
        const availableHeight = Math.min(dropdownMaxHeight, viewportHeight - topPosition - 20);
        dropdown.style.maxHeight = `${availableHeight}px`;
        
        // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ£ŸÅŸÇŸä ŸÖÿπ ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿπÿØŸÖ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑÿ¥ÿßÿ¥ÿ©
        const viewportWidth = window.innerWidth;
        const dropdownWidth = 350; // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ™ŸàŸÇÿπ
        let leftPosition = buttonRect.left;
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ ÿÆÿ±Ÿàÿ¨ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÖŸÜ ÿßŸÑÿ¨ÿßŸÜÿ® ÿßŸÑÿ£ŸäŸÖŸÜ
        if (leftPosition + dropdownWidth > viewportWidth) {
            leftPosition = viewportWidth - dropdownWidth - 10;
        }
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ ÿÆÿ±Ÿàÿ¨ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÖŸÜ ÿßŸÑÿ¨ÿßŸÜÿ® ÿßŸÑÿ£Ÿäÿ≥ÿ±
        if (leftPosition < 10) {
            leftPosition = 10;
        }
        
        dropdown.style.left = `${leftPosition}px`;
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ£ÿÆŸäÿ± ŸÇÿµŸäÿ± ŸÑÿ∂ŸÖÿßŸÜ ÿπÿØŸÖ ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±
        setTimeout(() => {
            dropdown.setAttribute('data-open', 'true');
        }, 10);
    } else {
        dropdown.style.display = 'none';
        dropdown.removeAttribute('data-open');
        
        // ÿ•ÿπÿßÿØÿ© ÿßŸÑÿπŸÜÿµÿ± ŸÑŸÖŸÉÿßŸÜŸá ÿßŸÑÿ£ÿµŸÑŸä
        const originalParent = dropdown.getAttribute('data-original-parent');
        if (originalParent) {
            const parent = document.querySelector(`[data-dropdown-parent="${dropdownId}"]`);
            if (parent) {
                parent.appendChild(dropdown);
                dropdown.removeAttribute('data-original-parent');
                parent.removeAttribute('data-dropdown-parent');
            }
        }
    }
}

// --- ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ© ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß - ŸÖÿ≠ÿØÿ´ÿ© ---
document.addEventListener('click', function(e){
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÜŸÇÿ± ŸÑŸäÿ≥ ÿØÿßÿÆŸÑ ÿ£Ÿä ŸÖŸÜ ÿπŸÜÿßÿµÿ± ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
    const isClickInsideShopsDropdown = e.target.closest('.shops-dropdown-wrap');
    const isClickOnShopsButton = e.target.classList.contains('show-shops-btn') || e.target.closest('.show-shops-btn');
    const isClickInsideDropdownList = e.target.closest('.shops-dropdown-list');
    
    // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ÿßŸÑŸÜŸÇÿ± ÿØÿßÿÆŸÑ ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ£Ÿà ÿπŸÑŸâ ÿßŸÑÿ≤ÿ± ÿ£Ÿà ÿØÿßÿÆŸÑ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©ÿå ÿ£ÿÆŸÅŸê ÿ¨ŸÖŸäÿπ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ
    if (!isClickInsideShopsDropdown && !isClickOnShopsButton && !isClickInsideDropdownList) {
        document.querySelectorAll('.shops-dropdown-list').forEach(el => {
            // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÖŸÅÿ™Ÿàÿ≠ÿ© ŸÇÿ®ŸÑ ÿ•ÿ∫ŸÑÿßŸÇŸáÿß
            if (el.getAttribute('data-open') === 'true') {
                el.style.display = 'none';
                el.removeAttribute('data-open');
                
                // ÿ•ÿπÿßÿØÿ© ÿßŸÑÿπŸÜÿµÿ± ŸÑŸÖŸÉÿßŸÜŸá ÿßŸÑÿ£ÿµŸÑŸä
                const originalParent = el.getAttribute('data-original-parent');
                if (originalParent) {
                    const parent = document.querySelector(`[data-dropdown-parent="${el.id}"]`);
                    if (parent) {
                        parent.appendChild(el);
                        el.removeAttribute('data-original-parent');
                        parent.removeAttribute('data-dropdown-parent');
                    }
                }
            }
        });
    }
    
    // ŸÖŸÜÿπ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ© ŸÜŸÅÿ≥Ÿáÿß ŸÖŸÜ ÿ•ÿ∫ŸÑÿßŸÇŸáÿß
    if (e.target.closest('.shops-dropdown-list') && !isClickOnShopsButton) {
        e.stopPropagation();
    }
});

// --- ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖÿ∑ŸàŸÑ ---
let longPressTimer = null;
let isLongPressActive = false;
let currentRowIndex = null;

// --- Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖÿ∑ŸàŸÑ ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™ ---
function startLongPress(rowIndex) {
    isLongPressActive = false;
    currentRowIndex = rowIndex;
    
    longPressTimer = setTimeout(function() {
        isLongPressActive = true;
        showShopDetailsModal(rowIndex);
    }, 800); // 800ms ŸÑŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖÿ∑ŸàŸÑ
}

function endLongPress() {
    if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
    }
    
    // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ®ÿπÿØ ŸÅÿ™ÿ±ÿ© ŸÇÿµŸäÿ±ÿ© ŸÑŸÑÿ≥ŸÖÿßÿ≠ ŸÑŸÑŸÜŸÇÿ± ÿßŸÑÿπÿßÿØŸä ÿ®ÿßŸÑÿπŸÖŸÑ
    setTimeout(function() {
        isLongPressActive = false;
        currentRowIndex = null;
    }, 100);
}

// --- ÿ™ÿπÿØŸäŸÑ Ÿàÿ∏ŸäŸÅÿ© toggleShopsDropdown ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ™ÿØÿßÿÆŸÑ ŸÖÿπ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖÿ∑ŸàŸÑ ---
const originalToggleShopsDropdown = toggleShopsDropdown;
toggleShopsDropdown = function(rowIndex) {
    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖÿ∑ŸàŸÑ ŸÜÿ¥ÿ∑ÿßŸãÿå ŸÑÿß ÿ™ŸÅÿπŸÑ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿπÿßÿØŸäÿ©
    if (isLongPressActive) {
        return;
    }
    
    // ÿ™ÿ£ÿÆŸäÿ± ŸÇÿµŸäÿ± ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿπÿØŸÖ ÿ™ÿØÿßÿÆŸÑ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖÿ∑ŸàŸÑ
    setTimeout(function() {
        if (!isLongPressActive) {
            originalToggleShopsDropdown(rowIndex);
        }
    }, 50);
};

// --- ÿπÿ±ÿ∂ ŸÖŸàÿØÿßŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ---
let currentShopEditData = null;
let isShopEditMode = false;

function showShopDetailsModal(rowIndex) {
    const row = inspectionData[rowIndex];
    if (!row || !row.shops || row.shops.length === 0) {
        return;
    }
    
    // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± - ŸÅŸÇÿ∑ ÿßŸÑŸÖÿ∑Ÿàÿ± ÿßŸÑŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑŸá ŸäŸÖŸÉŸÜŸá ÿ±ÿ§Ÿäÿ© ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ±
    const hasDevAccess = isDev || window.isDev;
    const editControls = document.getElementById('shopEditControls');
    editControls.style.display = hasDevAccess ? 'block' : 'none';
    
    const modal = document.getElementById('shopDetailsModal');
    const content = document.getElementById('shopDetailsContent');
    
    // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÑÿ™ÿπÿØŸäŸÑ
    currentShopEditData = {
        rowIndex: rowIndex,
        shops: row.shops.map(shopName => {
            const shopData = shopsData.find(shop => shop.name === shopName);
            return shopData ? {...shopData} : {name: shopName, id: null};
        })
    };
    
    renderShopDetails();
    modal.style.display = 'flex';
}

// ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿ™ÿ∑ÿ®Ÿäÿπ ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÑŸÖÿ∑ÿßÿ®ŸÇÿ© ÿßŸÑÿ£ŸÅÿ∂ŸÑ
function normalizeShopName(name) {
    if (!name) return "";
    let normalized = name;
    // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ®ÿßÿØÿ¶ÿßÿ™ ÿßŸÑÿ¥ÿßÿ¶ÿπÿ©
    normalized = normalized.replace(/^ŸÖÿ≠ŸÑ\s+/g, '');
    normalized = normalized.replace(/^ÿµÿßŸÑŸàŸÜ\s+/g, '');
    normalized = normalized.replace(/^ÿπŸäÿßÿØÿ©\s+/g, '');
    normalized = normalized.replace(/^ÿµŸäÿØŸÑŸäÿ©\s+/g, '');
    // ÿ™ÿ∑ÿ®Ÿäÿπ ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™
    normalized = normalized.replace(/\s+/g, ' ');
    normalized = normalized.trim();
    // ÿ™ÿ∑ÿ®Ÿäÿπ ÿ®ÿπÿ∂ ÿßŸÑÿ£ÿ≠ÿ±ŸÅ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
    normalized = normalized.replace(/ÿ£/g, 'ÿß');
    normalized = normalized.replace(/ÿ•/g, 'ÿß');
    normalized = normalized.replace(/ÿ¢/g, 'ÿß');
    normalized = normalized.replace(/ÿ©/g, 'Ÿá');
    // ÿ™ÿ∑ÿ®Ÿäÿπ "ŸÑŸÄ" variations (ŸÑÿ∑ŸäŸàÿ± vs ŸÑŸÑÿ∑ŸäŸàÿ±)
    normalized = normalized.replace(/\s+ŸÑÿ∑ŸäŸàÿ±/g, ' ŸÑŸÑÿ∑ŸäŸàÿ±');
    normalized = normalized.replace(/\s+ŸÑÿßÿ≥ŸÖÿßŸÉ/g, ' ŸÑŸÑÿßÿ≥ŸÖÿßŸÉ');
    normalized = normalized.replace(/\s+ŸÑÿ£ÿ≥ŸÖÿßŸÉ/g, ' ŸÑŸÑÿßÿ≥ŸÖÿßŸÉ');
    return normalized;
}

function renderShopDetails() {
    const content = document.getElementById('shopDetailsContent');
    let html = '';
    
    currentShopEditData.shops.forEach((shopData, index) => {
        // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ ŸÖŸÜ ŸÖŸÑŸÅ Excel ÿßŸÑŸÖÿ≥ÿ™ÿÆÿ±ÿ¨
        const shopName = shopData.name;
        let excelShopData = null;
        
        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≠ŸÑ ŸÅŸä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿ±ÿ¨ÿ© ŸÖŸÜ Excel
        // 1. ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿØŸÇŸäŸÇ
        if (shopsDetailsData && shopsDetailsData[shopName]) {
            excelShopData = shopsDetailsData[shopName];
        } 
        // 2. ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÖÿ∑ÿ®Ÿëÿπ (ÿ®ÿØŸàŸÜ ŸÖÿ≠ŸÑ/ÿµÿßŸÑŸàŸÜ/ÿπŸäÿßÿØÿ©)
        else {
            const normalizedShopName = normalizeShopName(shopName);
            
            for (const [key, value] of Object.entries(shopsDetailsData)) {
                const normalizedExcelName = normalizeShopName(key);
                
                // ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿØŸÇŸäŸÇÿ© ÿ®ÿπÿØ ÿßŸÑÿ™ÿ∑ÿ®Ÿäÿπ
                if (normalizedExcelName === normalizedShopName) {
                    excelShopData = value;
                    break;
                }
                // ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿ¨ÿ≤ÿ¶Ÿäÿ© (ÿ£ÿ≠ÿØŸáŸÖÿß Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿßŸÑÿ¢ÿÆÿ±)
                else if (normalizedExcelName.includes(normalizedShopName) || 
                         normalizedShopName.includes(normalizedExcelName)) {
                    excelShopData = value;
                    break;
                }
            }
        }
        
        const areaData = areasData.find(area => area.id === shopData.areaId);
        const areaName = areaData ? areaData.name : (excelShopData ? excelShopData.address : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ');
        
        // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Excel ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖÿ™ŸàŸÅÿ±ÿ©ÿå Ÿàÿ•ŸÑÿß ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿµŸÑŸäÿ©
        const nameAr = shopName;
        const nameEn = excelShopData ? excelShopData.nameEn : (shopData.nameEn || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ');
        const licenseNo = excelShopData ? excelShopData.licenseNo : (shopData.licenseNumber || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ');
        const locationMap = excelShopData ? excelShopData.locationMap : (shopData.googleMapsUrl || '');
        const admCode = excelShopData ? excelShopData.admCode : '';
        const contact = excelShopData ? excelShopData.contact : '';
        
        // ŸÖÿ≠ŸÑ ŸÑŸá ÿ™ŸÅÿßÿµŸäŸÑ (ÿ•ŸÖÿß ŸÖŸÜ Excel ÿ£Ÿà ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™)
        html += `
            <div class="shop-detail-card" data-shop-index="${index}">
                <div class="shop-detail-row">
                    <div class="shop-detail-label">
                        <span class="shop-icon">üè™</span>
                        ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©:
                    </div>
                    <div class="shop-detail-value arabic">
                        ${isShopEditMode ? 
                            `<input type="text" class="shop-edit-input arabic" 
                                    data-field="name" data-shop-index="${index}" 
                                    value="${nameAr}">` :
                            nameAr
                        }
                    </div>
                </div>
                <div class="shop-detail-row">
                    <div class="shop-detail-label">
                        <span class="shop-icon">üè¨</span>
                        ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©:
                    </div>
                    <div class="shop-detail-value">
                        ${isShopEditMode ? 
                            `<input type="text" class="shop-edit-input" 
                                    data-field="nameEn" data-shop-index="${index}" 
                                    value="${nameEn}" 
                                    placeholder="English name">` :
                            nameEn
                        }
                    </div>
                </div>
                <div class="shop-detail-row">
                    <div class="shop-detail-label">
                        <span class="shop-icon">üìã</span>
                        ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ±ÿÆŸäÿµ:
                    </div>
                    <div class="shop-detail-value">
                        ${isShopEditMode ? 
                            `<input type="text" class="shop-edit-input" 
                                    data-field="licenseNumber" data-shop-index="${index}" 
                                    value="${licenseNo}" 
                                    placeholder="License number">` :
                            licenseNo
                        }
                    </div>
                </div>
                ${admCode ? `
                <div class="shop-detail-row">
                    <div class="shop-detail-label">
                        <span class="shop-icon">üî¢</span>
                        ÿ±ŸÖÿ≤ ADM:
                    </div>
                    <div class="shop-detail-value">${admCode}</div>
                </div>
                ` : ''}
                <div class="shop-detail-row">
                    <div class="shop-detail-label">
                        <span class="shop-icon">üó∫Ô∏è</span>
                        ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:
                    </div>
                    <div class="shop-detail-value arabic">${areaName}</div>
                </div>
                ${contact ? `
                <div class="shop-detail-row">
                    <div class="shop-detail-label">
                        <span class="shop-icon">üìû</span>
                        ÿ±ŸÇŸÖ ÿßŸÑÿßÿ™ÿµÿßŸÑ:
                    </div>
                    <div class="shop-detail-value">${contact}</div>
                </div>
                ` : ''}
                <div class="shop-detail-row">
                    <div class="shop-detail-label">
                        <span class="shop-icon">üìç</span>
                        ÿßŸÑŸÖŸàŸÇÿπ:
                    </div>
                    <div class="shop-detail-value">
                        ${isShopEditMode ? 
                            `<input type="url" class="shop-edit-input" 
                                    data-field="googleMapsUrl" data-shop-index="${index}" 
                                    value="${locationMap}" 
                                    placeholder="https://maps.google.com/...">` :
                            (locationMap ? 
                                `<a href="${locationMap}" target="_blank" class="location-btn">
                                    üìç ÿπÿ±ÿ∂ ÿßŸÑŸÖŸàŸÇÿπ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©
                                </a>` : 
                                'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'
                            )
                        }
                    </div>
                </div>
            </div>
        `;
    });
    
    content.innerHTML = html;
}

// --- ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± ---
function checkDevAccess() {
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑŸÖÿ∑Ÿàÿ± ÿ£Ÿà Ÿàÿ¨ŸàÿØ ÿßŸÑÿ™ŸàŸÉŸÜ
    const token = localStorage.getItem("devToken");
    const isDevLoggedIn = isDev || window.isDev;
    return isDevLoggedIn || (token && token.trim().length > 0);
}

// --- ÿ™ÿ®ÿØŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± ---
function toggleShopEditMode() {
    if (!isDev && !window.isDev) {
        alert('ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÖÿ∑ŸÑŸàÿ®ÿ© ŸÑŸÑÿ™ÿ≠ÿ±Ÿäÿ±');
        return;
    }
    
    isShopEditMode = true;
    
    // ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿ™ÿ∏Ÿáÿ± ÿ¨ŸÜÿ®Ÿãÿß ÿ•ŸÑŸâ ÿ¨ŸÜÿ®
    document.getElementById('shopEditModeBtn').style.display = 'inline-block';
    document.getElementById('shopSaveBtn').style.display = 'inline-block';
    document.getElementById('shopCancelBtn').style.display = 'inline-block';
    
    renderShopDetails();
}

// --- ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± ---
function cancelShopEdit() {
    isShopEditMode = false;
    
    // ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿ™ÿ®ŸÇŸâ ÿ∏ÿßŸáÿ±ÿ© ÿ¨ŸÜÿ®Ÿãÿß ÿ•ŸÑŸâ ÿ¨ŸÜÿ®
    document.getElementById('shopEditModeBtn').style.display = 'inline-block';
    document.getElementById('shopSaveBtn').style.display = 'inline-block';
    document.getElementById('shopCancelBtn').style.display = 'inline-block';
    document.getElementById('shopSaveStatus').style.display = 'none';
    
    renderShopDetails();
}

// --- ÿ≠ŸÅÿ∏ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ ---
async function saveShopDetails() {
    if (!isDev && !window.isDev) {
        showShopSaveStatus('ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÖÿ∑ŸÑŸàÿ®ÿ© ŸÑŸÑÿ≠ŸÅÿ∏', 'error');
        return;
    }
    
    try {
        showShopSaveStatus('ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...', 'info');
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿßŸÖÿ© ŸÖÿ™ŸàŸÅÿ±ÿ©ÿå Ÿàÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÉÿ∞ŸÑŸÉÿå ÿ•ŸÜÿ¥ÿßÿ§Ÿáÿß
        if (!allPlanData || typeof allPlanData !== 'object') {
            allPlanData = {
                inspectionData: inspectionData || [],
                inspectors: inspectorsData || [],
                areas: areasData || [],
                shops: shopsData || [],
                bellNotes: bellNotesData || { notifications: [] },
                lastUpdate: new Date().toISOString()
            };
        }
        
        // ÿ¨ŸÖÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿ´ÿ© ŸÖŸÜ ŸÜŸÖÿßÿ∞ÿ¨ ÿßŸÑÿ•ÿØÿÆÿßŸÑ (ŸÖÿ±ŸÜ - ŸÑÿß Ÿäÿ™ÿ∑ŸÑÿ® ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ)
        const inputs = document.querySelectorAll('.shop-edit-input');
        let hasChanges = false;
        
        inputs.forEach(input => {
            const shopIndex = parseInt(input.dataset.shopIndex);
            const field = input.dataset.field;
            const value = input.value.trim();
            
            if (currentShopEditData.shops[shopIndex]) {
                // ÿ≠ŸÅÿ∏ ÿßŸÑŸÇŸäŸÖÿ© ÿ≠ÿ™Ÿâ ŸÑŸà ŸÉÿßŸÜÿ™ ŸÅÿßÿ±ÿ∫ÿ© (ŸÖÿ±ŸàŸÜÿ© ŸÅŸä ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ±)
                if (currentShopEditData.shops[shopIndex][field] !== value) {
                    currentShopEditData.shops[shopIndex][field] = value;
                    hasChanges = true;
                }
            }
        });
        
        // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸáŸÜÿßŸÉ ÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ÿå ÿ•ÿπŸÑÿßŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£ŸÜŸá ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÑŸÑÿ≠ŸÅÿ∏
        if (!hasChanges) {
            showShopSaveStatus('‚úÖ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÑŸÑÿ≠ŸÅÿ∏', 'success');
            setTimeout(() => {
                cancelShopEdit();
            }, 1500);
            return;
        }
        
        // ÿ™ÿ≠ÿØŸäÿ´ shopsData ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
        currentShopEditData.shops.forEach(updatedShop => {
            if (updatedShop.id) {
                const existingShopIndex = shopsData.findIndex(shop => shop.id === updatedShop.id);
                if (existingShopIndex !== -1) {
                    // ÿØŸÖÿ¨ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿ´ÿ© ŸÖÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ© (ŸÖÿ±ŸàŸÜÿ© ŸÅŸä ÿßŸÑÿ≠ŸÅÿ∏)
                    shopsData[existingShopIndex] = {...shopsData[existingShopIndex], ...updatedShop};
                }
            }
        });
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä plan-data.json
        const updatedData = {
            inspectionData: inspectionData,
            inspectors: inspectorsData,
            areas: areasData,
            shops: shopsData,
            lastUpdate: new Date().toISOString(),
            bellNotes: allPlanData.bellNotes || bellNotesData || {notifications: []}
        };
        
        // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ GitHub
        const success = await saveDataToGitHub(updatedData);
        
        if (success) {
            showShopSaveStatus('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!', 'success');
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
            allPlanData = updatedData;
            
            // ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ±
            setTimeout(() => {
                cancelShopEdit();
            }, 2000);
        } else {
            // Use detailed error message if available
            const errorDetails = window.lastSaveError || 'ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸàÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™';
            const formattedError = errorDetails.replace(/\n/g, '<br>');
            showShopSaveStatus(`‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.<br><br>${formattedError}`, 'error');
        }
        
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
        showShopSaveStatus('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ≠ŸÅÿ∏: ' + error.message, 'error');
    }
}

// --- ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ŸÅÿ∏ ---
function showShopSaveStatus(message, type) {
    const statusDiv = document.getElementById('shopSaveStatus');
    statusDiv.innerHTML = message;
    statusDiv.className = `shop-save-status ${type}`;
    statusDiv.style.display = 'block';
}

// --- ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ GitHub ---
async function saveDataToGitHub(data) {
    const token = localStorage.getItem("devToken");
    if (!token) {
        window.lastSaveError = 'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ŸàŸÉŸÜ GitHub. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÉŸÖÿ∑Ÿàÿ± ÿ£ŸàŸÑÿßŸã.';
        return false;
    }
    
    try {
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ SHA ÿßŸÑÿ≠ÿßŸÑŸä ŸÑŸÑŸÖŸÑŸÅ
        const getResponse = await fetch('https://api.github.com/repos/aliabdelaal-adm/Monthly_inspection_plan/contents/plan-data.json', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            }
        });
        
        if (!getResponse.ok) {
            let errorMsg = `ŸÅÿ¥ŸÑ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ: ${getResponse.status}`;
            try {
                const errorData = await getResponse.json();
                if (errorData.message) {
                    errorMsg += ` - ${errorData.message}`;
                }
            } catch (e) {
                // Ignore
            }
            
            if (getResponse.status === 401 || getResponse.status === 403) {
                errorMsg += '\n\nüîë ÿßŸÑÿ™ŸàŸÉŸÜ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ÿ£Ÿà ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©.\n\nŸÑŸÑÿ≠ŸÑ:\n1. ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ‚öôÔ∏è\n2. ÿ£ÿØÿÆŸÑ ÿ™ŸàŸÉŸÜ GitHub ÿ¨ÿØŸäÿØ\n3. ÿßÿ≠ŸÅÿ∏ Ÿàÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ';
            }
            
            window.lastSaveError = errorMsg;
            return false;
        }
        
        const fileData = await getResponse.json();
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÖŸèÿ±ŸÖÿ≤
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÑŸÅ
        const updateResponse = await fetch('https://api.github.com/repos/aliabdelaal-adm/Monthly_inspection_plan/contents/plan-data.json', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: 'ÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™',
                content: content,
                sha: fileData.sha
            })
        });
        
        if (!updateResponse.ok) {
            let errorMsg = `ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ: ${updateResponse.status}`;
            try {
                const errorData = await updateResponse.json();
                if (errorData.message) {
                    errorMsg += ` - ${errorData.message}`;
                }
            } catch (e) {
                // Ignore
            }
            
            if (updateResponse.status === 401 || updateResponse.status === 403) {
                errorMsg += '\n\nüîë ÿßŸÑÿ™ŸàŸÉŸÜ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ÿ£Ÿà ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©.\n\nŸÑŸÑÿ≠ŸÑ:\n1. ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ‚öôÔ∏è\n2. ÿ£ÿØÿÆŸÑ ÿ™ŸàŸÉŸÜ GitHub ÿ¨ÿØŸäÿØ\n3. ÿßÿ≠ŸÅÿ∏ Ÿàÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ';
            }
            
            window.lastSaveError = errorMsg;
            return false;
        }
        
        window.lastSaveError = null;
        return true;
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ GitHub:', error);
        window.lastSaveError = `ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ: ${error.message}`;
        return false;
    }
}

// --- ÿ•ÿ∫ŸÑÿßŸÇ ŸÖŸàÿØÿßŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ---
function closeShopDetailsModal() {
    const modal = document.getElementById('shopDetailsModal');
    modal.style.display = 'none';
    
    // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ±
    isShopEditMode = false;
    currentShopEditData = null;
    
    // ÿπŸÜÿØ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖŸàÿØÿßŸÑÿå ŸäŸÖŸÉŸÜ ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿ£Ÿà ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜŸáÿß
    document.getElementById('shopEditModeBtn').style.display = 'inline-block';
    document.getElementById('shopSaveBtn').style.display = 'inline-block';
    document.getElementById('shopCancelBtn').style.display = 'inline-block';
    document.getElementById('shopSaveStatus').style.display = 'none';
}

// --- ÿµŸàÿ™ ÿßŸÑŸÜŸÇÿ± ÿßŸÑÿ¥ÿßŸÖŸÑ ---
let lastClickSoundTime = 0;
const CLICK_SOUND_COOLDOWN = 100; // 100ms between clicks to prevent spam

function playClickSound() {
    const currentTime = Date.now();
    // Check cooldown to prevent too frequent sounds
    if (currentTime - lastClickSoundTime < CLICK_SOUND_COOLDOWN) {
        return;
    }
    
    lastClickSoundTime = currentTime;
    
    // Generate keyboard-like click sound using Web Audio API
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Configure keyboard-like click sound
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
        
        // Quick attack and decay (keyboard-like)
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.15, audioContext.currentTime + 0.005);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.05);
        
        // Start and stop
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.05);
        
        console.log('Click sound played');
        
    } catch (error) {
        console.log('Failed to play click sound:', error);
    }
}

function playBellSound() {
    // Play click sound instead of bell sound
    playClickSound();
    
    // Add visual bell animation
    const bellBtn = document.getElementById('bellBtn');
    if (bellBtn) {
        bellBtn.classList.add('bell-ringing');
        setTimeout(function() {
            bellBtn.classList.remove('bell-ringing');
        }, 800);
    }
    
    // Show the bell modal after a short delay
    setTimeout(function() {
        showBellModal();
    }, 200);
}

// --- Ÿàÿ∏ÿßÿ¶ŸÅ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ¨ÿ±ÿ≥ ---
function showBellModal() {
    const modal = document.getElementById('bellModal');
    const textarea = document.getElementById('bellNotesTextarea');
    const bellInfoText = document.getElementById('bellInfoText');
    const bellInfoEdit = document.getElementById('bellInfoEdit');
    
    // Load saved notes from central storage (bellNotesData)
    const savedNotes = bellNotesData.notes || '';
    textarea.value = savedNotes;
    
    // Load saved bell info text from central storage
    const savedBellInfo = bellNotesData.infoText || 'ÿ™Ÿàÿ¨ŸäŸáÿßÿ™ Ÿàÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÑŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ - Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏Ÿáÿß ŸÖÿ±ŸÉÿ≤ŸäÿßŸã ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ';
    bellInfoText.textContent = savedBellInfo;
    bellInfoEdit.value = savedBellInfo;
    
    // Initialize notifications if not exists
    if (!bellNotesData.notifications) {
        bellNotesData.notifications = [];
    }
    
    // Display individual notifications
    displayNotificationsList();
    
    // Check if user is developer before allowing bell notifications editing
    if (isDev || window.isDev) {
        // Allow developer to edit bell notifications
        textarea.disabled = false;
        textarea.placeholder = 'ÿßŸÉÿ™ÿ® ÿ™Ÿàÿ¨ŸäŸáÿßÿ™ŸÉ Ÿàÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ŸÉ ŸáŸÜÿß... (ŸÖÿ™ÿßÿ≠ ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑)';
        textarea.style.backgroundColor = '#fff';
        textarea.style.cursor = 'text';
        
        // Show action buttons for developer only
        document.getElementById('bellSaveBtn').style.display = 'inline-block';
        document.getElementById('bellClearBtn').style.display = 'inline-block';
        document.getElementById('bellExportBtn').style.display = 'none';
        
        // Show add notification section for developer
        document.getElementById('addNotificationSection').style.display = 'block';
        
        // Make bell info text editable for developer only
        bellInfoText.style.cursor = 'pointer';
        bellInfoText.onclick = function() {
            bellInfoText.style.display = 'none';
            bellInfoEdit.style.display = 'block';
            bellInfoEdit.focus();
        };
    } else {
        // Restrict access for non-developers
        textarea.disabled = true;
        textarea.placeholder = 'ÿπÿ±ÿ∂ ŸÅŸÇÿ∑ - ÿßŸÑÿ™Ÿàÿ¨ŸäŸáÿßÿ™ ŸàÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖŸÜ ÿßÿÆÿ™ÿµÿßÿµ ÿßŸÑŸÖÿ∑Ÿàÿ± ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ';
        textarea.style.backgroundColor = '#f8f9fa';
        textarea.style.cursor = 'not-allowed';
        
        // Hide action buttons for non-developers
        document.getElementById('bellSaveBtn').style.display = 'none';
        document.getElementById('bellClearBtn').style.display = 'none';
        document.getElementById('bellExportBtn').style.display = 'none';
        
        // Hide add notification section for non-developers
        document.getElementById('addNotificationSection').style.display = 'none';
        
        // Make bell info text non-editable for non-developers
        bellInfoText.style.cursor = 'default';
        bellInfoText.onclick = null;
    }
    
    bellInfoEdit.onblur = function() {
        if (isDev || window.isDev) {
            const newText = bellInfoEdit.value.trim() || 'ÿ™Ÿàÿ¨ŸäŸáÿßÿ™ Ÿàÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÑŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ - Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏Ÿáÿß ŸÖÿ±ŸÉÿ≤ŸäÿßŸã ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ';
            bellInfoText.textContent = newText;
            bellNotesData.infoText = newText;
            // Save to central file
            saveDataToJSON();
        }
        bellInfoText.style.display = 'block';
        bellInfoEdit.style.display = 'none';
    };
    
    bellInfoEdit.onkeypress = function(e) {
        if (e.key === 'Enter') {
            bellInfoEdit.blur();
        }
    };
    
    modal.classList.add('show');
    
    // Focus on textarea for all users
    setTimeout(function() {
        textarea.focus();
    }, 100);
}

function displayNotificationsList() {
    const notificationsList = document.getElementById('notificationsList');
    if (!notificationsList) return;
    
    notificationsList.innerHTML = '';
    
    if (!bellNotesData.notifications || bellNotesData.notifications.length === 0) {
        notificationsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ≠ÿßŸÑŸäÿßŸã</p>';
        return;
    }
    
    bellNotesData.notifications.forEach((notification, index) => {
        const notificationDiv = document.createElement('div');
        notificationDiv.className = 'notification-item';
        notificationDiv.style.cssText = `
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        `;
        
        // Check if user is developer to determine if text should be clickable
        const isDeveloper = isDev || window.isDev;
        const textClickable = isDeveloper ? `onclick="editNotification(${index})"` : '';
        const textCursor = isDeveloper ? 'pointer' : 'default';
        
        // Show action buttons only for developers
        const actionButtons = isDeveloper ? `
            <div class="notification-actions">
                <button onclick="saveNotificationEdit(${index})" id="saveBtn_${index}" style="display: none; background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-left: 5px;">‚úÖ ÿ≠ŸÅÿ∏</button>
                <button onclick="cancelNotificationEdit(${index})" id="cancelBtn_${index}" style="display: none; background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-left: 5px;">‚ùå ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button onclick="deleteNotification(${index})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>
            </div>
        ` : '';
        
        notificationDiv.innerHTML = `
            <div class="notification-content" style="margin-bottom: 10px;">
                <div class="notification-text" id="notificationText_${index}" style="display: block; cursor: ${textCursor}; padding: 5px; border-radius: 4px;" ${textClickable}>${notification.text}</div>
                <textarea class="notification-edit" id="notificationEdit_${index}" style="display: none; width: 100%; min-height: 60px; border: 1px solid #ccc; border-radius: 4px; padding: 5px; resize: vertical; margin-bottom: 8px;" dir="rtl">${notification.text}</textarea>
                <div id="authorEditContainer_${index}" style="display: none; margin-top: 8px;">
                    <label style="display: block; margin-bottom: 4px; color: #495057; font-weight: 500; font-size: 0.9em;">üë§ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ§ŸÑŸÅ/ÿßŸÑŸÖÿ±ÿ≥ŸÑ:</label>
                    <input 
                        type="text" 
                        id="authorEdit_${index}" 
                        value="${notification.author || 'ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ'}"
                        style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit;"
                        dir="rtl"
                    />
                </div>
            </div>
            <div class="notification-meta" style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                <span>üìÖ ${formatDate(notification.timestamp)}</span>
                ${notification.author ? `<span style="margin-right: 15px;">üë§ ${notification.author}</span>` : ''}
            </div>
            ${actionButtons}
        `;
        
        notificationsList.appendChild(notificationDiv);
    });
}

function addNewNotification() {
    // Check if user is developer
    if (!isDev && !window.isDev) {
        alert('‚ö†Ô∏è Ÿáÿ∞Ÿá ÿßŸÑŸàÿ∏ŸäŸÅÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑ - ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ');
        return;
    }
    
    const input = document.getElementById('newNotificationInput');
    const authorInput = document.getElementById('newNotificationAuthor');
    const text = input.value.trim();
    const author = authorInput.value.trim();
    
    if (!text) {
        alert('Ÿäÿ±ÿ¨Ÿâ ŸÉÿ™ÿßÿ®ÿ© ŸÜÿµ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±');
        return;
    }
    
    if (!author) {
        alert('Ÿäÿ±ÿ¨Ÿâ ŸÉÿ™ÿßÿ®ÿ© ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ§ŸÑŸÅ');
        return;
    }
    
    const newNotification = {
        id: Date.now().toString(),
        text: text,
        timestamp: new Date().toISOString(),
        author: author
    };
    
    if (!bellNotesData.notifications) {
        bellNotesData.notifications = [];
    }
    
    bellNotesData.notifications.unshift(newNotification); // Add to beginning
    input.value = '';
    // Keep the author field as is for convenience when adding multiple notifications
    
    displayNotificationsList();
    saveDataToJSON();
    updateNewsTicker(); // Update news ticker
    
    // Show success message
    showBellSaveMessage('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠! ‚úÖ');
}

function editNotification(index) {
    // Check if user is developer
    if (!isDev && !window.isDev) {
        alert('‚ö†Ô∏è Ÿáÿ∞Ÿá ÿßŸÑŸàÿ∏ŸäŸÅÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑ - ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ');
        return;
    }
    
    const textDiv = document.getElementById(`notificationText_${index}`);
    const editTextarea = document.getElementById(`notificationEdit_${index}`);
    const authorEditContainer = document.getElementById(`authorEditContainer_${index}`);
    const saveBtn = document.getElementById(`saveBtn_${index}`);
    const cancelBtn = document.getElementById(`cancelBtn_${index}`);
    
    textDiv.style.display = 'none';
    editTextarea.style.display = 'block';
    authorEditContainer.style.display = 'block';
    saveBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';
    
    editTextarea.focus();
}

function saveNotificationEdit(index) {
    // Check if user is developer
    if (!isDev && !window.isDev) {
        alert('‚ö†Ô∏è Ÿáÿ∞Ÿá ÿßŸÑŸàÿ∏ŸäŸÅÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑ - ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ');
        return;
    }
    
    const textDiv = document.getElementById(`notificationText_${index}`);
    const editTextarea = document.getElementById(`notificationEdit_${index}`);
    const authorEditContainer = document.getElementById(`authorEditContainer_${index}`);
    const authorEdit = document.getElementById(`authorEdit_${index}`);
    const saveBtn = document.getElementById(`saveBtn_${index}`);
    const cancelBtn = document.getElementById(`cancelBtn_${index}`);
    
    const newText = editTextarea.value.trim();
    const newAuthor = authorEdit.value.trim();
    
    if (!newText) {
        alert('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ŸÅÿßÿ±ÿ∫ÿßŸã');
        return;
    }
    
    if (!newAuthor) {
        alert('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ§ŸÑŸÅ ŸÅÿßÿ±ÿ∫ÿßŸã');
        return;
    }
    
    bellNotesData.notifications[index].text = newText;
    bellNotesData.notifications[index].author = newAuthor;
    bellNotesData.notifications[index].lastModified = new Date().toISOString();
    
    textDiv.textContent = newText;
    textDiv.style.display = 'block';
    editTextarea.style.display = 'none';
    authorEditContainer.style.display = 'none';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
    
    // Refresh the display to update the author in the metadata section
    displayNotificationsList();
    
    saveDataToJSON();
    updateNewsTicker(); // Update news ticker
    showBellSaveMessage('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠! ‚úÖ');
}

function cancelNotificationEdit(index) {
    const textDiv = document.getElementById(`notificationText_${index}`);
    const editTextarea = document.getElementById(`notificationEdit_${index}`);
    const authorEditContainer = document.getElementById(`authorEditContainer_${index}`);
    const authorEdit = document.getElementById(`authorEdit_${index}`);
    const saveBtn = document.getElementById(`saveBtn_${index}`);
    const cancelBtn = document.getElementById(`cancelBtn_${index}`);
    
    // Reset textarea and author to original values
    editTextarea.value = bellNotesData.notifications[index].text;
    authorEdit.value = bellNotesData.notifications[index].author || 'ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ';
    
    textDiv.style.display = 'block';
    editTextarea.style.display = 'none';
    authorEditContainer.style.display = 'none';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
}

function deleteNotification(index) {
    // Check if user is developer
    if (!isDev && !window.isDev) {
        alert('‚ö†Ô∏è Ÿáÿ∞Ÿá ÿßŸÑŸàÿ∏ŸäŸÅÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑ - ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ');
        return;
    }
    
    if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿü')) {
        bellNotesData.notifications.splice(index, 1);
        displayNotificationsList();
        saveDataToJSON();
        updateNewsTicker(); // Update news ticker
        showBellSaveMessage('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠! ‚úÖ');
    }
}

function formatDate(isoString) {
    const date = new Date(isoString);
    return date.toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function hideBellModal() {
    const modal = document.getElementById('bellModal');
    modal.classList.remove('show');
}

function saveBellNotes() {
    // Check if user is developer
    if (!isDev && !window.isDev) {
        alert('‚ö†Ô∏è Ÿáÿ∞Ÿá ÿßŸÑŸàÿ∏ŸäŸÅÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑ - ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ');
        return;
    }
    
    const textarea = document.getElementById('bellNotesTextarea');
    const notes = textarea.value.trim();
    
    // Save legacy notes to central storage
    bellNotesData.notes = notes;
    
    // If user typed in the main textarea and it's not empty, convert it to a notification
    if (notes && notes.length > 0) {
        const existingNotificationFromTextarea = bellNotesData.notifications.find(n => n.source === 'textarea');
        if (existingNotificationFromTextarea) {
            // Update existing textarea-based notification  
            existingNotificationFromTextarea.text = notes;
            existingNotificationFromTextarea.lastModified = new Date().toISOString();
            existingNotificationFromTextarea.author = 'ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ'; // Ensure author is Dr. Ali Abdelaal
        } else {
            // Create new notification from textarea content
            const newNotification = {
                id: 'textarea_' + Date.now().toString(),
                text: notes,
                timestamp: new Date().toISOString(),
                author: 'ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ',
                source: 'textarea'
            };
            if (!bellNotesData.notifications) {
                bellNotesData.notifications = [];
            }
            bellNotesData.notifications.unshift(newNotification);
        }
        
        // Clear the textarea after converting to notification
        textarea.value = '';
        bellNotesData.notes = '';
        
        // Refresh the notifications display  
        displayNotificationsList();
    }
    
    saveDataToJSON();
    updateNewsTicker(); // Update news ticker
    
    // Show success feedback with clearer messaging
    const saveBtn = document.getElementById('bellSaveBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏';
    saveBtn.style.background = '#28a745';
    
    // Show more prominent message about saving
    showBellSaveMessage('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™Ÿàÿ¨ŸäŸáÿßÿ™ ŸàÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠! üéâ ÿ≥Ÿäÿ™ŸÖ ŸÖÿ≤ÿßŸÖŸÜÿ™Ÿáÿß ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ.');
    
    setTimeout(function() {
        saveBtn.innerHTML = originalText;
        saveBtn.style.background = '#28a745';
    }, 3000);
}

function showBellSaveMessage(message) {
    // Create or update the message div
    let messageDiv = document.getElementById('bellSaveMessage');
    if (!messageDiv) {
        messageDiv = document.createElement('div');
        messageDiv.id = 'bellSaveMessage';
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2196F3;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 400px;
            font-size: 14px;
            line-height: 1.4;
            text-align: right;
            direction: rtl;
        `;
        document.body.appendChild(messageDiv);
    }
    
    messageDiv.innerHTML = `
        <div style="margin-bottom: 10px;">
            üìù ${message}
        </div>
        <button onclick="hideBellSaveMessage()" style="
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        ">ÿ•ÿ∫ŸÑÿßŸÇ</button>
    `;
    
    // Auto-hide after 8 seconds
    setTimeout(function() {
        hideBellSaveMessage();
    }, 8000);
}

function hideBellSaveMessage() {
    const messageDiv = document.getElementById('bellSaveMessage');
    if (messageDiv) {
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateY(-10px)';
        messageDiv.style.transition = 'all 0.3s ease';
        setTimeout(function() {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 300);
    }
}

function clearBellNotes() {
    // Check if user is developer
    if (!isDev && !window.isDev) {
        alert('‚ö†Ô∏è Ÿáÿ∞Ÿá ÿßŸÑŸàÿ∏ŸäŸÅÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑ - ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ');
        return;
    }
    
    if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™Ÿàÿ¨ŸäŸáÿßÿ™ ŸàÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ÿü (ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ŸÉŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÅÿ±ÿØŸäÿ© ÿ£Ÿäÿ∂ÿßŸã)')) {
        const textarea = document.getElementById('bellNotesTextarea');
        textarea.value = '';
        
        // Clear both legacy notes and new notifications from central storage
        bellNotesData.notes = '';
        bellNotesData.notifications = [];
        
        // Refresh display
        displayNotificationsList();
        
        saveDataToJSON();
        updateNewsTicker(); // Update news ticker
        
        // Show clear feedback
        const clearBtn = document.getElementById('bellClearBtn');
        const originalText = clearBtn.innerHTML;
        clearBtn.innerHTML = '‚úÖ ÿ™ŸÖ ÿßŸÑŸÖÿ≥ÿ≠';
        
        showBellSaveMessage('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™Ÿàÿ¨ŸäŸáÿßÿ™ ŸàÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠! üóëÔ∏è');
        
        setTimeout(function() {
            clearBtn.innerHTML = originalText;
        }, 2000);
    }
}

// Event listeners for bell modal
document.addEventListener('DOMContentLoaded', function() {
    // Add global click sound to document
    document.addEventListener('click', function(e) {
        // Play click sound on any click/touch
        playClickSound();
    });
    
    // Add global touch sound to document  
    document.addEventListener('touchstart', function(e) {
        // Play click sound on any touch
        playClickSound();
    });
    
    // Bell button specific functionality
    document.getElementById('bellBtn').addEventListener('click', function(e) {
        // Prevent double click sound (already handled by global listener)
        e.stopPropagation();
        playBellSound();
    });
    
    document.getElementById('bellBtn').addEventListener('touchstart', function(e) {
        // Prevent double click sound (already handled by global listener)  
        e.stopPropagation();
        playBellSound();
    });
    
    // Bell modal event listeners
    document.getElementById('bellSaveBtn').addEventListener('click', saveBellNotes);
    document.getElementById('bellClearBtn').addEventListener('click', clearBellNotes);
    document.getElementById('bellExportBtn').addEventListener('click', function() {
        // First save the current data, then export
        saveBellNotes();
        // Wait a bit for the save to complete, then export
        setTimeout(function() {
            saveToExternalFile();
        }, 500);
    });
    document.getElementById('bellCloseBtn').addEventListener('click', hideBellModal);
    
    // Close modal when clicking outside
    document.getElementById('bellModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideBellModal();
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideBellModal();
        }
    });
});

// --- ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿµÿØŸäÿ± ŸàÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ÿ®ÿßŸÑŸÉÿßŸÖŸÑ ---
function exportTableToPDF() {
    let table = document.getElementById('inspectorPlanTable');
    if (!table) { alert("ŸÑÿß ŸäŸàÿ¨ÿØ ÿ¨ÿØŸàŸÑ ŸÑŸÑÿ™ÿµÿØŸäÿ±"); return; }
    
    let wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '20px';
    wrap.style.fontFamily = 'Cairo, Arial, sans-serif';
    wrap.style.width = 'auto';
    wrap.style.minWidth = '800px';
    
    let titleBox = document.createElement('div');
    titleBox.className = "pdf-title-arabic";
    titleBox.innerText = "ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©";
    titleBox.style.fontSize = '1.3em';
    titleBox.style.marginBottom = '15px';
    wrap.appendChild(titleBox);
    
    let tableClone = table.cloneNode(true);
    tableClone.style.marginTop = '10px';
    tableClone.style.width = '100%';
    tableClone.style.fontSize = '11px';
    
    // Style table for better PDF rendering
    const thElements = tableClone.querySelectorAll('th');
    thElements.forEach(th => {
        th.style.padding = '6px 4px';
        th.style.fontSize = '9px';
        th.style.fontWeight = 'bold';
    });
    
    const tdElements = tableClone.querySelectorAll('td');
    tdElements.forEach(td => {
        td.style.padding = '5px 3px';
        td.style.fontSize = '8px';
        td.style.wordBreak = 'break-word';
    });
    
    // Replace shops buttons with actual shop names for PDF export
    const shopsDropdowns = tableClone.querySelectorAll('.shops-dropdown-wrap');
    shopsDropdowns.forEach(dropdown => {
        const shopsList = dropdown.querySelector('.shops-dropdown-list ul');
        const shopsButton = dropdown.querySelector('.show-shops-btn');
        
        if (shopsList && shopsButton) {
            // Extract shop names from the list
            const shopItems = shopsList.querySelectorAll('li');
            const shopNames = Array.from(shopItems).map(item => {
                // Remove the shop icon emoji from the text
                return item.textContent.replace('üè™', '').trim();
            });
            
            // Create a formatted shops display for PDF
            const shopsText = document.createElement('div');
            shopsText.style.fontSize = '7px';
            shopsText.style.lineHeight = '1.3';
            shopsText.style.textAlign = 'right';
            shopsText.innerHTML = shopNames.join('<br>');
            
            // Replace the entire dropdown with the shops text
            dropdown.parentNode.replaceChild(shopsText, dropdown);
        }
    });
    
    wrap.appendChild(tableClone);
    document.body.appendChild(wrap);
    
    html2canvas(wrap, {
        backgroundColor: '#fff', 
        scale: 1.5,
        useCORS: true,
        allowTaint: true,
        width: wrap.scrollWidth,
        height: wrap.scrollHeight
    }).then(function(canvas) {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation: "landscape", unit: "pt", format: "a4"});
        
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const imgProps = doc.getImageProperties(imgData);
        
        const pdfWidth = pageWidth - 40;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        // If content is too tall, split into multiple pages
        if (pdfHeight > pageHeight - 60) {
            const ratio = (pageHeight - 60) / pdfHeight;
            const finalWidth = pdfWidth * ratio;
            const finalHeight = pageHeight - 60;
            
            doc.addImage(imgData, 'PNG', 20, 30, finalWidth, finalHeight);
            
            // Add additional pages if needed
            if (pdfHeight > pageHeight - 60) {
                // For very large tables, we might need to implement table splitting logic
                // For now, we'll scale to fit one page
            }
        } else {
            doc.addImage(imgData, 'PNG', 20, 30, pdfWidth, pdfHeight);
        }
        
        doc.save(`ÿÆÿ∑ÿ©_ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥_${new Date().toISOString().split('T')[0]}.pdf`);
        document.body.removeChild(wrap);
    }).catch(function(error) {
        console.error('PDF generation error:', error);
        document.body.removeChild(wrap);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± ŸÖŸÑŸÅ PDF');
    });
}
function exportTableToExcel() {
    let table = document.getElementById('inspectorPlanTable');
    if (!table) { alert("ŸÑÿß ŸäŸàÿ¨ÿØ ÿ¨ÿØŸàŸÑ ŸÑŸÑÿ™ÿµÿØŸäÿ±"); return; }
    
    let ws_data = [];
    
    // Process each row
    for(let r of table.rows) {
        let row = [];
        for(let c of r.cells) {
            // Check if this cell contains shops dropdown
            const shopsDropdown = c.querySelector('.shops-dropdown-wrap');
            if (shopsDropdown) {
                const shopsList = shopsDropdown.querySelector('.shops-dropdown-list ul');
                if (shopsList) {
                    // Extract shop names from the list
                    const shopItems = shopsList.querySelectorAll('li');
                    const shopNames = Array.from(shopItems).map(item => {
                        // Remove the shop icon emoji from the text
                        return item.textContent.replace('üè™', '').trim();
                    });
                    row.push(shopNames.join(', '));
                } else {
                    row.push(c.textContent);
                }
            } else {
                row.push(c.textContent);
            }
        }
        ws_data.push(row);
    }
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "ÿßŸÑÿÆÿ∑ÿ©");
    XLSX.writeFile(wb, `ÿÆÿ∑ÿ©_ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥.xlsx`);
}
function printTable() {
    let table = document.getElementById('inspectorPlanTable');
    if (!table) { alert("ŸÑÿß ŸäŸàÿ¨ÿØ ÿ¨ÿØŸàŸÑ ŸÑÿ∑ÿ®ÿßÿπÿ™Ÿá"); return; }
    
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    const tableClone = table.cloneNode(true);
    
    // Replace shops buttons with actual shop names for printing
    const shopsDropdowns = tableClone.querySelectorAll('.shops-dropdown-wrap');
    shopsDropdowns.forEach(dropdown => {
        const shopsList = dropdown.querySelector('.shops-dropdown-list ul');
        const shopsButton = dropdown.querySelector('.show-shops-btn');
        
        if (shopsList && shopsButton) {
            // Extract shop names from the list
            const shopItems = shopsList.querySelectorAll('li');
            const shopNames = Array.from(shopItems).map(item => {
                // Remove the shop icon emoji from the text
                return item.textContent.replace('üè™', '').trim();
            });
            
            // Create a formatted shops display for printing
            const shopsText = document.createElement('div');
            shopsText.style.fontSize = '0.8em';
            shopsText.style.lineHeight = '1.2';
            shopsText.style.textAlign = 'right';
            shopsText.innerHTML = shopNames.join('<br>');
            
            // Replace the entire dropdown with the shops text
            dropdown.parentNode.replaceChild(shopsText, dropdown);
        }
    });
    
    // Create the print document
    printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© - ÿ∑ÿ®ÿßÿπÿ©</title>
            <style>
                body { font-family: 'Cairo', Arial, sans-serif; margin: 20px; }
                .print-title { text-align: center; color: #234085; font-size: 1.5em; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
                th, td { border: 1px solid #234093; padding: 6px; text-align: center; }
                th { background: #234093; color: #fff; font-size: 0.9em; }
                tr:nth-child(even) { background: #f3f5fa; }
                @media print {
                    body { margin: 0; }
                    .print-title { font-size: 1.2em; }
                    table { font-size: 0.8em; }
                    th, td { padding: 5px; }
                }
            </style>
        </head>
        <body>
            <div class="print-title">ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©</div>
            ${tableClone.outerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    
    // Wait for content to load then print
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 500);
}
function showInspectorReport() {
    let inspectorName = selectedInspector || "";
    if (!inspectorName) { alert("Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÅÿ™ÿ¥ ÿ£ŸàŸÑÿßŸã."); return; }
    const div = document.getElementById('inspectorReportDiv');
    const rows = inspectionData.filter(item => item.inspector === inspectorName);
    
    // Calculate comprehensive statistics
    let totalShops = 0;
    let morningShops = 0;
    let eveningShops = 0;
    let weekendShops = 0;
    let totalDays = 0;
    let areasVisited = new Set();
    let shopsList = new Set();
    let dailyStats = {};
    
    rows.forEach(r => {
        const shopsCount = r.shops ? r.shops.length : 0;
        totalShops += shopsCount;
        totalDays++;
        areasVisited.add(r.area);
        
        // Add shops to set for unique count
        if (r.shops) {
            r.shops.forEach(shop => shopsList.add(shop));
        }
        
        // Daily statistics
        if (!dailyStats[r.day]) {
            dailyStats[r.day] = { shops: 0, shift: r.shift, area: r.area };
        }
        dailyStats[r.day].shops += shopsCount;
        
        if (r.shift === "ÿµÿ®ÿßÿ≠Ÿäÿ©") {
            morningShops += shopsCount;
        } else if (r.shift === "ŸÖÿ≥ÿßÿ¶Ÿäÿ©") {
            eveningShops += shopsCount;
        }
        
        // Check if it's a weekend day (Friday, Saturday, Sunday)
        const dayOfWeek = new Date(r.day).getDay();
        if ([5,6,0].includes(dayOfWeek)) {
            weekendShops += shopsCount;
        }
    });
    
    const averageShopsPerDay = totalDays > 0 ? (totalShops / totalDays).toFixed(1) : 0;
    const uniqueShopsCount = shopsList.size;
    
    let table = `
    <div class="pdf-title-arabic" id="inspectorReportTitle">ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥: ${inspectorName}</div>
    <div class="save-box" style="margin-bottom:15px;">
        <button class="pdf-btn" onclick="exportInspectorReportToPDF()">üìÑ ÿ≠ŸÅÿ∏ ŸÉŸÄ PDF</button>
        <button class="excel-btn" onclick="exportInspectorReportToExcel()">üìä ÿ≠ŸÅÿ∏ ŸÉŸÄ Excel</button>
    </div>
    
    <!-- Summary Statistics -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #2196f3;">
            <h4 style="margin: 0; color: #1976d2;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</h4>
            <span style="font-size: 1.5em; font-weight: bold; color: #1976d2;">${totalShops}</span>
        </div>
        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #4caf50;">
            <h4 style="margin: 0; color: #388e3c;">ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ©</h4>
            <span style="font-size: 1.5em; font-weight: bold; color: #388e3c;">${uniqueShopsCount}</span>
        </div>
        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #ff9800;">
            <h4 style="margin: 0; color: #f57c00;">ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿ∫ÿ∑ÿßÿ©</h4>
            <span style="font-size: 1.5em; font-weight: bold; color: #f57c00;">${areasVisited.size}</span>
        </div>
        <div style="background: #fce4ec; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #e91e63;">
            <h4 style="margin: 0; color: #c2185b;">ŸÖÿ™Ÿàÿ≥ÿ∑ ŸäŸàŸÖŸä</h4>
            <span style="font-size: 1.5em; font-weight: bold; color: #c2185b;">${averageShopsPerDay}</span>
        </div>
    </div>
    
    <!-- Main Statistics Table -->
    <table class="stats-table" id="inspectorStatsTable">
        <thead>
            <tr>
                <th>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</th>
                <th>ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑÿµÿ®ÿßÿ≠Ÿäÿ©</th>
                <th>ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÖÿ≥ÿßÿ¶Ÿäÿ©</th>
                <th>ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑÿπÿ∑ŸÑÿ©</th>
                <th>ÿ£ŸäÿßŸÖ ÿßŸÑÿπŸÖŸÑ</th>
                <th>ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿ∫ÿ∑ÿßÿ©</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td style="font-weight: bold; color: #2196f3;">${totalShops}</td>
                <td style="color: #4caf50;">${morningShops}</td>
                <td style="color: #ff9800;">${eveningShops}</td>
                <td style="color: #e91e63;">${weekendShops}</td>
                <td>${totalDays}</td>
                <td>${areasVisited.size}</td>
            </tr>
        </tbody>
    </table>
    
    <!-- Daily Breakdown Table -->
    <h3 style="color: #234085; margin-top: 25px; margin-bottom: 15px;">ÿßŸÑÿ™ŸÅÿµŸäŸÑ ÿßŸÑŸäŸàŸÖŸä</h3>
    <table class="stats-table" id="inspectorDailyTable">
        <thead>
            <tr>
                <th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                <th>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                <th>ŸàŸÇÿ™ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©</th>
                <th>ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</th>
                <th>ÿßŸÑŸÜÿ≥ÿ®ÿ© ŸÖŸÜ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
            </tr>
        </thead>
        <tbody>`;
    
    // Add daily breakdown
    Object.keys(dailyStats).sort().forEach(day => {
        const dayData = dailyStats[day];
        const percentage = totalShops > 0 ? ((dayData.shops / totalShops) * 100).toFixed(1) : 0;
        const dayOfWeek = new Date(day).toLocaleDateString('ar', { weekday: 'long' });
        
        table += `
            <tr>
                <td>${day}<br><small style="color: #666;">${dayOfWeek}</small></td>
                <td style="color:${dayData.area === 'ÿ≥ŸàŸÇ ÿßŸÑŸÖŸäŸÜÿßÿ°' || dayData.area === 'ÿ≥ŸàŸÇ ÿßŸÑÿ™ÿ±ÿßÿ´' ? '#1976d2' : '#d32f2f'};">${dayData.area}</td>
                <td style="text-align:center;">
                    <span style="display:inline-block;vertical-align:middle;background: ${dayData.shift === 'ÿµÿ®ÿßÿ≠Ÿäÿ©' ? '#4caf50' : '#ff9800'}; 
                                 color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.85em;">
                        ${dayData.shift}
                    </span>
                </td>
                <td style="font-weight: bold;">${dayData.shops}</td>
                <td>
                    <div style="display: flex; align-items: center; justify-content: center;">
                        <div style="background: #e0e0e0; width: 50px; height: 8px; border-radius: 4px; margin-right: 8px;">
                            <div style="background: #2196f3; width: ${percentage}%; height: 100%; border-radius: 4px;"></div>
                        </div>
                        ${percentage}%
                    </div>
                </td>
            </tr>`;
    });
    
    table += `
        </tbody>
    </table>
    
    <!-- Areas Coverage -->
    <h3 style="color: #234085; margin-top: 25px; margin-bottom: 15px;">ÿ™ÿ∫ÿ∑Ÿäÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">`;
    
    areasVisited.forEach(area => {
        const areaInspections = rows.filter(r => r.area === area).reduce((sum, r) => sum + (r.shops ? r.shops.length : 0), 0);
        const areaPercentage = totalShops > 0 ? ((areaInspections / totalShops) * 100).toFixed(1) : 0;
        
        table += `
            <div style="background: #f5f5f5; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd;">
                <strong>${area}</strong><br>
                <small>${areaInspections} ÿ™ŸÅÿ™Ÿäÿ¥ (${areaPercentage}%)</small>
            </div>`;
    });
    
    table += `</div>`;
    
    div.innerHTML = table;
    div.style.display = "block";
}
function exportInspectorReportToPDF() {
    let titleBox = document.getElementById('inspectorReportTitle');
    let reportDiv = document.getElementById('inspectorReportDiv');
    if (!reportDiv || !titleBox) return;
    
    let wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '20px';
    wrap.style.fontFamily = 'Cairo, Arial, sans-serif';
    wrap.style.width = 'auto';
    wrap.style.minWidth = '800px';
    wrap.style.maxWidth = '1000px';
    
    // Clone the entire report content
    let contentClone = reportDiv.cloneNode(true);
    
    // Remove buttons from the cloned content
    const buttons = contentClone.querySelectorAll('button, .save-box');
    buttons.forEach(btn => btn.remove());
    
    // Style tables for better PDF rendering
    const tables = contentClone.querySelectorAll('table');
    tables.forEach(table => {
        table.style.fontSize = '10px';
        table.style.marginBottom = '15px';
        
        const ths = table.querySelectorAll('th');
        ths.forEach(th => {
            th.style.padding = '8px 6px';
            th.style.fontSize = '9px';
            th.style.fontWeight = 'bold';
        });
        
        const tds = table.querySelectorAll('td');
        tds.forEach(td => {
            td.style.padding = '6px 4px';
            td.style.fontSize = '8px';
            td.style.wordBreak = 'break-word';
        });
    });
    
    // Style other elements
    const h3Elements = contentClone.querySelectorAll('h3');
    h3Elements.forEach(h3 => {
        h3.style.fontSize = '12px';
        h3.style.marginTop = '15px';
        h3.style.marginBottom = '8px';
    });
    
    const smallElements = contentClone.querySelectorAll('small');
    smallElements.forEach(small => {
        small.style.fontSize = '7px';
    });
    
    wrap.appendChild(contentClone);
    document.body.appendChild(wrap);
    
    html2canvas(wrap, {
        backgroundColor: '#fff', 
        scale: 1.2,
        useCORS: true,
        allowTaint: true,
        width: wrap.scrollWidth,
        height: wrap.scrollHeight
    }).then(function(canvas) {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation: "portrait", unit: "pt", format: "a4"});
        
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const imgProps = doc.getImageProperties(imgData);
        
        let pdfWidth = pageWidth - 40;
        let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        // Handle multiple pages if content is too tall
        let yPosition = 20;
        let remainingHeight = pdfHeight;
        let sourceY = 0;
        
        while (remainingHeight > 0) {
            const pageContentHeight = Math.min(remainingHeight, pageHeight - 40);
            const sourceHeight = (pageContentHeight * imgProps.height) / pdfHeight;
            
            if (sourceY > 0) {
                doc.addPage();
            }
            
            // Create a cropped image for this page
            const pageCanvas = document.createElement('canvas');
            pageCanvas.width = imgProps.width;
            pageCanvas.height = sourceHeight;
            const pageCtx = pageCanvas.getContext('2d');
            
            const img = new Image();
            img.onload = function() {
                pageCtx.drawImage(img, 0, sourceY, imgProps.width, sourceHeight, 0, 0, imgProps.width, sourceHeight);
                const pageImgData = pageCanvas.toDataURL('image/png');
                doc.addImage(pageImgData, 'PNG', 20, 20, pdfWidth, pageContentHeight);
                
                sourceY += sourceHeight;
                remainingHeight -= pageContentHeight;
                
                if (remainingHeight <= 0) {
                    doc.save(`ÿ™ŸÇÿ±Ÿäÿ±_${selectedInspector}_${new Date().toISOString().split('T')[0]}.pdf`);
                    document.body.removeChild(wrap);
                }
            };
            img.src = imgData;
            
            if (remainingHeight <= pageHeight - 40) {
                break;
            }
        }
        
        // Fallback: if the multi-page logic fails, just fit to one page
        if (remainingHeight > 0) {
            if (pdfHeight > pageHeight - 40) {
                const ratio = (pageHeight - 40) / pdfHeight;
                pdfWidth = pdfWidth * ratio;
                pdfHeight = pageHeight - 40;
            }
            doc.addImage(imgData, 'PNG', 20, 20, pdfWidth, pdfHeight);
            doc.save(`ÿ™ŸÇÿ±Ÿäÿ±_${selectedInspector}_${new Date().toISOString().split('T')[0]}.pdf`);
            document.body.removeChild(wrap);
        }
        
    }).catch(function(error) {
        console.error('PDF generation error:', error);
        document.body.removeChild(wrap);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± ŸÖŸÑŸÅ PDF');
    });
}
function exportInspectorReportToExcel() {
    if (!selectedInspector) return;
    
    const rows = inspectionData.filter(item => item.inspector === selectedInspector);
    let ws_data = [];
    
    // Add title
    ws_data.push([`ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥: ${selectedInspector}`]);
    ws_data.push([]);
    
    // Calculate statistics
    let totalShops = 0;
    let morningShops = 0;
    let eveningShops = 0;
    let weekendShops = 0;
    let areasVisited = new Set();
    let shopsList = new Set();
    
    rows.forEach(r => {
        const shopsCount = r.shops ? r.shops.length : 0;
        totalShops += shopsCount;
        areasVisited.add(r.area);
        
        if (r.shops) {
            r.shops.forEach(shop => shopsList.add(shop));
        }
        
        if (r.shift === "ÿµÿ®ÿßÿ≠Ÿäÿ©") {
            morningShops += shopsCount;
        } else if (r.shift === "ŸÖÿ≥ÿßÿ¶Ÿäÿ©") {
            eveningShops += shopsCount;
        }
        
        const dayOfWeek = new Date(r.day).getDay();
        if ([5,6,0].includes(dayOfWeek)) {
            weekendShops += shopsCount;
        }
    });
    
    // Add summary statistics
    ws_data.push(['ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©']);
    ws_data.push(['ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™', totalShops]);
    ws_data.push(['ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ©', shopsList.size]);
    ws_data.push(['ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿ∫ÿ∑ÿßÿ©', areasVisited.size]);
    ws_data.push(['ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑÿµÿ®ÿßÿ≠Ÿäÿ©', morningShops]);
    ws_data.push(['ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÖÿ≥ÿßÿ¶Ÿäÿ©', eveningShops]);
    ws_data.push(['ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑÿπÿ∑ŸÑÿ©', weekendShops]);
    ws_data.push(['ÿ£ŸäÿßŸÖ ÿßŸÑÿπŸÖŸÑ', rows.length]);
    ws_data.push([]);
    
    // Add detailed breakdown header
    ws_data.push(['ÿßŸÑÿ™ŸÅÿµŸäŸÑ ÿßŸÑŸäŸàŸÖŸä']);
    ws_data.push(['ÿßŸÑÿ™ÿßÿ±ŸäÿÆ', 'ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©', 'ŸàŸÇÿ™ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©', 'ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™', 'ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ≠ŸÑÿßÿ™']);
    
    // Add daily details
    rows.forEach(r => {
        const shopsCount = r.shops ? r.shops.length : 0;
        const shopNames = r.shops ? r.shops.join(', ') : '';
        ws_data.push([r.day, r.area, r.shift, shopsCount, shopNames]);
    });
    
    ws_data.push([]);
    ws_data.push(['ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿ∫ÿ∑ÿßÿ©']);
    areasVisited.forEach(area => {
        const areaInspections = rows.filter(r => r.area === area).reduce((sum, r) => sum + (r.shops ? r.shops.length : 0), 0);
        ws_data.push([area, areaInspections]);
    });
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    
    // Set column widths
    ws['!cols'] = [
        {wch: 15}, {wch: 20}, {wch: 15}, {wch: 15}, {wch: 50}
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, "ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥");
    XLSX.writeFile(wb, `ÿ™ŸÇÿ±Ÿäÿ±_${selectedInspector}_${new Date().toISOString().split('T')[0]}.xlsx`);
}

function showMonthlyReport() {
    let allDays = Array.from(new Set(inspectionData.map(r => r.day))).sort();
    
    // Calculate totals
    let totals = { 
        total: 0, 
        morning: 0, 
        evening: 0, 
        weekend: 0, 
        days: Array(allDays.length).fill(0),
        inspectors: inspectorsData.length,
        areas: new Set(),
        uniqueShops: new Set()
    };
    
    let html = `<div class="pdf-title-arabic" id="monthlyReportTitle">ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¥Ÿáÿ±Ÿä</div>`;
    
    // Add summary statistics
    html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">`;
    
    // Calculate overall statistics
    inspectionData.forEach(item => {
        totals.areas.add(getAreaName(item.area));
        if (item.shops) {
            item.shops.forEach(shop => totals.uniqueShops.add(shop));
        }
    });
    
    html += `
        <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; text-align: center;">
            <strong style="color: #1976d2; font-size: 1.1em;">${inspectionData.length}</strong>
            <div style="font-size: 0.8em; color: #666;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™</div>
        </div>
        <div style="background: #e8f5e8; padding: 12px; border-radius: 8px; text-align: center;">
            <strong style="color: #388e3c; font-size: 1.1em;">${totals.uniqueShops.size}</strong>
            <div style="font-size: 0.8em; color: #666;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ© ÿßŸÑÿ™Ÿä ÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß</div>
        </div>
        <div style="background: #fff3e0; padding: 12px; border-radius: 8px; text-align: center;">
            <strong style="color: #f57c00; font-size: 1.1em;">${totals.areas.size}</strong>
            <div style="font-size: 0.8em; color: #666;">ŸÖŸÜÿ∑ŸÇÿ© ŸÖÿ∫ÿ∑ÿßÿ©</div>
        </div>
        <div style="background: #fce4ec; padding: 12px; border-radius: 8px; text-align: center;">
            <strong style="color: #c2185b; font-size: 1.1em;">${totals.inspectors}</strong>
            <div style="font-size: 0.8em; color: #666;">ŸÖŸÅÿ™ÿ¥ ŸÜÿ¥ÿ∑</div>
        </div>
    </div>`;
    
    html += `<table class="stats-table" id="monthlyStatsTable">
        <thead>
            <tr>
                <th style="min-width: 120px;">ÿßŸÑŸÖŸÅÿ™ÿ¥</th>`;
    
    allDays.forEach(day => {
        const dayName = new Date(day).toLocaleDateString('ar', { weekday: 'short' });
        html += `<th style="min-width: 80px;">${day}<br><small style="font-size: 0.7em;">${dayName}</small></th>`;
    });
    
    html += `<th style="background: #2196f3;">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
             <th style="background: #4caf50;">ÿßŸÑÿµÿ®ÿßÿ≠Ÿäÿ©</th>
             <th style="background: #ff9800;">ÿßŸÑŸÖÿ≥ÿßÿ¶Ÿäÿ©</th>
             <th style="background: #e91e63;">ÿßŸÑÿπÿ∑ŸÑÿ©</th>
             <th style="background: #9c27b0;">ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</th>
             <th style="background: #607d8b;">ÿßŸÑŸÉŸÅÿßÿ°ÿ©</th>
             </tr>
        </thead>
        <tbody>`;
    
    inspectors.forEach(inspector => {
        const rows = inspectionData.filter(item => item.inspector === inspector);
        const inspectorAreas = new Set(rows.map(r => r.area));
        
        html += `<tr><td style="font-weight: bold; text-align: right;">${inspector}</td>`;
        
        // Daily columns
        allDays.forEach((day, i) => {
            let dayRows = rows.filter(r => r.day === day);
            let shopsCount = 0;
            dayRows.forEach(row => {
                shopsCount += row.shops ? row.shops.length : 0;
            });
            
            let cellStyle = '';
            if (shopsCount > 0) {
                if (shopsCount >= 7) cellStyle = 'background: #c8e6c9; font-weight: bold;';
                else if (shopsCount >= 5) cellStyle = 'background: #fff9c4;';
                else cellStyle = 'background: #ffcdd2;';
            }
            
            html += `<td style="${cellStyle}">${shopsCount || ''}</td>`;
            totals.days[i] += shopsCount;
        });
        
        // Calculate totals for this inspector
        let totalShops = 0;
        let morningShops = 0;
        let eveningShops = 0;
        let weekendShops = 0;
        
        rows.forEach(r => {
            const shopsCount = r.shops ? r.shops.length : 0;
            totalShops += shopsCount;
            
            if (r.shift === "ÿµÿ®ÿßÿ≠Ÿäÿ©") {
                morningShops += shopsCount;
            } else if (r.shift === "ŸÖÿ≥ÿßÿ¶Ÿäÿ©") {
                eveningShops += shopsCount;
            }
            
            const dow = new Date(r.day).getDay();
            if ([5,6,0].includes(dow)) {
                weekendShops += shopsCount;
            }
        });
        
        // Calculate efficiency (shops per working day)
        const workingDays = rows.length;
        const efficiency = workingDays > 0 ? (totalShops / workingDays).toFixed(1) : '0';
        
        html += `<td style="font-weight: bold; background: #e3f2fd;">${totalShops}</td>
                 <td style="color: #4caf50;">${morningShops}</td>
                 <td style="color: #ff9800;">${eveningShops}</td>
                 <td style="color: #e91e63;">${weekendShops}</td>
                 <td style="color: #9c27b0;">${inspectorAreas.size}</td>
                 <td style="color: #607d8b; font-weight: bold;">${efficiency}</td>
                 </tr>`;
        
        totals.total += totalShops;
        totals.morning += morningShops;
        totals.evening += eveningShops;
        totals.weekend += weekendShops;
    });
    
    // Add totals row
    html += `<tr class="red-total" style="background: #ffeb3b; font-weight: bold;">
        <td style="font-weight: bold;">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</td>`;
    
    totals.days.forEach(sum => html += `<td>${sum}</td>`);
    
    const overallEfficiency = inspectors.length > 0 ? (totals.total / inspectors.length).toFixed(1) : '0';
    
    html += `<td style="background: #2196f3; color: white;">${totals.total}</td>
             <td style="background: #4caf50; color: white;">${totals.morning}</td>
             <td style="background: #ff9800; color: white;">${totals.evening}</td>
             <td style="background: #e91e63; color: white;">${totals.weekend}</td>
             <td style="background: #9c27b0; color: white;">${totals.areas.size}</td>
             <td style="background: #607d8b; color: white;">${overallEfficiency}</td>
             </tr>`;
    
    html += `</tbody></table>`;
    
    // Add performance analysis
    html += `
    <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <h4 style="color: #234085; margin-bottom: 10px;">ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ£ÿØÿßÿ°</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 0.9em;">
            <div>
                <strong>ÿ£ÿπŸÑŸâ ÿ£ÿØÿßÿ° ŸäŸàŸÖŸä:</strong><br>
                ${Math.max(...totals.days)} ÿ™ŸÅÿ™Ÿäÿ¥ ŸÅŸä ${allDays[totals.days.indexOf(Math.max(...totals.days))]}
            </div>
            <div>
                <strong>ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸäŸàŸÖŸä:</strong><br>
                ${(totals.days.reduce((a, b) => a + b, 0) / totals.days.length).toFixed(1)} ÿ™ŸÅÿ™Ÿäÿ¥/ŸäŸàŸÖ
            </div>
            <div>
                <strong>ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿµÿ®ÿßÿ≠Ÿä:</strong><br>
                ${totals.total > 0 ? ((totals.morning / totals.total) * 100).toFixed(1) : 0}%
            </div>
            <div>
                <strong>ŸÜÿ≥ÿ®ÿ© ÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿπÿ∑ŸÑÿ©:</strong><br>
                ${totals.total > 0 ? ((totals.weekend / totals.total) * 100).toFixed(1) : 0}%
            </div>
        </div>
    </div>`;
    
    document.getElementById('monthlyReportContent').innerHTML = html;
    document.getElementById('monthlyReportModal').style.display = 'flex';
}
function closeMonthlyReportModal() {
    document.getElementById('monthlyReportModal').style.display = 'none';
}

// ============================================================================
// Inspector Details Modal Functions - Ÿàÿ∏ÿßÿ¶ŸÅ ŸÖŸàÿØÿßŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿßŸÑÿ¥ÿßŸÖŸÑ
// ============================================================================

let currentInspectorDetails = {
    name: '',
    currentTab: 'inspections'
};

function showInspectorDetailsModal(inspectorName) {
    if (!inspectorName) {
        alert("ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ŸÖŸÅÿ™ÿ¥");
        return;
    }
    
    currentInspectorDetails.name = inspectorName;
    currentInspectorDetails.currentTab = 'inspections';
    
    // Update modal title
    document.getElementById('inspectorDetailsTitle').textContent = `üë§ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿßŸÑÿ¥ÿßŸÖŸÑÿ©: ${inspectorName}`;
    
    // Generate quick stats
    generateInspectorQuickStats(inspectorName);
    
    // Show inspections tab by default
    showInspectorTab('inspections');
    
    // Display modal
    document.getElementById('inspectorDetailsModal').style.display = 'flex';
}

function closeInspectorDetailsModal() {
    document.getElementById('inspectorDetailsModal').style.display = 'none';
    currentInspectorDetails = { name: '', currentTab: 'inspections' };
}

function generateInspectorQuickStats(inspectorName) {
    const inspectorData = inspectionData.filter(item => item.inspector === inspectorName);
    
    if (inspectorData.length === 0) {
        document.getElementById('inspectorQuickStats').innerHTML = '<p style="text-align:center;color:#666;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸÅÿ™ÿ¥</p>';
        return;
    }
    
    // Calculate stats
    const today = new Date().toLocaleDateString('en-CA');
    const pastInspections = inspectorData.filter(item => item.day < today);
    const todayInspections = inspectorData.filter(item => item.day === today);
    const futureInspections = inspectorData.filter(item => item.day > today);
    
    let totalShops = 0;
    let uniqueShops = new Set();
    let uniqueAreas = new Set();
    
    inspectorData.forEach(item => {
        if (item.shops) {
            totalShops += item.shops.length;
            item.shops.forEach(shop => uniqueShops.add(shop));
        }
        uniqueAreas.add(item.area);
    });
    
    const html = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; text-align: center; color: #fff; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
            <h3 style="margin: 0 0 10px 0; font-size: 1.5em;">üìä ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</h3>
            <div style="font-size: 2.5em; font-weight: bold;">${inspectorData.length}</div>
        </div>
        
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; text-align: center; color: #fff; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);">
            <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">‚úÖ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿ≥ÿßÿ®ŸÇÿ©</h3>
            <div style="font-size: 2em; font-weight: bold;">${pastInspections.length}</div>
        </div>
        
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px; text-align: center; color: #fff; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);">
            <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">üìÖ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸäŸàŸÖ</h3>
            <div style="font-size: 2em; font-weight: bold;">${todayInspections.length}</div>
        </div>
        
        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 10px; text-align: center; color: #fff; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
            <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">üîú ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÇÿßÿØŸÖÿ©</h3>
            <div style="font-size: 2em; font-weight: bold;">${futureInspections.length}</div>
        </div>
        
        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 10px; text-align: center; color: #fff; box-shadow: 0 4px 15px rgba(250, 112, 154, 0.3);">
            <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">üè™ ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</h3>
            <div style="font-size: 2em; font-weight: bold;">${totalShops}</div>
        </div>
        
        <div style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); padding: 20px; border-radius: 10px; text-align: center; color: #fff; box-shadow: 0 4px 15px rgba(48, 207, 208, 0.3);">
            <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">üè™ ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ©</h3>
            <div style="font-size: 2em; font-weight: bold;">${uniqueShops.size}</div>
        </div>
        
        <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 10px; text-align: center; color: #234085; box-shadow: 0 4px 15px rgba(168, 237, 234, 0.3);">
            <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">üìç ŸÖŸÜÿßÿ∑ŸÇ ŸÖÿ∫ÿ∑ÿßÿ©</h3>
            <div style="font-size: 2em; font-weight: bold;">${uniqueAreas.size}</div>
        </div>
    `;
    
    document.getElementById('inspectorQuickStats').innerHTML = html;
}

function showInspectorTab(tabName) {
    currentInspectorDetails.currentTab = tabName;
    const inspectorName = currentInspectorDetails.name;
    
    // Update tab button styles
    const buttons = document.querySelectorAll('.inspector-tab-btn');
    buttons.forEach(btn => {
        if (btn.getAttribute('data-tab') === tabName) {
            btn.style.background = '#234085';
            btn.style.color = '#fff';
            btn.classList.add('active');
        } else {
            btn.style.background = '#e0e6f0';
            btn.style.color = '#234085';
            btn.classList.remove('active');
        }
    });
    
    // Generate content based on tab
    let content = '';
    
    switch(tabName) {
        case 'inspections':
            content = generateInspectorInspectionsTab(inspectorName);
            break;
        case 'report':
            content = generateInspectorReportTab(inspectorName);
            break;
        case 'statistics':
            content = generateInspectorStatisticsTab(inspectorName);
            break;
        case 'analytics':
            content = generateInspectorAnalyticsTab(inspectorName);
            break;
    }
    
    document.getElementById('inspectorTabContent').innerHTML = content;
}

function generateInspectorInspectionsTab(inspectorName) {
    const inspectorData = inspectionData.filter(item => item.inspector === inspectorName);
    
    if (inspectorData.length === 0) {
        return '<p style="text-align:center;color:#666;padding:30px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸÅÿ™ÿ¥</p>';
    }
    
    // Sort by date
    const sortedData = inspectorData.sort((a, b) => a.day.localeCompare(b.day));
    
    const today = new Date().toLocaleDateString('en-CA');
    const pastInspections = sortedData.filter(item => item.day < today);
    const todayInspections = sortedData.filter(item => item.day === today);
    const futureInspections = sortedData.filter(item => item.day > today);
    
    let html = '<div style="padding: 10px;">';
    
    // Future Inspections
    if (futureInspections.length > 0) {
        html += `
            <div style="margin-bottom: 30px;">
                <h3 style="color: #28a745; border-bottom: 3px solid #28a745; padding-bottom: 10px; margin-bottom: 15px;">
                    üîú ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸÇÿßÿØŸÖÿ© (${futureInspections.length})
                </h3>
                <div style="display: grid; gap: 15px;">
        `;
        
        futureInspections.forEach(item => {
            const shopsCount = item.shops ? item.shops.length : 0;
            const shopsList = item.shops ? item.shops.join('ÿå ') : 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™';
            const dayName = getArabicDayName(item.day);
            
            html += `
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                        <div><strong>üìÖ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:</strong> ${item.day} (${dayName})</div>
                        <div><strong>‚è∞ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©:</strong> ${item.shift}</div>
                        <div><strong>üìç ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:</strong> ${getAreaName(item.area)}</div>
                        <div><strong>üè™ ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™:</strong> ${shopsCount}</div>
                    </div>
                    <div style="background: #fff; padding: 10px; border-radius: 4px; margin-top: 10px;">
                        <strong>ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™:</strong><br>
                        <span style="color: #666;">${shopsList}</span>
                    </div>
                </div>
            `;
        });
        
        html += `</div></div>`;
    }
    
    // Today's Inspections
    if (todayInspections.length > 0) {
        html += `
            <div style="margin-bottom: 30px;">
                <h3 style="color: #007bff; border-bottom: 3px solid #007bff; padding-bottom: 10px; margin-bottom: 15px;">
                    üìÖ ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑŸäŸàŸÖ (${todayInspections.length})
                </h3>
                <div style="display: grid; gap: 15px;">
        `;
        
        todayInspections.forEach(item => {
            const shopsCount = item.shops ? item.shops.length : 0;
            const shopsList = item.shops ? item.shops.join('ÿå ') : 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™';
            
            html += `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                        <div><strong>‚è∞ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©:</strong> ${item.shift}</div>
                        <div><strong>üìç ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:</strong> ${getAreaName(item.area)}</div>
                        <div><strong>üè™ ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™:</strong> ${shopsCount}</div>
                    </div>
                    <div style="background: #fff; padding: 10px; border-radius: 4px; margin-top: 10px;">
                        <strong>ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™:</strong><br>
                        <span style="color: #666;">${shopsList}</span>
                    </div>
                </div>
            `;
        });
        
        html += `</div></div>`;
    }
    
    // Past Inspections
    if (pastInspections.length > 0) {
        html += `
            <div style="margin-bottom: 30px;">
                <h3 style="color: #6c757d; border-bottom: 3px solid #6c757d; padding-bottom: 10px; margin-bottom: 15px;">
                    ‚úÖ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© (${pastInspections.length})
                </h3>
                <div style="display: grid; gap: 15px;">
        `;
        
        // Show only last 20 past inspections to avoid overwhelming the display
        const recentPast = pastInspections.slice(-20).reverse();
        
        recentPast.forEach(item => {
            const shopsCount = item.shops ? item.shops.length : 0;
            const shopsList = item.shops ? item.shops.join('ÿå ') : 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™';
            const dayName = getArabicDayName(item.day);
            
            html += `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #6c757d;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                        <div><strong>üìÖ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:</strong> ${item.day} (${dayName})</div>
                        <div><strong>‚è∞ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©:</strong> ${item.shift}</div>
                        <div><strong>üìç ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:</strong> ${getAreaName(item.area)}</div>
                        <div><strong>üè™ ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™:</strong> ${shopsCount}</div>
                    </div>
                    <div style="background: #fff; padding: 10px; border-radius: 4px; margin-top: 10px;">
                        <strong>ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™:</strong><br>
                        <span style="color: #666;">${shopsList}</span>
                    </div>
                </div>
            `;
        });
        
        if (pastInspections.length > 20) {
            html += `<p style="text-align:center;color:#666;font-style:italic;">ÿπÿ±ÿ∂ ÿ¢ÿÆÿ± 20 ÿ™ŸÅÿ™Ÿäÿ¥ ŸÖŸÜ ÿ£ÿµŸÑ ${pastInspections.length} ÿ™ŸÅÿ™Ÿäÿ¥ ÿ≥ÿßÿ®ŸÇ</p>`;
        }
        
        html += `</div></div>`;
    }
    
    html += '</div>';
    return html;
}

function generateInspectorReportTab(inspectorName) {
    // Reuse the existing inspector report generation logic
    const rows = inspectionData.filter(item => item.inspector === inspectorName);
    
    if (rows.length === 0) {
        return '<p style="text-align:center;color:#666;padding:30px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸÅÿ™ÿ¥</p>';
    }
    
    // Calculate comprehensive statistics
    let totalShops = 0;
    let morningShops = 0;
    let eveningShops = 0;
    let weekendShops = 0;
    let totalDays = 0;
    let areasVisited = new Set();
    let shopsList = new Set();
    let dailyStats = {};
    
    rows.forEach(r => {
        const shopsCount = r.shops ? r.shops.length : 0;
        totalShops += shopsCount;
        totalDays++;
        areasVisited.add(r.area);
        
        if (r.shops) {
            r.shops.forEach(shop => shopsList.add(shop));
        }
        
        if (!dailyStats[r.day]) {
            dailyStats[r.day] = { shops: 0, shift: r.shift, area: r.area };
        }
        dailyStats[r.day].shops += shopsCount;
        
        if (r.shift === "ÿµÿ®ÿßÿ≠Ÿäÿ©") {
            morningShops += shopsCount;
        } else if (r.shift === "ŸÖÿ≥ÿßÿ¶Ÿäÿ©") {
            eveningShops += shopsCount;
        }
        
        const dayOfWeek = new Date(r.day).getDay();
        if ([5,6,0].includes(dayOfWeek)) {
            weekendShops += shopsCount;
        }
    });
    
    const averageShopsPerDay = totalDays > 0 ? (totalShops / totalDays).toFixed(1) : 0;
    const uniqueShopsCount = shopsList.size;
    
    let html = `
    <div style="padding: 20px;">
        <!-- Summary Statistics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #2196f3;">
                <h4 style="margin: 0; color: #1976d2;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</h4>
                <span style="font-size: 1.5em; font-weight: bold; color: #1976d2;">${totalShops}</span>
            </div>
            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #4caf50;">
                <h4 style="margin: 0; color: #388e3c;">ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ©</h4>
                <span style="font-size: 1.5em; font-weight: bold; color: #388e3c;">${uniqueShopsCount}</span>
            </div>
            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #ff9800;">
                <h4 style="margin: 0; color: #f57c00;">ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸäŸàŸÖŸäÿßŸã</h4>
                <span style="font-size: 1.5em; font-weight: bold; color: #f57c00;">${averageShopsPerDay}</span>
            </div>
            <div style="background: #fce4ec; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #e91e63;">
                <h4 style="margin: 0; color: #c2185b;">ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ</h4>
                <span style="font-size: 1.5em; font-weight: bold; color: #c2185b;">${totalDays}</span>
            </div>
        </div>
        
        <!-- Shift Statistics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                <h4 style="margin: 0; color: #2e7d32;">ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿµÿ®ÿßÿ≠Ÿäÿ©</h4>
                <span style="font-size: 1.5em; font-weight: bold; color: #2e7d32;">${morningShops}</span>
            </div>
            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                <h4 style="margin: 0; color: #ef6c00;">ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÖÿ≥ÿßÿ¶Ÿäÿ©</h4>
                <span style="font-size: 1.5em; font-weight: bold; color: #ef6c00;">${eveningShops}</span>
            </div>
            <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; text-align: center;">
                <h4 style="margin: 0; color: #7b1fa2;">ÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÜŸáÿßŸäÿ© ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</h4>
                <span style="font-size: 1.5em; font-weight: bold; color: #7b1fa2;">${weekendShops}</span>
            </div>
            <div style="background: #e1f5fe; padding: 15px; border-radius: 8px; text-align: center;">
                <h4 style="margin: 0; color: #0277bd;">ÿπÿØÿØ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</h4>
                <span style="font-size: 1.5em; font-weight: bold; color: #0277bd;">${areasVisited.size}</span>
            </div>
        </div>
        
        <!-- Detailed Table -->
        <h3 style="color: #234085; border-bottom: 2px solid #234085; padding-bottom: 10px; margin-top: 30px;">ÿ¨ÿØŸàŸÑ ÿ™ŸÅÿµŸäŸÑŸä ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</h3>
        <div style="overflow-x: auto;">
            <table class="stats-table" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr style="background: #234085; color: #fff;">
                        <th style="padding: 12px; border: 1px solid #ddd;">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">ÿßŸÑŸäŸàŸÖ</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    rows.sort((a, b) => a.day.localeCompare(b.day)).forEach(r => {
        const dayName = getArabicDayName(r.day);
        const shopsCount = r.shops ? r.shops.length : 0;
        const shopsList = r.shops ? r.shops.join('ÿå ') : 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™';
        
        html += `
            <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${r.day}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${dayName}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                    <span style="background: ${r.shift === 'ÿµÿ®ÿßÿ≠Ÿäÿ©' ? '#e8f5e9' : '#fff3e0'}; color: ${r.shift === 'ÿµÿ®ÿßÿ≠Ÿäÿ©' ? '#2e7d32' : '#ef6c00'}; padding: 4px 8px; border-radius: 4px;">
                        ${r.shift}
                    </span>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">${getAreaName(r.area)}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${shopsCount}</td>
                <td style="padding: 10px; border: 1px solid #ddd; font-size: 0.9em;">${shopsList}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    </div>
    `;
    
    return html;
}

function generateInspectorStatisticsTab(inspectorName) {
    // Filter data for this inspector
    const inspectorData = inspectionData.filter(item => item.inspector === inspectorName);
    
    if (inspectorData.length === 0) {
        return '<p style="text-align:center;color:#666;padding:30px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸÅÿ™ÿ¥</p>';
    }
    
    // Use the smart stats generation logic
    const stats = generateSmartMonthlyStats(inspectorData);
    
    let html = '<div style="padding: 20px;">';
    
    // Overview Statistics
    html += `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: #fff; text-align: center;">
                <h4 style="margin: 0 0 10px 0;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™</h4>
                <div style="font-size: 2em; font-weight: bold;">${stats.totalInspections}</div>
            </div>
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: #fff; text-align: center;">
                <h4 style="margin: 0 0 10px 0;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</h4>
                <div style="font-size: 2em; font-weight: bold;">${stats.totalShops}</div>
            </div>
            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px; color: #fff; text-align: center;">
                <h4 style="margin: 0 0 10px 0;">ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ©</h4>
                <div style="font-size: 2em; font-weight: bold;">${stats.uniqueShops.size}</div>
            </div>
            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 10px; color: #fff; text-align: center;">
                <h4 style="margin: 0 0 10px 0;">ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸäŸàŸÖŸäÿßŸã</h4>
                <div style="font-size: 2em; font-weight: bold;">${stats.averageShopsPerDay.toFixed(1)}</div>
            </div>
        </div>
    `;
    
    // Shift Distribution
    html += `
        <h3 style="color: #234085; border-bottom: 2px solid #234085; padding-bottom: 10px; margin-bottom: 15px;">
            ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 25px;">
            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
                <h4 style="margin: 0 0 10px 0; color: #2e7d32;">ŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿµÿ®ÿßÿ≠Ÿäÿ©</h4>
                <div style="font-size: 1.8em; font-weight: bold; color: #2e7d32;">${stats.shiftStats.morning}</div>
            </div>
            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
                <h4 style="margin: 0 0 10px 0; color: #ef6c00;">ŸÖŸÜÿßŸàÿ®ÿßÿ™ ŸÖÿ≥ÿßÿ¶Ÿäÿ©</h4>
                <div style="font-size: 1.8em; font-weight: bold; color: #ef6c00;">${stats.shiftStats.evening}</div>
            </div>
        </div>
    `;
    
    // Area Statistics
    html += `
        <h3 style="color: #234085; border-bottom: 2px solid #234085; padding-bottom: 10px; margin-bottom: 15px;">
            ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
        </h3>
        <div style="overflow-x: auto; margin-bottom: 25px;">
            <table class="stats-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #234085; color: #fff;">
                        <th style="padding: 12px; border: 1px solid #ddd;">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">ÿπÿØÿØ ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ÿ©</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    Object.entries(stats.areaStats).forEach(([area, data]) => {
        html += `
            <tr>
                <td style="padding: 10px; border: 1px solid #ddd;">${getAreaName(area)}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${data.visits}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${data.shops}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    // Most inspected shops
    const shopStatsArray = Object.entries(stats.shopStats).sort((a, b) => b[1] - a[1]).slice(0, 10);
    
    if (shopStatsArray.length > 0) {
        html += `
            <h3 style="color: #234085; border-bottom: 2px solid #234085; padding-bottom: 10px; margin-bottom: 15px;">
                ÿ£ŸÉÿ´ÿ± 10 ŸÖÿ≠ŸÑÿßÿ™ ÿ™ŸÅÿ™Ÿäÿ¥ÿßŸã
            </h3>
            <div style="overflow-x: auto; margin-bottom: 25px;">
                <table class="stats-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #234085; color: #fff;">
                            <th style="padding: 12px; border: 1px solid #ddd;">ÿßŸÑŸÖÿ≠ŸÑ</th>
                            <th style="padding: 12px; border: 1px solid #ddd;">ÿπÿØÿØ ŸÖÿ±ÿßÿ™ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        shopStatsArray.forEach(([shop, count]) => {
            html += `
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">${shop}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #234085;">${count}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    html += '</div>';
    return html;
}

function generateInspectorAnalyticsTab(inspectorName) {
    const inspectorData = inspectionData.filter(item => item.inspector === inspectorName);
    
    if (inspectorData.length === 0) {
        return '<p style="text-align:center;color:#666;padding:30px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸÅÿ™ÿ¥</p>';
    }
    
    let html = '<div style="padding: 20px;">';
    
    // Monthly breakdown
    const monthlyData = {};
    inspectorData.forEach(item => {
        const month = item.day.substring(0, 7); // YYYY-MM
        if (!monthlyData[month]) {
            monthlyData[month] = {
                inspections: 0,
                shops: 0,
                areas: new Set(),
                morningShifts: 0,
                eveningShifts: 0
            };
        }
        monthlyData[month].inspections++;
        if (item.shops) {
            monthlyData[month].shops += item.shops.length;
        }
        monthlyData[month].areas.add(item.area);
        if (item.shift === 'ÿµÿ®ÿßÿ≠Ÿäÿ©') monthlyData[month].morningShifts++;
        if (item.shift === 'ŸÖÿ≥ÿßÿ¶Ÿäÿ©') monthlyData[month].eveningShifts++;
    });
    
    html += `
        <h3 style="color: #234085; border-bottom: 2px solid #234085; padding-bottom: 10px; margin-bottom: 15px;">
            üìä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ¥Ÿáÿ±Ÿä
        </h3>
        <div style="overflow-x: auto; margin-bottom: 25px;">
            <table class="stats-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #234085; color: #fff;">
                        <th style="padding: 12px; border: 1px solid #ddd;">ÿßŸÑÿ¥Ÿáÿ±</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ÿ©</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">ÿµÿ®ÿßÿ≠Ÿäÿ©</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">ŸÖÿ≥ÿßÿ¶Ÿäÿ©</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    Object.entries(monthlyData).sort((a, b) => b[0].localeCompare(a[0])).forEach(([month, data]) => {
        const [year, monthNum] = month.split('-');
        const monthName = getMonthName(monthNum);
        
        html += `
            <tr>
                <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${monthName} ${year}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${data.inspections}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${data.shops}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${data.areas.size}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background: #e8f5e9;">${data.morningShifts}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; background: #fff3e0;">${data.eveningShifts}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    // Performance metrics
    const totalShops = inspectorData.reduce((sum, item) => sum + (item.shops ? item.shops.length : 0), 0);
    const uniqueDays = new Set(inspectorData.map(item => item.day)).size;
    const avgShopsPerDay = (totalShops / uniqueDays).toFixed(2);
    const uniqueShops = new Set();
    inspectorData.forEach(item => {
        if (item.shops) item.shops.forEach(shop => uniqueShops.add(shop));
    });
    const shopCoverage = ((uniqueShops.size / totalShops) * 100).toFixed(1);
    
    html += `
        <h3 style="color: #234085; border-bottom: 2px solid #234085; padding-bottom: 10px; margin-bottom: 15px;">
            üìà ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑÿ£ÿØÿßÿ°
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 25px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: #fff;">
                <h4 style="margin: 0 0 10px 0;">ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸäŸàŸÖŸäÿßŸã</h4>
                <div style="font-size: 2em; font-weight: bold;">${avgShopsPerDay}</div>
            </div>
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: #fff;">
                <h4 style="margin: 0 0 10px 0;">ŸÜÿ≥ÿ®ÿ© ÿ™ŸÜŸàÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</h4>
                <div style="font-size: 2em; font-weight: bold;">${shopCoverage}%</div>
            </div>
            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px; color: #fff;">
                <h4 style="margin: 0 0 10px 0;">ÿ£ŸäÿßŸÖ ÿßŸÑÿπŸÖŸÑ</h4>
                <div style="font-size: 2em; font-weight: bold;">${uniqueDays}</div>
            </div>
        </div>
    `;
    
    // Day of week analysis
    const dayOfWeekData = {};
    const daysAr = ['ÿßŸÑÿ£ÿ≠ÿØ', 'ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ', 'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°', 'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°', 'ÿßŸÑÿÆŸÖŸäÿ≥', 'ÿßŸÑÿ¨ŸÖÿπÿ©', 'ÿßŸÑÿ≥ÿ®ÿ™'];
    daysAr.forEach(day => dayOfWeekData[day] = 0);
    
    inspectorData.forEach(item => {
        const date = new Date(item.day);
        const dayIndex = date.getDay();
        const dayName = daysAr[dayIndex];
        dayOfWeekData[dayName]++;
    });
    
    html += `
        <h3 style="color: #234085; border-bottom: 2px solid #234085; padding-bottom: 10px; margin-bottom: 15px;">
            üìÖ ÿ™Ÿàÿ≤Ÿäÿπ ÿ£ŸäÿßŸÖ ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 25px;">
    `;
    
    Object.entries(dayOfWeekData).forEach(([day, count]) => {
        html += `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #e0e6f0;">
                <h5 style="margin: 0 0 8px 0; color: #234085;">${day}</h5>
                <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">${count}</div>
            </div>
        `;
    });
    
    html += `
        </div>
    `;
    
    html += '</div>';
    return html;
}

// Export functions for inspector details
function exportInspectorDetailsToPDF() {
    const inspectorName = currentInspectorDetails.name;
    if (!inspectorName) return;
    
    alert('ÿ™ÿµÿØŸäÿ± ÿ¨ŸÖŸäÿπ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿ•ŸÑŸâ PDF - ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±');
    // This would generate a comprehensive PDF with all tabs
}

function exportInspectorDetailsToExcel() {
    const inspectorName = currentInspectorDetails.name;
    if (!inspectorName) return;
    
    alert('ÿ™ÿµÿØŸäÿ± ÿ¨ŸÖŸäÿπ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿ•ŸÑŸâ Excel - ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±');
    // This would generate a comprehensive Excel file with multiple sheets
}

// ============================================================================
// End of Inspector Details Modal Functions
// ============================================================================

function exportMonthlyReportToPDF() {
    let reportContent = document.getElementById('monthlyReportContent');
    if (!reportContent) return;
    
    let wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '20px';
    wrap.style.fontFamily = 'Cairo, Arial, sans-serif';
    wrap.style.width = 'auto';
    wrap.style.minWidth = '1000px';
    wrap.style.maxWidth = '1200px';
    
    let contentClone = reportContent.cloneNode(true);
    
    // Style elements for better PDF rendering
    const tables = contentClone.querySelectorAll('table');
    tables.forEach(table => {
        table.style.fontSize = '8px';
        table.style.marginBottom = '15px';
        
        const ths = table.querySelectorAll('th');
        ths.forEach(th => {
            th.style.padding = '6px 4px';
            th.style.fontSize = '8px';
            th.style.fontWeight = 'bold';
        });
        
        const tds = table.querySelectorAll('td');
        tds.forEach(td => {
            td.style.padding = '5px 3px';
            td.style.fontSize = '7px';
            td.style.wordBreak = 'break-word';
        });
    });
    
    // Style summary cards
    const summaryDivs = contentClone.querySelectorAll('[style*="grid-template-columns"]');
    summaryDivs.forEach(div => {
        div.style.fontSize = '9px';
        const children = div.querySelectorAll('div');
        children.forEach(child => {
            child.style.padding = '8px';
            child.style.fontSize = '8px';
        });
    });
    
    // Style analysis section
    const h4Elements = contentClone.querySelectorAll('h4');
    h4Elements.forEach(h4 => {
        h4.style.fontSize = '11px';
        h4.style.marginBottom = '8px';
    });
    
    const smallElements = contentClone.querySelectorAll('small');
    smallElements.forEach(small => {
        small.style.fontSize = '6px';
    });
    
    wrap.appendChild(contentClone);
    document.body.appendChild(wrap);
    
    html2canvas(wrap, {
        backgroundColor: '#fff', 
        scale: 1.0,
        useCORS: true,
        allowTaint: true,
        width: wrap.scrollWidth,
        height: wrap.scrollHeight
    }).then(function(canvas) {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation: "landscape", unit: "pt", format: "a4"});
        
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const imgProps = doc.getImageProperties(imgData);
        
        let pdfWidth = pageWidth - 40;
        let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        // Handle multiple pages if content is too tall
        if (pdfHeight > pageHeight - 40) {
            // Scale to fit page width, then handle multiple pages
            const pages = Math.ceil(pdfHeight / (pageHeight - 40));
            const pageContentHeight = (pageHeight - 40);
            
            for (let i = 0; i < pages; i++) {
                if (i > 0) {
                    doc.addPage();
                }
                
                const sourceY = (i * pageContentHeight * imgProps.height) / pdfHeight;
                const sourceHeight = Math.min(
                    (pageContentHeight * imgProps.height) / pdfHeight,
                    imgProps.height - sourceY
                );
                
                // Create page canvas
                const pageCanvas = document.createElement('canvas');
                pageCanvas.width = imgProps.width;
                pageCanvas.height = sourceHeight;
                const pageCtx = pageCanvas.getContext('2d');
                
                const img = new Image();
                img.onload = function() {
                    pageCtx.drawImage(canvas, 0, sourceY, imgProps.width, sourceHeight, 0, 0, imgProps.width, sourceHeight);
                    const pageImgData = pageCanvas.toDataURL('image/png');
                    const pageImgHeight = (sourceHeight * pdfWidth) / imgProps.width;
                    doc.addImage(pageImgData, 'PNG', 20, 20, pdfWidth, pageImgHeight);
                    
                    if (i === pages - 1) {
                        doc.save(`ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑÿ¥Ÿáÿ±Ÿä_${new Date().toISOString().split('T')[0]}.pdf`);
                        document.body.removeChild(wrap);
                    }
                };
                img.src = canvas.toDataURL('image/png');
            }
        } else {
            doc.addImage(imgData, 'PNG', 20, 20, pdfWidth, pdfHeight);
            doc.save(`ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑÿ¥Ÿáÿ±Ÿä_${new Date().toISOString().split('T')[0]}.pdf`);
            document.body.removeChild(wrap);
        }
        
    }).catch(function(error) {
        console.error('PDF generation error:', error);
        document.body.removeChild(wrap);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± ŸÖŸÑŸÅ PDF');
    });
}
function exportMonthlyReportToExcel() {
    let allDays = Array.from(new Set(inspectionData.map(r => r.day))).sort();
    let ws_data = [];
    
    // Add title and summary
    ws_data.push(['ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¥Ÿáÿ±Ÿä']);
    ws_data.push([]);
    
    // Calculate overall statistics 
    let totals = { 
        total: 0, 
        morning: 0, 
        evening: 0, 
        weekend: 0, 
        areas: new Set(),
        uniqueShops: new Set()
    };
    
    inspectionData.forEach(item => {
        totals.areas.add(getAreaName(item.area));
        if (item.shops) {
            item.shops.forEach(shop => totals.uniqueShops.add(shop));
        }
    });
    
    // Add summary statistics
    ws_data.push(['ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©']);
    ws_data.push(['ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™', inspectionData.length]);
    ws_data.push(['ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ©', totals.uniqueShops.size]);
    ws_data.push(['ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿ∫ÿ∑ÿßÿ©', totals.areas.size]);
    ws_data.push(['ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ÿßŸÑŸÜÿ¥ÿ∑ŸäŸÜ', inspectorsData.length]);
    ws_data.push([]);
    
    // Create main table header
    let headerRow = ['ÿßŸÑŸÖŸÅÿ™ÿ¥'];
    allDays.forEach(day => {
        const dayName = new Date(day).toLocaleDateString('ar', { weekday: 'short' });
        headerRow.push(`${day} (${dayName})`);
    });
    headerRow.push('ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä', 'ÿßŸÑÿµÿ®ÿßÿ≠Ÿäÿ©', 'ÿßŸÑŸÖÿ≥ÿßÿ¶Ÿäÿ©', 'ÿßŸÑÿπÿ∑ŸÑÿ©', 'ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ', 'ÿßŸÑŸÉŸÅÿßÿ°ÿ©');
    ws_data.push(['ÿßŸÑÿ™ŸÅÿµŸäŸÑ ÿßŸÑŸäŸàŸÖŸä']);
    ws_data.push(headerRow);
    
    let dailyTotals = Array(allDays.length).fill(0);
    
    // Add inspector data
    inspectors.forEach(inspector => {
        const rows = inspectionData.filter(item => item.inspector === inspector);
        const inspectorAreas = new Set(rows.map(r => r.area));
        
        let inspectorRow = [inspector];
        
        // Daily columns
        allDays.forEach((day, i) => {
            let dayRows = rows.filter(r => r.day === day);
            let shopsCount = 0;
            dayRows.forEach(row => {
                shopsCount += row.shops ? row.shops.length : 0;
            });
            inspectorRow.push(shopsCount || '');
            dailyTotals[i] += shopsCount;
        });
        
        // Calculate totals for this inspector
        let totalShops = 0;
        let morningShops = 0;
        let eveningShops = 0;
        let weekendShops = 0;
        
        rows.forEach(r => {
            const shopsCount = r.shops ? r.shops.length : 0;
            totalShops += shopsCount;
            
            if (r.shift === "ÿµÿ®ÿßÿ≠Ÿäÿ©") {
                morningShops += shopsCount;
            } else if (r.shift === "ŸÖÿ≥ÿßÿ¶Ÿäÿ©") {
                eveningShops += shopsCount;
            }
            
            const dow = new Date(r.day).getDay();
            if ([5,6,0].includes(dow)) {
                weekendShops += shopsCount;
            }
        });
        
        const workingDays = rows.length;
        const efficiency = workingDays > 0 ? (totalShops / workingDays).toFixed(1) : '0';
        
        inspectorRow.push(totalShops, morningShops, eveningShops, weekendShops, inspectorAreas.size, efficiency);
        ws_data.push(inspectorRow);
        
        totals.total += totalShops;
        totals.morning += morningShops;
        totals.evening += eveningShops;
        totals.weekend += weekendShops;
    });
    
    // Add totals row
    let totalsRow = ['ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä'];
    dailyTotals.forEach(sum => totalsRow.push(sum));
    const overallEfficiency = inspectors.length > 0 ? (totals.total / inspectors.length).toFixed(1) : '0';
    totalsRow.push(totals.total, totals.morning, totals.evening, totals.weekend, totals.areas.size, overallEfficiency);
    ws_data.push(totalsRow);
    
    ws_data.push([]);
    
    // Add performance analysis
    ws_data.push(['ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ£ÿØÿßÿ°']);
    ws_data.push(['ÿ£ÿπŸÑŸâ ÿ£ÿØÿßÿ° ŸäŸàŸÖŸä', Math.max(...dailyTotals) + ' ÿ™ŸÅÿ™Ÿäÿ¥']);
    ws_data.push(['ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸäŸàŸÖŸä', (dailyTotals.reduce((a, b) => a + b, 0) / dailyTotals.length).toFixed(1) + ' ÿ™ŸÅÿ™Ÿäÿ¥/ŸäŸàŸÖ']);
    ws_data.push(['ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿµÿ®ÿßÿ≠Ÿä', totals.total > 0 ? ((totals.morning / totals.total) * 100).toFixed(1) + '%' : '0%']);
    ws_data.push(['ŸÜÿ≥ÿ®ÿ© ÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿπÿ∑ŸÑÿ©', totals.total > 0 ? ((totals.weekend / totals.total) * 100).toFixed(1) + '%' : '0%']);
    
    ws_data.push([]);
    
    // Add areas breakdown
    ws_data.push(['ÿ™ŸÅÿµŸäŸÑ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ']);
    ws_data.push(['ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©', 'ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™', 'ÿπÿØÿØ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ']);
    totals.areas.forEach(area => {
        const areaInspections = inspectionData.filter(r => r.area === area).reduce((sum, r) => sum + (r.shops ? r.shops.length : 0), 0);
        const areaInspectors = new Set(inspectionData.filter(r => r.area === area).map(r => r.inspector)).size;
        ws_data.push([area, areaInspections, areaInspectors]);
    });
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    
    // Set column widths
    const colWidths = [{ wch: 20 }]; // Inspector name column
    allDays.forEach(() => colWidths.push({ wch: 12 })); // Daily columns
    colWidths.push({ wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }); // Summary columns
    ws['!cols'] = colWidths;
    
    XLSX.utils.book_append_sheet(wb, ws, "ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¥Ÿáÿ±Ÿä");
    XLSX.writeFile(wb, `ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑÿ¥Ÿáÿ±Ÿä_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// --- Smart Monthly Statistics Functions ---
function showSmartMonthlyStatsReport() {
    // Set current month and year as default
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth() + 1;
    const currentYear = currentDate.getFullYear();
    
    document.getElementById('smartStatsMonth').value = currentMonth;
    document.getElementById('smartStatsYear').value = currentYear;
    
    // Generate and display the report
    refreshSmartStats();
    
    // Show the modal
    document.getElementById('smartStatsModal').style.display = 'flex';
}

function closeSmartStatsModal() {
    document.getElementById('smartStatsModal').style.display = 'none';
}

function refreshSmartStats() {
    const selectedMonth = document.getElementById('smartStatsMonth').value;
    const selectedYear = document.getElementById('smartStatsYear').value;
    
    // Filter data by selected month and year
    let filteredData = inspectionData;
    
    if (selectedMonth || selectedYear) {
        filteredData = inspectionData.filter(item => {
            const itemDate = new Date(item.day);
            const itemMonth = itemDate.getMonth() + 1;
            const itemYear = itemDate.getFullYear();
            
            if (selectedMonth && selectedYear) {
                return itemMonth == selectedMonth && itemYear == selectedYear;
            } else if (selectedMonth) {
                return itemMonth == selectedMonth;
            } else if (selectedYear) {
                return itemYear == selectedYear;
            }
            return true;
        });
    }
    
    const stats = generateSmartMonthlyStats(filteredData);
    displaySmartStats(stats, selectedMonth, selectedYear);
}

function generateSmartMonthlyStats(data) {
    const stats = {
        totalInspections: data.length,
        totalShops: 0,
        uniqueShops: new Set(),
        inspectorStats: {},
        areaStats: {},
        shopStats: {},
        shiftStats: { morning: 0, evening: 0 },
        dayOfWeekStats: {},
        vacationDays: {},
        weekendInspections: 0,
        averageShopsPerDay: 0,
        mostProductiveDay: null,
        leastProductiveDay: null
    };
    
    // Initialize day of week stats
    const daysAr = ['ÿßŸÑÿ£ÿ≠ÿØ', 'ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ', 'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°', 'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°', 'ÿßŸÑÿÆŸÖŸäÿ≥', 'ÿßŸÑÿ¨ŸÖÿπÿ©', 'ÿßŸÑÿ≥ÿ®ÿ™'];
    daysAr.forEach(day => stats.dayOfWeekStats[day] = 0);
    
    // Process each inspection
    data.forEach(item => {
        // Inspector stats
        if (!stats.inspectorStats[item.inspector]) {
            stats.inspectorStats[item.inspector] = {
                inspections: 0,
                shops: 0,
                areas: new Set(),
                morningShifts: 0,
                eveningShifts: 0,
                weekendDays: 0,
                workDays: new Set()
            };
        }
        
        const inspectorStat = stats.inspectorStats[item.inspector];
        inspectorStat.inspections++;
        inspectorStat.workDays.add(item.day);
        
        if (item.shift === 'ÿµÿ®ÿßÿ≠Ÿäÿ©') {
            inspectorStat.morningShifts++;
            stats.shiftStats.morning++;
        } else if (item.shift === 'ŸÖÿ≥ÿßÿ¶Ÿäÿ©') {
            inspectorStat.eveningShifts++;
            stats.shiftStats.evening++;
        }
        
        inspectorStat.areas.add(item.area);
        
        // Area stats
        if (!stats.areaStats[item.area]) {
            stats.areaStats[item.area] = { visits: 0, shops: 0, inspectors: new Set() };
        }
        stats.areaStats[item.area].visits++;
        stats.areaStats[item.area].inspectors.add(item.inspector);
        
        // Shop stats
        if (item.shops) {
            item.shops.forEach(shop => {
                stats.uniqueShops.add(shop);
                stats.totalShops++;
                inspectorStat.shops++;
                stats.areaStats[item.area].shops++;
                
                if (!stats.shopStats[shop]) {
                    stats.shopStats[shop] = { count: 0, inspectors: new Set(), areas: new Set() };
                }
                stats.shopStats[shop].count++;
                stats.shopStats[shop].inspectors.add(item.inspector);
                stats.shopStats[shop].areas.add(item.area);
            });
        }
        
        // Day of week stats
        const dayOfWeek = new Date(item.day).getDay();
        const dayNameAr = daysAr[dayOfWeek];
        stats.dayOfWeekStats[dayNameAr] += (item.shops ? item.shops.length : 0);
        
        // Weekend stats
        if ([5, 6, 0].includes(dayOfWeek)) {
            stats.weekendInspections++;
            inspectorStat.weekendDays++;
        }
    });
    
    // Calculate vacation days (days not worked in the period)
    if (data.length > 0) {
        const allDays = Array.from(new Set(data.map(r => r.day))).sort();
        const totalDays = allDays.length;
        
        Object.keys(stats.inspectorStats).forEach(inspector => {
            const workDays = stats.inspectorStats[inspector].workDays.size;
            stats.vacationDays[inspector] = totalDays - workDays;
        });
    }
    
    // Calculate daily shop counts
    const dailyShopCounts = {};
    data.forEach(item => {
        if (!dailyShopCounts[item.day]) {
            dailyShopCounts[item.day] = 0;
        }
        dailyShopCounts[item.day] += (item.shops ? item.shops.length : 0);
    });
    
    // Find most and least productive days
    if (Object.keys(dailyShopCounts).length > 0) {
        const days = Object.keys(dailyShopCounts);
        stats.mostProductiveDay = days.reduce((a, b) => dailyShopCounts[a] > dailyShopCounts[b] ? a : b);
        stats.leastProductiveDay = days.reduce((a, b) => dailyShopCounts[a] < dailyShopCounts[b] ? a : b);
        stats.averageShopsPerDay = stats.totalShops / days.length;
    }
    
    return stats;
}

function displaySmartStats(stats, selectedMonth, selectedYear) {
    let monthName = '';
    if (selectedMonth) {
        const monthNames = ['', 'ŸäŸÜÿßŸäÿ±', 'ŸÅÿ®ÿ±ÿßŸäÿ±', 'ŸÖÿßÿ±ÿ≥', 'ÿ£ÿ®ÿ±ŸäŸÑ', 'ŸÖÿßŸäŸà', 'ŸäŸàŸÜŸäŸà', 'ŸäŸàŸÑŸäŸà', 'ÿ£ÿ∫ÿ≥ÿ∑ÿ≥', 'ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±', 'ÿ£ŸÉÿ™Ÿàÿ®ÿ±', 'ŸÜŸàŸÅŸÖÿ®ÿ±', 'ÿØŸäÿ≥ŸÖÿ®ÿ±'];
        monthName = monthNames[parseInt(selectedMonth)];
    }
    
    let periodTitle = '';
    if (selectedMonth && selectedYear) {
        periodTitle = `${monthName} ${selectedYear}`;
    } else if (selectedMonth) {
        periodTitle = `ÿ¥Ÿáÿ± ${monthName}`;
    } else if (selectedYear) {
        periodTitle = `ÿ≥ŸÜÿ© ${selectedYear}`;
    } else {
        periodTitle = 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™';
    }
    
    let html = `
    <div class="pdf-title-arabic" id="smartStatsTitle">
        üìä ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© ÿßŸÑÿ∞ŸÉŸäÿ© - ${periodTitle}
    </div>`;
    
    // === 1. Overall Summary Cards ===
    html += `
    <div style="margin-bottom: 25px;">
        <h3 style="color: #234085; margin-bottom: 15px; border-bottom: 3px solid #234085; padding-bottom: 10px;">
            üìà ŸÜÿ∏ÿ±ÿ© ÿπÿßŸÖÿ©
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">${stats.totalInspections}</div>
                <div style="font-size: 0.9em; opacity: 0.9;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥Ÿäÿ©</div>
            </div>
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">${stats.totalShops}</div>
                <div style="font-size: 0.9em; opacity: 0.9;">ÿ™ŸÅÿ™Ÿäÿ¥ ŸÖÿ≠ŸÑ</div>
            </div>
            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">${stats.uniqueShops.size}</div>
                <div style="font-size: 0.9em; opacity: 0.9;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ© ÿßŸÑÿ™Ÿä ÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß</div>
            </div>
            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">${Object.keys(stats.areaStats).length}</div>
                <div style="font-size: 0.9em; opacity: 0.9;">ŸÖŸÜÿ∑ŸÇÿ© ŸÖÿ∫ÿ∑ÿßÿ©</div>
            </div>
            <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">${Object.keys(stats.inspectorStats).length}</div>
                <div style="font-size: 0.9em; opacity: 0.9;">ŸÖŸÅÿ™ÿ¥ ŸÜÿ¥ÿ∑</div>
            </div>
            <div style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); padding: 20px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">${stats.averageShopsPerDay.toFixed(1)}</div>
                <div style="font-size: 0.9em; opacity: 0.9;">ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸäŸàŸÖŸä</div>
            </div>
        </div>
    </div>`;
    
    // === 2. Top Performers - Most Active Inspector ===
    const inspectorsList = Object.entries(stats.inspectorStats)
        .sort((a, b) => b[1].shops - a[1].shops);
    
    if (inspectorsList.length > 0) {
        const topInspector = inspectorsList[0];
        html += `
        <div style="margin-bottom: 25px;">
            <h3 style="color: #234085; margin-bottom: 15px; border-bottom: 3px solid #234085; padding-bottom: 10px;">
                üèÜ ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿßŸÑÿ£ŸÉÿ´ÿ± ŸÜÿ¥ÿßÿ∑ÿßŸã Ÿàÿ™ŸÅÿ™Ÿäÿ¥ÿßŸã
            </h3>
            <div style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); padding: 25px; border-radius: 12px; color: white; box-shadow: 0 6px 12px rgba(0,0,0,0.15);">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: center;">
                    <div style="text-align: center;">
                        <div style="font-size: 3em; margin-bottom: 10px;">üë®‚Äç‚öïÔ∏è</div>
                        <div style="font-size: 1.4em; font-weight: bold;">${topInspector[0]}</div>
                        <div style="font-size: 0.9em; opacity: 0.9; margin-top: 5px;">ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ•ŸÜÿ¨ÿßÿ≤ÿßŸã</div>
                    </div>
                    <div>
                        <div style="margin-bottom: 10px;"><strong>üè™ ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ÿ©:</strong> ${topInspector[1].shops} ŸÖÿ≠ŸÑ</div>
                        <div style="margin-bottom: 10px;"><strong>üìç ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖÿ∫ÿ∑ÿßÿ©:</strong> ${topInspector[1].areas.size} ŸÖŸÜÿ∑ŸÇÿ©</div>
                        <div style="margin-bottom: 10px;"><strong>üìÖ ÿ£ŸäÿßŸÖ ÿßŸÑÿπŸÖŸÑ:</strong> ${topInspector[1].workDays.size} ŸäŸàŸÖ</div>
                    </div>
                    <div>
                        <div style="margin-bottom: 10px;"><strong>‚òÄÔ∏è ŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿµÿ®ÿßÿ≠Ÿäÿ©:</strong> ${topInspector[1].morningShifts}</div>
                        <div style="margin-bottom: 10px;"><strong>üåô ŸÖŸÜÿßŸàÿ®ÿßÿ™ ŸÖÿ≥ÿßÿ¶Ÿäÿ©:</strong> ${topInspector[1].eveningShifts}</div>
                        <div style="margin-bottom: 10px;"><strong>üéØ ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸäŸàŸÖŸä:</strong> ${(topInspector[1].shops / topInspector[1].workDays.size).toFixed(1)} ŸÖÿ≠ŸÑ/ŸäŸàŸÖ</div>
                    </div>
                </div>
            </div>
        </div>`;
    }
    
    // === 3. All Inspectors Performance Table ===
    html += `
    <div style="margin-bottom: 25px;">
        <h3 style="color: #234085; margin-bottom: 15px; border-bottom: 3px solid #234085; padding-bottom: 10px;">
            üë• ÿ£ÿØÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ
        </h3>
        <div style="overflow-x: auto;">
            <table class="stats-table" style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <thead>
                    <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">ÿßŸÑŸÖŸÅÿ™ÿ¥</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿ£ŸäÿßŸÖ ÿßŸÑÿπŸÖŸÑ</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿ£ŸäÿßŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿµÿ®ÿßÿ≠Ÿäÿ©</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ŸÖÿ≥ÿßÿ¶Ÿäÿ©</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿπÿ∑ŸÑÿ©</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿßŸÑŸÉŸÅÿßÿ°ÿ©</th>
                    </tr>
                </thead>
                <tbody>`;
    
    inspectorsList.forEach(([inspector, data], index) => {
        const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
        const efficiency = (data.shops / data.workDays.size).toFixed(1);
        html += `
                    <tr style="background: ${bgColor};">
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${inspector}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #667eea; font-weight: bold;">${data.shops}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #4facfe;">${data.areas.size}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #43e97b;">${data.workDays.size}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #f5576c;">${stats.vacationDays[inspector] || 0}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #ffd700;">${data.morningShifts}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #ff8c00;">${data.eveningShifts}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #9c27b0;">${data.weekendDays}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #19547b;">${efficiency}</td>
                    </tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    </div>`;
    
    // === 4. Most Inspected Shops ===
    const topShops = Object.entries(stats.shopStats)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 10);
    
    if (topShops.length > 0) {
        html += `
        <div style="margin-bottom: 25px;">
            <h3 style="color: #234085; margin-bottom: 15px; border-bottom: 3px solid #234085; padding-bottom: 10px;">
                üè™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ™ŸÅÿ™Ÿäÿ¥ÿßŸã (ÿ£ÿπŸÑŸâ 10)
            </h3>
            <div style="overflow-x: auto;">
                <table class="stats-table" style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                            <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">ÿßŸÑŸÖÿ≠ŸÑ</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿπÿØÿØ ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿπÿØÿØ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        topShops.forEach(([shop, data], index) => {
            const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
            html += `
                        <tr style="background: ${bgColor};">
                            <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${medal} ${shop}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #f5576c; font-weight: bold;">${data.count}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #4facfe;">${data.inspectors.size}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #43e97b;">${Array.from(data.areas).join(', ')}</td>
                        </tr>`;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        </div>`;
    }
    
    // === 5. Most Visited Areas ===
    const topAreas = Object.entries(stats.areaStats)
        .sort((a, b) => b[1].visits - a[1].visits)
        .slice(0, 10);
    
    if (topAreas.length > 0) {
        html += `
        <div style="margin-bottom: 25px;">
            <h3 style="color: #234085; margin-bottom: 15px; border-bottom: 3px solid #234085; padding-bottom: 10px;">
                üìç ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ≤Ÿäÿßÿ±ÿ© (ÿ£ÿπŸÑŸâ 10)
            </h3>
            <div style="overflow-x: auto;">
                <table class="stats-table" style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                            <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿπÿØÿØ ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ÿ©</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿπÿØÿØ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        topAreas.forEach(([area, data], index) => {
            const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
            html += `
                        <tr style="background: ${bgColor};">
                            <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${medal} ${area}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #43e97b; font-weight: bold;">${data.visits}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #f5576c;">${data.shops}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #4facfe;">${data.inspectors.size}</td>
                        </tr>`;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        </div>`;
    }
    
    // === 6. Shift and Weekend Analysis ===
    html += `
    <div style="margin-bottom: 25px;">
        <h3 style="color: #234085; margin-bottom: 15px; border-bottom: 3px solid #234085; padding-bottom: 10px;">
            ‚è∞ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ŸàÿßŸÑÿπÿ∑ŸÑÿßÿ™
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="text-align: center; margin-bottom: 15px; font-size: 2.5em;">‚òÄÔ∏è</div>
                <div style="font-size: 1.8em; font-weight: bold; text-align: center; color: #d35400; margin-bottom: 5px;">${stats.shiftStats.morning}</div>
                <div style="text-align: center; color: #666; font-size: 0.95em;">ŸÖŸÜÿßŸàÿ®ÿ© ÿµÿ®ÿßÿ≠Ÿäÿ©</div>
                <div style="text-align: center; color: #666; font-size: 0.85em; margin-top: 5px;">
                    (${stats.totalInspections > 0 ? ((stats.shiftStats.morning / stats.totalInspections) * 100).toFixed(1) : 0}%)
                </div>
            </div>
            <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="text-align: center; margin-bottom: 15px; font-size: 2.5em;">üåô</div>
                <div style="font-size: 1.8em; font-weight: bold; text-align: center; color: #8e44ad; margin-bottom: 5px;">${stats.shiftStats.evening}</div>
                <div style="text-align: center; color: #666; font-size: 0.95em;">ŸÖŸÜÿßŸàÿ®ÿ© ŸÖÿ≥ÿßÿ¶Ÿäÿ©</div>
                <div style="text-align: center; color: #666; font-size: 0.85em; margin-top: 5px;">
                    (${stats.totalInspections > 0 ? ((stats.shiftStats.evening / stats.totalInspections) * 100).toFixed(1) : 0}%)
                </div>
            </div>
            <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="text-align: center; margin-bottom: 15px; font-size: 2.5em;">üèñÔ∏è</div>
                <div style="font-size: 1.8em; font-weight: bold; text-align: center; color: #c0392b; margin-bottom: 5px;">${stats.weekendInspections}</div>
                <div style="text-align: center; color: #666; font-size: 0.95em;">ÿ≤Ÿäÿßÿ±ÿ© ŸÅŸä ÿßŸÑÿπÿ∑ŸÑÿ©</div>
                <div style="text-align: center; color: #666; font-size: 0.85em; margin-top: 5px;">
                    (${stats.totalInspections > 0 ? ((stats.weekendInspections / stats.totalInspections) * 100).toFixed(1) : 0}%)
                </div>
            </div>
        </div>
    </div>`;
    
    // === 7. Day of Week Analysis ===
    html += `
    <div style="margin-bottom: 25px;">
        <h3 style="color: #234085; margin-bottom: 15px; border-bottom: 3px solid #234085; padding-bottom: 10px;">
            üìÖ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸä ŸÑŸÑÿ™ŸÅÿ™Ÿäÿ¥
        </h3>
        <div style="overflow-x: auto;">
            <table class="stats-table" style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <thead>
                    <tr style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿßŸÑŸäŸàŸÖ</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">ÿßŸÑŸÜÿ≥ÿ®ÿ©</th>
                    </tr>
                </thead>
                <tbody>`;
    
    const daysOrder = ['ÿßŸÑÿ≥ÿ®ÿ™', 'ÿßŸÑÿ£ÿ≠ÿØ', 'ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ', 'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°', 'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°', 'ÿßŸÑÿÆŸÖŸäÿ≥', 'ÿßŸÑÿ¨ŸÖÿπÿ©'];
    daysOrder.forEach((day, index) => {
        const count = stats.dayOfWeekStats[day] || 0;
        const percentage = stats.totalShops > 0 ? ((count / stats.totalShops) * 100).toFixed(1) : 0;
        const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
        const isWeekend = ['ÿßŸÑÿ¨ŸÖÿπÿ©', 'ÿßŸÑÿ≥ÿ®ÿ™'].includes(day);
        const dayStyle = isWeekend ? 'color: #e91e63; font-weight: bold;' : '';
        
        html += `
                    <tr style="background: ${bgColor};">
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; ${dayStyle}">${day}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #667eea; font-weight: bold;">${count}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #43e97b;">${percentage}%</td>
                    </tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    </div>`;
    
    // === 8. Productivity Insights ===
    if (stats.mostProductiveDay && stats.leastProductiveDay) {
        const mostDate = new Date(stats.mostProductiveDay);
        const leastDate = new Date(stats.leastProductiveDay);
        const mostDayName = mostDate.toLocaleDateString('ar', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const leastDayName = leastDate.toLocaleDateString('ar', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        const dailyShopCounts = {};
        stats.totalShops > 0 && Object.keys(stats.inspectorStats).length > 0 && Object.entries(stats.inspectorStats).forEach(([inspector, data]) => {
            data.workDays.forEach(day => {
                if (!dailyShopCounts[day]) dailyShopCounts[day] = 0;
            });
        });
        
        html += `
        <div style="margin-bottom: 25px;">
            <h3 style="color: #234085; margin-bottom: 15px; border-bottom: 3px solid #234085; padding-bottom: 10px;">
                üí° ÿ±ÿ§Ÿâ ÿ∞ŸÉŸäÿ© ÿ≠ŸàŸÑ ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨Ÿäÿ©
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div style="background: linear-gradient(135deg, #c2e9fb 0%, #a1c4fd 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">üìà</div>
                    <div style="font-weight: bold; color: #1e3a8a; margin-bottom: 10px; font-size: 1.1em;">ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ•ŸÜÿ™ÿßÿ¨Ÿäÿ©</div>
                    <div style="color: #374151; font-size: 0.9em; line-height: 1.6;">
                        ${mostDayName}<br>
                        <strong style="color: #2563eb; font-size: 1.3em;">${Object.values(stats.dayOfWeekStats).length > 0 ? Math.max(...Object.values(stats.dayOfWeekStats)) : 0}</strong> ÿ™ŸÅÿ™Ÿäÿ¥
                    </div>
                </div>
                <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">üìâ</div>
                    <div style="font-weight: bold; color: #7c2d12; margin-bottom: 10px; font-size: 1.1em;">ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ£ŸÇŸÑ ÿ•ŸÜÿ™ÿßÿ¨Ÿäÿ©</div>
                    <div style="color: #374151; font-size: 0.9em; line-height: 1.6;">
                        ${leastDayName}<br>
                        <strong style="color: #dc2626; font-size: 1.3em;">${Object.values(stats.dayOfWeekStats).length > 0 ? Math.min(...Object.values(stats.dayOfWeekStats).filter(v => v > 0)) : 0}</strong> ÿ™ŸÅÿ™Ÿäÿ¥
                    </div>
                </div>
            </div>
        </div>`;
    }
    
    // === 9. Key Performance Indicators ===
    const totalWorkDays = new Set();
    Object.values(stats.inspectorStats).forEach(data => {
        data.workDays.forEach(day => totalWorkDays.add(day));
    });
    
    html += `
    <div style="margin-bottom: 25px;">
        <h3 style="color: #234085; margin-bottom: 15px; border-bottom: 3px solid #234085; padding-bottom: 10px;">
            üéØ ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑÿ£ÿØÿßÿ° ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
        </h3>
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; color: white; box-shadow: 0 6px 12px rgba(0,0,0,0.15);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÉŸÑ ŸÖŸÅÿ™ÿ¥</div>
                    <div style="font-size: 2em; font-weight: bold;">${(stats.totalShops / Object.keys(stats.inspectorStats).length).toFixed(1)}</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ŸÑŸÉŸÑ ŸÖŸÅÿ™ÿ¥</div>
                    <div style="font-size: 2em; font-weight: bold;">${(Object.values(stats.inspectorStats).reduce((sum, data) => sum + data.areas.size, 0) / Object.keys(stats.inspectorStats).length).toFixed(1)}</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">ŸÖÿπÿØŸÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥</div>
                    <div style="font-size: 2em; font-weight: bold;">${((stats.totalShops / stats.uniqueShops.size) - 1).toFixed(2)}x</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÉŸÑ ŸÖŸÜÿ∑ŸÇÿ©</div>
                    <div style="font-size: 2em; font-weight: bold;">${(stats.uniqueShops.size / Object.keys(stats.areaStats).length).toFixed(1)}</div>
                </div>
            </div>
        </div>
    </div>`;
    
    // Final note
    html += `
    <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 12px; text-align: center; color: #334155;">
        <div style="font-size: 0.95em; margin-bottom: 8px;">üìä ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° Ÿáÿ∞ÿß ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©</div>
        <div style="font-size: 0.85em; opacity: 0.8;">${new Date().toLocaleDateString('ar', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
    </div>`;
    
    document.getElementById('smartStatsContent').innerHTML = html;
}

function exportSmartStatsToPDF() {
    let reportContent = document.getElementById('smartStatsContent');
    if (!reportContent) return;
    
    let wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '20px';
    wrap.style.fontFamily = 'Cairo, Arial, sans-serif';
    wrap.style.width = 'auto';
    wrap.style.minWidth = '1000px';
    wrap.style.maxWidth = '1400px';
    
    let contentClone = reportContent.cloneNode(true);
    
    // Style tables for better PDF rendering
    const tables = contentClone.querySelectorAll('table');
    tables.forEach(table => {
        table.style.fontSize = '9px';
        table.style.marginBottom = '15px';
        
        const ths = table.querySelectorAll('th');
        ths.forEach(th => {
            th.style.padding = '8px 5px';
            th.style.fontSize = '9px';
        });
        
        const tds = table.querySelectorAll('td');
        tds.forEach(td => {
            td.style.padding = '6px 4px';
            td.style.fontSize = '8px';
        });
    });
    
    wrap.appendChild(contentClone);
    document.body.appendChild(wrap);
    
    html2canvas(wrap, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        logging: false
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF.jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = pdfWidth - 20;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        let heightLeft = imgHeight;
        let position = 10;
        
        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pdfHeight;
        
        while (heightLeft > 0) {
            position = heightLeft - imgHeight + 10;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= pdfHeight;
        }
        
        const fileName = `ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™_ÿßŸÑÿ∞ŸÉŸäÿ©_${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(fileName);
        
        document.body.removeChild(wrap);
        alert('‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®ŸÜÿ¨ÿßÿ≠ ŸÉŸÖŸÑŸÅ PDF');
    }).catch(err => {
        console.error('Error generating PDF:', err);
        document.body.removeChild(wrap);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± ŸÖŸÑŸÅ PDF');
    });
}

function exportSmartStatsToExcel() {
    const selectedMonth = document.getElementById('smartStatsMonth').value;
    const selectedYear = document.getElementById('smartStatsYear').value;
    
    // Filter data by selected month and year
    let filteredData = inspectionData;
    
    if (selectedMonth || selectedYear) {
        filteredData = inspectionData.filter(item => {
            const itemDate = new Date(item.day);
            const itemMonth = itemDate.getMonth() + 1;
            const itemYear = itemDate.getFullYear();
            
            if (selectedMonth && selectedYear) {
                return itemMonth == selectedMonth && itemYear == selectedYear;
            } else if (selectedMonth) {
                return itemMonth == selectedMonth;
            } else if (selectedYear) {
                return itemYear == selectedYear;
            }
            return true;
        });
    }
    
    const stats = generateSmartMonthlyStats(filteredData);
    
    let ws_data = [];
    
    // Title
    const monthNames = ['', 'ŸäŸÜÿßŸäÿ±', 'ŸÅÿ®ÿ±ÿßŸäÿ±', 'ŸÖÿßÿ±ÿ≥', 'ÿ£ÿ®ÿ±ŸäŸÑ', 'ŸÖÿßŸäŸà', 'ŸäŸàŸÜŸäŸà', 'ŸäŸàŸÑŸäŸà', 'ÿ£ÿ∫ÿ≥ÿ∑ÿ≥', 'ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±', 'ÿ£ŸÉÿ™Ÿàÿ®ÿ±', 'ŸÜŸàŸÅŸÖÿ®ÿ±', 'ÿØŸäÿ≥ŸÖÿ®ÿ±'];
    let periodTitle = 'ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© ÿßŸÑÿ∞ŸÉŸäÿ©';
    if (selectedMonth && selectedYear) {
        periodTitle += ` - ${monthNames[parseInt(selectedMonth)]} ${selectedYear}`;
    }
    ws_data.push([periodTitle]);
    ws_data.push([]);
    
    // Overall statistics
    ws_data.push(['ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©']);
    ws_data.push(['ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥Ÿäÿ©', stats.totalInspections]);
    ws_data.push(['ÿ™ŸÅÿ™Ÿäÿ¥ ŸÖÿ≠ŸÑ', stats.totalShops]);
    ws_data.push(['ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ© ÿßŸÑÿ™Ÿä ÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß', stats.uniqueShops.size]);
    ws_data.push(['ŸÖŸÜÿ∑ŸÇÿ© ŸÖÿ∫ÿ∑ÿßÿ©', Object.keys(stats.areaStats).length]);
    ws_data.push(['ŸÖŸÅÿ™ÿ¥ ŸÜÿ¥ÿ∑', Object.keys(stats.inspectorStats).length]);
    ws_data.push(['ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸäŸàŸÖŸä', stats.averageShopsPerDay.toFixed(1)]);
    ws_data.push([]);
    
    // Inspector statistics
    ws_data.push(['ÿ£ÿØÿßÿ° ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ']);
    ws_data.push(['ÿßŸÑŸÖŸÅÿ™ÿ¥', 'ÿßŸÑŸÖÿ≠ŸÑÿßÿ™', 'ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ', 'ÿ£ŸäÿßŸÖ ÿßŸÑÿπŸÖŸÑ', 'ÿ£ŸäÿßŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©', 'ÿµÿ®ÿßÿ≠Ÿäÿ©', 'ŸÖÿ≥ÿßÿ¶Ÿäÿ©', 'ÿπÿ∑ŸÑÿ©', 'ÿßŸÑŸÉŸÅÿßÿ°ÿ©']);
    
    const inspectorsList = Object.entries(stats.inspectorStats)
        .sort((a, b) => b[1].shops - a[1].shops);
    
    inspectorsList.forEach(([inspector, data]) => {
        const efficiency = (data.shops / data.workDays.size).toFixed(1);
        ws_data.push([
            inspector,
            data.shops,
            data.areas.size,
            data.workDays.size,
            stats.vacationDays[inspector] || 0,
            data.morningShifts,
            data.eveningShifts,
            data.weekendDays,
            efficiency
        ]);
    });
    ws_data.push([]);
    
    // Top shops
    ws_data.push(['ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ™ŸÅÿ™Ÿäÿ¥ÿßŸã (ÿ£ÿπŸÑŸâ 10)']);
    ws_data.push(['ÿßŸÑŸÖÿ≠ŸÑ', 'ÿπÿØÿØ ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™', 'ÿπÿØÿØ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ', 'ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ']);
    
    const topShops = Object.entries(stats.shopStats)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 10);
    
    topShops.forEach(([shop, data]) => {
        ws_data.push([
            shop,
            data.count,
            data.inspectors.size,
            Array.from(data.areas).join(', ')
        ]);
    });
    ws_data.push([]);
    
    // Top areas
    ws_data.push(['ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ≤Ÿäÿßÿ±ÿ© (ÿ£ÿπŸÑŸâ 10)']);
    ws_data.push(['ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©', 'ÿπÿØÿØ ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™', 'ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ÿ©', 'ÿπÿØÿØ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ']);
    
    const topAreas = Object.entries(stats.areaStats)
        .sort((a, b) => b[1].visits - a[1].visits)
        .slice(0, 10);
    
    topAreas.forEach(([area, data]) => {
        ws_data.push([
            area,
            data.visits,
            data.shops,
            data.inspectors.size
        ]);
    });
    ws_data.push([]);
    
    // Shift analysis
    ws_data.push(['ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™']);
    ws_data.push(['ÿßŸÑŸÜŸàÿπ', 'ÿßŸÑÿπÿØÿØ', 'ÿßŸÑŸÜÿ≥ÿ®ÿ©']);
    ws_data.push(['ŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿµÿ®ÿßÿ≠Ÿäÿ©', stats.shiftStats.morning, `${stats.totalInspections > 0 ? ((stats.shiftStats.morning / stats.totalInspections) * 100).toFixed(1) : 0}%`]);
    ws_data.push(['ŸÖŸÜÿßŸàÿ®ÿßÿ™ ŸÖÿ≥ÿßÿ¶Ÿäÿ©', stats.shiftStats.evening, `${stats.totalInspections > 0 ? ((stats.shiftStats.evening / stats.totalInspections) * 100).toFixed(1) : 0}%`]);
    ws_data.push(['ÿ≤Ÿäÿßÿ±ÿßÿ™ ÿßŸÑÿπÿ∑ŸÑÿ©', stats.weekendInspections, `${stats.totalInspections > 0 ? ((stats.weekendInspections / stats.totalInspections) * 100).toFixed(1) : 0}%`]);
    ws_data.push([]);
    
    // Day of week analysis
    ws_data.push(['ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸä']);
    ws_data.push(['ÿßŸÑŸäŸàŸÖ', 'ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™', 'ÿßŸÑŸÜÿ≥ÿ®ÿ©']);
    
    const daysOrder = ['ÿßŸÑÿ≥ÿ®ÿ™', 'ÿßŸÑÿ£ÿ≠ÿØ', 'ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ', 'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°', 'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°', 'ÿßŸÑÿÆŸÖŸäÿ≥', 'ÿßŸÑÿ¨ŸÖÿπÿ©'];
    daysOrder.forEach(day => {
        const count = stats.dayOfWeekStats[day] || 0;
        const percentage = stats.totalShops > 0 ? ((count / stats.totalShops) * 100).toFixed(1) : 0;
        ws_data.push([day, count, `${percentage}%`]);
    });
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    
    // Set column widths
    ws['!cols'] = [
        { wch: 30 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 },
        { wch: 12 },
        { wch: 12 },
        { wch: 12 },
        { wch: 12 }
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, "ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©");
    XLSX.writeFile(wb, `ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™_ÿßŸÑÿ∞ŸÉŸäÿ©_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// --- Enhanced Reporting Functions ---
function showEnhancedReportsModal() {
    // Populate inspector dropdown in the modal
    const reportInspectorSelect = document.getElementById('reportInspectorSelect');
    reportInspectorSelect.innerHTML = '<option value="">-- ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ --</option>';
    inspectorsData.forEach(inspector => {
        reportInspectorSelect.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
    });
    
    // Set current year as default
    const currentYear = new Date().getFullYear();
    document.getElementById('reportYear').value = currentYear;
    
    // Set current month as default
    const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0');
    document.getElementById('reportMonth').value = currentMonth;
    
    document.getElementById('enhancedReportsModal').style.display = 'flex';
}

function closeEnhancedReportsModal() {
    document.getElementById('enhancedReportsModal').style.display = 'none';
}

function generateEnhancedReport() {
    const reportType = document.querySelector('input[name="reportType"]:checked').value;
    const selectedInspector = document.getElementById('reportInspectorSelect').value;
    const selectedYear = document.getElementById('reportYear').value;
    const selectedMonth = document.getElementById('reportMonth').value;
    
    let filteredData = inspectionData.slice();
    
    // Filter by year
    if (selectedYear) {
        filteredData = filteredData.filter(item => item.day.startsWith(selectedYear));
    }
    
    // Filter by month (for monthly reports)
    if ((reportType === 'inspector-monthly' || reportType === 'all-monthly') && selectedMonth) {
        filteredData = filteredData.filter(item => {
            const month = item.day.substring(5, 7);
            return month === selectedMonth;
        });
    }
    
    // Filter by inspector (for inspector-specific reports)
    if ((reportType === 'inspector-monthly' || reportType === 'inspector-yearly') && selectedInspector) {
        filteredData = filteredData.filter(item => item.inspector === selectedInspector);
    }
    
    let reportHtml = '';
    let reportTitle = '';
    
    if (reportType === 'inspector-monthly') {
        reportTitle = `ÿ™ŸÇÿ±Ÿäÿ± ÿ¥Ÿáÿ±Ÿä ŸÑŸÑŸÖŸÅÿ™ÿ¥: ${selectedInspector || 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ'} - ${getMonthName(selectedMonth)} ${selectedYear}`;
        reportHtml = generateInspectorMonthlyReport(filteredData, selectedInspector);
    } else if (reportType === 'inspector-yearly') {
        reportTitle = `ÿ™ŸÇÿ±Ÿäÿ± ÿ≥ŸÜŸàŸä ŸÑŸÑŸÖŸÅÿ™ÿ¥: ${selectedInspector || 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ'} - ${selectedYear}`;
        reportHtml = generateInspectorYearlyReport(filteredData, selectedInspector);
    } else if (reportType === 'all-monthly') {
        reportTitle = `ÿ™ŸÇÿ±Ÿäÿ± ÿ¥Ÿáÿ±Ÿä ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ - ${getMonthName(selectedMonth)} ${selectedYear}`;
        reportHtml = generateAllInspectorsMonthlyReport(filteredData);
    } else if (reportType === 'all-yearly') {
        reportTitle = `ÿ™ŸÇÿ±Ÿäÿ± ÿ≥ŸÜŸàŸä ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ - ${selectedYear}`;
        reportHtml = generateAllInspectorsYearlyReport(filteredData);
    } else if (reportType === 'shop-analytics') {
        reportTitle = `üìä ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ© - ${selectedYear}`;
        reportHtml = generateShopAnalyticsReport(filteredData, selectedYear, selectedMonth);
    }
    
    const fullReportHtml = `
        <div class="pdf-title-arabic" id="enhancedReportTitle">${reportTitle}</div>
        ${reportHtml}
    `;
    
    document.getElementById('enhancedReportContent').innerHTML = fullReportHtml;
}

function generateInspectorMonthlyReport(data, inspectorName) {
    const inspectorData = data.filter(item => !inspectorName || item.inspector === inspectorName);
    const groupedByDate = {};
    
    inspectorData.forEach(item => {
        if (!groupedByDate[item.day]) {
            groupedByDate[item.day] = [];
        }
        groupedByDate[item.day].push(item);
    });
    
    let html = `
        <table class="stats-table" id="enhancedReportTable">
            <thead>
                <tr>
                    <th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                    <th>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                    <th>ŸàŸÇÿ™ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©</th>
                    <th>ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</th>
                    <th>ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalInspections = 0;
    let totalShops = 0;
    
    Object.keys(groupedByDate).sort().forEach(date => {
        groupedByDate[date].forEach(item => {
            const shopsCount = item.shops ? item.shops.length : 0;
            totalInspections++;
            totalShops += shopsCount;
            
            // Format shops as separate lines
            const shopsDisplay = item.shops && item.shops.length > 0 
                ? item.shops.map(shop => `<div style="padding:2px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${shop}</div>`).join('') 
                : '';
            
            html += `
                <tr>
                    <td>${item.day}</td>
                    <td style="color:${getAreaName(item.area) === 'ÿ≥ŸàŸÇ ÿßŸÑŸÖŸäŸÜÿßÿ°' || getAreaName(item.area) === 'ÿ≥ŸàŸÇ ÿßŸÑÿ™ÿ±ÿßÿ´' ? '#1976d2' : '#d32f2f'};">${getAreaName(item.area)}</td>
                    <td>${item.shift}</td>
                    <td>${shopsCount}</td>
                    <td style="text-align:right;padding:8px;line-height:1.8;">${shopsDisplay}</td>
                </tr>
            `;
        });
    });
    
    html += `
            <tr style="background:#e9ecef;font-weight:bold;">
                <td colspan="3">ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</td>
                <td>${totalShops}</td>
                <td>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™: ${totalInspections}</td>
            </tr>
        </tbody>
        </table>
    `;
    
    return html;
}

function generateInspectorYearlyReport(data, inspectorName) {
    const inspectorData = data.filter(item => !inspectorName || item.inspector === inspectorName);
    const groupedByMonth = {};
    
    inspectorData.forEach(item => {
        const month = item.day.substring(0, 7); // YYYY-MM
        if (!groupedByMonth[month]) {
            groupedByMonth[month] = {
                count: 0,
                shops: 0,
                morning: 0,
                evening: 0
            };
        }
        
        groupedByMonth[month].count++;
        groupedByMonth[month].shops += item.shops ? item.shops.length : 0;
        
        if (item.shift === 'ÿµÿ®ÿßÿ≠Ÿäÿ©') {
            groupedByMonth[month].morning++;
        } else if (item.shift === 'ŸÖÿ≥ÿßÿ¶Ÿäÿ©') {
            groupedByMonth[month].evening++;
        }
    });
    
    let html = `
        <table class="stats-table" id="enhancedReportTable">
            <thead>
                <tr>
                    <th>ÿßŸÑÿ¥Ÿáÿ±</th>
                    <th>ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</th>
                    <th>ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</th>
                    <th>ÿßŸÑÿµÿ®ÿßÿ≠Ÿäÿ©</th>
                    <th>ÿßŸÑŸÖÿ≥ÿßÿ¶Ÿäÿ©</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalInspections = 0;
    let totalShops = 0;
    let totalMorning = 0;
    let totalEvening = 0;
    
    Object.keys(groupedByMonth).sort().forEach(month => {
        const data = groupedByMonth[month];
        totalInspections += data.count;
        totalShops += data.shops;
        totalMorning += data.morning;
        totalEvening += data.evening;
        
        const monthName = getMonthName(month.substring(5, 7));
        
        html += `
            <tr>
                <td>${monthName} ${month.substring(0, 4)}</td>
                <td>${data.count}</td>
                <td>${data.shops}</td>
                <td>${data.morning}</td>
                <td>${data.evening}</td>
            </tr>
        `;
    });
    
    html += `
            <tr style="background:#e9ecef;font-weight:bold;">
                <td>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≥ŸÜŸàŸä</td>
                <td>${totalInspections}</td>
                <td>${totalShops}</td>
                <td>${totalMorning}</td>
                <td>${totalEvening}</td>
            </tr>
        </tbody>
        </table>
    `;
    
    return html;
}

function generateAllInspectorsMonthlyReport(data) {
    const groupedByInspector = {};
    
    data.forEach(item => {
        if (!groupedByInspector[item.inspector]) {
            groupedByInspector[item.inspector] = {
                count: 0,
                shops: 0,
                morning: 0,
                evening: 0
            };
        }
        
        groupedByInspector[item.inspector].count++;
        groupedByInspector[item.inspector].shops += item.shops ? item.shops.length : 0;
        
        if (item.shift === 'ÿµÿ®ÿßÿ≠Ÿäÿ©') {
            groupedByInspector[item.inspector].morning++;
        } else if (item.shift === 'ŸÖÿ≥ÿßÿ¶Ÿäÿ©') {
            groupedByInspector[item.inspector].evening++;
        }
    });
    
    let html = `
        <table class="stats-table" id="enhancedReportTable">
            <thead>
                <tr>
                    <th>ÿßŸÑŸÖŸÅÿ™ÿ¥</th>
                    <th>ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</th>
                    <th>ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</th>
                    <th>ÿßŸÑÿµÿ®ÿßÿ≠Ÿäÿ©</th>
                    <th>ÿßŸÑŸÖÿ≥ÿßÿ¶Ÿäÿ©</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalInspections = 0;
    let totalShops = 0;
    let totalMorning = 0;
    let totalEvening = 0;
    
    Object.keys(groupedByInspector).sort().forEach(inspector => {
        const data = groupedByInspector[inspector];
        totalInspections += data.count;
        totalShops += data.shops;
        totalMorning += data.morning;
        totalEvening += data.evening;
        
        html += `
            <tr>
                <td>${inspector}</td>
                <td>${data.count}</td>
                <td>${data.shops}</td>
                <td>${data.morning}</td>
                <td>${data.evening}</td>
            </tr>
        `;
    });
    
    html += `
            <tr style="background:#e9ecef;font-weight:bold;">
                <td>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</td>
                <td>${totalInspections}</td>
                <td>${totalShops}</td>
                <td>${totalMorning}</td>
                <td>${totalEvening}</td>
            </tr>
        </tbody>
        </table>
    `;
    
    return html;
}

function generateAllInspectorsYearlyReport(data) {
    const groupedByInspectorMonth = {};
    
    data.forEach(item => {
        const month = item.day.substring(5, 7);
        const key = `${item.inspector}-${month}`;
        
        if (!groupedByInspectorMonth[key]) {
            groupedByInspectorMonth[key] = {
                inspector: item.inspector,
                month: month,
                count: 0,
                shops: 0
            };
        }
        
        groupedByInspectorMonth[key].count++;
        groupedByInspectorMonth[key].shops += item.shops ? item.shops.length : 0;
    });
    
    // Get all unique months
    const allMonths = Array.from(new Set(data.map(item => item.day.substring(5, 7)))).sort();
    const allInspectors = Array.from(new Set(data.map(item => item.inspector))).sort();
    
    let html = `
        <table class="stats-table" id="enhancedReportTable">
            <thead>
                <tr>
                    <th>ÿßŸÑŸÖŸÅÿ™ÿ¥</th>
    `;
    
    allMonths.forEach(month => {
        html += `<th>${getMonthName(month)}</th>`;
    });
    
    html += `
                    <th>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let monthTotals = {};
    let grandTotal = 0;
    
    allInspectors.forEach(inspector => {
        html += `<tr><td>${inspector}</td>`;
        let inspectorTotal = 0;
        
        allMonths.forEach(month => {
            const key = `${inspector}-${month}`;
            const monthData = groupedByInspectorMonth[key];
            const count = monthData ? monthData.count : 0;
            
            html += `<td>${count || ''}</td>`;
            inspectorTotal += count;
            
            if (!monthTotals[month]) monthTotals[month] = 0;
            monthTotals[month] += count;
        });
        
        html += `<td>${inspectorTotal}</td></tr>`;
        grandTotal += inspectorTotal;
    });
    
    // Add totals row
    html += `<tr style="background:#e9ecef;font-weight:bold;"><td>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</td>`;
    allMonths.forEach(month => {
        html += `<td>${monthTotals[month] || 0}</td>`;
    });
    html += `<td>${grandTotal}</td></tr>`;
    
    html += `</tbody></table>`;
    
    return html;
}

function generateShopAnalyticsReport(data, selectedYear, selectedMonth) {
    // Create comprehensive shop analytics with intelligent recommendations
    const shopAnalytics = {};
    const areaAnalytics = {};
    
    // Process inspection data to extract shop statistics
    data.forEach(item => {
        if (!item.shops || !Array.isArray(item.shops)) return;
        
        const weekOfYear = getWeekOfYear(item.day);
        const area = getAreaName(item.area);
        
        // Initialize area if not exists
        if (!areaAnalytics[area]) {
            areaAnalytics[area] = {
                totalInspections: 0,
                shops: new Set(),
                weeks: new Set()
            };
        }
        
        areaAnalytics[area].totalInspections++;
        areaAnalytics[area].weeks.add(weekOfYear);
        
        item.shops.forEach(shop => {
            // Initialize shop analytics
            if (!shopAnalytics[shop]) {
                shopAnalytics[shop] = {
                    name: shop,
                    area: area,
                    totalInspections: 0,
                    weeks: new Set(),
                    inspectors: new Set(),
                    shifts: { morning: 0, evening: 0 },
                    lastInspected: null
                };
            }
            
            // Update shop statistics
            shopAnalytics[shop].totalInspections++;
            shopAnalytics[shop].weeks.add(weekOfYear);
            shopAnalytics[shop].inspectors.add(item.inspector);
            shopAnalytics[shop].area = area;
            
            // Update shift counts
            if (item.shift === 'ÿµÿ®ÿßÿ≠Ÿäÿ©') {
                shopAnalytics[shop].shifts.morning++;
            } else if (item.shift === 'ŸÖÿ≥ÿßÿ¶Ÿäÿ©') {
                shopAnalytics[shop].shifts.evening++;
            }
            
            // Update last inspection date
            if (!shopAnalytics[shop].lastInspected || item.day > shopAnalytics[shop].lastInspected) {
                shopAnalytics[shop].lastInspected = item.day;
            }
            
            areaAnalytics[area].shops.add(shop);
        });
    });
    
    // Convert shop analytics to array and calculate additional metrics
    const shopsArray = Object.values(shopAnalytics).map(shop => {
        const weekCount = shop.weeks.size;
        const inspectionRate = weekCount > 0 ? (shop.totalInspections / weekCount).toFixed(2) : 0;
        const daysSinceLastInspection = shop.lastInspected ? 
            Math.floor((new Date() - new Date(shop.lastInspected)) / (1000 * 60 * 60 * 24)) : 999;
        
        return {
            ...shop,
            weekCount,
            inspectionRate: parseFloat(inspectionRate),
            daysSinceLastInspection,
            weeks: Array.from(shop.weeks),
            inspectors: Array.from(shop.inspectors)
        };
    });
    
    // Sort by inspection count (high to low as requested)
    shopsArray.sort((a, b) => b.totalInspections - a.totalInspections);
    
    // Calculate statistics
    const totalShops = shopsArray.length;
    const avgInspectionRate = totalShops > 0 ? 
        (shopsArray.reduce((sum, shop) => sum + shop.totalInspections, 0) / totalShops).toFixed(2) : 0;
    
    // Identify under-inspected shops (bottom 30%)
    const threshold = Math.ceil(totalShops * 0.3);
    const underInspectedShops = shopsArray.slice(-threshold);
    
    // Generate HTML report
    let html = `
        <!-- Digital Statistics Dashboard -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0;padding:15px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:12px;color:white;">
            <div style="text-align:center;">
                <div style="font-size:2em;font-weight:bold;margin-bottom:5px;">${totalShops}</div>
                <div style="font-size:0.9em;opacity:0.9;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>
            </div>
            <div style="text-align:center;">
                <div style="font-size:2em;font-weight:bold;margin-bottom:5px;">${avgInspectionRate}</div>
                <div style="font-size:0.9em;opacity:0.9;">ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</div>
            </div>
            <div style="text-align:center;">
                <div style="font-size:2em;font-weight:bold;margin-bottom:5px;">${Object.keys(areaAnalytics).length}</div>
                <div style="font-size:0.9em;opacity:0.9;">ÿπÿØÿØ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</div>
            </div>
            <div style="text-align:center;">
                <div style="font-size:2em;font-weight:bold;margin-bottom:5px;">${underInspectedShops.length}</div>
                <div style="font-size:0.9em;opacity:0.9;">ŸÖÿ≠ŸÑÿßÿ™ ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ£ŸàŸÑŸàŸäÿ©</div>
            </div>
        </div>
        
        <!-- Intelligence Recommendations -->
        <div style="margin:20px 0;padding:15px;background:#fff3cd;border:1px solid #ffeaa7;border-radius:8px;">
            <h4 style="margin:0 0 10px 0;color:#856404;display:flex;align-items:center;gap:8px;">
                üß† ÿßŸÑÿ™ŸàÿµŸäÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©
            </h4>
            <div style="font-size:0.95em;line-height:1.6;">
                <p style="margin:5px 0;"><strong>ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑÿπÿßŸÑŸäÿ©:</strong> ÿ≤ŸäÿßÿØÿ© ÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ™ÿßŸÑŸäÿ©:</p>
                <ul style="margin:5px 0;padding-right:20px;">`;
    
    underInspectedShops.slice(0, 5).forEach(shop => {
        const urgencyLevel = shop.daysSinceLastInspection > 14 ? 'üî¥ ÿπÿßÿ¨ŸÑ' : 
                            shop.daysSinceLastInspection > 7 ? 'üü° ŸÖÿ™Ÿàÿ≥ÿ∑' : 'üü¢ ÿπÿßÿØŸä';
        const areaName = shop.area || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        html += `<li>${shop.name} (${areaName}) - ${shop.totalInspections} ÿ™ŸÅÿ™Ÿäÿ¥ ${urgencyLevel}</li>`;
    });
    
    html += `
                </ul>
                <p style="margin:10px 0 5px 0;"><strong>ÿ™ŸàÿµŸäÿßÿ™ ÿπÿßŸÖÿ©:</strong></p>
                <p style="margin:5px 0;">‚Ä¢ ŸäŸèŸÜÿµÿ≠ ÿ®ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ÿ®ÿ¥ŸÉŸÑ ÿ£ŸÉÿ´ÿ± ÿπÿØÿßŸÑÿ© ÿπÿ®ÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</p>
                <p style="margin:5px 0;">‚Ä¢ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ™Ÿä ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß ŸÖŸÜÿ∞ ÿ£ŸÉÿ´ÿ± ŸÖŸÜ ÿ£ÿ≥ÿ®ŸàÿπŸäŸÜ</p>
                <p style="margin:5px 0;">‚Ä¢ ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ™ÿ∫ÿ∑Ÿäÿ© ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ© ŸÑŸÑŸÖŸÜÿßÿ∑ŸÇ ÿ∞ÿßÿ™ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸÖŸÜÿÆŸÅÿ∂</p>
            </div>
        </div>
        
        <!-- Visual Statistics Chart -->
        <div style="margin:20px 0;padding:15px;background:#f8f9fa;border-radius:8px;">
            <h4 style="margin:0 0 15px 0;color:#234085;">üìä ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿ±ÿ¶Ÿäÿ©</h4>
            <div id="shopChartContainer" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;">`;
    
    // Create simple visual bars for top shops
    const maxInspections = Math.max(...shopsArray.map(s => s.totalInspections));
    shopsArray.slice(0, 10).forEach(shop => {
        const percentage = (shop.totalInspections / maxInspections) * 100;
        const color = shop.totalInspections >= avgInspectionRate ? '#28a745' : 
                     shop.totalInspections >= avgInspectionRate * 0.5 ? '#ffc107' : '#dc3545';
        
        html += `
            <div style="text-align:center;margin:5px;">
                <div style="width:40px;height:${Math.max(20, percentage * 2)}px;background:${color};border-radius:4px;margin:0 auto 5px;position:relative;">
                    <span style="position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:0.8em;font-weight:bold;">${shop.totalInspections}</span>
                </div>
                <div style="font-size:0.7em;max-width:80px;word-wrap:break-word;">${shop.name.substring(0, 15)}${shop.name.length > 15 ? '...' : ''}</div>
            </div>`;
    });
    
    html += `
            </div>
            <div style="display:flex;justify-content:center;gap:20px;margin-top:15px;font-size:0.9em;">
                <span><span style="display:inline-block;width:12px;height:12px;background:#28a745;border-radius:2px;margin-left:5px;"></span>ŸÖÿ±ÿ™ŸÅÿπ</span>
                <span><span style="display:inline-block;width:12px;height:12px;background:#ffc107;border-radius:2px;margin-left:5px;"></span>ŸÖÿ™Ÿàÿ≥ÿ∑</span>
                <span><span style="display:inline-block;width:12px;height:12px;background:#dc3545;border-radius:2px;margin-left:5px;"></span>ŸÖŸÜÿÆŸÅÿ∂</span>
            </div>
        </div>
        
        <!-- Detailed Shop Analytics Table -->
        <table class="stats-table" id="enhancedReportTable">
            <thead>
                <tr>
                    <th>ÿßŸÑŸÖÿ≠ŸÑ</th>
                    <th>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                    <th>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</th>
                    <th>ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿßÿ®Ÿäÿπ</th>
                    <th>ŸÖÿπÿØŸÑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸä</th>
                    <th>ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥</th>
                    <th>ÿπÿØÿØ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</th>
                    <th>ÿµÿ®ÿßÿ≠Ÿä/ŸÖÿ≥ÿßÿ¶Ÿä</th>
                    <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                </tr>
            </thead>
            <tbody>`;
    
    shopsArray.forEach(shop => {
        const status = shop.totalInspections >= avgInspectionRate ? 'üü¢ ÿ¨ŸäÿØ' : 
                      shop.totalInspections >= avgInspectionRate * 0.5 ? 'üü° ŸÖÿ™Ÿàÿ≥ÿ∑' : 'üî¥ Ÿäÿ≠ÿ™ÿßÿ¨ ÿ£ŸàŸÑŸàŸäÿ©';
        const statusColor = shop.totalInspections >= avgInspectionRate ? '#d4edda' : 
                           shop.totalInspections >= avgInspectionRate * 0.5 ? '#fff3cd' : '#f8d7da';
        
        const areaName = shop.area || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        html += `
            <tr style="background:${statusColor};">
                <td style="font-weight:bold;">${shop.name}</td>
                <td>${areaName}</td>
                <td style="text-align:center;font-weight:bold;">${shop.totalInspections}</td>
                <td style="text-align:center;">${shop.weekCount}</td>
                <td style="text-align:center;">${shop.inspectionRate}</td>
                <td style="text-align:center;">${shop.lastInspected || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                <td style="text-align:center;">${shop.inspectors.length}</td>
                <td style="text-align:center;">${shop.shifts.morning}/${shop.shifts.evening}</td>
                <td style="text-align:center;">${status}</td>
            </tr>`;
    });
    
    html += `
            </tbody>
        </table>
        
        <!-- Area Summary -->
        <div style="margin-top:25px;">
            <h4 style="color:#234085;margin-bottom:15px;">üìç ŸÖŸÑÿÆÿµ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;">`;
    
    Object.entries(areaAnalytics).forEach(([area, stats]) => {
        const shopCount = stats.shops.size;
        const avgInspectionsPerShop = shopCount > 0 ? (stats.totalInspections / shopCount).toFixed(1) : 0;
        
        html += `
            <div style="padding:15px;background:#ffffff;border:1px solid #e0e0e0;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                <h5 style="margin:0 0 10px 0;color:#234085;">${area}</h5>
                <p style="margin:5px 0;font-size:0.9em;"><strong>ÿßŸÑŸÖÿ≠ŸÑÿßÿ™:</strong> ${shopCount}</p>
                <p style="margin:5px 0;font-size:0.9em;"><strong>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™:</strong> ${stats.totalInspections}</p>
                <p style="margin:5px 0;font-size:0.9em;"><strong>ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥:</strong> ${avgInspectionsPerShop}/ŸÖÿ≠ŸÑ</p>
                <p style="margin:5px 0;font-size:0.9em;"><strong>ÿßŸÑÿ£ÿ≥ÿßÿ®Ÿäÿπ ÿßŸÑŸÖÿ∫ÿ∑ÿßÿ©:</strong> ${stats.weeks.size}</p>
            </div>`;
    });
    
    html += `
            </div>
        </div>`;
    
    return html;
}

// Helper function to get week number of year
function getWeekOfYear(dateString) {
    const date = new Date(dateString);
    const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
    const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
    return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
}

function getMonthName(monthNumber) {
    const months = {
        '01': 'ŸäŸÜÿßŸäÿ±', '02': 'ŸÅÿ®ÿ±ÿßŸäÿ±', '03': 'ŸÖÿßÿ±ÿ≥', '04': 'ÿ£ÿ®ÿ±ŸäŸÑ',
        '05': 'ŸÖÿßŸäŸà', '06': 'ŸäŸàŸÜŸäŸà', '07': 'ŸäŸàŸÑŸäŸà', '08': 'ÿ£ÿ∫ÿ≥ÿ∑ÿ≥',
        '09': 'ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±', '10': 'ÿ£ŸÉÿ™Ÿàÿ®ÿ±', '11': 'ŸÜŸàŸÅŸÖÿ®ÿ±', '12': 'ÿØŸäÿ≥ŸÖÿ®ÿ±'
    };
    return months[monthNumber] || monthNumber;
}

function exportEnhancedReportToPDF() {
    const titleElement = document.getElementById('enhancedReportTitle');
    const tableElement = document.getElementById('enhancedReportTable');
    
    if (!titleElement || !tableElement) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ£ŸàŸÑÿßŸã');
        return;
    }
    
    // Add confirmation dialog
    if (!confirm('ŸáŸÑ ÿ™ÿ±ÿ∫ÿ® ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ŸÉŸÄ PDFÿü')) {
        return;
    }
    
    const wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '18px';
    wrap.style.width = tableElement.offsetWidth + 'px';
    
    const titleClone = titleElement.cloneNode(true);
    const tableClone = tableElement.cloneNode(true);
    tableClone.style.marginTop = '10px';
    
    wrap.appendChild(titleClone);
    wrap.appendChild(tableClone);
    document.body.appendChild(wrap);
    
    html2canvas(wrap, {
        backgroundColor: '#fff', 
        scale: 1.5,
        useCORS: true,
        allowTaint: true,
        width: wrap.scrollWidth,
        height: wrap.scrollHeight
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation: "landscape", unit: "pt", format: "a4"});
        const pageWidth = doc.internal.pageSize.getWidth();
        const imgProps = doc.getImageProperties(imgData);
        const pdfWidth = pageWidth - 80;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        doc.addImage(imgData, 'PNG', 40, 35, pdfWidth, pdfHeight);
        doc.save(`ÿ™ŸÇÿ±Ÿäÿ±_ŸÖÿ™ŸÇÿØŸÖ_${Date.now()}.pdf`);
        document.body.removeChild(wrap);
    }).catch(function(error) {
        console.error('PDF generation error:', error);
        document.body.removeChild(wrap);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± ŸÖŸÑŸÅ PDF');
    });
}

function exportEnhancedReportToExcel() {
    const tableElement = document.getElementById('enhancedReportTable');
    
    if (!tableElement) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ£ŸàŸÑÿßŸã');
        return;
    }
    
    // Add confirmation dialog
    if (!confirm('ŸáŸÑ ÿ™ÿ±ÿ∫ÿ® ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ŸÉŸÄ Excelÿü')) {
        return;
    }
    
    let ws_data = [];
    for (let r of tableElement.rows) {
        let row = [];
        for (let c of r.cells) row.push(c.textContent);
        ws_data.push(row);
    }
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿ™ŸÇÿØŸÖ");
    XLSX.writeFile(wb, `ÿ™ŸÇÿ±Ÿäÿ±_ŸÖÿ™ŸÇÿØŸÖ_${Date.now()}.xlsx`);
}
</script>
   <script>
// --- Toggle Functions for Inspector/Area Input Fields ---
function resetFormToggles() {
    // Reset inspector toggle
    const inspectorSelect = document.getElementById('formInspector');
    const inspectorInput = document.getElementById('newInspectorInput');
    inspectorSelect.style.display = 'inline-block';
    inspectorSelect.setAttribute('required', 'required'); // Ensure select has required
    inspectorInput.style.display = 'none';
    inspectorInput.removeAttribute('required'); // Remove required from input
    inspectorInput.value = '';
    
    // Reset area toggle
    const areaSelect = document.getElementById('formArea');
    const areaInput = document.getElementById('newAreaInput');
    areaSelect.style.display = 'inline-block';
    areaSelect.setAttribute('required', 'required'); // Ensure select has required
    areaInput.style.display = 'none';
    areaInput.removeAttribute('required'); // Remove required from input
    areaInput.value = '';
    
    // Reset custom shops dropdown
    customClearShopsSelection();
    
    // Update area-based shops
    fillShopsDropdowns();
}

// --- Modal Management Functions ---
function closeInspectorsModal() {
    document.getElementById('inspectorsModal').style.display = 'none';
}

function closeAreasModal() {
    document.getElementById('areasModal').style.display = 'none';
}

function closeShopsModal() {
    document.getElementById('shopsModal').style.display = 'none';
}

// ===== Ÿàÿ∏ÿßÿ¶ŸÅ ŸÖŸàÿØÿßŸÑ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿä =====
function showMonthlyScheduleModal() {
    // ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸÑÿßÿ™ÿ± ÿßŸÑÿ¥ŸáŸàÿ± ŸàÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ
    updateScheduleFilters();
    
    // ÿπÿ±ÿ∂ ÿßŸÑÿ¨ÿØŸàŸÑ ÿßŸÑŸÉÿßŸÖŸÑ
    displayFullScheduleTable();
    
    // ÿ•ÿ∏Ÿáÿßÿ± ÿ£Ÿà ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÖÿÆÿµÿµÿ© ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑
    const uploadBtn = document.getElementById('scheduleUploadBtn');
    const jsonBtn = document.getElementById('scheduleJsonBtn');
    
    // ÿ≤ÿ± ÿßŸÑÿ±ŸÅÿπ ŸÖÿ™ÿßÿ≠ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
    uploadBtn.style.display = 'flex';
    
    // ÿ≤ÿ± JSON ŸÖÿ™ÿßÿ≠ ŸÑŸÑŸÖÿ∑Ÿàÿ±ŸäŸÜ ŸÅŸÇÿ∑
    if (isDev || window.isDev) {
        jsonBtn.style.display = 'flex';
    } else {
        jsonBtn.style.display = 'none';
    }
    
    // ÿπÿ±ÿ∂ ÿßŸÑŸÖŸàÿØÿßŸÑ ŸÖÿπ ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖÿ™ÿØÿßÿÆŸÑÿ©
    const modalElement = document.getElementById('monthlyScheduleModal');
    modalElement.style.display = 'flex';
    modalElement.classList.add('nested-modal');
}

function closeMonthlyScheduleModal() {
    const modalElement = document.getElementById('monthlyScheduleModal');
    modalElement.style.display = 'none';
    modalElement.classList.remove('nested-modal');
}

function updateScheduleFilters() {
    // ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸÑÿ™ÿ± ÿßŸÑÿ¥ŸáŸàÿ±
    const monthFilter = document.getElementById('scheduleMonthFilter');
    const monthsSet = new Set();
    
    inspectionData.forEach(item => {
        const date = new Date(item.day);
        const monthYear = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
        monthsSet.add(monthYear);
    });
    
    monthFilter.innerHTML = '<option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ¥ŸáŸàÿ±</option>';
    Array.from(monthsSet).sort().forEach(monthYear => {
        const [year, month] = monthYear.split('-');
        const monthNames = ['ŸäŸÜÿßŸäÿ±', 'ŸÅÿ®ÿ±ÿßŸäÿ±', 'ŸÖÿßÿ±ÿ≥', 'ÿ£ÿ®ÿ±ŸäŸÑ', 'ŸÖÿßŸäŸà', 'ŸäŸàŸÜŸäŸà', 
                           'ŸäŸàŸÑŸäŸà', 'ÿ£ÿ∫ÿ≥ÿ∑ÿ≥', 'ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±', 'ÿ£ŸÉÿ™Ÿàÿ®ÿ±', 'ŸÜŸàŸÅŸÖÿ®ÿ±', 'ÿØŸäÿ≥ŸÖÿ®ÿ±'];
        const monthName = monthNames[parseInt(month) - 1];
        monthFilter.innerHTML += `<option value="${monthYear}">${monthName} ${year}</option>`;
    });
    
    // ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸÑÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ
    const inspectorFilter = document.getElementById('scheduleInspectorFilter');
    const inspectorsSet = new Set(inspectionData.map(item => item.inspector));
    
    inspectorFilter.innerHTML = '<option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</option>';
    Array.from(inspectorsSet).sort().forEach(inspector => {
        inspectorFilter.innerHTML += `<option value="${inspector}">${inspector}</option>`;
    });
}

function displayFullScheduleTable() {
    let tableHTML = `
        <table class="plan-table" style="margin: 0;">
            <thead>
                <tr>
                    <th style="width: 18%;">ÿßŸÑŸÖŸÅÿ™ÿ¥</th>
                    <th style="width: 12%;">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                    <th style="width: 10%;">ÿßŸÑŸäŸàŸÖ</th>
                    <th style="width: 12%;">ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©</th>
                    <th style="width: 15%;">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                    <th style="width: 8%;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</th>
                    <th style="width: 25%;">ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</th>
                </tr>
            </thead>
            <tbody id="scheduleTableBody">
    `;
    
    // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ´ŸÖ ÿßŸÑŸÖŸÅÿ™ÿ¥
    const sortedData = inspectionData.slice().sort((a, b) => {
        const dateA = new Date(a.day);
        const dateB = new Date(b.day);
        if (dateA.getTime() !== dateB.getTime()) {
            return dateA - dateB;
        }
        return a.inspector.localeCompare(b.inspector);
    });
    
    sortedData.forEach((item, index) => {
        const date = new Date(item.day);
        const dayNames = ['ÿßŸÑÿ£ÿ≠ÿØ', 'ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ', 'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°', 'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°', 'ÿßŸÑÿÆŸÖŸäÿ≥', 'ÿßŸÑÿ¨ŸÖÿπÿ©', 'ÿßŸÑÿ≥ÿ®ÿ™'];
        const dayName = dayNames[date.getDay()];
        
        tableHTML += `
            <tr data-inspector="${item.inspector}" data-date="${item.day}">
                <td>${item.inspector}</td>
                <td>${item.day}</td>
                <td>${dayName}</td>
                <td>
                    <span class="shift-badge ${item.shift === 'ÿµÿ®ÿßÿ≠Ÿäÿ©' ? 'morning' : 'evening'}">
                        ${item.shift}
                    </span>
                </td>
                <td style="color:${getAreaName(item.area) === 'ÿ≥ŸàŸÇ ÿßŸÑŸÖŸäŸÜÿßÿ°' || getAreaName(item.area) === 'ÿ≥ŸàŸÇ ÿßŸÑÿ™ÿ±ÿßÿ´' ? '#1976d2' : '#d32f2f'};">${getAreaName(item.area)}</td>
                <td style="text-align: center;">
                    <span class="shops-count">${item.shops.length}</span>
                </td>
                <td>
                    <div class="shops-list" style="font-size: 0.85em; max-height: 60px; overflow-y: auto;">
                        ${item.shops.map(shop => `<span class="shop-tag">${shop}</span>`).join(' ')}
                    </div>
                </td>
            </tr>
        `;
    });
    
    tableHTML += `
            </tbody>
        </table>
    `;
    
    document.getElementById('monthlyScheduleContent').innerHTML = tableHTML;
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ£ŸÜŸÖÿßÿ∑ ŸÑŸÑÿπŸÜÿßÿµÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©
    addScheduleTableStyles();
}

function addScheduleTableStyles() {
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸÜŸÖÿßÿ∑ CSS ŸÑŸÑÿ¨ÿØŸàŸÑ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿ©
    if (!document.getElementById('scheduleTableStyles')) {
        const style = document.createElement('style');
        style.id = 'scheduleTableStyles';
        style.textContent = `
            .shift-badge {
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 0.8em;
                font-weight: bold;
                color: white;
            }
            .shift-badge.morning {
                background: linear-gradient(135deg, #28a745, #20c997);
            }
            .shift-badge.evening {
                background: linear-gradient(135deg, #fd7e14, #ffc107);
            }
            .shops-count {
                background: #e3f2fd;
                color: #1976d2;
                padding: 4px 8px;
                border-radius: 50%;
                font-weight: bold;
                font-size: 0.9em;
            }
            .shop-tag {
                display: inline-block;
                background: #f0f9ff;
                border: 1px solid #bae6fd;
                color: #0369a1;
                padding: 2px 6px;
                margin: 1px;
                border-radius: 8px;
                font-size: 0.8em;
            }
        `;
        document.head.appendChild(style);
    }
}

function filterScheduleTable() {
    const searchText = document.getElementById('scheduleSearchInput').value.toLowerCase();
    const selectedMonth = document.getElementById('scheduleMonthFilter').value;
    const selectedInspector = document.getElementById('scheduleInspectorFilter').value;
    
    const tableBody = document.getElementById('scheduleTableBody');
    const rows = tableBody.getElementsByTagName('tr');
    
    for (let row of rows) {
        const inspector = row.cells[0].textContent.toLowerCase();
        const date = row.cells[1].textContent;
        const area = row.cells[4].textContent.toLowerCase();
        const shops = row.cells[6].textContent.toLowerCase();
        
        // ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÜÿµŸä
        const matchesSearch = !searchText || 
            inspector.includes(searchText) || 
            area.includes(searchText) || 
            shops.includes(searchText);
        
        // ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑÿ¥Ÿáÿ±
        const matchesMonth = !selectedMonth || date.startsWith(selectedMonth);
        
        // ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑŸÖŸÅÿ™ÿ¥
        const matchesInspector = !selectedInspector || row.cells[0].textContent === selectedInspector;
        
        // ÿ•ÿ∏Ÿáÿßÿ± ÿ£Ÿà ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿµŸÅ
        row.style.display = (matchesSearch && matchesMonth && matchesInspector) ? '' : 'none';
    }
}

// ===== Ÿàÿ∏ÿßÿ¶ŸÅ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ŸàŸÉŸÜ =====
function showTokenPopup() {
    document.getElementById("tokenPopup").style.display = "flex";
    document.getElementById("tokenInput").value = "";
    document.getElementById("tokenInput").focus();
    document.getElementById("tokenError").textContent = "";
}

function hideTokenPopup() {
    document.getElementById("tokenPopup").style.display = "none";
}

function saveTokenFromPopup() {
    const token = document.getElementById("tokenInput").value.trim();
    if (!token) {
        document.getElementById("tokenError").textContent = "‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿ≥ÿ±Ÿä!";
        return;
    }
    localStorage.setItem("devToken", token);
    hideTokenPopup();
    // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠
    alert("‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸàŸÉŸÜ ÿ®ŸÜÿ¨ÿßÿ≠!\n\n" +
          "ÿßŸÑÿ¢ŸÜ ŸäŸÖŸÉŸÜŸÉ:\n" +
          "‚Ä¢ ÿ™ŸÅÿπŸäŸÑ/ÿ•ŸÑÿ∫ÿßÿ° Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ\n" +
          "‚Ä¢ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ•ŸÑŸâ GitHub\n" +
          "‚Ä¢ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿπŸÑŸâ GitHub\n\n" +
          "ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿ≥ÿ™ÿ™ŸÖ ŸÖÿ≤ÿßŸÖŸÜÿ™Ÿáÿß ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ©!");
}

function useDefaultToken() {
    // Use the repository's default token
    const defaultToken = "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";
    localStorage.setItem("devToken", defaultToken);
    hideTokenPopup();
    alert("‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä ÿ®ŸÜÿ¨ÿßÿ≠!\n\n" +
          "ÿßŸÑÿ¢ŸÜ ŸäŸÖŸÉŸÜŸÉ:\n" +
          "‚Ä¢ ÿ™ŸÅÿπŸäŸÑ/ÿ•ŸÑÿ∫ÿßÿ° Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ\n" +
          "‚Ä¢ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ•ŸÑŸâ GitHub\n" +
          "‚Ä¢ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿπŸÑŸâ GitHub\n\n" +
          "ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿ≥ÿ™ÿ™ŸÖ ŸÖÿ≤ÿßŸÖŸÜÿ™Ÿáÿß ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ©!");
}

// ===== Ÿàÿ∏ÿßÿ¶ŸÅ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ•ŸÑŸâ GitHub =====
// ÿØÿßŸÑÿ© ŸÖÿ¥ÿ™ÿ±ŸÉÿ© ŸÑÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ•ŸÑŸâ GitHub Repository
async function uploadFileToGitHub(file, category, description = '') {
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÖÿ∑Ÿàÿ±
    if (!isDev && !window.isDev) {
        alert('‚ùå ÿπÿ∞ÿ±ÿßŸãÿå ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÖÿ™ÿßÿ≠ ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑\n\nŸäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÉŸÖÿ∑Ÿàÿ± ÿ£ŸàŸÑÿßŸã');
        return { success: false, error: 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸÑÿßÿ≠Ÿäÿ©' };
    }
    
    const repo = "aliabdelaal-adm/Monthly_inspection_plan";
    let token = localStorage.getItem("devToken");
    
    // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ÿßŸÑÿ™ŸàŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã ŸàŸÑŸÉŸÜ ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÖÿ≥ÿ¨ŸÑ ÿßŸÑÿØÿÆŸàŸÑÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
    if (!token && (isDev || window.isDev)) {
        const defaultToken = "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";
        localStorage.setItem("devToken", defaultToken);
        token = defaultToken;
    }
    
    if (!token) {
        showTokenPopup();
        return { success: false, error: 'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ŸàŸÉŸÜ' };
    }
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ (ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 25 MB ŸÑŸÑŸÄ GitHub)
    const maxSize = 25 * 1024 * 1024;
    if (file.size > maxSize) {
        alert('‚ùå ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã!\n\nŸäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ£ŸÇŸÑ ŸÖŸÜ 25 MB\nÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ≠ÿßŸÑŸä: ' + (file.size / (1024 * 1024)).toFixed(2) + ' MB');
        return { success: false, error: 'ÿßŸÑŸÖŸÑŸÅ ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã' };
    }
    
    // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ
    const loadingMsg = document.createElement('div');
    loadingMsg.id = 'uploadLoadingMsg';
    loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:99999;text-align:center;min-width:300px;';
    loadingMsg.innerHTML = `
        <div style="font-size:3em;margin-bottom:15px;">‚è≥</div>
        <div style="font-size:1.2em;color:#234085;font-weight:bold;margin-bottom:10px;">ÿ¨ÿßÿ±Ÿä ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ...</div>
        <div style="font-size:0.9em;color:#666;">${file.name}</div>
        <div style="margin-top:15px;font-size:0.85em;color:#999;">ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±...</div>
    `;
    document.body.appendChild(loadingMsg);
    
    try {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ŸàŸÉŸÜ ÿ£ŸàŸÑÿßŸã
        const testRes = await fetch(`https://api.github.com/repos/${repo}`, {
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            }
        });
        
        if (!testRes.ok) {
            document.body.removeChild(loadingMsg);
            
            if (testRes.status === 401) {
                localStorage.removeItem("devToken");
                alert('‚ùå ÿßŸÑÿ™ŸàŸÉŸÜ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ÿ£Ÿà ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©!\n\nÿ≥Ÿäÿ™ŸÖ ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ŸÑÿ•ÿØÿÆÿßŸÑ ÿ™ŸàŸÉŸÜ ÿ¨ÿØŸäÿØ.');
                showTokenPopup();
                return { success: false, error: 'ÿßŸÑÿ™ŸàŸÉŸÜ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠' };
            } else if (testRes.status === 403) {
                localStorage.removeItem("devToken");
                alert('‚ùå ÿßŸÑÿ™ŸàŸÉŸÜ ŸÑŸäÿ≥ ŸÑÿØŸäŸá ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ŸÉÿßŸÅŸäÿ©!\n\nŸäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ≠ÿ™ŸàŸä ÿßŸÑÿ™ŸàŸÉŸÜ ÿπŸÑŸâ ÿµŸÑÿßÿ≠Ÿäÿ© "repo".\nÿ≥Ÿäÿ™ŸÖ ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ŸÑÿ•ÿØÿÆÿßŸÑ ÿ™ŸàŸÉŸÜ ÿ¨ÿØŸäÿØ.');
                showTokenPopup();
                return { success: false, error: 'ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸäÿ©' };
            }
        }
        
        // ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ ŸÉŸÄ base64
        const content = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result.split(',')[1];
                resolve(base64);
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
        
        const fileName = file.name;
        const filePath = `files/${category}/${fileName}`;
        
        // ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿ•ŸÑŸâ GitHub
        const uploadRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: `ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿ¨ÿØŸäÿØ: ${fileName}`,
                content: content
            })
        });
        
        // ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
        document.body.removeChild(loadingMsg);
        
        if (uploadRes.status === 201) {
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅ files.json
            await updateFilesRegistryAfterUpload(fileName, filePath, category, file.size, description, token);
            return { success: true, fileName, filePath };
        } else if (uploadRes.status === 422) {
            alert('‚ùå ŸÖŸÑŸÅ ÿ®ŸÜŸÅÿ≥ ÿßŸÑÿßÿ≥ŸÖ ŸÖŸàÿ¨ŸàÿØ ŸÖÿ≥ÿ®ŸÇÿßŸã!\n\nÿßŸÑÿ≠ŸÑŸàŸÑ:\n1. ÿ£ÿπÿØ ÿ™ÿ≥ŸÖŸäÿ© ÿßŸÑŸÖŸÑŸÅ\n2. ÿ£Ÿà ÿßÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÇÿØŸäŸÖ ŸÖŸÜ ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖÿ∑Ÿàÿ± ÿ£ŸàŸÑÿßŸã');
            return { success: false, error: 'ŸÖŸÑŸÅ ŸÖŸàÿ¨ŸàÿØ ŸÖÿ≥ÿ®ŸÇÿßŸã' };
        } else if (uploadRes.status === 401 || uploadRes.status === 403) {
            localStorage.removeItem("devToken");
            alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑÿ™ŸàŸÉŸÜ!\n\nÿ≥Ÿäÿ™ŸÖ ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ŸÑÿ•ÿØÿÆÿßŸÑ ÿ™ŸàŸÉŸÜ ÿ¨ÿØŸäÿØ.');
            showTokenPopup();
            return { success: false, error: 'ÿÆÿ∑ÿ£ ŸÅŸä ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑÿ™ŸàŸÉŸÜ' };
        } else {
            const err = await uploadRes.json().catch(() => ({ message: `HTTP ${uploadRes.status}` }));
            alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ!\n\nÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ: ' + (err.message || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ') + '\nÿßŸÑÿ±ŸÖÿ≤: ' + uploadRes.status);
            return { success: false, error: err.message || 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ±ŸÅÿπ' };
        }
    } catch (error) {
        // ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£
        const loadingElement = document.getElementById('uploadLoadingMsg');
        if (loadingElement) {
            document.body.removeChild(loadingElement);
        }
        
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ:', error);
        
        if (error.message && (error.message.includes("NetworkError") || error.message.includes("Failed to fetch"))) {
            alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™!\n\nŸäÿ±ÿ¨Ÿâ:\n1. ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™\n2. ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ');
        } else {
            alert('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÇÿπ!\n\nÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ: ' + error.message);
        }
        
        return { success: false, error: error.message };
    }
}

// ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅ files.json ÿ®ÿπÿØ ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿ¨ÿØŸäÿØ
async function updateFilesRegistryAfterUpload(fileName, filePath, category, fileSize, description, token) {
    try {
        const repo = "aliabdelaal-adm/Monthly_inspection_plan";
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ files.json ÿßŸÑÿ≠ÿßŸÑŸä
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            }
        });
        
        let filesData = { files: [], categories: [], lastUpdate: new Date().toISOString() };
        let currentSha = "";
        
        if (res.ok) {
            const file = await res.json();
            filesData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
            currentSha = file.sha;
        }
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¨ÿØŸäÿØ
        const newFile = {
            id: Date.now().toString(),
            name: fileName,
            path: filePath,
            category: category,
            type: fileName.split('.').pop().toLowerCase(),
            size: fileSize,
            uploadDate: new Date().toISOString(),
            description: description || fileName,
            uploader: "ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ",
            visible: true
        };
        
        filesData.files.push(newFile);
        filesData.lastUpdate = new Date().toISOString();
        
        // ÿ≠ŸÅÿ∏ ŸÖŸÑŸÅ files.json ÿßŸÑŸÖÿ≠ÿØÿ´
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(filesData, null, 2))));
        await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: `ÿ™ÿ≠ÿØŸäÿ´ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ®ÿπÿØ ÿ±ŸÅÿπ: ${fileName}`,
                content: content,
                sha: currentSha
            })
        });
        
        return true;
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™:', error);
        return false;
    }
}

// ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ® ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ (ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑)
function handleScheduleUploadRequest() {
    document.getElementById('scheduleFileInput').click();
}

// ÿ™ÿ£ŸÉŸäÿØ ÿ™ÿ≠ŸÖŸäŸÑ PDF ŸÖÿπ ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©
function confirmExportScheduleToPDF() {
    if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ŸÉŸÖŸÑŸÅ PDFÿü')) {
        exportScheduleToPDF();
    }
}

// ÿ™ÿ£ŸÉŸäÿØ ÿ™ÿ≠ŸÖŸäŸÑ Excel ŸÖÿπ ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©
function confirmExportScheduleToExcel() {
    if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ŸÉŸÖŸÑŸÅ Excelÿü')) {
        exportScheduleToExcel();
    }
}

// --- ŸÖÿ≥ÿßÿπÿØ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ---
async function processPDFFile(file) {
    try {
        const arrayBuffer = await file.arrayBuffer();
        
        // ÿ•ÿπÿØÿßÿØ PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // ÿ™ÿ≠ŸÖŸäŸÑ PDF
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        let fullText = '';
        
        // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÜÿµ ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÅÿ≠ÿßÿ™
        for (let i = 1; i <= Math.min(pdf.numPages, 10); i++) { // ŸÜÿ≠ÿØÿØ ÿ®ŸÄ 10 ÿµŸÅÿ≠ÿßÿ™ ŸÉÿ≠ÿØ ÿ£ŸÇÿµŸâ ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ®ÿ∑ÿ°
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += pageText + '\n';
        }
        
        return {
            text: fullText,
            numPages: pdf.numPages,
            success: true
        };
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© PDF:', error);
        return {
            text: '',
            numPages: 0,
            success: false,
            error: error.message
        };
    }
}

async function processTextFile(file) {
    try {
        const text = await file.text();
        return {
            text: text,
            success: true
        };
    } catch (error) {
        return {
            text: '',
            success: false,
            error: error.message
        };
    }
}

async function processExcelFile(file) {
    try {
        const data = new Uint8Array(await file.arrayBuffer());
        const workbook = XLSX.read(data, {type: 'array'});
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);
        
        return {
            data: jsonData,
            sheetNames: workbook.SheetNames,
            success: true
        };
    } catch (error) {
        return {
            data: [],
            success: false,
            error: error.message
        };
    }
}

async function handleScheduleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const fileName = file.name;
    const fileExtension = fileName.split('.').pop().toLowerCase();
    
    // ÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ±ŸÅŸàÿπ
    displayUploadedFileInfo(fileName, file.size);
    
    // ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿ•ŸÑŸâ GitHub (ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑)
    if (isDev || window.isDev) {
        const uploadResult = await uploadFileToGitHub(file, 'schedules', `ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ - ${fileName}`);
        if (uploadResult.success) {
            alert(`‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nÿßŸÑŸÖŸÑŸÅ: ${fileName}\nÿßŸÑÿ¢ŸÜ ŸÖÿ™ÿßÿ≠ ŸÑŸÑÿ¨ŸÖŸäÿπ ŸÅŸä ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™`);
        } else {
            alert(`‚ö†Ô∏è ÿ™ŸÖ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ ŸÖÿ≠ŸÑŸäÿßŸãÿå ŸÑŸÉŸÜ ŸÅÿ¥ŸÑ ÿ±ŸÅÿπŸá ÿ•ŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ: ${uploadResult.error}`);
        }
    }
    
    // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ£ŸÜŸàÿßÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ© ŸÖÿ≠ŸÑŸäÿßŸã
    if (fileExtension === 'json') {
        handleJSONFile(file);
    } else if (['xlsx', 'xls'].includes(fileExtension)) {
        handleExcelFileForSchedule(file);
    } else if (fileExtension === 'pdf') {
        handlePDFFileForSchedule(file);
    } else if (['csv'].includes(fileExtension)) {
        handleCSVFile(file);
    } else if (['txt', 'doc', 'docx'].includes(fileExtension)) {
        handleTextFileForSchedule(file);
    } else {
        if (!isDev && !window.isDev) {
            alert(`‚úÖ ÿ™ŸÖ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ "${fileName}" ŸÖÿ≠ŸÑŸäÿßŸã! ŸÜŸàÿπ ÿßŸÑŸÖŸÑŸÅ: ${fileExtension.toUpperCase()}\n\nÿßŸÑŸÖŸÑŸÅ ŸÖÿ™ÿßÿ≠ ŸÑŸÑŸÖÿπÿßŸäŸÜÿ©. ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ.`);
        }
    }
    
    // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ input ÿßŸÑŸÖŸÑŸÅ
    event.target.value = '';
}

async function handleJSONFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const jsonData = JSON.parse(e.target.result);
            if (jsonData.inspectionData && Array.isArray(jsonData.inspectionData)) {
                // ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©
                inspectionData = jsonData.inspectionData;
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸàÿ¨ŸàÿØÿ©
                if (jsonData.inspectors) inspectorsData = jsonData.inspectors;
                if (jsonData.areas) areasData = jsonData.areas;
                if (jsonData.shops) shopsData = jsonData.shops;
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ Ÿàÿ•ÿπÿßÿØÿ© ÿßŸÑÿπÿ±ÿ∂
                saveInspectionData();
                displayFullScheduleTable();
                updateScheduleFilters();
                
                alert('‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ŸÖŸÑŸÅ JSON ÿ®ŸÜÿ¨ÿßÿ≠!');
            } else {
                alert('‚ùå ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠. Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ inspectionData');
            }
        } catch (error) {
            alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ: ' + error.message);
        }
    };
    reader.readAsText(file);
}

async function handleExcelFileForSchedule(file) {
    const result = await processExcelFile(file);
    if (result.success) {
        alert(`‚úÖ ÿ™ŸÖ ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ Excel ÿ®ŸÜÿ¨ÿßÿ≠!\n\nÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${result.data.length} ÿ≥ÿ¨ŸÑ ŸÅŸä ${result.sheetNames.length} Ÿàÿ±ŸÇÿ© ÿπŸÖŸÑ.\n\nŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ Ÿàÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸáÿß ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ.`);
        console.log('ÿ®ŸäÿßŸÜÿßÿ™ Excel:', result.data);
        // ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇ ÿ•ÿ∂ÿßŸÅŸä ŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿ®ŸäÿßŸÜÿßÿ™ Excel
    } else {
        alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ Excel: ' + result.error);
    }
}

async function handlePDFFileForSchedule(file) {
    alert('üîÑ ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ŸÖŸÑŸÅ PDF... ŸÇÿØ Ÿäÿ≥ÿ™ÿ∫ÿ±ŸÇ Ÿáÿ∞ÿß ÿ®ÿπÿ∂ ÿßŸÑŸàŸÇÿ™.');
    
    const result = await processPDFFile(file);
    if (result.success) {
        alert(`‚úÖ ÿ™ŸÖ ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ PDF ÿ®ŸÜÿ¨ÿßÿ≠!\n\nÿπÿØÿØ ÿßŸÑÿµŸÅÿ≠ÿßÿ™: ${result.numPages}\nÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÜÿµ ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ.\n\nŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ.`);
        console.log('ŸÜÿµ PDF:', result.text);
        // ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇ ÿ•ÿ∂ÿßŸÅŸä ŸÑŸÖÿπÿßŸÑÿ¨ÿ© ŸÜÿµ PDF
    } else {
        alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ PDF: ' + result.error);
    }
}

async function handleCSVFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csvText = e.target.result;
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }
            
            alert(`‚úÖ ÿ™ŸÖ ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ CSV ÿ®ŸÜÿ¨ÿßÿ≠!\n\nÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${data.length} ÿ≥ÿ¨ŸÑ ŸÖÿπ ${headers.length} ÿπŸÖŸàÿØ.\n\nŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ.`);
            console.log('ÿ®ŸäÿßŸÜÿßÿ™ CSV:', data);
        } catch (error) {
            alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ CSV: ' + error.message);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

async function handleTextFileForSchedule(file) {
    const result = await processTextFile(file);
    if (result.success) {
        alert(`‚úÖ ÿ™ŸÖ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÜÿµŸä ÿ®ŸÜÿ¨ÿßÿ≠!\n\nÿ≠ÿ¨ŸÖ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ: ${result.text.length} ÿ≠ÿ±ŸÅ\n\nŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ.`);
        console.log('ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÖŸÑŸÅ:', result.text);
    } else {
        alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÜÿµŸä: ' + result.error);
    }
}

function displayUploadedFileInfo(fileName, fileSize) {
    const fileSizeKB = Math.round(fileSize / 1024);
    const uploadTime = new Date().toLocaleString('ar-AE');
    
    const infoDiv = document.getElementById('uploadedFilesInfo');
    const listDiv = document.getElementById('uploadedFilesList');
    
    const fileInfo = `
        <div style="background: white; padding: 8px; margin: 4px 0; border-radius: 4px; border-left: 4px solid #28a745;">
            <strong>${fileName}</strong> (${fileSizeKB} KB) - ÿ™ŸÖ ÿßŸÑÿ±ŸÅÿπ: ${uploadTime}
        </div>
    `;
    
    listDiv.innerHTML = fileInfo + listDiv.innerHTML;
    infoDiv.style.display = 'block';
}

function exportScheduleToPDF() {
    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÜŸÅÿ≥ ÿ¢ŸÑŸäÿ© ÿ™ÿµÿØŸäÿ± PDF ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
    const originalTable = document.getElementById('inspectorPlanTable');
    const scheduleTable = document.querySelector('#monthlyScheduleContent table');
    
    if (!scheduleTable) {
        alert('ŸÑÿß ŸäŸàÿ¨ÿØ ÿ¨ÿØŸàŸÑ ŸÑŸÑÿ™ÿµÿØŸäÿ±');
        return;
    }
    
    // ÿ™ÿπŸäŸäŸÜ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ŸÖÿ§ŸÇÿ™ÿßŸã ŸÉÿßŸÑÿ¨ÿØŸàŸÑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ŸÑŸÑÿ™ÿµÿØŸäÿ±
    scheduleTable.id = 'tempScheduleTableForExport';
    const tempContainer = document.createElement('div');
    tempContainer.appendChild(scheduleTable.cloneNode(true));
    document.body.appendChild(tempContainer);
    
    // ÿ™ÿµÿØŸäÿ± PDF
    const { jsPDF } = window.jspdf;
    html2canvas(tempContainer, {
        allowTaint: true,
        scale: 2,
        useCORS: true
    }).then(function(canvas) {
        const imgData = canvas.toDataURL('image/png');
        const doc = new jsPDF('l', 'mm', 'a4'); // landscape orientation
        
        const pdfWidth = doc.internal.pageSize.getWidth() - 20;
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        doc.addImage(imgData, 'PNG', 10, 20, pdfWidth, pdfHeight);
        doc.save(`ÿ¨ÿØŸàŸÑ_ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™_ÿßŸÑÿ¥Ÿáÿ±Ÿä_${new Date().toISOString().split('T')[0]}.pdf`);
        
        // ÿ™ŸÜÿ∏ŸäŸÅ
        document.body.removeChild(tempContainer);
    }).catch(function(error) {
        console.error('PDF generation error:', error);
        document.body.removeChild(tempContainer);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± ŸÖŸÑŸÅ PDF');
    });
}

function exportScheduleToExcel() {
    const scheduleTable = document.querySelector('#monthlyScheduleContent table');
    if (!scheduleTable) { 
        alert("ŸÑÿß ŸäŸàÿ¨ÿØ ÿ¨ÿØŸàŸÑ ŸÑŸÑÿ™ÿµÿØŸäÿ±"); 
        return; 
    }
    
    let ws_data = [];
    for(let r of scheduleTable.rows) {
        let row = [];
        for(let c of r.cells) {
            // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÜÿµ ŸÖŸÜ HTML tags
            let cellText = c.textContent || c.innerText;
            row.push(cellText);
        }
        ws_data.push(row);
    }
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™");
    XLSX.writeFile(wb, `ÿ¨ÿØŸàŸÑ_ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™_ÿßŸÑÿ¥Ÿáÿ±Ÿä_${new Date().toISOString().split('T')[0]}.xlsx`);
}

function downloadScheduleAsJSON() {
    const scheduleData = {
        inspectionData: inspectionData,
        inspectors: inspectorsData,
        areas: areasData,
        shops: shopsData,
        lastUpdate: new Date().toISOString(),
        exportedAt: new Date().toISOString(),
        totalEntries: inspectionData.length
    };
    
    const dataStr = JSON.stringify(scheduleData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `ÿ¨ÿØŸàŸÑ_ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    // ÿ™ŸÜÿ∏ŸäŸÅ
    URL.revokeObjectURL(link.href);
}

function printScheduleTable() {
    // ÿßÿ≠ŸÅÿ∏ ÿπŸÜŸàÿßŸÜ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ£ÿµŸÑŸä
    const originalTitle = document.title;
    
    // ÿ∫ŸäŸëÿ± ÿπŸÜŸàÿßŸÜ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÖÿ§ŸÇÿ™ÿßŸã ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©
    document.title = 'ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿä';
    
    // ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÖÿ≠ÿ™ŸàŸâ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™
    const scheduleTable = document.getElementById('scheduleTableBody')?.parentElement || document.querySelector('#monthlyScheduleModal table');
    const scheduleTitle = document.querySelector('#monthlyScheduleModal .stats-title');
    
    if (!scheduleTable) {
        alert('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©');
        return;
    }
    
    // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿ¨ÿØŸäÿØÿ© ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©
    const printWindow = window.open('', '_blank');
    
    const printContent = `
    <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <title>ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿä</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
            
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: 'Cairo', Arial, sans-serif;
                font-size: 12px;
                line-height: 1.4;
                color: #333;
                background: white;
                padding: 20px;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 30px;
                border-bottom: 3px solid #007bff;
                padding-bottom: 15px;
            }
            
            .print-title {
                font-size: 24px;
                font-weight: bold;
                color: #007bff;
                margin-bottom: 10px;
            }
            
            .print-date {
                font-size: 14px;
                color: #666;
                margin-bottom: 5px;  
            }
            
            .schedule-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
                font-size: 11px;
            }
            
            .schedule-table th,
            .schedule-table td {
                border: 1px solid #ddd;
                padding: 8px 6px;
                text-align: center;
                vertical-align: middle;
            }
            
            .schedule-table th {
                background-color: #f8f9fa;
                font-weight: bold;
                color: #333;
                font-size: 12px;
            }
            
            .schedule-table tbody tr:nth-child(even) {
                background-color: #f9f9f9;
            }
            
            .schedule-table tbody tr:hover {
                background-color: #e3f2fd;
            }
            
            .print-footer {
                margin-top: 30px;
                text-align: center;
                font-size: 10px;
                color: #666;
                border-top: 1px solid #ddd;
                padding-top: 15px;
            }
            
            @media print {
                body {
                    padding: 0;
                    font-size: 10px;
                }
                
                .print-header {
                    margin-bottom: 20px;
                }
                
                .print-title {
                    font-size: 20px;
                }
                
                .schedule-table {
                    font-size: 9px;
                }
                
                .schedule-table th,
                .schedule-table td {
                    padding: 4px 3px;
                }
            }
        </style>
    </head>
    <body>
        <div class="print-header">
            <div class="print-title">üìã ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿä ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</div>
            <div class="print-date">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©: ${new Date().toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            })}</div>
            <div class="print-date">ÿßŸÑŸàŸÇÿ™: ${new Date().toLocaleTimeString('ar-SA')}</div>
        </div>
        
        ${scheduleTable.outerHTML}
        
        <div class="print-footer">
            <p>ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° Ÿáÿ∞ÿß ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ŸÖŸÜ ŸÜÿ∏ÿßŸÖ ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©</p>
            <p>¬© ${new Date().getFullYear()} - ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ©</p>
        </div>
    </body>
    </html>`;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // ÿßŸÜÿ™ÿ∏ÿ± ÿ≠ÿ™Ÿâ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿ´ŸÖ ÿßÿ∑ÿ®ÿπ
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
    };
    
    // ÿßÿ≥ÿ™ÿπÿØ ÿßŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑÿ£ÿµŸÑŸä
    document.title = originalTitle;
}

function addNewInspector() {
    const nameInput = document.getElementById('newInspectorName');
    const name = nameInput.value.trim();
    if (!name) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÅÿ™ÿ¥');
        return;
    }
    
    if (inspectorsData.find(insp => insp.name === name)) {
        alert('Ÿáÿ∞ÿß ÿßŸÑŸÖŸÅÿ™ÿ¥ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ');
        return;
    }
    
    const newId = 'insp_' + Date.now();
    inspectorsData.push({id: newId, name: name});
    inspectors = inspectorsData.map(i => i.name);
    
    fillInspectorsDropdowns();
    displayInspectorsList();
    nameInput.value = '';
    saveDataToJSON();
}

function addNewArea() {
    const nameInput = document.getElementById('newAreaName');
    const name = nameInput.value.trim();
    if (!name) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©');
        return;
    }
    
    if (areasData.find(area => area.name === name)) {
        alert('Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÖŸàÿ¨ŸàÿØÿ© ÿ®ÿßŸÑŸÅÿπŸÑ');
        return;
    }
    
    const newId = 'area_' + Date.now();
    areasData.push({id: newId, name: name});
    
    fillAreasDropdowns();
    displayAreasList();
    nameInput.value = '';
    saveDataToJSON();
}

function addNewShopQuick() {
    const nameInput = document.getElementById('newShopName');
    const areaSelect = document.getElementById('newShopArea');
    const name = nameInput.value.trim();
    const areaId = areaSelect.value;
    
    if (!name || !areaId) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ ŸàÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©');
        return;
    }
    
    if (shopsData.find(shop => shop.name === name)) {
        alert('Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≠ŸÑ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ');
        return;
    }
    
    const newId = 'shop_' + Date.now();
    shopsData.push({
        id: newId, 
        name: name, 
        nameEn: name + ' (English)', 
        areaId: areaId,
        licenseNumber: 'LIC-' + Date.now().toString().slice(-6),
        googleMapsUrl: 'https://maps.google.com/?q=24.4574,54.3775'
    });
    
    fillShopsDropdowns();
    displayShopsList();
    nameInput.value = '';
    areaSelect.value = '';
    saveDataToJSON();
}

function displayInspectorsList() {
    const container = document.getElementById('inspectorsList');
    let html = '';
    inspectorsData.forEach((inspector, index) => {
        html += `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee;">
                <span>${inspector.name}</span>
                <div style="display:flex;gap:4px;">
                    <button onclick="editInspector(${index})" style="background:#6c757d;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">ÿ™ÿπÿØŸäŸÑ</button>
                    <button onclick="deleteInspector(${index})" style="background:#dc3545;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">ÿ≠ÿ∞ŸÅ</button>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function displayAreasList() {
    const container = document.getElementById('areasList');
    let html = '';
    areasData.forEach((area, index) => {
        html += `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee;">
                <span>${area.name}</span>
                <div style="display:flex;gap:4px;">
                    <button onclick="editArea(${index})" style="background:#6c757d;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">ÿ™ÿπÿØŸäŸÑ</button>
                    <button onclick="deleteArea(${index})" style="background:#dc3545;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">ÿ≠ÿ∞ŸÅ</button>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function displayShopsList() {
    const container = document.getElementById('shopsList');
    let html = '';
    shopsData.forEach((shop, index) => {
        const area = areasData.find(a => a.id === shop.areaId);
        const areaName = area ? area.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        html += `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee;">
                <span>${shop.name} - ${areaName}</span>
                <div style="display:flex;gap:4px;">
                    <button onclick="checkDeveloperAccess('shop-management', () => editShopSimple(${index}))" style="background:#6c757d;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">ÿ™ÿπÿØŸäŸÑ</button>
                    <button onclick="checkDeveloperAccess('shop-management', () => deleteShopSimple(${index}))" style="background:#dc3545;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">ÿ≠ÿ∞ŸÅ</button>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function deleteInspector(index) {
    if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖŸÅÿ™ÿ¥ÿü')) {
        inspectorsData.splice(index, 1);
        inspectors = inspectorsData.map(i => i.name);
        fillInspectorsDropdowns();
        displayInspectorsList();
        saveDataToJSON();
    }
}

function editInspector(index) {
    const inspector = inspectorsData[index];
    const oldName = inspector.name;
    const newName = prompt('ÿ™ÿπÿØŸäŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÅÿ™ÿ¥:', inspector.name);
    
    if (newName === null) return; // User cancelled
    
    const newNameTrimmed = newName.trim();
    if (!newNameTrimmed) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿµÿ≠Ÿäÿ≠ ŸÑŸÑŸÖŸÅÿ™ÿ¥');
        return;
    }
    
    // Check if name already exists (but not for the same inspector)
    const existingInspector = inspectorsData.find((i, idx) => i.name === newNameTrimmed && idx !== index);
    if (existingInspector) {
        alert('Ÿáÿ∞ÿß ÿßŸÑŸÖŸÅÿ™ÿ¥ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ');
        return;
    }
    
    // Update inspector data
    inspector.name = newNameTrimmed;
    inspectors = inspectorsData.map(i => i.name); // Update the inspectors array too
    
    fillInspectorsDropdowns();
    displayInspectorsList();
    saveDataToJSON();
    
    // Show success message
    showUpdateMessage(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÅÿ™ÿ¥ ŸÖŸÜ "${oldName}" ÿ•ŸÑŸâ "${newNameTrimmed}" Ÿàÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠`);
}

function deleteArea(index) {
    if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©ÿü')) {
        areasData.splice(index, 1);
        fillAreasDropdowns();
        displayAreasList();
        saveDataToJSON();
    }
}

function editArea(index) {
    const area = areasData[index];
    const oldName = area.name;
    const newName = prompt('ÿ™ÿπÿØŸäŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:', area.name);
    
    if (newName === null) return; // User cancelled
    
    const newNameTrimmed = newName.trim();
    if (!newNameTrimmed) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿµÿ≠Ÿäÿ≠ ŸÑŸÑŸÖŸÜÿ∑ŸÇÿ©');
        return;
    }
    
    // Check if name already exists (but not for the same area)
    const existingArea = areasData.find((a, i) => a.name === newNameTrimmed && i !== index);
    if (existingArea) {
        alert('Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÖŸàÿ¨ŸàÿØÿ© ÿ®ÿßŸÑŸÅÿπŸÑ');
        return;
    }
    
    // Update area data
    area.name = newNameTrimmed;
    
    fillAreasDropdowns();
    displayAreasList();
    saveDataToJSON();
    
    // Show success message
    showUpdateMessage(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÖŸÜ "${oldName}" ÿ•ŸÑŸâ "${newNameTrimmed}" Ÿàÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠`);
}

function deleteShopSimple(index) {
    if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≠ŸÑÿü')) {
        shopsData.splice(index, 1);
        fillShopsDropdowns();
        displayShopsList();
        saveDataToJSON();
    }
}

function editShopSimple(index) {
    const shop = shopsData[index];
    const area = areasData.find(a => a.id === shop.areaId);
    const oldName = shop.name;
    const oldAreaName = area ? area.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
    
    const newName = prompt('ÿ™ÿπÿØŸäŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ:', shop.name);
    if (newName === null) return; // User cancelled
    
    const newNameTrimmed = newName.trim();
    if (!newNameTrimmed) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿµÿ≠Ÿäÿ≠ ŸÑŸÑŸÖÿ≠ŸÑ');
        return;
    }
    
    // Check if name already exists (but not for the same shop)
    const existingShop = shopsData.find((s, i) => s.name === newNameTrimmed && i !== index);
    if (existingShop) {
        alert('Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≠ŸÑ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ');
        return;
    }
    
    // Get new area
    const areaNames = areasData.map(a => a.name);
    const currentAreaName = area ? area.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
    let selectedAreaName = currentAreaName;
    
    // Simple area selection using confirm dialogs (basic approach)
    let areaChoice = confirm(`ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©: ${currentAreaName}\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©ÿü`);
    if (areaChoice) {
        let areaOptions = areaNames.join('\n');
        let newAreaName = prompt(`ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©:\n${areaOptions}`, currentAreaName);
        if (newAreaName !== null) {
            const newArea = areasData.find(a => a.name === newAreaName.trim());
            if (newArea) {
                selectedAreaName = newArea.name;
            } else {
                alert('ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                return;
            }
        }
    }
    
    // Update shop data
    shop.name = newNameTrimmed;
    const selectedArea = areasData.find(a => a.name === selectedAreaName);
    if (selectedArea) {
        shop.areaId = selectedArea.id;
    }
    
    fillShopsDropdowns();
    displayShopsList();
    saveDataToJSON();
    
    // Show success message
    const newAreaName = selectedArea ? selectedArea.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
    if (oldName !== newNameTrimmed || oldAreaName !== newAreaName) {
        showUpdateMessage(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≠ŸÑ "${oldName}" (${oldAreaName}) ÿ•ŸÑŸâ "${newNameTrimmed}" (${newAreaName}) Ÿàÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠`);
    }
}

function saveDataToJSON(silent = true) {
    // Save all data to localStorage as backup
    const allData = {
        inspectionData: inspectionData,
        inspectors: inspectorsData,
        areas: areasData,
        shops: shopsData,
        bellNotes: bellNotesData,
        lastUpdate: new Date().toISOString()
    };
    localStorage.setItem('allPlanData', JSON.stringify(allData));
    
    // Always try to save to external file for bell notifications synchronization
    // This ensures that bell notifications are shared across all users via Git
    // Pass silent parameter to avoid showing warning messages during routine operations
    saveToExternalFileAutomatic(allData, silent);
    
    console.log('Data saved to localStorage and attempting external file save for synchronization');
}

// Call loadInspectionData when the DOM is ready  
// Note: This is already handled in the main DOMContentLoaded event listener above
</script>

<!-- Backup initialization script to ensure functionality works -->
<script>
(function() {
    // Backup inspector data in case main script fails
    if (typeof inspectorsData === 'undefined') {
        window.inspectorsData = [
            {id:"insp_1758813880098", name:"ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ"},
            {id:"insp_1758830925093", name:"ÿØ. ŸÖÿ≠ŸÖÿØ ÿ•ÿ≥ŸÖÿßÿπŸäŸÑ"},
            {id:"insp_1758830939296", name:"ÿØ. ŸÖÿ≠ŸÖÿØ ÿ≥ÿπŸäÿØ"},
            {id:"insp_1758830950586", name:"ÿØ. ŸÅÿßŸäÿ≤ ÿßŸÑŸÖÿ≥ÿßŸÑŸÖÿ©"},
            {id:"insp_1758830963007", name:"ÿØ. ÿ¢ŸäŸá ÿ≥ŸÑÿßŸÖÿ©"},
            {id:"insp_1758830974747", name:"ÿØ. ÿ¢ŸÖŸÜŸá ÿ®ŸÜ ÿµÿ±ŸÖ"},
            {id:"insp_1758830985608", name:"ÿØ. ÿ≠ÿµÿ© ÿßŸÑÿπŸÑŸä"},
            {id:"insp_1758830999876", name:"ÿØ. ÿ≠ÿ≥ŸäŸÜÿ© ÿßŸÑÿπÿßŸÖÿ±Ÿä"},
            {id:"insp_1758831014928", name:"ÿØ. Ÿáÿßÿ¨ÿ± ÿßŸÑÿ∫ÿßŸÅÿ±Ÿä"}
        ];
        window.inspectors = window.inspectorsData.map(i => i.name);
    }
    
    // Backup function to fill inspector dropdown
    function ensureInspectorDropdownFilled() {
        const inspectorSelect = document.getElementById('inspectorSelect');
        if (inspectorSelect && inspectorSelect.options.length <= 1) {
            inspectorSelect.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥ --</option>';
            window.inspectorsData.forEach(inspector => {
                inspectorSelect.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
            });
        }
    }
    
    // Backup function to ensure developer login functionality
    function ensureDeveloperLoginWorks() {
        const loginRole = document.getElementById('loginRole');
        const devPassword = document.getElementById('devPassword');
        const devLoginBtn = document.getElementById('devLoginBtn');
        
        if (loginRole && !loginRole.onchangeBackup) {
            loginRole.onchangeBackup = true;
            loginRole.addEventListener('change', function() {
                const role = this.value;
                document.getElementById('devError').innerText = '';
                
                if(role === 'developer') {
                    document.getElementById('devPassword').style.display = 'inline-block';
                    document.getElementById('devLoginBtn').style.display = 'inline-block';
                    document.getElementById('devLogoutBtn').style.display = 'none';
                    document.getElementById('devSection').style.display = 'none';
                    // Keep system services visible (showing only reports for non-logged-in users)
                    // document.getElementById('systemServicesContainer').style.display = 'none';
                    window.isDev = false;
                    // Clear saved login state when switching to developer login screen
                    localStorage.removeItem('isDevLoggedIn');
                } else if (role === 'inspector') {
                    document.getElementById('devPassword').style.display = 'none';
                    document.getElementById('devLoginBtn').style.display = 'none';
                    document.getElementById('devLogoutBtn').style.display = 'none';
                    document.getElementById('devSection').style.display = 'none';
                    // Show system services for inspectors (with only reports visible)
                    document.getElementById('systemServicesContainer').style.display = 'block';
                    console.log('üìä PR#317: [Backup Handler] Showing System Services for Inspector');
                    
                    // Hide developer-only categories
                    const developerCategories = document.querySelectorAll('.developer-only-category');
                    console.log(`üìä PR#317: [Backup Handler] Found ${developerCategories.length} developer-only categories to hide`);
                    developerCategories.forEach(cat => {
                        cat.style.display = 'none';
                        console.log('üìä PR#317: [Backup Handler] Hidden category:', cat.id);
                    });
                    
                    window.isDev = false;
                    // Clear saved login state when switching to inspector role
                    localStorage.removeItem('isDevLoggedIn');
                } else {
                    document.getElementById('devPassword').style.display = 'none';
                    document.getElementById('devLoginBtn').style.display = 'none';
                    document.getElementById('devLogoutBtn').style.display = 'none';
                    document.getElementById('devSection').style.display = 'none';
                    // Keep system services visible (showing only reports for inspectors)
                    document.getElementById('systemServicesContainer').style.display = 'block';
                    window.isDev = false;
                    // Clear saved login state when switching to empty selection
                    localStorage.removeItem('isDevLoggedIn');
                }
            });
        }
        
        if (devLoginBtn && !devLoginBtn.onclickBackup) {
            devLoginBtn.onclickBackup = true;
            devLoginBtn.onclick = async function() {
                const pw = document.getElementById('devPassword').value.trim();
                const DEV_PASSWORD = 'ali@1940';
                
                if (pw === DEV_PASSWORD) {
                    window.isDev = true;
                    isDev = true;
                    // Save developer login state to persist across page reloads
                    localStorage.setItem('isDevLoggedIn', 'true');
                    
                    // ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
                    if (!localStorage.getItem("devToken")) {
                        const defaultToken = "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";
                        localStorage.setItem("devToken", defaultToken);
                    }
                    
                    // Try to update last update date if function is available
                    if (typeof setLastUpdateDate === 'function') {
                        try {
                            setLastUpdateDate();
                        } catch (e) {
                            console.log('setLastUpdateDate error:', e);
                        }
                    }
                    document.getElementById('devSection').style.display = 'block';
                    document.getElementById('devLogoutBtn').style.display = 'inline-block';
                    document.getElementById('devPassword').style.display = 'none';
                    document.getElementById('devLoginBtn').style.display = 'none';
                    document.getElementById('devError').innerText = '';
                    // Show system services for developer
                    document.getElementById('systemServicesContainer').style.display = 'block';
                    console.log('üìä PR#317: [Backup Handler] Developer logged in - showing all System Services');
                    
                    // Show all categories including developer-only categories
                    const developerCategories = document.querySelectorAll('.developer-only-category');
                    console.log(`üìä PR#317: [Backup Handler] Found ${developerCategories.length} developer-only categories to show`);
                    developerCategories.forEach(cat => {
                        cat.style.display = 'contents';
                        console.log('üìä PR#317: [Backup Handler] Shown category:', cat.id);
                    });
                    
                    // Update maintenance close button visibility for developer
                    updateMaintenanceCloseButton();
                    
                    // Hide maintenance overlay for developer if it's showing
                    const overlay = document.getElementById('maintenanceOverlay');
                    if (overlay && overlay.style.display === 'flex') {
                        hideMaintenanceMode();
                        console.log('‚úÖ Developer logged in (backup) - maintenance overlay hidden automatically');
                    }
                    
                    console.log('‚úÖ Developer logged in (backup handler) - maintenance close button now visible');
                } else {
                    document.getElementById('devError').innerText = 'ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©!';
                }
            };
        }
        
        const devLogoutBtn = document.getElementById('devLogoutBtn');
        if (devLogoutBtn && !devLogoutBtn.onclickBackup) {
            devLogoutBtn.onclickBackup = true;
            devLogoutBtn.onclick = async function() {
                window.isDev = false;
                isDev = false;  // ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÖÿ™ÿ∫Ÿäÿ± isDev ÿ£Ÿäÿ∂ÿßŸã
                // Remove developer login state from localStorage
                localStorage.removeItem('isDevLoggedIn');
                document.getElementById('devSection').style.display = 'none';
                document.getElementById('devLogoutBtn').style.display = 'none';
                document.getElementById('devPassword').style.display = 'none';
                document.getElementById('devLoginBtn').style.display = 'none';
                document.getElementById('loginRole').value = '';
                document.getElementById('devError').innerText = '';
                // Keep system services visible when developer logs out (inspectors can still see reports)
                document.getElementById('systemServicesContainer').style.display = 'block';
                // Hide developer-only categories
                const developerCategories = document.querySelectorAll('.developer-only-category');
                developerCategories.forEach(cat => {
                    cat.style.display = 'none';
                });
                
                // Update maintenance close button visibility
                updateMaintenanceCloseButton();
                
                // Show maintenance overlay if maintenance mode is active (check GitHub status)
                const maintenanceStatus = localStorage.getItem('systemMaintenanceMode') === 'true';
                if (maintenanceStatus) {
                    await checkMaintenanceMode();
                    console.log('üö™ Developer logged out (backup) - maintenance overlay shown for non-developer');
                }
                
                console.log('üö™ Developer logged out (backup handler) - maintenance close button hidden');
            };
        }
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                ensureInspectorDropdownFilled();
                ensureDeveloperLoginWorks();
            }, 100);
        });
    } else {
        setTimeout(function() {
            ensureInspectorDropdownFilled();
            ensureDeveloperLoginWorks();
        }, 100);
    }
})();

// ===== Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ™ÿØŸàŸäÿ± ÿßŸÑÿ∞ŸÉŸä ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™ ÿπŸÑŸâ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ =====


// ===== Ÿàÿ∏ÿßÿ¶ŸÅ ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸàÿßŸÑÿπÿ∑ŸÑ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ© =====

// ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
let vacationData = [];
let currentVacationAnalysis = null;

// ŸÅÿ™ÿ≠ ŸÖŸàÿØÿßŸÑ ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
function showVacationTrackerModal() {
    // ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    document.getElementById('vacationStartDate').value = firstDay.toISOString().split('T')[0];
    document.getElementById('vacationEndDate').value = lastDay.toISOString().split('T')[0];
    
    // ÿπÿ±ÿ∂ ÿßŸÑŸÖŸàÿØÿßŸÑ ŸÖÿπ ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖÿ™ÿØÿßÿÆŸÑÿ©
    const modalElement = document.getElementById('vacationTrackerModal');
    modalElement.style.display = 'flex';
    modalElement.classList.add('nested-modal');
    
    // ÿ•ÿ∏Ÿáÿßÿ± ÿ£Ÿà ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑŸÖÿÆÿµÿµÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±
    document.getElementById('vacationAnalysisPeriod').addEventListener('change', function() {
        const customRange = document.getElementById('customDateRange');
        if (this.value === 'custom_range') {
            customRange.style.display = 'block';
        } else {
            customRange.style.display = 'none';
        }
    });
}

// ÿ•ÿ∫ŸÑÿßŸÇ ŸÖŸàÿØÿßŸÑ ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
function closeVacationTrackerModal() {
    const modalElement = document.getElementById('vacationTrackerModal');
    modalElement.style.display = 'none';
    modalElement.classList.remove('nested-modal');
    document.getElementById('vacationManagementTable').style.display = 'none';
}

// ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
function analyzeVacations() {
    const period = document.getElementById('vacationAnalysisPeriod').value;
    const analysisType = document.getElementById('vacationAnalysisType').value;
    const resultsDiv = document.getElementById('vacationAnalysisResults');
    
    // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
    let startDate, endDate;
    const today = new Date();
    
    switch(period) {
        case 'current_month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            break;
        case 'last_month':
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
        case 'custom_range':
            startDate = new Date(document.getElementById('vacationStartDate').value);
            endDate = new Date(document.getElementById('vacationEndDate').value);
            break;
        case 'full_year':
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date(today.getFullYear(), 11, 31);
            break;
    }
    
    // ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ© ŸÑÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ£ŸäÿßŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
    const vacationAnalysis = analyzeInspectionDataForVacations(startDate, endDate, analysisType);
    
    // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
    displayVacationAnalysis(vacationAnalysis, startDate, endDate);
    
    // ÿ•ÿ∏Ÿáÿßÿ± ÿ¨ÿØŸàŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
    document.getElementById('vacationManagementTable').style.display = 'block';
    populateVacationTable(vacationAnalysis);
}

// ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ŸÑÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ£ŸäÿßŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
function analyzeInspectionDataForVacations(startDate, endDate, analysisType) {
    const inspectorVacations = {};
    const allDates = [];
    
    // ÿ•ŸÜÿ¥ÿßÿ° ŸÇÿßÿ¶ŸÖÿ© ÿ®ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ ŸÅŸä ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        allDates.push(new Date(d).toISOString().split('T')[0]);
    }
    
    // ÿ™ŸáŸäÿ¶ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ
    inspectorsData.forEach(inspector => {
        inspectorVacations[inspector.name] = {
            workDays: new Set(),
            vacationDays: [],
            weeklyOffs: [],
            totalVacationDays: 0
        };
    });
    
    // ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
    inspectionData.forEach(entry => {
        const entryDate = entry.day;
        if (entryDate >= startDate.toISOString().split('T')[0] && 
            entryDate <= endDate.toISOString().split('T')[0]) {
            inspectorVacations[entry.inspector].workDays.add(entryDate);
        }
    });
    
    // ÿ™ÿ≠ÿØŸäÿØ ÿ£ŸäÿßŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© (ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑÿ™Ÿä ŸÑŸÖ ŸäÿπŸÖŸÑ ŸÅŸäŸáÿß ÿßŸÑŸÖŸÅÿ™ÿ¥)
    Object.keys(inspectorVacations).forEach(inspectorName => {
        const inspector = inspectorVacations[inspectorName];
        
        allDates.forEach(date => {
            if (!inspector.workDays.has(date)) {
                const dayOfWeek = new Date(date).getDay();
                const dayName = getDayNameInArabic(dayOfWeek);
                
                const vacationEntry = {
                    date: date,
                    dayName: dayName,
                    dayOfWeek: dayOfWeek,
                    type: 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
                    duration: 'ŸäŸàŸÖ ŸÉÿßŸÖŸÑ',
                    notes: ''
                };
                
                // ÿ™ÿµŸÜŸäŸÅ ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸäŸàŸÖ
                if (analysisType === 'weekly_offs') {
                    // ÿßŸÑÿ¨ŸÖÿπÿ© (5) ŸàÿßŸÑÿ≥ÿ®ÿ™ (6) ŸàÿßŸÑÿ£ÿ≠ÿØ (0) ÿ™ÿπÿ™ÿ®ÿ± ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ£ÿ≥ÿ®ŸàÿπŸäÿ©
                    if ([0, 5, 6].includes(dayOfWeek)) {
                        vacationEntry.type = 'ÿ•ÿ¨ÿßÿ≤ÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ©';
                        inspector.weeklyOffs.push(vacationEntry);
                    }
                } else {
                    vacationEntry.type = getVacationTypeByAnalysis(analysisType);
                    inspector.vacationDays.push(vacationEntry);
                }
            }
        });
        
        inspector.totalVacationDays = inspector.vacationDays.length + inspector.weeklyOffs.length;
    });
    
    return inspectorVacations;
}

// ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßÿ≥ŸÖ ÿßŸÑŸäŸàŸÖ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
function getDayNameInArabic(dayOfWeek) {
    const days = ['ÿßŸÑÿ£ÿ≠ÿØ', 'ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ', 'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°', 'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°', 'ÿßŸÑÿÆŸÖŸäÿ≥', 'ÿßŸÑÿ¨ŸÖÿπÿ©', 'ÿßŸÑÿ≥ÿ®ÿ™'];
    return days[dayOfWeek];
}

// ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ
function getVacationTypeByAnalysis(analysisType) {
    switch(analysisType) {
        case 'annual_leave': return 'ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≥ŸÜŸàŸäÿ©';
        case 'sick_leave': return 'ÿ•ÿ¨ÿßÿ≤ÿ© ŸÖÿ±ÿ∂Ÿäÿ©';
        case 'weekly_offs': return 'ÿ•ÿ¨ÿßÿ≤ÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ©';
        default: return 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
    }
}

// ÿπÿ±ÿ∂ ŸÜÿ™ÿßÿ¶ÿ¨ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
function displayVacationAnalysis(analysisData, startDate, endDate) {
    const resultsDiv = document.getElementById('vacationAnalysisResults');
    
    let totalVacationDays = 0;
    let totalInspectors = Object.keys(analysisData).length;
    
    let html = `
    <div style="margin-bottom: 20px;">
        <h4 style="color: #234085; text-align: center; margin-bottom: 15px;">üìä ŸÜÿ™ÿßÿ¶ÿ¨ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™</h4>
        <div style="text-align: center; color: #666; margin-bottom: 20px;">
            ÿßŸÑŸÅÿ™ÿ±ÿ©: ${startDate.toLocaleDateString('ar-SA')} - ${endDate.toLocaleDateString('ar-SA')}
        </div>
        
        <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿπÿßŸÖÿ© -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
    `;
    
    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
    Object.values(analysisData).forEach(inspector => {
        totalVacationDays += inspector.totalVacationDays;
    });
    
    const avgVacationDays = totalInspectors > 0 ? (totalVacationDays / totalInspectors).toFixed(1) : 0;
    
    html += `
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                <h5 style="margin: 0; color: #0277bd;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ£ŸäÿßŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©</h5>
                <span style="font-size: 1.8em; font-weight: bold; color: #0277bd;">${totalVacationDays}</span>
            </div>
            <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; text-align: center;">
                <h5 style="margin: 0; color: #7b1fa2;">ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÑŸÑŸÖŸÅÿ™ÿ¥</h5>
                <span style="font-size: 1.8em; font-weight: bold; color: #7b1fa2;">${avgVacationDays}</span>
            </div>
            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                <h5 style="margin: 0; color: #2e7d32;">ÿπÿØÿØ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</h5>
                <span style="font-size: 1.8em; font-weight: bold; color: #2e7d32;">${totalInspectors}</span>
            </div>
        </div>
        
        <!-- ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
    `;
    
    Object.entries(analysisData).forEach(([inspectorName, data]) => {
        html += `
            <div style="background: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                <h6 style="margin: 0 0 10px 0; color: #234085; font-size: 1.1em;">${inspectorName}</h6>
                <div style="font-size: 0.9em; color: #666;">
                    <div>ÿ£ŸäÿßŸÖ ÿßŸÑÿπŸÖŸÑ: <strong>${data.workDays.size}</strong></div>
                    <div>ÿ£ŸäÿßŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©: <strong>${data.totalVacationDays}</strong></div>
                    <div>ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©: <strong>${data.weeklyOffs.length}</strong></div>
                    <div>ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ£ÿÆÿ±Ÿâ: <strong>${data.vacationDays.length}</strong></div>
                </div>
            </div>
        `;
    });
    
    html += `
        </div>
    </div>
    `;
    
    resultsDiv.innerHTML = html;
}

// ŸÖŸÑÿ° ÿ¨ÿØŸàŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
function populateVacationTable(analysisData) {
    const tableBody = document.getElementById('vacationTableBody');
    let html = '';
    
    Object.entries(analysisData).forEach(([inspectorName, data]) => {
        // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©
        data.weeklyOffs.forEach((vacation, index) => {
            html += `
                <tr>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${inspectorName}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${vacation.date}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${vacation.dayName}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        <select onchange="updateVacationType('${inspectorName}', '${vacation.date}', this.value)" 
                                style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="ÿ•ÿ¨ÿßÿ≤ÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ©" ${vacation.type === 'ÿ•ÿ¨ÿßÿ≤ÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ©' ? 'selected' : ''}>ÿ•ÿ¨ÿßÿ≤ÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ©</option>
                            <option value="ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≥ŸÜŸàŸäÿ©" ${vacation.type === 'ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≥ŸÜŸàŸäÿ©' ? 'selected' : ''}>ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≥ŸÜŸàŸäÿ©</option>
                            <option value="ÿ•ÿ¨ÿßÿ≤ÿ© ŸÖÿ±ÿ∂Ÿäÿ©" ${vacation.type === 'ÿ•ÿ¨ÿßÿ≤ÿ© ŸÖÿ±ÿ∂Ÿäÿ©' ? 'selected' : ''}>ÿ•ÿ¨ÿßÿ≤ÿ© ŸÖÿ±ÿ∂Ÿäÿ©</option>
                            <option value="ÿ•ÿ¨ÿßÿ≤ÿ© ÿ∑ÿßÿ±ÿ¶ÿ©" ${vacation.type === 'ÿ•ÿ¨ÿßÿ≤ÿ© ÿ∑ÿßÿ±ÿ¶ÿ©' ? 'selected' : ''}>ÿ•ÿ¨ÿßÿ≤ÿ© ÿ∑ÿßÿ±ÿ¶ÿ©</option>
                            <option value="ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ" ${vacation.type === 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ' ? 'selected' : ''}>ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ</option>
                        </select>
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        <select onchange="updateVacationDuration('${inspectorName}', '${vacation.date}', this.value)"
                                style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="ŸäŸàŸÖ ŸÉÿßŸÖŸÑ" ${vacation.duration === 'ŸäŸàŸÖ ŸÉÿßŸÖŸÑ' ? 'selected' : ''}>ŸäŸàŸÖ ŸÉÿßŸÖŸÑ</option>
                            <option value="ŸÜÿµŸÅ ŸäŸàŸÖ" ${vacation.duration === 'ŸÜÿµŸÅ ŸäŸàŸÖ' ? 'selected' : ''}>ŸÜÿµŸÅ ŸäŸàŸÖ</option>
                            <option value="ÿ≥ÿßÿπÿßÿ™ ŸÖÿπŸäŸÜÿ©" ${vacation.duration === 'ÿ≥ÿßÿπÿßÿ™ ŸÖÿπŸäŸÜÿ©' ? 'selected' : ''}>ÿ≥ÿßÿπÿßÿ™ ŸÖÿπŸäŸÜÿ©</option>
                        </select>
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        <input type="text" value="${vacation.notes}" 
                               onchange="updateVacationNotes('${inspectorName}', '${vacation.date}', this.value)"
                               style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;"
                               placeholder="ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™...">
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                        <button onclick="deleteVacationRecord('${inspectorName}', '${vacation.date}')" 
                                style="background: #dc3545; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `;
        });
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâ
        data.vacationDays.forEach((vacation, index) => {
            html += `
                <tr>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${inspectorName}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${vacation.date}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">${vacation.dayName}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        <select onchange="updateVacationType('${inspectorName}', '${vacation.date}', this.value)" 
                                style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="ÿ•ÿ¨ÿßÿ≤ÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ©" ${vacation.type === 'ÿ•ÿ¨ÿßÿ≤ÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ©' ? 'selected' : ''}>ÿ•ÿ¨ÿßÿ≤ÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ©</option>
                            <option value="ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≥ŸÜŸàŸäÿ©" ${vacation.type === 'ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≥ŸÜŸàŸäÿ©' ? 'selected' : ''}>ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≥ŸÜŸàŸäÿ©</option>
                            <option value="ÿ•ÿ¨ÿßÿ≤ÿ© ŸÖÿ±ÿ∂Ÿäÿ©" ${vacation.type === 'ÿ•ÿ¨ÿßÿ≤ÿ© ŸÖÿ±ÿ∂Ÿäÿ©' ? 'selected' : ''}>ÿ•ÿ¨ÿßÿ≤ÿ© ŸÖÿ±ÿ∂Ÿäÿ©</option>
                            <option value="ÿ•ÿ¨ÿßÿ≤ÿ© ÿ∑ÿßÿ±ÿ¶ÿ©" ${vacation.type === 'ÿ•ÿ¨ÿßÿ≤ÿ© ÿ∑ÿßÿ±ÿ¶ÿ©' ? 'selected' : ''}>ÿ•ÿ¨ÿßÿ≤ÿ© ÿ∑ÿßÿ±ÿ¶ÿ©</option>
                            <option value="ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ" ${vacation.type === 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ' ? 'selected' : ''}>ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ</option>
                        </select>
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        <select onchange="updateVacationDuration('${inspectorName}', '${vacation.date}', this.value)"
                                style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="ŸäŸàŸÖ ŸÉÿßŸÖŸÑ" ${vacation.duration === 'ŸäŸàŸÖ ŸÉÿßŸÖŸÑ' ? 'selected' : ''}>ŸäŸàŸÖ ŸÉÿßŸÖŸÑ</option>
                            <option value="ŸÜÿµŸÅ ŸäŸàŸÖ" ${vacation.duration === 'ŸÜÿµŸÅ ŸäŸàŸÖ' ? 'selected' : ''}>ŸÜÿµŸÅ ŸäŸàŸÖ</option>
                            <option value="ÿ≥ÿßÿπÿßÿ™ ŸÖÿπŸäŸÜÿ©" ${vacation.duration === 'ÿ≥ÿßÿπÿßÿ™ ŸÖÿπŸäŸÜÿ©' ? 'selected' : ''}>ÿ≥ÿßÿπÿßÿ™ ŸÖÿπŸäŸÜÿ©</option>
                        </select>
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        <input type="text" value="${vacation.notes}" 
                               onchange="updateVacationNotes('${inspectorName}', '${vacation.date}', this.value)"
                               style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px;"
                               placeholder="ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™...">
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                        <button onclick="deleteVacationRecord('${inspectorName}', '${vacation.date}')" 
                                style="background: #dc3545; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `;
        });
    });
    
    tableBody.innerHTML = html;
    currentVacationAnalysis = analysisData;
}

// ÿ™ÿ≠ÿØŸäÿ´ ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
function updateVacationType(inspector, date, newType) {
    // Ÿáÿ∞Ÿá ÿßŸÑÿØÿßŸÑÿ© ÿ≥ÿ™ÿ≠ÿØÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
    // ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇ ÿßŸÑÿ≠ŸÅÿ∏ ŸÅŸä localStorage ÿ£Ÿà ÿ•ÿ±ÿ≥ÿßŸÑ ŸÑŸÑÿÆÿßÿØŸÖ
    console.log(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÜŸàÿπ ÿ•ÿ¨ÿßÿ≤ÿ© ${inspector} ŸÅŸä ${date} ÿ•ŸÑŸâ ${newType}`);
}

// ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿØÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
function updateVacationDuration(inspector, date, newDuration) {
    console.log(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿØÿ© ÿ•ÿ¨ÿßÿ≤ÿ© ${inspector} ŸÅŸä ${date} ÿ•ŸÑŸâ ${newDuration}`);
}

// ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
function updateVacationNotes(inspector, date, newNotes) {
    console.log(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ¨ÿßÿ≤ÿ© ${inspector} ŸÅŸä ${date} ÿ•ŸÑŸâ ${newNotes}`);
}

// ÿ≠ÿ∞ŸÅ ÿ≥ÿ¨ŸÑ ÿ•ÿ¨ÿßÿ≤ÿ©
function deleteVacationRecord(inspector, date) {
    if (confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿ≥ÿ¨ŸÑ ÿ•ÿ¨ÿßÿ≤ÿ© ${inspector} ŸÅŸä ${date}ÿü`)) {
        // ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≥ÿ¨ŸÑ Ÿàÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ¨ÿØŸàŸÑ
        console.log(`ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ≥ÿ¨ŸÑ ÿ•ÿ¨ÿßÿ≤ÿ© ${inspector} ŸÅŸä ${date}`);
        // ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇ ÿßŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿπŸÑŸä ŸáŸÜÿß
    }
}

// ÿ•ÿ∂ÿßŸÅÿ© ÿ≥ÿ¨ŸÑ ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¨ÿØŸäÿØ
function addVacationRecord() {
    // ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜÿ®ÿ´ŸÇÿ© ŸÑÿ•ÿØÿÆÿßŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©
    const inspector = prompt('ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÅÿ™ÿ¥:');
    const date = prompt('ÿßŸÑÿ™ÿßÿ±ŸäÿÆ (YYYY-MM-DD):');
    const type = prompt('ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©:');
    
    if (inspector && date && type) {
        console.log(`ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¨ÿØŸäÿØÿ©: ${inspector} - ${date} - ${type}`);
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ¨ÿØŸàŸÑ
        analyzeVacations();
    }
}

// ÿ™ÿµÿØŸäÿ± ÿ¨ÿØŸàŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
function exportVacationTable() {
    if (!currentVacationAnalysis) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ£ŸàŸÑÿßŸã');
        return;
    }
    
    let ws_data = [];
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿπŸÜŸàÿßŸÜ
    ws_data.push(['ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸàÿßŸÑÿπÿ∑ŸÑ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©']);
    ws_data.push(['ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±:', new Date().toLocaleDateString('ar-SA')]);
    ws_data.push([]);
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿ£ÿ≥ ÿßŸÑÿ¨ÿØŸàŸÑ
    ws_data.push(['ÿßŸÑŸÖŸÅÿ™ÿ¥', 'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ', 'ÿßŸÑŸäŸàŸÖ', 'ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©', 'ÿßŸÑŸÖÿØÿ©', 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™']);
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    Object.entries(currentVacationAnalysis).forEach(([inspectorName, data]) => {
        [...data.weeklyOffs, ...data.vacationDays].forEach(vacation => {
            ws_data.push([
                inspectorName,
                vacation.date,
                vacation.dayName,
                vacation.type,
                vacation.duration,
                vacation.notes
            ]);
        });
    });
    
    // ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ Excel
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    
    XLSX.utils.book_append_sheet(wb, ws, "ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™");
    XLSX.writeFile(wb, `ÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// ŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
function clearVacationData() {
    if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ÿü Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá.')) {
        currentVacationAnalysis = null;
        document.getElementById('vacationTableBody').innerHTML = '';
        document.getElementById('vacationAnalysisResults').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 3em;">üèñÔ∏è</div>
                <p>ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™. ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ŸàÿßŸÜŸÇÿ± ÿπŸÑŸâ "ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™" ŸÑÿπÿ±ÿ∂ ŸÜÿ™ÿßÿ¶ÿ¨ ÿ¨ÿØŸäÿØÿ©</p>
            </div>
        `;
        document.getElementById('vacationManagementTable').style.display = 'none';
    }
}

// ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿ¨ÿØŸàŸÑ ŸÖŸÜÿßŸàÿ®ÿßÿ™
function importVacationSchedule() {
    document.getElementById('vacationFileInput').click();
}

// ŸÖÿπÿßŸÑÿ¨ÿ© ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
async function handleVacationFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const fileName = file.name;
    const fileExtension = fileName.split('.').pop().toLowerCase();
    
    // ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿ•ŸÑŸâ GitHub (ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑)
    if (isDev || window.isDev) {
        const uploadResult = await uploadFileToGitHub(file, 'schedules', `ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ - ${fileName}`);
        if (uploadResult.success) {
            alert(`‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nÿßŸÑŸÖŸÑŸÅ: ${fileName}\nÿßŸÑÿ¢ŸÜ ŸÖÿ™ÿßÿ≠ ŸÑŸÑÿ¨ŸÖŸäÿπ ŸÅŸä ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™`);
        } else {
            alert(`‚ö†Ô∏è ÿ™ŸÖ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ ŸÖÿ≠ŸÑŸäÿßŸãÿå ŸÑŸÉŸÜ ŸÅÿ¥ŸÑ ÿ±ŸÅÿπŸá ÿ•ŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ: ${uploadResult.error}`);
        }
    }
    
    // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ£ŸÜŸàÿßÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ© ŸÖÿ≠ŸÑŸäÿßŸã
    if (fileExtension === 'json') {
        handleJSONFileForVacation(file);
    } else if (['xlsx', 'xls'].includes(fileExtension)) {
        handleExcelFileForVacation(file);
    } else if (fileExtension === 'pdf') {
        handlePDFFileForVacation(file);
    } else if (['csv'].includes(fileExtension)) {
        handleCSVFileForVacation(file);
    } else if (['txt', 'doc', 'docx'].includes(fileExtension)) {
        handleTextFileForVacation(file);
    } else {
        if (!isDev && !window.isDev) {
            alert(`‚úÖ ÿ™ŸÖ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ "${fileName}" ŸÖÿ≠ŸÑŸäÿßŸã! ŸÜŸàÿπ ÿßŸÑŸÖŸÑŸÅ: ${fileExtension.toUpperCase()}\n\nÿßŸÑŸÖŸÑŸÅ ŸÖÿ™ÿßÿ≠ ŸÑŸÑŸÖÿπÿßŸäŸÜÿ©. ŸäŸÖŸÉŸÜŸÉ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸá ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™.`);
        }
    }
    
    // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ input ÿßŸÑŸÖŸÑŸÅ
    event.target.value = '';
}

async function handleJSONFileForVacation(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const jsonData = JSON.parse(e.target.result);
            if (jsonData.inspectionData && Array.isArray(jsonData.inspectionData)) {
                alert('‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÑŸÅ JSON ÿ®ŸÜÿ¨ÿßÿ≠! ÿßŸÜŸÇÿ± ÿπŸÑŸâ "ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™" ŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.');
                // ŸäŸÖŸÉŸÜ ÿØŸÖÿ¨ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
            } else {
                alert('‚ùå ÿ™ŸÜÿ≥ŸäŸÇ ŸÖŸÑŸÅ JSON ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');
            }
        } catch (error) {
            alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ JSON: ' + error.message);
        }
    };
    reader.readAsText(file);
}

async function handleExcelFileForVacation(file) {
    const result = await processExcelFile(file);
    if (result.success) {
        alert(`‚úÖ ÿ™ŸÖ ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ Excel ÿ®ŸÜÿ¨ÿßÿ≠!\n\nÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${result.data.length} ÿ≥ÿ¨ŸÑ.\n\nŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™.`);
        console.log('ÿ®ŸäÿßŸÜÿßÿ™ Excel ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™:', result.data);
        // ŸäŸÖŸÉŸÜ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸáŸÜÿß ŸÑÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿßÿ™
    } else {
        alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ Excel: ' + result.error);
    }
}

async function handlePDFFileForVacation(file) {
    alert('üîÑ ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ŸÖŸÑŸÅ PDF... ŸÇÿØ Ÿäÿ≥ÿ™ÿ∫ÿ±ŸÇ Ÿáÿ∞ÿß ÿ®ÿπÿ∂ ÿßŸÑŸàŸÇÿ™.');
    
    const result = await processPDFFile(file);
    if (result.success) {
        alert(`‚úÖ ÿ™ŸÖ ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ PDF ÿ®ŸÜÿ¨ÿßÿ≠!\n\nÿπÿØÿØ ÿßŸÑÿµŸÅÿ≠ÿßÿ™: ${result.numPages}\nÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÜÿµ ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ.\n\nŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™.`);
        console.log('ŸÜÿµ PDF ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™:', result.text);
        // ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇ ÿ•ÿ∂ÿßŸÅŸä ŸÑŸÖÿπÿßŸÑÿ¨ÿ© ŸÜÿµ PDF
    } else {
        alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ PDF: ' + result.error);
    }
}

async function handleCSVFileForVacation(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csvText = e.target.result;
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }
            
            alert(`‚úÖ ÿ™ŸÖ ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ CSV ÿ®ŸÜÿ¨ÿßÿ≠!\n\nÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${data.length} ÿ≥ÿ¨ŸÑ.\n\nŸäŸÖŸÉŸÜŸÉ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™.`);
            console.log('ÿ®ŸäÿßŸÜÿßÿ™ CSV ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™:', data);
        } catch (error) {
            alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ CSV: ' + error.message);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

async function handleTextFileForVacation(file) {
    const result = await processTextFile(file);
    if (result.success) {
        alert(`‚úÖ ÿ™ŸÖ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÜÿµŸä ÿ®ŸÜÿ¨ÿßÿ≠!\n\nŸäŸÖŸÉŸÜŸÉ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™.`);
        console.log('ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÖŸÑŸÅ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™:', result.text);
    } else {
        alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÜÿµŸä: ' + result.error);
    }
}

// ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
function exportVacationReport() {
    if (!currentVacationAnalysis) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ£ŸàŸÑÿßŸã');
        return;
    }
    
    exportVacationTable();
}

// ===== Ÿàÿ∏ÿßÿ¶ŸÅ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ© =====

// ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
let filteredShopsData = [];
let shopsClassificationFilter = '';
let lastShopsUpdate = null;

// ŸÅÿ™ÿ≠ ŸÖŸàÿØÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
function showShopsManagementModal() {
    const modalElement = document.getElementById('shopsManagementModal');
    modalElement.style.display = 'flex';
    modalElement.classList.add('nested-modal');
    populateShopsAreaFilter(); // Populate area filter dropdown
    refreshShopsDisplay();
    updateShopsStats();
    updateShopsEditingStatus(); // Update the editing status banner
    
    // Show quick add section for developers only
    const quickAddSection = document.getElementById('quickAddShopSection');
    if (quickAddSection) {
        quickAddSection.style.display = (isDev || window.isDev) ? 'block' : 'none';
        
        // Populate area dropdown for quick add
        if (isDev || window.isDev) {
            const areaSelect = document.getElementById('quickAddShopArea');
            if (areaSelect) {
                areaSelect.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© --</option>';
                areasData.forEach(area => {
                    areaSelect.innerHTML += `<option value="${area.id}">${area.name}</option>`;
                });
            }
        }
    }
}

// ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± ŸÅŸä ŸÖŸàÿØÿßŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
function updateShopsEditingStatus() {
    const statusContent = document.getElementById('editingStatusContent');
    const statusBanner = document.getElementById('shopsEditingStatus');
    
    if (isDev || window.isDev) {
        // ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ - ÿ•ÿ∏Ÿáÿßÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± ÿßŸÑŸÖŸÅÿπŸÑÿ©
        statusBanner.style.background = 'linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%)';
        statusBanner.style.borderColor = '#4caf50';
        statusContent.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
                <div style="font-size: 1.5em;">‚úÖ</div>
                <h4 style="margin: 0; color: #2e7d32; font-size: 1.1em;">Ÿàÿ∂ÿπ ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÖŸÅÿπŸÑ - ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿ™ÿ≠ÿ±Ÿäÿ± ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</h4>
            </div>
            <div style="color: #388e3c; font-size: 0.95em; line-height: 1.5;">
                <div style="margin-bottom: 8px;"><strong>‚úèÔ∏è ÿßŸÑÿ¢ŸÜ ŸäŸÖŸÉŸÜŸÉ:</strong> ÿ™ÿ≠ÿ±Ÿäÿ± ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ÿå ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖŸÜÿßÿ∑ŸÇÿå ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ÿå ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑÿßÿ™ ÿ¨ÿØŸäÿØÿ©</div>
                <div style="margin-bottom: 8px;"><strong>üìä ŸÖÿ™ÿßÿ≠ ÿ£Ÿäÿ∂ÿßŸã:</strong> ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿå ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜ ŸÖŸÑŸÅÿßÿ™ ÿÆÿßÿ±ÿ¨Ÿäÿ©</div>
                <div style="background: #fff; padding: 8px; border-radius: 6px; border: 1px solid #a5d6a7; margin-top: 10px;">
                    <span style="font-weight: 600;">ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ!</span>
                    ÿ¨ŸÖŸäÿπ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± (‚úèÔ∏è) ŸàÿßŸÑÿ≠ÿ∞ŸÅ (üóëÔ∏è) ÿ£ÿµÿ®ÿ≠ÿ™ ŸÅÿπÿßŸÑÿ© ÿßŸÑÿ¢ŸÜ
                </div>
            </div>
        `;
    } else {
        // Ÿàÿ∂ÿπ ÿßŸÑÿπÿ±ÿ∂ ŸÅŸÇÿ∑
        statusBanner.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%)';
        statusBanner.style.borderColor = '#2196f3';
        statusContent.innerHTML = `
            <div style="margin-bottom: 8px;"><strong>üîç Ÿàÿ∂ÿπ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑÿ≠ÿßŸÑŸä:</strong> ŸäŸÖŸÉŸÜŸÉ ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸàÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±</div>
            <div style="margin-bottom: 8px;"><strong>‚úèÔ∏è ŸÑŸÑÿ™ÿ≠ÿ±Ÿäÿ± ŸàÿßŸÑÿ≠ÿ∞ŸÅ ŸàÿßŸÑÿ•ÿ∂ÿßŸÅÿ©:</strong> Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÉŸÖÿ∑Ÿàÿ± ŸÖŸÜ ÿ£ÿπŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ©</div>
            <div style="background: #fff; padding: 8px; border-radius: 6px; border: 1px solid #bbdefb; margin-top: 10px;">
                <span style="font-weight: 600;">ÿÆÿ∑Ÿàÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ©:</span>
                ÿßÿÆÿ™ÿ± "ÿßŸÑŸÖÿ∑Ÿàÿ±" ŸÖŸÜ ŸÇÿßÿ¶ŸÖÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ‚Üí ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿßŸÑŸÖÿ∑Ÿàÿ± ‚Üí ÿßŸÜŸÇÿ± "ÿØÿÆŸàŸÑ"
            </div>
        `;
    }
}

// ÿ•ÿ∫ŸÑÿßŸÇ ŸÖŸàÿØÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
function closeShopsManagementModal() {
    const modalElement = document.getElementById('shopsManagementModal');
    modalElement.style.display = 'none';
    modalElement.classList.remove('nested-modal');
    document.getElementById('editShopModal').style.display = 'none';
}

// ÿ™ÿ≠ÿØŸäÿ´ ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
function refreshShopsDisplay() {
    filteredShopsData = [...shopsData];
    applyShopsClassification();
    renderShopsTable();
}

// ŸÖŸÑÿ° ŸÇÿßÿ¶ŸÖÿ© ŸÅŸÑÿ™ÿ± ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
function populateShopsAreaFilter() {
    const areaFilter = document.getElementById('shopsAreaFilter');
    if (areaFilter) {
        areaFilter.innerHTML = '<option value="">-- ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ --</option>';
        areasData.forEach(area => {
            areaFilter.innerHTML += `<option value="${area.id}">${area.name}</option>`;
        });
    }
}

// ÿ™ÿ∑ÿ®ŸäŸÇ ŸÅŸÑÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©
function applyShopsAreaFilter() {
    applyShopsClassification();
}

// ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ∞ŸÉŸä
function applyShopsClassification() {
    const filterValue = document.getElementById('shopsClassificationFilter').value;
    const searchTerm = document.getElementById('shopsSearchInput').value.toLowerCase().trim();
    const selectedAreaId = document.getElementById('shopsAreaFilter').value;
    
    // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÜÿµŸä ÿ£ŸàŸÑÿßŸã
    if (searchTerm) {
        filteredShopsData = shopsData.filter(shop => 
            shop.name.toLowerCase().includes(searchTerm) ||
            (getAreaName(shop.areaId) && getAreaName(shop.areaId).toLowerCase().includes(searchTerm))
        );
    } else {
        filteredShopsData = [...shopsData];
    }
    
    // ÿ™ÿ∑ÿ®ŸäŸÇ ŸÅŸÑÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©
    if (selectedAreaId) {
        filteredShopsData = filteredShopsData.filter(shop => shop.areaId === selectedAreaId);
    }
    
    // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿµŸÜŸäŸÅ
    switch(filterValue) {
        case 'area':
            filteredShopsData.sort((a, b) => {
                const areaA = getAreaName(a.areaId) || '';
                const areaB = getAreaName(b.areaId) || '';
                return areaA.localeCompare(areaB, 'ar');
            });
            break;
        case 'alphabetical':
            filteredShopsData.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            break;
        case 'activity':
            filteredShopsData.sort((a, b) => {
                const activityA = getShopActivity(a.name);
                const activityB = getShopActivity(b.name);
                return activityA.localeCompare(activityB, 'ar');
            });
            break;
        case 'inspection_frequency':
            filteredShopsData.sort((a, b) => {
                const freqA = getShopInspectionCount(a.name);
                const freqB = getShopInspectionCount(b.name);
                return freqB - freqA; // ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ™ŸÅÿ™Ÿäÿ¥ÿßŸã ÿ£ŸàŸÑÿßŸã
            });
            break;
        case 'last_inspection':
            filteredShopsData.sort((a, b) => {
                const lastA = getLastInspectionDate(a.name);
                const lastB = getLastInspectionDate(b.name);
                return new Date(lastB) - new Date(lastA); // ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã
            });
            break;
    }
    
    renderShopsTable();
    updateShopsStats();
}

// ÿπÿ±ÿ∂ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
function renderShopsTable() {
    const tbody = document.getElementById('shopsTableBody');
    
    if (filteredShopsData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 2em;">üè™</div>
                    <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ÿ™ÿ∑ÿßÿ®ŸÇ ÿßŸÑŸÖÿπÿßŸäŸäÿ± ÿßŸÑŸÖÿ≠ÿØÿØÿ©</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    filteredShopsData.forEach((shop, index) => {
        const areaName = getAreaName(shop.areaId) || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        const activity = getShopActivity(shop.name);
        const lastInspection = getLastInspectionDate(shop.name);
        const inspectionCount = getShopInspectionCount(shop.name);
        
        html += `
            <tr style="border-bottom: 1px solid #e6ecf5; transition: background-color 0.2s ease;">
                <td style="padding: 10px 8px; text-align: center; font-weight: 600;">${index + 1}</td>
                <td style="padding: 10px 8px; font-weight: 600; color: #234085;">${shop.name}</td>
                <td style="padding: 10px 8px; text-align: center;">${areaName}</td>
                <td style="padding: 10px 8px; text-align: center;">
                    <span style="background: ${getActivityColor(activity)}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8em;">
                        ${activity}
                    </span>
                </td>
                <td style="padding: 10px 8px; text-align: center; color: ${lastInspection ? '#28a745' : '#dc3545'};">
                    ${lastInspection ? formatDate(lastInspection) : 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿ®ÿπÿØ'}
                </td>
                <td style="padding: 10px 8px; text-align: center;">
                    <span style="background: ${inspectionCount > 5 ? '#28a745' : inspectionCount > 2 ? '#ffc107' : '#dc3545'}; color: ${inspectionCount > 2 ? 'white' : 'black'}; padding: 3px 8px; border-radius: 12px; font-size: 0.9em; font-weight: bold;">
                        ${inspectionCount}
                    </span>
                </td>
                <td style="padding: 10px 8px; text-align: center;">
                    <button onclick="checkDeveloperAccess('shop-management', () => editShop(${index}))" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin: 0 2px;">
                        ‚úèÔ∏è
                    </button>
                    <button onclick="checkDeveloperAccess('shop-management', () => deleteShop(${index}))" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin: 0 2px;">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
function updateShopsStats() {
    const container = document.getElementById('shopsStatsContainer');
    
    const totalShops = filteredShopsData.length;
    const areas = [...new Set(filteredShopsData.map(shop => getAreaName(shop.areaId)))].filter(Boolean);
    const activities = [...new Set(filteredShopsData.map(shop => getShopActivity(shop.name)))];
    const inspectedShops = filteredShopsData.filter(shop => getShopInspectionCount(shop.name) > 0).length;
    
    container.innerHTML = `
        <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px; border-radius: 10px; text-align: center; min-width: 120px;">
            <div style="font-size: 1.8em; font-weight: bold;">${totalShops}</div>
            <div style="font-size: 0.9em;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>
        </div>
        <div style="background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%); color: white; padding: 15px; border-radius: 10px; text-align: center; min-width: 120px;">
            <div style="font-size: 1.8em; font-weight: bold;">${areas.length}</div>
            <div style="font-size: 0.9em;">ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</div>
        </div>
        <div style="background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%); color: white; padding: 15px; border-radius: 10px; text-align: center; min-width: 120px;">
            <div style="font-size: 1.8em; font-weight: bold;">${activities.length}</div>
            <div style="font-size: 0.9em;">ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©</div>
        </div>
        <div style="background: linear-gradient(135deg, #ff8c00 0%, #ff6b35 100%); color: white; padding: 15px; border-radius: 10px; text-align: center; min-width: 120px;">
            <div style="font-size: 1.8em; font-weight: bold;">${inspectedShops}</div>
            <div style="font-size: 0.9em;">ÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß</div>
        </div>
    `;
}

// Ÿàÿ∏ÿßÿ¶ŸÅ ŸÖÿ≥ÿßÿπÿØÿ©
function getAreaName(areaValue) {
    if (!areaValue) return '';
    
    // Check if it's an ID (starts with 'area_')
    if (typeof areaValue === 'string' && areaValue.startsWith('area_')) {
        const area = areasData.find(a => a.id === areaValue);
        return area ? area.name : areaValue;
    }
    
    // If it's already a name, return it as-is
    return areaValue;
}

function getArabicDayName(dateString) {
    // Convert date string to Date object
    const date = new Date(dateString + 'T00:00:00');
    const dayIndex = date.getDay();
    
    // Arabic day names
    const arabicDays = ['ÿßŸÑÿ£ÿ≠ÿØ', 'ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ', 'ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°', 'ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°', 'ÿßŸÑÿÆŸÖŸäÿ≥', 'ÿßŸÑÿ¨ŸÖÿπÿ©', 'ÿßŸÑÿ≥ÿ®ÿ™'];
    
    return arabicDays[dayIndex];
}

function getShopActivity(shopName) {
    // ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ ÿßŸÑŸÜÿ¥ÿßÿ∑ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ (ŸäŸÖŸÉŸÜ ÿ™ÿ≠ÿ≥ŸäŸÜŸá ŸÑÿßÿ≠ŸÇÿßŸã)
    if (shopName.includes('ÿπŸäÿßÿØÿ©') || shopName.includes('ÿ®Ÿäÿ∑ÿ±Ÿä')) return 'ÿπŸäÿßÿØÿ© ÿ®Ÿäÿ∑ÿ±Ÿäÿ©';
    if (shopName.includes('ÿµÿßŸÑŸàŸÜ') || shopName.includes('ÿ∫ÿ±ŸàŸÖŸäŸÜÿ∫')) return 'ÿµÿßŸÑŸàŸÜ ÿ≠ŸäŸàÿßŸÜÿßÿ™';
    if (shopName.includes('ÿ£ÿ≥ŸÖÿßŸÉ') || shopName.includes('ÿßŸÉŸàÿßÿ±ŸäŸàŸÖ')) return 'ŸÖÿ≠ŸÑ ÿ£ÿ≥ŸÖÿßŸÉ';
    if (shopName.includes('ÿ∑ŸäŸàÿ±') || shopName.includes('ÿπÿµÿßŸÅŸäÿ±')) return 'ŸÖÿ≠ŸÑ ÿ∑ŸäŸàÿ±';
    if (shopName.includes('ŸÖÿ≥ÿ™ŸÑÿ≤ŸÖÿßÿ™') || shopName.includes('ÿ•ŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™')) return 'ŸÖÿ≥ÿ™ŸÑÿ≤ŸÖÿßÿ™ ÿ≠ŸäŸàÿßŸÜÿßÿ™';
    return 'ŸÖÿ≠ŸÑ ÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿ£ŸÑŸäŸÅÿ©';
}

function getActivityColor(activity) {
    const colors = {
        'ÿπŸäÿßÿØÿ© ÿ®Ÿäÿ∑ÿ±Ÿäÿ©': '#dc3545',
        'ÿµÿßŸÑŸàŸÜ ÿ≠ŸäŸàÿßŸÜÿßÿ™': '#6f42c1',
        'ŸÖÿ≠ŸÑ ÿ£ÿ≥ŸÖÿßŸÉ': '#17a2b8',
        'ŸÖÿ≠ŸÑ ÿ∑ŸäŸàÿ±': '#ffc107',
        'ŸÖÿ≥ÿ™ŸÑÿ≤ŸÖÿßÿ™ ÿ≠ŸäŸàÿßŸÜÿßÿ™': '#28a745',
        'ŸÖÿ≠ŸÑ ÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿ£ŸÑŸäŸÅÿ©': '#234085'
    };
    return colors[activity] || '#6c757d';
}

function getShopInspectionCount(shopName) {
    return inspectionData.filter(item => 
        item.shops && item.shops.includes(shopName)
    ).length;
}

function getLastInspectionDate(shopName) {
    const inspections = inspectionData.filter(item => 
        item.shops && item.shops.includes(shopName)
    );
    if (inspections.length === 0) return null;
    
    const sortedInspections = inspections.sort((a, b) => new Date(b.day) - new Date(a.day));
    return sortedInspections[0].day;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-EG');
}

// ŸÅŸÑÿ™ÿ±ÿ© ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
function filterShopsList() {
    applyShopsClassification();
}

// ŸÖÿ≥ÿ≠ ÿßŸÑŸÅŸÑÿßÿ™ÿ±
function clearShopsFilters() {
    document.getElementById('shopsAreaFilter').value = '';
    document.getElementById('shopsClassificationFilter').value = '';
    document.getElementById('shopsSearchInput').value = '';
    refreshShopsDisplay();
}

// ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜ ŸÖÿµÿØÿ± ÿÆÿßÿ±ÿ¨Ÿä
function downloadShopsFromExternalSource() {
    const statusDiv = document.getElementById('shopsUpdateStatus');
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = 'ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑŸÖÿµÿØÿ± ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä...';
    statusDiv.style.background = '#d1ecf1';
    statusDiv.style.color = '#0c5460';
    
    // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ CSV ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ
    fetch('./ÿ¨ÿØŸàŸÑ_ÿ™Ÿàÿ≤Ÿäÿπ_ÿßŸÑŸÖÿ≠ŸÑÿßÿ™.csv')
        .then(response => {
            if (!response.ok) {
                // ÿ¨ÿ±ÿ® ŸÖÿ≥ÿßÿ± ÿ¢ÿÆÿ±
                return fetch('./files/ÿ¨ÿØŸàŸÑ_ÿ™Ÿàÿ≤Ÿäÿπ_ÿßŸÑŸÖÿ≠ŸÑÿßÿ™.csv');
            }
            return response;
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖŸÑŸÅ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™');
            }
            return response.text();
        })
        .then(csvText => {
            parseAndUpdateShopsFromCSV(csvText, statusDiv);
        })
        .catch(error => {
            console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä:', error);
            
            // ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿäÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ÿßŸÉÿßÿ©
            fallbackToMockExternalData(statusDiv);
        });
}

// ŸÖÿπÿßŸÑÿ¨ÿ© Ÿàÿ™ÿ≠ŸÑŸäŸÑ ŸÖŸÑŸÅ CSV ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™
function parseAndUpdateShopsFromCSV(csvText, statusDiv) {
    try {
        const lines = csvText.split('\n').filter(line => line.trim() !== '');
        const newShops = [];
        
        // ÿ™ÿÆÿ∑Ÿä ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑÿ£ŸàŸÑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿπŸÜÿßŸàŸäŸÜ
        const dataLines = lines[0].includes('ŸÖÿ≠ŸÑ') || lines[0].includes('ŸÖŸÜÿ∑ŸÇÿ©') ? lines.slice(1) : lines;
        
        dataLines.forEach((line, index) => {
            const columns = line.split(',').map(col => col.trim().replace(/"/g, ''));
            
            if (columns.length >= 2 && columns[0] && columns[1]) {
                const shopName = columns[0];
                const areaName = columns[1];
                
                // ÿ™ÿ¨ŸÜÿ® ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©
                const existingShop = shopsData.find(shop => shop.name === shopName);
                if (existingShop) return;
                
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÅŸä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
                let areaId = areasData.find(area => area.name === areaName)?.id;
                
                // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©ÿå ÿ£ŸÜÿ¥ÿ¶ ŸÖŸÜÿ∑ŸÇÿ© ÿ¨ÿØŸäÿØÿ©
                if (!areaId) {
                    areaId = `area_${Date.now()}_${Math.random()}`;
                    areasData.push({
                        id: areaId,
                        name: areaName
                    });
                }
                
                // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑ ÿßŸÑÿ¨ÿØŸäÿØ
                newShops.push({
                    id: `shop_${Date.now()}_${index}_${Math.random()}`,
                    name: shopName,
                    areaId: areaId,
                    source: 'external_csv'
                });
            }
        });
        
        if (newShops.length > 0) {
            // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ•ŸÑŸâ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
            shopsData.push(...newShops);
            
            statusDiv.innerHTML = `‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${newShops.length} ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿµÿØÿ± ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä`;
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
            refreshShopsDisplay();
            updateShopsStats();
        } else {
            statusDiv.innerHTML = '‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖÿ≠ŸÑÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸÅŸä ÿßŸÑŸÖÿµÿØÿ± ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
        }
        
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 4000);
        
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ŸÖŸÑŸÅ CSV:', error);
        fallbackToMockExternalData(statusDiv);
    }
}

// ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÅŸä ÿ≠ÿßŸÑÿ© ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
function fallbackToMockExternalData(statusDiv) {
    // ŸÖÿ≠ÿßŸÉÿßÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ŸÖÿµÿØÿ± ÿÆÿßÿ±ÿ¨Ÿä
    setTimeout(() => {
        const mockExternalShops = [
            {
                id: `shop_external_${Date.now()}_1`,
                name: 'ŸÖÿ≠ŸÑ ÿßŸÑÿ•ŸÖÿßÿ±ÿßÿ™ ŸÑŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿßŸÑÿ£ŸÑŸäŸÅÿ©',
                areaId: areasData[0]?.id || 'area_default',
                source: 'external'
            },
            {
                id: `shop_external_${Date.now()}_2`,
                name: 'ŸÖÿ±ŸÉÿ≤ ÿ£ÿ®Ÿàÿ∏ÿ®Ÿä ÿßŸÑÿ®Ÿäÿ∑ÿ±Ÿä ÿßŸÑŸÖÿ™ŸÇÿØŸÖ',
                areaId: areasData[1]?.id || 'area_default',
                source: 'external'
            },
            {
                id: `shop_external_${Date.now()}_3`,
                name: 'ÿπŸäÿßÿØÿ© ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿßŸÖŸÑÿ©',
                areaId: areasData[2]?.id || 'area_default',
                source: 'external'
            }
        ];
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© (ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ™ŸÉÿ±ÿßÿ±)
        let addedCount = 0;
        mockExternalShops.forEach(externalShop => {
            const exists = shopsData.find(shop => shop.name === externalShop.name);
            if (!exists) {
                shopsData.push(externalShop);
                addedCount++;
            }
        });
        
        statusDiv.innerHTML = `‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${addedCount} ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿµÿØÿ± ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä (ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©)`;
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
        refreshShopsDisplay();
        updateShopsStats();
        
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 4000);
        
    }, 1000);
}

// ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
function uploadShopsFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,.xlsx,.csv,.pdf,.txt,.doc,.docx';
    input.onchange = handleShopsFileUpload;
    input.click();
}

async function handleShopsFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const fileName = file.name;
    const fileExtension = fileName.split('.').pop().toLowerCase();
    
    const statusDiv = document.getElementById('shopsUpdateStatus');
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = 'ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ...';
    statusDiv.style.background = '#d1ecf1';
    statusDiv.style.color = '#0c5460';
    
    // ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿ•ŸÑŸâ GitHub (ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑)
    if (isDev || window.isDev) {
        const uploadResult = await uploadFileToGitHub(file, 'documents', `ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ - ${fileName}`);
        if (uploadResult.success) {
            statusDiv.innerHTML = `‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nÿßŸÑŸÖŸÑŸÅ: ${fileName}\nÿßŸÑÿ¢ŸÜ ŸÖÿ™ÿßÿ≠ ŸÑŸÑÿ¨ŸÖŸäÿπ ŸÅŸä ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™`;
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            setTimeout(() => statusDiv.style.display = 'none', 5000);
        } else {
            statusDiv.innerHTML = `‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ: ${uploadResult.error}\n\nÿ≥Ÿäÿ™ŸÖ ŸÖÿπÿßŸÑÿ¨ÿ™Ÿá ŸÖÿ≠ŸÑŸäÿßŸã ŸÅŸÇÿ∑`;
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
        }
    }
    
    try {
        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ ŸÖÿ≠ŸÑŸäÿßŸã
        if (fileExtension === 'json') {
            await handleJSONFileForShops(file, statusDiv);
        } else if (['xlsx', 'xls'].includes(fileExtension)) {
            await handleExcelFileForShops(file, statusDiv);
        } else if (fileExtension === 'pdf') {
            await handlePDFFileForShops(file, statusDiv);
        } else if (fileExtension === 'csv') {
            await handleCSVFileForShops(file, statusDiv);
        } else if (['txt', 'doc', 'docx'].includes(fileExtension)) {
            await handleTextFileForShops(file, statusDiv);
        } else {
            if (!isDev && !window.isDev) {
                statusDiv.innerHTML = `‚úÖ ÿ™ŸÖ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ "${fileName}" ŸÖÿ≠ŸÑŸäÿßŸã! ŸÜŸàÿπ ÿßŸÑŸÖŸÑŸÅ: ${fileExtension.toUpperCase()}`;
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
            }
        }
    } catch (error) {
        statusDiv.innerHTML = `‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ: ${error.message}`;
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
    }
    
    setTimeout(() => statusDiv.style.display = 'none', 4000);
}

async function handleJSONFileForShops(file, statusDiv) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (data.shops && Array.isArray(data.shops)) {
                let addedCount = 0;
                data.shops.forEach(shop => {
                    const exists = shopsData.find(s => s.name === shop.name);
                    if (!exists) {
                        shopsData.push({
                            id: shop.id || `shop_${Date.now()}_${Math.random()}`,
                            name: shop.name,
                            areaId: shop.areaId || areasData[0]?.id || 'area_default'
                        });
                        addedCount++;
                    }
                });
                
                statusDiv.innerHTML = `‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${addedCount} ŸÖÿ≠ŸÑ ŸÖŸÜ ŸÖŸÑŸÅ JSON`;
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                
                refreshShopsDisplay();
                updateShopsStats();
            } else {
                throw new Error('ÿ™ŸÜÿ≥ŸäŸÇ ŸÖŸÑŸÅ JSON ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');
            }
        } catch (error) {
            statusDiv.innerHTML = `‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ JSON: ${error.message}`;
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.color = '#721c24';
        }
    };
    reader.readAsText(file);
}

async function handleExcelFileForShops(file, statusDiv) {
    const result = await processExcelFile(file);
    if (result.success) {
        // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜ Excel
        let addedCount = 0;
        result.data.forEach(row => {
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ÿπŸÖÿØÿ© ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
            const possibleNameFields = ['name', 'ÿßÿ≥ŸÖ', 'ŸÖÿ≠ŸÑ', 'shop', 'ÿßŸÑÿßÿ≥ŸÖ', 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ'];
            let shopName = '';
            
            possibleNameFields.forEach(field => {
                if (row[field] && !shopName) {
                    shopName = row[field].toString().trim();
                }
            });
            
            if (shopName) {
                const exists = shopsData.find(s => s.name === shopName);
                if (!exists) {
                    shopsData.push({
                        id: `shop_${Date.now()}_${Math.random()}`,
                        name: shopName,
                        areaId: areasData[0]?.id || 'area_default'
                    });
                    addedCount++;
                }
            }
        });
        
        statusDiv.innerHTML = `‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${addedCount} ŸÖÿ≠ŸÑ ŸÖŸÜ ŸÖŸÑŸÅ Excel (ÿ•ÿ¨ŸÖÿßŸÑŸä ${result.data.length} ÿ≥ÿ¨ŸÑ)`;
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        
        refreshShopsDisplay();
        updateShopsStats();
    } else {
        statusDiv.innerHTML = `‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ Excel: ${result.error}`;
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
    }
}

async function handlePDFFileForShops(file, statusDiv) {
    statusDiv.innerHTML = 'üîÑ ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ŸÖŸÑŸÅ PDF... ŸÇÿØ Ÿäÿ≥ÿ™ÿ∫ÿ±ŸÇ Ÿáÿ∞ÿß ÿ®ÿπÿ∂ ÿßŸÑŸàŸÇÿ™.';
    
    const result = await processPDFFile(file);
    if (result.success) {
        // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜ ÿßŸÑŸÜÿµ
        const text = result.text;
        const lines = text.split('\n');
        let addedCount = 0;
        
        lines.forEach(line => {
            const trimmedLine = line.trim();
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ÿ≥ÿ∑ÿ± ŸÇÿØ ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ£ÿ≥ŸÖÿßÿ° ŸÖÿ≠ŸÑÿßÿ™
            if (trimmedLine.length > 5 && trimmedLine.length < 100) {
                // ÿ™ÿµŸÅŸäÿ© ŸÖÿ≠ÿ™ŸÖŸÑÿ© ŸÑÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
                if (trimmedLine.includes('ŸÖÿ≠ŸÑ') || trimmedLine.includes('ÿµÿßŸÑŸàŸÜ') || 
                    trimmedLine.includes('ŸÖÿ±ŸÉÿ≤') || trimmedLine.includes('ÿπŸäÿßÿØÿ©')) {
                    
                    const exists = shopsData.find(s => s.name === trimmedLine);
                    if (!exists) {
                        shopsData.push({
                            id: `shop_${Date.now()}_${Math.random()}`,
                            name: trimmedLine,
                            areaId: areasData[0]?.id || 'area_default'
                        });
                        addedCount++;
                    }
                }
            }
        });
        
        statusDiv.innerHTML = `‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ${addedCount} ŸÖÿ≠ŸÑ ŸÖÿ≠ÿ™ŸÖŸÑ ŸÖŸÜ ŸÖŸÑŸÅ PDF (${result.numPages} ÿµŸÅÿ≠ÿ©)`;
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        
        refreshShopsDisplay();
        updateShopsStats();
    } else {
        statusDiv.innerHTML = `‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ PDF: ${result.error}`;
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
    }
}

async function handleCSVFileForShops(file, statusDiv) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csvText = e.target.result;
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            let addedCount = 0;
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index] ? values[index].trim() : '';
                    });
                    
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ÿπŸÖÿØÿ© ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
                    const possibleNameFields = ['name', 'ÿßÿ≥ŸÖ', 'ŸÖÿ≠ŸÑ', 'shop', 'ÿßŸÑÿßÿ≥ŸÖ', 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ'];
                    let shopName = '';
                    
                    possibleNameFields.forEach(field => {
                        if (row[field] && !shopName) {
                            shopName = row[field].toString().trim();
                        }
                    });
                    
                    if (shopName) {
                        const exists = shopsData.find(s => s.name === shopName);
                        if (!exists) {
                            shopsData.push({
                                id: `shop_${Date.now()}_${Math.random()}`,
                                name: shopName,
                                areaId: areasData[0]?.id || 'area_default'
                            });
                            addedCount++;
                        }
                    }
                }
            }
            
            statusDiv.innerHTML = `‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${addedCount} ŸÖÿ≠ŸÑ ŸÖŸÜ ŸÖŸÑŸÅ CSV`;
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            
            refreshShopsDisplay();
            updateShopsStats();
        } catch (error) {
            statusDiv.innerHTML = `‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ CSV: ${error.message}`;
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.color = '#721c24';
        }
    };
    reader.readAsText(file, 'UTF-8');
}

async function handleTextFileForShops(file, statusDiv) {
    const result = await processTextFile(file);
    if (result.success) {
        const lines = result.text.split('\n');
        let addedCount = 0;
        
        lines.forEach(line => {
            const trimmedLine = line.trim();
            if (trimmedLine.length > 5 && trimmedLine.length < 100) {
                // ÿ™ÿµŸÅŸäÿ© ŸÖÿ≠ÿ™ŸÖŸÑÿ© ŸÑÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
                if (trimmedLine.includes('ŸÖÿ≠ŸÑ') || trimmedLine.includes('ÿµÿßŸÑŸàŸÜ') || 
                    trimmedLine.includes('ŸÖÿ±ŸÉÿ≤') || trimmedLine.includes('ÿπŸäÿßÿØÿ©')) {
                    
                    const exists = shopsData.find(s => s.name === trimmedLine);
                    if (!exists) {
                        shopsData.push({
                            id: `shop_${Date.now()}_${Math.random()}`,
                            name: trimmedLine,
                            areaId: areasData[0]?.id || 'area_default'
                        });
                        addedCount++;
                    }
                }
            }
        });
        
        statusDiv.innerHTML = `‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ${addedCount} ŸÖÿ≠ŸÑ ŸÖÿ≠ÿ™ŸÖŸÑ ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÜÿµŸä`;
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        
        refreshShopsDisplay();
        updateShopsStats();
    } else {
        statusDiv.innerHTML = `‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÜÿµŸä: ${result.error}`;
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
    }
}

// ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ•ŸÑŸâ Excel
function exportShopsToExcel() {
    const data = filteredShopsData.map((shop, index) => ({
        'ÿßŸÑÿ±ŸÇŸÖ': index + 1,
        'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ': shop.name,
        'ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©': getAreaName(shop.areaId) || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
        'ŸÜŸàÿπ ÿßŸÑŸÜÿ¥ÿßÿ∑': getShopActivity(shop.name),
        'ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥': getLastInspectionDate(shop.name) || 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿ®ÿπÿØ',
        'ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™': getShopInspectionCount(shop.name)
    }));
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    
    // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿπÿ±ÿ∂ ÿßŸÑÿ£ÿπŸÖÿØÿ©
    ws['!cols'] = [
        { width: 8 },   // ÿßŸÑÿ±ŸÇŸÖ
        { width: 25 },  // ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ
        { width: 20 },  // ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©
        { width: 18 },  // ŸÜŸàÿπ ÿßŸÑŸÜÿ¥ÿßÿ∑
        { width: 15 },  // ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥
        { width: 12 }   // ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, 'ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™');
    XLSX.writeFile(wb, `ŸÇÿßÿ¶ŸÖÿ©_ÿßŸÑŸÖÿ≠ŸÑÿßÿ™_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ•ŸÑŸâ PDF
function exportShopsToPDF() {
    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ jsPDF ŸÑÿ™ÿµÿØŸäÿ± PDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // ÿ•ÿπÿØÿßÿØ ÿßŸÑÿÆÿ∑ ÿßŸÑÿπÿ±ÿ®Ÿä
    doc.setFont('Arial', 'normal');
    doc.setFontSize(16);
    doc.text('ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿÆÿßÿ∂ÿπÿ© ŸÑŸÑÿ±ŸÇÿßÿ®ÿ© ŸàÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥', 105, 20, { align: 'center' });
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
    doc.setFontSize(10);
    doc.text(`ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${new Date().toLocaleDateString('ar-EG')}`, 20, 35);
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
    doc.text(`ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™: ${filteredShopsData.length}`, 20, 45);
    
    // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ
    doc.save(`ŸÇÿßÿ¶ŸÖÿ©_ÿßŸÑŸÖÿ≠ŸÑÿßÿ™_${new Date().toISOString().split('T')[0]}.pdf`);
}

// ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ ÿ®ÿ≥ÿ±ÿπÿ© (ÿ®ÿØŸàŸÜ ŸÅÿ™ÿ≠ ŸÖŸàÿØÿßŸÑ ŸÖŸÜŸÅÿµŸÑ)
function quickAddShop() {
    const nameInput = document.getElementById('quickAddShopName');
    const areaSelect = document.getElementById('quickAddShopArea');
    
    if (!nameInput || !areaSelect) {
        console.error('Quick add elements not found');
        return;
    }
    
    const name = nameInput.value.trim();
    const areaId = areaSelect.value;
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
    if (!name) {
        alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ');
        nameInput.focus();
        return;
    }
    
    if (!areaId) {
        alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©');
        areaSelect.focus();
        return;
    }
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ ÿßŸÑÿ™ŸÉÿ±ÿßÿ±
    const existingShop = shopsData.find(shop => shop.name.trim().toLowerCase() === name.toLowerCase());
    if (existingShop) {
        const areaName = getAreaName(existingShop.areaId) || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        alert('‚ö†Ô∏è Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≠ŸÑ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ©!\n\n' +
              'üìã ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ: ' + existingShop.name + '\n' +
              'üìç ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: ' + areaName + '\n\n' +
              'üí° Ÿäÿ±ÿ¨Ÿâ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßÿ≥ŸÖ ŸÖÿÆÿ™ŸÑŸÅ ÿ£Ÿà ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ ÿßŸÑŸÖŸàÿ¨ŸàÿØ.');
        nameInput.focus();
        nameInput.select();
        return;
    }
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑ ÿßŸÑÿ¨ÿØŸäÿØ
    const newShop = {
        id: `shop_${Date.now()}_${Math.random()}`,
        name: name,
        areaId: areaId
    };
    
    shopsData.push(newShop);
    
    // ŸÖÿ≥ÿ≠ ÿ≠ŸÇŸàŸÑ ÿßŸÑÿ•ÿØÿÆÿßŸÑ
    nameInput.value = '';
    areaSelect.value = '';
    nameInput.focus();
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
    refreshShopsDisplay();
    updateShopsStats();
    
    // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠
    const statusDiv = document.getElementById('shopsUpdateStatus');
    if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
        statusDiv.innerHTML = '‚úÖ ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≠ŸÑ "' + name + '" ÿ®ŸÜÿ¨ÿßÿ≠! ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ•ŸÑŸâ GitHub.';
        
        // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿ®ÿπÿØ 5 ÿ´ŸàÿßŸÜ
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    }
}

// ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ (ŸÅÿ™ÿ≠ ŸÖŸàÿØÿßŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑ)
function addNewShop() {
    document.getElementById('editShopModal').style.display = 'flex';
    document.getElementById('editShopForm').reset();
    document.getElementById('editShopIndex').value = '';
    
    // ŸÖŸÑÿ° ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
    const areaSelect = document.getElementById('editShopArea');
    areaSelect.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© --</option>';
    areasData.forEach(area => {
        areaSelect.innerHTML += `<option value="${area.id}">${area.name}</option>`;
    });
}

// ÿ™ÿπÿØŸäŸÑ ŸÖÿ≠ŸÑ
function editShop(index) {
    const shop = filteredShopsData[index];
    const originalIndex = shopsData.findIndex(s => s.id === shop.id);
    
    document.getElementById('editShopModal').style.display = 'flex';
    document.getElementById('editShopName').value = shop.name;
    document.getElementById('editShopArea').value = shop.areaId;
    document.getElementById('editShopIndex').value = originalIndex;
    
    // ŸÖŸÑÿ° ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
    const areaSelect = document.getElementById('editShopArea');
    areaSelect.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© --</option>';
    areasData.forEach(area => {
        areaSelect.innerHTML += `<option value="${area.id}" ${area.id === shop.areaId ? 'selected' : ''}>${area.name}</option>`;
    });
}

// ÿ≠ÿ∞ŸÅ ŸÖÿ≠ŸÑ
function deleteShop(index) {
    const shop = filteredShopsData[index];
    if (confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ŸÖÿ≠ŸÑ "${shop.name}"ÿü`)) {
        const originalIndex = shopsData.findIndex(s => s.id === shop.id);
        if (originalIndex !== -1) {
            shopsData.splice(originalIndex, 1);
            refreshShopsDisplay();
            updateShopsStats();
            
            // ÿπÿ±ÿ∂ ÿ™ÿ∞ŸÉŸäÿ± ÿ®ÿßŸÑÿ≠ŸÅÿ∏
            const statusDiv = document.getElementById('shopsUpdateStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
            statusDiv.innerHTML = '‚ö†Ô∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑ ŸÖÿ≠ŸÑŸäÿßŸã. ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ•ŸÑŸâ GitHub!';
            setTimeout(() => statusDiv.style.display = 'none', 5000);
        }
    }
}

// ÿ•ÿ∫ŸÑÿßŸÇ ŸÖŸàÿØÿßŸÑ ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ
function closeEditShopModal() {
    document.getElementById('editShopModal').style.display = 'none';
}

// ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
function refreshShopsData() {
    refreshShopsDisplay();
    updateShopsStats();
}

// ÿ™ÿπÿØŸäŸÑ ŸÖÿ¨ŸÖÿπ ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™
function bulkEditShops() {
    // ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸàÿØÿßŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ¨ŸÖÿπ
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    modal.style.zIndex = '10001';
    
    const modalContent = `
        <div class="modal-content" style="max-width: 95%; width: 1100px;">
            <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">√ó</button>
            <div class="stats-title" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: #000; padding: 15px;">
                ‚úèÔ∏è ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ¨ŸÖÿπ ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™
            </div>
            
            <div style="padding: 20px;">
                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">üìù ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ¨ŸÖÿπ:</h4>
                    <ul style="margin: 0; padding-right: 20px; color: #856404; line-height: 1.8;">
                        <li>ŸäŸÖŸÉŸÜŸÉ ÿ™ÿπÿØŸäŸÑ ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÅŸä ÿßŸÑÿÆŸÑÿßŸäÿß</li>
                        <li>ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ©</li>
                        <li>ÿ∂ÿπ ÿπŸÑÿßŸÖÿ© ‚úì ÿπŸÑŸâ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅŸáÿß</li>
                        <li>ÿßŸÜŸÇÿ± "ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™" ÿπŸÜÿØ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°</li>
                        <li><strong>ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ!</strong></li>
                    </ul>
                </div>
                
                <div style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px;">
                    <table id="bulkEditTable" style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #ffc107; color: #000; position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th style="padding: 10px; text-align: center; border: 1px solid #e0a800;">ÿ≠ÿ∞ŸÅ</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #e0a800;">#</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #e0a800;">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #e0a800;">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                            </tr>
                        </thead>
                        <tbody id="bulkEditTableBody">
                            <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button onclick="applyBulkEdits()" style="background: #28a745; color: #fff; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.1em;">
                        ‚úÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove()" style="background: #6c757d; color: #fff; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer;">
                        ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
            </div>
        </div>
    `;
    
    modal.innerHTML = modalContent;
    document.body.appendChild(modal);
    
    // ŸÖŸÑÿ° ÿßŸÑÿ¨ÿØŸàŸÑ ÿ®ÿßŸÑŸÖÿ≠ŸÑÿßÿ™
    const tbody = document.getElementById('bulkEditTableBody');
    let html = '';
    
    shopsData.forEach((shop, index) => {
        const areaName = getAreaName(shop.areaId) || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        html += `
            <tr style="border-bottom: 1px solid #dee2e6;">
                <td style="padding: 8px; text-align: center;">
                    <input type="checkbox" id="delete_${index}" style="width: 20px; height: 20px; cursor: pointer;">
                </td>
                <td style="padding: 8px; text-align: center;">${index + 1}</td>
                <td style="padding: 8px;">
                    <input type="text" id="name_${index}" value="${shop.name}" 
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: 'Cairo', Arial, sans-serif;">
                </td>
                <td style="padding: 8px;">
                    <select id="area_${index}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: 'Cairo', Arial, sans-serif;">
                        ${areasData.map(area => `
                            <option value="${area.id}" ${area.id === shop.areaId ? 'selected' : ''}>${area.name}</option>
                        `).join('')}
                    </select>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ÿßŸÑŸÖÿ¨ŸÖÿπÿ©
function applyBulkEdits() {
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ∑ÿ®ŸäŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ÿü')) {
        return;
    }
    
    let deletedCount = 0;
    let updatedCount = 0;
    
    // ÿßŸÑŸÖÿ±Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜ ÿßŸÑÿ£ÿÆŸäÿ± ŸÑŸÑÿ£ŸàŸÑ ŸÑÿ™ÿ¨ŸÜÿ® ŸÖÿ¥ÿßŸÉŸÑ ÿßŸÑŸÅŸáÿ±ÿ≥ÿ© ÿπŸÜÿØ ÿßŸÑÿ≠ÿ∞ŸÅ
    for (let i = shopsData.length - 1; i >= 0; i--) {
        const deleteCheckbox = document.getElementById(`delete_${i}`);
        
        if (deleteCheckbox && deleteCheckbox.checked) {
            // ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ŸÑ
            shopsData.splice(i, 1);
            deletedCount++;
        } else {
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            const nameInput = document.getElementById(`name_${i}`);
            const areaSelect = document.getElementById(`area_${i}`);
            
            if (nameInput && areaSelect) {
                const newName = nameInput.value.trim();
                const newAreaId = areaSelect.value;
                
                if (shopsData[i].name !== newName || shopsData[i].areaId !== newAreaId) {
                    shopsData[i].name = newName;
                    shopsData[i].areaId = newAreaId;
                    updatedCount++;
                }
            }
        }
    }
    
    // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖŸàÿØÿßŸÑ
    const modal = document.querySelector('.modal-overlay');
    if (modal) modal.remove();
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
    refreshShopsDisplay();
    updateShopsStats();
    
    // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠
    const statusDiv = document.getElementById('shopsUpdateStatus');
    statusDiv.style.display = 'block';
    statusDiv.style.background = '#d4edda';
    statusDiv.style.color = '#155724';
    statusDiv.innerHTML = `‚úÖ ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ÿßŸÑŸÖÿ¨ŸÖÿπÿ© ÿ®ŸÜÿ¨ÿßÿ≠!<br>
        ${updatedCount > 0 ? `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${updatedCount} ŸÖÿ≠ŸÑ` : ''}
        ${deletedCount > 0 ? ` | ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${deletedCount} ŸÖÿ≠ŸÑ` : ''}
        <br><strong>‚ö†Ô∏è ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ•ŸÑŸâ GitHub!</strong>`;
    
    setTimeout(() => statusDiv.style.display = 'none', 8000);
}

// ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ•ŸÑŸâ GitHub
async function saveShopsToGitHub() {
    const statusDiv = document.getElementById('shopsUpdateStatus');
    statusDiv.style.display = 'block';
    statusDiv.style.background = '#d1ecf1';
    statusDiv.style.color = '#0c5460';
    statusDiv.innerHTML = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ•ŸÑŸâ GitHub...';
    
    try {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ±
        if (!isDev && !window.isDev) {
            throw new Error('ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÖÿ∑ŸÑŸàÿ®ÿ© ŸÑŸÑÿ≠ŸÅÿ∏');
        }
        
        const repo = "aliabdelaal-adm/Monthly_inspection_plan";
        let token = localStorage.getItem("devToken");
        
        if (!token) {
            const defaultToken = "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";
            localStorage.setItem("devToken", defaultToken);
            token = defaultToken;
        }
        
        if (!token) {
            showTokenPopup();
            throw new Error('ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ŸàŸÉŸÜ GitHub');
        }
        
        // ÿ¨ŸÑÿ® ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ≠ÿßŸÑŸä ŸÑŸÄ plan-data.json
        statusDiv.innerHTML = '‚è≥ ÿ¨ÿßÿ±Ÿä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©...';
        
        const getResponse = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            }
        });
        
        if (!getResponse.ok) {
            let errorMsg = `ŸÅÿ¥ŸÑ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© plan-data.json: ${getResponse.status}`;
            try {
                const errorData = await getResponse.json();
                if (errorData.message) {
                    errorMsg += ` - ${errorData.message}`;
                }
            } catch (e) {
                // Ignore JSON parse errors
            }
            
            if (getResponse.status === 401 || getResponse.status === 403) {
                errorMsg += '\n\nüîë ÿßŸÑÿ™ŸàŸÉŸÜ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ÿ£Ÿà ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©.\n\nŸÑŸÑÿ≠ŸÑ:\n1. ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ‚öôÔ∏è\n2. ÿ£ÿØÿÆŸÑ ÿ™ŸàŸÉŸÜ GitHub ÿ¨ÿØŸäÿØ\n3. ÿßÿ≠ŸÅÿ∏ Ÿàÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ';
            }
            
            throw new Error(errorMsg);
        }
        
        const currentFile = await getResponse.json();
        const sha = currentFile.sha;
        
        // ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
        const planData = {
            inspectionData: inspectionData,
            inspectors: inspectorsData,
            areas: areasData,
            shops: shopsData,
            lastUpdate: new Date().toISOString(),
            bellNotes: bellNotesData || []
        };
        
        const jsonContent = JSON.stringify(planData, null, 2);
        const base64Content = btoa(unescape(encodeURIComponent(jsonContent)));
        
        // ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿ´ÿ©
        statusDiv.innerHTML = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ±ŸÅÿπ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ•ŸÑŸâ GitHub...';
        
        const updateResponse = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: `ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ - ${new Date().toLocaleString('ar-EG')}`,
                content: base64Content,
                sha: sha
            })
        });
        
        if (updateResponse.ok) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = `‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!<br>
                ÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™: ${shopsData.length}<br>
                ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ${new Date().toLocaleString('ar-EG')}<br>
                <strong>‚ú® ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÅŸä GitHub</strong>`;
            
            setTimeout(() => statusDiv.style.display = 'none', 6000);
        } else {
            let errorMsg = `ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏: ${updateResponse.status}`;
            try {
                const errorData = await updateResponse.json();
                if (errorData.message) {
                    errorMsg += ` - ${errorData.message}`;
                }
            } catch (e) {
                // Ignore JSON parse errors
            }
            
            if (updateResponse.status === 401 || updateResponse.status === 403) {
                errorMsg += '\n\nüîë ÿßŸÑÿ™ŸàŸÉŸÜ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ÿ£Ÿà ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©.\n\nŸÑŸÑÿ≠ŸÑ:\n1. ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ‚öôÔ∏è\n2. ÿ£ÿØÿÆŸÑ ÿ™ŸàŸÉŸÜ GitHub ÿ¨ÿØŸäÿØ\n3. ÿßÿ≠ŸÅÿ∏ Ÿàÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ';
            }
            
            throw new Error(errorMsg);
        }
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        
        // Format error message with line breaks
        const errorMsg = error.message.replace(/\n/g, '<br>');
        statusDiv.innerHTML = `‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™!<br><br>
            ${errorMsg}<br><br>
            üí° Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ`;
        
        // If it's a token error, offer to open token popup
        if (error.message.includes('401') || error.message.includes('403') || error.message.includes('ÿßŸÑÿ™ŸàŸÉŸÜ')) {
            statusDiv.innerHTML += `<br><br><button onclick="showTokenPopup()" style="background: #007bff; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">üîë ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿ¢ŸÜ</button>`;
        }
        
        setTimeout(() => statusDiv.style.display = 'none', 15000);
    }
}

// ŸÖÿπÿßŸÑÿ¨ÿ© ŸÜŸÖŸàÿ∞ÿ¨ ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑ
document.addEventListener('DOMContentLoaded', function() {
    const editShopForm = document.getElementById('editShopForm');
    if (editShopForm) {
        editShopForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('editShopName').value.trim();
            const areaId = document.getElementById('editShopArea').value;
            const index = document.getElementById('editShopIndex').value;
            
            if (!name || !areaId) {
                alert('Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©');
                return;
            }
            
            if (index === '') {
                // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ŸÑ ÿ¨ÿØŸäÿØ - ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ ÿßŸÑÿ™ŸÉÿ±ÿßÿ±
                const existingShop = shopsData.find(shop => shop.name.trim() === name);
                if (existingShop) {
                    alert('‚ö†Ô∏è Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≠ŸÑ ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ©!\n\nÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ: ' + existingShop.name + '\nÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: ' + (getAreaName(existingShop.areaId) || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'));
                    return;
                }
                
                const newShop = {
                    id: `shop_${Date.now()}_${Math.random()}`,
                    name: name,
                    areaId: areaId
                };
                shopsData.push(newShop);
            } else {
                // ÿ™ÿπÿØŸäŸÑ ŸÖÿ≠ŸÑ ŸÖŸàÿ¨ŸàÿØ - ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ŸÖÿπ ŸÖÿ≠ŸÑÿßÿ™ ÿ£ÿÆÿ±Ÿâ
                const existingShop = shopsData.find((shop, idx) => shop.name.trim() === name && idx !== parseInt(index));
                if (existingShop) {
                    alert('‚ö†Ô∏è Ÿáÿ∞ÿß ÿßŸÑÿßÿ≥ŸÖ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßŸÑŸÅÿπŸÑ ŸÑŸÖÿ≠ŸÑ ÿ¢ÿÆÿ± ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ©!\n\nÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ: ' + existingShop.name + '\nÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: ' + (getAreaName(existingShop.areaId) || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'));
                    return;
                }
                
                shopsData[parseInt(index)].name = name;
                shopsData[parseInt(index)].areaId = areaId;
            }
            
            closeEditShopModal();
            refreshShopsDisplay();
            updateShopsStats();
            
            // ÿπÿ±ÿ∂ ÿ™ÿ∞ŸÉŸäÿ± ÿ®ÿßŸÑÿ≠ŸÅÿ∏
            const statusDiv = document.getElementById('shopsUpdateStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
            statusDiv.innerHTML = '‚ö†Ô∏è ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã. ŸÑÿß ÿ™ŸÜÿ≥Ÿé ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ•ŸÑŸâ GitHub!';
            setTimeout(() => statusDiv.style.display = 'none', 5000);
        });
    }
});

// ===== Ÿàÿ∏ÿßÿ¶ŸÅ ÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÅŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ =====
// Shop Priority Recommendation System

/**
 * ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ≠ÿ≥ÿ® ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÅŸä ŸÅÿ™ÿ±ÿ© ÿ≤ŸÖŸÜŸäÿ© ŸÖÿ≠ÿØÿØÿ©
 * Analyze shops by inspection count in a specific time period
 * @param {Date} startDate - ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ© / Start date
 * @param {Date} endDate - ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÜŸáÿßŸäÿ© / End date
 * @returns {Array} - ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖÿπ ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ / List of shops with inspection counts
 */
function analyzeShopInspectionPriority(startDate, endDate) {
    const startDateStr = startDate.toISOString().split('T')[0];
    const endDateStr = endDate.toISOString().split('T')[0];
    
    // ÿ•ŸÜÿ¥ÿßÿ° ÿÆÿ±Ÿäÿ∑ÿ© ŸÑÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÑŸÉŸÑ ŸÖÿ≠ŸÑ / Create map of inspection counts per shop
    const shopInspectionMap = {};
    
    // ÿ™ŸáŸäÿ¶ÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ®ÿπÿØÿØ ÿµŸÅÿ± / Initialize all shops with zero count
    shopsData.forEach(shop => {
        shopInspectionMap[shop.name] = {
            shopName: shop.name,
            shopId: shop.id,
            areaId: shop.areaId,
            areaName: getAreaName(shop.areaId),
            inspectionCount: 0,
            lastInspectionDate: null,
            inspectors: []
        };
    });
    
    // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ ŸÑŸÉŸÑ ŸÖÿ≠ŸÑ ŸÅŸä ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ© / Count inspections per shop in the period
    inspectionData.forEach(inspection => {
        const inspectionDate = inspection.day;
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ŸÅŸä ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ© / Check if inspection is in the period
        if (inspectionDate >= startDateStr && inspectionDate <= endDateStr) {
            if (inspection.shops && Array.isArray(inspection.shops)) {
                inspection.shops.forEach(shopName => {
                    if (shopInspectionMap[shopName]) {
                        shopInspectionMap[shopName].inspectionCount++;
                        
                        // ÿ™ÿ≠ÿØŸäÿ´ ÿ¢ÿÆÿ± ÿ™ÿßÿ±ŸäÿÆ ÿ™ŸÅÿ™Ÿäÿ¥ / Update last inspection date
                        if (!shopInspectionMap[shopName].lastInspectionDate || 
                            inspectionDate > shopInspectionMap[shopName].lastInspectionDate) {
                            shopInspectionMap[shopName].lastInspectionDate = inspectionDate;
                        }
                        
                        // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿ•ŸÑŸâ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© / Add inspector to list
                        if (!shopInspectionMap[shopName].inspectors.includes(inspection.inspector)) {
                            shopInspectionMap[shopName].inspectors.push(inspection.inspector);
                        }
                    }
                });
            }
        }
    });
    
    // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿ•ŸÑŸâ ŸÖÿµŸÅŸàŸÅÿ© Ÿàÿ™ÿ±ÿ™Ÿäÿ®Ÿáÿß / Convert map to array and sort
    const priorityList = Object.values(shopInspectionMap)
        .sort((a, b) => {
            // ÿ™ÿ±ÿ™Ÿäÿ® ÿ≠ÿ≥ÿ® ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™ (ÿßŸÑÿ£ŸÇŸÑ ÿ£ŸàŸÑÿßŸã) / Sort by inspection count (least first)
            if (a.inspectionCount !== b.inspectionCount) {
                return a.inspectionCount - b.inspectionCount;
            }
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿπÿØÿØ ŸÖÿ™ÿ≥ÿßŸàŸäÿßŸãÿå ÿ±ÿ™ÿ® ÿ≠ÿ≥ÿ® ÿ¢ÿÆÿ± ÿ™ÿßÿ±ŸäÿÆ ÿ™ŸÅÿ™Ÿäÿ¥ (ÿßŸÑÿ£ŸÇÿØŸÖ ÿ£ŸàŸÑÿßŸã) / If equal, sort by last inspection (oldest first)
            if (a.lastInspectionDate && b.lastInspectionDate) {
                return a.lastInspectionDate.localeCompare(b.lastInspectionDate);
            }
            if (!a.lastInspectionDate) return -1;
            if (!b.lastInspectionDate) return 1;
            return 0;
        });
    
    return priorityList;
}

/**
 * ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ∞ÿßÿ™ ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ŸÅŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ŸÑŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≥ÿßÿ®ŸÇ
 * Get priority shops for previous month
 * @returns {Object} - ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ / Analysis information
 */
function getPreviousMonthPriorityShops() {
    const now = new Date();
    const firstDayOfCurrentMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastDayOfPreviousMonth = new Date(firstDayOfCurrentMonth);
    lastDayOfPreviousMonth.setDate(lastDayOfPreviousMonth.getDate() - 1);
    const firstDayOfPreviousMonth = new Date(lastDayOfPreviousMonth.getFullYear(), lastDayOfPreviousMonth.getMonth(), 1);
    
    const priorityList = analyzeShopInspectionPriority(firstDayOfPreviousMonth, lastDayOfPreviousMonth);
    
    return {
        period: 'previous_month',
        periodName: 'ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≥ÿßÿ®ŸÇ',
        startDate: firstDayOfPreviousMonth.toISOString().split('T')[0],
        endDate: lastDayOfPreviousMonth.toISOString().split('T')[0],
        monthName: lastDayOfPreviousMonth.toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' }),
        shops: priorityList,
        totalShops: priorityList.length,
        uninspectedCount: priorityList.filter(s => s.inspectionCount === 0).length,
        leastInspectedCount: priorityList.filter(s => s.inspectionCount > 0 && s.inspectionCount <= 2).length
    };
}

/**
 * ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ∞ÿßÿ™ ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ŸÅŸä ÿßŸÑŸÜÿµŸÅ ÿßŸÑÿ£ŸàŸÑ ŸÖŸÜ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä
 * Get priority shops for first half of current month
 * @returns {Object} - ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ / Analysis information
 */
function getCurrentMonthFirstHalfPriorityShops() {
    const now = new Date();
    const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const fifteenthDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 15);
    
    const priorityList = analyzeShopInspectionPriority(firstDayOfMonth, fifteenthDayOfMonth);
    
    return {
        period: 'current_month_first_half',
        periodName: 'ÿßŸÑŸÜÿµŸÅ ÿßŸÑÿ£ŸàŸÑ ŸÖŸÜ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä',
        startDate: firstDayOfMonth.toISOString().split('T')[0],
        endDate: fifteenthDayOfMonth.toISOString().split('T')[0],
        monthName: now.toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' }),
        shops: priorityList,
        totalShops: priorityList.length,
        uninspectedCount: priorityList.filter(s => s.inspectionCount === 0).length,
        leastInspectedCount: priorityList.filter(s => s.inspectionCount > 0 && s.inspectionCount <= 1).length
    };
}

/**
 * ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸàÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ
 * Show shop priority modal for developer and inspectors (read-only for inspectors)
 */
function showShopPriorityModal() {
    // ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ - ŸÖÿ™ÿßÿ≠ ŸÑŸÑÿ¨ŸÖŸäÿπ ŸÑŸÑÿπÿ±ÿ∂
    // No permission check - available for all users to view
    
    // ÿ•ŸÜÿ¥ÿßÿ° ÿ£Ÿà ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿπŸÜÿµÿ± ÿßŸÑŸÖŸàÿØÿßŸÑ / Create or get modal element
    let modal = document.getElementById('shopPriorityModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'shopPriorityModal';
        modal.style.cssText = `
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            padding: 20px;
        `;
        document.body.appendChild(modal);
    }
    
    // ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ / Analyze data
    const previousMonthAnalysis = getPreviousMonthPriorityShops();
    const currentMonthFirstHalfAnalysis = getCurrentMonthFirstHalfPriorityShops();
    
    // ÿ®ŸÜÿßÿ° ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÖŸàÿØÿßŸÑ / Build modal content
    const modalContent = `
        <div style="background: white; margin: auto; max-width: 1200px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative; max-height: 90vh; overflow-y: auto;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; border-radius: 12px 12px 0 0; position: sticky; top: 0; z-index: 100;">
                <h2 style="margin: 0; font-size: 1.8em; display: flex; align-items: center; gap: 10px;">
                    <span>üìä</span>
                    <span>ÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÅŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥</span>
                </h2>
                <p style="margin: 8px 0 0 0; font-size: 0.95em; opacity: 0.95;">
                    ÿ™ÿ≠ŸÑŸäŸÑ ÿ∞ŸÉŸä ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ£ŸàŸÑŸàŸäÿ© ŸÅŸä ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥
                </p>
                <button onclick="closeShopPriorityModal()" style="position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5em; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">√ó</button>
            </div>
            
            <!-- Content -->
            <div style="padding: 30px;">
                <!-- Previous Month Analysis -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: #667eea; font-size: 1.5em; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                        <span>üìÖ</span>
                        <span>ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≥ÿßÿ®ŸÇ: ${previousMonthAnalysis.monthName}</span>
                    </h3>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 2em; color: #dc3545; font-weight: bold;">${previousMonthAnalysis.uninspectedCount}</div>
                                <div style="color: #666; font-size: 0.9em; margin-top: 5px;">ŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 2em; color: #ffc107; font-weight: bold;">${previousMonthAnalysis.leastInspectedCount}</div>
                                <div style="color: #666; font-size: 0.9em; margin-top: 5px;">ŸÖÿ≠ŸÑÿßÿ™ ŸÇŸÑŸäŸÑÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ (1-2)</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 2em; color: #28a745; font-weight: bold;">${previousMonthAnalysis.totalShops - previousMonthAnalysis.uninspectedCount - previousMonthAnalysis.leastInspectedCount}</div>
                                <div style="color: #666; font-size: 0.9em; margin-top: 5px;">ŸÖÿ≠ŸÑÿßÿ™ ÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß ÿ®ÿ¥ŸÉŸÑ ŸÉÿßŸÅŸç</div>
                            </div>
                        </div>
                    </div>
                    ${generatePriorityTable(previousMonthAnalysis, 'previousMonth')}
                </div>
                
                <!-- Current Month First Half Analysis -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #764ba2; font-size: 1.5em; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                        <span>üìÜ</span>
                        <span>ÿßŸÑŸÜÿµŸÅ ÿßŸÑÿ£ŸàŸÑ ŸÖŸÜ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä: ${currentMonthFirstHalfAnalysis.monthName}</span>
                    </h3>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 2em; color: #dc3545; font-weight: bold;">${currentMonthFirstHalfAnalysis.uninspectedCount}</div>
                                <div style="color: #666; font-size: 0.9em; margin-top: 5px;">ŸÖÿ≠ŸÑÿßÿ™ ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 2em; color: #ffc107; font-weight: bold;">${currentMonthFirstHalfAnalysis.leastInspectedCount}</div>
                                <div style="color: #666; font-size: 0.9em; margin-top: 5px;">ŸÖÿ≠ŸÑÿßÿ™ ŸÇŸÑŸäŸÑÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ (1)</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 2em; color: #28a745; font-weight: bold;">${currentMonthFirstHalfAnalysis.totalShops - currentMonthFirstHalfAnalysis.uninspectedCount - currentMonthFirstHalfAnalysis.leastInspectedCount}</div>
                                <div style="color: #666; font-size: 0.9em; margin-top: 5px;">ŸÖÿ≠ŸÑÿßÿ™ ÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß ÿ®ÿ¥ŸÉŸÑ ŸÉÿßŸÅŸç</div>
                            </div>
                        </div>
                    </div>
                    ${generatePriorityTable(currentMonthFirstHalfAnalysis, 'currentMonth')}
                </div>
                
                <!-- Instructions -->
                <div style="background: #e7f3ff; border-left: 4px solid #667eea; padding: 15px; border-radius: 8px; margin-top: 30px;">
                    <h4 style="margin: 0 0 10px 0; color: #667eea; font-size: 1.1em;">üí° ŸÉŸäŸÅŸäÿ© ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ:</h4>
                    <ul style="margin: 0; padding-right: 20px; line-height: 1.8;">
                        <li>ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ±ÿ™ÿ®ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© (ÿßŸÑÿ£ŸÇŸÑ ÿ™ŸÅÿ™Ÿäÿ¥ÿßŸã ÿ£ŸàŸÑÿßŸã)</li>
                        <li><strong style="color: #dc3545;">ÿßŸÑÿ£ÿ≠ŸÖÿ±:</strong> ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸÖÿ≠ŸÑ - ÿ£ŸàŸÑŸàŸäÿ© ÿπÿßŸÑŸäÿ© ÿ¨ÿØÿßŸã</li>
                        <li><strong style="color: #ffc107;">ÿßŸÑÿ£ÿµŸÅÿ±:</strong> ÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸÖÿ≠ŸÑ ŸÖÿ±ÿ© ÿ£Ÿà ŸÖÿ±ÿ™ŸäŸÜ ŸÅŸÇÿ∑ - ÿ£ŸàŸÑŸàŸäÿ© ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©</li>
                        <li><strong style="color: #28a745;">ÿßŸÑÿ£ÿÆÿ∂ÿ±:</strong> ÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸÖÿ≠ŸÑ ÿ®ÿ¥ŸÉŸÑ ŸÉÿßŸÅŸç</li>
                        <li>ÿßÿ≥ÿ™ÿÆÿØŸÖ Ÿáÿ∞Ÿá ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÑÿ™ÿ≠ÿØŸäÿØ ÿ£ŸàŸÑŸàŸäÿßÿ™ ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ÿßŸÑŸÇÿßÿØŸÖÿ©</li>
                        <li>ŸäŸÖŸÉŸÜŸÉ ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿ®ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿ≤ÿ± "ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨"</li>
                    </ul>
                </div>
                
                <!-- Action Buttons -->
                <div style="margin-top: 25px; text-align: center; display: flex; gap: 15px; justify-content: center;">
                    ${isDev ? `
                    <button onclick="exportShopPriorityResults()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                        üì• ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ (Excel)
                    </button>
                    ` : `
                    <div style="padding: 10px 20px; background: #e9ecef; border-radius: 8px; color: #495057; font-size: 0.9em;">
                        ‚ÑπÔ∏è Ÿàÿ∂ÿπ ÿßŸÑÿπÿ±ÿ∂ ŸÅŸÇÿ∑ - ÿßŸÑÿ™ÿµÿØŸäÿ± ŸÖÿ™ÿßÿ≠ ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑
                    </div>
                    `}
                    <button onclick="closeShopPriorityModal()" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                        ÿ•ÿ∫ŸÑÿßŸÇ
                    </button>
                </div>
            </div>
        </div>
    `;
    
    modal.innerHTML = modalContent;
    modal.style.display = 'block';
}

/**
 * ÿ™ŸàŸÑŸäÿØ ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸàŸÑŸàŸäÿßÿ™
 * Generate priority table
 */
function generatePriorityTable(analysis, prefix) {
    // ÿπÿ±ÿ∂ ÿ£ŸàŸÑ 50 ŸÖÿ≠ŸÑ ŸÅŸÇÿ∑ (ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ£ŸàŸÑŸàŸäÿ©) / Show only first 50 shops (highest priority)
    const shopsToShow = analysis.shops.slice(0, 50);
    
    let tableHTML = `
        <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <th style="padding: 12px; text-align: center; font-weight: bold;">#</th>
                            <th style="padding: 12px; text-align: right; font-weight: bold;">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ</th>
                            <th style="padding: 12px; text-align: center; font-weight: bold;">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                            <th style="padding: 12px; text-align: center; font-weight: bold;">ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™</th>
                            <th style="padding: 12px; text-align: center; font-weight: bold;">ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥</th>
                            <th style="padding: 12px; text-align: center; font-weight: bold;">ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    shopsToShow.forEach((shop, index) => {
        let priorityLabel = '';
        let priorityColor = '';
        let bgColor = '';
        
        if (shop.inspectionCount === 0) {
            priorityLabel = 'ÿπÿßŸÑŸäÿ© ÿ¨ÿØÿßŸã üî¥';
            priorityColor = '#dc3545';
            bgColor = index % 2 === 0 ? '#fff5f5' : '#ffe5e5';
        } else if (shop.inspectionCount <= 2 && analysis.period === 'previous_month') {
            priorityLabel = 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ© üü°';
            priorityColor = '#ffc107';
            bgColor = index % 2 === 0 ? '#fffdf0' : '#fff9e6';
        } else if (shop.inspectionCount <= 1 && analysis.period === 'current_month_first_half') {
            priorityLabel = 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ© üü°';
            priorityColor = '#ffc107';
            bgColor = index % 2 === 0 ? '#fffdf0' : '#fff9e6';
        } else {
            priorityLabel = 'ŸÖŸÜÿÆŸÅÿ∂ÿ© üü¢';
            priorityColor = '#28a745';
            bgColor = index % 2 === 0 ? '#f0fff4' : '#e6f9ec';
        }
        
        tableHTML += `
            <tr style="background: ${bgColor}; border-bottom: 1px solid #e0e0e0;">
                <td style="padding: 10px; text-align: center; font-weight: bold; color: #666;">${index + 1}</td>
                <td style="padding: 10px; text-align: right; font-weight: 600; color: #333;">${shop.shopName}</td>
                <td style="padding: 10px; text-align: center; color: #666;">${shop.areaName || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                <td style="padding: 10px; text-align: center;">
                    <span style="background: ${priorityColor}; color: white; padding: 4px 12px; border-radius: 12px; font-weight: bold; font-size: 0.95em;">
                        ${shop.inspectionCount}
                    </span>
                </td>
                <td style="padding: 10px; text-align: center; color: ${shop.lastInspectionDate ? '#666' : '#dc3545'}; font-size: 0.9em;">
                    ${shop.lastInspectionDate ? new Date(shop.lastInspectionDate).toLocaleDateString('ar-EG') : 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿ®ÿπÿØ'}
                </td>
                <td style="padding: 10px; text-align: center; color: ${priorityColor}; font-weight: bold;">
                    ${priorityLabel}
                </td>
            </tr>
        `;
    });
    
    tableHTML += `
                    </tbody>
                </table>
            </div>
            ${analysis.shops.length > 50 ? `
                <div style="padding: 15px; text-align: center; background: #f7fafc; border-top: 1px solid #e0e0e0; color: #666;">
                    ÿπÿ±ÿ∂ ÿ£ŸàŸÑ 50 ŸÖÿ≠ŸÑ ŸÖŸÜ ÿ£ÿµŸÑ ${analysis.shops.length} ŸÖÿ≠ŸÑ. ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ©ÿå ŸÇŸÖ ÿ®ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨.
                </div>
            ` : ''}
        </div>
    `;
    
    return tableHTML;
}

/**
 * ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ£ŸàŸÑŸàŸäÿßÿ™
 * Close priority modal
 */
function closeShopPriorityModal() {
    const modal = document.getElementById('shopPriorityModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

/**
 * ÿ™ÿµÿØŸäÿ± ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ£ŸàŸÑŸàŸäÿßÿ™ ÿ•ŸÑŸâ Excel
 * Export priority results to Excel
 */
function exportShopPriorityResults() {
    const previousMonthAnalysis = getPreviousMonthPriorityShops();
    const currentMonthFirstHalfAnalysis = getCurrentMonthFirstHalfPriorityShops();
    
    // ÿ®ŸÜÿßÿ° ÿ®ŸäÿßŸÜÿßÿ™ Excel / Build Excel data
    let csvContent = '\uFEFF'; // UTF-8 BOM for Arabic support
    
    // ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≥ÿßÿ®ŸÇ / Previous Month
    csvContent += `ÿ™ŸÇÿ±Ÿäÿ± ÿ£ŸàŸÑŸàŸäÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÅŸä ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥\n`;
    csvContent += `\n`;
    csvContent += `ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ£ŸàŸÑ: ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≥ÿßÿ®ŸÇ - ${previousMonthAnalysis.monthName}\n`;
    csvContent += `ÿßŸÑŸÅÿ™ÿ±ÿ©: ŸÖŸÜ ${previousMonthAnalysis.startDate} ÿ•ŸÑŸâ ${previousMonthAnalysis.endDate}\n`;
    csvContent += `\n`;
    csvContent += `#,ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ,ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©,ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™,ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥,ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©\n`;
    
    previousMonthAnalysis.shops.forEach((shop, index) => {
        let priorityLabel = shop.inspectionCount === 0 ? 'ÿπÿßŸÑŸäÿ© ÿ¨ÿØÿßŸã' : 
                           shop.inspectionCount <= 2 ? 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©' : 'ŸÖŸÜÿÆŸÅÿ∂ÿ©';
        csvContent += `${index + 1},"${shop.shopName}","${shop.areaName || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}",${shop.inspectionCount},"${shop.lastInspectionDate ? new Date(shop.lastInspectionDate).toLocaleDateString('ar-EG') : 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿ®ÿπÿØ'}","${priorityLabel}"\n`;
    });
    
    // ÿßŸÑŸÜÿµŸÅ ÿßŸÑÿ£ŸàŸÑ ŸÖŸÜ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä / Current Month First Half
    csvContent += `\n\n`;
    csvContent += `ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ´ÿßŸÜŸä: ÿßŸÑŸÜÿµŸÅ ÿßŸÑÿ£ŸàŸÑ ŸÖŸÜ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä - ${currentMonthFirstHalfAnalysis.monthName}\n`;
    csvContent += `ÿßŸÑŸÅÿ™ÿ±ÿ©: ŸÖŸÜ ${currentMonthFirstHalfAnalysis.startDate} ÿ•ŸÑŸâ ${currentMonthFirstHalfAnalysis.endDate}\n`;
    csvContent += `\n`;
    csvContent += `#,ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÑ,ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©,ÿπÿØÿØ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ÿßÿ™,ÿ¢ÿÆÿ± ÿ™ŸÅÿ™Ÿäÿ¥,ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©\n`;
    
    currentMonthFirstHalfAnalysis.shops.forEach((shop, index) => {
        let priorityLabel = shop.inspectionCount === 0 ? 'ÿπÿßŸÑŸäÿ© ÿ¨ÿØÿßŸã' : 
                           shop.inspectionCount <= 1 ? 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©' : 'ŸÖŸÜÿÆŸÅÿ∂ÿ©';
        csvContent += `${index + 1},"${shop.shopName}","${shop.areaName || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}",${shop.inspectionCount},"${shop.lastInspectionDate ? new Date(shop.lastInspectionDate).toLocaleDateString('ar-EG') : 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿ®ÿπÿØ'}","${priorityLabel}"\n`;
    });
    
    // ÿ•ŸÜÿ¥ÿßÿ° Ÿàÿ™ŸÜÿ≤ŸäŸÑ ÿßŸÑŸÖŸÑŸÅ / Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    const timestamp = new Date().toISOString().split('T')[0];
    
    link.setAttribute('href', url);
    link.setAttribute('download', `ÿ™ŸÇÿ±Ÿäÿ±_ÿ£ŸàŸÑŸàŸäÿ©_ÿßŸÑŸÖÿ≠ŸÑÿßÿ™_${timestamp}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert('‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®ŸÜÿ¨ÿßÿ≠!\n\nŸäŸÖŸÉŸÜŸÉ ŸÅÿ™ÿ≠ ÿßŸÑŸÖŸÑŸÅ ŸÅŸä Excel ŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ©.');
}

// ===== Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ™ÿØŸàŸäÿ± ÿßŸÑÿ∞ŸÉŸä ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™ ÿπŸÑŸâ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ =====

// ÿßÿÆÿ™ÿ®ÿßÿ± JavaScript
console.log('Smart Rotation JavaScript loaded');

// ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ™ÿØŸàŸäÿ± ÿßŸÑÿ∞ŸÉŸä
let generatedRotationPlan = [];
let currentRotationAnalysis = null;

// ŸÅÿ™ÿ≠ ŸÖŸàÿØÿßŸÑ ÿßŸÑÿ™ÿØŸàŸäÿ± ÿßŸÑÿ∞ŸÉŸä
function showSmartRotationModal() {
    // Allow all users to open the modal (inspectors can view but not modify)
    openSmartRotationModal();
}

// ŸÅÿ™ÿ≠ ŸÖŸàÿØÿßŸÑ ÿßŸÑÿ™ÿØŸàŸäÿ± ÿßŸÑÿ∞ŸÉŸä (ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ©)
function openSmartRotationModal() {
    // ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä ŸÑŸÑŸäŸàŸÖ
    const today = new Date();
    document.getElementById('rotationStartDate').value = today.toISOString().split('T')[0];
    
    // ŸÖŸÑÿ° ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ
    populateInspectorSelection();
    
    // Ensure inspector selection is populated (fallback approach)
    setTimeout(() => {
        const selectionDiv = document.getElementById('inspectorSelection');
        if (selectionDiv && selectionDiv.innerHTML.includes('ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸáŸÜÿß')) {
            // Use hardcoded fallback if data loading failed
            const inspectors = [
                { id: 'insp_1', name: 'ÿØ. ÿ¢ŸÖŸÜŸá ÿ®ŸÜ ÿµÿ±ŸÖ' },
                { id: 'insp_2', name: 'ÿØ. ÿ¢ŸäŸá ÿ≥ŸÑÿßŸÖÿ©' },
                { id: 'insp_3', name: 'ÿØ. ÿ≠ÿ≥ŸäŸÜÿ© ÿßŸÑÿπÿßŸÖÿ±Ÿä' },
                { id: 'insp_4', name: 'ÿØ. ÿ≠ÿµÿ© ÿßŸÑÿπŸÑŸä' },
                { id: 'insp_5', name: 'ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ' },
                { id: 'insp_6', name: 'ÿØ. ŸÅÿßŸäÿ≤ ÿßŸÑŸÖÿ≥ÿßŸÑŸÖÿ©' },
                { id: 'insp_7', name: 'ÿØ. ŸÖÿ≠ŸÖÿØ ÿ•ÿ≥ŸÖÿßÿπŸäŸÑ' },
                { id: 'insp_8', name: 'ÿØ. ŸÖÿ≠ŸÖÿØ ÿ≥ÿπŸäÿØ' },
                { id: 'insp_9', name: 'ÿØ. Ÿáÿßÿ¨ÿ± ÿßŸÑÿ∫ÿßŸÅÿ±Ÿä' }
            ];
            
            let html = "";
            inspectors.forEach(inspector => {
                html += `
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" name="selectedInspectors" value="${inspector.id}" checked 
                               style="margin: 0;">
                        <span style="font-size: 0.9em;">${inspector.name}</span>
                    </label>
                `;
            });
            
            html += `
                <div style="margin-top: 10px; display: flex; gap: 8px; justify-content: center;">
                    <button type="button" onclick="selectAllInspectors()" 
                            style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">
                        ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ
                    </button>
                    <button type="button" onclick="deselectAllInspectors()" 
                            style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">
                        ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ≠ÿØŸäÿØ
                    </button>
                </div>
            `;
            
            selectionDiv.innerHTML = html;
        }
    }, 100);
    
    // ÿπÿ±ÿ∂ ÿßŸÑŸÖŸàÿØÿßŸÑ ŸÖÿπ ÿ•ÿπÿ∑ÿßÿ°Ÿá z-index ÿ£ÿπŸÑŸâ ŸÑŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖÿ™ÿØÿßÿÆŸÑÿ©
    const modalElement = document.getElementById('smartRotationModal');
    modalElement.style.display = 'flex';
    modalElement.classList.add('nested-modal');
    
    // ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ≠ÿßŸÑŸä ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã (read-only for inspectors)
    setTimeout(() => {
        analyzeCurrentDistribution();
    }, 500);
    
    // Disable action buttons for inspectors
    if (!isDev && !window.isDev) {
        const actionButtons = document.querySelectorAll('#smartRotationModal button[onclick*="checkDeveloperAccess"]');
        actionButtons.forEach(btn => {
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';
            const originalText = btn.textContent;
            btn.title = 'ÿπÿ∞ÿ±ÿßŸãÿå Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÖÿÆÿµÿµ ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑ - ' + originalText;
        });
    }
}

// ÿ•ÿ∫ŸÑÿßŸÇ ŸÖŸàÿØÿßŸÑ ÿßŸÑÿ™ÿØŸàŸäÿ± ÿßŸÑÿ∞ŸÉŸä
function closeSmartRotationModal() {
    const modalElement = document.getElementById('smartRotationModal');
    modalElement.style.display = 'none';
    modalElement.classList.remove('nested-modal');
    document.getElementById('rotationPreview').style.display = 'none';
    generatedRotationPlan = [];
}

// ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ≠ÿßŸÑŸä
function analyzeCurrentDistribution() {
    console.log('analyzeCurrentDistribution called');
    const resultsDiv = document.getElementById('rotationResults');
    
    // Ensure data is available
    const inspectors = window.inspectorsData || inspectorsData || [];
    const shops = window.shopsData || shopsData || [];
    const inspections = window.inspectionData || inspectionData || [];
    
    console.log('Data availability check:', {
        inspectors: inspectors.length,
        shops: shops.length, 
        inspections: inspections.length
    });
    
    if (inspectors.length === 0) {
        resultsDiv.innerHTML = `
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; text-align: center;">
                <h4 style="color: #856404; margin-bottom: 10px;">‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</h4>
                <p style="color: #856404; margin: 0;">Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã</p>
            </div>
        `;
        return;
    }
    
    // ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ≠ÿßŸÑŸä
    const inspectorShopCount = {};
    const shopInspectorCount = {};
    
    // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿπÿØÿßÿØÿßÿ™
    inspectors.forEach(inspector => {
        const inspectorName = inspector.name || inspector;
        inspectorShopCount[inspectorName] = new Set();
    });
    
    shops.forEach(shop => {
        const shopName = shop.name || shop;
        shopInspectorCount[shopName] = new Set();
    });
    
    // ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©
    inspections.forEach(item => {
        if (!inspectorShopCount[item.inspector]) {
            inspectorShopCount[item.inspector] = new Set();
        }
        
        if (item.shops && Array.isArray(item.shops)) {
            item.shops.forEach(shop => {
                inspectorShopCount[item.inspector].add(shop);
                if (!shopInspectorCount[shop]) {
                    shopInspectorCount[shop] = new Set();
                }
                shopInspectorCount[shop].add(item.inspector);
            });
        }
    });
    
    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
    const inspectorStats = Object.keys(inspectorShopCount).map(inspector => ({
        name: inspector,
        shopsCount: inspectorShopCount[inspector].size,
        shops: Array.from(inspectorShopCount[inspector])
    })).sort((a, b) => b.shopsCount - a.shopsCount);
    
    const shopStats = Object.keys(shopInspectorCount).map(shop => ({
        name: shop,
        inspectorsCount: shopInspectorCount[shop].size,
        inspectors: Array.from(shopInspectorCount[shop])
    })).sort((a, b) => a.inspectorsCount - b.inspectorsCount);
    
    // ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ™Ÿä ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß ÿ£Ÿà ÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß ŸÖŸÜ ŸÖŸÅÿ™ÿ¥ Ÿàÿßÿ≠ÿØ ŸÅŸÇÿ∑
    const underInspectedShops = shopStats.filter(shop => shop.inspectorsCount <= 1);
    
    // ÿπÿ±ÿ∂ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ
    let analysisHtml = `
        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; border: 1px solid #dee2e6;">
            <h4 style="color: #234085; margin-bottom: 15px; text-align: center;">üìä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ≠ÿßŸÑŸä</h4>
            
            <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿπÿßŸÖÿ© -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #1976d2;">${inspectors.length}</div>
                    <div style="color: #1976d2;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</div>
                </div>
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #388e3c;">${shops.length}</div>
                    <div style="color: #388e3c;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>
                </div>
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #f57c00;">${underInspectedShops.length}</div>
                    <div style="color: #f57c00;">ŸÖÿ≠ŸÑÿßÿ™ ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ™ŸÅÿ™Ÿäÿ¥</div>
                </div>
            </div>
            
            <!-- ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ -->
            <div style="margin-bottom: 20px;">
                <h5 style="color: #234085; margin-bottom: 10px;">üìà ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿπŸÑŸâ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</h5>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; background: white;">
                    ${inspectorStats.map(stat => `
                        <div style="display: flex; justify-content: space-between; padding: 8px; margin: 4px 0; background: ${stat.shopsCount > 0 ? '#e8f5e8' : '#ffebee'}; border-radius: 4px;">
                            <span style="font-weight: bold;">${stat.name}</span>
                            <span style="color: ${stat.shopsCount > 0 ? '#2e7d32' : '#c62828'};">${stat.shopsCount} ŸÖÿ≠ŸÑ</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- ÿßŸÑÿ™ŸàÿµŸäÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ© -->
            <div style="background: #e3f2fd; border-radius: 8px; padding: 15px; border-left: 4px solid #2196f3;">
                <h5 style="color: #1976d2; margin-bottom: 10px;">üß† ÿßŸÑÿ™ŸàÿµŸäÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©</h5>
                <ul style="margin: 0; padding-right: 20px;">
                    ${underInspectedShops.length > 0 ? `<li style="margin-bottom: 8px;">ŸäŸèŸÜÿµÿ≠ ÿ®ÿ•ÿπÿ∑ÿßÿ° ÿ£ŸàŸÑŸàŸäÿ© ŸÑŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑÿ™Ÿä ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß ÿ£Ÿà ÿ™ŸÖ ÿ™ŸÅÿ™Ÿäÿ¥Ÿáÿß ŸÖŸÜ ŸÖŸÅÿ™ÿ¥ Ÿàÿßÿ≠ÿØ ŸÅŸÇÿ∑</li>` : ''}
                    <li style="margin-bottom: 8px;">ÿ™Ÿàÿ≤Ÿäÿπ ÿπÿßÿØŸÑ: ŸÉŸÑ ŸÖŸÅÿ™ÿ¥ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÅÿ™ÿ¥ ÿ≠ŸàÿßŸÑŸä ${Math.ceil(shops.length / inspectors.length)} ŸÖÿ≠ŸÑ</li>
                    <li>ÿØŸàÿ±ÿßŸÜ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ: ŸÉŸÑ ŸÖÿ≠ŸÑ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸèŸÅÿ™ÿ¥ ŸÖŸÜ ${Math.min(3, inspectors.length)} ŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÖÿÆÿ™ŸÑŸÅŸäŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ</li>
                </ul>
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML = analysisHtml;
}


// Make functions globally accessible immediately after definition
window.analyzeCurrentDistribution = analyzeCurrentDistribution;
window.populateInspectorSelection = populateInspectorSelection;

// ŸÖŸÑÿ° ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÅŸä Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±
// Make populateInspectorSelection function globally accessible
window.populateInspectorSelection = function() {
    const selectionDiv = document.getElementById('inspectorSelection');
    if (!selectionDiv) {
        console.log('Inspector selection div not found');
        return;
    }
    
    // Use multiple sources to get inspector data
    let availableInspectors = window.inspectorsData || inspectorsData || [];
    
    // Try to get from localStorage
    if (!availableInspectors || availableInspectors.length === 0) {
        try {
            const planData = JSON.parse(localStorage.getItem('allPlanData') || '{}');
            availableInspectors = planData.inspectors || [];
        } catch (e) {
            console.log('Error parsing localStorage:', e);
        }
    }
    
    // Try to extract from the inspector dropdown if still no data
    if (!availableInspectors || availableInspectors.length === 0) {
        const inspectorSelect = document.querySelector('#inspectorSelect, select[id*="inspector"], #addInspectorSelect');
        if (inspectorSelect) {
            const options = Array.from(inspectorSelect.options).filter(opt => opt.value && opt.value !== '' && !opt.textContent.includes('ÿßÿÆÿ™ÿ±'));
            availableInspectors = options.map((opt, index) => ({
                id: opt.value || `inspector_${index + 1}`,
                name: opt.textContent.trim()
            }));
        }
    }
    
    // Fallback to hardcoded list based on what we see in the dropdown
    if (!availableInspectors || availableInspectors.length === 0) {
        availableInspectors = [
            { id: 'insp_1758830974747', name: 'ÿØ. ÿ¢ŸÖŸÜŸá ÿ®ŸÜ ÿµÿ±ŸÖ' },
            { id: 'insp_1758830963007', name: 'ÿØ. ÿ¢ŸäŸá ÿ≥ŸÑÿßŸÖÿ©' },
            { id: 'insp_1758830999876', name: 'ÿØ. ÿ≠ÿ≥ŸäŸÜÿ© ÿßŸÑÿπÿßŸÖÿ±Ÿä' },
            { id: 'insp_1758830985608', name: 'ÿØ. ÿ≠ÿµÿ© ÿßŸÑÿπŸÑŸä' },
            { id: 'insp_1758813880098', name: 'ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ' },
            { id: 'insp_1758830950586', name: 'ÿØ. ŸÅÿßŸäÿ≤ ÿßŸÑŸÖÿ≥ÿßŸÑŸÖÿ©' },
            { id: 'insp_1758830925093', name: 'ÿØ. ŸÖÿ≠ŸÖÿØ ÿ•ÿ≥ŸÖÿßÿπŸäŸÑ' },
            { id: 'insp_1758830939296', name: 'ÿØ. ŸÖÿ≠ŸÖÿØ ÿ≥ÿπŸäÿØ' },
            { id: 'insp_1758831014928', name: 'ÿØ. Ÿáÿßÿ¨ÿ± ÿßŸÑÿ∫ÿßŸÅÿ±Ÿä' }
        ];
    }
    
    console.log('Populating inspector selection, availableInspectors:', availableInspectors);
    
    if (availableInspectors.length === 0) {
        selectionDiv.innerHTML = '<p style="color: #666; text-align: center;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ŸÖÿ™ÿßÿ≠ÿ©</p>';
        return;
    }
    
    let html = "";
    availableInspectors.forEach(inspector => {
        const inspectorId = inspector.id || inspector.name; // fallback to name if no id
        const inspectorName = inspector.name || inspector;
        html += `
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                <input type="checkbox" name="selectedInspectors" value="${inspectorId}" checked 
                       style="margin: 0;">
                <span style="font-size: 0.9em;">${inspectorName}</span>
            </label>
        `;
    });
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ
    html += `
        <div style="margin-top: 10px; display: flex; gap: 8px; justify-content: center;">
            <button type="button" onclick="selectAllInspectors()" 
                    style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">
                ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ
            </button>
            <button type="button" onclick="deselectAllInspectors()" 
                    style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">
                ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ≠ÿØŸäÿØ
            </button>
        </div>
    `;
    
    console.log('Setting inspector selection HTML:', html);
    selectionDiv.innerHTML = html;
};
// Make it available without window prefix too
populateInspectorSelection = window.populateInspectorSelection;

// Make additional functions globally accessible
window.generateSmartRotation = generateSmartRotation;
window.previewRotation = previewRotation;

// ÿ™ÿ≠ÿØŸäÿØ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ - Make globally accessible
window.selectAllInspectors = function() {
    const checkboxes = document.querySelectorAll('input[name="selectedInspectors"]');
    checkboxes.forEach(cb => cb.checked = true);
};

// ÿ•ŸÑÿ∫ÿßÿ° ÿ™ÿ≠ÿØŸäÿØ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ - Make globally accessible
window.deselectAllInspectors = function() {
    const checkboxes = document.querySelectorAll('input[name="selectedInspectors"]');
    checkboxes.forEach(cb => cb.checked = false);
};

// ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ŸÜŸàÿπ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ - Make globally accessible
window.updateAreasBasedOnType = function() {
    const inspectionType = document.getElementById('inspectionType').value;
    // ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑÿØÿßÿÆŸÑŸäÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ™ÿ∑ŸÑÿ®ÿßÿ™
    const internalAreas = [
        'ÿ≥ŸàŸÇ ÿßŸÑÿ™ÿ±ÿßÿ´', 'ÿ≥ŸàŸÇ ÿßŸÑŸÖŸäŸÜÿßÿ°', 'ÿßŸÑÿØÿßŸÜÿ©', 'ÿ¢ŸÑ ŸÜŸáŸäÿßŸÜ', 
        'ÿßŸÑÿ≠ÿµŸÜ', 'ÿßŸÑÿ≤ÿßŸáŸäÿ©', 'ÿßŸÑŸÖÿ¥ÿ±ŸÅ', 'ÿßŸÑÿÆÿßŸÑÿØŸäÿ©', 'ÿßŸÑÿ®ÿ∑ŸäŸÜ'
    ];
    
    window.selectedAreasFilter = inspectionType;
    window.internalAreasFilter = internalAreas;
};

// ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ÿßŸÑŸÖÿ≠ÿØÿØŸäŸÜ - Make globally accessible
window.getSelectedInspectors = function() {
    const checkboxes = document.querySelectorAll('input[name="selectedInspectors"]:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    return inspectorsData.filter(inspector => selectedIds.includes(inspector.id));
};

// ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ - Make globally accessible
window.getFilteredAreas = function() {
    const inspectionType = document.getElementById('inspectionType').value;
    const internalAreas = [
        'ÿ≥ŸàŸÇ ÿßŸÑÿ™ÿ±ÿßÿ´', 'ÿ≥ŸàŸÇ ÿßŸÑŸÖŸäŸÜÿßÿ°', 'ÿßŸÑÿØÿßŸÜÿ©', 'ÿ¢ŸÑ ŸÜŸáŸäÿßŸÜ', 
        'ÿßŸÑÿ≠ÿµŸÜ', 'ÿßŸÑÿ≤ÿßŸáŸäÿ©', 'ÿßŸÑŸÖÿ¥ÿ±ŸÅ', 'ÿßŸÑÿÆÿßŸÑÿØŸäÿ©', 'ÿßŸÑÿ®ÿ∑ŸäŸÜ'
    ];
    
    switch(inspectionType) {
        case 'internal':
            return areasData.filter(area => internalAreas.includes(area.name));
        case 'external':
            return areasData.filter(area => !internalAreas.includes(area.name));
        default:
            return areasData;
    }
};
// ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ÿØŸàŸäÿ± ÿßŸÑÿ∞ŸÉŸä (ŸÖÿ≠ÿ≥ŸÜ)
function generateSmartRotation() {
    console.log('generateSmartRotation called');
    const period = document.getElementById('rotationPeriod').value;
    const startDate = new Date(document.getElementById('rotationStartDate').value);
    const shopsPerInspector = parseInt(document.getElementById('shopsPerInspector').value);
    const distributionStrategy = document.getElementById('distributionStrategy').value;
    
    if (!startDate || isNaN(startDate.getTime())) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿØ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ©');
        return;
    }
    
    // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ÿßŸÑŸÖÿ≠ÿØÿØŸäŸÜ
    const selectedInspectors = distributionStrategy === 'custom_inspectors' ? getSelectedInspectors() : inspectorsData;
    
    if (selectedInspectors.length === 0) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿØ ŸÖŸÅÿ™ÿ¥ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
        return;
    }
    
    // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿßŸÑŸÖŸÅŸÑÿ™ÿ±ÿ©
    const filteredAreas = getFilteredAreas();
    const availableShops = shopsData.filter(shop => {
        const area = areasData.find(a => a.id === shop.areaId);
        return area && filteredAreas.some(fa => fa.id === area.id);
    });
    
    if (availableShops.length === 0) {
        alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿπÿßŸäŸäÿ± ÿßŸÑŸÖÿ≠ÿØÿØÿ©');
        return;
    }
    
    // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ ÿ≠ÿ≥ÿ® ÿßŸÑŸÅÿ™ÿ±ÿ©
    let days = 7;
    switch(period) {
        case 'day': days = 1; break;
        case 'week': days = 7; break;
        case '2weeks': days = 14; break;
        case 'month': days = 30; break;
        case 'quarter': days = 90; break;
    }
    
    // ÿ™ŸàŸÑŸäÿØ ÿÆÿ∑ÿ© ŸÖÿ≠ÿ≥ŸÜÿ©
    generatedRotationPlan = [];
    let shopIndex = 0;
    
    // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÅÿπŸÑŸäÿ© ŸÑŸÑÿ™Ÿàÿ≤Ÿäÿπ
    const actualDays = period === 'day' ? 1 : Math.ceil(days / 2); // ŸÉŸÑ ŸäŸàŸÖŸäŸÜ ÿ•ŸÑÿß ŸÅŸä ÿ≠ÿßŸÑÿ© ŸäŸàŸÖ Ÿàÿßÿ≠ÿØ
    
    for (let dayOffset = 0; dayOffset < actualDays; dayOffset++) {
        const currentDate = new Date(startDate);
        
        if (period === 'day') {
            // ŸäŸàŸÖ Ÿàÿßÿ≠ÿØ ŸÅŸÇÿ∑
            currentDate.setDate(startDate.getDate());
        } else {
            // ÿ£ŸäÿßŸÖ ŸÖÿ™ÿπÿØÿØÿ©
            currentDate.setDate(startDate.getDate() + (dayOffset * 2));
        }
        
        const dateStr = currentDate.toISOString().split('T')[0];
        
        // ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ ÿ≠ÿ≥ÿ® ÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ™Ÿäÿ¨Ÿäÿ©
        selectedInspectors.forEach((inspector, index) => {
            if (shopIndex >= availableShops.length) shopIndex = 0; // ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ®ÿØÿ°
            
            const assignedShops = [];
            for (let i = 0; i < shopsPerInspector && shopIndex < availableShops.length; i++) {
                assignedShops.push(availableShops[shopIndex].name);
                shopIndex++;
            }
            
            if (assignedShops.length > 0) {
                // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ¥ŸäŸàÿπÿßŸã
                const areas = assignedShops.map(shopName => {
                    const shop = availableShops.find(s => s.name === shopName);
                    const area = shop ? areasData.find(a => a.id === shop.areaId) : null;
                    return area ? area.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                });
                const mainArea = areas[0] || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                
                // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ™Ÿäÿ¨Ÿäÿ©
                let shift = 'ÿµÿ®ÿßÿ≠Ÿäÿ©';
                switch(distributionStrategy) {
                    case 'balanced':
                        shift = (index % 2 === 0) ? 'ÿµÿ®ÿßÿ≠Ÿäÿ©' : 'ŸÖÿ≥ÿßÿ¶Ÿäÿ©';
                        break;
                    case 'area_focused':
                        shift = areas.includes('ÿ≥ŸàŸÇ ÿßŸÑŸÖŸäŸÜÿßÿ°') || areas.includes('ÿ≥ŸàŸÇ ÿßŸÑÿ™ÿ±ÿßÿ´') ? 'ÿµÿ®ÿßÿ≠Ÿäÿ©' : 'ŸÖÿ≥ÿßÿ¶Ÿäÿ©';
                        break;
                    case 'random_fair':
                        shift = Math.random() > 0.5 ? 'ÿµÿ®ÿßÿ≠Ÿäÿ©' : 'ŸÖÿ≥ÿßÿ¶Ÿäÿ©';
                        break;
                    case 'experience_based':
                    case 'custom_inspectors':
                        shift = (index % 2 === 0) ? 'ÿµÿ®ÿßÿ≠Ÿäÿ©' : 'ŸÖÿ≥ÿßÿ¶Ÿäÿ©';
                        break;
                }
                
                generatedRotationPlan.push({
                    inspector: inspector.name,
                    day: dateStr,
                    shift: shift,
                    area: mainArea,
                    shops: assignedShops
                });
            }
        });
        
        // ŸÅŸä ÿ≠ÿßŸÑÿ© ŸäŸàŸÖ Ÿàÿßÿ≠ÿØÿå ŸÜÿ™ŸàŸÇŸÅ ÿ®ÿπÿØ ÿßŸÑÿØŸàÿ±ÿ© ÿßŸÑÿ£ŸàŸÑŸâ
        if (period === 'day') break;
    }
    
    if (generatedRotationPlan.length === 0) {
        alert('ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿÆÿ∑ÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
        return;
    }
    
    // ÿπÿ±ÿ∂ ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿÆÿ∑ÿ©
    displayRotationPreview();
    
    const inspectionTypeText = document.getElementById('inspectionType').value === 'internal' ? 'ÿØÿßÿÆŸÑŸä' : 
                              document.getElementById('inspectionType').value === 'external' ? 'ÿÆÿßÿ±ÿ¨Ÿä' : 'ÿ¥ÿßŸÖŸÑ';
    
    alert(`ÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ ${generatedRotationPlan.length} ÿ™ŸÅÿ™Ÿäÿ¥ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nŸÜŸàÿπ ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥: ${inspectionTypeText}\nÿπÿØÿØ ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ: ${selectedInspectors.length}\nÿπÿØÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©: ${availableShops.length}`);
}

// ÿπÿ±ÿ∂ ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿÆÿ∑ÿ© ÿßŸÑŸÖŸàŸÑÿØÿ©
function displayRotationPreview() {
    const previewDiv = document.getElementById('rotationPreview');
    const contentDiv = document.getElementById('rotationPreviewContent');
    
    if (!generatedRotationPlan || generatedRotationPlan.length === 0) {
        previewDiv.style.display = 'none';
        return;
    }
    
    let previewHtml = `
        <div style="margin-bottom: 15px;">
            <h5 style="color: #234085;">üìÖ ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿÆÿ∑ÿ©: ${generatedRotationPlan.length} ÿ™ŸÅÿ™Ÿäÿ¥</h5>
        </div>
        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
            <thead>
                <tr style="background: #f1f3f4;">
                    <th style="border: 1px solid #ddd; padding: 8px;">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">ÿßŸÑŸÖŸÅÿ™ÿ¥</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    generatedRotationPlan.forEach((item, index) => {
        const formattedDate = new Date(item.day).toLocaleDateString('en-GB');
        previewHtml += `
            <tr style="background: ${index % 2 === 0 ? '#f9f9f9' : 'white'};">
                <td style="border: 1px solid #ddd; padding: 8px;">${formattedDate}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${item.inspector}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                    <span style="display:inline-block;padding: 3px 8px; border-radius: 12px; font-size: 0.8em; ${item.shift === 'ÿµÿ®ÿßÿ≠Ÿäÿ©' ? 'background: #e8f5e8; color: #2e7d32;' : 'background: #fff3e0; color: #f57c00;'}">${item.shift}</span>
                </td>
                <td style="border: 1px solid #ddd; padding: 8px; color:${getAreaName(item.area) === 'ÿ≥ŸàŸÇ ÿßŸÑŸÖŸäŸÜÿßÿ°' || getAreaName(item.area) === 'ÿ≥ŸàŸÇ ÿßŸÑÿ™ÿ±ÿßÿ´' ? '#1976d2' : '#d32f2f'};">${getAreaName(item.area)}</td>
                <td style="border: 1px solid #ddd; padding: 8px; font-size: 0.85em;">${item.shops.join(', ')}</td>
            </tr>
        `;
    });
    
    previewHtml += `
            </tbody>
        </table>
    `;
    
    contentDiv.innerHTML = previewHtml;
    previewDiv.style.display = 'block';
}

// ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿÆÿ∑ÿ©
function previewRotation() {
    console.log('previewRotation called');
    if (!generatedRotationPlan || generatedRotationPlan.length === 0) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿÆÿ∑ÿ© ÿ£ŸàŸÑÿßŸã');
        return;
    }
    displayRotationPreview();
    document.getElementById('rotationPreview').scrollIntoView({ behavior: 'smooth' });
}

// ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿÆÿ∑ÿ© ÿßŸÑŸÖŸàŸÑÿØÿ©
function applyGeneratedRotation() {
    if (!generatedRotationPlan || generatedRotationPlan.length === 0) {
        alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿÆÿ∑ÿ© ŸÖŸàŸÑÿØÿ© ŸÑŸÑÿ™ÿ∑ÿ®ŸäŸÇ');
        return;
    }
    
    if (!confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿÆÿ∑ÿ© ÿßŸÑŸÖŸàŸÑÿØÿ©ÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${generatedRotationPlan.length} ÿ™ŸÅÿ™Ÿäÿ¥ ÿ¨ÿØŸäÿØ ÿ•ŸÑŸâ ÿßŸÑŸÜÿ∏ÿßŸÖ.`)) {
        return;
    }
    
    // Create a temporary copy of inspectionData with the new plan to validate
    const tempInspectionData = [...inspectionData, ...generatedRotationPlan];
    
    // Get unique days from the generated plan
    const daysInGeneratedPlan = [...new Set(generatedRotationPlan.map(item => item.day))];
    
    // Validate for duplicate shops on the same day
    // Only check for duplicates on the days being added in the generated plan
    const validation = validateShopDuplicates(tempInspectionData, daysInGeneratedPlan);
    
    if (!validation.isValid) {
        // Show detailed error message with duplicate information
        showDuplicateShopsError(validation.duplicates);
        alert('‚ùå ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿÆÿ∑ÿ© ÿ®ÿ≥ÿ®ÿ® Ÿàÿ¨ŸàÿØ ÿ™ŸÉÿ±ÿßÿ±ÿßÿ™!\nŸäÿ±ÿ¨Ÿâ ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿÆÿ∑ÿ© ÿ£Ÿà ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ™ÿπÿßÿ±ÿ∂ÿ©.');
        return; // Prevent applying the plan
    }
    
    // If validation passed, apply the plan
    generatedRotationPlan.forEach(item => {
        inspectionData.push(item);
    });
    
    // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    saveInspectionData();
    renderPlanTable();
    
    // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖŸàÿØÿßŸÑ
    closeSmartRotationModal();
    
    alert(`ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿÆÿ∑ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!\n\nÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${generatedRotationPlan.length} ÿ™ŸÅÿ™Ÿäÿ¥ ÿ¨ÿØŸäÿØ.`);
    
    // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™
    generatedRotationPlan = [];
}

// ÿ™ÿµÿØŸäÿ± ÿÆÿ∑ÿ© ÿßŸÑÿ™ÿØŸàŸäÿ±
function exportRotationPlan() {
    if (!generatedRotationPlan || generatedRotationPlan.length === 0) {
        alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿÆÿ∑ÿ© ŸÖŸàŸÑÿØÿ© ŸÑŸÑÿ™ÿµÿØŸäÿ±');
        return;
    }
    
    const exportData = {
        generatedAt: new Date().toISOString(),
        plan: generatedRotationPlan,
        statistics: {
            totalInspections: generatedRotationPlan.length,
            uniqueShops: new Set(generatedRotationPlan.flatMap(item => item.shops)).size,
            uniqueInspectors: new Set(generatedRotationPlan.map(item => item.inspector)).size
        }
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `ÿÆÿ∑ÿ©_ÿßŸÑÿ™ÿØŸàŸäÿ±_ÿßŸÑÿ∞ŸÉŸä_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿÆÿ∑ÿ© ÿßŸÑÿ™ÿØŸàŸäÿ± ÿ®ŸÜÿ¨ÿßÿ≠!');
}
</script>

<script>
// ===== Ÿàÿ∏ÿßÿ¶ŸÅ ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ =====
let currentPreviewFile = null;
let currentPdfDocument = null;
let currentPageNumber = 1;
let totalPages = 1;

function showFilePreviewModal() {
    const modalElement = document.getElementById('filePreviewModal');
    modalElement.style.display = 'flex';
    modalElement.classList.add('nested-modal');
}

function closeFilePreviewModal() {
    const modalElement = document.getElementById('filePreviewModal');
    modalElement.style.display = 'none';
    modalElement.classList.remove('nested-modal');
    clearPreview();
}

async function handlePreviewFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ (ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 10 MB)
    const maxSize = 10 * 1024 * 1024; // 10 MB
    if (file.size > maxSize) {
        alert('ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã! Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ£ŸÇŸÑ ŸÖŸÜ 10 MB');
        event.target.value = '';
        return;
    }
    
    const fileName = file.name;
    const fileExtension = fileName.split('.').pop().toLowerCase();
    const supportedFormats = ['pdf', 'xlsx', 'xls', 'csv'];
    
    if (!supportedFormats.includes(fileExtension)) {
        alert('ŸÜŸàÿπ ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ! ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿØÿπŸàŸÖÿ©: PDF, Excel (.xlsx, .xls), CSV');
        event.target.value = '';
        return;
    }
    
    currentPreviewFile = file;
    
    // ÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÑŸÅ
    displayPreviewFileInfo(fileName, file.size, fileExtension);
    
    // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ ÿ≠ÿ≥ÿ® ŸÜŸàÿπŸá
    try {
        if (fileExtension === 'pdf') {
            await previewPDFFile(file);
        } else if (['xlsx', 'xls'].includes(fileExtension)) {
            await previewExcelFile(file);
        } else if (fileExtension === 'csv') {
            await previewCSVFile(file);
        }
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÖŸÑŸÅ:', error);
        showPreviewError('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÖŸÑŸÅ: ' + error.message);
    }
    
    // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ input ÿßŸÑŸÖŸÑŸÅ
    event.target.value = '';
}

function displayPreviewFileInfo(fileName, fileSize, fileExtension) {
    const fileSizeMB = (fileSize / (1024 * 1024)).toFixed(2);
    const fileInfo = document.getElementById('previewFileInfo');
    const fileDetails = document.getElementById('previewFileDetails');
    
    let fileIcon = 'üìÑ';
    if (fileExtension === 'pdf') fileIcon = 'üìï';
    else if (['xlsx', 'xls'].includes(fileExtension)) fileIcon = 'üìä';
    else if (fileExtension === 'csv') fileIcon = 'üìã';
    
    fileDetails.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
            <span style="font-size: 1.5em;">${fileIcon}</span>
            <div>
                <strong>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ:</strong> ${fileName}<br>
                <strong>ÿßŸÑÿ≠ÿ¨ŸÖ:</strong> ${fileSizeMB} MB<br>
                <strong>ÿßŸÑŸÜŸàÿπ:</strong> ${fileExtension.toUpperCase()}
            </div>
        </div>
    `;
    
    fileInfo.style.display = 'block';
    document.getElementById('downloadPreviewBtn').style.display = 'inline-block';
}

async function previewPDFFile(file) {
    try {
        const arrayBuffer = await file.arrayBuffer();
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        currentPdfDocument = pdf;
        totalPages = pdf.numPages;
        currentPageNumber = 1;
        
        await renderPDFPage(currentPageNumber);
        showPreviewControls(true);
        
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸäŸÜÿ© PDF:', error);
        showPreviewError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ PDF');
    }
}

async function renderPDFPage(pageNumber) {
    if (!currentPdfDocument) return;
    
    try {
        const page = await currentPdfDocument.getPage(pageNumber);
        const scale = 1.2;
        const viewport = page.getViewport({scale});
        
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        await page.render({
            canvasContext: context,
            viewport: viewport
        }).promise;
        
        const previewContent = document.getElementById('previewContent');
        previewContent.innerHTML = '';
        previewContent.appendChild(canvas);
        previewContent.style.textAlign = 'center';
        previewContent.style.padding = '20px';
        
        updatePageInfo();
        
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© PDF:', error);
        showPreviewError('ÿÆÿ∑ÿ£ ŸÅŸä ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© PDF');
    }
}

async function previewExcelFile(file) {
    try {
        const data = new Uint8Array(await file.arrayBuffer());
        const workbook = XLSX.read(data, {type: 'array'});
        
        let tableHTML = '<div style="padding: 20px;">';
        
        // ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£Ÿàÿ±ÿßŸÇ
        workbook.SheetNames.forEach((sheetName, index) => {
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            
            if (jsonData.length > 0) {
                tableHTML += `<h3 style="color: #234085; margin: ${index > 0 ? '30px' : '0'} 0 15px 0;">üìä Ÿàÿ±ŸÇÿ©: ${sheetName}</h3>`;
                tableHTML += '<div style="overflow-x: auto; margin-bottom: 20px;">';
                tableHTML += '<table style="border-collapse: collapse; width: 100%; min-width: 600px; background: #fff; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">';
                
                jsonData.forEach((row, rowIndex) => {
                    tableHTML += '<tr>';
                    row.forEach((cell, cellIndex) => {
                        const isHeader = rowIndex === 0;
                        const bgColor = isHeader ? '#f8f9fa' : (rowIndex % 2 === 0 ? '#fff' : '#f8f9fa');
                        const fontWeight = isHeader ? 'bold' : 'normal';
                        const color = isHeader ? '#234085' : '#333';
                        
                        tableHTML += `<td style="border: 1px solid #dee2e6; padding: 12px 15px; text-align: center; background: ${bgColor}; font-weight: ${fontWeight}; color: ${color};">
                            ${cell !== null && cell !== undefined ? String(cell) : ''}
                        </td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</table>';
                tableHTML += '</div>';
            }
        });
        
        tableHTML += '</div>';
        
        document.getElementById('previewContent').innerHTML = tableHTML;
        showPreviewControls(false);
        
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸäŸÜÿ© Excel:', error);
        showPreviewError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ Excel');
    }
}

async function previewCSVFile(file) {
    try {
        const text = await file.text();
        const lines = text.split('\n').filter(line => line.trim() !== '');
        
        if (lines.length === 0) {
            showPreviewError('ÿßŸÑŸÖŸÑŸÅ ŸÅÿßÿ±ÿ∫');
            return;
        }
        
        let tableHTML = '<div style="padding: 20px;">';
        tableHTML += '<h3 style="color: #234085; margin: 0 0 15px 0;">üìã ŸÖÿ≠ÿ™ŸàŸâ ŸÖŸÑŸÅ CSV</h3>';
        tableHTML += '<div style="overflow-x: auto;">';
        tableHTML += '<table style="border-collapse: collapse; width: 100%; min-width: 600px; background: #fff; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">';
        
        lines.forEach((line, lineIndex) => {
            const cells = line.split(',');
            tableHTML += '<tr>';
            
            cells.forEach(cell => {
                const isHeader = lineIndex === 0;
                const bgColor = isHeader ? '#f8f9fa' : (lineIndex % 2 === 0 ? '#fff' : '#f8f9fa');
                const fontWeight = isHeader ? 'bold' : 'normal';
                const color = isHeader ? '#234085' : '#333';
                
                tableHTML += `<td style="border: 1px solid #dee2e6; padding: 12px 15px; text-align: center; background: ${bgColor}; font-weight: ${fontWeight}; color: ${color};">
                    ${cell.trim()}
                </td>`;
            });
            
            tableHTML += '</tr>';
        });
        
        tableHTML += '</table>';
        tableHTML += '</div>';
        tableHTML += '</div>';
        
        document.getElementById('previewContent').innerHTML = tableHTML;
        showPreviewControls(false);
        
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸäŸÜÿ© CSV:', error);
        showPreviewError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ CSV');
    }
}

function showPreviewError(message) {
    document.getElementById('previewContent').innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 400px; color: #dc3545; flex-direction: column;">
            <span style="font-size: 4em; margin-bottom: 20px;">‚ö†Ô∏è</span>
            <p style="font-size: 1.2em; margin: 0; font-weight: bold;">${message}</p>
            <p style="font-size: 0.9em; margin-top: 10px; color: #6c757d;">Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿπ ŸÖŸÑŸÅ ÿ¢ÿÆÿ±</p>
        </div>
    `;
    showPreviewControls(false);
}

function showPreviewControls(show) {
    document.getElementById('previewControls').style.display = show ? 'flex' : 'none';
}

function changePage(direction) {
    if (!currentPdfDocument) return;
    
    const newPageNumber = currentPageNumber + direction;
    if (newPageNumber < 1 || newPageNumber > totalPages) return;
    
    currentPageNumber = newPageNumber;
    renderPDFPage(currentPageNumber);
}

function updatePageInfo() {
    document.getElementById('pageInfo').textContent = `ÿµŸÅÿ≠ÿ© ${currentPageNumber} ŸÖŸÜ ${totalPages}`;
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
    document.getElementById('prevPageBtn').disabled = currentPageNumber <= 1;
    document.getElementById('nextPageBtn').disabled = currentPageNumber >= totalPages;
}

function downloadCurrentFile() {
    if (!currentPreviewFile) return;
    
    const url = URL.createObjectURL(currentPreviewFile);
    const a = document.createElement('a');
    a.href = url;
    a.download = currentPreviewFile.name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function printPreviewContent() {
    const previewContent = document.getElementById('previewContent');
    if (!previewContent.innerHTML.trim()) {
        alert('ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≠ÿ™ŸàŸâ ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©');
        return;
    }
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÖÿπÿßŸäŸÜÿ©</title>
            <style>
                body { font-family: Arial, sans-serif; direction: rtl; text-align: right; }
                table { border-collapse: collapse; width: 100%; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                th { background-color: #f2f2f2; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            ${previewContent.innerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function clearPreview() {
    currentPreviewFile = null;
    currentPdfDocument = null;
    currentPageNumber = 1;
    totalPages = 1;
    
    document.getElementById('previewFileInfo').style.display = 'none';
    document.getElementById('downloadPreviewBtn').style.display = 'none';
    document.getElementById('previewContent').innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 400px; color: #6c757d; flex-direction: column;">
            <span style="font-size: 4em; margin-bottom: 20px;">üìã</span>
            <p style="font-size: 1.2em; margin: 0;">ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ ŸÑÿ®ÿØÿ° ÿßŸÑŸÖÿπÿßŸäŸÜÿ©</p>
            <p style="font-size: 0.9em; margin-top: 10px; color: #adb5bd;">ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÖŸÑŸÅ ŸáŸÜÿß</p>
        </div>
    `;
    showPreviewControls(false);
}

// ===== Ÿàÿ∏ÿßÿ¶ŸÅ ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿπÿßŸÖÿ© =====

// ŸÖÿ™ÿ∫Ÿäÿ± ŸÑÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ≠ÿßŸÑŸä ŸÑŸÑŸÖŸÑŸÅÿßÿ™
let currentFilesCategory = 'all';

// ÿØÿßŸÑÿ© ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ≠ÿßŸÑŸä
function getCurrentFileCategory() {
    return currentFilesCategory;
}

async function loadPublicFiles(category = 'all') {
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ±
    if (!isDev && !window.isDev) {
        const listDiv = document.getElementById('publicFilesList');
        if (listDiv) {
            listDiv.innerHTML = `
                <div style="text-align: center; color: #dc3545; padding: 40px 0;">
                    <div style="font-size: 3em; margin-bottom: 15px;">üîí</div>
                    <p style="font-size: 1.2em; margin: 0; font-weight: bold;">ÿßŸÑŸàÿµŸàŸÑ ŸÖÿ≠ÿ∏Ÿàÿ±</p>
                    <p style="font-size: 0.9em; margin-top: 10px; color: #666;">Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑŸÖÿ∑Ÿàÿ± ŸÅŸÇÿ∑</p>
                </div>
            `;
        }
        return;
    }
    
    // ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ≠ÿßŸÑŸä
    currentFilesCategory = category;
    const statusDiv = document.getElementById('filesLoadingStatus');
    const listDiv = document.getElementById('publicFilesList');
    
    try {
        statusDiv.textContent = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™...';
        statusDiv.style.color = '#666';
        
        let filesData;
        
        // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ files.json ŸÖÿ≠ŸÑŸäÿßŸã ÿ£ŸàŸÑÿßŸã ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±
        try {
            const localResponse = await fetch('./files.json?t=' + Date.now(), {
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache'
                }
            });
            if (localResponse.ok) {
                filesData = await localResponse.json();
                console.log('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã');
            } else {
                throw new Error('Local file not found');
            }
        } catch (localError) {
            // ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑŸäÿå ŸÖÿ≠ÿßŸàŸÑÿ© ŸÖŸÜ GitHub
            const response = await fetch('https://raw.githubusercontent.com/aliabdelaal-adm/Monthly_inspection_plan/main/files.json');
            
            if (!response.ok) {
                throw new Error('ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÖŸÑŸÅ ÿßŸÑŸÅŸáÿ±ÿ≥');
            }
            
            filesData = await response.json();
            console.log('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÖŸÜ GitHub');
        }
        
        displayPublicFiles(filesData.files, category);
        statusDiv.textContent = '‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠';
        statusDiv.style.color = '#28a745';
        
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™:', error);
        statusDiv.textContent = '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ - Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã';
        statusDiv.style.color = '#dc3545';
        
        // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿπÿØŸÖ ÿ™ŸàŸÅÿ± ÿßŸÑŸÖŸÑŸÅÿßÿ™
        listDiv.innerHTML = `
            <div style="text-align: center; color: #666; padding: 40px 0;">
                <div style="font-size: 3em; margin-bottom: 15px;">‚ö†Ô∏è</div>
                <p style="font-size: 1.1em; margin: 0;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑŸÅÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ÿ≠ÿßŸÑŸäÿßŸã</p>
                <p style="font-size: 0.9em; margin-top: 10px; color: #999;">ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿØÿßÿ±ÿ©</p>
            </div>
        `;
    }
}

function displayPublicFiles(files, category) {
    const container = document.getElementById('publicFilesList');
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
    updateFilesCategoryButtons(category);
    
    if (!files || files.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; color: #666; padding: 40px 0;">
                <div style="font-size: 3em; margin-bottom: 15px;">üìÅ</div>
                <p style="font-size: 1.1em; margin: 0;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑŸÅÿßÿ™ ŸÖÿ±ŸÅŸàÿπÿ©</p>
            </div>
        `;
        return;
    }
    
    // ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ±ÿ¶Ÿäÿ©
    let visibleFiles = files.filter(f => f.visible !== false && f.category !== 'system');
    
    // ÿ™ÿ∑ÿ®ŸäŸÇ ŸÅŸÑÿ™ÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ
    if (category !== 'all') {
        visibleFiles = visibleFiles.filter(f => f.category === category);
    }
    
    if (visibleFiles.length === 0) {
        const categoryNames = {
            documents: 'ÿßŸÑŸàÿ´ÿßÿ¶ŸÇ',
            reports: 'ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±',
            schedules: 'ÿßŸÑÿ¨ÿØÿßŸàŸÑ', 
            resources: 'ÿßŸÑŸÖŸàÿßÿ±ÿØ'
        };
        
        container.innerHTML = `
            <div style="text-align: center; color: #666; padding: 40px 0;">
                <div style="font-size: 3em; margin-bottom: 15px;">üìÇ</div>
                <p style="font-size: 1.1em; margin: 0;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑŸÅÿßÿ™ ŸÅŸä ŸÇÿ≥ŸÖ ${categoryNames[category] || 'Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ'}</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    const categories = {
        documents: { name: 'ÿßŸÑŸàÿ´ÿßÿ¶ŸÇ', icon: 'üìÑ', color: '#17a2b8' },
        reports: { name: 'ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±', icon: 'üìä', color: '#28a745' }, 
        schedules: { name: 'ÿßŸÑÿ¨ÿØÿßŸàŸÑ', icon: 'üìÖ', color: '#ffc107' },
        resources: { name: 'ÿßŸÑŸÖŸàÿßÿ±ÿØ', icon: 'üìö', color: '#6f42c1' }
    };
    
    // ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿπÿ±ÿ∂ ÿ¥ÿßŸÖŸÑ
    if (category === 'all') {
        const filesByCategory = {};
        visibleFiles.forEach(file => {
            if (!filesByCategory[file.category]) {
                filesByCategory[file.category] = [];
            }
            filesByCategory[file.category].push(file);
        });
        
        // ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿµŸÜŸäŸÅ
        Object.keys(filesByCategory).forEach(cat => {
            const catInfo = categories[cat] || { name: cat, icon: 'üìÅ', color: '#6c757d' };
            html += `
                <div style="margin-bottom: 25px;">
                    <h4 style="color: ${catInfo.color}; margin-bottom: 12px; padding: 8px 0; border-bottom: 2px solid ${catInfo.color};">
                        ${catInfo.icon} ${catInfo.name}
                    </h4>
                    <div style="display: grid; gap: 12px;">
            `;
            
            filesByCategory[cat].forEach(file => {
                html += generateFileCard(file);
            });
            
            html += `</div></div>`;
        });
    } else {
        // ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÅŸä ÿ™ÿµŸÜŸäŸÅ Ÿàÿßÿ≠ÿØ
        html += '<div style="display: grid; gap: 12px;">';
        visibleFiles.forEach(file => {
            html += generateFileCard(file);
        });
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function escapeForAttribute(str) {
    if (!str) return '';
    return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
}

function generateFileCard(file) {
    const fileSize = formatPublicFileSize(file.size);
    const uploadDate = new Date(file.uploadDate).toLocaleDateString('ar-EG');
    const fileIcon = getFileIcon(file.type);
    const isDeveloper = isDev || window.isDev;
    
    // ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÖÿ∑Ÿàÿ± - ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± ŸàÿßŸÑÿ≠ÿ∞ŸÅ
    const developerButtons = isDeveloper ? `
        <button onclick="editFileFromMain('${file.id}', '${escapeForAttribute(file.name)}', '${escapeForAttribute(file.description)}', '${file.category}')" style="background: #ffc107; color: #333; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; white-space: nowrap;">
            ‚úèÔ∏è ÿ™ÿ≠ÿ±Ÿäÿ±
        </button>
        <button onclick="deleteFileFromMain('${file.id}', '${escapeForAttribute(file.path)}', '${escapeForAttribute(file.name)}', '${file.category}')" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; white-space: nowrap;">
            üóëÔ∏è ÿ≠ÿ∞ŸÅ
        </button>
    ` : '';
    
    return `
        <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <span style="font-size: 1.5em;">${fileIcon}</span>
                        <strong style="color: #2336a0; font-size: 1.1em;">${file.name}</strong>
                    </div>
                    <p style="margin: 5px 0; color: #555; line-height: 1.4;">${file.description}</p>
                    <div style="display: flex; gap: 15px; margin-top: 10px;">
                        <small style="color: #999;">üìè ${fileSize}</small>
                        <small style="color: #999;">üìÖ ${uploadDate}</small>
                        <small style="color: #999;">üë§ ${file.uploader || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</small>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button onclick="downloadPublicFile('${file.path}', '${file.name}')" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; white-space: nowrap;">
                        üì• ÿ™ÿ≠ŸÖŸäŸÑ
                    </button>
                    ${canPreviewFile(file.type) ? `
                        <button onclick="previewPublicFile('${file.path}', '${file.name}', '${file.type}')" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; white-space: nowrap;">
                            üëÅÔ∏è ŸÖÿπÿßŸäŸÜÿ©
                        </button>
                    ` : ''}
                    ${developerButtons}
                </div>
            </div>
        </div>
    `;
}

function getFileIcon(fileType) {
    const icons = {
        pdf: 'üìÑ',
        doc: 'üìù', docx: 'üìù',
        xls: 'üìä', xlsx: 'üìä',
        ppt: 'üìΩÔ∏è', pptx: 'üìΩÔ∏è',
        csv: 'üìã',
        txt: 'üìù',
        jpg: 'üñºÔ∏è', jpeg: 'üñºÔ∏è', png: 'üñºÔ∏è', gif: 'üñºÔ∏è',
        zip: 'üì¶', rar: 'üì¶',
        mp4: 'üé¨', avi: 'üé¨',
        mp3: 'üéµ', wav: 'üéµ'
    };
    return icons[fileType.toLowerCase()] || 'üìÅ';
}

function canPreviewFile(fileType) {
    const previewableTypes = ['pdf', 'jpg', 'jpeg', 'png', 'gif', 'txt', 'csv'];
    return previewableTypes.includes(fileType.toLowerCase());
}

function formatPublicFileSize(bytes) {
    if (bytes === 0) return '0 ÿ®ÿßŸäÿ™';
    const k = 1024;
    const sizes = ['ÿ®ÿßŸäÿ™', 'ŸÉŸäŸÑŸàÿ®ÿßŸäÿ™', 'ŸÖŸäÿ¨ÿßÿ®ÿßŸäÿ™', 'ÿ¨Ÿäÿ¨ÿßÿ®ÿßŸäÿ™'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ===== Ÿàÿ∏ÿßÿ¶ŸÅ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÑŸÑŸÖÿ∑Ÿàÿ± =====

async function uploadFileFromMain() {
    if (!isDev && !window.isDev) {
        alert('‚ùå ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÖÿ∑ŸÑŸàÿ®ÿ© ŸÑÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™');
        return;
    }
    
    const fileInput = document.getElementById('mainFileUpload');
    const categorySelect = document.getElementById('mainFileCategory');
    const descriptionInput = document.getElementById('mainFileDescription');
    const statusDiv = document.getElementById('mainFileUploadStatus');
    const uploadBtn = document.getElementById('mainUploadBtn');
    
    if (!fileInput.files[0]) {
        statusDiv.textContent = '‚ùå Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿ£ŸàŸÑÿßŸã';
        statusDiv.style.color = '#dc3545';
        return;
    }
    
    const file = fileInput.files[0];
    const category = categorySelect.value;
    const description = descriptionInput.value || file.name;
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ (ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 25 MB)
    const maxSize = 25 * 1024 * 1024;
    if (file.size > maxSize) {
        statusDiv.textContent = '‚ùå ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã! Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ£ŸÇŸÑ ŸÖŸÜ 25 ŸÖŸäÿ¨ÿßÿ®ÿßŸäÿ™';
        statusDiv.style.color = '#dc3545';
        return;
    }
    
    try {
        uploadBtn.disabled = true;
        statusDiv.textContent = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ...';
        statusDiv.style.color = '#666';
        
        // ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ ŸÉŸÄ base64
        const reader = new FileReader();
        reader.onload = async function(e) {
            const content = e.target.result.split(',')[1];
            const fileName = file.name;
            const filePath = `files/${category}/${fileName}`;
            const repo = 'aliabdelaal-adm/Monthly_inspection_plan';
            
            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ™ŸàŸÉŸÜ ŸÖŸÜ localStorage (ŸÖŸÜ ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ∑Ÿàÿ±)
            let token = localStorage.getItem('devToken') || localStorage.getItem('githubToken');
            
            // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ÿßŸÑÿ™ŸàŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã ŸàŸÑŸÉŸÜ ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÖÿ≥ÿ¨ŸÑ ÿßŸÑÿØÿÆŸàŸÑÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ™ŸàŸÉŸÜ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
            if (!token && (isDev || window.isDev)) {
                const defaultToken = "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";
                localStorage.setItem("devToken", defaultToken);
                token = defaultToken;
            }
            
            if (!token) {
                statusDiv.textContent = '‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ŸàŸÉŸÜ ŸÖÿ™ÿßÿ≠. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ´ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ';
                statusDiv.style.color = '#dc3545';
                uploadBtn.disabled = false;
                return;
            }
            
            try {
                // ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿ•ŸÑŸâ GitHub
                const uploadRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿ¨ÿØŸäÿØ: ${fileName}`,
                        content: content
                    })
                });
                
                if (uploadRes.status === 201) {
                    // ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅ files.json
                    await updateFilesRegistryFromMain(fileName, filePath, category, file.size, description, token);
                    statusDiv.textContent = '‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ Ÿàÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠!';
                    statusDiv.style.color = '#28a745';
                    
                    // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
                    fileInput.value = '';
                    descriptionInput.value = '';
                    
                    // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™
                    setTimeout(() => loadPublicFiles('all'), 1000);
                } else {
                    const err = await uploadRes.json().catch(() => ({ message: `HTTP ${uploadRes.status}` }));
                    statusDiv.textContent = '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ: ' + (err.message || 'ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ŸàŸÉŸÜ ÿ£Ÿà ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™');
                    statusDiv.style.color = '#dc3545';
                }
            } catch (error) {
                statusDiv.textContent = '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ: ' + error.message;
                statusDiv.style.color = '#dc3545';
            } finally {
                uploadBtn.disabled = false;
            }
        };
        
        reader.readAsDataURL(file);
        
    } catch (error) {
        statusDiv.textContent = '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ: ' + error.message;
        statusDiv.style.color = '#dc3545';
        uploadBtn.disabled = false;
    }
}

async function updateFilesRegistryFromMain(fileName, filePath, category, fileSize, description, token) {
    try {
        const repo = 'aliabdelaal-adm/Monthly_inspection_plan';
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ files.json ÿßŸÑÿ≠ÿßŸÑŸä
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        let filesData = { files: [], categories: [], lastUpdate: new Date().toISOString() };
        let currentSha = '';
        
        if (res.ok) {
            const file = await res.json();
            filesData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
            currentSha = file.sha;
        }
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¨ÿØŸäÿØ
        const newFile = {
            id: Date.now().toString(),
            name: fileName,
            path: filePath,
            category: category,
            type: fileName.split('.').pop().toLowerCase(),
            size: fileSize,
            uploadDate: new Date().toISOString(),
            description: description,
            uploader: 'ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ',
            visible: true
        };
        
        filesData.files.push(newFile);
        filesData.lastUpdate = new Date().toISOString();
        
        // ÿ≠ŸÅÿ∏ ŸÖŸÑŸÅ files.json ÿßŸÑŸÖÿ≠ÿØÿ´
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(filesData, null, 2))));
        const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `ÿ™ÿ≠ÿØŸäÿ´ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ - ÿ•ÿ∂ÿßŸÅÿ© ${fileName}`,
                content: content,
                sha: currentSha
            })
        });
        
        if (!updateRes.ok) {
            console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™');
        }
        
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™:', error);
    }
}

async function editFileFromMain(fileId, fileName, description, category) {
    if (!isDev && !window.isDev) {
        alert('‚ùå ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÖÿ∑ŸÑŸàÿ®ÿ© ŸÑÿ™ÿ≠ÿ±Ÿäÿ± ÿßŸÑŸÖŸÑŸÅÿßÿ™');
        return;
    }
    
    const newDescription = prompt('ÿ™ÿ≠ÿ±Ÿäÿ± ŸàÿµŸÅ ÿßŸÑŸÖŸÑŸÅ:\n\nÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ: ' + fileName, description);
    
    if (newDescription === null) {
        return; // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£ŸÑÿ∫Ÿâ
    }
    
    const token = localStorage.getItem('devToken') || localStorage.getItem('githubToken');
    if (!token) {
        alert('‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÉŸÖÿ∑Ÿàÿ± ÿ£ŸàŸÑÿßŸã');
        return;
    }
    
    const statusDiv = document.getElementById('filesLoadingStatus');
    
    try {
        statusDiv.textContent = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÑŸÅ...';
        statusDiv.style.color = '#666';
        
        const repo = 'aliabdelaal-adm/Monthly_inspection_plan';
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ files.json ÿßŸÑÿ≠ÿßŸÑŸä
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (res.ok) {
            const file = await res.json();
            const filesData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸàÿµŸÅ ÿßŸÑŸÖŸÑŸÅ
            const fileIndex = filesData.files.findIndex(f => f.id === fileId);
            if (fileIndex !== -1) {
                filesData.files[fileIndex].description = newDescription;
                filesData.lastUpdate = new Date().toISOString();
                
                // ÿ≠ŸÅÿ∏ ŸÖŸÑŸÅ files.json ÿßŸÑŸÖÿ≠ÿØÿ´
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(filesData, null, 2))));
                const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `ÿ™ÿ≠ÿØŸäÿ´ ŸàÿµŸÅ ÿßŸÑŸÖŸÑŸÅ: ${fileName}`,
                        content: content,
                        sha: file.sha
                    })
                });
                
                if (updateRes.ok) {
                    statusDiv.textContent = '‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠';
                    statusDiv.style.color = '#28a745';
                    
                    // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™
                    setTimeout(() => loadPublicFiles(category), 1000);
                } else {
                    statusDiv.textContent = '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™';
                    statusDiv.style.color = '#dc3545';
                }
            } else {
                statusDiv.textContent = '‚ùå ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑÿ≥ÿ¨ŸÑ';
                statusDiv.style.color = '#dc3545';
            }
        } else {
            statusDiv.textContent = '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÑŸÅÿßÿ™';
            statusDiv.style.color = '#dc3545';
        }
    } catch (error) {
        statusDiv.textContent = '‚ùå ÿÆÿ∑ÿ£: ' + error.message;
        statusDiv.style.color = '#dc3545';
    }
}

async function deleteFileFromMain(fileId, filePath, fileName, category) {
    if (!isDev && !window.isDev) {
        alert('‚ùå ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± ŸÖÿ∑ŸÑŸàÿ®ÿ© ŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅÿßÿ™');
        return;
    }
    
    if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅ "${fileName}"ÿü\n\nŸáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá.`)) {
        return;
    }
    
    const token = localStorage.getItem('devToken') || localStorage.getItem('githubToken');
    if (!token) {
        alert('‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÉŸÖÿ∑Ÿàÿ± ÿ£ŸàŸÑÿßŸã');
        return;
    }
    
    const statusDiv = document.getElementById('filesLoadingStatus');
    
    try {
        statusDiv.textContent = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅ...';
        statusDiv.style.color = '#666';
        
        const repo = 'aliabdelaal-adm/Monthly_inspection_plan';
        
        // ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅ ŸÖŸÜ GitHub
        const fileRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (fileRes.ok) {
            const file = await fileRes.json();
            const deleteRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅ: ${fileName}`,
                    sha: file.sha
                })
            });
            
            if (deleteRes.ok) {
                // ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅ files.json
                await removeFromFilesRegistryFromMain(fileId, token);
                statusDiv.textContent = '‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ Ÿàÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠';
                statusDiv.style.color = '#28a745';
                
                // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™
                setTimeout(() => loadPublicFiles(category), 1000);
            } else {
                statusDiv.textContent = '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅ';
                statusDiv.style.color = '#dc3545';
            }
        } else {
            statusDiv.textContent = '‚ùå ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ';
            statusDiv.style.color = '#dc3545';
        }
    } catch (error) {
        statusDiv.textContent = '‚ùå ÿÆÿ∑ÿ£: ' + error.message;
        statusDiv.style.color = '#dc3545';
    }
}

async function removeFromFilesRegistryFromMain(fileId, token) {
    try {
        const repo = 'aliabdelaal-adm/Monthly_inspection_plan';
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ files.json ÿßŸÑÿ≠ÿßŸÑŸä
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (res.ok) {
            const file = await res.json();
            const filesData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
            
            // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖŸÑŸÅ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
            filesData.files = filesData.files.filter(f => f.id !== fileId);
            filesData.lastUpdate = new Date().toISOString();
            
            // ÿ≠ŸÅÿ∏ ŸÖŸÑŸÅ files.json ÿßŸÑŸÖÿ≠ÿØÿ´
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(filesData, null, 2))));
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: 'ÿ™ÿ≠ÿØŸäÿ´ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ - ÿ≠ÿ∞ŸÅ ŸÖŸÑŸÅ',
                    content: content,
                    sha: file.sha
                })
            });
            
            if (!updateRes.ok) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™');
            }
        }
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™:', error);
    }
}

function updateFilesCategoryButtons(activeCategory) {
    // ÿ™ÿÆÿ∑Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ŸÅŸä ÿ≠ÿßŸÑÿ© Ÿàÿ¨ŸàÿØ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿπŸÜÿßÿµÿ±
    try {
        const buttonsContainer = document.getElementById('publicFilesList')?.parentElement;
        if (!buttonsContainer) return;
        
        const buttons = buttonsContainer.querySelectorAll('button');
        
        buttons.forEach(btn => {
            btn.style.opacity = '0.7';
            btn.style.transform = 'scale(1)';
        });
        
        // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≤ÿ± ÿßŸÑŸÜÿ¥ÿ∑
        const activeBtn = document.getElementById('filesAllBtn');
        if (activeBtn && activeCategory === 'all') {
            activeBtn.style.opacity = '1';
            activeBtn.style.transform = 'scale(1.05)';
        }
    } catch (error) {
        console.warn('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ:', error);
    }
}

async function downloadPublicFile(filePath, fileName) {
    const statusDiv = document.getElementById('filesLoadingStatus');
    
    try {
        statusDiv.textContent = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ...';
        statusDiv.style.color = '#666';
        
        let response;
        
        // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ŸÖÿ≠ŸÑŸäÿßŸã ÿ£ŸàŸÑÿßŸã ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±
        try {
            response = await fetch(`./${filePath}`);
            if (!response.ok) {
                throw new Error('Local file not found');
            }
            console.log('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ŸÖÿ≠ŸÑŸäÿßŸã');
        } catch (localError) {
            // ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑŸäÿå ŸÖÿ≠ÿßŸàŸÑÿ© ŸÖŸÜ GitHub
            response = await fetch(`https://raw.githubusercontent.com/aliabdelaal-adm/Monthly_inspection_plan/main/${filePath}`);
            
            if (!response.ok) {
                throw new Error('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ');
            }
            console.log('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ŸÖŸÜ GitHub');
        }
        
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        statusDiv.textContent = '‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠';
        statusDiv.style.color = '#28a745';
        
        // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿ®ÿπÿØ 3 ÿ´ŸàÿßŸÜ
        setTimeout(() => {
            statusDiv.textContent = '';
        }, 3000);
        
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ:', error);
        statusDiv.textContent = '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ - Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã';
        statusDiv.style.color = '#dc3545';
    }
}

async function previewPublicFile(filePath, fileName, fileType) {
    const statusDiv = document.getElementById('filesLoadingStatus');
    
    statusDiv.textContent = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿ∂Ÿäÿ± ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÖŸÑŸÅ...';
    statusDiv.style.color = '#666';
    
    try {
        const response = await fetch(`https://raw.githubusercontent.com/aliabdelaal-adm/Monthly_inspection_plan/main/${filePath}`);
        
        if (!response.ok) {
            throw new Error('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ŸÑŸÑŸÖÿπÿßŸäŸÜÿ©');
        }
        
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        
        // ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿ¨ÿØŸäÿØÿ© ŸÑŸÑŸÖÿπÿßŸäŸÜÿ©
        const previewWindow = window.open('', '_blank');
        previewWindow.document.write(`
            <html>
            <head>
                <title>ŸÖÿπÿßŸäŸÜÿ©: ${fileName}</title>
                <meta charset="UTF-8">
                <style>
                    body { margin: 0; padding: 20px; font-family: Arial, sans-serif; direction: rtl; }
                    .header { background: #2336a0; color: white; padding: 15px; margin: -20px -20px 20px -20px; }
                    .content { text-align: center; }
                    iframe, img { max-width: 100%; height: 80vh; border: 1px solid #ddd; }
                    .download-btn { background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h2>ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÖŸÑŸÅ: ${fileName}</h2>
                    <button class="download-btn" onclick="window.close()">ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©</button>
                </div>
                <div class="content">
        `);
        
        if (fileType.toLowerCase() === 'pdf') {
            previewWindow.document.write(`<iframe src="${url}" width="100%" height="600px"></iframe>`);
        } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileType.toLowerCase())) {
            previewWindow.document.write(`<img src="${url}" alt="${fileName}" style="max-width: 100%; height: auto;">`);
        } else {
            previewWindow.document.write(`<p>ŸÖÿπÿßŸäŸÜÿ© Ÿáÿ∞ÿß ÿßŸÑŸÜŸàÿπ ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖÿ©. ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ŸÑŸÑÿßÿ∑ŸÑÿßÿπ ÿπŸÑŸäŸá.</p>`);
        }
        
        previewWindow.document.write(`
                </div>
            </body>
            </html>
        `);
        
        statusDiv.textContent = '‚úÖ ÿ™ŸÖ ŸÅÿ™ÿ≠ ÿßŸÑŸÖŸÑŸÅ ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿ¨ÿØŸäÿØÿ©';
        statusDiv.style.color = '#28a745';
        
        // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿ®ÿπÿØ 3 ÿ´ŸàÿßŸÜ
        setTimeout(() => {
            statusDiv.textContent = '';
        }, 3000);
        
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÖŸÑŸÅ:', error);
        statusDiv.textContent = '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÖŸÑŸÅ - Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã';
        statusDiv.style.color = '#dc3545';
    }
}

// ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
document.addEventListener('DOMContentLoaded', function() {
    // ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖŸÜ ŸÖŸÑŸÅ Excel ÿßŸÑŸÖÿ≥ÿ™ÿÆÿ±ÿ¨
    if (typeof loadShopsDetails === 'function') {
        loadShopsDetails();
    }
    
    // ÿ™ÿ£ÿÆŸäÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÇŸÑŸäŸÑÿßŸã ŸÑŸÑÿ≥ŸÖÿßÿ≠ ŸÑŸÑÿµŸÅÿ≠ÿ© ÿ®ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÉÿßŸÖŸÑ
    setTimeout(() => {
        if (typeof loadPublicFiles === 'function') {
            loadPublicFiles('all');
        }
    }, 1000);
    
    // ÿ™ŸáŸäÿ¶ÿ© ŸÇÿ≥ŸÖ ÿ•ÿØÿßÿ±ÿ© ÿÆÿØŸÖÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÉŸÖŸÅÿ™Ÿàÿ≠ ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäÿßŸã
    setTimeout(() => {
        const content = document.getElementById('systemServicesContent');
        const header = document.querySelector('.system-services-header');
        if (content && header) {
            content.classList.add('expanded');
            // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÉŸÑÿßÿ≥ collapsed ÿ•ŸÜ ŸàŸèÿ¨ÿØ
            header.classList.remove('collapsed');
        }
    }, 500);
});

// ===== ÿ•ÿµŸÑÿßÿ≠ ŸÖÿ§ŸÇÿ™ ŸÑŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÖÿπÿ∑ŸÑÿ© =====
// ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ÿ≠ÿ™Ÿâ ŸÑŸà ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ
if (typeof showSmartRotationModal === 'undefined') {
    function showSmartRotationModal() {
        if (document.getElementById('smartRotationModal')) {
            document.getElementById('smartRotationModal').style.display = 'flex';
        } else {
            alert('üîÑ ŸÖŸäÿ≤ÿ© ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ∞ŸÉŸä ŸÖÿ™ÿßÿ≠ÿ© ŸÇÿ±Ÿäÿ®ÿßŸã');
        }
    }
}

if (typeof closeSmartRotationModal === 'undefined') {
    function closeSmartRotationModal() {
        if (document.getElementById('smartRotationModal')) {
            document.getElementById('smartRotationModal').style.display = 'none';
        }
    }
}

if (typeof showVacationTrackerModal === 'undefined') {
    function showVacationTrackerModal() {
        if (document.getElementById('vacationTrackerModal')) {
            document.getElementById('vacationTrackerModal').style.display = 'flex';
        } else {
            alert('üèñÔ∏è ŸÖŸäÿ≤ÿ© ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ŸÇÿ±Ÿäÿ®ÿßŸã');
        }
    }
}

if (typeof closeVacationTrackerModal === 'undefined') {
    function closeVacationTrackerModal() {
        if (document.getElementById('vacationTrackerModal')) {
            document.getElementById('vacationTrackerModal').style.display = 'none';
        }
    }
}

if (typeof showShopsManagementModal === 'undefined') {
    function showShopsManagementModal() {
        if (document.getElementById('shopsManagementModal')) {
            document.getElementById('shopsManagementModal').style.display = 'flex';
        } else {
            alert('üè™ ŸÖŸäÿ≤ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ŸÇÿ±Ÿäÿ®ÿßŸã');
        }
    }
}

if (typeof closeShopsManagementModal === 'undefined') {
    function closeShopsManagementModal() {
        if (document.getElementById('shopsManagementModal')) {
            document.getElementById('shopsManagementModal').style.display = 'none';
        }
    }
}

// Sheikh Zayed Audio Message - Play on click anywhere or on button click
(function() {
    const audio = document.getElementById('sheikhZayedAudio');
    const playBtn = document.getElementById('playSheikhZayedBtn');
    let hasPlayedOnce = false;
    
    // Update button text when playing/paused
    if (audio) {
        audio.addEventListener('play', function() {
            if (playBtn) playBtn.textContent = '‚è∏Ô∏è ÿ•ŸäŸÇÿßŸÅ ŸÖÿ§ŸÇÿ™';
        });
        
        audio.addEventListener('pause', function() {
            if (playBtn) playBtn.textContent = 'ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ¥ŸäÿÆ ÿ≤ÿßŸäÿØ';
        });
        
        audio.addEventListener('ended', function() {
            if (playBtn) playBtn.textContent = 'ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ¥ŸäÿÆ ÿ≤ÿßŸäÿØ';
        });
    }
    
    // Toggle play/pause on button click with enhanced cross-browser support
    if (playBtn && audio) {
        playBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (audio.paused) {
                // Safari-specific: Load audio if not ready
                if (audio.readyState < 2) {
                    audio.load();
                }
                
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('üéµ Sheikh Zayed audio playing');
                    }).catch(error => {
                        console.log('üéµ Audio playback prevented, trying muted start:', error);
                        // Try muted start for Safari
                        audio.muted = true;
                        audio.play().then(() => {
                            setTimeout(() => {
                                audio.muted = false;
                                audio.volume = 1.0;
                            }, 100);
                        }).catch(err => {
                            console.log('üéµ Sheikh Zayed audio playback failed:', err);
                        });
                    });
                }
            } else {
                audio.pause();
            }
        });
    }
})();

// Auto-scroll functionality - Very slow continuous scrolling with smooth animation
(function() {
    let animationFrameId;
    let currentPosition = 0;
    let isScrolling = false;
    let lastTimestamp = 0;
    
    // Pixels per second for very slow scrolling (10 pixels/second)
    const scrollSpeed = 10;
    
    function startAutoScroll() {
        // Calculate scroll speed for very slow movement
        const pageHeight = Math.max(
            document.body.scrollHeight,
            document.body.offsetHeight,
            document.documentElement.clientHeight,
            document.documentElement.scrollHeight,
            document.documentElement.offsetHeight
        );
        
        isScrolling = true;
        lastTimestamp = performance.now();
        
        function animate(timestamp) {
            if (!isScrolling) return;
            
            // Calculate time elapsed since last frame
            const deltaTime = timestamp - lastTimestamp;
            lastTimestamp = timestamp;
            
            // Calculate pixels to move based on time elapsed (smooth framerate-independent animation)
            const pixelsToMove = (scrollSpeed * deltaTime) / 1000;
            currentPosition += pixelsToMove;
            
            // Check if we've reached the bottom
            const maxScroll = pageHeight - window.innerHeight;
            if (currentPosition >= maxScroll) {
                // Reset to top and start over
                currentPosition = 0;
                window.scrollTo({ top: 0, behavior: 'auto' });
                
                // Wait a bit before starting again
                isScrolling = false;
                setTimeout(startAutoScroll, 2000);
                return;
            }
            
            // Use scrollTo with 'auto' behavior for instant but smooth pixel-by-pixel movement
            window.scrollTo({ top: Math.round(currentPosition), behavior: 'auto' });
            
            // Continue animation
            animationFrameId = requestAnimationFrame(animate);
        }
        
        // Start the animation
        animationFrameId = requestAnimationFrame(animate);
    }
    
    // Start auto-scroll when page loads
    window.addEventListener('load', function() {
        // Wait a bit before starting auto-scroll
        setTimeout(function() {
            startAutoScroll();
        }, 3000); // Start after 3 seconds
    });
    
    // Pause auto-scroll when user manually scrolls
    let userScrollTimeout;
    
    function pauseAndResumeAutoScroll() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            isScrolling = false;
        }
        
        // Resume auto-scroll after user stops interacting for 10 seconds
        clearTimeout(userScrollTimeout);
        userScrollTimeout = setTimeout(function() {
            currentPosition = window.pageYOffset;
            startAutoScroll();
        }, 10000);
    }
    
    // Pause on mouse wheel scroll
    window.addEventListener('wheel', pauseAndResumeAutoScroll, { passive: true });
    
    // Pause on touch scroll for mobile
    window.addEventListener('touchmove', pauseAndResumeAutoScroll, { passive: true });
    
    // Pause on any click anywhere on the screen
    window.addEventListener('click', pauseAndResumeAutoScroll, { passive: true });
})();

// ===== Enhanced Quick Data Entry Functions =====

// Show/Hide Quick Bulk Import Section
function showQuickBulkImport() {
    if (!isDev) {
        alert('Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÅŸÇÿ∑ ŸÑŸÑŸÖÿ∑Ÿàÿ±');
        return;
    }
    document.getElementById('bulkImportSection').style.display = 'block';
    document.getElementById('cloneSection').style.display = 'none';
    document.getElementById('batchOperationsSection').style.display = 'none';
    document.getElementById('bulkImportData').focus();
}

function closeBulkImport() {
    document.getElementById('bulkImportSection').style.display = 'none';
    document.getElementById('bulkImportData').value = '';
    document.getElementById('bulkImportStatus').innerHTML = '';
}

// Set bulk import format
let bulkImportFormat = 'json';
function setBulkImportFormat(format) {
    bulkImportFormat = format;
    
    // Update button styles
    document.getElementById('formatJsonBtn').style.background = format === 'json' ? '#007bff' : '#6c757d';
    document.getElementById('formatCsvBtn').style.background = format === 'csv' ? '#007bff' : '#6c757d';
    
    // Update example
    const exampleDiv = document.getElementById('formatExample');
    if (format === 'csv') {
        exampleDiv.innerHTML = `
            <strong style="color:#007bff;">ŸÖÿ´ÿßŸÑ CSV:</strong>
            <pre style="margin:10px 0 0 0;padding:10px;background:#fff;border-radius:4px;overflow-x:auto;font-size:0.85em;">inspector,day,shift,area,shops
ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ,2025-10-01,ÿµÿ®ÿßÿ≠Ÿäÿ©,ÿ≥ŸàŸÇ ÿßŸÑŸÖŸäŸÜÿßÿ°,"ŸÖÿ≠ŸÑ 1|ŸÖÿ≠ŸÑ 2|ŸÖÿ≠ŸÑ 3"
ÿØ. ÿ¢ŸÖŸÜŸá ÿ®ŸÜ ÿµÿ±ŸÖ,2025-10-01,ŸÖÿ≥ÿßÿ¶Ÿäÿ©,ÿßŸÑÿ≠ÿµŸÜ,"ŸÖÿ≠ŸÑ 4|ŸÖÿ≠ŸÑ 5"</pre>
            <small style="color:#666;">ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿ™ŸÅÿµŸÑ ÿ®ŸÄ | ÿØÿßÿÆŸÑ ÿßŸÑÿ≠ŸÇŸÑ</small>
        `;
    } else {
        exampleDiv.innerHTML = `
            <strong style="color:#007bff;">ŸÖÿ´ÿßŸÑ JSON:</strong>
            <pre style="margin:10px 0 0 0;padding:10px;background:#fff;border-radius:4px;overflow-x:auto;font-size:0.85em;">[
  {
    "inspector": "ÿØ. ÿπŸÑŸä ÿπÿ®ÿØÿßŸÑÿπÿßŸÑ",
    "day": "2025-10-01",
    "shift": "ÿµÿ®ÿßÿ≠Ÿäÿ©",
    "area": "ÿ≥ŸàŸÇ ÿßŸÑŸÖŸäŸÜÿßÿ°",
    "shops": ["ŸÖÿ≠ŸÑ 1", "ŸÖÿ≠ŸÑ 2"]
  }
]</pre>
        `;
    }
}

// Validate bulk import data
function validateBulkImport() {
    const data = document.getElementById('bulkImportData').value.trim();
    const statusDiv = document.getElementById('bulkImportStatus');
    
    if (!data) {
        statusDiv.innerHTML = '<div style="background:#fff3cd;border:1px solid #ffc107;padding:10px;border-radius:6px;color:#856404;">‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã</div>';
        return;
    }
    
    try {
        let entries = [];
        
        if (bulkImportFormat === 'json') {
            entries = JSON.parse(data);
            if (!Array.isArray(entries)) {
                entries = [entries];
            }
        } else if (bulkImportFormat === 'csv') {
            const lines = data.split('\n').filter(l => l.trim());
            const headers = lines[0].split(',').map(h => h.trim());
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g) || [];
                const entry = {};
                
                headers.forEach((header, index) => {
                    let value = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '';
                    
                    if (header === 'shops') {
                        entry[header] = value.split('|').map(s => s.trim()).filter(s => s);
                    } else {
                        entry[header] = value;
                    }
                });
                
                entries.push(entry);
            }
        }
        
        // Validate entries
        const errors = [];
        entries.forEach((entry, index) => {
            if (!entry.inspector) errors.push(`ÿßŸÑÿ≥ÿ∑ÿ± ${index + 1}: ŸÖŸÅŸÇŸàÿØ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÅÿ™ÿ¥`);
            if (!entry.day) errors.push(`ÿßŸÑÿ≥ÿ∑ÿ± ${index + 1}: ŸÖŸÅŸÇŸàÿØ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ`);
            if (!entry.shift) errors.push(`ÿßŸÑÿ≥ÿ∑ÿ± ${index + 1}: ŸÖŸÅŸÇŸàÿØ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©`);
            if (!entry.area) errors.push(`ÿßŸÑÿ≥ÿ∑ÿ± ${index + 1}: ŸÖŸÅŸÇŸàÿØ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©`);
            if (!entry.shops || entry.shops.length === 0) errors.push(`ÿßŸÑÿ≥ÿ∑ÿ± ${index + 1}: ŸÖŸÅŸÇŸàÿØ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™`);
        });
        
        if (errors.length > 0) {
            statusDiv.innerHTML = `
                <div style="background:#f8d7da;border:1px solid:#dc3545;padding:10px;border-radius:6px;color:#721c24;">
                    ‚ùå ÿ£ÿÆÿ∑ÿßÿ° ŸÅŸä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:<br>
                    ${errors.map(e => `‚Ä¢ ${e}`).join('<br>')}
                </div>
            `;
        } else {
            statusDiv.innerHTML = `
                <div style="background:#d4edda;border:1px solid:#28a745;padding:10px;border-radius:6px;color:#155724;">
                    ‚úÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿµÿ≠Ÿäÿ≠ÿ©! ÿπÿØÿØ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™: ${entries.length}
                </div>
            `;
        }
    } catch (error) {
        statusDiv.innerHTML = `
            <div style="background:#f8d7da;border:1px solid:#dc3545;padding:10px;border-radius:6px;color:#721c24;">
                ‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ${error.message}
            </div>
        `;
    }
}

// Process and import bulk data
function processBulkImport() {
    const data = document.getElementById('bulkImportData').value.trim();
    const statusDiv = document.getElementById('bulkImportStatus');
    
    if (!data) {
        statusDiv.innerHTML = '<div style="background:#fff3cd;border:1px solid:#ffc107;padding:10px;border-radius:6px;color:#856404;">‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£ŸàŸÑÿßŸã</div>';
        return;
    }
    
    try {
        let entries = [];
        
        if (bulkImportFormat === 'json') {
            entries = JSON.parse(data);
            if (!Array.isArray(entries)) {
                entries = [entries];
            }
        } else if (bulkImportFormat === 'csv') {
            const lines = data.split('\n').filter(l => l.trim());
            const headers = lines[0].split(',').map(h => h.trim());
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g) || [];
                const entry = {};
                
                headers.forEach((header, index) => {
                    let value = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '';
                    
                    if (header === 'shops') {
                        entry[header] = value.split('|').map(s => s.trim()).filter(s => s);
                    } else {
                        entry[header] = value;
                    }
                });
                
                entries.push(entry);
            }
        }
        
        // Validate and add entries
        let added = 0;
        let skipped = 0;
        const errors = [];
        
        entries.forEach((entry, index) => {
            // Validate entry
            if (!entry.inspector || !entry.day || !entry.shift || !entry.area || !entry.shops || entry.shops.length === 0) {
                errors.push(`ÿßŸÑÿ≥ÿ∑ÿ± ${index + 1}: ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿßŸÇÿµÿ©`);
                skipped++;
                return;
            }
            
            // Check if area exists
            if (!areasData.find(ar => ar.name === entry.area)) {
                errors.push(`ÿßŸÑÿ≥ÿ∑ÿ± ${index + 1}: ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© "${entry.area}" ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©`);
                skipped++;
                return;
            }
            
            // Add new inspector if needed
            if (!inspectorsData.find(insp => insp.name === entry.inspector)) {
                const newId = 'insp_' + Date.now() + '_' + added;
                inspectorsData.push({id: newId, name: entry.inspector});
            }
            
            // Add entry
            inspectionData.push(entry);
            added++;
        });
        
        // Save and update display
        saveInspectionData();
        fillInspectorsDropdowns();
        renderPlanTable();
        
        // Show results
        let resultHtml = `<div style="background:#d4edda;border:1px solid:#28a745;padding:10px;border-radius:6px;color:#155724;">
            ‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ${added} ÿ≥ÿ¨ŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!`;
        
        if (skipped > 0) {
            resultHtml += `<br>‚ö†Ô∏è ÿ™ŸÖ ÿ™ÿÆÿ∑Ÿä ${skipped} ÿ≥ÿ¨ŸÑ ÿ®ÿ≥ÿ®ÿ® ÿ£ÿÆÿ∑ÿßÿ°`;
        }
        
        if (errors.length > 0 && errors.length <= 10) {
            resultHtml += `<br><br>ÿ£ÿÆÿ∑ÿßÿ°:<br>${errors.map(e => `‚Ä¢ ${e}`).join('<br>')}`;
        }
        
        resultHtml += '</div>';
        statusDiv.innerHTML = resultHtml;
        
        // Clear input after 3 seconds
        setTimeout(() => {
            if (added > 0) {
                closeBulkImport();
            }
        }, 3000);
        
    } catch (error) {
        statusDiv.innerHTML = `
            <div style="background:#f8d7da;border:1px solid:#dc3545;padding:10px;border-radius:6px;color:#721c24;">
                ‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ${error.message}
            </div>
        `;
    }
}

// Show Clone Section
function showQuickClone() {
    if (!isDev) {
        alert('Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÅŸÇÿ∑ ŸÑŸÑŸÖÿ∑Ÿàÿ±');
        return;
    }
    document.getElementById('bulkImportSection').style.display = 'none';
    document.getElementById('cloneSection').style.display = 'block';
    document.getElementById('batchOperationsSection').style.display = 'none';
    
    // Populate inspectors
    const inspectorSelect = document.getElementById('cloneInspector');
    inspectorSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ŸÖŸÅÿ™ÿ¥</option>';
    inspectorsData.forEach(insp => {
        inspectorSelect.innerHTML += `<option value="${insp.name}">${insp.name}</option>`;
    });
    
    // Add change listener to populate dates
    inspectorSelect.onchange = function() {
        const dateSelect = document.getElementById('cloneSourceDate');
        dateSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</option>';
        
        if (this.value) {
            const inspectorEntries = inspectionData.filter(e => e.inspector === this.value);
            const uniqueDates = [...new Set(inspectorEntries.map(e => e.day))].sort();
            
            uniqueDates.forEach(date => {
                dateSelect.innerHTML += `<option value="${date}">${date}</option>`;
            });
        }
    };
}

function closeClone() {
    document.getElementById('cloneSection').style.display = 'none';
    document.getElementById('cloneInspector').value = '';
    document.getElementById('cloneSourceDate').value = '';
    document.getElementById('cloneTargetDates').value = '';
    document.getElementById('cloneStatus').innerHTML = '';
}

// Process clone operation
function processClone() {
    const inspector = document.getElementById('cloneInspector').value;
    const sourceDate = document.getElementById('cloneSourceDate').value;
    const targetDatesStr = document.getElementById('cloneTargetDates').value.trim();
    const statusDiv = document.getElementById('cloneStatus');
    
    if (!inspector || !sourceDate || !targetDatesStr) {
        statusDiv.innerHTML = '<div style="background:#fff3cd;border:1px solid:#ffc107;padding:10px;border-radius:6px;color:#856404;">‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ™ÿπÿ®ÿ¶ÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ</div>';
        return;
    }
    
    // Parse target dates
    const targetDates = targetDatesStr.split(',').map(d => d.trim()).filter(d => d);
    
    if (targetDates.length === 0) {
        statusDiv.innerHTML = '<div style="background:#fff3cd;border:1px solid:#ffc107;padding:10px;border-radius:6px;color:#856404;">‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ™ÿßÿ±ŸäÿÆ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ</div>';
        return;
    }
    
    // Find source entries
    const sourceEntries = inspectionData.filter(e => e.inspector === inspector && e.day === sourceDate);
    
    if (sourceEntries.length === 0) {
        statusDiv.innerHTML = '<div style="background:#f8d7da;border:1px solid:#dc3545;padding:10px;border-radius:6px;color:#721c24;">‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿÆÿ∑ÿ© ŸÑŸÑŸÖŸÅÿ™ÿ¥ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</div>';
        return;
    }
    
    // Clone to target dates
    let cloned = 0;
    targetDates.forEach(targetDate => {
        sourceEntries.forEach(sourceEntry => {
            const newEntry = {
                ...sourceEntry,
                day: targetDate
            };
            inspectionData.push(newEntry);
            cloned++;
        });
    });
    
    // Save and update
    saveInspectionData();
    renderPlanTable();
    
    statusDiv.innerHTML = `
        <div style="background:#d4edda;border:1px solid:#28a745;padding:10px;border-radius:6px;color:#155724;">
            ‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ${sourceEntries.length} ÿÆÿ∑ÿ© ÿ•ŸÑŸâ ${targetDates.length} ÿ™ÿßÿ±ŸäÿÆ (ÿ•ÿ¨ŸÖÿßŸÑŸä ${cloned} ÿ≥ÿ¨ŸÑ ÿ¨ÿØŸäÿØ)
        </div>
    `;
    
    setTimeout(() => {
        closeClone();
    }, 3000);
}

// Show Batch Operations
function showBatchOperations() {
    if (!isDev) {
        alert('Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÅŸÇÿ∑ ŸÑŸÑŸÖÿ∑Ÿàÿ±');
        return;
    }
    document.getElementById('bulkImportSection').style.display = 'none';
    document.getElementById('cloneSection').style.display = 'none';
    document.getElementById('batchOperationsSection').style.display = 'block';
    
    // Set default dates
    const today = new Date();
    const nextWeek = new Date(today);
    nextWeek.setDate(nextWeek.getDate() + 7);
    
    document.getElementById('batchFromDate').valueAsDate = today;
    document.getElementById('batchToDate').valueAsDate = nextWeek;
    
    // Add operation selector change listener
    document.getElementById('batchOperation').onchange = function() {
        const fieldsDiv = document.getElementById('batchOperationFields');
        fieldsDiv.innerHTML = '';
        
        switch(this.value) {
            case 'changeShift':
                fieldsDiv.innerHTML = `
                    <label style="display:block;margin-bottom:8px;font-weight:bold;color:#333;">ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©:</label>
                    <select id="batchNewShift" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                        <option value="ÿµÿ®ÿßÿ≠Ÿäÿ©">ÿµÿ®ÿßÿ≠Ÿäÿ©</option>
                        <option value="ŸÖÿ≥ÿßÿ¶Ÿäÿ©">ŸÖÿ≥ÿßÿ¶Ÿäÿ©</option>
                    </select>
                `;
                break;
            case 'changeInspector':
                fieldsDiv.innerHTML = `
                    <label style="display:block;margin-bottom:8px;font-weight:bold;color:#333;">ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿßŸÑŸÇÿØŸäŸÖ:</label>
                    <select id="batchOldInspector" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;margin-bottom:10px;">
                        <option value="">ÿßÿÆÿ™ÿ± ŸÖŸÅÿ™ÿ¥</option>
                        ${inspectorsData.map(i => `<option value="${i.name}">${i.name}</option>`).join('')}
                    </select>
                    <label style="display:block;margin-bottom:8px;font-weight:bold;color:#333;">ÿßŸÑŸÖŸÅÿ™ÿ¥ ÿßŸÑÿ¨ÿØŸäÿØ:</label>
                    <select id="batchNewInspector" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                        <option value="">ÿßÿÆÿ™ÿ± ŸÖŸÅÿ™ÿ¥</option>
                        ${inspectorsData.map(i => `<option value="${i.name}">${i.name}</option>`).join('')}
                    </select>
                `;
                break;
            case 'addShops':
                fieldsDiv.innerHTML = `
                    <label style="display:block;margin-bottom:8px;font-weight:bold;color:#333;">ÿßŸÑŸÖÿ≠ŸÑÿßÿ™ ÿßŸÑŸÖÿ±ÿßÿØ ÿ•ÿ∂ÿßŸÅÿ™Ÿáÿß (ŸÖŸÅÿµŸàŸÑÿ© ÿ®ŸÅŸàÿßÿµŸÑ):</label>
                    <input type="text" id="batchShopsToAdd" placeholder="ŸÖÿ≠ŸÑ 1, ŸÖÿ≠ŸÑ 2, ŸÖÿ≠ŸÑ 3" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                `;
                break;
        }
    };
}

function closeBatchOperations() {
    document.getElementById('batchOperationsSection').style.display = 'none';
    document.getElementById('batchOperation').value = '';
    document.getElementById('batchOperationFields').innerHTML = '';
    document.getElementById('batchOperationStatus').innerHTML = '';
}

// Process batch operation
function processBatchOperation() {
    const fromDate = document.getElementById('batchFromDate').value;
    const toDate = document.getElementById('batchToDate').value;
    const operation = document.getElementById('batchOperation').value;
    const statusDiv = document.getElementById('batchOperationStatus');
    
    if (!fromDate || !toDate || !operation) {
        statusDiv.innerHTML = '<div style="background:#fff3cd;border:1px solid:#ffc107;padding:10px;border-radius:6px;color:#856404;">‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ™ÿπÿ®ÿ¶ÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ</div>';
        return;
    }
    
    // Get entries in date range
    const entriesInRange = inspectionData.filter(e => e.day >= fromDate && e.day <= toDate);
    
    if (entriesInRange.length === 0) {
        statusDiv.innerHTML = '<div style="background:#fff3cd;border:1px solid:#ffc107;padding:10px;border-radius:6px;color:#856404;">‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿÆÿ∑ÿ∑ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÜÿ∑ÿßŸÇ ÿßŸÑÿ≤ŸÖŸÜŸä</div>';
        return;
    }
    
    let affected = 0;
    
    switch(operation) {
        case 'delete':
            if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ${entriesInRange.length} ÿÆÿ∑ÿ© ŸÅŸä ÿßŸÑŸÜÿ∑ÿßŸÇ ÿßŸÑÿ≤ŸÖŸÜŸä ŸÖŸÜ ${fromDate} ÿ•ŸÑŸâ ${toDate}ÿü`)) {
                return;
            }
            inspectionData = inspectionData.filter(e => e.day < fromDate || e.day > toDate);
            affected = entriesInRange.length;
            break;
            
        case 'changeShift':
            const newShift = document.getElementById('batchNewShift').value;
            inspectionData.forEach(e => {
                if (e.day >= fromDate && e.day <= toDate) {
                    e.shift = newShift;
                    affected++;
                }
            });
            break;
            
        case 'changeInspector':
            const oldInspector = document.getElementById('batchOldInspector').value;
            const newInspector = document.getElementById('batchNewInspector').value;
            
            if (!oldInspector || !newInspector) {
                statusDiv.innerHTML = '<div style="background:#fff3cd;border:1px solid:#ffc107;padding:10px;border-radius:6px;color:#856404;">‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÅÿ™ÿ¥ŸäŸÜ</div>';
                return;
            }
            
            inspectionData.forEach(e => {
                if (e.day >= fromDate && e.day <= toDate && e.inspector === oldInspector) {
                    e.inspector = newInspector;
                    affected++;
                }
            });
            break;
            
        case 'addShops':
            const shopsToAddStr = document.getElementById('batchShopsToAdd').value.trim();
            
            if (!shopsToAddStr) {
                statusDiv.innerHTML = '<div style="background:#fff3cd;border:1px solid:#ffc107;padding:10px;border-radius:6px;color:#856404;">‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÖÿ≠ŸÑÿßÿ™</div>';
                return;
            }
            
            const shopsToAdd = shopsToAddStr.split(',').map(s => s.trim()).filter(s => s);
            
            inspectionData.forEach(e => {
                if (e.day >= fromDate && e.day <= toDate) {
                    shopsToAdd.forEach(shop => {
                        if (!e.shops.includes(shop)) {
                            e.shops.push(shop);
                        }
                    });
                    affected++;
                }
            });
            break;
    }
    
    // Save and update
    saveInspectionData();
    renderPlanTable();
    
    statusDiv.innerHTML = `
        <div style="background:#d4edda;border:1px solid:#28a745;padding:10px;border-radius:6px;color:#155724;">
            ‚úÖ ÿ™ŸÖÿ™ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠! ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ${affected} ÿÆÿ∑ÿ©
        </div>
    `;
    
    setTimeout(() => {
        closeBatchOperations();
    }, 3000);
}

// Save directly to GitHub
async function saveDirectToGitHub() {
    if (!isDev) {
        alert('Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÅŸÇÿ∑ ŸÑŸÑŸÖÿ∑Ÿàÿ±');
        return;
    }
    
    const token = localStorage.getItem('devToken');
    if (!token) {
        if (confirm('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ™ŸàŸÉŸÜ GitHub. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿØÿÆÿßŸÑŸá ÿßŸÑÿ¢ŸÜÿü')) {
            showTokenPopup();
        }
        return;
    }
    
    if (!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ•ŸÑŸâ GitHubÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅ plan-data.json ŸÅŸàÿ±ÿßŸã.')) {
        return;
    }
    
    try {
        const planData = {
            inspectionData: inspectionData,
            inspectors: inspectorsData,
            areas: areasData,
            shops: shopsData,
            bellNotes: bellNotesData,
            lastUpdate: new Date().toISOString()
        };
        
        // Show loading message
        showUpdateMessage('‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏ ÿ•ŸÑŸâ GitHub...');
        
        // Get current file SHA
        const repo = "aliabdelaal-adm/Monthly_inspection_plan";
        const path = "plan-data.json";
        
        const getResponse = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            }
        });
        
        if (!getResponse.ok) {
            throw new Error(`ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖŸÑŸÅ plan-data.json: ${getResponse.statusText}`);
        }
        
        const fileData = await getResponse.json();
        const sha = fileData.sha;
        
        // Update file
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(planData, null, 2))));
        const updateResponse = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: "ÿ™ÿ≠ÿØŸäÿ´ ÿÆÿ∑ÿ© ÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÖŸÜ ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖÿ∑Ÿàÿ±",
                content: content,
                sha: sha
            })
        });
        
        if (updateResponse.status === 200 || updateResponse.status === 201) {
            showUpdateMessage('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ GitHub ÿ®ŸÜÿ¨ÿßÿ≠!');
            console.log('‚úÖ Data saved directly to GitHub');
        } else {
            const error = await updateResponse.json().catch(() => ({}));
            throw new Error(error.message || `HTTP ${updateResponse.status}: ${updateResponse.statusText}`);
        }
        
    } catch (error) {
        console.error('Error saving to GitHub:', error);
        showUpdateMessage(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ŸÅÿ∏: ${error.message}`);
        
        if (error.message.includes('401') || error.message.includes('403')) {
            if (confirm('ÿ™ŸàŸÉŸÜ GitHub ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ÿ£Ÿà ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ™Ÿá. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿØÿÆÿßŸÑ ÿ™ŸàŸÉŸÜ ÿ¨ÿØŸäÿØÿü')) {
                localStorage.removeItem('devToken');
                showTokenPopup();
            }
        }
    }
}

// ========================================
// PWA Service Worker Registration
// ========================================
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then((registration) => {
                console.log('‚úÖ Service Worker registered successfully:', registration);
                
                // Check for updates periodically
                setInterval(() => {
                    registration.update();
                }, 60000); // Check every minute
                
                // Listen for updates
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    console.log('üîÑ New Service Worker installing...');
                    
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // New service worker available, prompt user to update
                            if (confirm('Ÿäÿ™ŸàŸÅÿ± ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ÿØŸäÿØ ŸÑŸÑÿ™ÿ∑ÿ®ŸäŸÇ. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ¢ŸÜÿü\n\nA new update is available. Update now?')) {
                                newWorker.postMessage({ action: 'skipWaiting' });
                                window.location.reload();
                            }
                        }
                    });
                });
            })
            .catch((error) => {
                console.error('‚ùå Service Worker registration failed:', error);
            });
        
        // Reload page when new service worker takes control
        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (!refreshing) {
                refreshing = true;
                window.location.reload();
            }
        });
    });
}

// PWA Install Prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    console.log('üì± PWA install prompt available');
    // Prevent the mini-infobar from appearing on mobile
    e.preventDefault();
    // Stash the event so it can be triggered later
    deferredPrompt = e;
    
    // Show install button or banner
    showPWAInstallBanner();
});

// Function to show PWA install banner
function showPWAInstallBanner() {
    // Check if already installed or dismissed
    if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('‚úÖ PWA already installed');
        return;
    }
    
    if (localStorage.getItem('pwa-install-dismissed')) {
        return;
    }
    
    // Create install banner
    const banner = document.createElement('div');
    banner.id = 'pwa-install-banner';
    banner.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 25px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        z-index: 100000;
        max-width: 90%;
        text-align: center;
        font-family: 'Cairo', sans-serif;
        animation: slideUp 0.5s ease-out;
    `;
    
    banner.innerHTML = `
        <div style="margin-bottom: 10px;">
            <strong>üì± ŸÇŸÖ ÿ®ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿπŸÑŸâ Ÿáÿßÿ™ŸÅŸÉ</strong><br>
            <small>ŸÑŸÑŸàÿµŸàŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπ ŸàÿßŸÑÿπŸÖŸÑ ÿ®ÿØŸàŸÜ ÿ•ŸÜÿ™ÿ±ŸÜÿ™</small>
        </div>
        <button id="pwa-install-btn" style="
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
            font-family: 'Cairo', sans-serif;
        ">ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑÿ¢ŸÜ</button>
        <button id="pwa-dismiss-btn" style="
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
        ">ŸÑÿßÿ≠ŸÇÿßŸã</button>
    `;
    
    document.body.appendChild(banner);
    
    // Install button click
    document.getElementById('pwa-install-btn').addEventListener('click', async () => {
        if (!deferredPrompt) {
            alert('ÿπÿ∞ÿ±ÿßŸãÿå ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ÿßŸÑŸä. ÿ¨ÿ±ÿ® ŸÖŸÜ ÿÆŸÑÿßŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ™ÿµŸÅÿ≠.');
            return;
        }
        
        // Show the install prompt
        deferredPrompt.prompt();
        
        // Wait for the user's response
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response to install prompt: ${outcome}`);
        
        if (outcome === 'accepted') {
            console.log('‚úÖ User accepted the install prompt');
        } else {
            console.log('‚ùå User dismissed the install prompt');
        }
        
        // Clear the deferred prompt
        deferredPrompt = null;
        
        // Remove banner
        banner.remove();
    });
    
    // Dismiss button click
    document.getElementById('pwa-dismiss-btn').addEventListener('click', () => {
        localStorage.setItem('pwa-install-dismissed', 'true');
        banner.remove();
    });
}

// Check if running as PWA
window.addEventListener('DOMContentLoaded', () => {
    const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                  window.navigator.standalone === true;
    
    if (isPWA) {
        console.log('‚úÖ Running as installed PWA');
        document.body.classList.add('pwa-mode');
    }
});

// ===== Developer Splash Screen System =====
// This system monitors for file changes and shows a splash screen with music

let splashScreenTimer = null;
let lastKnownDataHash = null;
let isMonitoringActive = false;

// Calculate hash of data for change detection
function calculateDataHash(data) {
    return JSON.stringify(data).split('').reduce((a, b) => {
        a = ((a << 5) - a) + b.charCodeAt(0);
        return a & a;
    }, 0);
}

// Show developer splash screen with music
function showDevSplashScreen() {
    const splash = document.getElementById('devSplashScreen');
    const audio = document.getElementById('splashAudio');
    
    if (!splash) return;
    
    // Show splash screen
    splash.style.display = 'flex';
    setTimeout(() => {
        splash.classList.add('show');
    }, 10);
    
    // Play music with autoplay handling
    if (audio) {
        audio.currentTime = 0;
        audio.volume = 0.15; // 15% volume (reduced by half)
        audio.play().catch(error => {
            console.log('Audio autoplay prevented:', error);
            // Try to play on first user interaction
            const playOnInteraction = () => {
                audio.volume = 0.15; // 15% volume (reduced by half)
                audio.play().catch(e => console.log('Still cannot play:', e));
                document.removeEventListener('click', playOnInteraction);
                document.removeEventListener('touchstart', playOnInteraction);
            };
            document.addEventListener('click', playOnInteraction);
            document.addEventListener('touchstart', playOnInteraction);
        });
    }
    
    console.log('üé¨ Developer splash screen shown with music');
}

// Hide developer splash screen
function hideDevSplashScreen() {
    const splash = document.getElementById('devSplashScreen');
    const audio = document.getElementById('splashAudio');
    
    if (!splash) return;
    
    // Fade out
    splash.classList.remove('show');
    splash.classList.add('hide');
    
    // Stop music
    if (audio) {
        audio.pause();
        audio.currentTime = 0;
    }
    
    // Remove from DOM after animation
    setTimeout(() => {
        splash.style.display = 'none';
        splash.classList.remove('hide');
    }, 500);
    
    console.log('üé¨ Developer splash screen hidden');
}

// Monitor for data changes
async function monitorForChanges() {
    if (!isMonitoringActive) return;
    
    try {
        // Check plan-data.json for changes
        const response = await fetch('./plan-data.json?t=' + Date.now());
        if (response.ok) {
            const data = await response.json();
            const currentHash = calculateDataHash(data);
            
            // If hash changed, show splash screen
            if (lastKnownDataHash !== null && currentHash !== lastKnownDataHash) {
                console.log('üì¶ Data change detected!');
                showDevSplashScreen();
                
                // Auto-hide after 3 seconds
                clearTimeout(splashScreenTimer);
                splashScreenTimer = setTimeout(() => {
                    hideDevSplashScreen();
                }, 3000);
            }
            
            lastKnownDataHash = currentHash;
        }
    } catch (error) {
        console.log('Monitor error:', error);
    }
    
    // Check again in 3 seconds
    setTimeout(monitorForChanges, 3000);
}

// Start monitoring when page loads
window.addEventListener('load', function() {
    // Calculate initial hash
    if (typeof inspectionData !== 'undefined') {
        lastKnownDataHash = calculateDataHash({
            inspectionData,
            inspectors: inspectorsData,
            areas: areasData
        });
    }
    
    // Start monitoring after 5 seconds
    setTimeout(() => {
        isMonitoringActive = true;
        monitorForChanges();
        console.log('üëÄ File change monitoring started');
    }, 5000);
});

// Manual trigger for developers (can be called from console)
window.showSplash = showDevSplashScreen;
window.hideSplash = hideDevSplashScreen;

// Detect when saveInspectionData is called (when developer makes edits)
const originalSaveInspectionData = window.saveInspectionData;
if (typeof originalSaveInspectionData === 'function') {
    window.saveInspectionData = function() {
        // Show splash screen when saving
        showDevSplashScreen();
        
        // Call original function
        const result = originalSaveInspectionData.apply(this, arguments);
        
        // Auto-hide after 5 seconds
        clearTimeout(splashScreenTimer);
        splashScreenTimer = setTimeout(() => {
            hideDevSplashScreen();
        }, 5000);
        
        return result;
    };
}

// Detect GitHub save operations
const originalSaveDirectToGitHub = window.saveDirectToGitHub;
if (typeof originalSaveDirectToGitHub === 'function') {
    window.saveDirectToGitHub = async function() {
        // Show splash screen
        showDevSplashScreen();
        
        try {
            // Call original function
            const result = await originalSaveDirectToGitHub.apply(this, arguments);
            
            // Auto-hide after 5 seconds
            clearTimeout(splashScreenTimer);
            splashScreenTimer = setTimeout(() => {
                hideDevSplashScreen();
            }, 5000);
            
            return result;
        } catch (error) {
            // Hide on error too
            setTimeout(hideDevSplashScreen, 1000);
            throw error;
        }
    };
}

</script>
</body>
</html>
