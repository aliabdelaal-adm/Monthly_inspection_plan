<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>خطة التفتيش الشهرية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family:'Segoe UI',Arial,sans-serif; background:#f6f6f6; margin:0; padding:0;}
    .container { max-width:950px; margin:40px auto; background:#fff; border-radius:10px; box-shadow:0 0 10px #bbb; padding:28px;}
    .header { background:#2336a0; color:#fff; font-size:1.6em; text-align:center; padding:16px 0; border-radius:8px; margin-bottom:24px;}
    .update-alert { background:#c00; color:#fff; text-align:center; font-size:1.17em; padding:12px 6px; border-radius:6px; margin-bottom:18px; display:none;}
    .section-title { background:#e2e6f6; font-size:1.17em; font-weight:bold; margin:22px 0 10px 0; padding:7px 0; border-radius:6px; text-align:right;}
    .section-title.red { color:#c00; }
    .btn-main { background:#2336a0; color:#fff; border:none; border-radius:4px; padding:8px 22px; font-size:1em; cursor:pointer; margin-bottom:10px;}
    .btn-main:hover { background:#2a43c7; }
    .shops-cell-btn {background:#e2e6f6; color:#2336a0; border:none; border-radius:4px; padding:6px 17px; font-size:1em; cursor:pointer;}
    .shops-cell-btn:hover {background:#bed3fa;}
    table {width:100%; border-collapse:collapse; background:#fafafa;}
    th,td {border:1px solid #bbb; padding:12px 6px; text-align:center; vertical-align:middle; font-size:1.09em;}
    th {background:#2336a0; color:#fff;}
    .goals-cell { text-align:right; background:#f3f7ff; color:#2336a0; font-weight:bold; font-size:1.09em;}
    .goals-red { color:#c00; font-weight:bold; }
    .copyright { text-align:center; color:#2336a0; font-weight:bold; margin-top:30px; font-size:1.1em;}
    /* Popup shops */
    .shop-list-popup-bg {position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.13);z-index:2200;display:flex;align-items:center;justify-content:center;}
    .shop-list-popup {text-align:right; padding:18px; background:#fff; border-radius:10px; box-shadow:0 4px 20px #aaa; min-width:220px;}
    .shop-list-popup ul {list-style:none; padding:0; margin:0;}
    .shop-list-popup ul li {padding:7px 0; border-bottom:1px solid #eee; color:#2336a0;}
    .shop-list-popup-close {background:#c00; color:#fff; border:none; border-radius:4px; padding:4px 14px; font-size:1em; cursor:pointer; margin-top:10px;}
    .shop-list-popup-close:hover {background:#a00;}
    @media print { .btn-main, .copyright, .update-alert, .shop-list-popup-bg { display:none !important;} body { background:#fff; } .container{box-shadow:none;} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">خطة التفتيش الشهرية</div>
    <div id="updateAlert" class="update-alert"></div>
    <div style="text-align:left; margin-bottom:12px;">
      <button class="btn-main" onclick="window.print()">طباعة أو حفظ PDF</button>
    </div>
    <div class="section-title red">جدول التفتيش</div>
    <div id="planTable"></div>
    <div class="section-title red">أهداف التفتيش هذا الشهر:</div>
    <div id="goalsSection" class="goals-cell"></div>
    <div class="copyright">
      جميع الحقوق محفوظة &copy; المطور د. علي عبدالعال
    </div>
    <div id="shopListPopupBg" class="shop-list-popup-bg" style="display:none;">
      <div id="shopListPopup" class="shop-list-popup"></div>
    </div>
  </div>
  <script>
    // إعداد جلب الخطة من GitHub تلقائياً
    const PLAN_URL = "https://raw.githubusercontent.com/aliabdelaal-adm/Monthly_inspection_plan/main/plan-data.json";
    const API_URL  = "https://api.github.com/repos/aliabdelaal-adm/Monthly_inspection_plan/commits?path=plan-data.json&per_page=1";

    let planData = {}, lastSha = "";
    // check for update
    function checkForUpdate() {
      fetch(API_URL)
        .then(r=>r.json())
        .then(commits=>{
          if(Array.isArray(commits) && commits[0] && commits[0].sha){
            let newSha = commits[0].sha;
            lastSha = localStorage.getItem("lastPlanSha") || "";
            if(newSha !== lastSha && lastSha) {
              document.getElementById("updateAlert").innerHTML = 'يوجد تحديث جديد في خطة التفتيش! <a href="#" onclick="reloadPlan()" style="color:#fff;text-decoration:underline;">اضغط هنا لعرض الخطة الجديدة.</a>';
              document.getElementById("updateAlert").style.display = "block";
            } else {
              document.getElementById("updateAlert").style.display = "none";
            }
          }
        });
    }
    function reloadPlan() {
      localStorage.removeItem("lastPlanSha");
      location.reload();
    }

    function renderPlanTable() {
      let html = `<table>
        <thead>
          <tr>
            <th>اسم المفتش</th>
            <th>اليوم</th>
            <th>وقت المناوبة</th>
            <th>المنطقة</th>
            <th>المحلات</th>
          </tr>
        </thead>
        <tbody>
      `;
      (planData.distribution||[]).forEach((row, idx) => {
        html += `<tr>
          <td>${row.inspector||""}</td>
          <td>${row.day||""}</td>
          <td>${row.shift||""}</td>
          <td>${row.area||""}</td>
          <td>
            <button class="shops-cell-btn" onclick="showShopListPopup(${idx})">عرض المحلات</button>
          </td>
        </tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById("planTable").innerHTML = html;
    }
    function renderGoals() {
      document.getElementById("goalsSection").innerHTML = `<span class="goals-red">${(planData.goals||"").replace(/\n/g, "<br>")}</span>`;
    }
    function showShopListPopup(distIndex) {
      let dist = (planData.distribution||[])[distIndex] || {};
      let shops = dist.shops || [];
      let bg = document.getElementById("shopListPopupBg");
      let popup = document.getElementById("shopListPopup");
      let html = `<strong>المحلات المرجو تفتيشها:</strong><ul>`;
      if(shops.length) {
        shops.forEach(shop => {
          html += `<li>${shop}</li>`;
        });
      } else {
        html += `<li style="color:#c00;">لا توجد محلات محددة</li>`;
      }
      html += `</ul><button class="shop-list-popup-close" onclick="closeShopListPopup()">إغلاق</button>`;
      popup.innerHTML = html;
      bg.style.display = "flex";
    }
    function closeShopListPopup() {
      document.getElementById("shopListPopupBg").style.display = "none";
    }
    window.onclick = function(e){
      let bg = document.getElementById("shopListPopupBg");
      if(bg.style.display==="flex" && e.target === bg) closeShopListPopup();
    }

    // تحميل الخطة من GitHub تلقائياً
    fetch(PLAN_URL + '?'+Date.now())
      .then(r=>r.json())
      .then(plan=>{
        planData = plan;
        renderPlanTable();
        renderGoals();
        // حفظ sha الخطة الحالية بعد تحميلها (لمنع التكرار في رسالة التنبيه)
        fetch(API_URL)
          .then(r=>r.json())
          .then(commits=>{
            if(Array.isArray(commits) && commits[0] && commits[0].sha){
              localStorage.setItem("lastPlanSha", commits[0].sha);
            }
          });
      });

    // تحقق من وجود تحديثات جديدة عند تحميل الصفحة
    checkForUpdate();
  </script>
</body>
</html>