<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>واجهة إدارة خطة التفتيش الشهرية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: 'Cairo', Tahoma, Arial, sans-serif;
            background: #f7f8fa;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1100px;
            margin: 40px auto 24px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 32px #0002;
            padding: 32px 24px 24px 24px;
            direction: rtl;
        }
        .main-title {
            background: #234093;
            color: #fff;
            border-radius: 10px;
            padding: 18px 0;
            text-align: center;
            font-size: 2em;
            margin-bottom: 24px;
            letter-spacing: 1px;
        }
        /* CSS خاص بالطباعة - إظهار المحلات بدلاً من الأزرار */
        @media print {
            .shop-btn {
                display: none !important;
            }
            .shops-list-print {
                display: block !important;
            }
            /* تحسين التنسيق العام للطباعة */
            .main-title {
                font-size: 1.5em;
                margin-bottom: 20px;
            }
            .top-bar {
                display: none !important;
            }
            .api-token-bar {
                display: none !important;
            }
            .modal-overlay {
                display: none !important;
            }
        }
        /* إخفاء قائمة المحلات في العرض العادي */
        .shops-list-print {
            display: none;
            font-size: 0.9em;
            line-height: 1.4;
            white-space: pre-line;
        }
        .top-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
            gap: 1.5rem;
            direction: rtl;
        }
        .top-bar label, .top-bar .user-type-label {
            font-size: 1.1em;
            margin-left: 8px;
        }
        .top-bar select, .top-bar button {
            font-size: 1em;
            border-radius: 7px;
            border: 1px solid #ccc;
            padding: 8px 14px;
            margin-right: 8px;
        }
        .top-bar button {
            background: #234093;
            color: #fff;
            border: none;
            margin: 0 4px;
            cursor: pointer;
            transition: 0.2s;
        }
        .top-bar button:hover {
            background: #1a2c67;
        }
        /* ========== API Token Bar ========== */
        .api-token-bar {
            margin-bottom: 18px;
            text-align: left;
            direction: ltr;
            padding: 8px 12px;
            background: #e6eeff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
        }
        .api-token-bar label {
            font-size: 1.06em;
            color: #234093;
            margin-left: 8px;
        }
        .api-token-bar input[type="password"], .api-token-bar input[type="text"] {
            border: 1px solid #bbb;
            border-radius: 5px;
            padding: 6px 10px;
            font-size: 1em;
            width: 240px;
        }
        .api-token-bar button {
            background: #234093;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 6px 18px;
            font-size: 1em;
            cursor: pointer;
        }
        .api-token-bar .api-token-saved {
            color: #388e3c;
            margin-right: 8px;
        }
        .api-token-bar .api-token-warning {
            color: #d32f2f;
            margin-right: 8px;
        }
        /* ========== باقي التنسيقات الأصلية ========== */
        .admin-panel {
            margin: 32px 0 32px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 28px;
        }
        .admin-section {
            background: #f3f6fe;
            border: 1px solid #e0e7f7;
            border-radius: 14px;
            padding: 24px 18px 18px 18px;
            box-shadow: 0px 1.5px 6px #23409311;
            margin-bottom: 24px;
        }
        .admin-section h3 {
            color: #1a2c67;
            margin-top: 0;
            font-size: 1.13em;
            margin-bottom: 18px;
        }
        .add-row-form {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
            align-items: center;
        }
        .add-row-form input[type="text"] {
            flex: 1;
            font-size: 1em;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #bbb;
        }
        .add-row-form button {
            background: #234093;
            color: #fff;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: 0.2s;
        }
        .admin-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .admin-list li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            margin-bottom: 7px;
            border-radius: 7px;
            padding: 7px 10px;
            border: 1px solid #e3e6f0;
        }
        .admin-list .list-actions button {
            margin-right: 5px;
            font-size: 0.97em;
            padding: 4px 12px;
            border-radius: 5px;
        }
        .edit-btn {
            background: #efb400;
            color: #fff;
            border: none;
        }
        .edit-btn:hover {
            background: #b28a00;
        }
        .save-btn {
            background: #388e3c;
            color: #fff;
            border: none;
        }
        .delete-btn {
            background: #d32f2f;
            color: #fff;
            border: none;
        }
        .delete-btn:hover {
            background: #b71c1c;
        }
        .goal-section {
            background: #e5f7ef;
            border: 1px solid #81c6ae;
            border-radius: 14px;
            padding: 24px 18px 18px 18px;
            box-shadow: 0px 1.5px 6px #046a4433;
            margin-top: 30px;
        }
        .goal-section h3 {
            color: #046a44;
            margin-top: 0;
            font-size: 1.13em;
            margin-bottom: 18px;
        }
        .goal-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .goal-list li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            margin-bottom: 7px;
            border-radius: 7px;
            padding: 7px 10px;
            border: 1px solid #b2dfdb;
        }
        .goal-list .list-actions button {
            margin-right: 5px;
            font-size: 0.97em;
            padding: 4px 12px;
            border-radius: 5px;
        }
        .goal-edit-btn {
            background: #009688;
            color: #fff;
        }
        .goal-save-btn {
            background: #388e3c;
            color: #fff;
        }
        .goal-delete-btn {
            background: #d32f2f;
            color: #fff;
        }
        .goal-delete-btn:hover {
            background: #b71c1c;
        }
        /* توزيع المحلات */
        .shops-area-box {
            background: #e9ebf6;
            border-radius: 10px;
            padding: 18px 10px 10px 10px;
            margin-bottom: 20px;
        }
        .shops-area-title {
            font-size: 1.07em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .shop-area-tag {
            background: #234093;
            color: #fff;
            border-radius: 18px;
            padding: 4px 16px 4px 16px;
            display: inline-block;
            margin: 2px 4px;
        }
        .shop-area-tag button {
            background: #c22;
            color: #fff;
            border: none;
            border-radius: 50%;
            margin-right: 4px;
            font-size: 1.1em;
            cursor: pointer;
        }
        .distribution-table th, .distribution-table td {
            text-align: center;
            padding: 7px 6px;
        }
        .distribution-table th {
            background: #234093;
            color: #fff;
        }
        .distribution-table td button {
            background: #c22;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 4px 10px;
        }
        /* المفتش */
        .section-box {
            background: #f4f6fa;
            border-radius: 14px;
            margin-bottom: 30px;
            box-shadow: 0px 1.5px 6px #23409311;
        }
        .table-title, .stats-title {
            color: #c00;
            font-size: 1.15em;
            font-weight: bold;
            margin: 16px 0 8px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            margin-bottom: 10px;
        }
        th, td {
            border: 1px solid #bbb;
            padding: 12px 6px;
            text-align: center;
            vertical-align: middle;
            font-size: 1.09em;
        }
        th {
            background: #234093;
            color: #fff;
        }
        .shop-btn {
            background: #e5eaff;
            color: #234093;
            border: none;
            border-radius: 7px;
            padding: 6px 16px;
            cursor: pointer;
            font-size: 1em;
            transition: 0.2s;
        }
        .shop-btn:hover {
            background: #b2c5fa;
        }
        .goals-section {
            background: #e5f7ef;
            border: 1px solid #81c6ae;
            border-radius: 14px;
            padding: 16px 12px 10px 12px;
            margin-bottom: 15px;
        }
        .goals-section h3 {
            color: #046a44;
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }
        .goals-section ul {
            margin: 0;
            padding-right: 20px;
        }
        .goals-section li {
            color: #046a44;
            margin-bottom: 4px;
            font-size: 1.01em;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 8px;
            background: #fff;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .stats-table th, .stats-table td {
            border: 1px solid #234093;
            padding: 12px 8px;
            text-align: center;
            font-size: 1em;
            width: 25%; /* أعمدة متساوية */
        }
        .stats-table th {
            background: #234093;
            color: #fff;
            font-size: 0.85em; /* تصغير حجم خط التواريخ في رأس الجدول */
            font-weight: bold;
        }
        .stats-table tfoot td {
            background: #e8f4f8;
            font-weight: bold;
            color: #234093;
            border: 2px solid #234093; /* صف الإجمالي بارز وواضح */
            font-size: 1.1em;
        }
        .stats-total-cell {
            color: #c00;
            font-weight: bold;
        }
        /* تحسين تنسيق جدول التفتيش */
        #inspectionTable th, #inspectionTable td {
            text-align: center;
            padding: 12px 8px;
            border: 1px solid #ddd;
            width: 25%; /* أعمدة متساوية */
        }
        #inspectionTable th {
            background: #234093;
            color: #fff;
            font-weight: bold;
        }
        #inspectionTable tbody tr:nth-child(even) {
            background-color: #f8f9fa; /* ألوان متناوبة للصفوف */
        }
        #inspectionTable tbody tr:hover {
            background-color: #e8f4f8; /* تمييز الصف عند المرور */
        }
        .copyright {
            text-align: center;
            color: #234093;
            font-weight: bold;
            margin-top: 20px;
            font-size: 1.08em;
        }
        /* نافذة المحلات ونافذة الرقم السري */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.36);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            padding: 32px 26px 22px 26px;
            border-radius: 18px;
            box-shadow: 0 2px 16px #0002;
            min-width: 260px;
            max-width: 350px;
            text-align: center;
        }
        .modal-content button {
            background: #234093;
            color: #fff;
            border: none;
            padding: 8px 22px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 10px;
        }
        .modal-content label {
            font-size: 1.08em;
            color: #234093;
            margin-bottom: 16px;
            display: block;
        }
        .modal-content input[type="password"] {
            font-size: 1.08em;
            padding: 7px 12px;
            border: 1.5px solid #ccc;
            border-radius: 8px;
            margin-bottom: 14px;
            text-align: center;
        }
        .modal-content .error-msg {
            color: #d32f2f;
            margin-bottom: 8px;
        }
        @media (max-width: 900px) {
            .container { padding: 14px 2px 8px 2px; }
            .main-title { font-size: 1.22em; padding: 11px 0; }
            .admin-panel { grid-template-columns: 1fr; gap: 16px; }
            .admin-section, .goal-section, .inspect-section, .section-box { padding: 13px 4px 13px 4px;}
        }
        /* ========== GitHub Upload Button Styles ========== */
        .github-upload-section {
            margin-top: 12px;
            padding: 10px;
            background: #f0f8ff;
            border-radius: 8px;
            border: 1px solid #c5d9f1;
            display: none; /* Hidden by default, shown only in developer mode */
        }
        .github-upload-btn {
            background: #28a745;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 1em;
            cursor: pointer;
            margin-right: 10px;
            transition: 0.2s;
        }
        .github-upload-btn:hover {
            background: #218838;
        }
        .github-upload-btn:disabled {
            background: #999;
            cursor: not-allowed;
        }
        .upload-status {
            display: inline-block;
            margin-right: 8px;
            font-weight: bold;
        }
        .upload-status.success {
            color: #28a745;
        }
        .upload-status.error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-title">واجهة إدارة خطة التفتيش الشهرية - نسخة المطور</div>
        
        <!-- شريط أدوات المطور -->
        <div class="top-bar">
            <div>
                <label class="user-type-label">وضع المطور:</label>
                <button onclick="enterDeveloperMode()">دخول وضع المطور</button>
                <button onclick="exitDeveloperMode()" id="exitDevBtn" style="display:none;">خروج من وضع المطور</button>
            </div>
            <div>
                <button onclick="window.print()">طباعة</button>
                <button onclick="loadInspectionPlan()">تحديث البيانات</button>
            </div>
        </div>

        <!-- شريط API Token - يظهر فقط في وضع المطور -->
        <div class="api-token-bar" id="apiTokenBar" style="display:none;">
            <label>GitHub Token:</label>
            <input type="password" id="githubToken" placeholder="GitHub Personal Access Token">
            <button onclick="saveGitHubToken()">حفظ التوكن</button>
            <span class="api-token-saved" id="tokenSaved" style="display:none;">✓ محفوظ</span>
            <span class="api-token-warning" id="tokenWarning" style="display:none;">⚠ غير محفوظ</span>
            
            <!-- قسم رفع التعديلات إلى GitHub -->
            <div class="github-upload-section" id="githubUploadSection">
                <button class="github-upload-btn" id="uploadBtn" onclick="uploadToGitHub()">
                    رفع التعديل تلقائيًا إلى GitHub
                </button>
                <span class="upload-status" id="uploadStatus"></span>
            </div>
        </div>

        <!-- باقي المحتوى -->
        <div id="mainContent">
            <p>جاري تحميل البيانات...</p>
        </div>

        <div class="copyright">
            تم التطوير بواسطة &copy; المطور د. علي عبدالعال
        </div>
    </div>

    <!-- نافذة إدخال كلمة السر -->
    <div class="modal-overlay" id="passwordModal" style="display:none;">
        <div class="modal-content">
            <label>أدخل كلمة السر للوصول إلى وضع المطور:</label>
            <input type="password" id="developerPassword" placeholder="كلمة السر">
            <div class="error-msg" id="passwordError"></div>
            <button onclick="checkDeveloperPassword()">دخول</button>
            <button onclick="closePasswordModal()">إلغاء</button>
        </div>
    </div>

    <script>
        // إعدادات المطور
        const DEVELOPER_PASSWORD = "dev123"; // كلمة سر المطور
        const REPO = "aliabdelaal-adm/Monthly_inspection_plan";
        const HTML_FILE_PATH = "index_after.html.html";
        let isDevMode = false;
        let htmlFileSha = "";

        // ========== إدارة وضع المطور ==========
        function enterDeveloperMode() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('developerPassword').focus();
        }

        function checkDeveloperPassword() {
            const password = document.getElementById('developerPassword').value;
            if (password === DEVELOPER_PASSWORD) {
                isDevMode = true;
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('apiTokenBar').style.display = 'flex';
                document.getElementById('exitDevBtn').style.display = 'inline-block';
                document.getElementById('passwordError').textContent = '';
                document.getElementById('developerPassword').value = '';
                
                // إظهار قسم رفع التعديلات إذا كان التوكن محفوظ
                if (getGitHubToken()) {
                    document.getElementById('githubUploadSection').style.display = 'block';
                }
                
                loadTokenStatus();
            } else {
                document.getElementById('passwordError').textContent = 'كلمة السر غير صحيحة!';
            }
        }

        function exitDeveloperMode() {
            isDevMode = false;
            document.getElementById('apiTokenBar').style.display = 'none';
            document.getElementById('exitDevBtn').style.display = 'none';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('passwordError').textContent = '';
            document.getElementById('developerPassword').value = '';
        }

        // ========== إدارة GitHub Token ==========
        function getGitHubToken() {
            return localStorage.getItem('githubDevToken') || '';
        }

        function saveGitHubToken() {
            const token = document.getElementById('githubToken').value.trim();
            if (token) {
                localStorage.setItem('githubDevToken', token);
                loadTokenStatus();
                document.getElementById('githubUploadSection').style.display = 'block';
            }
        }

        function loadTokenStatus() {
            const token = getGitHubToken();
            if (token) {
                document.getElementById('githubToken').value = token;
                document.getElementById('tokenSaved').style.display = 'inline';
                document.getElementById('tokenWarning').style.display = 'none';
            } else {
                document.getElementById('tokenSaved').style.display = 'none';
                document.getElementById('tokenWarning').style.display = 'inline';
            }
        }

        // ========== رفع التعديلات إلى GitHub ==========
        async function uploadToGitHub() {
            const token = getGitHubToken();
            if (!token) {
                showUploadStatus('يجب حفظ التوكن أولاً!', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            showUploadStatus('جاري رفع التعديلات...', '');

            try {
                // الحصول على SHA الحالي للملف
                await fetchCurrentFileSha();
                
                // الحصول على محتوى الملف الحالي
                const currentContent = document.documentElement.outerHTML;
                
                // تنظيف المحتوى (إزالة الـ viewport tags المكررة)
                const cleanContent = currentContent.replace(
                    /^<meta name='viewport'[^>]*\/><meta name='viewport'[^>]*\/>/,
                    ''
                );
                
                // تحويل المحتوى إلى base64
                const contentBase64 = btoa(unescape(encodeURIComponent(cleanContent)));
                
                // رفع الملف إلى GitHub
                const response = await fetch(`https://api.github.com/repos/${REPO}/contents/${HTML_FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'تحديث واجهة المطور من خلال التطبيق',
                        content: contentBase64,
                        sha: htmlFileSha
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    htmlFileSha = result.content.sha;
                    showUploadStatus('✅ تم رفع التعديلات بنجاح!', 'success');
                } else {
                    const error = await response.json();
                    showUploadStatus(`❌ فشل في الرفع: ${error.message}`, 'error');
                }
            } catch (error) {
                showUploadStatus(`❌ خطأ: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
            }
        }

        async function fetchCurrentFileSha() {
            const token = getGitHubToken();
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO}/contents/${HTML_FILE_PATH}`, {
                    headers: {
                        'Authorization': `token ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    htmlFileSha = data.sha;
                } else {
                    throw new Error('فشل في جلب معلومات الملف');
                }
            } catch (error) {
                throw new Error(`خطأ في جلب SHA: ${error.message}`);
            }
        }

        function showUploadStatus(message, type) {
            const statusElement = document.getElementById('uploadStatus');
            statusElement.textContent = message;
            statusElement.className = `upload-status ${type}`;
            
            // إخفاء الرسالة بعد 5 ثوانٍ للرسائل الإيجابية
            if (type === 'success') {
                setTimeout(() => {
                    statusElement.textContent = '';
                    statusElement.className = 'upload-status';
                }, 5000);
            }
        }

        // ========== تحميل البيانات ==========
        function loadInspectionPlan() {
            document.getElementById('mainContent').innerHTML = '<p>تم تحديث البيانات بنجاح! هذه واجهة المطور لإدارة خطة التفتيش الشهرية.</p>';
        }

        // ========== التهيئة عند تحميل الصفحة ==========
        window.onload = function() {
            loadInspectionPlan();
            
            // مراقبة الضغط على Enter في حقل كلمة السر
            document.getElementById('developerPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkDeveloperPassword();
                }
            });
        };
    </script>
</body>
</html>