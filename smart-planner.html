<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة التخطيط الذكية للتفتيش الشهري</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .feature-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .feature-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .feature-card h3 {
            color: #2d3561;
            margin-bottom: 5px;
        }
        
        .feature-card p {
            color: #666;
            font-size: 0.9em;
        }
        
        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.8em;
            color: #2d3561;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #2d3561;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102,126,234,0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(17,153,142,0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(17,153,142,0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(250,112,154,0.3);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(250,112,154,0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 600;
            display: none;
        }
        
        .status-message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .status-message.warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
        }
        
        .shops-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .shop-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .shop-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.2);
        }
        
        .shop-card.selected {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .shop-card.high-priority {
            border-left: 5px solid #dc3545;
        }
        
        .shop-card.medium-priority {
            border-left: 5px solid #ffc107;
        }
        
        .shop-card.low-priority {
            border-left: 5px solid #28a745;
        }
        
        .shop-card .priority-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .shop-card .priority-badge.high {
            background: #dc3545;
            color: white;
        }
        
        .shop-card .priority-badge.medium {
            background: #ffc107;
            color: #212529;
        }
        
        .shop-card .priority-badge.low {
            background: #28a745;
            color: white;
        }
        
        .shop-card .shop-name {
            font-weight: 600;
            color: #2d3561;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .shop-card .shop-info {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .shop-card .last-inspection {
            font-size: 0.85em;
            color: #999;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }
        
        .selected-shops {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .selected-shops h3 {
            color: #1565c0;
            margin-bottom: 15px;
        }
        
        .selected-shops-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .selected-shop-tag {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .selected-shop-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .selected-shop-tag .remove:hover {
            color: #ffcccc;
        }
        
        .filter-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        
        .stat-box .value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-box .label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .inspection-preview {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }
        
        .inspection-preview h3 {
            color: #2d3561;
            margin-bottom: 15px;
        }
        
        .inspection-preview .preview-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .inspection-preview .preview-item strong {
            color: #667eea;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* New styles for enhanced features */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 12px 24px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            background: #f0f0ff;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .inspections-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .inspections-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .inspections-table th,
        .inspections-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .inspections-table tbody tr:hover {
            background: #f5f5f5;
        }
        
        .action-icon {
            cursor: pointer;
            font-size: 1.3em;
            margin: 0 5px;
            transition: transform 0.2s;
        }
        
        .action-icon:hover {
            transform: scale(1.2);
        }
        
        .edit-icon { color: #ffc107; }
        .delete-icon { color: #dc3545; }
        .copy-icon { color: #17a2b8; }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        
        .inspector-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-card .stat-label {
            font-size: 1em;
            color: #2d3561;
            margin-top: 5px;
        }
        
        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .calendar-day {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            min-height: 100px;
            position: relative;
        }
        
        .calendar-day .day-number {
            font-weight: 700;
            color: #2d3561;
            margin-bottom: 10px;
        }
        
        .calendar-day .inspection-badge {
            background: #667eea;
            color: white;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            margin-bottom: 5px;
            display: block;
        }
        
        .calendar-day.has-inspection {
            border-color: #667eea;
            background: #f0f0ff;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #2d3561;
        }
        
        .modal-close {
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
        }
        
        .search-box .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(231,76,60,0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(231,76,60,0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(52,152,219,0.3);
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52,152,219,0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 أداة التخطيط الذكية للتفتيش الشهري</h1>
            <p>نظام ذكي ومرن لتحديث خطة التفتيش مباشرة وفوراً مع فلترة المحلات ذات الأولوية</p>
        </div>
        
        <div class="features">
            <div class="feature-card">
                <div class="icon">⚡</div>
                <h3>تحديث فوري</h3>
                <p>التحديثات تظهر مباشرة دون رفع ملفات</p>
            </div>
            <div class="feature-card">
                <div class="icon">🎯</div>
                <h3>الأولوية الذكية</h3>
                <p>المحلات ذات الأولوية العالية تظهر أولاً</p>
            </div>
            <div class="feature-card">
                <div class="icon">🚫</div>
                <h3>منع التكرار</h3>
                <p>تجنب المحلات المكررة في نفس اليوم</p>
            </div>
            <div class="feature-card">
                <div class="icon">📅</div>
                <h3>فترة الانتظار</h3>
                <p>أسبوع واحد قبل إعادة التفتيش</p>
            </div>
            <div class="feature-card">
                <div class="icon">📝</div>
                <h3>تحرير التفتيشات</h3>
                <p>إمكانية تعديل التفتيشات السابقة</p>
            </div>
            <div class="feature-card">
                <div class="icon">👁️</div>
                <h3>عرض التفتيشات</h3>
                <p>مشاهدة جميع التفتيشات لكل مفتش</p>
            </div>
            <div class="feature-card">
                <div class="icon">🗑️</div>
                <h3>حذف تلقائي</h3>
                <p>حذف التفتيشات المكررة تلقائياً</p>
            </div>
            <div class="feature-card">
                <div class="icon">📊</div>
                <h3>إحصائيات شاملة</h3>
                <p>تقارير تفصيلية لكل مفتش</p>
            </div>
        </div>
        
        <!-- Login Section -->
        <div class="section" id="loginSection">
            <h2 class="section-title">🔐 تسجيل الدخول كمطور</h2>
            <div class="form-group">
                <label class="form-label">GitHub Token (للحفظ المباشر)</label>
                <input type="password" id="githubToken" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <small style="color: #666; display: block; margin-top: 5px;">
                    احصل على التوكن من: GitHub Settings → Developer Settings → Personal Access Tokens
                </small>
            </div>
            <button class="btn btn-primary" onclick="loginDeveloper()">
                <span>✓</span>
                <span>تسجيل الدخول</span>
            </button>
            <div class="status-message" id="loginStatus"></div>
        </div>
        
        <!-- Main Interface with Tabs -->
        <div id="mainInterface" style="display: none;">
            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('add')">
                    <span>➕</span> إضافة تفتيش جديد
                </button>
                <button class="tab-button" onclick="switchTab('view')">
                    <span>👁️</span> عرض التفتيشات
                </button>
                <button class="tab-button" onclick="switchTab('stats')">
                    <span>📊</span> إحصائيات المفتشين
                </button>
                <button class="tab-button" onclick="switchTab('calendar')">
                    <span>📅</span> التقويم الشهري
                </button>
            </div>
            
            <!-- Tab Content: Add Inspection -->
            <div id="addTab" class="tab-content active">
            <!-- Tab Content: Add Inspection -->
            <div id="addTab" class="tab-content active">
                <div class="section">
            <h2 class="section-title">📝 إضافة تفتيش جديد</h2>
            
            <div class="form-group">
                <label class="form-label">المفتش</label>
                <select id="inspectorSelect" class="form-control" onchange="updateAvailableShops()">
                    <option value="">اختر المفتش...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">التاريخ</label>
                <input type="date" id="inspectionDate" class="form-control" onchange="updateAvailableShops()">
            </div>
            
            <div class="form-group">
                <label class="form-label">المناوبة</label>
                <select id="shiftSelect" class="form-control">
                    <option value="صباحية">صباحية</option>
                    <option value="مسائية">مسائية</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">المنطقة</label>
                <select id="areaSelect" class="form-control" onchange="updateAvailableShops()">
                    <option value="">اختر المنطقة...</option>
                </select>
            </div>
            
            <!-- Filter Statistics -->
            <div class="filter-stats">
                <div class="stat-box">
                    <div class="value" id="totalShopsCount">0</div>
                    <div class="label">إجمالي المحلات</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="availableShopsCount">0</div>
                    <div class="label">المحلات المتاحة</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="highPriorityCount">0</div>
                    <div class="label">أولوية عالية</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="selectedShopsCount">0</div>
                    <div class="label">المحلات المختارة</div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">المحلات المتاحة (مرتبة حسب الأولوية)</label>
                <div id="shopsListContainer">
                    <p style="text-align: center; color: #999; padding: 20px;">
                        اختر المفتش والتاريخ والمنطقة لعرض المحلات المتاحة
                    </p>
                </div>
            </div>
            
            <!-- Selected Shops -->
            <div class="selected-shops" id="selectedShopsContainer" style="display: none;">
                <h3>المحلات المختارة للتفتيش</h3>
                <div class="selected-shops-list" id="selectedShopsList"></div>
            </div>
            
            <!-- Inspection Preview -->
            <div class="inspection-preview" id="inspectionPreview" style="display: none;">
                <h3>معاينة التفتيش</h3>
                <div class="preview-item">
                    <strong>المفتش:</strong> <span id="previewInspector">-</span>
                </div>
                <div class="preview-item">
                    <strong>التاريخ:</strong> <span id="previewDate">-</span>
                </div>
                <div class="preview-item">
                    <strong>المناوبة:</strong> <span id="previewShift">-</span>
                </div>
                <div class="preview-item">
                    <strong>المنطقة:</strong> <span id="previewArea">-</span>
                </div>
                <div class="preview-item">
                    <strong>عدد المحلات:</strong> <span id="previewShopsCount">0</span>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveInspection()" id="saveBtn" disabled>
                    <span>💾</span>
                    <span>حفظ التفتيش فوراً</span>
                </button>
                <button class="btn btn-warning" onclick="resetForm()">
                    <span>🔄</span>
                    <span>إعادة تعيين</span>
                </button>
            </div>
            
            <div class="status-message" id="planningStatus"></div>
                </div>
            </div>
            
            <!-- Tab Content: View Inspections -->
            <div id="viewTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">👁️ عرض وإدارة التفتيشات</h2>
                    
                    <!-- Filter Bar -->
                    <div class="filter-bar">
                        <div class="filter-item">
                            <label class="form-label">فلترة حسب المفتش</label>
                            <select id="filterInspector" class="form-control" onchange="filterInspections()">
                                <option value="">جميع المفتشين</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">فلترة حسب المنطقة</label>
                            <select id="filterArea" class="form-control" onchange="filterInspections()">
                                <option value="">جميع المناطق</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="form-label">من تاريخ</label>
                            <input type="date" id="filterDateFrom" class="form-control" onchange="filterInspections()">
                        </div>
                        <div class="filter-item">
                            <label class="form-label">إلى تاريخ</label>
                            <input type="date" id="filterDateTo" class="form-control" onchange="filterInspections()">
                        </div>
                    </div>
                    
                    <!-- Search Box -->
                    <div class="search-box">
                        <input type="text" id="searchBox" class="form-control" 
                               placeholder="بحث في التفتيشات (اسم المفتش، المنطقة، المحلات...)" 
                               oninput="filterInspections()">
                        <span class="search-icon">🔍</span>
                    </div>
                    
                    <!-- Inspections Table -->
                    <div id="inspectionsTableContainer">
                        <p style="text-align: center; color: #999; padding: 40px;">جاري تحميل التفتيشات...</p>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-danger btn-sm" onclick="deleteSelectedInspections()">
                            <span>🗑️</span> حذف المحدد
                        </button>
                        <button class="btn btn-info btn-sm" onclick="exportInspections()">
                            <span>📥</span> تصدير البيانات
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Statistics -->
            <div id="statsTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">📊 إحصائيات المفتشين</h2>
                    
                    <div class="form-group">
                        <label class="form-label">اختر المفتش</label>
                        <select id="statsInspector" class="form-control" onchange="loadInspectorStats()">
                            <option value="">اختر المفتش...</option>
                        </select>
                    </div>
                    
                    <div id="statsContainer">
                        <div class="empty-state">
                            <div class="icon">📊</div>
                            <p>اختر مفتشاً لعرض الإحصائيات</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Calendar -->
            <div id="calendarTab" class="tab-content">
                <div class="section">
                    <h2 class="section-title">📅 التقويم الشهري</h2>
                    
                    <div class="form-group">
                        <label class="form-label">اختر الشهر</label>
                        <input type="month" id="calendarMonth" class="form-control" onchange="loadCalendar()">
                    </div>
                    
                    <div id="calendarContainer">
                        <div class="empty-state">
                            <div class="icon">📅</div>
                            <p>اختر الشهر لعرض التقويم</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>✏️ تحرير التفتيش</h2>
                    <span class="modal-close" onclick="closeEditModal()">&times;</span>
                </div>
                <input type="hidden" id="editInspectionIndex">
                <div class="form-group">
                    <label class="form-label">المفتش</label>
                    <select id="editInspector" class="form-control">
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">التاريخ</label>
                    <input type="date" id="editDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">المناوبة</label>
                    <select id="editShift" class="form-control">
                        <option value="صباحية">صباحية</option>
                        <option value="مسائية">مسائية</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">المنطقة</label>
                    <select id="editArea" class="form-control">
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">المحلات (مفصولة بفواصل)</label>
                    <textarea id="editShops" class="form-control" rows="6" 
                              placeholder="محل 1، محل 2، محل 3..."></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveEditedInspection()">
                        <span>💾</span> حفظ التغييرات
                    </button>
                    <button class="btn btn-warning" onclick="closeEditModal()">
                        <span>✕</span> إلغاء
                    </button>
                </div>
                <div class="status-message" id="editStatus"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let planData = null;
        let shopsDetails = null;
        let selectedShops = [];
        let githubToken = null;
        const repo = "aliabdelaal-adm/Monthly_inspection_plan";
        let currentEditingIndex = -1;
        let selectedInspectionsForDelete = [];
        
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'view') {
                loadInspectionsView();
            } else if (tabName === 'stats') {
                populateStatsInspector();
            } else if (tabName === 'calendar') {
                // Set default month to current month
                const now = new Date();
                document.getElementById('calendarMonth').value = 
                    `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                loadCalendar();
            }
        }
        
        // Login developer
        async function loginDeveloper() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                showMessage('loginStatus', 'error', '❌ يرجى إدخال GitHub Token');
                return;
            }
            
            githubToken = token;
            localStorage.setItem('devToken', token);
            
            showMessage('loginStatus', 'info', '⏳ جاري التحقق من الصلاحيات...');
            
            try {
                // Load data from GitHub
                await loadPlanData();
                await loadShopsDetails();
                
                // Initialize UI
                populateInspectors();
                populateAreas();
                populateFilterDropdowns();
                
                // Set default date to today
                document.getElementById('inspectionDate').valueAsDate = new Date();
                
                // Hide login section and show main interface
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainInterface').style.display = 'block';
                
                showMessage('loginStatus', 'success', '✅ تم تسجيل الدخول بنجاح!');
                
            } catch (error) {
                showMessage('loginStatus', 'error', '❌ فشل تحميل البيانات: ' + error.message);
                githubToken = null;
            }
        }
        
        // Load plan data from GitHub
        async function loadPlanData() {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!res.ok) {
                throw new Error('فشل تحميل plan-data.json');
            }
            
            const file = await res.json();
            planData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
        }
        
        // Load shops details from GitHub
        async function loadShopsDetails() {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!res.ok) {
                throw new Error('فشل تحميل shops_details.json');
            }
            
            const file = await res.json();
            shopsDetails = JSON.parse(decodeURIComponent(escape(atob(file.content))));
        }
        
        // Populate inspectors dropdown
        function populateInspectors() {
            const select = document.getElementById('inspectorSelect');
            select.innerHTML = '<option value="">اختر المفتش...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const option = document.createElement('option');
                    option.value = inspector.name;
                    option.textContent = inspector.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Populate areas dropdown
        function populateAreas() {
            const select = document.getElementById('areaSelect');
            select.innerHTML = '<option value="">اختر المنطقة...</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.name;
                    option.textContent = area.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Update available shops based on selection
        function updateAvailableShops() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector || !date || !area) {
                document.getElementById('shopsListContainer').innerHTML = 
                    '<p style="text-align: center; color: #999; padding: 20px;">اختر المفتش والتاريخ والمنطقة لعرض المحلات المتاحة</p>';
                return;
            }
            
            // Get all shops for the selected area
            const allShops = getAllShopsInArea(area);
            
            // Filter shops based on smart rules
            const availableShops = filterSmartShops(allShops, inspector, date);
            
            // Sort shops by priority
            const sortedShops = sortShopsByPriority(availableShops, inspector, date);
            
            // Update statistics
            updateStatistics(allShops.length, availableShops.length, sortedShops);
            
            // Display shops
            displayShops(sortedShops);
        }
        
        // Get all shops in an area
        function getAllShopsInArea(area) {
            const shops = [];
            
            if (!planData || !planData.inspectionData) return shops;
            
            // Collect all unique shops from the area
            const shopSet = new Set();
            planData.inspectionData.forEach(inspection => {
                if (inspection.area === area && inspection.shops) {
                    inspection.shops.forEach(shop => shopSet.add(shop));
                }
            });
            
            return Array.from(shopSet);
        }
        
        // Filter shops based on smart rules
        function filterSmartShops(shops, inspector, date) {
            const available = [];
            
            shops.forEach(shop => {
                // Rule 1: Check if shop is already assigned to ANY inspector on the same day
                const assignedToday = isShopAssignedToday(shop, date);
                
                // Rule 2: Check if shop was inspected by THIS inspector in the last 7 days
                const recentlyInspected = wasShopRecentlyInspected(shop, inspector, date);
                
                // If shop passes both rules, it's available
                if (!assignedToday && !recentlyInspected) {
                    available.push(shop);
                }
            });
            
            return available;
        }
        
        // Check if shop is already assigned to any inspector on the same day
        function isShopAssignedToday(shop, date) {
            if (!planData || !planData.inspectionData) return false;
            
            return planData.inspectionData.some(inspection => {
                return inspection.day === date && 
                       inspection.shops && 
                       inspection.shops.includes(shop);
            });
        }
        
        // Check if shop was recently inspected by the same inspector (within 7 days)
        function wasShopRecentlyInspected(shop, inspector, date) {
            if (!planData || !planData.inspectionData) return false;
            
            const targetDate = new Date(date);
            const sevenDaysAgo = new Date(targetDate);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            return planData.inspectionData.some(inspection => {
                if (inspection.inspector !== inspector) return false;
                if (!inspection.shops || !inspection.shops.includes(shop)) return false;
                
                const inspectionDate = new Date(inspection.day);
                return inspectionDate > sevenDaysAgo && inspectionDate < targetDate;
            });
        }
        
        // Sort shops by priority
        function sortShopsByPriority(shops, inspector, date) {
            return shops.map(shop => {
                const priority = calculateShopPriority(shop, inspector, date);
                return { name: shop, priority: priority.level, score: priority.score, reason: priority.reason };
            }).sort((a, b) => b.score - a.score);
        }
        
        // Calculate shop priority
        function calculateShopPriority(shop, inspector, date) {
            let score = 0;
            let reasons = [];
            
            // Find last inspection date for this shop (by any inspector)
            const lastInspection = getLastInspectionDate(shop);
            
            if (!lastInspection) {
                score += 100; // Never inspected = highest priority
                reasons.push('لم يتم تفتيشه من قبل');
            } else {
                const targetDate = new Date(date);
                const lastDate = new Date(lastInspection);
                const daysSince = Math.floor((targetDate - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysSince > 30) {
                    score += 80;
                    reasons.push(`آخر تفتيش قبل ${daysSince} يوم`);
                } else if (daysSince > 21) {
                    score += 60;
                    reasons.push(`آخر تفتيش قبل ${daysSince} يوم`);
                } else if (daysSince > 14) {
                    score += 40;
                    reasons.push(`آخر تفتيش قبل ${daysSince} يوم`);
                } else {
                    score += 20;
                    reasons.push(`آخر تفتيش قبل ${daysSince} يوم`);
                }
            }
            
            // Priority based on shop type (if available in shops_details)
            if (shopsDetails && shopsDetails[shop]) {
                const activity = shopsDetails[shop].activity || '';
                if (activity.includes('يجب تسجيلها')) {
                    score += 30;
                    reasons.push('نشاط يتطلب التسجيل');
                }
            }
            
            // Determine priority level
            let level = 'low';
            if (score >= 80) level = 'high';
            else if (score >= 50) level = 'medium';
            
            return { level, score, reason: reasons.join(' - ') };
        }
        
        // Get last inspection date for a shop
        function getLastInspectionDate(shop) {
            if (!planData || !planData.inspectionData) return null;
            
            let lastDate = null;
            
            planData.inspectionData.forEach(inspection => {
                if (inspection.shops && inspection.shops.includes(shop)) {
                    if (!lastDate || inspection.day > lastDate) {
                        lastDate = inspection.day;
                    }
                }
            });
            
            return lastDate;
        }
        
        // Update statistics
        function updateStatistics(total, available, sortedShops) {
            document.getElementById('totalShopsCount').textContent = total;
            document.getElementById('availableShopsCount').textContent = available;
            
            const highPriority = sortedShops.filter(s => s.priority === 'high').length;
            document.getElementById('highPriorityCount').textContent = highPriority;
            
            document.getElementById('selectedShopsCount').textContent = selectedShops.length;
        }
        
        // HTML escape function to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Display shops
        function displayShops(shops) {
            const container = document.getElementById('shopsListContainer');
            
            if (shops.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">لا توجد محلات متاحة حسب المعايير المحددة</p>';
                return;
            }
            
            // Clear container
            container.innerHTML = '';
            
            // Create shops list container
            const shopsListDiv = document.createElement('div');
            shopsListDiv.className = 'shops-list';
            
            shops.forEach(shop => {
                const isSelected = selectedShops.includes(shop.name);
                const lastInspection = getLastInspectionDate(shop.name);
                
                // Create shop card element
                const shopCard = document.createElement('div');
                shopCard.className = `shop-card ${shop.priority}-priority ${isSelected ? 'selected' : ''}`;
                shopCard.onclick = function() { toggleShop(shop.name); };
                
                // Priority badge
                const priorityBadge = document.createElement('div');
                priorityBadge.className = `priority-badge ${shop.priority}`;
                priorityBadge.textContent = shop.priority === 'high' ? 'أولوية عالية' : 
                                            shop.priority === 'medium' ? 'أولوية متوسطة' : 'أولوية منخفضة';
                
                // Shop name
                const shopName = document.createElement('div');
                shopName.className = 'shop-name';
                shopName.textContent = shop.name;
                
                // Shop info - score
                const shopScore = document.createElement('div');
                shopScore.className = 'shop-info';
                shopScore.textContent = '📊 النقاط: ' + shop.score;
                
                // Shop info - reason
                const shopReason = document.createElement('div');
                shopReason.className = 'shop-info';
                shopReason.textContent = '📝 ' + shop.reason;
                
                // Last inspection
                const lastInspectionDiv = document.createElement('div');
                lastInspectionDiv.className = 'last-inspection';
                lastInspectionDiv.textContent = '📅 آخر تفتيش: ' + (lastInspection || 'لم يتم التفتيش بعد');
                
                // Append all elements
                shopCard.appendChild(priorityBadge);
                shopCard.appendChild(shopName);
                shopCard.appendChild(shopScore);
                shopCard.appendChild(shopReason);
                shopCard.appendChild(lastInspectionDiv);
                
                shopsListDiv.appendChild(shopCard);
            });
            
            container.appendChild(shopsListDiv);
        }
        
        // Toggle shop selection
        function toggleShop(shopName) {
            const index = selectedShops.indexOf(shopName);
            
            if (index > -1) {
                selectedShops.splice(index, 1);
            } else {
                selectedShops.push(shopName);
            }
            
            updateSelectedShopsDisplay();
            updateAvailableShops();
            updatePreview();
        }
        
        // Update selected shops display
        function updateSelectedShopsDisplay() {
            const container = document.getElementById('selectedShopsContainer');
            const list = document.getElementById('selectedShopsList');
            
            if (selectedShops.length === 0) {
                container.style.display = 'none';
                document.getElementById('saveBtn').disabled = true;
                return;
            }
            
            container.style.display = 'block';
            document.getElementById('saveBtn').disabled = false;
            
            // Clear list
            list.innerHTML = '';
            
            // Create shop tags safely
            selectedShops.forEach(shop => {
                const tag = document.createElement('div');
                tag.className = 'selected-shop-tag';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = shop;
                
                const removeSpan = document.createElement('span');
                removeSpan.className = 'remove';
                removeSpan.textContent = '×';
                removeSpan.onclick = function() { toggleShop(shop); };
                
                tag.appendChild(nameSpan);
                tag.appendChild(removeSpan);
                list.appendChild(tag);
            });
            
            document.getElementById('selectedShopsCount').textContent = selectedShops.length;
        }
        
        // Update preview
        function updatePreview() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const shift = document.getElementById('shiftSelect').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector || !date || !area || selectedShops.length === 0) {
                document.getElementById('inspectionPreview').style.display = 'none';
                return;
            }
            
            document.getElementById('inspectionPreview').style.display = 'block';
            document.getElementById('previewInspector').textContent = inspector;
            document.getElementById('previewDate').textContent = date;
            document.getElementById('previewShift').textContent = shift;
            document.getElementById('previewArea').textContent = area;
            document.getElementById('previewShopsCount').textContent = selectedShops.length;
        }
        
        // Populate filter dropdowns
        function populateFilterDropdowns() {
            // Populate inspector filter
            const filterInspector = document.getElementById('filterInspector');
            const statsInspector = document.getElementById('statsInspector');
            const editInspector = document.getElementById('editInspector');
            
            filterInspector.innerHTML = '<option value="">جميع المفتشين</option>';
            statsInspector.innerHTML = '<option value="">اختر المفتش...</option>';
            editInspector.innerHTML = '<option value="">اختر المفتش...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const opt1 = document.createElement('option');
                    opt1.value = inspector.name;
                    opt1.textContent = inspector.name;
                    filterInspector.appendChild(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = inspector.name;
                    opt2.textContent = inspector.name;
                    statsInspector.appendChild(opt2);
                    
                    const opt3 = document.createElement('option');
                    opt3.value = inspector.name;
                    opt3.textContent = inspector.name;
                    editInspector.appendChild(opt3);
                });
            }
            
            // Populate area filter
            const filterArea = document.getElementById('filterArea');
            const editArea = document.getElementById('editArea');
            
            filterArea.innerHTML = '<option value="">جميع المناطق</option>';
            editArea.innerHTML = '<option value="">اختر المنطقة...</option>';
            
            if (planData && planData.areas) {
                planData.areas.forEach(area => {
                    const opt1 = document.createElement('option');
                    opt1.value = area.name;
                    opt1.textContent = area.name;
                    filterArea.appendChild(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = area.name;
                    opt2.textContent = area.name;
                    editArea.appendChild(opt2);
                });
            }
        }
        
        // Load inspections view
        function loadInspectionsView() {
            filterInspections();
        }
        
        // Filter inspections
        function filterInspections() {
            if (!planData || !planData.inspectionData) {
                document.getElementById('inspectionsTableContainer').innerHTML = 
                    '<div class="empty-state"><div class="icon">📭</div><p>لا توجد تفتيشات متاحة</p></div>';
                return;
            }
            
            const filterInspector = document.getElementById('filterInspector').value;
            const filterArea = document.getElementById('filterArea').value;
            const filterDateFrom = document.getElementById('filterDateFrom').value;
            const filterDateTo = document.getElementById('filterDateTo').value;
            const searchText = document.getElementById('searchBox').value.toLowerCase();
            
            let filtered = planData.inspectionData.filter(inspection => {
                // Filter by inspector
                if (filterInspector && inspection.inspector !== filterInspector) return false;
                
                // Filter by area
                if (filterArea && inspection.area !== filterArea) return false;
                
                // Filter by date range
                if (filterDateFrom && inspection.day < filterDateFrom) return false;
                if (filterDateTo && inspection.day > filterDateTo) return false;
                
                // Filter by search text
                if (searchText) {
                    const searchIn = `${inspection.inspector} ${inspection.area} ${inspection.shops.join(' ')}`.toLowerCase();
                    if (!searchIn.includes(searchText)) return false;
                }
                
                return true;
            });
            
            // Sort by date (newest first)
            filtered.sort((a, b) => b.day.localeCompare(a.day));
            
            displayInspectionsTable(filtered);
        }
        
        // Display inspections table
        function displayInspectionsTable(inspections) {
            const container = document.getElementById('inspectionsTableContainer');
            
            if (inspections.length === 0) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">🔍</div><p>لا توجد نتائج مطابقة للفلترة</p></div>';
                return;
            }
            
            let html = '<table class="inspections-table">';
            html += '<thead><tr>';
            html += '<th><input type="checkbox" onchange="toggleAllCheckboxes(this)"></th>';
            html += '<th>المفتش</th>';
            html += '<th>التاريخ</th>';
            html += '<th>المناوبة</th>';
            html += '<th>المنطقة</th>';
            html += '<th>عدد المحلات</th>';
            html += '<th>الإجراءات</th>';
            html += '</tr></thead><tbody>';
            
            inspections.forEach((inspection, index) => {
                // Find original index in planData
                const originalIndex = planData.inspectionData.indexOf(inspection);
                
                html += '<tr>';
                html += `<td><input type="checkbox" class="inspection-checkbox" value="${originalIndex}"></td>`;
                html += `<td>${escapeHtml(inspection.inspector)}</td>`;
                html += `<td>${inspection.day}</td>`;
                html += `<td>${escapeHtml(inspection.shift || 'صباحية')}</td>`;
                html += `<td>${escapeHtml(inspection.area)}</td>`;
                html += `<td>${inspection.shops ? inspection.shops.length : 0}</td>`;
                html += `<td>
                    <span class="action-icon edit-icon" onclick="openEditModal(${originalIndex})" title="تحرير">✏️</span>
                    <span class="action-icon delete-icon" onclick="deleteInspection(${originalIndex})" title="حذف">🗑️</span>
                    <span class="action-icon copy-icon" onclick="copyInspection(${originalIndex})" title="نسخ">📋</span>
                </td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Toggle all checkboxes
        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('.inspection-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = source.checked;
            });
        }
        
        // Open edit modal
        function openEditModal(index) {
            const inspection = planData.inspectionData[index];
            
            document.getElementById('editInspectionIndex').value = index;
            document.getElementById('editInspector').value = inspection.inspector;
            document.getElementById('editDate').value = inspection.day;
            document.getElementById('editShift').value = inspection.shift || 'صباحية';
            document.getElementById('editArea').value = inspection.area;
            document.getElementById('editShops').value = inspection.shops.join('، ');
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editStatus').className = 'status-message';
        }
        
        // Save edited inspection
        async function saveEditedInspection() {
            const index = parseInt(document.getElementById('editInspectionIndex').value);
            const inspector = document.getElementById('editInspector').value;
            const date = document.getElementById('editDate').value;
            const shift = document.getElementById('editShift').value;
            const area = document.getElementById('editArea').value;
            const shopsText = document.getElementById('editShops').value;
            
            if (!inspector || !date || !area || !shopsText) {
                showMessage('editStatus', 'error', '❌ يرجى ملء جميع الحقول');
                return;
            }
            
            // Parse shops
            const shops = shopsText.split('،').map(s => s.trim()).filter(s => s);
            
            if (shops.length === 0) {
                showMessage('editStatus', 'error', '❌ يرجى إضافة محل واحد على الأقل');
                return;
            }
            
            showMessage('editStatus', 'info', '⏳ جاري حفظ التعديلات...');
            
            try {
                // Check for duplicates (excluding current inspection)
                const duplicateIndex = planData.inspectionData.findIndex((insp, idx) => 
                    idx !== index && 
                    insp.inspector === inspector && 
                    insp.day === date
                );
                
                if (duplicateIndex !== -1) {
                    if (confirm('يوجد تفتيش مكرر لنفس المفتش في نفس اليوم. هل تريد حذف التفتيش القديم؟')) {
                        // Delete the duplicate
                        planData.inspectionData.splice(duplicateIndex, 1);
                        // Adjust index if needed
                        if (duplicateIndex < index) {
                            index--;
                        }
                    } else {
                        showMessage('editStatus', 'error', '❌ تم إلغاء الحفظ لتجنب التكرار');
                        return;
                    }
                }
                
                // Update inspection
                planData.inspectionData[index] = {
                    inspector: inspector,
                    day: date,
                    shift: shift,
                    area: area,
                    shops: shops
                };
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`تحديث تفتيش - ${inspector} - ${date}`);
                
                showMessage('editStatus', 'success', '✅ تم حفظ التعديلات بنجاح!');
                
                setTimeout(() => {
                    closeEditModal();
                    filterInspections();
                }, 2000);
                
            } catch (error) {
                showMessage('editStatus', 'error', '❌ فشل حفظ التعديلات: ' + error.message);
            }
        }
        
        // Delete inspection
        async function deleteInspection(index) {
            const inspection = planData.inspectionData[index];
            
            if (!confirm(`هل أنت متأكد من حذف هذا التفتيش؟\n\nالمفتش: ${inspection.inspector}\nالتاريخ: ${inspection.day}\nالمحلات: ${inspection.shops.length}`)) {
                return;
            }
            
            try {
                // Remove inspection
                planData.inspectionData.splice(index, 1);
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`حذف تفتيش - ${inspection.inspector} - ${inspection.day}`);
                
                alert('✅ تم حذف التفتيش بنجاح!');
                filterInspections();
                
            } catch (error) {
                alert('❌ فشل حذف التفتيش: ' + error.message);
            }
        }
        
        // Copy inspection
        function copyInspection(index) {
            const inspection = planData.inspectionData[index];
            
            // Switch to add tab
            document.querySelectorAll('.tab-button')[0].click();
            
            // Fill form with copied data
            document.getElementById('inspectorSelect').value = inspection.inspector;
            document.getElementById('areaSelect').value = inspection.area;
            document.getElementById('shiftSelect').value = inspection.shift || 'صباحية';
            
            // Set date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('inspectionDate').valueAsDate = tomorrow;
            
            // Pre-select shops (if they're available)
            selectedShops = [...inspection.shops];
            
            updateAvailableShops();
            
            alert('✅ تم نسخ بيانات التفتيش! يمكنك الآن تعديل التاريخ والمحلات وحفظ التفتيش الجديد.');
        }
        
        // Delete selected inspections
        async function deleteSelectedInspections() {
            const checkboxes = document.querySelectorAll('.inspection-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('⚠️ يرجى تحديد التفتيشات المراد حذفها');
                return;
            }
            
            if (!confirm(`هل أنت متأكد من حذف ${checkboxes.length} تفتيش؟`)) {
                return;
            }
            
            try {
                // Get indices and sort in descending order (to delete from end to start)
                const indices = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => b - a);
                
                // Delete inspections
                indices.forEach(index => {
                    planData.inspectionData.splice(index, 1);
                });
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`حذف ${indices.length} تفتيش`);
                
                alert(`✅ تم حذف ${indices.length} تفتيش بنجاح!`);
                filterInspections();
                
            } catch (error) {
                alert('❌ فشل حذف التفتيشات: ' + error.message);
            }
        }
        
        // Export inspections
        function exportInspections() {
            const filterInspector = document.getElementById('filterInspector').value;
            const dataToExport = filterInspector ? 
                planData.inspectionData.filter(i => i.inspector === filterInspector) : 
                planData.inspectionData;
            
            const jsonStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inspections-${filterInspector || 'all'}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Load inspector statistics
        function loadInspectorStats() {
            const inspector = document.getElementById('statsInspector').value;
            const container = document.getElementById('statsContainer');
            
            if (!inspector) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">📊</div><p>اختر مفتشاً لعرض الإحصائيات</p></div>';
                return;
            }
            
            // Calculate statistics
            const inspections = planData.inspectionData.filter(i => i.inspector === inspector);
            const totalInspections = inspections.length;
            const totalShops = inspections.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0);
            const areas = new Set(inspections.map(i => i.area)).size;
            const uniqueShops = new Set();
            inspections.forEach(i => i.shops && i.shops.forEach(s => uniqueShops.add(s)));
            
            // Get date range
            const dates = inspections.map(i => new Date(i.day)).sort((a, b) => a - b);
            const firstDate = dates.length > 0 ? dates[0].toLocaleDateString('ar-EG') : '-';
            const lastDate = dates.length > 0 ? dates[dates.length - 1].toLocaleDateString('ar-EG') : '-';
            
            // Calculate inspections per area
            const areaCount = {};
            inspections.forEach(i => {
                areaCount[i.area] = (areaCount[i.area] || 0) + 1;
            });
            
            let html = '<div class="inspector-stats">';
            html += `<div class="stat-card"><div class="stat-value">${totalInspections}</div><div class="stat-label">إجمالي التفتيشات</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${totalShops}</div><div class="stat-label">إجمالي المحلات</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${uniqueShops.size}</div><div class="stat-label">محلات فريدة</div></div>`;
            html += `<div class="stat-card"><div class="stat-value">${areas}</div><div class="stat-label">المناطق المغطاة</div></div>`;
            html += '</div>';
            
            html += '<div style="margin-top: 30px;">';
            html += '<h3 style="color: #2d3561; margin-bottom: 15px;">📅 الفترة الزمنية</h3>';
            html += `<p><strong>أول تفتيش:</strong> ${firstDate}</p>`;
            html += `<p><strong>آخر تفتيش:</strong> ${lastDate}</p>`;
            html += '</div>';
            
            html += '<div style="margin-top: 30px;">';
            html += '<h3 style="color: #2d3561; margin-bottom: 15px;">🗺️ توزيع التفتيشات حسب المنطقة</h3>';
            for (const [area, count] of Object.entries(areaCount).sort((a, b) => b[1] - a[1])) {
                html += `<div style="padding: 10px; background: #f8f9fa; margin-bottom: 5px; border-radius: 8px;">`;
                html += `<strong>${escapeHtml(area)}:</strong> ${count} تفتيش`;
                html += `</div>`;
            }
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Populate stats inspector dropdown
        function populateStatsInspector() {
            const select = document.getElementById('statsInspector');
            select.innerHTML = '<option value="">اختر المفتش...</option>';
            
            if (planData && planData.inspectors) {
                planData.inspectors.forEach(inspector => {
                    const option = document.createElement('option');
                    option.value = inspector.name;
                    option.textContent = inspector.name;
                    select.appendChild(option);
                });
            }
        }
        
        // Load calendar
        function loadCalendar() {
            const monthInput = document.getElementById('calendarMonth').value;
            const container = document.getElementById('calendarContainer');
            
            if (!monthInput) {
                container.innerHTML = 
                    '<div class="empty-state"><div class="icon">📅</div><p>اختر الشهر لعرض التقويم</p></div>';
                return;
            }
            
            const [year, month] = monthInput.split('-').map(Number);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const daysInMonth = lastDay.getDate();
            
            // Get inspections for this month
            const monthStr = monthInput;
            const monthInspections = planData.inspectionData.filter(i => 
                i.day.startsWith(monthStr)
            );
            
            // Group by date
            const inspectionsByDate = {};
            monthInspections.forEach(i => {
                if (!inspectionsByDate[i.day]) {
                    inspectionsByDate[i.day] = [];
                }
                inspectionsByDate[i.day].push(i);
            });
            
            let html = '<div style="margin-bottom: 20px;">';
            html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; font-weight: bold; text-align: center; color: #667eea;">';
            const daysOfWeek = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            daysOfWeek.forEach(day => {
                html += `<div style="padding: 10px;">${day}</div>`;
            });
            html += '</div>';
            html += '<div class="calendar-view">';
            
            // Add empty cells for days before first day of month
            const startDay = firstDay.getDay();
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day" style="opacity: 0.3;"></div>';
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayInspections = inspectionsByDate[dateStr] || [];
                const hasInspection = dayInspections.length > 0;
                
                html += `<div class="calendar-day ${hasInspection ? 'has-inspection' : ''}">`;
                html += `<div class="day-number">${day}</div>`;
                
                dayInspections.forEach(insp => {
                    html += `<div class="inspection-badge" title="${escapeHtml(insp.inspector)} - ${escapeHtml(insp.area)}">`;
                    html += `${escapeHtml(insp.inspector.split(' ')[1] || insp.inspector)}`;
                    html += `</div>`;
                });
                
                html += '</div>';
            }
            
            html += '</div></div>';
            
            // Add summary
            html += '<div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">';
            html += `<h3 style="color: #2d3561; margin-bottom: 15px;">📊 ملخص الشهر</h3>`;
            html += `<p><strong>إجمالي التفتيشات:</strong> ${monthInspections.length}</p>`;
            html += `<p><strong>إجمالي المحلات:</strong> ${monthInspections.reduce((sum, i) => sum + (i.shops ? i.shops.length : 0), 0)}</p>`;
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Update preview
        function updatePreview() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const shift = document.getElementById('shiftSelect').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector || !date || !area || selectedShops.length === 0) {
                document.getElementById('inspectionPreview').style.display = 'none';
                return;
            }
            
            document.getElementById('inspectionPreview').style.display = 'block';
            document.getElementById('previewInspector').textContent = inspector;
            document.getElementById('previewDate').textContent = date;
            document.getElementById('previewShift').textContent = shift;
            document.getElementById('previewArea').textContent = area;
            document.getElementById('previewShopsCount').textContent = selectedShops.length;
        }
        
        // Save inspection to GitHub
        async function saveInspection() {
            const inspector = document.getElementById('inspectorSelect').value;
            const date = document.getElementById('inspectionDate').value;
            const shift = document.getElementById('shiftSelect').value;
            const area = document.getElementById('areaSelect').value;
            
            if (!inspector || !date || !area || selectedShops.length === 0) {
                showMessage('planningStatus', 'error', '❌ يرجى ملء جميع الحقول واختيار المحلات');
                return;
            }
            
            // Check for duplicate inspection (same inspector and date)
            const duplicateIndex = planData.inspectionData.findIndex(insp => 
                insp.inspector === inspector && insp.day === date
            );
            
            let confirmMessage = `هل أنت متأكد من إضافة هذا التفتيش؟\n\nالمفتش: ${inspector}\nالتاريخ: ${date}\nالمحلات: ${selectedShops.length}`;
            
            if (duplicateIndex !== -1) {
                confirmMessage = `⚠️ تنبيه: يوجد تفتيش مكرر لنفس المفتش في نفس اليوم!\n\nهل تريد حذف التفتيش القديم وإضافة التفتيش الجديد؟\n\nالمفتش: ${inspector}\nالتاريخ: ${date}\nالمحلات الجديدة: ${selectedShops.length}`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            showMessage('planningStatus', 'info', '⏳ جاري حفظ التفتيش...');
            document.getElementById('saveBtn').disabled = true;
            
            try {
                // Delete duplicate if exists
                if (duplicateIndex !== -1) {
                    planData.inspectionData.splice(duplicateIndex, 1);
                    showMessage('planningStatus', 'info', '⏳ تم حذف التفتيش المكرر... جاري حفظ التفتيش الجديد...');
                }
                
                // Create new inspection entry
                const newInspection = {
                    inspector: inspector,
                    day: date,
                    shift: shift,
                    area: area,
                    shops: [...selectedShops]
                };
                
                // Add to plan data
                planData.inspectionData.push(newInspection);
                
                // Update lastUpdate timestamp
                planData.lastUpdate = new Date().toISOString();
                
                // Save to GitHub
                await savePlanDataToGitHub(`إضافة تفتيش جديد - ${inspector} - ${date}`);
                
                let successMsg = `✅ تم حفظ التفتيش بنجاح!\n\n📊 المفتش: ${inspector}\n📅 التاريخ: ${date}\n🏪 عدد المحلات: ${selectedShops.length}`;
                
                if (duplicateIndex !== -1) {
                    successMsg += '\n\n🗑️ تم حذف التفتيش المكرر تلقائياً';
                }
                
                successMsg += '\n\n✨ التحديثات ستظهر فوراً في الموقع!';
                
                showMessage('planningStatus', 'success', successMsg);
                
                // Reset form
                setTimeout(() => {
                    resetForm();
                }, 3000);
                
            } catch (error) {
                showMessage('planningStatus', 'error', '❌ فشل حفظ التفتيش: ' + error.message);
                document.getElementById('saveBtn').disabled = false;
            }
        }
        
        // Save plan data to GitHub
        async function savePlanDataToGitHub(commitMessage = null) {
            // Get current file SHA
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!getRes.ok) {
                throw new Error('فشل الحصول على ملف plan-data.json');
            }
            
            const file = await getRes.json();
            const sha = file.sha;
            
            // Prepare content
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(planData, null, 2))));
            
            // Default commit message if not provided
            if (!commitMessage) {
                const inspector = document.getElementById('inspectorSelect').value;
                const date = document.getElementById('inspectionDate').value;
                commitMessage = `إضافة تفتيش جديد - ${inspector} - ${date}`;
            }
            
            // Update file
            const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/plan-data.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: commitMessage,
                    content: content,
                    sha: sha
                })
            });
            
            if (!updateRes.ok) {
                throw new Error('فشل تحديث ملف plan-data.json');
            }
        }
        
        // Reset form
        function resetForm() {
            document.getElementById('inspectorSelect').value = '';
            document.getElementById('inspectionDate').valueAsDate = new Date();
            document.getElementById('shiftSelect').value = 'صباحية';
            document.getElementById('areaSelect').value = '';
            selectedShops = [];
            
            document.getElementById('shopsListContainer').innerHTML = 
                '<p style="text-align: center; color: #999; padding: 20px;">اختر المفتش والتاريخ والمنطقة لعرض المحلات المتاحة</p>';
            
            document.getElementById('selectedShopsContainer').style.display = 'none';
            document.getElementById('inspectionPreview').style.display = 'none';
            document.getElementById('saveBtn').disabled = true;
            
            updateStatistics(0, 0, []);
        }
        
        // Show message
        function showMessage(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.className = `status-message ${type} show`;
            el.textContent = message;
            
            setTimeout(() => {
                el.classList.remove('show');
            }, type === 'success' ? 5000 : 10000);
        }
        
        // Check if user is already logged in
        window.onload = function() {
            const savedToken = localStorage.getItem('devToken');
            if (savedToken) {
                document.getElementById('githubToken').value = savedToken;
            }
        };
    </script>
</body>
</html>
