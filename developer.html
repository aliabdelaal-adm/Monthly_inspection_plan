<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لوحة إدارة خطة التفتيش الشهرية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- مكتبات التصدير -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {font-family:'Cairo',Tahoma,Arial,sans-serif;background:#f7f8fa;margin:0;padding:0;}
        .container {max-width:1100px;margin:40px auto 24px auto;background:#fff;border-radius:18px;box-shadow:0 4px 32px #0002;padding:32px 24px 24px 24px;direction:rtl;}
        .main-title {background:#234093;color:#fff;border-radius:10px;padding:18px 0;text-align:center;font-size:2em;margin-bottom:24px;letter-spacing:1px;}
        .top-bar {display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:18px;gap:1.5rem;}
        .top-bar label,.top-bar .user-type-label {font-size:1.1em;margin-left:8px;}
        .top-bar select,.top-bar button {font-size:1em;border-radius:7px;border:1px solid #ccc;padding:8px 14px;margin-right:8px;}
        .top-bar button {background:#234093;color:#fff;border:none;margin:0 4px;cursor:pointer;transition:0.2s;}
        .top-bar button:hover {background:#1a2c67;}
        .api-token-bar {margin-bottom:18px;text-align:left;direction:ltr;padding:8px 12px;background:#e6eeff;border-radius:10px;display:flex;align-items:center;gap:10px;font-size:1em;}
        .api-token-bar label {font-size:1.06em;color:#234093;margin-left:8px;}
        .api-token-bar input[type="password"],.api-token-bar input[type="text"] {border:1px solid #bbb;border-radius:5px;padding:6px 10px;font-size:1em;width:240px;}
        .api-token-bar button {background:#234093;color:#fff;border:none;border-radius:6px;padding:6px 18px;font-size:1em;cursor:pointer;}
        .api-token-bar .api-token-saved {color:#388e3c;margin-right:8px;}
        .api-token-bar .api-token-warning {color:#d32f2f;margin-right:8px;}
        .admin-panel {margin:32px 0;display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:28px;}
        .admin-section {background:#f3f6fe;border:1px solid #e0e7f7;border-radius:14px;padding:24px 18px 18px 18px;box-shadow:0px 1.5px 6px #23409311;margin-bottom:24px;}
        .admin-section h3 {color:#1a2c67;margin:0 0 18px 0;font-size:1.13em;}
        .add-row-form {display:flex;gap:8px;margin-bottom:18px;align-items:center;}
        .add-row-form input[type="text"],.add-row-form select,.add-row-form input[type="date"] {flex:1;font-size:1em;padding:6px 10px;border-radius:6px;border:1px solid #bbb;}
        .add-row-form button {background:#198754;color:#fff;border:none;padding:8px 22px;border-radius:7px;font-size:1em;cursor:pointer;}
        .table-wrapper {overflow:auto;}
        table {width:100%;border-collapse:collapse;margin-bottom:15px;}
        th,td {padding:9px 12px;text-align:right;}
        th {background:#234093;color:#fff;font-weight:600;}
        tr:nth-child(even) {background:#f7f8fa;}
        tr:hover {background:#e6eeff;}
        .action-btn {background:#234093;color:#fff;border:none;border-radius:5px;padding:5px 16px;font-size:0.97em;cursor:pointer;margin-left:5px;}
        .action-btn.edit {background:#0288d1;}
        .action-btn.delete {background:#b71c1c;}
        .action-btn.export {background:#388e3c;}
        .action-btn.import {background:#ffa000;}
        .action-btn:disabled {opacity:0.6;cursor:not-allowed;}
        .warning {color:#b71c1c;font-size:1.02em;margin-bottom:5px;}
        .success {color:#198754;font-size:1.01em;}
        .info {color:#1976d2;font-size:1em;}
        .flex-between {display:flex;align-items:center;justify-content:space-between;}
        @media (max-width: 700px) {
            .container {padding:14px 5px;}
            .admin-panel {grid-template-columns:1fr;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-title">لوحة إدارة خطة التفتيش الشهرية</div>
        
        <!-- شريط توكن GitHub للمطور -->
        <div class="api-token-bar" id="tokenBar">
            <label for="githubTokenInput">GitHub Token:</label>
            <input id="githubTokenInput" type="password" placeholder="ghp_xxxxxx..." />
            <button onclick="setGithubToken()">حفظ التوكن</button>
            <span id="tokenResultMsg"></span>
            <div style="color:#b71c1c;font-size:0.98em;margin-top:3px;">
                <b>تحذير:</b> التوكن سرّي وخاص بك فقط.<br>
                لا تشارك التوكن مع أي شخص أو تضعه في أي مكان عام.<br>
                التوكن يُخزن في متصفحك فقط ويمكنك مسحه من الإعدادات في أي وقت.
            </div>
        </div>
        <div class="admin-panel">
            <div class="admin-section">
                <h3>إدارة المفتشين</h3>
                <form class="add-row-form" id="inspectorForm">
                    <input type="text" id="inspectorName" placeholder="اسم المفتش" required>
                    <button type="submit">إضافة</button>
                </form>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr><th>اسم المفتش</th><th>الإجراءات</th></tr>
                        </thead>
                        <tbody id="inspectorTable"></tbody>
                    </table>
                </div>
            </div>
            <div class="admin-section">
                <h3>إدارة المناطق</h3>
                <form class="add-row-form" id="areaForm">
                    <input type="text" id="areaName" placeholder="اسم المنطقة" required>
                    <button type="submit">إضافة</button>
                </form>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr><th>اسم المنطقة</th><th>الإجراءات</th></tr>
                        </thead>
                        <tbody id="areaTable"></tbody>
                    </table>
                </div>
            </div>
            <div class="admin-section">
                <h3>إدارة المحلات</h3>
                <form class="add-row-form" id="shopForm">
                    <input type="text" id="shopName" placeholder="اسم المحل" required>
                    <button type="submit">إضافة</button>
                </form>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr><th>اسم المحل</th><th>الإجراءات</th></tr>
                        </thead>
                        <tbody id="shopTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="admin-section">
            <h3>جدول خطة التفتيش</h3>
            <form class="add-row-form" id="planForm">
                <select id="planInspector" required>
                    <option value="">اختر المفتش</option>
                </select>
                <input type="date" id="planDate" required>
                <select id="planShift" required>
                    <option value="">وقت المناوبة</option>
                    <option value="صباحية">صباحية</option>
                    <option value="مسائية">مسائية</option>
                </select>
                <select id="planArea" required>
                    <option value="">اختر المنطقة</option>
                </select>
                <input type="text" id="planShops" placeholder="المحلات (افصل بفاصلة ,)" required>
                <button type="submit">إضافة / تحديث</button>
                <input type="hidden" id="planEditingIndex" value="">
            </form>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>اسم المفتش</th>
                            <th>اليوم</th>
                            <th>وقت المناوبة</th>
                            <th>المنطقة</th>
                            <th>المحلات</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="planTable"></tbody>
                </table>
            </div>
        </div>
        <div class="flex-between" style="margin-top:20px;">
            <div>
                <button class="action-btn export" onclick="exportToExcel()">تصدير Excel</button>
                <button class="action-btn export" onclick="exportToPDF()">تصدير PDF</button>
                <label style="margin-right:15px;">
                    <input type="file" id="importFile" style="display:none;" onchange="importFromFile(this)">
                    <button class="action-btn import" onclick="document.getElementById('importFile').click();return false;">استيراد ملف</button>
                </label>
            </div>
            <button class="action-btn delete" onclick="resetAllData()" style="margin-left:12px;">إعادة ضبط جميع البيانات</button>
        </div>
        <div style="margin-top:22px;color:#888;font-size:1.05em;text-align:center;">
            <span id="lastUpdate"></span>
        </div>
    </div>
<script>
// ============== متغيرات البيانات ==============
let data = {
    inspectors: [],
    areas: [],
    shops: [],
    plan: [],
    lastUpdate: ''
};
const GITHUB_REPO = "aliabdelaal-adm/Monthly_inspection_plan";
const PLAN_FILE = "inspection_plan.json";
// ============== إدارة التوكن ==============
function getGithubToken() {
    return localStorage.getItem('github_token') || '';
}
function setGithubToken() {
    const token = document.getElementById('githubTokenInput').value.trim();
    if(token.length > 10) {
        localStorage.setItem('github_token', token);
        document.getElementById('tokenResultMsg').innerHTML = "<span class='api-token-saved'>تم الحفظ!</span>";
    } else {
        document.getElementById('tokenResultMsg').innerHTML = "<span class='api-token-warning'>توكن غير صحيح</span>";
    }
}
document.getElementById('githubTokenInput').value = getGithubToken();
// ============== تحميل/حفظ البيانات من/إلى GitHub ==============
async function fetchPlanFromGitHub() {
    try {
        const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${PLAN_FILE}`);
        if (!res.ok) throw new Error('تعذر تحميل البيانات');
        const json = await res.json();
        // فك التشفير بشكل يدعم العربية
        const planContent = decodeURIComponent(escape(atob(json.content.replace(/\n/g,''))));
        data = JSON.parse(planContent);
        renderAll();
        document.getElementById('lastUpdate').textContent = 'آخر تحديث: ' + (data.lastUpdate || '');
    } catch (e) {
        data = {inspectors:[],areas:[],shops:[],plan:[],lastUpdate:''};
        renderAll();
        document.getElementById('lastUpdate').textContent = 'تعذر تحميل البيانات';
    }
}
async function savePlanToGitHub() {
    const token = getGithubToken();
    if (!token) { alert("يرجى إدخال GitHub Token."); return; }
    // تحديث وقت حفظ البيانات
    data.lastUpdate = new Date().toLocaleString('ar-EG');
    const planContent = JSON.stringify(data,null,2);
    // نحتاج sha للملف الحالي
    let sha = null;
    try {
        const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${PLAN_FILE}`);
        const json = await res.json();
        sha = json.sha;
    } catch {}
    // رفع الملف مع ترميز يدعم العربية
    const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${PLAN_FILE}`, {
        method: "PUT",
        headers: {
            "Authorization": `token ${token}`,
            "Accept": "application/vnd.github+json"
        },
        body: JSON.stringify({
            message: "تحديث خطة التفتيش من لوحة المطور",
            content: btoa(unescape(encodeURIComponent(planContent))),
            sha: sha
        })
    });
    if(res.ok) {
        document.getElementById('lastUpdate').textContent = 'تم الحفظ: ' + data.lastUpdate;
        fetchPlanFromGitHub();
    } else {
        alert("تعذر حفظ البيانات. تأكد من صحة التوكن وصلاحياته.");
    }
}
// ============== دوال عرض البيانات ==============
function renderInspectors() {
    const tbody = document.getElementById('inspectorTable');
    tbody.innerHTML = '';
    data.inspectors.forEach((name, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td>\n            <td>\n                <button class=\"action-btn delete\" onclick=\"deleteInspector(${idx})\">حذف</button>\n            </td>`;
        tbody.appendChild(tr);
    });
    renderInspectorOptions();
}
function renderAreas() {
    const tbody = document.getElementById('areaTable');
    tbody.innerHTML = '';
    data.areas.forEach((name, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td>\n            <td>\n                <button class=\"action-btn delete\" onclick=\"deleteArea(${idx})\">حذف</button>\n            </td>`;
        tbody.appendChild(tr);
    });
    renderAreaOptions();
}
function renderShops() {
    const tbody = document.getElementById('shopTable');
    tbody.innerHTML = '';
    data.shops.forEach((name, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td>\n            <td>\n                <button class=\"action-btn delete\" onclick=\"deleteShop(${idx})\">حذف</button>\n            </td>`;
        tbody.appendChild(tr);
    });
}
function renderPlan() {
    const tbody = document.getElementById('planTable');
    tbody.innerHTML = '';
    data.plan.forEach((row, idx) => {
        const shops = (row.shops||[]).join(', ');
        const tr = document.createElement('tr');
        tr.innerHTML = `\n            <td>${row.inspector}</td>\n            <td>${row.date}</td>\n            <td>${row.shift}</td>\n            <td>${row.area}</td>\n            <td>${shops}</td>\n            <td>\n                <button class=\"action-btn edit\" onclick=\"editPlanRow(${idx})\">تعديل</button>\n                <button class=\"action-btn delete\" onclick=\"deletePlanRow(${idx})\">حذف</button>\n            </td>\n        `;
        tbody.appendChild(tr);
    });
}
function renderInspectorOptions() {
    const sel = document.getElementById('planInspector');
    sel.innerHTML = `<option value=\"\">اختر المفتش</option>`;
    data.inspectors.forEach(name => {
        sel.innerHTML += `<option value=\"${name}\">${name}</option>`;
    });
}
function renderAreaOptions() {
    const sel = document.getElementById('planArea');
    sel.innerHTML = `<option value=\"\">اختر المنطقة</option>`;
    data.areas.forEach(name => {
        sel.innerHTML += `<option value=\"${name}\">${name}</option>`;
    });
}
function renderAll() {
    renderInspectors();
    renderAreas();
    renderShops();
    renderPlan();
}
document.getElementById('inspectorForm').onsubmit = function(e) {
    e.preventDefault();
    const name = document.getElementById('inspectorName').value.trim();
    if(name && !data.inspectors.includes(name)) {
        data.inspectors.push(name);
        document.getElementById('inspectorName').value = '';
        renderInspectors();
        savePlanToGitHub();
    }
};
function deleteInspector(idx) {
    if(confirm('تأكيد حذف المفتش؟')) {
        data.inspectors.splice(idx,1);
        renderInspectors();
        savePlanToGitHub();
    }
}
document.getElementById('areaForm').onsubmit = function(e) {
    e.preventDefault();
    const name = document.getElementById('areaName').value.trim();
    if(name && !data.areas.includes(name)) {
        data.areas.push(name);
        document.getElementById('areaName').value = '';
        renderAreas();
        savePlanToGitHub();
    }
};
function deleteArea(idx) {
    if(confirm('تأكيد حذف المنطقة؟')) {
        data.areas.splice(idx,1);
        renderAreas();
        savePlanToGitHub();
    }
}
document.getElementById('shopForm').onsubmit = function(e) {
    e.preventDefault();
    const name = document.getElementById('shopName').value.trim();
    if(name && !data.shops.includes(name)) {
        data.shops.push(name);
        document.getElementById('shopName').value = '';
        renderShops();
        savePlanToGitHub();
    }
};
function deleteShop(idx) {
    if(confirm('تأكيد حذف المحل؟')) {
        data.shops.splice(idx,1);
        renderShops();
        savePlanToGitHub();
    }
}
document.getElementById('planForm').onsubmit = function(e) {
    e.preventDefault();
    const inspector = document.getElementById('planInspector').value;
    const date = document.getElementById('planDate').value;
    const shift = document.getElementById('planShift').value;
    const area = document.getElementById('planArea').value;
    const shops = document.getElementById('planShops').value.split(',').map(x=>x.trim()).filter(x=>x);
    const editingIndex = document.getElementById('planEditingIndex').value;
    if(inspector && date && shift && area && shops.length) {
        const newRow = {inspector,date,shift,area,shops};
        if(editingIndex==='') {
            data.plan.push(newRow);
        } else {
            data.plan[+editingIndex] = newRow;
            document.getElementById('planEditingIndex').value = '';
            document.getElementById('planForm').querySelector('button[type="submit"]').textContent = "إضافة / تحديث";
        }
        document.getElementById('planInspector').value = '';
        document.getElementById('planDate').value = '';
        document.getElementById('planShift').value = '';
        document.getElementById('planArea').value = '';
        document.getElementById('planShops').value = '';
        renderPlan();
        savePlanToGitHub();
    }
};
function editPlanRow(idx) {
    const row = data.plan[idx];
    document.getElementById('planInspector').value = row.inspector;
    document.getElementById('planDate').value = row.date;
    document.getElementById('planShift').value = row.shift;
    document.getElementById('planArea').value = row.area;
    document.getElementById('planShops').value = (row.shops||[]).join(', ');
    document.getElementById('planEditingIndex').value = idx;
    document.getElementById('planForm').querySelector('button[type="submit"]').textContent = "تحديث";
}
function deletePlanRow(idx) {
    if(confirm('تأكيد حذف السطر؟')) {
        data.plan.splice(idx,1);
        renderPlan();
        savePlanToGitHub();
    }
}
function exportToExcel() {
    const ws = XLSX.utils.json_to_sheet(data.plan.map(r=>({
        المفتش: r.inspector,
        اليوم: r.date,
        المناوبة: r.shift,
        المنطقة: r.area,
        المحلات: (r.shops||[]).join(', ')
    })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "خطة التفتيش");
    XLSX.writeFile(wb, "inspection_plan.xlsx");
}
function exportToPDF() {
    const table = document.getElementById('planTable').parentElement;
    html2canvas(table).then(canvas => {
        const pdf = new window.jspdf.jsPDF({orientation:"landscape"});
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, 270, 0);
        pdf.save("inspection_plan.pdf");
    });
}
function importFromFile(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);
            if(imported.inspectors&&imported.areas&&imported.shops&&imported.plan) {
                data = imported;
                renderAll();
                savePlanToGitHub();
            } else {
                alert("الملف غير صالح!");
            }
        } catch {
            alert("الملف غير صالح!");
        }
    };
    reader.readAsText(file);
}
function resetAllData() {
    if(confirm("تأكيد إعادة ضبط جميع البيانات؟")) {
        data = {inspectors:[],areas:[],shops:[],plan:[],lastUpdate:''};
        renderAll();
        savePlanToGitHub();
    }
}
window.addEventListener('DOMContentLoaded', fetchPlanFromGitHub);
</script>
</body>
</html>