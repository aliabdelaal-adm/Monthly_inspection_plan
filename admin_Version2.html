<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة إدارة خطة التفتيش</title>
  <style>
    body {font-family:Arial; background:#f7f7ff;}
    .box {max-width:600px; background:#fff; margin:50px auto; padding:30px 22px; border-radius:12px; box-shadow:0 0 16px #bbb;}
    textarea {width:100%; font-size:1.1em; padding:8px; border-radius:6px; border:1px solid #ccc;}
    button {background:#2336a0; color:#fff; border:none; border-radius:6px; padding:10px 28px; font-size:1.08em; cursor:pointer;}
    button:disabled {background:#999;}
    #uploadBtn {background:#0d7377; margin-left: 10px;}
    #uploadBtn:hover {background:#0a5d61;}
    #uploadBtn:disabled {background:#999;}
    .status {margin:14px 0 0 0;}
    label {font-weight:bold; color:#2336a0;}
    input[type="password"] {font-size:1.1em; padding:7px; border-radius:6px; border:1px solid #bbb;}
    .token-popup-bg {
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.17);z-index:1000;
      display:flex;align-items:center;justify-content:center;
    }
    .token-popup-box {
      background:#fff;padding:26px 22px;border-radius:12px;box-shadow:0 0 22px #aaa;min-width:320px;text-align:center;
    }
    .token-popup-box label {color:#2336a0;}
  </style>
</head>
<body>
  <div class="token-popup-bg" id="tokenPopup" style="display:none;">
    <div class="token-popup-box">
      <h3>إدخال التوكن السري</h3>
      <label> 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 </label><br>
      <input id="tokenInput" type="password" placeholder="GitHub Personal Access Token"><br><br>
      <button onclick="saveToken()">حفظ</button>
      <div style="color:#c00;font-size:1em;margin-top:10px;" id="tokenError"></div>
    </div>
  </div>
  <div class="box">
    <h2 style="text-align:center; color:#2336a0;">تعديل ملف خطة التفتيش (plan-data.json)</h2>
    <button onclick="changeToken()" style="float:left;margin-bottom:10px;">تغيير التوكن</button>
    <label>بيانات JSON (يمكنك التعديل هنا):</label>
    <textarea id="json" rows="18"></textarea><br>
    <button onclick="updatePlan()" id="saveBtn">حفظ التعديلات</button>
    <button onclick="uploadDistributionToGitHub()" id="uploadBtn" style="margin-right: 10px;">حفظ ورفع تلقائيًا إلى GitHub</button>
    <div class="status" id="status"></div>
  </div>
  <script>
    const repo = "aliabdelaal-adm/Monthly_inspection_plan";
    const path = "plan-data.json";
    let sha = "";

    // ---- Token Management ----
    function getToken() {
      return localStorage.getItem("devToken") || "";
    }
    function setToken(token) {
      localStorage.setItem("devToken", token);
    }
    function removeToken() {
      localStorage.removeItem("devToken");
    }
    function showTokenPopup() {
      document.getElementById("tokenPopup").style.display = "flex";
      document.getElementById("tokenInput").value = "";
      document.getElementById("tokenInput").focus();
      document.getElementById("tokenError").textContent = "";
    }
    function hideTokenPopup() {
      document.getElementById("tokenPopup").style.display = "none";
    }
    function saveToken() {
      const token = document.getElementById("tokenInput").value.trim();
      if (!token) {
        document.getElementById("tokenError").textContent = "يرجى إدخال التوكن السري!";
        return;
      }
      setToken(token);
      hideTokenPopup();
      loadPlan();
    }
    function changeToken() {
      removeToken();
      showTokenPopup();
    }

    // ---- Plan Data Logic ----
    async function loadPlan() {
      document.getElementById("status").textContent = "جاري تحميل البيانات...";
      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`);
      const file = await res.json();
      document.getElementById("json").value = decodeURIComponent(escape(atob(file.content)));
      sha = file.sha;
      document.getElementById("status").textContent = "تم تحميل البيانات. يمكنك التعديل الآن.";
    }

    async function updatePlan() {
      const token = getToken();
      if (!token) { showTokenPopup(); return; }
      let jsonData;
      try {
        jsonData = JSON.parse(document.getElementById("json").value);
      } catch(e) {
        alert("خطأ في تنسيق JSON! راجع الأقواس والفواصل.");
        return;
      }
      document.getElementById("saveBtn").disabled = true;
      document.getElementById("status").textContent = "جاري الحفظ...";
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(jsonData, null, 2))));
      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
        method: "PUT",
        headers: {
          "Authorization": `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "تحديث خطة التفتيش من لوحة المطور",
          content: content,
          sha: sha
        })
      });
      if (res.status === 200 || res.status === 201) {
        document.getElementById("status").textContent = "✅ تم حفظ التعديلات بنجاح!";
        loadPlan(); // reload sha
      } else {
        const err = await res.json();
        document.getElementById("status").textContent = "❌ حدث خطأ: " + (err.message || "تحقق من التوكن أو الصلاحيات.");
        if (res.status === 401 || res.status === 403) {
          removeToken();
          setTimeout(showTokenPopup, 500);
        }
      }
      document.getElementById("saveBtn").disabled = false;
    }

    // ---- Upload Distribution CSV to GitHub ----
    async function uploadDistributionToGitHub() {
      const token = getToken();
      if (!token) { showTokenPopup(); return; }
      
      const distributionPath = "جدول_توزيع_المحلات.csv";
      let distributionSha = "";
      
      document.getElementById("uploadBtn").disabled = true;
      document.getElementById("status").textContent = "جاري رفع جدول التوزيع...";
      
      try {
        // First, try to get the existing file to get its SHA
        const existingRes = await fetch(`https://api.github.com/repos/${repo}/contents/${distributionPath}`);
        if (existingRes.ok) {
          const existingFile = await existingRes.json();
          distributionSha = existingFile.sha;
        }
        
        // Read the current CSV file from the repo
        const csvRes = await fetch(`https://raw.githubusercontent.com/${repo}/main/${distributionPath}`);
        let csvContent;
        if (csvRes.ok) {
          csvContent = await csvRes.text();
        } else {
          // If file doesn't exist, create a basic CSV structure
          csvContent = "المفتش,اليوم,المنطقة,المحلات\n";
        }
        
        // Encode the CSV content for GitHub API
        const encodedContent = btoa(unescape(encodeURIComponent(csvContent)));
        
        // Upload/update the file
        const uploadData = {
          message: "تحديث جدول توزيع المحلات من لوحة المطور",
          content: encodedContent
        };
        
        if (distributionSha) {
          uploadData.sha = distributionSha;
        }
        
        const uploadRes = await fetch(`https://api.github.com/repos/${repo}/contents/${distributionPath}`, {
          method: "PUT",
          headers: {
            "Authorization": `token ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(uploadData)
        });
        
        if (uploadRes.status === 200 || uploadRes.status === 201) {
          document.getElementById("status").textContent = "تم رفع الجدول بنجاح إلى GitHub ✅";
        } else {
          const err = await uploadRes.json();
          document.getElementById("status").textContent = "❌ فشل في رفع الجدول: " + (err.message || "تحقق من التوكن أو الصلاحيات.");
          if (uploadRes.status === 401 || uploadRes.status === 403) {
            removeToken();
            setTimeout(showTokenPopup, 500);
          }
        }
      } catch (error) {
        document.getElementById("status").textContent = "❌ خطأ في الاتصال: " + error.message;
      }
      
      document.getElementById("uploadBtn").disabled = false;
    }

    // ---- On Load ----
    window.onload = function() {
      if (!getToken()) {
        showTokenPopup();
      } else {
        loadPlan();
      }
    };
  </script>
</body>
</html>
