<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø®Ø·Ø© Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ± -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Cairo', Arial, sans-serif; background: #f7f9fc; margin:0;}
        .main-container {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 2px 16px #dadce0;
            padding: 36px 18px 24px 18px;
            max-width: 900px;
            min-width:320px;
            margin: 64px auto 0 auto;
            display: flex; flex-direction: column; align-items: center;
        }
        .header-top-bar {
            width:100%;
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom: 8px;
            position: relative;
        }
        .last-update-row {
            color: #666;
            font-size: 0.97em;
            margin-right: 8px;
            margin-top: 0;
            text-align: right;
            direction: ltr;
        }
        .bell-container {
            margin-left:8px;
            margin-top:0;
        }
        .bell-btn {
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
            padding: 0;
        }
        .bell-icon {
            width: 38px;
            height: 38px;
            fill: #ffc107;
            transition: fill 0.2s;
        }
        .bell-btn:hover .bell-icon {
            fill: #ff9800;
        }
        .horizontal-line {
            width: 100%;
            border: none;
            border-top: 1.5px solid #e0e3ea;
            margin: 16px 0 0 0;
        }
        .title-bar {
            width:100%;
            display:flex;
            justify-content:center;
            align-items:center;
            margin-top: 18px;
            margin-bottom: 24px;
        }
        .main-title-box {
            background:#234085;
            color:#fff;
            padding:28px 0 28px 0;
            border-radius:14px;
            width: 96%;
            max-width: 600px;
            min-height: 56px;
            font-size:2.12em;
            text-align:center;
            font-weight: bold;
            letter-spacing: 1px;
            margin:0 auto;
            box-shadow:0 2px 14px #e0e2f5;
        }
        .login-section, .inspector-select-section {margin: 10px 0 18px 0; width: 100%; display:flex;justify-content:center;align-items:center;gap:10px;}
        select, input[type="text"], input[type="date"], input[type="password"] {padding:7px 16px;font-size:1em;border-radius:6px;border:1px solid #b6b6b6;min-width:130px;max-width:210px;}
        .actions-row {width:100%;display:flex;justify-content:center;align-items:center;gap:18px;margin:20px 0 18px;}
        .save-box, .report-box {display:flex;gap:12px;}
        .save-box button, .report-box button {padding:10px 28px;border-radius:8px;border:none;cursor:pointer;font-size:1em;}
        .pdf-btn {background:#d63384;color:#fff;}
        .excel-btn {background:#198754;color:#fff;}
        .inspector-report-btn {background:#234085;color:#fff;}
        .monthly-report-btn {background:#ff9800;color:#fff;}
        .plan-table-container {width:100%;margin:18px 0;}
        .plan-table {width:100%;border-collapse:collapse;border-radius:13px;overflow:hidden;box-shadow:0 2px 14px #eee;}
        .plan-table th,.plan-table td {padding:10px 8px;text-align:center;}
        .plan-table th {
            background:#234085;
            color:#fff;
            font-weight:bold;
            font-size:1.12em;
        }
        .plan-table tr:nth-child(even) {background:#f5f7fb;}
        .plan-table td {
            border-bottom:1px solid #d7dcef;
            font-size:1em;
        }
        .dropdown-shops-btn {
            background:#234085;
            color:#fff;
            border:none;
            border-radius:6px;
            padding:6px 18px;
            cursor:pointer;
            font-size:0.98em;
            min-width:90px;
        }
        .shops-dropdown-list {
            display:none;
            position:fixed;
            background:#fff;
            border:1px solid #23408577;
            border-radius:9px;
            margin-top:5px;
            min-width:130px;
            max-height:210px;
            box-shadow:0 2px 14px #eaeaea;
            z-index:1000;
            right:unset;
            left:unset;
            text-align:right;
            overflow-y:auto;
        }
        .shops-dropdown-list ul {
            list-style: none;
            margin:0; padding:7px 5px;
        }
        .shops-dropdown-list ul li {
            padding:3px 0 3px 0;
            border-bottom:1px solid #eee;
            font-size:0.97em;
        }
        .shops-dropdown-list ul li:last-child {border-bottom:none;}
        .shops-dropdown-wrap {position:relative; display:inline-block;}
        .inspector-report-div {margin:16px 0 0 0;background:#f7f9fc;border-radius:10px;padding:18px 12px;width:100%;color:#234085;font-size:1.1em;box-shadow:0 1px 5px #e2e2e2;}
        .modal-overlay {
            display:none; position:fixed;z-index:9999;right:0;left:0;top:0;bottom:0; background:rgba(0,0,0,0.18);align-items:center;justify-content:center;
        }
        .modal-content {
            background:#fff; border-radius:16px; box-shadow:0 2px 16px #23409333;
            padding:32px 18px; margin:50px auto; max-width:95vw; min-width:70vw; position:relative; text-align:center;
        }
        .modal-content button.close-btn {
            position:absolute; left:10px; top:10px; border:none; background:#d32f2f; color:#fff; border-radius:50%; font-size:1.4em;width:38px;height:38px;cursor:pointer;
        }
        .modal-actions {
            margin: 16px 0 0 0;
            display:flex;
            justify-content:center;
            gap:10px;
        }
        .stats-title {color:#134093;font-size:1.18em;text-align:center;margin-bottom:15px;}
        .stats-table {width:100%;border-collapse:collapse;margin-bottom:0;font-size:1.04em;}
        .stats-table th, .stats-table td {border:1px solid #234093;padding:10px 6px;text-align:center;}
        .stats-table th {background:#234093;color:#fff;}
        .stats-table tr:nth-child(even) {background:#f3f5fa;}
        .footer {text-align:center;margin-top:22px;color:#234085;font-size:0.85em;}
        .red-total {
            color: #d32f2f !important;
            font-weight: bold !important;
            background: #fffbe9;
        }
        .pdf-title-arabic {
            font-size: 1.18em;
            text-align: center;
            color: #234085;
            font-weight: bold;
            margin-bottom: 10px;
            width: 100%;
            margin-top: 0;
        }
        .edit-btn, .delete-btn {
            background: #6c757d; color: #fff; border: none; border-radius: 5px; padding: 6px 12px; margin: 2px; cursor: pointer; font-size: 0.95em;
        }
        .edit-btn:hover { background: #495057; }
        .delete-btn { background: #d32f2f; }
        .delete-btn:hover { background: #b71c1c; }
        .dev-section {background:#e9ecef;border-radius:8px;padding:16px 11px;margin:14px 0 14px 0;}
        .dev-section .close-btn {background:#d32f2f;color:#fff;border:none;border-radius:5px;padding:0 13px;font-size:1.1em;cursor:pointer;float:left;}
        #devPasswordForm {margin-bottom:6px;}
        @media (max-width:600px) {
            .main-container {padding:10px 1vw 7px 1vw;}
            .main-title-box {font-size:1em;padding:16px 0;}
            .plan-table th, .plan-table td {padding:7px 2px;font-size:0.94em;}
            .dropdown-shops-btn {padding:4px 8px;font-size:0.91em;}
            .modal-content {padding:10px 2vw; min-width:unset; max-width:99vw;}
            .stats-table th, .stats-table td {padding:7px 2px;}
            .actions-row {gap:7px;}
        }
    </style>
</head>
<body>
<div class="main-container">
    <div class="header-top-bar">
        <div class="bell-container">
            <button class="bell-btn" id="bellBtn" title="ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ">
                <svg class="bell-icon" id="bellIcon" viewBox="0 0 24 24">
                  <path d="M12 24c1.3 0 2.4-1 2.5-2.3h-5c.1 1.3 1.2 2.3 2.5 2.3zm7-6v-5c0-3.1-1.6-5.6-4.5-6.3V6c0-.8-.7-1.5-1.5-1.5S11.5 5.2 11.5 6v.7C8.6 7.4 7 9.9 7 13v5l-2 2v1h16v-1l-2-2z"/>
                </svg>
            </button>
            <audio id="birdSound">
              <source src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfa93e3.mp3" type="audio/mp3">
            </audio>
        </div>
        <div class="last-update-row" id="lastUpdateRow"></div>
    </div>
    <hr class="horizontal-line">
    <div class="title-bar">
        <div class="main-title-box">Ø®Ø·Ø© Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
    </div>
    <div class="login-section">
        <label for="loginRole">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:</label>
        <select id="loginRole">
            <option value="">-- Ø§Ø®ØªØ± --</option>
            <option value="inspector">Ù…ÙØªØ´</option>
            <option value="developer">Ø§Ù„Ù…Ø·ÙˆØ±</option>
        </select>
        <input type="password" id="devPassword" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…Ø·ÙˆØ±" style="display:none;">
        <button id="devLoginBtn" style="display:none;background:#198754;color:#fff;border:none;padding:7px 20px;border-radius:6px;font-size:1em;cursor:pointer;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆØ±</button>
        <button id="devLogoutBtn" style="display:none;background:#d32f2f;color:#fff;border:none;padding:7px 20px;border-radius:6px;font-size:1em;cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø·ÙˆØ±</button>
        <span id="devError" style="color:#d32f2f;margin-right:10px;"></span>
        <div id="refreshStatus" style="color:#28a745;font-size:0.9em;margin-top:5px;display:none;">ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>
    <div class="inspector-select-section">
        <label for="inspectorSelect">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´ :</label>
        <select id="inspectorSelect">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´ --</option>
        </select>
    </div>
    <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø·ÙˆØ±: Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø®Ø·Ø© -->
    <div id="devSection" class="dev-section" style="display:none;">
        <form id="addEditForm" style="width:100%;max-width:700px;display:flex;flex-wrap:wrap;gap:12px 20px;align-items:center;justify-content:center;margin-bottom:12px;">
            <select id="formInspector" required>
                <option value="">Ù…ÙØªØ´</option>
            </select>
            <input type="date" id="formDay" required>
            <select id="formShift" required>
                <option value="">ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</option>
                <option value="ØµØ¨Ø§Ø­ÙŠØ©">ØµØ¨Ø§Ø­ÙŠØ©</option>
                <option value="Ù…Ø³Ø§Ø¦ÙŠØ©">Ù…Ø³Ø§Ø¦ÙŠØ©</option>
            </select>
            <input type="text" id="formArea" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©" required>
            <input type="text" id="formShops" placeholder="Ø§Ù„Ù…Ø­Ù„Ø§Øª (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø© ,)" required>
            <button type="submit" style="background:#198754;color:#fff;border:none;padding:8px 22px;border-radius:7px;font-size:1em;cursor:pointer;">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„</button>
            <input type="hidden" id="formEditingIndex" value="">
        </form>
    </div>
    <div id="planTableContainer" class="plan-table-container"></div>
    <div class="actions-row">
        <div class="save-box">
            <button class="pdf-btn" onclick="exportTableToPDF()">Ø­ÙØ¸ ÙƒÙ€ PDF</button>
            <button class="excel-btn" onclick="exportTableToExcel()">Ø­ÙØ¸ ÙƒÙ€ Excel</button>
            <button class="refresh-btn" onclick="loadInspectionData()" style="background:#17a2b8;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:1em;cursor:pointer;margin-right:8px;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
        <div class="report-box">
            <button class="inspector-report-btn" onclick="showInspectorReport()">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙØªØ´</button>
            <button class="monthly-report-btn" onclick="showMonthlyReport()">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>
        </div>
    </div>
    <div id="inspectorReportDiv" class="inspector-report-div" style="display:none;"></div>
    <div id="monthlyReportModal" class="modal-overlay">
      <div class="modal-content">
        <button class="close-btn" onclick="closeMonthlyReportModal()">Ã—</button>
        <div class="stats-title">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
        <div class="modal-actions">
            <button class="pdf-btn" onclick="exportMonthlyReportToPDF()">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ€ PDF</button>
            <button class="excel-btn" onclick="exportMonthlyReportToExcel()">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ€ Excel</button>
        </div>
        <div id="monthlyReportContent"></div>
      </div>
    </div>
    <div class="footer">
        ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© &copy; Ø§Ù„Ù…Ø·ÙˆØ± Ø¯. Ø¹Ù„ÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø§Ù„
    </div>
</div>
<script>
// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØªØ´ÙŠÙ† Ø«Ø§Ø¨ØªØ©
let inspectorsData = [
    {id:"hager", name:"Ù‡Ø§Ø¬Ø±"}, {id:"amna", name:"Ø¢Ù…Ù†Ù‡"}, {id:"aya", name:"Ø¢ÙŠÙ‡"},
    {id:"faiz", name:"Ø¯. ÙØ§ÙŠØ² Ø§Ù„Ù…Ø³Ø§Ù„Ù…Ø©"}, {id:"amna2", name:"Ø¯.Ø¢Ù…Ù†Ù‡ Ø¨Ù† ØµØ±Ù…"}
];
let inspectors = inspectorsData.map(i=>i.name);
let isDev = false;
let selectedInspector = "";
const DEV_PASSWORD = "1983";
// Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
let defaultInspectionData = [
    { inspector: "Ù‡Ø§Ø¬Ø±", day: "2025-09-22", shift: "ØµØ¨Ø§Ø­ÙŠØ©", area: "Ø§Ù„Ù…ØµÙØ­", shops: ["Ù…Ø­Ù„ 1", "Ù…Ø­Ù„ 2"] },
    { inspector: "Ù‡Ø§Ø¬Ø±", day: "2025-09-28", shift: "Ù…Ø³Ø§Ø¦ÙŠØ©", area: "Ø§Ù„Ù…ØµÙØ­", shops: ["Ù…Ø­Ù„ 5"] },
    { inspector: "Ø¢Ù…Ù†Ù‡", day: "2025-09-25", shift: "Ù…Ø³Ø§Ø¦ÙŠØ©", area: "Ù…Ø¯ÙŠÙ†Ø© Ø®Ù„ÙŠÙØ©", shops: ["Ù…Ø­Ù„ 3", "Ù…Ø­Ù„ 4"] },
    { inspector: "Ø¢ÙŠÙ‡", day: "2025-09-22", shift: "ØµØ¨Ø§Ø­ÙŠØ©", area: "Ø§Ù„Ù…ØµÙØ­", shops: ["Ù…Ø­Ù„ 7"] },
    { inspector: "Ø¯. ÙØ§ÙŠØ² Ø§Ù„Ù…Ø³Ø§Ù„Ù…Ø©", day: "2025-09-21", shift: "ØµØ¨Ø§Ø­ÙŠØ©", area: "Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø£", shops: ["Ù…Ø­Ù„ 8", "Ù…Ø­Ù„ 9"] },
    { inspector: "Ø¯.Ø¢Ù…Ù†Ù‡ Ø¨Ù† ØµØ±Ù…", day: "2025-09-21", shift: "Ù…Ø³Ø§Ø¦ÙŠØ©", area: "Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø¬", shops: ["Ù…Ø­Ù„ 11"] },
];
let inspectionData = defaultInspectionData.slice();
let lastUpdateTime = null;

// Auto-refresh functionality
function startAutoRefresh() {
    setInterval(async () => {
        try {
            const response = await fetch('./plan-data.json?t=' + Date.now());
            if (response.ok) {
                const data = await response.json();
                if (data.lastUpdate && data.lastUpdate !== lastUpdateTime) {
                    await loadInspectionData();
                    showUpdateMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹');
                }
            }
        } catch (error) {
            console.log('Auto-refresh check failed:', error);
        }
    }, 30000); // Check every 30 seconds
}

// Load data from JSON file
async function loadInspectionData() {
    const statusDiv = document.getElementById('refreshStatus');
    try {
        if (statusDiv) {
            statusDiv.style.display = 'block';
        }
        
        const response = await fetch('./plan-data.json?t=' + Date.now());
        if (response.ok) {
            const data = await response.json();
            if (data.inspectionData && Array.isArray(data.inspectionData)) {
                inspectionData = data.inspectionData;
                lastUpdateTime = data.lastUpdate;
                if (data.inspectors && Array.isArray(data.inspectors)) {
                    inspectorsData = data.inspectors;
                    inspectors = inspectorsData.map(i=>i.name);
                }
                renderPlanTable();
                fillInspectorsDropdowns();
                setLastUpdateDate();
            }
        }
    } catch (error) {
        console.warn('Failed to load plan data, using default data:', error);
        // Fall back to localStorage if JSON fails
        const localData = localStorage.getItem('inspectionData');
        if (localData) {
            inspectionData = JSON.parse(localData);
        }
    } finally {
        if (statusDiv) {
            setTimeout(() => statusDiv.style.display = 'none', 1000);
        }
    }
}

function saveInspectionData() {
    // Save to localStorage as backup
    localStorage.setItem('inspectionData', JSON.stringify(inspectionData));
    setLastUpdateDate();
    
    // For developer mode, we could add GitHub API integration here
    if (isDev) {
        saveToExternalFile();
    }
}

// Function to save data to external JSON file (for developer mode)
async function saveToExternalFile() {
    try {
        const planData = {
            inspectionData: inspectionData,
            inspectors: inspectorsData,
            lastUpdate: new Date().toISOString()
        };
        
        // This would require a backend service or GitHub API integration
        // For now, we'll update the local JSON conceptually
        console.log('Data would be saved to plan-data.json:', planData);
        
        // Display a message to the user
        showUpdateMessage('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ');
    } catch (error) {
        console.error('Failed to save to external file:', error);
        showUpdateMessage('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·');
    }
}

function showUpdateMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = 'position:fixed;top:20px;right:20px;background:#28a745;color:white;padding:10px 15px;border-radius:5px;z-index:1000;';
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    setTimeout(() => document.body.removeChild(messageDiv), 3000);
}
function setLastUpdateDate() {
    let row = document.getElementById('lastUpdateRow');
    let today = new Date();
    let year = today.getFullYear();
    let month = String(today.getMonth()+1).padStart(2,'0');
    let day = String(today.getDate()).padStart(2,'0');
    let hours = today.getHours();
    let minutes = String(today.getMinutes()).padStart(2,'0');
    let period = hours >= 12 ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ù‹Ø§';
    let hour12 = hours % 12;
    if(hour12 === 0) hour12 = 12;
    let timeStr = hour12 + ':' + minutes + ' ' + period;
    let dateStr = year+'-'+month+'-'+day;
    row.textContent = "Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø®Ø·Ø©: " + dateStr + "    " + timeStr;
}
function fillInspectorsDropdowns() {
    // Ù…ÙØªØ´ÙŠÙ† Ù„Ø£Ø¯Ø§Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    const selectInspect = document.getElementById('inspectorSelect');
    selectInspect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙØªØ´ --</option>';
    inspectorsData.forEach(inspector => {
        selectInspect.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
    });
    // Ù…ÙØªØ´ÙŠÙ† ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø·ÙˆØ±
    const select2 = document.getElementById('formInspector');
    if (select2) {
        select2.innerHTML = `<option value="">Ù…ÙØªØ´</option>`;
        inspectorsData.forEach(inspector => {
            select2.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
        });
    }
}
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('bellBtn').addEventListener('click', playBirdSound);
    fillInspectorsDropdowns();
    setLastUpdateDate();
    enableBirdSoundOnFirstInteraction();
    loadInspectionData(); // Load data from JSON file
    startAutoRefresh(); // Start auto-refresh functionality
});

// Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±
document.getElementById("loginRole").addEventListener("change", function() {
    let role = this.value;
    document.getElementById("devError").innerText = "";
    if(role === "developer") {
        document.getElementById("devPassword").style.display = "inline-block";
        document.getElementById("devLoginBtn").style.display = "inline-block";
        document.getElementById("devLogoutBtn").style.display = "none";
        document.getElementById("devSection").style.display = "none";
        isDev = false;
    } else {
        document.getElementById("devPassword").style.display = "none";
        document.getElementById("devLoginBtn").style.display = "none";
        document.getElementById("devLogoutBtn").style.display = "none";
        document.getElementById("devSection").style.display = "none";
        isDev = false;
        renderPlanTable();
    }
});
document.getElementById("devLoginBtn").onclick = function() {
    let pw = document.getElementById("devPassword").value.trim();
    if (pw === DEV_PASSWORD) {
        isDev = true;
        document.getElementById("devSection").style.display = "block";
        document.getElementById("devLogoutBtn").style.display = "inline-block";
        document.getElementById("devPassword").style.display = "none";
        document.getElementById("devLoginBtn").style.display = "none";
        document.getElementById("devError").innerText = "";
        fillInspectorsDropdowns();
        renderPlanTable();
    } else {
        document.getElementById("devError").innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!";
    }
}
document.getElementById("devLogoutBtn").onclick = function() {
    isDev = false;
    document.getElementById("devSection").style.display = "none";
    document.getElementById("devLogoutBtn").style.display = "none";
    document.getElementById("devPassword").style.display = "none";
    document.getElementById("devLoginBtn").style.display = "none";
    document.getElementById("loginRole").value = "";
    document.getElementById("devError").innerText = "";
    renderPlanTable();
};

// Ø§Ù„ØªØºÙŠÙŠØ± Ø¹Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙØªØ´
document.getElementById('inspectorSelect').addEventListener('change', function() {
    selectedInspector = this.value;
    renderPlanTable();
    document.getElementById('inspectorReportDiv').style.display = "none";
});

document.getElementById("addEditForm").addEventListener("submit", function(e){
    e.preventDefault();
    if (!isDev) return;
    let inspector = document.getElementById("formInspector").value;
    let day = document.getElementById("formDay").value;
    let shift = document.getElementById("formShift").value;
    let area = document.getElementById("formArea").value.trim();
    let shops = document.getElementById("formShops").value.split(",").map(s=>s.trim()).filter(Boolean);
    let editingIdx = document.getElementById("formEditingIndex").value;

    if(!inspector || !day || !shift || !area || shops.length === 0) {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!");
        return;
    }
    let newPlan = {inspector, day, shift, area, shops};
    if(editingIdx==="") {
        inspectionData.push(newPlan);
    } else {
        inspectionData[editingIdx] = newPlan;
    }
    saveInspectionData();
    renderPlanTable();
    this.reset();
    document.getElementById("formEditingIndex").value = "";
});

// --- Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®Ø·Ø· Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·ÙˆØ± ---
function renderPlanTable() {
    const container = document.getElementById('planTableContainer');
    let rows = inspectionData;
    // Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…ÙØªØ´ Ù…Ø¹ÙŠÙ‘Ù†
    if(selectedInspector) {
        rows = inspectionData.filter(item => item.inspector === selectedInspector);
    }
    if (rows.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#c00;font-weight:bold;margin:30px 0;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠ Ø®Ø·Ø© ØªÙØªÙŠØ´.</div>';
        return;
    }
    let html = `
    <table class="plan-table" id="inspectorPlanTable">
        <thead>
            <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙØªØ´</th>
                <th>Ø§Ù„ÙŠÙˆÙ…</th>
                <th>ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©</th>
                <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
                <th>Ø§Ù„Ù…Ø­Ù„Ø§Øª</th>
                ${isDev?'<th>ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù</th>':''}
            </tr>
        </thead>
        <tbody>
    `;
    rows.forEach((row, idx) => {
        let shopsStr = row.shops.map(shop=>`<li>${shop}</li>`).join('');
        let realIdx = inspectionData.indexOf(row);
        html += `
            <tr>
                <td>${row.inspector}</td>
                <td>${row.day}</td>
                <td>${row.shift}</td>
                <td>${row.area}</td>
                <td>
                    <div class="shops-dropdown-wrap" id="shopsDropdownWrap${idx}">
                        <button class="dropdown-shops-btn" onclick="toggleShopsDropdown(event, ${idx})">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„Ø§Øª</button>
                        <div class="shops-dropdown-list" id="shopsDropdownList${idx}">
                            <ul>
                                ${shopsStr}
                            </ul>
                        </div>
                    </div>
                </td>
                ${isDev?`
                <td>
                    <button class="edit-btn" onclick="editPlan(${realIdx})">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="delete-btn" onclick="deletePlan(${realIdx})">Ø­Ø°Ù</button>
                </td>
                `:``}
            </tr>
        `;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
}

function editPlan(idx) {
    if (!isDev) return;
    let plan = inspectionData[idx];
    document.getElementById("formInspector").value = plan.inspector;
    document.getElementById("formDay").value = plan.day;
    document.getElementById("formShift").value = plan.shift;
    document.getElementById("formArea").value = plan.area;
    document.getElementById("formShops").value = plan.shops.join(", ");
    document.getElementById("formEditingIndex").value = idx;
    window.scrollTo({top:0,behavior:'smooth'});
}
function deletePlan(idx) {
    if (!isDev) return;
    if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
    inspectionData.splice(idx,1);
    saveInspectionData();
    renderPlanTable();
}

// --- Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ---
window.toggleShopsDropdown = function(event, idx) {
    event.stopPropagation();
    document.querySelectorAll('.shops-dropdown-list').forEach((el,i)=>{
        if(i!==idx) el.style.display='none';
    });
    let btn = event.target;
    let rect = btn.getBoundingClientRect();
    let list = document.getElementById('shopsDropdownList'+idx);
    list.style.display = 'block';
    let top = rect.bottom + window.scrollY + 2;
    let left = rect.right - list.offsetWidth + window.scrollX;
    if ((top + list.offsetHeight) > (window.innerHeight + window.scrollY)) {
        top = rect.top + window.scrollY - list.offsetHeight - 2;
    }
    list.style.top = top+"px";
    list.style.left = (rect.left + window.scrollX) + "px";
};
document.addEventListener('click', function(e){
    if (![...document.querySelectorAll('.shops-dropdown-wrap *')].includes(e.target)) {
        document.querySelectorAll('.shops-dropdown-list').forEach(el=>el.style.display='none');
    }
});

// --- ØµÙˆØª Ø§Ù„Ø¬Ø±Ø³ ÙˆØ§Ù„Ø¹ØµØ§ÙÙŠØ± ---
function playBirdSound() {
    var audio = document.getElementById('birdSound');
    if (!audio) return;
    audio.currentTime = 0;
    audio.play().catch(function(err){});
    setTimeout(function(){ audio.pause(); }, 7000);
}
function enableBirdSoundOnFirstInteraction() {
    function handler() {
        playBirdSound();
        window.removeEventListener('click', handler, true);
        window.removeEventListener('keydown', handler, true);
        window.removeEventListener('touchstart', handler, true);
        window.removeEventListener('change', handler, true);
    }
    window.addEventListener('click', handler, true);
    window.addEventListener('keydown', handler, true);
    window.addEventListener('touchstart', handler, true);
    window.addEventListener('change', handler, true);
}

// --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ---
function exportTableToPDF() {
    let table = document.getElementById('inspectorPlanTable');
    if (!table) { alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±"); return; }
    let wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '18px';
    wrap.style.width = table.offsetWidth + 'px';
    let titleBox = document.createElement('div');
    titleBox.className = "pdf-title-arabic";
    titleBox.innerText = "Ø®Ø·Ø© Ø§Ù„ØªÙØªÙŠØ´ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©";
    wrap.appendChild(titleBox);
    let tableClone = table.cloneNode(true);
    tableClone.style.marginTop = '10px';
    wrap.appendChild(tableClone);
    document.body.appendChild(wrap);
    html2canvas(wrap, {backgroundColor:'#fff', scale:2}).then(function(canvas) {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:"landscape",unit:"pt",format:"a4"});
        let pageWidth = doc.internal.pageSize.getWidth();
        let imgProps = doc.getImageProperties(imgData);
        let pdfWidth = pageWidth - 80;
        let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'PNG', 40, 35, pdfWidth, pdfHeight);
        doc.save(`Ø®Ø·Ø©_Ø§Ù„ØªÙØªÙŠØ´.pdf`);
        document.body.removeChild(wrap);
    });
}
function exportTableToExcel() {
    let table = document.getElementById('inspectorPlanTable');
    if (!table) { alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±"); return; }
    let ws_data = [];
    for(let r of table.rows) {
        let row = [];
        for(let c of r.cells) row.push(c.textContent);
        ws_data.push(row);
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø®Ø·Ø©");
    XLSX.writeFile(wb, `Ø®Ø·Ø©_Ø§Ù„ØªÙØªÙŠØ´.xlsx`);
}
function showInspectorReport() {
    let inspectorName = selectedInspector || "";
    if (!inspectorName) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙØªØ´ Ø£ÙˆÙ„Ø§Ù‹."); return; }
    const div = document.getElementById('inspectorReportDiv');
    const rows = inspectionData.filter(item => item.inspector === inspectorName);
    let total = rows.length;
    let morning = rows.filter(r => r.shift === "ØµØ¨Ø§Ø­ÙŠØ©").length;
    let evening = rows.filter(r => r.shift === "Ù…Ø³Ø§Ø¦ÙŠØ©").length;
    let weekend = rows.filter(r => {
        const dayOfWeek = new Date(r.day).getDay();
        return [5,6,0].includes(dayOfWeek);
    }).length;
    let table = `
    <div class="pdf-title-arabic" id="inspectorReportTitle">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙØªØ´: ${inspectorName}</div>
    <div class="save-box" style="margin-bottom:8px;">
        <button class="pdf-btn" onclick="exportInspectorReportToPDF()">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ€ PDF</button>
        <button class="excel-btn" onclick="exportInspectorReportToExcel()">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ€ Excel</button>
    </div>
    <table class="stats-table" id="inspectorStatsTable">
        <thead>
            <tr>
                <th>Ø¹Ø¯Ø¯ Ø§Ù„ØªÙØªÙŠØ´Ø§Øª</th>
                <th>Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ©</th>
                <th>Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠØ©</th>
                <th>Ø§Ù„Ø¹Ø·Ù„Ø©</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>${total}</td>
                <td>${morning}</td>
                <td>${evening}</td>
                <td>${weekend}</td>
            </tr>
        </tbody>
    </table>
    `;
    div.innerHTML = table;
    div.style.display = "block";
}
function exportInspectorReportToPDF() {
    let titleBox = document.getElementById('inspectorReportTitle');
    let table = document.getElementById('inspectorStatsTable');
    if (!table || !titleBox) return;
    let wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '18px';
    wrap.style.width = table.offsetWidth + 'px';
    let titleClone = titleBox.cloneNode(true);
    let tableClone = table.cloneNode(true);
    tableClone.style.marginTop = '10px';
    wrap.appendChild(titleClone);
    wrap.appendChild(tableClone);
    document.body.appendChild(wrap);
    html2canvas(wrap, {backgroundColor:'#fff', scale:2}).then(function(canvas){
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:"p",unit:"pt",format:"a4"});
        let pageWidth = doc.internal.pageSize.getWidth();
        let imgProps = doc.getImageProperties(imgData);
        let pdfWidth = pageWidth - 80;
        let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'PNG', 40, 35, pdfWidth, pdfHeight);
        doc.save(`ØªÙ‚Ø±ÙŠØ±_${selectedInspector}.pdf`);
        document.body.removeChild(wrap);
    });
}
function exportInspectorReportToExcel() {
    let table = document.getElementById("inspectorStatsTable");
    if (!table) return;
    let ws_data = [];
    for(let r of table.rows) {
        let row = [];
        for(let c of r.cells) row.push(c.textContent);
        ws_data.push(row);
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙØªØ´");
    XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_${selectedInspector}.xlsx`);
}
function showMonthlyReport() {
    let allDays = Array.from(new Set(inspectionData.map(r => r.day))).sort();
    let html = `<div class="pdf-title-arabic" id="monthlyReportTitle">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>`;
    html += `<table class="stats-table" id="monthlyStatsTable"><thead><tr>
        <th>Ø§Ù„Ù…ÙØªØ´</th>`;
    allDays.forEach(day => html += `<th>${day}</th>`);
    html += `<th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ©</th><th>Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠØ©</th><th>Ø§Ù„Ø¹Ø·Ù„Ø©</th></tr></thead><tbody>`;
    let totals = { total:0, morning:0, evening:0, weekend:0, days: Array(allDays.length).fill(0) };
    inspectors.forEach(inspector => {
        const rows = inspectionData.filter(item => item.inspector === inspector);
        html += `<tr><td>${inspector}</td>`;
        allDays.forEach((day,i) => {
            let count = rows.filter(r=>r.day===day).length;
            html += `<td>${count||''}</td>`;
            totals.days[i] += count;
        });
        let total = rows.length;
        let morning = rows.filter(r=>r.shift==="ØµØ¨Ø§Ø­ÙŠØ©").length;
        let evening = rows.filter(r=>r.shift==="Ù…Ø³Ø§Ø¦ÙŠØ©").length;
        let weekend = rows.filter(r=>{
            const dow = new Date(r.day).getDay();
            return [5,6,0].includes(dow);
        }).length;
        html += `<td>${total}</td><td>${morning}</td><td>${evening}</td><td>${weekend}</td></tr>`;
        totals.total += total; totals.morning += morning; totals.evening += evening; totals.weekend += weekend;
    });
    html += `<tr class="red-total">
        <td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>`;
    totals.days.forEach(sum=>html+=`<td>${sum}</td>`);
    html += `<td>${totals.total}</td><td>${totals.morning}</td><td>${totals.evening}</td><td>${totals.weekend}</td></tr>`;
    html += `</tbody></table>`;
    document.getElementById('monthlyReportContent').innerHTML = html;
    document.getElementById('monthlyReportModal').style.display = 'flex';
}
function closeMonthlyReportModal() {
    document.getElementById('monthlyReportModal').style.display = 'none';
}
function exportMonthlyReportToPDF() {
    let titleBox = document.getElementById('monthlyReportTitle');
    let table = document.getElementById("monthlyStatsTable");
    if (!table || !titleBox) return;
    let wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '18px';
    wrap.style.width = table.offsetWidth + 'px';
    let titleClone = titleBox.cloneNode(true);
    let tableClone = table.cloneNode(true);
    tableClone.style.marginTop = '10px';
    wrap.appendChild(titleClone);
    wrap.appendChild(tableClone);
    document.body.appendChild(wrap);
    html2canvas(wrap, {backgroundColor:'#fff', scale:2}).then(function(canvas){
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:"landscape",unit:"pt",format:"a4"});
        let pageWidth = doc.internal.pageSize.getWidth();
        let imgProps = doc.getImageProperties(imgData);
        let pdfWidth = pageWidth - 80;
        let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'PNG', 40, 35, pdfWidth, pdfHeight);
        doc.save(`Ø§Ù„ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø´Ù‡Ø±ÙŠ.pdf`);
        document.body.removeChild(wrap);
    });
}
function exportMonthlyReportToExcel() {
    let table = document.getElementById("monthlyStatsTable");
    if (!table) return;
    let ws_data = [];
    for(let r of table.rows) {
        let row = [];
        for(let c of r.cells) row.push(c.textContent);
        ws_data.push(row);
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ");
    XLSX.writeFile(wb, `Ø§Ù„ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø´Ù‡Ø±ÙŠ.xlsx`);
}
</script>
</body>
</html>
