<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Test High Priority Shops Feature</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Cairo', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      direction: rtl;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    h1 {
      text-align: center;
      color: #2d3561;
      margin-bottom: 30px;
    }
    
    .test-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      color: #2d3561;
      margin-bottom: 8px;
    }
    
    .form-control {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-family: 'Cairo', Arial, sans-serif;
      font-size: 14px;
    }
    
    .info-box {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #2196f3;
    }
    
    .success-box {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border-left: 4px solid #4caf50;
    }
    
    .result {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border: 2px solid #ddd;
    }
    
    optgroup {
      font-weight: bold;
      font-size: 15px;
    }
    
    option {
      padding: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>๐งช ุงุฎุชุจุงุฑ ููุฒุฉ ุงููุญูุงุช ุฐุงุช ุงูุฃููููุฉ ุงูุนุงููุฉ</h1>
    
    <div class="info-box">
      <strong>๐ ุงููุฏู ูู ุงูุงุฎุชุจุงุฑ:</strong>
      <p>ุงูุชุญูู ูู ุฃู ุงููุญูุงุช ุชุธูุฑ ูุตููุฉ ุญุณุจ ุงูุฃููููุฉ ูุงูุชูุงูุฑุ ูุฃู ุงููุญูุงุช ุฐุงุช ุงูุฃููููุฉ ุงูุนุงููุฉ ุชุธูุฑ ุฏุงุฆูุงู ุญุชู ูู ูุงูุช ูุญุฌูุฒุฉ ุฃู ุชู ุชูุชูุดูุง ูุคุฎุฑุงู.</p>
    </div>
    
    <div class="test-section">
      <h2 style="margin-bottom: 15px;">โ๏ธ ุจูุงูุงุช ุงูุงุฎุชุจุงุฑ</h2>
      
      <div class="form-group">
        <label class="form-label">ุงูููุชุด</label>
        <select id="testInspector" class="form-control" onchange="updateTestShops()">
          <option value="">-- ุงุฎุชุฑ ุงูููุชุด --</option>
          <option value="ุฏ. ุขููู ุจู ุตุฑู">ุฏ. ุขููู ุจู ุตุฑู</option>
          <option value="ุฏ. ุขูู ุณูุงูุฉ">ุฏ. ุขูู ุณูุงูุฉ</option>
          <option value="ุฏ. ุญุณููุฉ ุงูุนุงูุฑู">ุฏ. ุญุณููุฉ ุงูุนุงูุฑู</option>
          <option value="ุฏ. ุญุตุฉ ุงูุนูู">ุฏ. ุญุตุฉ ุงูุนูู</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">ุงูุชุงุฑูุฎ</label>
        <input type="date" id="testDate" class="form-control" value="2025-10-20" onchange="updateTestShops()">
      </div>
      
      <div class="form-group">
        <label class="form-label">ุงูููุทูุฉ</label>
        <select id="testArea" class="form-control" onchange="updateTestShops()">
          <option value="">-- ุงุฎุชุฑ ุงูููุทูุฉ --</option>
          <option value="ุณูู ุงููููุงุก">ุณูู ุงููููุงุก</option>
          <option value="ุงูุญุตู">ุงูุญุตู</option>
          <option value="ุดูุงู ุงููุซุจุฉ">ุดูุงู ุงููุซุจุฉ</option>
          <option value="ุงููุตูุญ">ุงููุตูุญ</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">ุงููุญูุงุช ุงููุชุงุญุฉ</label>
        <div class="info-box" style="margin-bottom: 10px; background: #fff3e0; border-left-color: #ff9800;">
          <small>
            <strong>ุงูุชุตููู:</strong>
            <br>๐ด <strong>ุฃููููุฉ ุนุงููุฉ:</strong> ูุญูุงุช ูู ูุชู ุชูุชูุดูุง ููุฐ ูุชุฑุฉ ุทูููุฉ
            <br>๐ก๐ข <strong>ูุญูุงุช ูุชุงุญุฉ:</strong> ูุญูุงุช ูู ูุชู ุญุฌุฒูุง ุงูููู ููู ูุชู ุชูุชูุดูุง ูุคุฎุฑุงู
          </small>
        </div>
        <select id="testShops" class="form-control" multiple size="12" disabled>
          <option value="">-- ุงุฎุชุฑ ุงูููุทูุฉ ุฃููุงู --</option>
        </select>
      </div>
    </div>
    
    <div id="resultSection" class="result" style="display: none;">
      <h3 style="margin-bottom: 10px; color: #2d3561;">๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ</h3>
      <div id="resultContent"></div>
    </div>
    
    <div class="success-box">
      <strong>โ ูุนุงููุฑ ุงููุฌุงุญ:</strong>
      <ul style="margin-top: 10px; padding-right: 20px;">
        <li>ูุฌุจ ุฃู ุชุธูุฑ ุงููุญูุงุช ุฐุงุช ุงูุฃููููุฉ ุงูุนุงููุฉ ูู ุงููุณู ุงูุฃูู</li>
        <li>ูุฌุจ ุฃู ุชุธูุฑ ุงููุญูุงุช ุงููุชุงุญุฉ ูู ุงููุณู ุงูุซุงูู</li>
        <li>ูุฌุจ ุฃู ุชุธูุฑ ุฌููุน ุงููุญูุงุช ุญุชู ูู ูุงูุช ูุญุฌูุฒุฉ ุฃู ุชู ุชูุชูุดูุง ูุคุฎุฑุงู</li>
        <li>ุงูุชุตููู ูุชุบูุฑ ุฏููุงููููุงู ุนูุฏ ุชุบููุฑ ุงูููุชุด ุฃู ุงูุชุงุฑูุฎ</li>
      </ul>
    </div>
  </div>
  
  <script>
    // Test data
    let planData = {
      inspectionData: [
        {
          inspector: "ุฏ. ุขููู ุจู ุตุฑู",
          day: "2025-09-26",
          shift: "ุตุจุงุญูุฉ",
          area: "ุณูู ุงููููุงุก",
          shops: ["ูุญู ุจูุช ุงูุทููุฑ", "ูุญู ุงููููุงุก ููุทููุฑ", "ูุญู ุงูุณุญุฑ ููุทููุฑ"]
        },
        {
          inspector: "ุฏ. ุขูู ุณูุงูุฉ",
          day: "2025-10-15",
          shift: "ุตุจุงุญูุฉ",
          area: "ุณูู ุงููููุงุก",
          shops: ["ูุญู ุฌุฑูู ููุฏุฒ", "ูุญู ุนุตุงููุฑ ุงูุฎููุฌ"]
        },
        {
          inspector: "ุฏ. ุญุณููุฉ ุงูุนุงูุฑู",
          day: "2025-10-20",
          shift: "ุตุจุงุญูุฉ",
          area: "ุณูู ุงููููุงุก",
          shops: ["ูุญู ุจูุช ุงูุทููุฑ"]
        }
      ]
    };
    
    let shopsDetails = {
      "ูุญู ุจูุช ุงูุทููุฑ": { address: "ุณูู ุงููููุงุก", activity: "ุชุฌุงุฑุฉ ุงูุทููุฑ" },
      "ูุญู ุงููููุงุก ููุทููุฑ": { address: "ุณูู ุงููููุงุก", activity: "ุชุฌุงุฑุฉ ุงูุทููุฑ" },
      "ูุญู ุงูุณุญุฑ ููุทููุฑ": { address: "ุณูู ุงููููุงุก", activity: "ุชุฌุงุฑุฉ ุงูุญููุงูุงุช" },
      "ูุญู ุฌุฑูู ููุฏุฒ": { address: "ุณูู ุงููููุงุก", activity: "ุชุฌุงุฑุฉ ุงูุทููุฑ" },
      "ูุญู ุนุตุงููุฑ ุงูุฎููุฌ": { address: "ุณูู ุงููููุงุก", activity: "ุชุฌุงุฑุฉ ุงูุทููุฑ" },
      "ูุญู ุฌุฑุงุญ ููุทููุฑ": { address: "ุณูู ุงููููุงุก", activity: "ุชุฌุงุฑุฉ ุงูุญููุงูุงุช" },
      "ูุญู ูุฌูุฉ ุงูุดุฑู ูุฃุณูุงู ุงูุฒููุฉ": { address: "ุณูู ุงููููุงุก", activity: "ุชุฌุงุฑุฉ ุงูุฃุณูุงู" },
      "ูุญู ุงุฎุชุจุงุฑ ุงููุซุจุฉ": { address: "ุดูุงู ุงููุซุจุฉ", activity: "ุชุฌุงุฑุฉ ุงูุญููุงูุงุช" },
      "ูุญู ุงุฎุชุจุงุฑ ุงููุตูุญ": { address: "ุงููุตูุญ", activity: "ุชุฌุงุฑุฉ ุงูุทููุฑ" }
    };
    
    // Helper functions (same as in admin-dashboard.html)
    function getAllShopsInArea(area) {
      const shops = new Set();
      
      if (shopsDetails) {
        Object.entries(shopsDetails).forEach(([name, details]) => {
          if (details.address === area) {
            shops.add(name);
          }
        });
      }
      
      if (planData && planData.inspectionData) {
        planData.inspectionData.forEach(inspection => {
          if (inspection.area === area && inspection.shops) {
            inspection.shops.forEach(shop => shops.add(shop));
          }
        });
      }
      
      return Array.from(shops);
    }
    
    function isShopAssignedOnDate(shop, date) {
      if (!planData || !planData.inspectionData) return false;
      
      return planData.inspectionData.some(inspection => {
        return inspection.day === date && 
               inspection.shops && 
               inspection.shops.includes(shop);
      });
    }
    
    function wasShopRecentlyInspectedByInspector(shop, inspector, date) {
      if (!planData || !planData.inspectionData || !date) return false;
      
      const targetDate = new Date(date);
      const sevenDaysAgo = new Date(targetDate);
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      
      return planData.inspectionData.some(inspection => {
        if (inspection.inspector !== inspector) return false;
        if (!inspection.shops || !inspection.shops.includes(shop)) return false;
        
        const inspectionDate = new Date(inspection.day);
        return inspectionDate > sevenDaysAgo && inspectionDate < targetDate;
      });
    }
    
    function getLastInspectionDate(shop) {
      if (!planData || !planData.inspectionData) return null;
      
      let lastDate = null;
      
      planData.inspectionData.forEach(inspection => {
        if (inspection.shops && inspection.shops.includes(shop)) {
          if (!lastDate || inspection.day > lastDate) {
            lastDate = inspection.day;
          }
        }
      });
      
      return lastDate;
    }
    
    function calculateShopPriority(shop, inspector, date) {
      let score = 0;
      
      const lastInspection = getLastInspectionDate(shop);
      
      if (!lastInspection) {
        score += 100;
      } else {
        const targetDate = new Date(date || new Date());
        const lastDate = new Date(lastInspection);
        const daysSince = Math.floor((targetDate - lastDate) / (1000 * 60 * 60 * 24));
        
        if (daysSince > 30) {
          score += 80;
        } else if (daysSince > 21) {
          score += 60;
        } else if (daysSince > 14) {
          score += 40;
        } else {
          score += 20;
        }
      }
      
      if (shopsDetails && shopsDetails[shop]) {
        const activity = shopsDetails[shop].activity || '';
        if (activity.includes('ูุฌุจ ุชุณุฌูููุง')) {
          score += 30;
        }
      }
      
      let level = 'low';
      if (score >= 80) level = 'high';
      else if (score >= 50) level = 'medium';
      
      return { level, score };
    }
    
    function updateTestShops() {
      const areaSelect = document.getElementById('testArea');
      const shopsSelect = document.getElementById('testShops');
      const inspectorSelect = document.getElementById('testInspector');
      const dateInput = document.getElementById('testDate');
      const resultSection = document.getElementById('resultSection');
      const resultContent = document.getElementById('resultContent');
      
      const selectedArea = areaSelect.value;
      const inspector = inspectorSelect.value;
      const date = dateInput.value;
      
      if (!selectedArea) {
        shopsSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูููุทูุฉ ุฃููุงู --</option>';
        shopsSelect.disabled = true;
        resultSection.style.display = 'none';
        return;
      }
      
      const allShopsInArea = getAllShopsInArea(selectedArea);
      
      if (allShopsInArea.length === 0) {
        shopsSelect.innerHTML = '<option value="">-- ูุง ุชูุฌุฏ ูุญูุงุช ูู ูุฐู ุงูููุทูุฉ --</option>';
        shopsSelect.disabled = true;
        resultSection.style.display = 'none';
        return;
      }
      
      const availableShops = [];
      const highPriorityShops = [];
      const otherShops = [];
      
      allShopsInArea.forEach(shop => {
        const priority = calculateShopPriority(shop, inspector, date);
        const assignedToday = date ? isShopAssignedOnDate(shop, date) : false;
        const recentlyInspected = inspector && date ? wasShopRecentlyInspectedByInspector(shop, inspector, date) : false;
        
        const shopInfo = {
          name: shop,
          priority: priority.level,
          score: priority.score,
          assignedToday,
          recentlyInspected
        };
        
        if (!assignedToday && !recentlyInspected) {
          if (priority.level === 'high') {
            highPriorityShops.push(shopInfo);
          } else {
            availableShops.push(shopInfo);
          }
        } else {
          if (priority.level === 'high') {
            highPriorityShops.push(shopInfo);
          } else {
            otherShops.push(shopInfo);
          }
        }
      });
      
      const sortByScore = (a, b) => b.score - a.score;
      highPriorityShops.sort(sortByScore);
      availableShops.sort(sortByScore);
      otherShops.sort(sortByScore);
      
      let options = '';
      
      if (highPriorityShops.length > 0) {
        options += '<optgroup label="โโโ ูุญูุงุช ุฐุงุช ุฃููููุฉ ุนุงููุฉ โโโ">';
        highPriorityShops.forEach(shop => {
          const status = shop.assignedToday ? ' [ูุญุฌูุฒ ุงูููู]' : 
                        shop.recentlyInspected ? ' [ุชู ุงูุชูุชูุด ูุคุฎุฑุงู]' : 
                        ' [ูุชุงุญ]';
          options += `<option value="${shop.name}" style="background-color: #ffe6e6;">๐ด ${shop.name}${status}</option>`;
        });
        options += '</optgroup>';
      }
      
      if (availableShops.length > 0) {
        options += '<optgroup label="โโโ ูุญูุงุช ูุชุงุญุฉ โโโ">';
        availableShops.forEach(shop => {
          const priorityIcon = shop.priority === 'medium' ? '๐ก' : '๐ข';
          options += `<option value="${shop.name}">${priorityIcon} ${shop.name} [ูุชุงุญ]</option>`;
        });
        options += '</optgroup>';
      }
      
      if (otherShops.length > 0) {
        options += '<optgroup label="โโโ ูุญูุงุช ุฃุฎุฑู โโโ">';
        otherShops.forEach(shop => {
          const status = shop.assignedToday ? ' [ูุญุฌูุฒ ุงูููู]' : 
                        shop.recentlyInspected ? ' [ุชู ุงูุชูุชูุด ูุคุฎุฑุงู]' : '';
          options += `<option value="${shop.name}" style="color: #999;">${shop.name}${status}</option>`;
        });
        options += '</optgroup>';
      }
      
      if (options === '') {
        shopsSelect.innerHTML = '<option value="">-- ูุง ุชูุฌุฏ ูุญูุงุช ูู ูุฐู ุงูููุทูุฉ --</option>';
        shopsSelect.disabled = true;
        resultSection.style.display = 'none';
        return;
      }
      
      shopsSelect.innerHTML = options;
      shopsSelect.disabled = false;
      
      // Display results
      resultSection.style.display = 'block';
      resultContent.innerHTML = `
        <p><strong>ุฅุฌูุงูู ุงููุญูุงุช:</strong> ${allShopsInArea.length}</p>
        <p><strong>ูุญูุงุช ุฐุงุช ุฃููููุฉ ุนุงููุฉ:</strong> ${highPriorityShops.length}</p>
        <p><strong>ูุญูุงุช ูุชุงุญุฉ:</strong> ${availableShops.length}</p>
        <p><strong>ูุญูุงุช ุฃุฎุฑู:</strong> ${otherShops.length}</p>
        <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
        <p style="color: #4caf50;"><strong>โ ุงููุชูุฌุฉ:</strong> ุฌููุน ุงููุญูุงุช ุชุธูุฑ ุจุดูู ุตุญูุญ ูุตููุฉ ุญุณุจ ุงูุฃููููุฉ!</p>
      `;
    }
  </script>
</body>
</html>
