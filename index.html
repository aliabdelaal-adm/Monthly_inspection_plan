<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>خطة التفتيش الشهرية</title>
    <script>
        // تعريف المتغير isDev
        var isDev = true; // قم بتغيير ذلك حسب الحاجة
        var inspectionData = {}; // تأكد من أن لديك بيانات التفتيش هنا

        // إضافة الأكواد الجديدة
        // زر الحفظ في GitHub ونافذة التوكن
        
        <div id="githubSaveBar" style="display:none; margin: 15px 0;">
          <button id="saveToGitHubBtn" style="background:#222;color:#fff;padding:8px 25px;border-radius:8px;border:none;font-size:16px;cursor:pointer">
            💾 حفظ البيانات في GitHub
          </button>
          <span id="githubSaveMsg" style="margin-right:15px;color:green;font-weight:bold"></span>
        </div>
        <!-- نافذة إدخال التوكن السري -->
        <div id="githubTokenModal" style="display:none; position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0008;z-index:1000;justify-content:center;align-items:center">
          <div style="background:#fff;padding:30px 25px;border-radius:12px;max-width:350px">
            <h4 style="margin-bottom:10px">إدخال GitHub Token</h4>
            <input type="password" id="githubTokenInput" style="width:100%;padding:8px" placeholder="الصق التوكن هنا" />
            <div id="githubTokenMsg" style="color:red;margin:7px 0 0"></div>
            <button onclick="saveGithubToken()" style="margin-top:10px;padding:6px 25px;border-radius:7px;background:#1976d2;color:#fff">حفظ</button>
          </div>
        </div>

        // =============================================
        //   أكواد زر حفظ البيانات في GitHub (جديدة)
        // =============================================

        // إعدادات GitHub
        const GITHUB_REPO = "aliabdelaal-adm/Monthly_inspection_plan"; // غيره لو الريبو مختلف
        const PLAN_FILE = "plan-data.json"; // غيره لو تريد اسم ملف آخر

        function getGithubToken() {
            return localStorage.getItem("github_token") || "";
        }
        function setGithubToken(token) {
            localStorage.setItem("github_token", token);
        }
        function showGithubTokenModal(msg="") {
            document.getElementById("githubTokenModal").style.display = "flex";
            document.getElementById("githubTokenInput").value = "";
            document.getElementById("githubTokenMsg").innerText = msg;
            document.getElementById("githubTokenInput").focus();
        }
        function saveGithubToken() {
            const token = document.getElementById("githubTokenInput").value.trim();
            if(token.length < 10) {
                document.getElementById("githubTokenMsg").innerText = "توكن غير صحيح!";
                return;
            }
            setGithubToken(token);
            document.getElementById("githubTokenModal").style.display = "none";
            document.getElementById("githubSaveMsg").innerText = "تم حفظ التوكن، يمكنك الحفظ الآن.";
        }

        // إظهار زر الحفظ فقط إذا كان المستخدم مطور
        function showGithubSaveIfDeveloper() {
            if(isDev) {
                document.getElementById('githubSaveBar').style.display = '';
            } else {
                document.getElementById('githubSaveBar').style.display = 'none';
            }
        }
        // حدث ظهور الزر عند دخول/خروج المطور
        // أضف هذه الأسطر بعد كل ظهور/إخفاء لصلاحية المطور:
        let origDevLoginBtn = document.getElementById("devLoginBtn").onclick;
        document.getElementById("devLoginBtn").onclick = function() {
            if(origDevLoginBtn) origDevLoginBtn();
            setTimeout(showGithubSaveIfDeveloper, 50);
        };
        let origDevLogoutBtn = document.getElementById("devLogoutBtn").onclick;
        document.getElementById("devLogoutBtn").onclick = function() {
            if(origDevLogoutBtn) origDevLogoutBtn();
            setTimeout(showGithubSaveIfDeveloper, 50);
        };
        // عند تحميل الصفحة أيضًا
        document.addEventListener('DOMContentLoaded', function(){
            showGithubSaveIfDeveloper();
        });

        // منطق الحفظ
        document.getElementById("saveToGitHubBtn").onclick = async function() {
            let token = getGithubToken();
            if (!token) { showGithubTokenModal(); return; }
            // استخدام بيانات inspectionData كما هي في مشروعك
            let planData = inspectionData;
            if (!planData) {
                document.getElementById("githubSaveMsg").innerText = "لم يتم العثور على بيانات للحفظ!";
                return;
            }
            document.getElementById("githubSaveMsg").innerText = "جاري الحفظ...";
            // تحديث وقت الحفظ
            let nowDate = new Date();
            planData.lastUpdate = nowDate.getFullYear()+"-"+String(nowDate.getMonth()+1).padStart(2,'0')+"-"+String(nowDate.getDate()).padStart(2,'0')
                +" "+String(nowDate.getHours()).padStart(2,'0')+":"+String(nowDate.getMinutes()).padStart(2,'0');
            let planContent = JSON.stringify(planData,null,2);
            // احضر sha للملف (إن وجد)
            let sha = null;
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${PLAN_FILE}`);
                if(res.ok) {
                    const json = await res.json();
                    sha = json.sha;
                }
            } catch {}
            // رفع البيانات
            const putRes = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${PLAN_FILE}`, {
                method: "PUT",
                headers: {
                    "Authorization": `token ${token}`,
                    "Accept": "application/vnd.github+json"
                },
                body: JSON.stringify({
                    message: "تحديث خطة التفتيش من صفحة المطور",
                    content: btoa(unescape(encodeURIComponent(planContent))),
                    sha: sha
                })
            });
            if(putRes.ok) {
                document.getElementById("githubSaveMsg").innerText = "✅ تم الحفظ بنجاح في GitHub!";
            } else {
                document.getElementById("githubSaveMsg").innerText = "❌ خطأ في الحفظ (تحقق من التوكن/الصلاحيات)!";
                if(putRes.status === 401) showGithubTokenModal("توكن غير صالح أو منتهي!");
            }
        } 
    </script>
</head>
<body>
    <div id="devSection">
        <!-- قسم المطورين هنا -->
    </div>
    <!-- بقية محتوى الصفحة -->
</body>
</html>
