<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة التحكم الشاملة - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- ABSOLUTE CACHE PREVENTION - All Browsers -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, max-stale=0, post-check=0, pre-check=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- SEO Prevention -->
  <meta name="robots" content="noindex, nofollow">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Chart.js for Data Visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Cairo', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      direction: rtl;
    }
    
    /* Sidebar Navigation */
    .sidebar {
      position: fixed;
      right: 0;
      top: 0;
      width: 280px;
      height: 100vh;
      background: linear-gradient(180deg, #1a1f36 0%, #2d3561 100%);
      padding: 20px;
      overflow-y: auto;
      box-shadow: -5px 0 20px rgba(0,0,0,0.3);
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    .sidebar-header {
      text-align: center;
      padding: 20px 0;
      border-bottom: 2px solid rgba(255,255,255,0.1);
      margin-bottom: 30px;
    }
    
    .sidebar-header h2 {
      color: #fff;
      font-size: 1.5em;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .sidebar-header p {
      color: rgba(255,255,255,0.7);
      font-size: 0.9em;
    }
    
    .nav-menu {
      list-style: none;
    }
    
    .nav-item {
      margin-bottom: 8px;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 14px 18px;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      border-radius: 10px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .nav-link:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
      transform: translateX(-5px);
    }
    
    .nav-link.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 5px 15px rgba(102,126,234,0.3);
    }
    
    .nav-link i {
      margin-left: 15px;
      font-size: 1.2em;
      width: 25px;
      text-align: center;
    }
    
    /* Main Content */
    .main-content {
      margin-right: 280px;
      padding: 30px;
      min-height: 100vh;
    }
    
    .top-bar {
      background: rgba(255,255,255,0.95);
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .top-bar h1 {
      color: #1a1f36;
      font-size: 1.8em;
      font-weight: 700;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .user-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 1.2em;
    }
    
    .user-name {
      font-weight: 600;
      color: #1a1f36;
    }
    
    /* Dashboard Section */
    .section {
      display: none;
    }
    
    .section.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: #fff;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .stat-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .stat-card-title {
      color: #666;
      font-size: 0.95em;
      font-weight: 600;
    }
    
    .stat-card-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      color: #fff;
    }
    
    .stat-card-icon.blue {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .stat-card-icon.green {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .stat-card-icon.orange {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .stat-card-icon.purple {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .stat-card-value {
      font-size: 2.5em;
      font-weight: 700;
      color: #1a1f36;
      margin-bottom: 5px;
    }
    
    .stat-card-label {
      color: #999;
      font-size: 0.9em;
    }
    
    /* Content Cards */
    .content-card {
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .content-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .content-card-title {
      font-size: 1.5em;
      font-weight: 700;
      color: #1a1f36;
    }
    
    /* Buttons */
    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 5px 15px rgba(102,126,234,0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102,126,234,0.4);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: #fff;
      box-shadow: 0 5px 15px rgba(17,153,142,0.3);
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(17,153,142,0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: #fff;
      box-shadow: 0 5px 15px rgba(245,87,108,0.3);
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(245,87,108,0.4);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      color: #fff;
      box-shadow: 0 5px 15px rgba(250,112,154,0.3);
    }
    
    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(250,112,154,0.4);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      color: #1a1f36;
      font-weight: 600;
      font-size: 0.95em;
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-family: 'Cairo', sans-serif;
      font-size: 1em;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }
    
    textarea.form-control {
      resize: vertical;
      min-height: 150px;
      font-family: monospace;
    }
    
    select.form-control {
      cursor: pointer;
    }
    
    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .quick-action-btn {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #e0e0e0;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .quick-action-btn:hover {
      border-color: #667eea;
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(102,126,234,0.2);
    }
    
    .quick-action-btn i {
      font-size: 2.5em;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .quick-action-btn .label {
      color: #1a1f36;
      font-weight: 600;
      font-size: 0.95em;
    }
    
    /* Status Messages */
    .status-message {
      padding: 15px 20px;
      border-radius: 10px;
      margin-top: 15px;
      font-weight: 600;
      display: none;
    }
    
    .status-message.show {
      display: block;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .status-message.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    
    /* Table Styles */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .data-table th,
    .data-table td {
      padding: 12px 15px;
      text-align: right;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .data-table th {
      background: #f8f9fa;
      color: #1a1f36;
      font-weight: 700;
      position: sticky;
      top: 0;
    }
    
    .data-table tbody tr:nth-child(even) {
      background: #fffacd;
    }
    
    .data-table tbody tr:nth-child(odd) {
      background: #ffffff;
    }
    
    .data-table tr:hover {
      background: #f8f9fa;
    }
    
    /* Charts */
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 30px;
    }
    
    /* File List */
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }
    
    .file-item:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }
    
    .file-info {
      flex: 1;
    }
    
    .file-name {
      font-weight: 600;
      color: #1a1f36;
      margin-bottom: 5px;
    }
    
    .file-meta {
      font-size: 0.85em;
      color: #999;
    }
    
    .file-actions {
      display: flex;
      gap: 8px;
    }
    
    .file-actions button {
      padding: 8px 15px;
      font-size: 0.9em;
    }
    
    /* Loading Spinner */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .modal-title {
      font-size: 1.5em;
      font-weight: 700;
      color: #1a1f36;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5em;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .modal-close:hover {
      background: #f0f0f0;
      color: #1a1f36;
    }
    
    .modal-body {
      margin-bottom: 20px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-start;
      gap: 10px;
      padding-top: 15px;
      border-top: 2px solid #f0f0f0;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      
      .main-content {
        margin-right: 0;
        padding: 15px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .top-bar {
        flex-direction: column;
        gap: 15px;
      }
      
      .quick-actions {
        grid-template-columns: 1fr;
      }
    }
    
    /* Toggle Sidebar Button (Mobile) */
    .sidebar-toggle {
      display: none;
      position: fixed;
      left: 20px;
      top: 20px;
      z-index: 2000;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.5em;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(102,126,234,0.3);
    }
    
    @media (max-width: 768px) {
      .sidebar-toggle {
        display: block;
      }
      
      .sidebar {
        transform: translateX(100%);
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
    }
  </style>
</head>
<body>
  
  <!-- Sidebar Toggle Button (Mobile) -->
  <button class="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </button>
  
  <!-- Sidebar Navigation -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>لوحة التحكم الشاملة</h2>
      <p>نظام إدارة متقدم وذكي</p>
    </div>
    
    <ul class="nav-menu">
      <li class="nav-item">
        <a class="nav-link active" onclick="showSection('dashboard')">
          <i class="fas fa-chart-line"></i>
          <span>لوحة المعلومات</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="showSection('quick-actions')">
          <i class="fas fa-bolt"></i>
          <span>الإجراءات السريعة</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="showSection('plan-editor')">
          <i class="fas fa-edit"></i>
          <span>محرر الخطة</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="showSection('file-management')">
          <i class="fas fa-folder-open"></i>
          <span>إدارة الملفات</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="showSection('inspectors')">
          <i class="fas fa-users"></i>
          <span>إدارة المفتشين</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="showSection('areas')">
          <i class="fas fa-map-marked-alt"></i>
          <span>إدارة المناطق</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="showSection('shops')">
          <i class="fas fa-store"></i>
          <span>إدارة المحلات</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="showSection('maintenance')">
          <i class="fas fa-tools"></i>
          <span>وضع الصيانة</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="showSection('reports')">
          <i class="fas fa-chart-bar"></i>
          <span>التقارير والإحصائيات</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="showSection('settings')">
          <i class="fas fa-cog"></i>
          <span>الإعدادات</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="showSection('activity-log')">
          <i class="fas fa-history"></i>
          <span>سجل النشاطات</span>
        </a>
      </li>
      <li class="nav-item" style="margin-top: 20px; border-top: 2px solid rgba(255,255,255,0.1); padding-top: 20px;">
        <h4 style="color: rgba(255,255,255,0.7); font-size: 0.85em; padding: 0 18px; margin-bottom: 10px;">🚀 أدوات المطورين المتقدمة</h4>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="openAdvancedSearch()">
          <i class="fas fa-search-plus"></i>
          <span>البحث المتقدم</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="openCodeInspector()">
          <i class="fas fa-code"></i>
          <span>مفتش الكود</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="openBulkOperations()">
          <i class="fas fa-tasks"></i>
          <span>العمليات المجمعة</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="openDataTransformer()">
          <i class="fas fa-exchange-alt"></i>
          <span>محول البيانات</span>
        </a>
      </li>
      <li class="nav-item" style="margin-top: 20px; border-top: 2px solid rgba(255,255,255,0.1); padding-top: 20px;">
        <a class="nav-link" onclick="window.location.href='index.html'">
          <i class="fas fa-home"></i>
          <span>العودة للموقع</span>
        </a>
      </li>
    </ul>
  </aside>
  
  <!-- Main Content -->
  <main class="main-content">
    
    <!-- Top Bar -->
    <div class="top-bar">
      <h1>مرحباً بك في لوحة التحكم</h1>
      <div class="user-info">
        <div class="user-avatar">د.ع</div>
        <div>
          <div class="user-name">د. علي عبدالعال</div>
          <div style="font-size: 0.85em; color: #999;">مطور النظام</div>
        </div>
      </div>
    </div>
    
    <!-- Dashboard Section -->
    <section id="dashboard" class="section active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-title">إجمالي التفتيشات</div>
            <div class="stat-card-icon blue">
              <i class="fas fa-clipboard-check"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalInspections">-</div>
          <div class="stat-card-label">تفتيش مسجل</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-title">عدد المفتشين</div>
            <div class="stat-card-icon green">
              <i class="fas fa-user-check"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalInspectors">-</div>
          <div class="stat-card-label">مفتش نشط</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-title">عدد المناطق</div>
            <div class="stat-card-icon orange">
              <i class="fas fa-map-marker-alt"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalAreas">-</div>
          <div class="stat-card-label">منطقة مسجلة</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-title">عدد المحلات</div>
            <div class="stat-card-icon purple">
              <i class="fas fa-store"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalShops">-</div>
          <div class="stat-card-label">محل مسجل</div>
        </div>
      </div>
      
      <!-- Charts -->
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">التوزيع حسب المفتشين</h3>
        </div>
        <div class="chart-container">
          <canvas id="inspectorsChart"></canvas>
        </div>
      </div>
      
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">التوزيع حسب المناطق</h3>
        </div>
        <div class="chart-container">
          <canvas id="areasChart"></canvas>
        </div>
      </div>
      
      <!-- Recent Activity -->
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">آخر النشاطات</h3>
          <button class="btn btn-primary" onclick="refreshDashboard()">
            <i class="fas fa-sync-alt"></i>
            تحديث
          </button>
        </div>
        <div id="recentActivity">
          <p style="text-align: center; color: #999; padding: 20px;">لا توجد نشاطات حديثة</p>
        </div>
      </div>
    </section>
    
    <!-- Quick Actions Section -->
    <section id="quick-actions" class="section">
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">الإجراءات السريعة</h3>
        </div>
        <div class="quick-actions">
          <div class="quick-action-btn" onclick="showSection('plan-editor')">
            <i class="fas fa-edit"></i>
            <div class="label">تحرير الخطة</div>
          </div>
          <div class="quick-action-btn" onclick="addNewInspection()">
            <i class="fas fa-plus-circle"></i>
            <div class="label">إضافة تفتيش جديد</div>
          </div>
          <div class="quick-action-btn" onclick="showSection('file-management')">
            <i class="fas fa-upload"></i>
            <div class="label">رفع ملف</div>
          </div>
          <div class="quick-action-btn" onclick="exportData()">
            <i class="fas fa-download"></i>
            <div class="label">تصدير البيانات</div>
          </div>
          <div class="quick-action-btn" onclick="backupData()">
            <i class="fas fa-database"></i>
            <div class="label">نسخة احتياطية</div>
          </div>
          <div class="quick-action-btn" onclick="showSection('maintenance')">
            <i class="fas fa-tools"></i>
            <div class="label">وضع الصيانة</div>
          </div>
          <div class="quick-action-btn" onclick="validateData()">
            <i class="fas fa-check-circle"></i>
            <div class="label">التحقق من البيانات</div>
          </div>
          <div class="quick-action-btn" onclick="showSection('reports')">
            <i class="fas fa-chart-pie"></i>
            <div class="label">عرض التقارير</div>
          </div>
          <div class="quick-action-btn" onclick="openAdvancedSearch()">
            <i class="fas fa-search-plus"></i>
            <div class="label">البحث المتقدم</div>
          </div>
          <div class="quick-action-btn" onclick="openCodeInspector()">
            <i class="fas fa-code"></i>
            <div class="label">مفتش الكود</div>
          </div>
          <div class="quick-action-btn" onclick="openVisualEditor()">
            <i class="fas fa-table"></i>
            <div class="label">المحرر المرئي</div>
          </div>
          <div class="quick-action-btn" onclick="addNewInspection()">
            <i class="fas fa-plus-square"></i>
            <div class="label">إضافة تفتيش سريع</div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Plan Editor Section -->
    <section id="plan-editor" class="section">
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">محرر خطة التفتيش</h3>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-success" onclick="savePlan()" id="savePlanBtn">
              <i class="fas fa-save"></i>
              حفظ التعديلات
            </button>
            <button class="btn btn-warning" onclick="loadPlan()">
              <i class="fas fa-sync-alt"></i>
              إعادة تحميل
            </button>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">بيانات الخطة (JSON)</label>
          <textarea id="planEditor" class="form-control" rows="20" placeholder='{"inspectionData": []}'></textarea>
        </div>
        
        <div class="status-message" id="planEditorStatus"></div>
        
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
          <h4 style="margin-bottom: 10px; color: #1a1f36;">نصائح للتحرير:</h4>
          <ul style="color: #666; line-height: 1.8;">
            <li>تأكد من صحة تنسيق JSON قبل الحفظ</li>
            <li>استخدم محرر JSON خارجي للتعديلات الكبيرة</li>
            <li>احفظ نسخة احتياطية قبل التعديلات الهامة</li>
            <li>تحقق من عدم وجود فواصل زائدة أو ناقصة</li>
          </ul>
        </div>
      </div>
      
      <!-- Visual Plan Editor -->
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">المحرر المرئي</h3>
          <button class="btn btn-primary" onclick="openVisualEditor()">
            <i class="fas fa-table"></i>
            فتح المحرر المرئي
          </button>
        </div>
        <p style="color: #666;">استخدم المحرر المرئي لتعديل البيانات بطريقة أسهل وأكثر سهولة</p>
      </div>
    </section>
    
    <!-- File Management Section -->
    <section id="file-management" class="section">
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">رفع ملف جديد</h3>
        </div>
        
        <div class="form-group">
          <label class="form-label">اختر الملف</label>
          <input type="file" id="fileUpload" class="form-control" 
                 accept=".pdf,.xlsx,.xls,.docx,.doc,.pptx,.ppt,.csv,.txt,.jpg,.jpeg,.png,.gif">
        </div>
        
        <div class="form-group">
          <label class="form-label">التصنيف</label>
          <select id="fileCategory" class="form-control">
            <option value="documents">الوثائق - Documents</option>
            <option value="reports">التقارير - Reports</option>
            <option value="schedules">الجداول - Schedules</option>
            <option value="resources">الموارد - Resources</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">وصف الملف (اختياري)</label>
          <input type="text" id="fileDescription" class="form-control" placeholder="وصف مختصر للملف">
        </div>
        
        <button class="btn btn-primary" onclick="uploadFile()" id="uploadBtn">
          <i class="fas fa-upload"></i>
          رفع الملف
        </button>
        
        <div class="status-message" id="fileUploadStatus"></div>
      </div>
      
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">الملفات المرفوعة</h3>
          <button class="btn btn-primary" onclick="loadFilesList()">
            <i class="fas fa-sync-alt"></i>
            تحديث القائمة
          </button>
        </div>
        <div id="filesList">
          <p style="text-align: center; color: #999; padding: 20px;">انقر على "تحديث القائمة" لعرض الملفات</p>
        </div>
      </div>
    </section>
    
    <!-- Inspectors Section -->
    <section id="inspectors" class="section">
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">إدارة المفتشين</h3>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="addInspector()">
              <i class="fas fa-user-plus"></i>
              إضافة مفتش جديد
            </button>
            <button class="btn btn-success" onclick="saveInspectorsToGitHub()" id="saveInspectorsBtn">
              <i class="fas fa-save"></i>
              <i class="fab fa-github"></i>
              حفظ في GitHub
            </button>
          </div>
        </div>
        <div id="inspectorsList">
          <div class="loader"></div>
        </div>
        <div class="status-message" id="inspectorsStatus"></div>
      </div>
      
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">إحصائيات المفتشين</h3>
        </div>
        <div class="chart-container">
          <canvas id="inspectorsStatsChart"></canvas>
        </div>
      </div>
    </section>
    
    <!-- Areas Section -->
    <section id="areas" class="section">
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">إدارة المناطق</h3>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="addArea()">
              <i class="fas fa-map-marker-alt"></i>
              إضافة منطقة جديدة
            </button>
            <button class="btn btn-success" onclick="saveAreasToGitHub()" id="saveAreasBtn">
              <i class="fas fa-save"></i>
              <i class="fab fa-github"></i>
              حفظ في GitHub
            </button>
          </div>
        </div>
        <div id="areasList">
          <div class="loader"></div>
        </div>
        <div class="status-message" id="areasStatus"></div>
      </div>
      
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">ربط المناطق بالمحلات</h3>
        </div>
        <div class="form-group">
          <label class="form-label">اختر منطقة لعرض المحلات التابعة لها</label>
          <select id="areaFilterSelect" class="form-control" onchange="filterShopsByArea()">
            <option value="">-- اختر منطقة --</option>
          </select>
        </div>
        <div id="areaShopsList" style="margin-top: 20px;">
          <p style="text-align: center; color: #999;">اختر منطقة لعرض المحلات التابعة لها</p>
        </div>
      </div>
    </section>
    
    <!-- Shops Section -->
    <section id="shops" class="section">
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">إدارة المحلات</h3>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="addShop()">
              <i class="fas fa-store"></i>
              إضافة محل جديد
            </button>
            <button class="btn btn-success" onclick="saveShopsToGitHub()" id="saveShopsBtn">
              <i class="fas fa-save"></i>
              <i class="fab fa-github"></i>
              حفظ في GitHub
            </button>
            <button class="btn btn-warning" onclick="loadShops()">
              <i class="fas fa-sync-alt"></i>
              تحديث القائمة
            </button>
          </div>
        </div>
        <div class="form-group" style="margin-top: 20px;">
          <label class="form-label">البحث والفلترة</label>
          <input type="text" id="shopsSearchInput" class="form-control" placeholder="ابحث عن محل..." onkeyup="filterShops()">
        </div>
        <div id="shopsList">
          <div class="loader"></div>
        </div>
        <div class="status-message" id="shopsStatus"></div>
      </div>
    </section>
    
    <!-- Maintenance Section -->
    <section id="maintenance" class="section">
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">وضع الصيانة</h3>
        </div>
        
        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ffc107;">
          <h4 style="margin-bottom: 10px; color: #856404;"><i class="fas fa-exclamation-triangle"></i> تنبيه هام</h4>
          <p style="color: #856404; margin: 0;">عند تفعيل وضع الصيانة، سيتم منع جميع المستخدمين من الوصول للموقع عدا المطور.</p>
        </div>
        
        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
          <button class="btn btn-danger" onclick="enableMaintenanceMode()">
            <i class="fas fa-lock"></i>
            تفعيل وضع الصيانة
          </button>
          <button class="btn btn-success" onclick="disableMaintenanceMode()">
            <i class="fas fa-unlock"></i>
            إلغاء وضع الصيانة
          </button>
          <button class="btn btn-primary" onclick="checkMaintenanceStatus()">
            <i class="fas fa-info-circle"></i>
            فحص الحالة
          </button>
        </div>
        
        <div class="status-message" id="maintenanceStatus"></div>
        
        <div class="content-card" style="margin-top: 20px;">
          <h4 style="margin-bottom: 15px;">رسائل الصيانة المخصصة</h4>
          <div class="form-group">
            <label class="form-label">رسالة الصيانة (عربي)</label>
            <textarea id="maintenanceMessageAr" class="form-control" rows="3">النظام قيد التحديث، الرجاء المحاولة لاحقاً</textarea>
          </div>
          <div class="form-group">
            <label class="form-label">رسالة الصيانة (إنجليزي)</label>
            <textarea id="maintenanceMessageEn" class="form-control" rows="3">System under maintenance, please try again later</textarea>
          </div>
          <button class="btn btn-warning" onclick="updateMaintenanceMessages()">
            <i class="fas fa-edit"></i>
            تحديث الرسائل
          </button>
        </div>

        <!-- Advanced Maintenance Configuration -->
        <div class="content-card" style="margin-top: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
          <h4 style="margin-bottom: 20px; color: #2d3561;"><i class="fas fa-cog"></i> إعدادات متقدمة للصيانة والموسيقى</h4>
          
          <!-- Current Status Display -->
          <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #667eea;">
            <h5 style="margin-bottom: 10px; color: #2d3561;">الحالة الحالية</h5>
            <div id="configCurrentStatus" style="color: #666;">
              <p><strong>فترة الفحص:</strong> <span id="currentCheckInterval">جاري التحميل...</span></p>
              <p><strong>تشغيل الموسيقى تلقائياً:</strong> <span id="currentMusicEnabled">جاري التحميل...</span></p>
              <p><strong>مدة تشغيل الموسيقى:</strong> <span id="currentMusicDuration">جاري التحميل...</span></p>
              <p><strong>مستوى الصوت:</strong> <span id="currentMusicVolume">جاري التحميل...</span></p>
            </div>
          </div>

          <!-- Check Interval Control -->
          <div class="form-group">
            <label class="form-label"><i class="fas fa-clock"></i> فترة فحص وضع الصيانة</label>
            <select id="checkIntervalSelect" class="form-control">
              <option value="0">إيقاف الفحص التلقائي</option>
              <option value="5000">5 ثوانٍ (سريع جداً)</option>
              <option value="10000" selected>10 ثوانٍ (افتراضي)</option>
              <option value="30000">30 ثانية (متوسط)</option>
              <option value="60000">60 ثانية (بطيء)</option>
              <option value="300000">5 دقائق (بطيء جداً)</option>
            </select>
            <small style="color: #666; display: block; margin-top: 5px;">
              تحديد عدد الثواني بين كل فحص لحالة الصيانة. اختر "إيقاف" لمنع الفحص التلقائي تماماً.
            </small>
          </div>

          <!-- Music Autoplay Control -->
          <div class="form-group">
            <label class="form-label"><i class="fas fa-music"></i> تشغيل الموسيقى تلقائياً عند وضع الصيانة</label>
            <div style="display: flex; gap: 10px; align-items: center;">
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="musicEnabled" value="true" style="margin-left: 5px;">
                <span>تفعيل</span>
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="musicEnabled" value="false" checked style="margin-left: 5px;">
                <span>إيقاف</span>
              </label>
            </div>
            <small style="color: #666; display: block; margin-top: 5px;">
              عند التفعيل، سيتم تشغيل الموسيقى تلقائياً عند ظهور شاشة الصيانة.
            </small>
          </div>

          <!-- Music Duration Control -->
          <div class="form-group">
            <label class="form-label"><i class="fas fa-hourglass-half"></i> مدة تشغيل الموسيقى</label>
            <select id="musicDurationSelect" class="form-control">
              <option value="0" selected>تشغيل مستمر (بدون إيقاف)</option>
              <option value="30000">30 ثانية</option>
              <option value="60000">دقيقة واحدة</option>
              <option value="300000">5 دقائق</option>
              <option value="600000">10 دقائق</option>
              <option value="1800000">30 دقيقة</option>
            </select>
            <small style="color: #666; display: block; margin-top: 5px;">
              تحديد مدة تشغيل الموسيقى قبل إيقافها تلقائياً. "تشغيل مستمر" تعني الموسيقى ستستمر بدون توقف.
            </small>
          </div>

          <!-- Music Volume Control -->
          <div class="form-group">
            <label class="form-label"><i class="fas fa-volume-up"></i> مستوى الصوت: <span id="volumeValue">15%</span></label>
            <input type="range" id="musicVolumeSlider" class="form-control" min="0" max="100" value="15" step="1" 
                   style="height: 40px; cursor: pointer;"
                   oninput="document.getElementById('volumeValue').textContent = this.value + '%'">
            <small style="color: #666; display: block; margin-top: 5px;">
              تحديد مستوى صوت الموسيقى (0% = كتم الصوت، 100% = أعلى صوت). القيمة الموصى بها: 10-20% للصوت الخافت.
            </small>
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="saveMaintenanceConfig()">
              <i class="fas fa-save"></i>
              حفظ الإعدادات
            </button>
            <button class="btn btn-info" onclick="loadMaintenanceConfig()">
              <i class="fas fa-sync"></i>
              تحديث الحالة
            </button>
            <button class="btn btn-danger" onclick="emergencyStopAll()">
              <i class="fas fa-stop-circle"></i>
              إيقاف طارئ (كل شيء)
            </button>
          </div>
          
          <div class="status-message" id="configStatus" style="margin-top: 15px;"></div>
        </div>
      </div>
    </section>
    
    <!-- Reports Section -->
    <section id="reports" class="section">
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">التقارير والإحصائيات</h3>
        </div>
        
        <div class="quick-actions">
          <div class="quick-action-btn" onclick="generateMonthlyReport()">
            <i class="fas fa-calendar-alt"></i>
            <div class="label">التقرير الشهري</div>
          </div>
          <div class="quick-action-btn" onclick="generateInspectorReport()">
            <i class="fas fa-user-tie"></i>
            <div class="label">تقرير المفتشين</div>
          </div>
          <div class="quick-action-btn" onclick="generateAreaReport()">
            <i class="fas fa-map"></i>
            <div class="label">تقرير المناطق</div>
          </div>
          <div class="quick-action-btn" onclick="generateShopReport()">
            <i class="fas fa-shopping-bag"></i>
            <div class="label">تقرير المحلات</div>
          </div>
        </div>
      </div>
      
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">إحصائيات متقدمة</h3>
        </div>
        <div id="advancedStats">
          <div class="loader"></div>
        </div>
      </div>
    </section>
    
    <!-- Settings Section -->
    <section id="settings" class="section">
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">الإعدادات العامة</h3>
        </div>
        
        <div class="form-group">
          <label class="form-label">GitHub Token</label>
          <input type="password" id="githubToken" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
          <small style="color: #999; display: block; margin-top: 5px;">
            التوكن المستخدم للوصول إلى GitHub API
          </small>
        </div>
        
        <div class="form-group">
          <label class="form-label">اسم المستودع</label>
          <input type="text" id="repoName" class="form-control" value="aliabdelaal-adm/Monthly_inspection_plan" readonly>
        </div>
        
        <div class="form-group">
          <label class="form-label">وضع التطوير</label>
          <select id="devMode" class="form-control">
            <option value="production">الإنتاج (Production)</option>
            <option value="development">التطوير (Development)</option>
          </select>
        </div>
        
        <button class="btn btn-primary" onclick="saveSettings()">
          <i class="fas fa-save"></i>
          حفظ الإعدادات
        </button>
        
        <div class="status-message" id="settingsStatus"></div>
      </div>
      
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">إدارة النسخ الاحتياطية</h3>
        </div>
        
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
          <button class="btn btn-success" onclick="createBackup()">
            <i class="fas fa-save"></i>
            إنشاء نسخة احتياطية
          </button>
          <button class="btn btn-warning" onclick="listBackups()">
            <i class="fas fa-list"></i>
            عرض النسخ الاحتياطية
          </button>
          <button class="btn btn-danger" onclick="restoreBackup()">
            <i class="fas fa-undo"></i>
            استعادة نسخة احتياطية
          </button>
        </div>
        
        <div id="backupsList" style="margin-top: 20px;"></div>
      </div>
    </section>
    
    <!-- Activity Log Section -->
    <section id="activity-log" class="section">
      <div class="content-card">
        <div class="content-card-header">
          <h3 class="content-card-title">سجل النشاطات</h3>
          <button class="btn btn-primary" onclick="refreshActivityLog()">
            <i class="fas fa-sync-alt"></i>
            تحديث
          </button>
        </div>
        
        <div id="activityLogContent">
          <p style="text-align: center; color: #999; padding: 20px;">جاري تحميل سجل النشاطات...</p>
        </div>
      </div>
    </section>
    
  </main>
  
  <!-- Token Setup Modal -->
  <div id="tokenModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">إدخال GitHub Token</h3>
        <button class="modal-close" onclick="closeTokenModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 15px; color: #666;">
          يرجى إدخال GitHub Personal Access Token للمستودع لتتمكن من إجراء التعديلات.
        </p>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <strong style="color: #856404;">كيفية إنشاء Token:</strong>
          <ol style="margin: 10px 0; padding-right: 20px; color: #856404; font-size: 0.9em;">
            <li>اذهب إلى <a href="https://github.com/settings/tokens" target="_blank" style="color: #0066cc;">GitHub Settings → Tokens</a></li>
            <li>انقر "Generate new token (classic)"</li>
            <li>اختر صلاحية <strong>repo</strong></li>
            <li>انسخ التوكن</li>
          </ol>
        </div>
        
        <div class="form-group">
          <label class="form-label">GitHub Token</label>
          <input type="password" id="tokenInput" class="form-control" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
        </div>
        
        <div class="status-message" id="tokenModalStatus"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveToken()">
          <i class="fas fa-save"></i>
          حفظ
        </button>
        <button class="btn btn-warning" onclick="useDefaultToken()">
          <i class="fas fa-key"></i>
          استخدام التوكن الافتراضي
        </button>
      </div>
    </div>
  </div>

  <!-- Shop Edit Modal -->
  <div id="shopEditModal" class="modal">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3 class="modal-title">✏️ تعديل بيانات المحل</h3>
        <button class="modal-close" onclick="closeShopEditModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="shopEditOriginalName">
        
        <!-- Required Fields Section -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h4 style="color: #2d3561; font-size: 1.1em; margin-bottom: 15px;">📋 المعلومات الأساسية (إجبارية)</h4>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">اسم المحل <span style="color: red;">*</span></label>
            <input type="text" id="shopEditName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="أدخل اسم المحل">
          </div>
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">المنطقة <span style="color: red;">*</span></label>
            <select id="shopEditArea" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">اختر المنطقة...</option>
            </select>
          </div>
        </div>
        
        <!-- Optional Details Section -->
        <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h4 style="color: #2d3561; font-size: 1.1em; margin-bottom: 15px;">📝 التفاصيل الإضافية (اختيارية)</h4>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">اسم المحل بالإنجليزية</label>
            <input type="text" id="shopEditNameEn" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Shop Name in English">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">رقم الترخيص</label>
            <input type="text" id="shopEditLicense" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="مثال: CN-1234567">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">العنوان</label>
            <input type="text" id="shopEditAddress" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="العنوان الكامل للمحل">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">رقم الهاتف</label>
            <input type="tel" id="shopEditPhone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="مثال: 0501234567">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">البريد الإلكتروني</label>
            <input type="email" id="shopEditEmail" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="example@email.com">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">🗺️ موقع المحل على خرائط جوجل</label>
            <!-- ⚠️ CRITICAL: Manual Google Maps link ONLY - NO auto-generation -->
            <input type="url" id="shopEditGoogleMaps" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="https://maps.google.com/...">
            <small style="color: #666; display: block; margin-top: 5px;">
              💡 نسخ رابط الموقع من خرائط جوجل لتسهيل الوصول إلى المحل
            </small>
            <small style="color: #d9534f; display: block; margin-top: 3px; font-weight: 500;">
              ⚠️ يجب نسخ الرابط يدوياً من خرائط جوجل - لا توليد تلقائي
            </small>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">طبيعة نشاط المحل</label>
            <textarea id="shopEditActivity" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" rows="3" placeholder="مثال: بيع الحيوانات الأليفة، بيع أسماك الزينة، بيع الطيور..."></textarea>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">رمز ADM</label>
            <input type="text" id="shopEditAdmCode" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="مثال: ADM0001">
          </div>
        </div>
        
        <div class="status-message" id="shopEditStatus"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveShopEdit()">
          <i class="fas fa-save"></i>
          💾 حفظ فوراً
        </button>
        <button class="btn btn-warning" onclick="closeShopEditModal()">
          <i class="fas fa-times"></i>
          ✕ إلغاء
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // ========================
    // Configuration & Global Variables
    // ========================
    const repo = "aliabdelaal-adm/Monthly_inspection_plan";
    const planPath = "plan-data.json";
    const filesPath = "files.json";
    const maintenancePath = "maintenance-status.json";
    
    let planData = null;
    let filesData = null;
    let planSha = "";
    let filesSha = "";
    let shopsDetails = null;
    
    // Chart instances
    let inspectorsChart = null;
    let areasChart = null;
    let inspectorsStatsChart = null;
    
    // ========================
    // Token Management
    // ========================
    function getToken() {
      return localStorage.getItem("devToken") || "";
    }
    
    function setToken(token) {
      localStorage.setItem("devToken", token);
    }
    
    function removeToken() {
      localStorage.removeItem("devToken");
    }
    
    function showTokenModal() {
      document.getElementById("tokenModal").classList.add("show");
      document.getElementById("tokenInput").focus();
    }
    
    function closeTokenModal() {
      document.getElementById("tokenModal").classList.remove("show");
    }
    
    function saveToken() {
      const token = document.getElementById("tokenInput").value.trim();
      if (!token) {
        showMessage("tokenModalStatus", "error", "يرجى إدخال التوكن!");
        return;
      }
      setToken(token);
      closeTokenModal();
      showMessage("tokenModalStatus", "success", "تم حفظ التوكن بنجاح!");
      setTimeout(() => {
        initDashboard();
      }, 500);
    }
    
    function useDefaultToken() {
      const defaultToken = "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";
      setToken(defaultToken);
      closeTokenModal();
      showMessage("tokenModalStatus", "success", "تم استخدام التوكن الافتراضي!");
      setTimeout(() => {
        initDashboard();
      }, 500);
    }
    
    // ========================
    // Navigation & UI
    // ========================
    function showSection(sectionId) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Remove active class from all nav links
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      
      // Show selected section
      document.getElementById(sectionId).classList.add('active');
      
      // Add active class to clicked nav link
      event.target.closest('.nav-link').classList.add('active');
      
      // Close sidebar on mobile
      if (window.innerWidth <= 768) {
        toggleSidebar();
      }
      
      // Load section-specific data
      loadSectionData(sectionId);
    }
    
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }
    
    function loadSectionData(sectionId) {
      switch(sectionId) {
        case 'dashboard':
          refreshDashboard();
          break;
        case 'plan-editor':
          if (!planData) loadPlan();
          break;
        case 'file-management':
          // File management loads on demand
          break;
        case 'inspectors':
          loadInspectorsList();
          break;
        case 'areas':
          loadAreasList();
          populateAreaFilter();
          break;
        case 'shops':
          loadShops();
          break;
        case 'activity-log':
          refreshActivityLog();
          break;
      }
    }
    
    function showMessage(elementId, type, message) {
      const element = document.getElementById(elementId);
      element.className = `status-message show ${type}`;
      element.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
      
      setTimeout(() => {
        element.classList.remove('show');
      }, 5000);
    }
    
    // ========================
    // Data Loading
    // ========================
    async function loadPlan() {
      const token = getToken();
      if (!token) {
        showTokenModal();
        return;
      }
      
      try {
        showMessage("planEditorStatus", "info", "جاري تحميل البيانات...");
        
        // Try to load from GitHub first
        try {
          const res = await fetch(`https://api.github.com/repos/${repo}/contents/${planPath}`, {
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            }
          });
          
          if (res.ok) {
            const file = await res.json();
            const content = decodeURIComponent(escape(atob(file.content)));
            planData = JSON.parse(content);
            planSha = file.sha;
            
            document.getElementById("planEditor").value = JSON.stringify(planData, null, 2);
            showMessage("planEditorStatus", "success", "تم تحميل البيانات بنجاح من GitHub!");
            
            // Update dashboard stats
            updateDashboardStats();
            return;
          }
        } catch (ghError) {
          console.warn('Could not load from GitHub, trying local file:', ghError.message);
        }
        
        // Fallback: Load from local file
        const localRes = await fetch('plan-data.json');
        if (localRes.ok) {
          planData = await localRes.json();
          planSha = "";
          
          document.getElementById("planEditor").value = JSON.stringify(planData, null, 2);
          showMessage("planEditorStatus", "success", "تم تحميل البيانات بنجاح من الملف المحلي!");
          
          // Update dashboard stats
          updateDashboardStats();
          return;
        }
        
        throw new Error('Could not load plan data from GitHub or local file');
        
      } catch (error) {
        showMessage("planEditorStatus", "error", "خطأ في تحميل البيانات: " + error.message);
        if (error.message.includes("401") || error.message.includes("403")) {
          removeToken();
          setTimeout(showTokenModal, 500);
        }
      }
    }
    
    async function savePlan() {
      const token = getToken();
      if (!token) {
        showTokenModal();
        return;
      }
      
      let jsonData;
      try {
        jsonData = JSON.parse(document.getElementById("planEditor").value);
      } catch(e) {
        showMessage("planEditorStatus", "error", "خطأ في تنسيق JSON! راجع الأقواس والفواصل.");
        return;
      }
      
      try {
        document.getElementById("savePlanBtn").disabled = true;
        showMessage("planEditorStatus", "info", "جاري الحفظ...");
        
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(jsonData, null, 2))));
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${planPath}`, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "تحديث خطة التفتيش من لوحة التحكم المتقدمة",
            content: content,
            sha: planSha
          })
        });
        
        if (res.status === 200 || res.status === 201) {
          showMessage("planEditorStatus", "success", "✅ تم حفظ التعديلات بنجاح!");
          planData = jsonData;
          await loadPlan(); // Reload to get new SHA
          updateDashboardStats();
          logActivity("تعديل خطة التفتيش", "تم حفظ التعديلات على خطة التفتيش");
        } else {
          const err = await res.json().catch(() => ({ message: `HTTP ${res.status}` }));
          showMessage("planEditorStatus", "error", "❌ حدث خطأ: " + (err.message || "تحقق من التوكن"));
        }
      } catch (error) {
        showMessage("planEditorStatus", "error", "❌ خطأ في الاتصال: " + error.message);
      } finally {
        document.getElementById("savePlanBtn").disabled = false;
      }
    }
    
    // ========================
    // Dashboard Statistics
    // ========================
    function updateDashboardStats() {
      if (!planData || !planData.inspectionData) return;
      
      const inspections = planData.inspectionData;
      
      // Count unique inspectors
      const inspectors = new Set(inspections.map(i => i.inspector));
      document.getElementById("totalInspectors").textContent = inspectors.size;
      
      // Count unique areas
      const areas = new Set(inspections.map(i => i.area));
      document.getElementById("totalAreas").textContent = areas.size;
      
      // Count unique shops
      const shops = new Set();
      inspections.forEach(i => {
        if (i.shops && Array.isArray(i.shops)) {
          i.shops.forEach(shop => shops.add(shop));
        }
      });
      document.getElementById("totalShops").textContent = shops.size;
      
      // Total inspections
      document.getElementById("totalInspections").textContent = inspections.length;
      
      // Update charts
      updateCharts(inspections, inspectors, areas);
    }
    
    function updateCharts(inspections, inspectors, areas) {
      // Inspectors distribution
      const inspectorCounts = {};
      inspections.forEach(i => {
        inspectorCounts[i.inspector] = (inspectorCounts[i.inspector] || 0) + 1;
      });
      
      if (inspectorsChart) {
        inspectorsChart.destroy();
      }
      
      const ctx1 = document.getElementById('inspectorsChart');
      if (ctx1) {
        inspectorsChart = new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: Object.keys(inspectorCounts),
            datasets: [{
              label: 'عدد التفتيشات',
              data: Object.values(inspectorCounts),
              backgroundColor: 'rgba(102, 126, 234, 0.7)',
              borderColor: 'rgba(102, 126, 234, 1)',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }
      
      // Areas distribution
      const areaCounts = {};
      inspections.forEach(i => {
        areaCounts[i.area] = (areaCounts[i.area] || 0) + 1;
      });
      
      if (areasChart) {
        areasChart.destroy();
      }
      
      const ctx2 = document.getElementById('areasChart');
      if (ctx2) {
        areasChart = new Chart(ctx2, {
          type: 'pie',
          data: {
            labels: Object.keys(areaCounts),
            datasets: [{
              data: Object.values(areaCounts),
              backgroundColor: [
                'rgba(102, 126, 234, 0.7)',
                'rgba(17, 153, 142, 0.7)',
                'rgba(240, 147, 251, 0.7)',
                'rgba(79, 172, 254, 0.7)',
                'rgba(250, 112, 154, 0.7)',
                'rgba(254, 225, 64, 0.7)'
              ],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
    }
    
    async function refreshDashboard() {
      if (!planData) {
        await loadPlan();
      } else {
        updateDashboardStats();
      }
    }
    
    // ========================
    // File Management
    // ========================
    async function uploadFile() {
      const token = getToken();
      if (!token) {
        showTokenModal();
        return;
      }
      
      const fileInput = document.getElementById("fileUpload");
      const category = document.getElementById("fileCategory").value;
      const description = document.getElementById("fileDescription").value;
      
      if (!fileInput.files[0]) {
        showMessage("fileUploadStatus", "error", "يرجى اختيار ملف أولاً");
        return;
      }
      
      const file = fileInput.files[0];
      const maxSize = 25 * 1024 * 1024; // 25 MB
      if (file.size > maxSize) {
        showMessage("fileUploadStatus", "error", "حجم الملف كبير جداً! يجب أن يكون أقل من 25 MB");
        return;
      }
      
      try {
        document.getElementById("uploadBtn").disabled = true;
        showMessage("fileUploadStatus", "info", "⏳ جاري رفع الملف...");
        
        const reader = new FileReader();
        reader.onload = async function(e) {
          const content = e.target.result.split(',')[1];
          const fileName = file.name;
          const filePath = `files/${category}/${fileName}`;
          
          try {
            const uploadRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
              method: "PUT",
              headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                message: `رفع ملف جديد: ${fileName}`,
                content: content
              })
            });
            
            if (uploadRes.status === 201) {
              await updateFilesRegistry(fileName, filePath, category, file.size, description || fileName, token);
              showMessage("fileUploadStatus", "success", `✅ تم رفع الملف بنجاح! ${fileName}`);
              fileInput.value = '';
              document.getElementById("fileDescription").value = '';
              setTimeout(() => loadFilesList(), 1000);
              logActivity("رفع ملف", `تم رفع الملف: ${fileName}`);
            } else if (uploadRes.status === 422) {
              showMessage("fileUploadStatus", "error", "❌ ملف بنفس الاسم موجود مسبقاً!");
            } else {
              showMessage("fileUploadStatus", "error", "❌ خطأ في رفع الملف");
            }
          } catch (error) {
            showMessage("fileUploadStatus", "error", "❌ خطأ: " + error.message);
          } finally {
            document.getElementById("uploadBtn").disabled = false;
          }
        };
        
        reader.onerror = function() {
          showMessage("fileUploadStatus", "error", "❌ خطأ في قراءة الملف");
          document.getElementById("uploadBtn").disabled = false;
        };
        
        reader.readAsDataURL(file);
        
      } catch (error) {
        showMessage("fileUploadStatus", "error", "❌ خطأ: " + error.message);
        document.getElementById("uploadBtn").disabled = false;
      }
    }
    
    async function updateFilesRegistry(fileName, filePath, category, fileSize, description, token) {
      try {
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filesPath}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        let filesData = { files: [], categories: [], lastUpdate: new Date().toISOString() };
        let currentSha = "";
        
        if (res.ok) {
          const file = await res.json();
          filesData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
          currentSha = file.sha;
        }
        
        const newFile = {
          id: Date.now().toString(),
          name: fileName,
          path: filePath,
          category: category,
          type: fileName.split('.').pop().toLowerCase(),
          size: fileSize,
          uploadDate: new Date().toISOString(),
          description: description,
          uploader: "د. علي عبدالعال",
          visible: true
        };
        
        filesData.files.push(newFile);
        filesData.lastUpdate = new Date().toISOString();
        
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(filesData, null, 2))));
        await fetch(`https://api.github.com/repos/${repo}/contents/${filesPath}`, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: `تحديث سجل الملفات - إضافة ${fileName}`,
            content: content,
            sha: currentSha
          })
        });
      } catch (error) {
        console.error("خطأ في تحديث سجل الملفات:", error);
      }
    }
    
    async function loadFilesList() {
      const token = getToken();
      if (!token) {
        showTokenModal();
        return;
      }
      
      try {
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filesPath}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        if (res.ok) {
          const file = await res.json();
          filesData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
          displayFilesList(filesData.files);
        } else {
          document.getElementById("filesList").innerHTML = '<p style="text-align: center; color: #999;">لا توجد ملفات</p>';
        }
      } catch (error) {
        document.getElementById("filesList").innerHTML = '<p style="text-align: center; color: #f5576c;">خطأ في تحميل الملفات</p>';
      }
    }
    
    function displayFilesList(files) {
      const container = document.getElementById("filesList");
      
      if (!files || files.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999;">لا توجد ملفات مرفوعة</p>';
        return;
      }
      
      const visibleFiles = files.filter(f => f.visible !== false);
      
      let html = '';
      visibleFiles.forEach(file => {
        const fileSize = formatFileSize(file.size);
        const uploadDate = new Date(file.uploadDate).toLocaleDateString('ar-EG');
        
        html += `
          <div class="file-item">
            <div class="file-info">
              <div class="file-name"><i class="fas fa-file"></i> ${file.name}</div>
              <div class="file-meta">${file.description}</div>
              <div class="file-meta">الحجم: ${fileSize} | التاريخ: ${uploadDate}</div>
            </div>
            <div class="file-actions">
              <button class="btn btn-success" onclick="downloadFile('${file.path}')">
                <i class="fas fa-download"></i> تحميل
              </button>
              <button class="btn btn-danger" onclick="deleteFile('${file.id}', '${file.path}', '${escapeQuotes(file.name)}')">
                <i class="fas fa-trash"></i> حذف
              </button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function escapeQuotes(str) {
      return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }
    
    async function downloadFile(filePath) {
      const token = getToken();
      if (!token) return;
      
      try {
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        if (res.ok) {
          const file = await res.json();
          const content = atob(file.content);
          const blob = new Blob([content], { type: 'application/octet-stream' });
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = file.name;
          a.click();
          URL.revokeObjectURL(url);
        }
      } catch (error) {
        console.error("خطأ في تحميل الملف:", error);
      }
    }
    
    async function deleteFile(fileId, filePath, fileName) {
      if (!confirm(`هل أنت متأكد من حذف الملف "${fileName}"؟`)) {
        return;
      }
      
      const token = getToken();
      if (!token) return;
      
      try {
        const fileRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        if (fileRes.ok) {
          const file = await fileRes.json();
          const deleteRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
            method: "DELETE",
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              message: `حذف الملف: ${fileName}`,
              sha: file.sha
            })
          });
          
          if (deleteRes.ok) {
            await removeFromFilesRegistry(fileId, token);
            loadFilesList();
            logActivity("حذف ملف", `تم حذف الملف: ${fileName}`);
          }
        }
      } catch (error) {
        console.error("خطأ في حذف الملف:", error);
      }
    }
    
    async function removeFromFilesRegistry(fileId, token) {
      try {
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filesPath}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        if (res.ok) {
          const file = await res.json();
          const filesData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
          
          filesData.files = filesData.files.filter(f => f.id !== fileId);
          filesData.lastUpdate = new Date().toISOString();
          
          const content = btoa(unescape(encodeURIComponent(JSON.stringify(filesData, null, 2))));
          await fetch(`https://api.github.com/repos/${repo}/contents/${filesPath}`, {
            method: "PUT",
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              message: `تحديث سجل الملفات - حذف ملف`,
              content: content,
              sha: file.sha
            })
          });
        }
      } catch (error) {
        console.error("خطأ في تحديث سجل الملفات:", error);
      }
    }
    
    // ========================
    // Inspectors Management
    // ========================
    function loadInspectorsList() {
      if (!planData || !planData.inspectionData) {
        document.getElementById("inspectorsList").innerHTML = '<p style="text-align: center; color: #999;">لا توجد بيانات</p>';
        return;
      }
      
      const inspections = planData.inspectionData;
      const inspectorStats = {};
      
      inspections.forEach(i => {
        if (!inspectorStats[i.inspector]) {
          inspectorStats[i.inspector] = {
            name: i.inspector,
            totalInspections: 0,
            areas: new Set(),
            shops: new Set()
          };
        }
        inspectorStats[i.inspector].totalInspections++;
        inspectorStats[i.inspector].areas.add(i.area);
        if (i.shops && Array.isArray(i.shops)) {
          i.shops.forEach(shop => inspectorStats[i.inspector].shops.add(shop));
        }
      });
      
      let html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>المفتش</th>
              <th>عدد التفتيشات</th>
              <th>عدد المناطق</th>
              <th>عدد المحلات</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      Object.values(inspectorStats).forEach(inspector => {
        html += `
          <tr>
            <td><i class="fas fa-user-tie"></i> ${inspector.name}</td>
            <td>${inspector.totalInspections}</td>
            <td>${inspector.areas.size}</td>
            <td>${inspector.shops.size}</td>
            <td>
              <button class="btn btn-warning" style="padding: 5px 10px; font-size: 0.85em; margin-left: 5px;" 
                      onclick="editInspector('${inspector.name.replace(/'/g, "\\'")}')">
                <i class="fas fa-edit"></i> تعديل
              </button>
              <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.85em;" 
                      onclick="deleteInspector('${inspector.name.replace(/'/g, "\\'")}')">
                <i class="fas fa-trash"></i> حذف
              </button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      document.getElementById("inspectorsList").innerHTML = html;
    }
    
    // ========================
    // Areas Management
    // ========================
    function loadAreasList() {
      if (!planData || !planData.inspectionData) {
        document.getElementById("areasList").innerHTML = '<p style="text-align: center; color: #999;">لا توجد بيانات</p>';
        return;
      }
      
      const inspections = planData.inspectionData;
      const areaStats = {};
      
      inspections.forEach(i => {
        if (!areaStats[i.area]) {
          areaStats[i.area] = {
            name: i.area,
            totalInspections: 0,
            inspectors: new Set(),
            shops: new Set()
          };
        }
        areaStats[i.area].totalInspections++;
        areaStats[i.area].inspectors.add(i.inspector);
        if (i.shops && Array.isArray(i.shops)) {
          i.shops.forEach(shop => areaStats[i.area].shops.add(shop));
        }
      });
      
      let html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>المنطقة</th>
              <th>عدد التفتيشات</th>
              <th>عدد المفتشين</th>
              <th>عدد المحلات</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      Object.values(areaStats).forEach(area => {
        html += `
          <tr>
            <td><i class="fas fa-map-marker-alt"></i> ${area.name}</td>
            <td>${area.totalInspections}</td>
            <td>${area.inspectors.size}</td>
            <td>${area.shops.size}</td>
            <td>
              <button class="btn btn-warning" style="padding: 5px 10px; font-size: 0.85em; margin-left: 5px;" 
                      onclick="editArea('${area.name.replace(/'/g, "\\'")}')">
                <i class="fas fa-edit"></i> تعديل
              </button>
              <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.85em;" 
                      onclick="deleteArea('${area.name.replace(/'/g, "\\'")}')">
                <i class="fas fa-trash"></i> حذف
              </button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      document.getElementById("areasList").innerHTML = html;
    }
    
    // ========================
    // Shops Management
    // ========================
    function loadShopsList() {
      if (!planData || !planData.inspectionData) {
        document.getElementById("shopsList").innerHTML = '<p style="text-align: center; color: #999;">لا توجد بيانات</p>';
        return;
      }
      
      const inspections = planData.inspectionData;
      const shopStats = {};
      
      inspections.forEach(i => {
        if (i.shops && Array.isArray(i.shops)) {
          i.shops.forEach(shop => {
            if (!shopStats[shop]) {
              shopStats[shop] = {
                name: shop,
                totalInspections: 0,
                areas: new Set(),
                inspectors: new Set()
              };
            }
            shopStats[shop].totalInspections++;
            shopStats[shop].areas.add(i.area);
            shopStats[shop].inspectors.add(i.inspector);
          });
        }
      });
      
      let html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>المحل</th>
              <th>عدد التفتيشات</th>
              <th>عدد المناطق</th>
              <th>عدد المفتشين</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      Object.values(shopStats).forEach(shop => {
        html += `
          <tr>
            <td><i class="fas fa-store"></i> ${shop.name}</td>
            <td>${shop.totalInspections}</td>
            <td>${shop.areas.size}</td>
            <td>${shop.inspectors.size}</td>
            <td>
              <button class="btn btn-warning" style="padding: 5px 10px; font-size: 0.85em; margin-left: 5px;" 
                      onclick="editShop('${shop.name.replace(/'/g, "\\'")}')">
                <i class="fas fa-edit"></i> تعديل
              </button>
              <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.85em;" 
                      onclick="deleteShop('${shop.name.replace(/'/g, "\\'")}')">
                <i class="fas fa-trash"></i> حذف
              </button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      document.getElementById("shopsList").innerHTML = html;
    }
    
    // ========================
    // GitHub Direct Save Functions
    // ========================
    
    // Save Inspectors to GitHub
    async function saveInspectorsToGitHub() {
      const token = getToken();
      if (!token) {
        showTokenModal();
        return;
      }
      
      if (!planData || !planData.inspectionData) {
        showMessage("inspectorsStatus", "error", "لا توجد بيانات للحفظ!");
        return;
      }
      
      try {
        showMessage("inspectorsStatus", "info", "جاري حفظ المفتشين في GitHub...");
        document.getElementById("saveInspectorsBtn").disabled = true;
        
        await savePlanToGitHub();
        
        showMessage("inspectorsStatus", "success", "✅ تم حفظ بيانات المفتشين في GitHub بنجاح!");
        logActivity("حفظ المفتشين", "تم حفظ بيانات المفتشين مباشرة في GitHub");
        
      } catch (error) {
        showMessage("inspectorsStatus", "error", "❌ فشل حفظ البيانات: " + error.message);
      } finally {
        document.getElementById("saveInspectorsBtn").disabled = false;
      }
    }
    
    // Save Areas to GitHub
    async function saveAreasToGitHub() {
      const token = getToken();
      if (!token) {
        showTokenModal();
        return;
      }
      
      if (!planData || !planData.inspectionData) {
        showMessage("areasStatus", "error", "لا توجد بيانات للحفظ!");
        return;
      }
      
      try {
        showMessage("areasStatus", "info", "جاري حفظ المناطق في GitHub...");
        document.getElementById("saveAreasBtn").disabled = true;
        
        await savePlanToGitHub();
        
        showMessage("areasStatus", "success", "✅ تم حفظ بيانات المناطق في GitHub بنجاح!");
        logActivity("حفظ المناطق", "تم حفظ بيانات المناطق مباشرة في GitHub");
        
        // Refresh area dropdown
        populateAreaFilter();
        
      } catch (error) {
        showMessage("areasStatus", "error", "❌ فشل حفظ البيانات: " + error.message);
      } finally {
        document.getElementById("saveAreasBtn").disabled = false;
      }
    }
    
    // Save Shops to GitHub
    async function saveShopsToGitHub() {
      const token = getToken();
      if (!token) {
        showTokenModal();
        return;
      }
      
      if (!planData || !planData.inspectionData) {
        showMessage("shopsStatus", "error", "لا توجد بيانات للحفظ!");
        return;
      }
      
      try {
        showMessage("shopsStatus", "info", "جاري حفظ المحلات في GitHub...");
        document.getElementById("saveShopsBtn").disabled = true;
        
        await savePlanToGitHub();
        
        showMessage("shopsStatus", "success", "✅ تم حفظ بيانات المحلات في GitHub بنجاح!");
        logActivity("حفظ المحلات", "تم حفظ بيانات المحلات مباشرة في GitHub");
        
      } catch (error) {
        showMessage("shopsStatus", "error", "❌ فشل حفظ البيانات: " + error.message);
      } finally {
        document.getElementById("saveShopsBtn").disabled = false;
      }
    }
    
    // Helper function to save plan to GitHub
    async function savePlanToGitHub() {
      const token = getToken();
      if (!token) {
        throw new Error("لا يوجد توكن GitHub");
      }
      
      // Encode plan data
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(planData, null, 2))));
      
      // Get current file SHA
      const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${planPath}`, {
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        }
      });
      
      if (!getRes.ok) {
        throw new Error("فشل في الحصول على SHA للملف");
      }
      
      const fileData = await getRes.json();
      const sha = fileData.sha;
      
      // Update file on GitHub
      const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/${planPath}`, {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "تحديث البيانات من لوحة التحكم - Developer Dashboard Update",
          content: content,
          sha: sha,
          branch: "main"
        })
      });
      
      if (!putRes.ok) {
        const errorData = await putRes.json();
        throw new Error(errorData.message || "فشل في حفظ الملف");
      }
      
      return await putRes.json();
    }
    
    // Wrapper function for compatibility with smart-planner style calls
    async function savePlanDataToGitHub(commitMessage) {
      // Note: commitMessage is currently not used in savePlanToGitHub
      // Future enhancement: pass custom commit messages
      return await savePlanToGitHub();
    }
    
    // Filter shops by area
    function filterShopsByArea() {
      const selectedArea = document.getElementById("areaFilterSelect").value;
      const container = document.getElementById("areaShopsList");
      
      if (!selectedArea) {
        container.innerHTML = '<p style="text-align: center; color: #999;">اختر منطقة لعرض المحلات التابعة لها</p>';
        return;
      }
      
      if (!planData || !planData.inspectionData) {
        container.innerHTML = '<p style="text-align: center; color: #999;">لا توجد بيانات</p>';
        return;
      }
      
      // Collect shops for selected area
      const areaShops = new Set();
      planData.inspectionData.forEach(inspection => {
        if (inspection.area === selectedArea && inspection.shops) {
          inspection.shops.forEach(shop => areaShops.add(shop));
        }
      });
      
      if (areaShops.size === 0) {
        container.innerHTML = `<p style="text-align: center; color: #999;">لا توجد محلات مسجلة في منطقة "${selectedArea}"</p>`;
        return;
      }
      
      // Display shops
      let html = `
        <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
          <h4 style="margin-bottom: 10px; color: #2e7d32;">
            <i class="fas fa-map-marked-alt"></i> المحلات في منطقة: ${selectedArea}
          </h4>
          <p style="color: #555;">عدد المحلات: <strong>${areaShops.size}</strong></p>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
      `;
      
      Array.from(areaShops).sort().forEach((shop, index) => {
        html += `
          <div style="background: #fff; border: 2px solid #4caf50; border-radius: 10px; padding: 15px; transition: all 0.3s ease;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="background: linear-gradient(135deg, #4caf50 0%, #81c784 100%); 
                          width: 40px; height: 40px; border-radius: 50%; 
                          display: flex; align-items: center; justify-content: center; 
                          color: white; font-weight: bold;">
                ${index + 1}
              </div>
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #1a1f36; margin-bottom: 5px;">
                  <i class="fas fa-store"></i> ${shop}
                </div>
                <div style="font-size: 0.85em; color: #666;">
                  <i class="fas fa-map-marker-alt"></i> ${selectedArea}
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    // Populate area filter dropdown
    function populateAreaFilter() {
      if (!planData || !planData.inspectionData) return;
      
      const areas = new Set();
      planData.inspectionData.forEach(inspection => {
        if (inspection.area) {
          areas.add(inspection.area);
        }
      });
      
      const select = document.getElementById("areaFilterSelect");
      if (!select) return;
      
      select.innerHTML = '<option value="">-- اختر منطقة --</option>';
      Array.from(areas).sort().forEach(area => {
        const option = document.createElement('option');
        option.value = area;
        option.textContent = area;
        select.appendChild(option);
      });
    }
    
    // Load shops with enhanced features
    function loadShops() {
      loadShopsList();
      populateAreaFilter();
    }
    
    // Filter shops in the shops list
    function filterShops() {
      const searchTerm = document.getElementById("shopsSearchInput").value.toLowerCase();
      const table = document.querySelector("#shopsList table");
      
      if (!table) return;
      
      const rows = table.querySelectorAll("tbody tr");
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? "" : "none";
      });
    }
    
    // ========================
    // Edit and Delete Functions
    // ========================
    
    // Edit Inspector
    function editInspector(oldName) {
      const newName = prompt(`تعديل اسم المفتش:\n\nالاسم الحالي: ${oldName}\n\nأدخل الاسم الجديد:`, oldName);
      
      if (!newName || newName === oldName) return;
      
      if (!confirm(`هل تريد تغيير اسم المفتش من "${oldName}" إلى "${newName}"؟\n\nسيتم تحديث جميع السجلات المرتبطة.`)) {
        return;
      }
      
      // Update all inspections with this inspector
      let updateCount = 0;
      planData.inspectionData.forEach(inspection => {
        if (inspection.inspector === oldName) {
          inspection.inspector = newName;
          updateCount++;
        }
      });
      
      // Update the plan editor
      document.getElementById('planEditor').value = JSON.stringify(planData, null, 2);
      
      // Reload the list
      loadInspectorsList();
      
      showMessage("inspectorsStatus", "success", `✅ تم تحديث ${updateCount} سجل بنجاح! اضغط "حفظ في GitHub" لحفظ التغييرات.`);
      logActivity("تعديل مفتش", `تم تغيير اسم المفتش من "${oldName}" إلى "${newName}"`);
    }
    
    // Delete Inspector
    function deleteInspector(name) {
      if (!confirm(`⚠️ هل أنت متأكد من حذف جميع سجلات المفتش "${name}"؟\n\nهذا الإجراء لا يمكن التراجع عنه!`)) {
        return;
      }
      
      const beforeCount = planData.inspectionData.length;
      planData.inspectionData = planData.inspectionData.filter(inspection => inspection.inspector !== name);
      const deletedCount = beforeCount - planData.inspectionData.length;
      
      if (deletedCount === 0) {
        showMessage("inspectorsStatus", "warning", "لم يتم العثور على سجلات للحذف!");
        return;
      }
      
      // Update the plan editor
      document.getElementById('planEditor').value = JSON.stringify(planData, null, 2);
      
      // Reload the list
      loadInspectorsList();
      
      showMessage("inspectorsStatus", "success", `✅ تم حذف ${deletedCount} سجل للمفتش "${name}"! اضغط "حفظ في GitHub" لحفظ التغييرات.`);
      logActivity("حذف مفتش", `تم حذف ${deletedCount} سجل للمفتش "${name}"`);
    }
    
    // Edit Area
    function editArea(oldName) {
      const newName = prompt(`تعديل اسم المنطقة:\n\nالاسم الحالي: ${oldName}\n\nأدخل الاسم الجديد:`, oldName);
      
      if (!newName || newName === oldName) return;
      
      if (!confirm(`هل تريد تغيير اسم المنطقة من "${oldName}" إلى "${newName}"؟\n\nسيتم تحديث جميع السجلات المرتبطة.`)) {
        return;
      }
      
      // Update all inspections with this area
      let updateCount = 0;
      planData.inspectionData.forEach(inspection => {
        if (inspection.area === oldName) {
          inspection.area = newName;
          updateCount++;
        }
      });
      
      // Update the plan editor
      document.getElementById('planEditor').value = JSON.stringify(planData, null, 2);
      
      // Reload the list
      loadAreasList();
      populateAreaFilter();
      
      showMessage("areasStatus", "success", `✅ تم تحديث ${updateCount} سجل بنجاح! اضغط "حفظ في GitHub" لحفظ التغييرات.`);
      logActivity("تعديل منطقة", `تم تغيير اسم المنطقة من "${oldName}" إلى "${newName}"`);
    }
    
    // Delete Area
    function deleteArea(name) {
      if (!confirm(`⚠️ هل أنت متأكد من حذف جميع سجلات المنطقة "${name}"؟\n\nهذا الإجراء لا يمكن التراجع عنه!`)) {
        return;
      }
      
      const beforeCount = planData.inspectionData.length;
      planData.inspectionData = planData.inspectionData.filter(inspection => inspection.area !== name);
      const deletedCount = beforeCount - planData.inspectionData.length;
      
      if (deletedCount === 0) {
        showMessage("areasStatus", "warning", "لم يتم العثور على سجلات للحذف!");
        return;
      }
      
      // Update the plan editor
      document.getElementById('planEditor').value = JSON.stringify(planData, null, 2);
      
      // Reload the list
      loadAreasList();
      populateAreaFilter();
      
      showMessage("areasStatus", "success", `✅ تم حذف ${deletedCount} سجل للمنطقة "${name}"! اضغط "حفظ في GitHub" لحفظ التغييرات.`);
      logActivity("حذف منطقة", `تم حذف ${deletedCount} سجل للمنطقة "${name}"`);
    }
    
    // Edit Shop
    async function editShop(shopName) {
      // Check if data is loaded
      if (!planData || !planData.shops) {
        alert('⚠️ لم يتم تحميل البيانات بعد!\n\nالرجاء الضغط على زر "تحديث القائمة" أولاً لتحميل البيانات.');
        return;
      }
      
      // Find the shop in planData
      const shop = planData.shops.find(s => s.name === shopName);
      if (!shop) {
        alert('❌ لم يتم العثور على المحل في قاعدة البيانات');
        return;
      }
      
      // Store original name for update
      document.getElementById('shopEditOriginalName').value = shopName;
      
      // Populate required fields
      document.getElementById('shopEditName').value = shop.name;
      
      // Populate areas dropdown
      const areaSelect = document.getElementById('shopEditArea');
      areaSelect.innerHTML = '<option value="">اختر المنطقة...</option>';
      if (planData.areas) {
        planData.areas.forEach(area => {
          const option = document.createElement('option');
          option.value = area.id;
          option.textContent = area.name;
          areaSelect.appendChild(option);
        });
      }
      areaSelect.value = shop.areaId || '';
      
      // Load additional details from shops_details.json
      try {
        const response = await fetch('shops_details.json?' + new Date().getTime());
        const shopsDetails = await response.json();
        const details = shopsDetails[shopName];
        
        if (details) {
          document.getElementById('shopEditNameEn').value = details.nameEn || '';
          document.getElementById('shopEditLicense').value = details.licenseNo || '';
          document.getElementById('shopEditAddress').value = details.address || '';
          document.getElementById('shopEditPhone').value = details.contact || '';
          document.getElementById('shopEditEmail').value = details.email || '';
          document.getElementById('shopEditGoogleMaps').value = details.locationMap || '';
          document.getElementById('shopEditActivity').value = details.activity || '';
          document.getElementById('shopEditAdmCode').value = details.admCode || '';
        } else {
          // Clear optional fields if no details found
          document.getElementById('shopEditNameEn').value = '';
          document.getElementById('shopEditLicense').value = '';
          document.getElementById('shopEditAddress').value = '';
          document.getElementById('shopEditPhone').value = '';
          document.getElementById('shopEditEmail').value = '';
          document.getElementById('shopEditGoogleMaps').value = '';
          document.getElementById('shopEditActivity').value = '';
          document.getElementById('shopEditAdmCode').value = '';
        }
      } catch (error) {
        console.error('Error loading shop details:', error);
        // Clear optional fields on error
        document.getElementById('shopEditNameEn').value = '';
        document.getElementById('shopEditLicense').value = '';
        document.getElementById('shopEditAddress').value = '';
        document.getElementById('shopEditPhone').value = '';
        document.getElementById('shopEditEmail').value = '';
        document.getElementById('shopEditGoogleMaps').value = '';
        document.getElementById('shopEditActivity').value = '';
        document.getElementById('shopEditAdmCode').value = '';
      }
      
      // Show modal
      document.getElementById('shopEditModal').classList.add('show');
    }
    
    // Close shop edit modal
    function closeShopEditModal() {
      document.getElementById('shopEditModal').classList.remove('show');
    }
    
    // Save shop edit
    async function saveShopEdit() {
      const originalName = document.getElementById('shopEditOriginalName').value;
      const newName = document.getElementById('shopEditName').value.trim();
      const areaId = document.getElementById('shopEditArea').value;
      
      // Get optional fields
      const nameEn = document.getElementById('shopEditNameEn').value.trim();
      const licenseNo = document.getElementById('shopEditLicense').value.trim();
      const address = document.getElementById('shopEditAddress').value.trim();
      const contact = document.getElementById('shopEditPhone').value.trim();
      const email = document.getElementById('shopEditEmail').value.trim();
      
      // ⚠️ CRITICAL: locationMap MUST be manually provided - NO AUTO-GENERATION
      // DO NOT auto-generate Google Maps links from address or coordinates
      // Requirement: Manual Google Maps links ONLY for 100% accuracy
      const locationMap = document.getElementById('shopEditGoogleMaps').value.trim();
      
      const activity = document.getElementById('shopEditActivity').value.trim();
      const admCode = document.getElementById('shopEditAdmCode').value.trim();
      
      if (!newName) {
        showMessage('shopEditStatus', 'error', '❌ يرجى إدخال اسم المحل');
        return;
      }
      
      if (!areaId) {
        showMessage('shopEditStatus', 'error', '❌ يرجى اختيار المنطقة');
        return;
      }
      
      const token = getToken();
      if (!token) {
        showTokenModal();
        return;
      }
      
      showMessage('shopEditStatus', 'info', '⏳ جاري الحفظ...');
      
      try {
        // Update shop in planData
        const shopIndex = planData.shops.findIndex(s => s.name === originalName);
        if (shopIndex !== -1) {
          planData.shops[shopIndex].name = newName;
          planData.shops[shopIndex].areaId = areaId;
          // Update area name from areaId
          const area = planData.areas.find(a => a.id === areaId);
          if (area) {
            planData.shops[shopIndex].area = area.name;
          }
        }
        
        // Update all inspections that contain this shop
        if (originalName !== newName) {
          planData.inspectionData.forEach(inspection => {
            if (inspection.shops && Array.isArray(inspection.shops)) {
              const index = inspection.shops.indexOf(originalName);
              if (index !== -1) {
                inspection.shops[index] = newName;
              }
            }
          });
        }
        
        // Save to plan-data.json on GitHub
        await savePlanDataToGitHub(`تحديث محل: ${newName}`);
        
        // Save additional details to shops_details.json if any optional field is filled
        if (nameEn || licenseNo || address || contact || email || locationMap || activity || admCode) {
          await saveShopDetailsToGitHub(originalName, newName, {
            nameAr: newName,
            nameEn: nameEn,
            licenseNo: licenseNo,
            address: address,
            contact: contact,
            email: email,
            locationMap: locationMap,
            activity: activity,
            admCode: admCode,
            area: planData.shops[shopIndex].area,
            areaId: areaId
          });
        }
        
        showMessage('shopEditStatus', 'success', '✅ تم الحفظ بنجاح');
        setTimeout(() => {
          closeShopEditModal();
          loadShopsList();
          logActivity("تعديل محل", `تم تحديث بيانات المحل: ${newName}`);
        }, 1500);
        
      } catch (error) {
        showMessage('shopEditStatus', 'error', '❌ فشل الحفظ: ' + error.message);
      }
    }
    
    // Save shop details to shops_details.json on GitHub
    async function saveShopDetailsToGitHub(oldName, newName, details) {
      const token = getToken();
      if (!token) return;
      
      try {
        // Get current shops_details.json file
        const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!getRes.ok) {
          throw new Error('فشل الحصول على ملف shops_details.json');
        }
        
        const file = await getRes.json();
        const sha = file.sha;
        
        // Decode and parse current content
        const currentContent = JSON.parse(decodeURIComponent(escape(atob(file.content))));
        
        // If name changed, delete old entry
        if (oldName !== newName && currentContent[oldName]) {
          delete currentContent[oldName];
        }
        
        // Update or add shop details - remove empty fields
        const cleanDetails = {};
        if (details.nameAr) cleanDetails.nameAr = details.nameAr;
        if (details.nameEn) cleanDetails.nameEn = details.nameEn;
        if (details.licenseNo) cleanDetails.licenseNo = details.licenseNo;
        if (details.address) cleanDetails.address = details.address;
        if (details.contact) cleanDetails.contact = details.contact;
        if (details.email) cleanDetails.email = details.email;
        if (details.locationMap) cleanDetails.locationMap = details.locationMap;
        if (details.activity) cleanDetails.activity = details.activity;
        if (details.admCode) cleanDetails.admCode = details.admCode;
        if (details.area) cleanDetails.area = details.area;
        if (details.areaId) cleanDetails.areaId = details.areaId;
        
        currentContent[newName] = cleanDetails;
        
        // Prepare content
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(currentContent, null, 2))));
        
        // Update file
        const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `تحديث تفاصيل المحل: ${newName}`,
            content: content,
            sha: sha
          })
        });
        
        if (!updateRes.ok) {
          throw new Error('فشل تحديث ملف shops_details.json');
        }
      } catch (error) {
        console.error('Error saving shop details:', error);
        // Don't throw - optional details save failure shouldn't block main save
      }
    }
    
    // Delete Shop
    function deleteShop(name) {
      // Check if data is loaded
      if (!planData || !planData.inspectionData) {
        alert('⚠️ لم يتم تحميل البيانات بعد!\n\nالرجاء الضغط على زر "تحديث القائمة" أولاً لتحميل البيانات.');
        return;
      }
      
      if (!confirm(`⚠️ هل أنت متأكد من حذف المحل "${name}" من جميع السجلات؟\n\nهذا الإجراء لا يمكن التراجع عنه!`)) {
        return;
      }
      
      let deleteCount = 0;
      planData.inspectionData.forEach(inspection => {
        if (inspection.shops && Array.isArray(inspection.shops)) {
          const beforeLength = inspection.shops.length;
          inspection.shops = inspection.shops.filter(shop => shop !== name);
          if (inspection.shops.length < beforeLength) {
            deleteCount++;
          }
        }
      });
      
      if (deleteCount === 0) {
        showMessage("shopsStatus", "warning", "لم يتم العثور على المحل في السجلات!");
        return;
      }
      
      // Update the plan editor
      document.getElementById('planEditor').value = JSON.stringify(planData, null, 2);
      
      // Reload the list
      loadShopsList();
      
      showMessage("shopsStatus", "success", `✅ تم حذف المحل "${name}" من ${deleteCount} سجل! اضغط "حفظ في GitHub" لحفظ التغييرات.`);
      logActivity("حذف محل", `تم حذف المحل "${name}" من ${deleteCount} سجل`);
    }
    
    // ========================
    // Maintenance Mode
    // ========================
    async function enableMaintenanceMode() {
      if (!confirm("هل أنت متأكد من تفعيل وضع الصيانة؟ سيتم منع جميع المستخدمين من الوصول للموقع.")) {
        return;
      }
      
      const token = getToken();
      if (!token) {
        showTokenModal();
        return;
      }
      
      try {
        showMessage("maintenanceStatus", "info", "جاري تفعيل وضع الصيانة...");
        
        const messageAr = document.getElementById("maintenanceMessageAr").value;
        const messageEn = document.getElementById("maintenanceMessageEn").value;
        
        const maintenanceData = {
          enabled: true,
          messages: {
            ar: messageAr,
            en: messageEn
          },
          enabledAt: new Date().toISOString(),
          enabledBy: "د. علي عبدالعال"
        };
        
        // Save to GitHub
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(maintenanceData, null, 2))));
        
        // Get current file SHA
        const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${maintenancePath}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        let sha = "";
        if (getRes.ok) {
          const file = await getRes.json();
          sha = file.sha;
        }
        
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${maintenancePath}`, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "تفعيل وضع الصيانة",
            content: content,
            sha: sha
          })
        });
        
        if (res.status === 200 || res.status === 201) {
          showMessage("maintenanceStatus", "success", "✅ تم تفعيل وضع الصيانة بنجاح!");
          logActivity("تفعيل وضع الصيانة", "تم تفعيل وضع الصيانة للموقع");
        } else {
          showMessage("maintenanceStatus", "error", "❌ حدث خطأ في تفعيل وضع الصيانة");
        }
      } catch (error) {
        showMessage("maintenanceStatus", "error", "❌ خطأ: " + error.message);
      }
    }
    
    async function disableMaintenanceMode() {
      if (!confirm("هل أنت متأكد من إلغاء وضع الصيانة؟ سيتمكن جميع المستخدمين من الوصول للموقع.")) {
        return;
      }
      
      const token = getToken();
      if (!token) {
        showTokenModal();
        return;
      }
      
      try {
        showMessage("maintenanceStatus", "info", "جاري إلغاء وضع الصيانة...");
        
        const maintenanceData = {
          enabled: false,
          messages: {},
          disabledAt: new Date().toISOString(),
          disabledBy: "د. علي عبدالعال"
        };
        
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(maintenanceData, null, 2))));
        
        const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${maintenancePath}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        let sha = "";
        if (getRes.ok) {
          const file = await getRes.json();
          sha = file.sha;
        }
        
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${maintenancePath}`, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "إلغاء وضع الصيانة",
            content: content,
            sha: sha
          })
        });
        
        if (res.status === 200 || res.status === 201) {
          showMessage("maintenanceStatus", "success", "✅ تم إلغاء وضع الصيانة بنجاح!");
          logActivity("إلغاء وضع الصيانة", "تم إلغاء وضع الصيانة للموقع");
        } else {
          showMessage("maintenanceStatus", "error", "❌ حدث خطأ في إلغاء وضع الصيانة");
        }
      } catch (error) {
        showMessage("maintenanceStatus", "error", "❌ خطأ: " + error.message);
      }
    }
    
    async function checkMaintenanceStatus() {
      const token = getToken();
      if (!token) {
        showTokenModal();
        return;
      }
      
      try {
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${maintenancePath}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        if (res.ok) {
          const file = await res.json();
          const maintenanceData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
          
          if (maintenanceData.enabled) {
            showMessage("maintenanceStatus", "warning", `⚠️ وضع الصيانة مفعّل حالياً منذ: ${new Date(maintenanceData.enabledAt).toLocaleString('ar-EG')}`);
          } else {
            showMessage("maintenanceStatus", "success", "✅ وضع الصيانة غير مفعّل");
          }
        } else {
          showMessage("maintenanceStatus", "info", "ℹ️ لا توجد معلومات عن وضع الصيانة");
        }
      } catch (error) {
        showMessage("maintenanceStatus", "error", "❌ خطأ في فحص وضع الصيانة: " + error.message);
      }
    }
    
    // ========================
    // Activity Log
    // ========================
    function logActivity(action, details) {
      const activities = JSON.parse(localStorage.getItem("activityLog") || "[]");
      activities.unshift({
        timestamp: new Date().toISOString(),
        action: action,
        details: details,
        user: "د. علي عبدالعال"
      });
      
      // Keep only last 50 activities
      if (activities.length > 50) {
        activities.length = 50;
      }
      
      localStorage.setItem("activityLog", JSON.stringify(activities));
    }
    
    function refreshActivityLog() {
      const activities = JSON.parse(localStorage.getItem("activityLog") || "[]");
      const container = document.getElementById("activityLogContent");
      
      if (activities.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">لا توجد نشاطات مسجلة</p>';
        return;
      }
      
      let html = '<table class="data-table"><thead><tr><th>الوقت</th><th>الإجراء</th><th>التفاصيل</th><th>المستخدم</th></tr></thead><tbody>';
      
      activities.forEach(activity => {
        const date = new Date(activity.timestamp);
        html += `
          <tr>
            <td>${date.toLocaleString('ar-EG')}</td>
            <td><strong>${activity.action}</strong></td>
            <td>${activity.details}</td>
            <td>${activity.user}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    
    // ========================
    // Utility Functions
    // ========================
    async function addNewInspection() {
      if (!planData) {
        alert("❌ يجب تحميل البيانات أولاً!");
        await loadPlan();
        if (!planData) return;
      }
      
      // Load shops details if not already loaded
      if (!shopsDetails) {
        await loadShopsDetails();
      }
      
      // Get unique inspectors from existing data
      const inspectors = [...new Set(planData.inspectionData.map(i => i.inspector).filter(Boolean))].sort();
      
      // Get unique areas from shops_details.json
      const areas = shopsDetails ? [...new Set(Object.values(shopsDetails).map(s => s.address).filter(Boolean))].sort() : [];
      
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.id = 'addInspectionModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
          <div class="modal-header">
            <h3 class="modal-title">إضافة تفتيش جديد</h3>
            <button class="modal-close" onclick="closeModal('addInspectionModal')">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">المفتش</label>
              <select id="newInspectionInspector" class="form-control">
                <option value="">-- اختر المفتش --</option>
                ${inspectors.map(i => `<option value="${i}">${i}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">التاريخ</label>
              <input type="date" id="newInspectionDate" class="form-control" 
                     value="${new Date().toISOString().split('T')[0]}">
            </div>
            <div class="form-group">
              <label class="form-label">الفترة</label>
              <select id="newInspectionShift" class="form-control">
                <option value="صباحية">صباحية</option>
                <option value="مسائية">مسائية</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">المنطقة</label>
              <select id="newInspectionArea" class="form-control" onchange="updateShopsDropdownByArea()">
                <option value="">-- اختر المنطقة --</option>
                ${areas.map(a => `<option value="${a}">${a}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">المحلات</label>
              <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                <small style="color: #666;">
                  <i class="fas fa-info-circle"></i> اختر المنطقة أولاً لعرض المحلات التابعة لها. يمكنك تحديد عدة محلات.
                </small>
              </div>
              <select id="newInspectionShopsSelect" class="form-control" multiple size="8" 
                      style="width: 100%;" disabled>
                <option value="">-- اختر المنطقة أولاً --</option>
              </select>
              <small style="color: #999; display: block; margin-top: 5px;">
                اضغط Ctrl (أو Cmd على Mac) + انقر لتحديد عدة محلات
              </small>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-success" onclick="saveNewInspection()">
              <i class="fas fa-save"></i> حفظ التفتيش
            </button>
            <button class="btn btn-secondary" onclick="closeModal('addInspectionModal')">
              إلغاء
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    window.saveNewInspection = async function() {
      const inspector = document.getElementById('newInspectionInspector').value.trim();
      const day = document.getElementById('newInspectionDate').value;
      const shift = document.getElementById('newInspectionShift').value;
      const area = document.getElementById('newInspectionArea').value.trim();
      
      // Get selected shops from the multi-select dropdown
      const shopsSelect = document.getElementById('newInspectionShopsSelect');
      const shops = Array.from(shopsSelect.selectedOptions).map(option => option.value);
      
      if (!inspector || !day || !area || shops.length === 0) {
        alert('❌ يجب ملء جميع الحقول المطلوبة واختيار محل واحد على الأقل!');
        return;
      }
      
      const newInspection = {
        inspector,
        day,
        shift,
        area,
        shops
      };
      
      planData.inspectionData.push(newInspection);
      document.getElementById('planEditor').value = JSON.stringify(planData, null, 2);
      
      await savePlan();
      
      alert(`✅ تم إضافة التفتيش بنجاح!\n\nالمفتش: ${inspector}\nالتاريخ: ${day}\nالمنطقة: ${area}\nعدد المحلات: ${shops.length}`);
      closeModal('addInspectionModal');
      
      // Refresh dashboard
      updateDashboardStats();
      
      logActivity("إضافة تفتيش", `تم إضافة تفتيش جديد للمفتش ${inspector} في ${area}`);
    }
    
    // Load shops details from GitHub or local file
    async function loadShopsDetails() {
      try {
        // Try to load from GitHub first
        const response = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
          headers: {
            'Authorization': `token ${getToken()}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          // Properly decode base64 with UTF-8 support for Arabic text
          const content = decodeURIComponent(Array.prototype.map.call(atob(data.content), function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));
          shopsDetails = JSON.parse(content);
          console.log('Loaded shops details from GitHub:', Object.keys(shopsDetails).length, 'shops');
          return;
        }
      } catch (error) {
        console.warn('Could not load from GitHub, trying local file:', error.message);
      }
      
      // Fallback: Load from local file
      try {
        const response = await fetch('shops_details.json');
        if (response.ok) {
          shopsDetails = await response.json();
          console.log('Loaded shops details from local file:', Object.keys(shopsDetails).length, 'shops');
          return;
        }
      } catch (error) {
        console.error('Error loading shops details from local file:', error);
      }
      
      // Last resort: empty object
      shopsDetails = {};
      console.warn('Could not load shops details, using empty object');
    }
    
    // Update shops dropdown based on selected area
    window.updateShopsDropdownByArea = function() {
      const areaSelect = document.getElementById('newInspectionArea');
      const shopsSelect = document.getElementById('newInspectionShopsSelect');
      
      if (!areaSelect || !shopsSelect) return;
      
      const selectedArea = areaSelect.value;
      
      if (!selectedArea) {
        shopsSelect.innerHTML = '<option value="">-- اختر المنطقة أولاً --</option>';
        shopsSelect.disabled = true;
        return;
      }
      
      // Filter shops by selected area
      const shopsInArea = shopsDetails ? 
        Object.entries(shopsDetails)
          .filter(([name, details]) => details.address === selectedArea)
          .map(([name, details]) => name)
          .sort() 
        : [];
      
      if (shopsInArea.length === 0) {
        shopsSelect.innerHTML = '<option value="">-- لا توجد محلات في هذه المنطقة --</option>';
        shopsSelect.disabled = true;
        return;
      }
      
      // Populate shops dropdown
      shopsSelect.innerHTML = shopsInArea.map(shop => 
        `<option value="${shop}">${shop}</option>`
      ).join('');
      shopsSelect.disabled = false;
    }
    
    function exportData() {
      if (!planData) {
        alert("لا توجد بيانات لتصديرها");
        return;
      }
      
      const dataStr = JSON.stringify(planData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `plan-data-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      logActivity("تصدير البيانات", "تم تصدير بيانات الخطة");
    }
    
    function backupData() {
      if (!planData) {
        alert("لا توجد بيانات للنسخ الاحتياطي");
        return;
      }
      
      const backupData = {
        timestamp: new Date().toISOString(),
        data: planData
      };
      
      const backups = JSON.parse(localStorage.getItem("backups") || "[]");
      backups.unshift(backupData);
      
      // Keep only last 10 backups
      if (backups.length > 10) {
        backups.length = 10;
      }
      
      localStorage.setItem("backups", JSON.stringify(backups));
      alert("✅ تم إنشاء نسخة احتياطية بنجاح!");
      
      logActivity("نسخة احتياطية", "تم إنشاء نسخة احتياطية من البيانات");
    }
    
    function validateData() {
      if (!planData) {
        alert("لا توجد بيانات للتحقق منها");
        return;
      }
      
      let errors = [];
      
      if (!planData.inspectionData || !Array.isArray(planData.inspectionData)) {
        errors.push("البيانات لا تحتوي على حقل inspectionData");
      } else {
        planData.inspectionData.forEach((item, index) => {
          if (!item.inspector) errors.push(`العنصر ${index + 1}: اسم المفتش مفقود`);
          if (!item.day) errors.push(`العنصر ${index + 1}: التاريخ مفقود`);
          if (!item.area) errors.push(`العنصر ${index + 1}: المنطقة مفقودة`);
          if (!item.shops || !Array.isArray(item.shops)) errors.push(`العنصر ${index + 1}: المحلات مفقودة أو غير صحيحة`);
        });
      }
      
      if (errors.length === 0) {
        alert("✅ البيانات صحيحة ولا توجد أخطاء!");
      } else {
        alert("❌ تم العثور على الأخطاء التالية:\n\n" + errors.join("\n"));
      }
    }
    
    function openVisualEditor() {
      if (!planData || !planData.inspectionData) {
        alert("❌ يجب تحميل البيانات أولاً!");
        return;
      }
      
      // Create a modal for the visual editor
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.id = 'visualEditorModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 95%; max-height: 95vh;">
          <div class="modal-header">
            <h3 class="modal-title">المحرر المرئي للخطة</h3>
            <button class="modal-close" onclick="closeVisualEditor()">&times;</button>
          </div>
          <div class="modal-body">
            <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn btn-success" onclick="addInspectionRow()">
                <i class="fas fa-plus"></i> إضافة تفتيش
              </button>
              <button class="btn btn-primary" onclick="saveFromVisualEditor()">
                <i class="fas fa-save"></i> حفظ التعديلات
              </button>
              <button class="btn btn-warning" onclick="refreshVisualEditor()">
                <i class="fas fa-sync"></i> تحديث
              </button>
              <input type="text" id="visualSearchInput" class="form-control" 
                     style="flex: 1; min-width: 200px;" 
                     placeholder="بحث... (مفتش، منطقة، محل)"
                     onkeyup="filterVisualEditor()">
            </div>
            <div style="overflow-x: auto; max-height: 60vh; overflow-y: auto;">
              <table id="visualEditorTable" style="width: 100%; border-collapse: collapse; background: white;">
                <thead style="position: sticky; top: 0; background: #667eea; color: white; z-index: 10;">
                  <tr>
                    <th style="padding: 12px; border: 1px solid #ddd; min-width: 50px;">#</th>
                    <th style="padding: 12px; border: 1px solid #ddd; min-width: 150px;">المفتش</th>
                    <th style="padding: 12px; border: 1px solid #ddd; min-width: 120px;">التاريخ</th>
                    <th style="padding: 12px; border: 1px solid #ddd; min-width: 100px;">الفترة</th>
                    <th style="padding: 12px; border: 1px solid #ddd; min-width: 150px;">المنطقة</th>
                    <th style="padding: 12px; border: 1px solid #ddd; min-width: 200px;">المحلات</th>
                    <th style="padding: 12px; border: 1px solid #ddd; min-width: 120px;">إجراءات</th>
                  </tr>
                </thead>
                <tbody id="visualEditorTableBody">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Populate the table
      refreshVisualEditor();
      
      logActivity("المحرر المرئي", "تم فتح المحرر المرئي للخطة");
    }
    
    window.closeVisualEditor = function() {
      const modal = document.getElementById('visualEditorModal');
      if (modal) {
        modal.remove();
      }
    }
    
    window.refreshVisualEditor = function() {
      const tbody = document.getElementById('visualEditorTableBody');
      if (!tbody || !planData || !planData.inspectionData) return;
      
      tbody.innerHTML = '';
      planData.inspectionData.forEach((item, index) => {
        const row = document.createElement('tr');
        row.dataset.index = index;
        const bgColor = index % 2 === 0 ? '#fffacd' : '#ffffff';
        row.style.background = bgColor;
        row.innerHTML = `
          <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${index + 1}</td>
          <td style="padding: 10px; border: 1px solid #ddd;">
            <input type="text" class="form-control" value="${item.inspector || ''}" 
                   onchange="updateInspectionField(${index}, 'inspector', this.value)">
          </td>
          <td style="padding: 10px; border: 1px solid #ddd;">
            <input type="date" class="form-control" value="${item.day || ''}" 
                   onchange="updateInspectionField(${index}, 'day', this.value)">
          </td>
          <td style="padding: 10px; border: 1px solid #ddd;">
            <select class="form-control" onchange="updateInspectionField(${index}, 'shift', this.value)">
              <option value="صباحية" ${item.shift === 'صباحية' ? 'selected' : ''}>صباحية</option>
              <option value="مسائية" ${item.shift === 'مسائية' ? 'selected' : ''}>مسائية</option>
            </select>
          </td>
          <td style="padding: 10px; border: 1px solid #ddd;">
            <input type="text" class="form-control" value="${item.area || ''}" 
                   onchange="updateInspectionField(${index}, 'area', this.value)">
          </td>
          <td style="padding: 10px; border: 1px solid #ddd;">
            <textarea class="form-control" rows="2" 
                      onchange="updateInspectionField(${index}, 'shops', this.value.split('\\n').filter(s => s.trim()))"
            >${(item.shops || []).join('\n')}</textarea>
          </td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
            <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.9em;" 
                    onclick="deleteInspectionRow(${index})">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }
    
    window.updateInspectionField = function(index, field, value) {
      if (!planData || !planData.inspectionData || !planData.inspectionData[index]) return;
      planData.inspectionData[index][field] = value;
    }
    
    window.deleteInspectionRow = function(index) {
      if (!confirm('هل تريد حذف هذا التفتيش؟')) return;
      planData.inspectionData.splice(index, 1);
      refreshVisualEditor();
      logActivity("حذف تفتيش", `تم حذف التفتيش رقم ${index + 1}`);
    }
    
    window.addInspectionRow = function() {
      if (!planData.inspectionData) planData.inspectionData = [];
      
      planData.inspectionData.push({
        inspector: '',
        day: new Date().toISOString().split('T')[0],
        shift: 'صباحية',
        area: '',
        shops: []
      });
      refreshVisualEditor();
      logActivity("إضافة تفتيش", "تم إضافة تفتيش جديد");
    }
    
    window.saveFromVisualEditor = async function() {
      document.getElementById('planEditor').value = JSON.stringify(planData, null, 2);
      await savePlan();
      alert("✅ تم حفظ التعديلات بنجاح!");
    }
    
    window.filterVisualEditor = function() {
      const searchTerm = document.getElementById('visualSearchInput').value.toLowerCase();
      const tbody = document.getElementById('visualEditorTableBody');
      if (!tbody) return;
      
      const rows = tbody.getElementsByTagName('tr');
      for (let row of rows) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      }
    }
    
    function addInspector() {
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.id = 'addInspectorModal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">إضافة مفتش جديد</h3>
            <button class="modal-close" onclick="closeModal('addInspectorModal')">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">اسم المفتش</label>
              <input type="text" id="newInspectorName" class="form-control" placeholder="د. اسم المفتش">
            </div>
            <div class="form-group">
              <label class="form-label">التخصص (اختياري)</label>
              <input type="text" id="newInspectorSpecialty" class="form-control" placeholder="طب بيطري">
            </div>
            <div class="form-group">
              <label class="form-label">رقم الهاتف (اختياري)</label>
              <input type="text" id="newInspectorPhone" class="form-control" placeholder="05xxxxxxxx">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-success" onclick="saveNewInspector()">
              <i class="fas fa-save"></i> حفظ
            </button>
            <button class="btn btn-secondary" onclick="closeModal('addInspectorModal')">
              إلغاء
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    window.saveNewInspector = function() {
      const name = document.getElementById('newInspectorName').value.trim();
      if (!name) {
        alert('❌ يجب إدخال اسم المفتش!');
        return;
      }
      
      // Add inspector to the list (for now, just log it)
      logActivity("إضافة مفتش", `تم إضافة المفتش: ${name}`);
      alert(`✅ تم إضافة المفتش: ${name}\n\nيمكنك الآن استخدامه في المحرر المرئي أو محرر JSON`);
      closeModal('addInspectorModal');
    }
    
    function addArea() {
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.id = 'addAreaModal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">إضافة منطقة جديدة</h3>
            <button class="modal-close" onclick="closeModal('addAreaModal')">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">اسم المنطقة</label>
              <input type="text" id="newAreaName" class="form-control" placeholder="سوق الميناء، الحصن، إلخ">
            </div>
            <div class="form-group">
              <label class="form-label">الوصف (اختياري)</label>
              <textarea id="newAreaDesc" class="form-control" rows="3" placeholder="وصف المنطقة ومميزاتها"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">الإحداثيات (اختياري)</label>
              <input type="text" id="newAreaCoords" class="form-control" placeholder="24.xxx, 54.xxx">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-success" onclick="saveNewArea()">
              <i class="fas fa-save"></i> حفظ
            </button>
            <button class="btn btn-secondary" onclick="closeModal('addAreaModal')">
              إلغاء
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    window.saveNewArea = function() {
      const name = document.getElementById('newAreaName').value.trim();
      if (!name) {
        alert('❌ يجب إدخال اسم المنطقة!');
        return;
      }
      
      logActivity("إضافة منطقة", `تم إضافة المنطقة: ${name}`);
      alert(`✅ تم إضافة المنطقة: ${name}\n\nيمكنك الآن استخدامها في المحرر المرئي أو محرر JSON`);
      closeModal('addAreaModal');
    }
    
    async function addShop() {
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.id = 'addShopModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
          <div class="modal-header">
            <h3 class="modal-title">إضافة محل جديد</h3>
            <button class="modal-close" onclick="closeModal('addShopModal')">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">اسم المحل (عربي)</label>
              <input type="text" id="newShopNameAr" class="form-control" placeholder="اسم المحل بالعربي">
            </div>
            <div class="form-group">
              <label class="form-label">اسم المحل (إنجليزي)</label>
              <input type="text" id="newShopNameEn" class="form-control" placeholder="Shop Name in English">
            </div>
            <div class="form-group">
              <label class="form-label">رقم الرخصة</label>
              <input type="text" id="newShopLicense" class="form-control" placeholder="CN-xxxxxxx">
            </div>
            <div class="form-group">
              <label class="form-label">المنطقة</label>
              <input type="text" id="newShopArea" class="form-control" placeholder="سوق الميناء">
            </div>
            <div class="form-group">
              <label class="form-label">رقم الهاتف</label>
              <input type="text" id="newShopPhone" class="form-control" placeholder="05xxxxxxxx">
            </div>
            <div class="form-group">
              <label class="form-label">النشاط</label>
              <input type="text" id="newShopActivity" class="form-control" placeholder="بيع الحيوانات">
            </div>
            <div class="form-group">
              <label class="form-label">رابط الموقع (Google Maps)</label>
              <!-- ⚠️ CRITICAL: Manual Google Maps link ONLY - NO auto-generation -->
              <input type="text" id="newShopLocation" class="form-control" placeholder="https://maps.google.com/...">
              <small style="color: #d9534f; display: block; margin-top: 3px; font-weight: 500;">
                ⚠️ يجب نسخ الرابط يدوياً من خرائط جوجل - لا توليد تلقائي
              </small>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-success" onclick="saveNewShop()">
              <i class="fas fa-save"></i> حفظ
            </button>
            <button class="btn btn-secondary" onclick="closeModal('addShopModal')">
              إلغاء
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    window.saveNewShop = async function() {
      const nameAr = document.getElementById('newShopNameAr').value.trim();
      const nameEn = document.getElementById('newShopNameEn').value.trim();
      const license = document.getElementById('newShopLicense').value.trim();
      
      if (!nameAr) {
        alert('❌ يجب إدخال اسم المحل بالعربي!');
        return;
      }
      
      const shopData = {
        nameAr: nameAr,
        nameEn: nameEn,
        licenseNo: license,
        address: document.getElementById('newShopArea').value.trim(),
        contact: document.getElementById('newShopPhone').value.trim(),
        activity: document.getElementById('newShopActivity').value.trim(),
        // ⚠️ CRITICAL: locationMap MUST be manually provided - NO AUTO-GENERATION
        // DO NOT auto-generate Google Maps links from address or coordinates
        locationMap: document.getElementById('newShopLocation').value.trim(),
        admCode: 'ADM' + Date.now().toString().slice(-4)
      };
      
      logActivity("إضافة محل", `تم إضافة المحل: ${nameAr}`);
      alert(`✅ تم إضافة المحل: ${nameAr}\n\nالبيانات:\n${JSON.stringify(shopData, null, 2)}\n\nيمكنك الآن استخدامه في المحرر المرئي`);
      closeModal('addShopModal');
    }
    
    function generateMonthlyReport() {
      if (!planData || !planData.inspectionData) {
        alert("❌ لا توجد بيانات للتقرير!");
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.id = 'monthlyReportModal';
      
      // Analyze data by month
      const monthlyData = {};
      planData.inspectionData.forEach(item => {
        const month = item.day ? item.day.substring(0, 7) : 'غير محدد';
        if (!monthlyData[month]) {
          monthlyData[month] = {
            count: 0,
            inspectors: new Set(),
            areas: new Set(),
            shops: new Set()
          };
        }
        monthlyData[month].count++;
        if (item.inspector) monthlyData[month].inspectors.add(item.inspector);
        if (item.area) monthlyData[month].areas.add(item.area);
        if (item.shops) item.shops.forEach(shop => monthlyData[month].shops.add(shop));
      });
      
      let reportHtml = '<div style="max-height: 60vh; overflow-y: auto;">';
      Object.keys(monthlyData).sort().reverse().forEach(month => {
        const data = monthlyData[month];
        reportHtml += `
          <div style="border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: #f8f9fa;">
            <h4 style="color: #667eea; margin-bottom: 10px;">📅 ${month}</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
              <div><strong>عدد التفتيشات:</strong> ${data.count}</div>
              <div><strong>عدد المفتشين:</strong> ${data.inspectors.size}</div>
              <div><strong>عدد المناطق:</strong> ${data.areas.size}</div>
              <div><strong>عدد المحلات:</strong> ${data.shops.size}</div>
            </div>
          </div>
        `;
      });
      reportHtml += '</div>';
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h3 class="modal-title">التقرير الشهري</h3>
            <button class="modal-close" onclick="closeModal('monthlyReportModal')">&times;</button>
          </div>
          <div class="modal-body">
            ${reportHtml}
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="exportReport('monthly')">
              <i class="fas fa-download"></i> تصدير التقرير
            </button>
            <button class="btn btn-secondary" onclick="closeModal('monthlyReportModal')">
              إغلاق
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      logActivity("تقرير شهري", "تم عرض التقرير الشهري");
    }
    
    function generateInspectorReport() {
      if (!planData || !planData.inspectionData) {
        alert("❌ لا توجد بيانات للتقرير!");
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.id = 'inspectorReportModal';
      
      // Analyze data by inspector
      const inspectorData = {};
      planData.inspectionData.forEach(item => {
        const inspector = item.inspector || 'غير محدد';
        if (!inspectorData[inspector]) {
          inspectorData[inspector] = {
            count: 0,
            areas: new Set(),
            shops: new Set(),
            dates: []
          };
        }
        inspectorData[inspector].count++;
        if (item.area) inspectorData[inspector].areas.add(item.area);
        if (item.shops) item.shops.forEach(shop => inspectorData[inspector].shops.add(shop));
        if (item.day) inspectorData[inspector].dates.push(item.day);
      });
      
      let reportHtml = '<div style="max-height: 60vh; overflow-y: auto;">';
      Object.keys(inspectorData).sort().forEach(inspector => {
        const data = inspectorData[inspector];
        const avgPerMonth = data.dates.length > 0 ? 
          (data.dates.length / (new Set(data.dates.map(d => d.substring(0, 7))).size || 1)).toFixed(1) : 0;
        
        reportHtml += `
          <div style="border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: #f8f9fa;">
            <h4 style="color: #667eea; margin-bottom: 10px;">👨‍⚕️ ${inspector}</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
              <div><strong>عدد التفتيشات:</strong> ${data.count}</div>
              <div><strong>عدد المناطق:</strong> ${data.areas.size}</div>
              <div><strong>عدد المحلات:</strong> ${data.shops.size}</div>
              <div><strong>معدل التفتيش الشهري:</strong> ${avgPerMonth}</div>
            </div>
          </div>
        `;
      });
      reportHtml += '</div>';
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h3 class="modal-title">تقرير المفتشين</h3>
            <button class="modal-close" onclick="closeModal('inspectorReportModal')">&times;</button>
          </div>
          <div class="modal-body">
            ${reportHtml}
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="exportReport('inspector')">
              <i class="fas fa-download"></i> تصدير التقرير
            </button>
            <button class="btn btn-secondary" onclick="closeModal('inspectorReportModal')">
              إغلاق
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      logActivity("تقرير المفتشين", "تم عرض تقرير المفتشين");
    }
    
    function generateAreaReport() {
      if (!planData || !planData.inspectionData) {
        alert("❌ لا توجد بيانات للتقرير!");
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.id = 'areaReportModal';
      
      // Analyze data by area
      const areaData = {};
      planData.inspectionData.forEach(item => {
        const area = item.area || 'غير محدد';
        if (!areaData[area]) {
          areaData[area] = {
            count: 0,
            inspectors: new Set(),
            shops: new Set()
          };
        }
        areaData[area].count++;
        if (item.inspector) areaData[area].inspectors.add(item.inspector);
        if (item.shops) item.shops.forEach(shop => areaData[area].shops.add(shop));
      });
      
      let reportHtml = '<div style="max-height: 60vh; overflow-y: auto;">';
      Object.keys(areaData).sort().forEach(area => {
        const data = areaData[area];
        reportHtml += `
          <div style="border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: #f8f9fa;">
            <h4 style="color: #667eea; margin-bottom: 10px;">📍 ${area}</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
              <div><strong>عدد التفتيشات:</strong> ${data.count}</div>
              <div><strong>عدد المفتشين:</strong> ${data.inspectors.size}</div>
              <div><strong>عدد المحلات:</strong> ${data.shops.size}</div>
            </div>
          </div>
        `;
      });
      reportHtml += '</div>';
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h3 class="modal-title">تقرير المناطق</h3>
            <button class="modal-close" onclick="closeModal('areaReportModal')">&times;</button>
          </div>
          <div class="modal-body">
            ${reportHtml}
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="exportReport('area')">
              <i class="fas fa-download"></i> تصدير التقرير
            </button>
            <button class="btn btn-secondary" onclick="closeModal('areaReportModal')">
              إغلاق
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      logActivity("تقرير المناطق", "تم عرض تقرير المناطق");
    }
    
    function generateShopReport() {
      if (!planData || !planData.inspectionData) {
        alert("❌ لا توجد بيانات للتقرير!");
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.id = 'shopReportModal';
      
      // Analyze data by shop
      const shopData = {};
      planData.inspectionData.forEach(item => {
        if (item.shops) {
          item.shops.forEach(shop => {
            if (!shopData[shop]) {
              shopData[shop] = {
                count: 0,
                inspectors: new Set(),
                areas: new Set(),
                lastInspection: null
              };
            }
            shopData[shop].count++;
            if (item.inspector) shopData[shop].inspectors.add(item.inspector);
            if (item.area) shopData[shop].areas.add(item.area);
            if (item.day) {
              if (!shopData[shop].lastInspection || item.day > shopData[shop].lastInspection) {
                shopData[shop].lastInspection = item.day;
              }
            }
          });
        }
      });
      
      // Sort by inspection count
      const sortedShops = Object.keys(shopData).sort((a, b) => shopData[b].count - shopData[a].count);
      
      let reportHtml = '<div style="max-height: 60vh; overflow-y: auto;">';
      reportHtml += `<div style="margin-bottom: 15px; padding: 10px; background: #e8f5e9; border-radius: 8px;">
        <strong>إجمالي المحلات:</strong> ${sortedShops.length} محل
      </div>`;
      
      sortedShops.forEach(shop => {
        const data = shopData[shop];
        reportHtml += `
          <div style="border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: #f8f9fa;">
            <h4 style="color: #667eea; margin-bottom: 10px;">🏪 ${shop}</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
              <div><strong>عدد التفتيشات:</strong> ${data.count}</div>
              <div><strong>عدد المفتشين:</strong> ${data.inspectors.size}</div>
              <div><strong>المناطق:</strong> ${Array.from(data.areas).join(', ')}</div>
              <div><strong>آخر تفتيش:</strong> ${data.lastInspection || 'غير محدد'}</div>
            </div>
          </div>
        `;
      });
      reportHtml += '</div>';
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px;">
          <div class="modal-header">
            <h3 class="modal-title">تقرير المحلات</h3>
            <button class="modal-close" onclick="closeModal('shopReportModal')">&times;</button>
          </div>
          <div class="modal-body">
            ${reportHtml}
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="exportReport('shop')">
              <i class="fas fa-download"></i> تصدير التقرير
            </button>
            <button class="btn btn-secondary" onclick="closeModal('shopReportModal')">
              إغلاق
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      logActivity("تقرير المحلات", "تم عرض تقرير المحلات");
    }
    
    window.exportReport = function(type) {
      const reportName = {
        'monthly': 'التقرير الشهري',
        'inspector': 'تقرير المفتشين',
        'area': 'تقرير المناطق',
        'shop': 'تقرير المحلات'
      }[type];
      
      alert(`✅ جاري تصدير ${reportName}...\n\nسيتم تحميل التقرير قريباً بصيغة PDF/Excel`);
      logActivity("تصدير تقرير", `تم طلب تصدير ${reportName}`);
    }
    
    window.closeModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.remove();
      }
    }
    
    function saveSettings() {
      const token = document.getElementById("githubToken").value.trim();
      const devMode = document.getElementById("devMode").value;
      
      if (token) {
        setToken(token);
      }
      
      localStorage.setItem("devMode", devMode);
      
      showMessage("settingsStatus", "success", "✅ تم حفظ الإعدادات بنجاح!");
      logActivity("تحديث الإعدادات", "تم تحديث إعدادات النظام");
    }
    
    function createBackup() {
      backupData();
    }
    
    function listBackups() {
      const backups = JSON.parse(localStorage.getItem("backups") || "[]");
      const container = document.getElementById("backupsList");
      
      if (backups.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999;">لا توجد نسخ احتياطية</p>';
        return;
      }
      
      let html = '<table class="data-table"><thead><tr><th>التاريخ</th><th>الوقت</th><th>الإجراءات</th></tr></thead><tbody>';
      
      backups.forEach((backup, index) => {
        const date = new Date(backup.timestamp);
        html += `
          <tr>
            <td>${date.toLocaleDateString('ar-EG')}</td>
            <td>${date.toLocaleTimeString('ar-EG')}</td>
            <td>
              <button class="btn btn-primary" onclick="restoreBackupByIndex(${index})">
                <i class="fas fa-undo"></i> استعادة
              </button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    
    function restoreBackup() {
      listBackups();
    }
    
    function restoreBackupByIndex(index) {
      if (!confirm("هل أنت متأكد من استعادة هذه النسخة الاحتياطية؟")) {
        return;
      }
      
      const backups = JSON.parse(localStorage.getItem("backups") || "[]");
      if (index >= 0 && index < backups.length) {
        planData = backups[index].data;
        document.getElementById("planEditor").value = JSON.stringify(planData, null, 2);
        alert("✅ تم استعادة النسخة الاحتياطية بنجاح!");
        logActivity("استعادة نسخة احتياطية", "تم استعادة نسخة احتياطية من البيانات");
      }
    }
    
    function updateMaintenanceMessages() {
      alert("سيتم تحديث رسائل الصيانة عند تفعيل وضع الصيانة");
    }
    
    // ========================
    // Advanced Developer Tools
    // ========================
    
    window.openAdvancedSearch = function() {
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.id = 'advancedSearchModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
          <div class="modal-header">
            <h3 class="modal-title">🔍 البحث المتقدم والفلترة</h3>
            <button class="modal-close" onclick="closeModal('advancedSearchModal')">&times;</button>
          </div>
          <div class="modal-body" style="overflow-y: auto; max-height: 70vh;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <div class="form-group">
                <label class="form-label">البحث العام</label>
                <input type="text" id="advSearchGeneral" class="form-control" placeholder="أي كلمة...">
              </div>
              <div class="form-group">
                <label class="form-label">المفتش</label>
                <input type="text" id="advSearchInspector" class="form-control" placeholder="د. اسم المفتش">
              </div>
              <div class="form-group">
                <label class="form-label">المنطقة</label>
                <input type="text" id="advSearchArea" class="form-control" placeholder="سوق الميناء">
              </div>
              <div class="form-group">
                <label class="form-label">المحل</label>
                <input type="text" id="advSearchShop" class="form-control" placeholder="اسم المحل">
              </div>
              <div class="form-group">
                <label class="form-label">من تاريخ</label>
                <input type="date" id="advSearchFromDate" class="form-control">
              </div>
              <div class="form-group">
                <label class="form-label">إلى تاريخ</label>
                <input type="date" id="advSearchToDate" class="form-control">
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <button class="btn btn-primary" onclick="executeAdvancedSearch()">
                <i class="fas fa-search"></i> بحث
              </button>
              <button class="btn btn-secondary" onclick="clearAdvancedSearch()">
                <i class="fas fa-eraser"></i> مسح
              </button>
            </div>
            
            <div id="advancedSearchResults"></div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    window.executeAdvancedSearch = function() {
      if (!planData || !planData.inspectionData) {
        alert('❌ لا توجد بيانات للبحث!');
        return;
      }
      
      const general = document.getElementById('advSearchGeneral').value.toLowerCase();
      const inspector = document.getElementById('advSearchInspector').value.toLowerCase();
      const area = document.getElementById('advSearchArea').value.toLowerCase();
      const shop = document.getElementById('advSearchShop').value.toLowerCase();
      const fromDate = document.getElementById('advSearchFromDate').value;
      const toDate = document.getElementById('advSearchToDate').value;
      
      const results = planData.inspectionData.filter(item => {
        const matchGeneral = !general || 
          JSON.stringify(item).toLowerCase().includes(general);
        const matchInspector = !inspector || 
          (item.inspector && item.inspector.toLowerCase().includes(inspector));
        const matchArea = !area || 
          (item.area && item.area.toLowerCase().includes(area));
        const matchShop = !shop || 
          (item.shops && item.shops.some(s => s.toLowerCase().includes(shop)));
        const matchFromDate = !fromDate || (item.day && item.day >= fromDate);
        const matchToDate = !toDate || (item.day && item.day <= toDate);
        
        return matchGeneral && matchInspector && matchArea && matchShop && 
               matchFromDate && matchToDate;
      });
      
      const container = document.getElementById('advancedSearchResults');
      if (results.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">لم يتم العثور على نتائج</p>';
        return;
      }
      
      let html = `<div style="background: #e8f5e9; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
        <strong>عدد النتائج:</strong> ${results.length}
      </div>`;
      
      results.forEach((item, index) => {
        html += `
          <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
              <div><strong>المفتش:</strong> <span style="font-size: 0.9em;">${item.inspector || 'غير محدد'}</span></div>
              <div><strong>التاريخ:</strong> <span style="font-size: 0.9em;">${item.day || 'غير محدد'}</span></div>
              <div><strong>المنطقة:</strong> ${item.area || 'غير محدد'}</div>
              <div><strong>عدد المحلات:</strong> ${item.shops ? item.shops.length : 0}</div>
            </div>
            ${item.shops ? `<div style="margin-top: 10px;"><strong>المحلات:</strong> ${item.shops.join(', ')}</div>` : ''}
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    window.clearAdvancedSearch = function() {
      document.getElementById('advSearchGeneral').value = '';
      document.getElementById('advSearchInspector').value = '';
      document.getElementById('advSearchArea').value = '';
      document.getElementById('advSearchShop').value = '';
      document.getElementById('advSearchFromDate').value = '';
      document.getElementById('advSearchToDate').value = '';
      document.getElementById('advancedSearchResults').innerHTML = '';
    }
    
    window.openCodeInspector = function() {
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.id = 'codeInspectorModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 95%; max-height: 95vh;">
          <div class="modal-header">
            <h3 class="modal-title">🔧 مفتش الكود - Code Inspector</h3>
            <button class="modal-close" onclick="closeModal('codeInspectorModal')">&times;</button>
          </div>
          <div class="modal-body" style="overflow-y: auto; max-height: 75vh;">
            <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 10px;">
              <h4 style="margin-bottom: 10px;">📊 معلومات البيانات</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <div><strong>حجم البيانات:</strong> <span id="dataSize">-</span></div>
                <div><strong>عدد السجلات:</strong> <span id="recordCount">-</span></div>
                <div><strong>عدد المفتاحات:</strong> <span id="keyCount">-</span></div>
                <div><strong>البنية:</strong> <span id="dataStructure">-</span></div>
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <h4 style="margin-bottom: 10px;">🔍 فحص البيانات</h4>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="analyzeDataStructure()">
                  <i class="fas fa-sitemap"></i> تحليل البنية
                </button>
                <button class="btn btn-success" onclick="findDuplicates()">
                  <i class="fas fa-copy"></i> البحث عن التكرارات
                </button>
                <button class="btn btn-warning" onclick="findMissingData()">
                  <i class="fas fa-exclamation-triangle"></i> البيانات الناقصة
                </button>
                <button class="btn btn-info" onclick="generateStatistics()">
                  <i class="fas fa-chart-bar"></i> إحصائيات شاملة
                </button>
              </div>
            </div>
            
            <div id="codeInspectorResults" style="background: #f8f9fa; padding: 15px; border-radius: 10px; font-family: 'Courier New', monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
              جاهز للتحليل...
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Update initial data
      if (planData) {
        document.getElementById('dataSize').textContent = 
          (JSON.stringify(planData).length / 1024).toFixed(2) + ' KB';
        document.getElementById('recordCount').textContent = 
          planData.inspectionData ? planData.inspectionData.length : 0;
        document.getElementById('keyCount').textContent = 
          Object.keys(planData).length;
        document.getElementById('dataStructure').textContent = 
          Array.isArray(planData.inspectionData) ? 'Array' : 'Object';
      }
    }
    
    window.analyzeDataStructure = function() {
      if (!planData) {
        alert('❌ لا توجد بيانات للتحليل!');
        return;
      }
      
      const analysis = {
        totalRecords: planData.inspectionData ? planData.inspectionData.length : 0,
        uniqueInspectors: new Set(),
        uniqueAreas: new Set(),
        uniqueShops: new Set(),
        dateRange: { min: null, max: null },
        shiftDistribution: { 'صباحية': 0, 'مسائية': 0 }
      };
      
      if (planData.inspectionData) {
        planData.inspectionData.forEach(item => {
          if (item.inspector) analysis.uniqueInspectors.add(item.inspector);
          if (item.area) analysis.uniqueAreas.add(item.area);
          if (item.shops) item.shops.forEach(s => analysis.uniqueShops.add(s));
          if (item.day) {
            if (!analysis.dateRange.min || item.day < analysis.dateRange.min) 
              analysis.dateRange.min = item.day;
            if (!analysis.dateRange.max || item.day > analysis.dateRange.max) 
              analysis.dateRange.max = item.day;
          }
          if (item.shift) {
            analysis.shiftDistribution[item.shift] = 
              (analysis.shiftDistribution[item.shift] || 0) + 1;
          }
        });
      }
      
      const result = `
📊 تحليل البنية الشامل
${'='.repeat(50)}

📝 المعلومات الأساسية:
   • إجمالي السجلات: ${analysis.totalRecords}
   • المفتشون الفريدون: ${analysis.uniqueInspectors.size}
   • المناطق الفريدة: ${analysis.uniqueAreas.size}
   • المحلات الفريدة: ${analysis.uniqueShops.size}

📅 نطاق التواريخ:
   • من: ${analysis.dateRange.min || 'غير محدد'}
   • إلى: ${analysis.dateRange.max || 'غير محدد'}

⏰ توزيع الفترات:
   • صباحية: ${analysis.shiftDistribution['صباحية']}
   • مسائية: ${analysis.shiftDistribution['مسائية']}

👥 قائمة المفتشين:
${Array.from(analysis.uniqueInspectors).map((i, idx) => `   ${idx + 1}. ${i}`).join('\n')}

📍 قائمة المناطق:
${Array.from(analysis.uniqueAreas).map((a, idx) => `   ${idx + 1}. ${a}`).join('\n')}
      `;
      
      document.getElementById('codeInspectorResults').textContent = result;
    }
    
    window.findDuplicates = function() {
      if (!planData || !planData.inspectionData) {
        alert('❌ لا توجد بيانات للفحص!');
        return;
      }
      
      const duplicates = [];
      const seen = new Map();
      
      planData.inspectionData.forEach((item, index) => {
        const key = `${item.inspector}_${item.day}_${item.area}`;
        if (seen.has(key)) {
          duplicates.push({
            index1: seen.get(key),
            index2: index,
            key: key,
            item: item
          });
        } else {
          seen.set(key, index);
        }
      });
      
      let result = `
🔍 فحص التكرارات
${'='.repeat(50)}

`;
      
      if (duplicates.length === 0) {
        result += '✅ لم يتم العثور على تكرارات!\n\nالبيانات نظيفة وخالية من التكرارات.';
      } else {
        result += `⚠️ تم العثور على ${duplicates.length} تكرار!\n\n`;
        duplicates.forEach((dup, idx) => {
          result += `${idx + 1}. التكرار بين السطر ${dup.index1 + 1} والسطر ${dup.index2 + 1}\n`;
          result += `   المفتش: ${dup.item.inspector}\n`;
          result += `   التاريخ: ${dup.item.day}\n`;
          result += `   المنطقة: ${dup.item.area}\n\n`;
        });
      }
      
      document.getElementById('codeInspectorResults').textContent = result;
    }
    
    window.findMissingData = function() {
      if (!planData || !planData.inspectionData) {
        alert('❌ لا توجد بيانات للفحص!');
        return;
      }
      
      const missing = [];
      
      planData.inspectionData.forEach((item, index) => {
        const issues = [];
        if (!item.inspector) issues.push('المفتش');
        if (!item.day) issues.push('التاريخ');
        if (!item.area) issues.push('المنطقة');
        if (!item.shops || item.shops.length === 0) issues.push('المحلات');
        
        if (issues.length > 0) {
          missing.push({ index, issues, item });
        }
      });
      
      let result = `
⚠️ فحص البيانات الناقصة
${'='.repeat(50)}

`;
      
      if (missing.length === 0) {
        result += '✅ جميع البيانات كاملة!\n\nلا توجد حقول ناقصة في البيانات.';
      } else {
        result += `❌ تم العثور على ${missing.length} سجل يحتوي على بيانات ناقصة!\n\n`;
        missing.forEach((item, idx) => {
          result += `${idx + 1}. السطر ${item.index + 1}:\n`;
          result += `   البيانات الناقصة: ${item.issues.join(', ')}\n`;
          if (item.item.inspector) result += `   المفتش: ${item.item.inspector}\n`;
          if (item.item.day) result += `   التاريخ: ${item.item.day}\n`;
          result += '\n';
        });
      }
      
      document.getElementById('codeInspectorResults').textContent = result;
    }
    
    window.openBulkOperations = function() {
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.id = 'bulkOpsModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h3 class="modal-title">⚡ العمليات المجمعة - Bulk Operations</h3>
            <button class="modal-close" onclick="closeModal('bulkOpsModal')">&times;</button>
          </div>
          <div class="modal-body">
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
              <strong>⚠️ تنبيه:</strong> العمليات المجمعة قد تغير بيانات كثيرة دفعة واحدة. احفظ نسخة احتياطية أولاً!
            </div>
            
            <div class="quick-actions" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
              <div class="quick-action-btn" onclick="bulkUpdateShift()">
                <i class="fas fa-clock"></i>
                <div class="label">تحديث الفترة</div>
              </div>
              <div class="quick-action-btn" onclick="bulkUpdateArea()">
                <i class="fas fa-map-marked"></i>
                <div class="label">تحديث المنطقة</div>
              </div>
              <div class="quick-action-btn" onclick="bulkDeleteByDate()">
                <i class="fas fa-trash"></i>
                <div class="label">حذف حسب التاريخ</div>
              </div>
              <div class="quick-action-btn" onclick="bulkExportFiltered()">
                <i class="fas fa-file-export"></i>
                <div class="label">تصدير مفلتر</div>
              </div>
              <div class="quick-action-btn" onclick="bulkMergeShops()">
                <i class="fas fa-compress-arrows-alt"></i>
                <div class="label">دمج المحلات</div>
              </div>
              <div class="quick-action-btn" onclick="bulkSortData()">
                <i class="fas fa-sort-amount-down"></i>
                <div class="label">ترتيب البيانات</div>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    window.bulkUpdateShift = function() {
      if (!planData || !planData.inspectionData) {
        alert('❌ لا توجد بيانات!');
        return;
      }
      
      const oldShift = prompt('أدخل الفترة القديمة (صباحية/مسائية):');
      if (!oldShift) return;
      
      const newShift = prompt('أدخل الفترة الجديدة (صباحية/مسائية):');
      if (!newShift) return;
      
      let count = 0;
      planData.inspectionData.forEach(item => {
        if (item.shift === oldShift) {
          item.shift = newShift;
          count++;
        }
      });
      
      document.getElementById('planEditor').value = JSON.stringify(planData, null, 2);
      alert(`✅ تم تحديث ${count} سجل من "${oldShift}" إلى "${newShift}"`);
      logActivity('عملية مجمعة', `تحديث الفترة: ${count} سجل`);
    }
    
    window.bulkUpdateArea = function() {
      if (!planData || !planData.inspectionData) {
        alert('❌ لا توجد بيانات!');
        return;
      }
      
      const oldArea = prompt('أدخل اسم المنطقة القديمة:');
      if (!oldArea) return;
      
      const newArea = prompt('أدخل اسم المنطقة الجديدة:');
      if (!newArea) return;
      
      let count = 0;
      planData.inspectionData.forEach(item => {
        if (item.area === oldArea) {
          item.area = newArea;
          count++;
        }
      });
      
      document.getElementById('planEditor').value = JSON.stringify(planData, null, 2);
      alert(`✅ تم تحديث ${count} سجل من "${oldArea}" إلى "${newArea}"`);
      logActivity('عملية مجمعة', `تحديث المنطقة: ${count} سجل`);
    }
    
    window.bulkDeleteByDate = function() {
      if (!planData || !planData.inspectionData) {
        alert('❌ لا توجد بيانات!');
        return;
      }
      
      const date = prompt('أدخل التاريخ للحذف (YYYY-MM-DD) أو شهر (YYYY-MM):');
      if (!date) return;
      
      if (!confirm(`⚠️ هل أنت متأكد من حذف جميع السجلات التي تحتوي على "${date}"؟`)) return;
      
      const beforeCount = planData.inspectionData.length;
      planData.inspectionData = planData.inspectionData.filter(item => 
        !item.day || !item.day.includes(date)
      );
      const deletedCount = beforeCount - planData.inspectionData.length;
      
      document.getElementById('planEditor').value = JSON.stringify(planData, null, 2);
      alert(`✅ تم حذف ${deletedCount} سجل`);
      logActivity('عملية مجمعة', `حذف حسب التاريخ: ${deletedCount} سجل`);
    }
    
    window.bulkExportFiltered = function() {
      if (!planData || !planData.inspectionData) {
        alert('❌ لا توجد بيانات!');
        return;
      }
      
      const filter = prompt('أدخل كلمة للفلترة (مفتش، منطقة، أو أي كلمة):');
      if (!filter) return;
      
      const filtered = planData.inspectionData.filter(item => 
        JSON.stringify(item).toLowerCase().includes(filter.toLowerCase())
      );
      
      if (filtered.length === 0) {
        alert('❌ لم يتم العثور على سجلات تطابق الفلتر!');
        return;
      }
      
      const exportData = { inspectionData: filtered };
      const dataStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `filtered-data-${filter}-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      alert(`✅ تم تصدير ${filtered.length} سجل!`);
      logActivity('عملية مجمعة', `تصدير مفلتر: ${filtered.length} سجل`);
    }
    
    window.bulkMergeShops = function() {
      alert('🔧 هذه الميزة تدمج المحلات المتشابهة في الأسماء.\n\nقريباً سيتم إضافتها...');
    }
    
    window.bulkSortData = function() {
      if (!planData || !planData.inspectionData) {
        alert('❌ لا توجد بيانات!');
        return;
      }
      
      const sortBy = prompt('الترتيب حسب:\n1. التاريخ\n2. المفتش\n3. المنطقة\n\nأدخل الرقم:');
      
      if (sortBy === '1') {
        planData.inspectionData.sort((a, b) => 
          (a.day || '').localeCompare(b.day || '')
        );
      } else if (sortBy === '2') {
        planData.inspectionData.sort((a, b) => 
          (a.inspector || '').localeCompare(b.inspector || '')
        );
      } else if (sortBy === '3') {
        planData.inspectionData.sort((a, b) => 
          (a.area || '').localeCompare(b.area || '')
        );
      } else {
        alert('❌ اختيار غير صحيح!');
        return;
      }
      
      document.getElementById('planEditor').value = JSON.stringify(planData, null, 2);
      alert('✅ تم ترتيب البيانات بنجاح!');
      logActivity('عملية مجمعة', 'ترتيب البيانات');
    }
    
    window.openDataTransformer = function() {
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.id = 'dataTransformerModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px;">
          <div class="modal-header">
            <h3 class="modal-title">🔄 محول البيانات - Data Transformer</h3>
            <button class="modal-close" onclick="closeModal('dataTransformerModal')">&times;</button>
          </div>
          <div class="modal-body">
            <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
              <strong>ℹ️ معلومة:</strong> استخدم هذه الأداة لتحويل وتنسيق البيانات
            </div>
            
            <div class="form-group">
              <label class="form-label">نوع التحويل</label>
              <select id="transformType" class="form-control">
                <option value="json-to-csv">JSON إلى CSV</option>
                <option value="json-to-excel">JSON إلى Excel Format</option>
                <option value="normalize">تطبيع البيانات</option>
                <option value="deduplicate">إزالة التكرارات</option>
                <option value="fill-missing">ملء البيانات الناقصة</option>
              </select>
            </div>
            
            <button class="btn btn-primary" onclick="executeTransform()">
              <i class="fas fa-magic"></i> تنفيذ التحويل
            </button>
            
            <div id="transformResult" style="margin-top: 20px;"></div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    window.executeTransform = function() {
      if (!planData || !planData.inspectionData) {
        alert('❌ لا توجد بيانات!');
        return;
      }
      
      const type = document.getElementById('transformType').value;
      const result = document.getElementById('transformResult');
      
      switch(type) {
        case 'json-to-csv':
          const csv = convertToCSV(planData.inspectionData);
          result.innerHTML = `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <h4>معاينة CSV:</h4>
              <pre style="white-space: pre-wrap; max-height: 300px; overflow-y: auto;">${csv}</pre>
              <button class="btn btn-success" onclick="downloadCSV()">
                <i class="fas fa-download"></i> تحميل CSV
              </button>
            </div>
          `;
          window.currentCSV = csv;
          break;
          
        case 'normalize':
          normalizeData();
          result.innerHTML = `<div class="status-message" style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px;">
            ✅ تم تطبيع البيانات (توحيد التنسيق، إزالة المسافات الزائدة)
          </div>`;
          break;
          
        case 'deduplicate':
          const beforeCount = planData.inspectionData.length;
          removeDuplicates();
          const afterCount = planData.inspectionData.length;
          result.innerHTML = `<div class="status-message" style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px;">
            ✅ تمت إزالة ${beforeCount - afterCount} تكرار
          </div>`;
          break;
          
        case 'fill-missing':
          fillMissingData();
          result.innerHTML = `<div class="status-message" style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px;">
            ✅ تم ملء البيانات الناقصة بالقيم الافتراضية
          </div>`;
          break;
          
        default:
          result.innerHTML = `<div class="status-message" style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px;">
            ⚠️ هذه الميزة قيد التطوير
          </div>`;
      }
      
      logActivity('تحويل البيانات', `نوع التحويل: ${type}`);
    }
    
    function convertToCSV(data) {
      if (!data || data.length === 0) return '';
      
      const headers = ['المفتش', 'التاريخ', 'الفترة', 'المنطقة', 'عدد المحلات', 'المحلات'];
      let csv = headers.join(',') + '\n';
      
      data.forEach(item => {
        const row = [
          item.inspector || '',
          item.day || '',
          item.shift || '',
          item.area || '',
          item.shops ? item.shops.length : 0,
          item.shops ? item.shops.join('; ') : ''
        ];
        csv += row.map(cell => `"${cell}"`).join(',') + '\n';
      });
      
      return csv;
    }
    
    window.downloadCSV = function() {
      const blob = new Blob([window.currentCSV], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `plan-data-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    function normalizeData() {
      planData.inspectionData.forEach(item => {
        if (item.inspector) item.inspector = item.inspector.trim();
        if (item.area) item.area = item.area.trim();
        if (item.shops) item.shops = item.shops.map(s => s.trim());
      });
      document.getElementById('planEditor').value = JSON.stringify(planData, null, 2);
    }
    
    function removeDuplicates() {
      const seen = new Set();
      planData.inspectionData = planData.inspectionData.filter(item => {
        const key = `${item.inspector}_${item.day}_${item.area}`;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
      document.getElementById('planEditor').value = JSON.stringify(planData, null, 2);
    }
    
    function fillMissingData() {
      planData.inspectionData.forEach(item => {
        if (!item.inspector) item.inspector = 'غير محدد';
        if (!item.area) item.area = 'غير محدد';
        if (!item.shift) item.shift = 'صباحية';
        if (!item.shops) item.shops = [];
      });
      document.getElementById('planEditor').value = JSON.stringify(planData, null, 2);
    }
    
    window.generateStatistics = function() {
      if (!planData || !planData.inspectionData) {
        alert('❌ لا توجد بيانات للتحليل!');
        return;
      }
      
      const stats = {
        inspectors: {},
        areas: {},
        months: {},
        totalShops: 0
      };
      
      planData.inspectionData.forEach(item => {
        // Count by inspector
        if (item.inspector) {
          stats.inspectors[item.inspector] = 
            (stats.inspectors[item.inspector] || 0) + 1;
        }
        
        // Count by area
        if (item.area) {
          stats.areas[item.area] = 
            (stats.areas[item.area] || 0) + 1;
        }
        
        // Count by month
        if (item.day) {
          const month = item.day.substring(0, 7);
          stats.months[month] = 
            (stats.months[month] || 0) + 1;
        }
        
        // Total shops
        if (item.shops) {
          stats.totalShops += item.shops.length;
        }
      });
      
      // Sort by count
      const topInspectors = Object.entries(stats.inspectors)
        .sort((a, b) => b[1] - a[1]).slice(0, 10);
      const topAreas = Object.entries(stats.areas)
        .sort((a, b) => b[1] - a[1]).slice(0, 10);
      
      let result = `
📊 إحصائيات شاملة
${'='.repeat(50)}

📈 الأرقام العامة:
   • إجمالي التفتيشات: ${planData.inspectionData.length}
   • إجمالي المحلات المسجلة: ${stats.totalShops}
   • متوسط المحلات لكل تفتيش: ${(stats.totalShops / planData.inspectionData.length).toFixed(2)}

👨‍⚕️ أكثر المفتشين نشاطاً:
${topInspectors.map(([name, count], idx) => 
  `   ${idx + 1}. ${name}: ${count} تفتيش`).join('\n')}

📍 أكثر المناطق تفتيشاً:
${topAreas.map(([name, count], idx) => 
  `   ${idx + 1}. ${name}: ${count} تفتيش`).join('\n')}

📅 التوزيع الشهري:
${Object.entries(stats.months).sort().map(([month, count]) => 
  `   ${month}: ${count} تفتيش`).join('\n')}
      `;
      
      document.getElementById('codeInspectorResults').textContent = result;
    }
    
    // ========================
    // Maintenance Configuration Functions
    // ========================
    const configPath = "maintenance-config.json";
    
    // Load current maintenance configuration
    async function loadMaintenanceConfig() {
      const token = getToken();
      if (!token) {
        showMessage("configStatus", "error", "❌ يجب تسجيل الدخول أولاً");
        return;
      }
      
      try {
        showMessage("configStatus", "info", "جاري تحميل الإعدادات...");
        
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${configPath}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        if (res.ok) {
          const file = await res.json();
          const config = JSON.parse(decodeURIComponent(escape(atob(file.content))));
          
          // Update UI with current config
          document.getElementById('checkIntervalSelect').value = config.checkInterval || 10000;
          
          const musicEnabledRadios = document.querySelectorAll('input[name="musicEnabled"]');
          musicEnabledRadios.forEach(radio => {
            radio.checked = radio.value === String(config.musicEnabled);
          });
          
          document.getElementById('musicDurationSelect').value = config.musicDuration || 600000;
          
          const volumePercent = Math.round((config.musicVolume || 0.15) * 100);
          document.getElementById('musicVolumeSlider').value = volumePercent;
          document.getElementById('volumeValue').textContent = volumePercent + '%';
          
          // Update status display
          updateConfigStatusDisplay(config);
          
          showMessage("configStatus", "success", "✅ تم تحميل الإعدادات بنجاح!");
        } else {
          showMessage("configStatus", "warning", "⚠️ لم يتم العثور على ملف الإعدادات - سيتم استخدام القيم الافتراضية");
        }
      } catch (error) {
        showMessage("configStatus", "error", "❌ خطأ في تحميل الإعدادات: " + error.message);
      }
    }
    
    // Update status display
    function updateConfigStatusDisplay(config) {
      const intervalLabels = {
        0: "إيقاف الفحص التلقائي",
        5000: "5 ثوانٍ (سريع جداً)",
        10000: "10 ثوانٍ (افتراضي)",
        30000: "30 ثانية (متوسط)",
        60000: "60 ثانية (بطيء)",
        300000: "5 دقائق (بطيء جداً)"
      };
      
      const durationLabels = {
        0: "تشغيل مستمر (بدون إيقاف)",
        30000: "30 ثانية",
        60000: "دقيقة واحدة",
        300000: "5 دقائق",
        600000: "10 دقائق (افتراضي)",
        1800000: "30 دقيقة"
      };
      
      document.getElementById('currentCheckInterval').textContent = intervalLabels[config.checkInterval] || config.checkIntervalLabel || "غير معروف";
      document.getElementById('currentMusicEnabled').textContent = config.musicEnabled ? "✅ مفعّل" : "❌ معطّل";
      document.getElementById('currentMusicDuration').textContent = durationLabels[config.musicDuration] || config.musicDurationLabel || "غير معروف";
      document.getElementById('currentMusicVolume').textContent = Math.round((config.musicVolume || 0.15) * 100) + '%';
    }
    
    // Save maintenance configuration
    async function saveMaintenanceConfig() {
      const token = getToken();
      if (!token) {
        showTokenModal();
        return;
      }
      
      if (!confirm("هل أنت متأكد من حفظ هذه الإعدادات؟\n\nستؤثر التغييرات على جميع الأجهزة فوراً.")) {
        return;
      }
      
      try {
        showMessage("configStatus", "info", "جاري حفظ الإعدادات...");
        
        const checkInterval = parseInt(document.getElementById('checkIntervalSelect').value);
        const musicEnabled = document.querySelector('input[name="musicEnabled"]:checked').value === 'true';
        const musicDuration = parseInt(document.getElementById('musicDurationSelect').value);
        const musicVolume = parseInt(document.getElementById('musicVolumeSlider').value) / 100;
        
        const intervalLabels = {
          0: "إيقاف",
          5000: "5 ثوانٍ",
          10000: "10 ثوانٍ",
          30000: "30 ثانية",
          60000: "60 ثانية",
          300000: "5 دقائق"
        };
        
        const durationLabels = {
          0: "مستمر",
          30000: "30 ثانية",
          60000: "دقيقة واحدة",
          300000: "5 دقائق",
          600000: "10 دقائق",
          1800000: "30 دقيقة"
        };
        
        const config = {
          checkInterval: checkInterval,
          checkIntervalLabel: intervalLabels[checkInterval] || checkInterval + " مللي ثانية",
          musicEnabled: musicEnabled,
          musicDuration: musicDuration,
          musicDurationLabel: durationLabels[musicDuration] || musicDuration + " مللي ثانية",
          musicVolume: musicVolume,
          lastUpdated: new Date().toISOString(),
          updatedBy: "المطور"
        };
        
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(config, null, 2))));
        
        // Get current file SHA
        const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${configPath}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        let sha = "";
        if (getRes.ok) {
          const file = await getRes.json();
          sha = file.sha;
        }
        
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${configPath}`, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "تحديث إعدادات الصيانة والموسيقى",
            content: content,
            sha: sha
          })
        });
        
        if (res.status === 200 || res.status === 201) {
          updateConfigStatusDisplay(config);
          showMessage("configStatus", "success", "✅ تم حفظ الإعدادات بنجاح!\n\n📱 سيتم تطبيق التغييرات على جميع الأجهزة خلال ثوانٍ.");
          logActivity("تحديث إعدادات الصيانة", `فحص: ${config.checkIntervalLabel}، موسيقى: ${musicEnabled ? 'مفعّلة' : 'معطّلة'}`);
        } else {
          showMessage("configStatus", "error", "❌ حدث خطأ في حفظ الإعدادات");
        }
      } catch (error) {
        showMessage("configStatus", "error", "❌ خطأ: " + error.message);
      }
    }
    
    // Emergency stop all maintenance features
    async function emergencyStopAll() {
      if (!confirm("⚠️ تحذير: إيقاف طارئ لكل شيء!\n\nسيتم:\n• إيقاف وضع الصيانة فوراً\n• إيقاف تشغيل الموسيقى\n• إيقاف الفحص التلقائي\n\nهل أنت متأكد؟")) {
        return;
      }
      
      const token = getToken();
      if (!token) {
        showTokenModal();
        return;
      }
      
      try {
        showMessage("configStatus", "info", "🚨 جاري تنفيذ الإيقاف الطارئ...");
        
        // 1. Disable maintenance mode
        const maintenanceData = {
          enabled: false,
          messages: {},
          disabledAt: new Date().toISOString(),
          disabledBy: "المطور (إيقاف طارئ)"
        };
        
        let content = btoa(unescape(encodeURIComponent(JSON.stringify(maintenanceData, null, 2))));
        
        let getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${maintenancePath}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        let sha = "";
        if (getRes.ok) {
          const file = await getRes.json();
          sha = file.sha;
        }
        
        await fetch(`https://api.github.com/repos/${repo}/contents/${maintenancePath}`, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "إيقاف طارئ - إلغاء وضع الصيانة",
            content: content,
            sha: sha
          })
        });
        
        // 2. Update config to disable music and slow down checks
        const config = {
          checkInterval: 60000,
          checkIntervalLabel: "60 ثانية",
          musicEnabled: false,
          musicDuration: 0,
          musicDurationLabel: "معطّل",
          musicVolume: 0,
          lastUpdated: new Date().toISOString(),
          updatedBy: "المطور (إيقاف طارئ)"
        };
        
        content = btoa(unescape(encodeURIComponent(JSON.stringify(config, null, 2))));
        
        getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${configPath}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        sha = "";
        if (getRes.ok) {
          const file = await getRes.json();
          sha = file.sha;
        }
        
        await fetch(`https://api.github.com/repos/${repo}/contents/${configPath}`, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "إيقاف طارئ - تعطيل الموسيقى والفحص السريع",
            content: content,
            sha: sha
          })
        });
        
        // Update UI
        await loadMaintenanceConfig();
        
        showMessage("configStatus", "success", "✅ تم تنفيذ الإيقاف الطارئ بنجاح!\n\n✓ وضع الصيانة: معطّل\n✓ الموسيقى: معطّلة\n✓ الفحص: مرة كل دقيقة");
        showMessage("maintenanceStatus", "success", "✅ تم إلغاء وضع الصيانة (إيقاف طارئ)");
        
        logActivity("إيقاف طارئ", "تم إيقاف جميع ميزات الصيانة والموسيقى فوراً");
      } catch (error) {
        showMessage("configStatus", "error", "❌ خطأ في الإيقاف الطارئ: " + error.message);
      }
    }
    
    // ========================
    // Initialization
    // ========================
    async function initDashboard() {
      const token = getToken();
      if (!token) {
        showTokenModal();
        return;
      }
      
      // Load plan data
      await loadPlan();
      
      // Load shops details for dropdowns
      await loadShopsDetails();
      
      // Initialize activity log
      refreshActivityLog();
      
      // Load maintenance configuration
      await loadMaintenanceConfig();
      
      // Log dashboard access
      logActivity("الوصول للوحة التحكم", "تم الدخول إلى لوحة التحكم المتقدمة");
    }
    
    // Initialize on page load
    window.onload = function() {
      initDashboard();
    };
  </script>
</body>
</html>
