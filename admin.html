<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة إدارة خطة التفتيش</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- SEO Prevention Meta Tags - Hide from Search Engines -->
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex, notranslate">
  <meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
  <meta name="bingbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta property="og:title" content="">
  <meta property="og:description" content="">
  <meta name="twitter:card" content="">
  <meta name="twitter:title" content="">
  <meta name="twitter:description" content="">
  <style>
    body {font-family:Arial; background:#f7f7ff; margin:0; padding:0;}
    .box {max-width:600px; background:#fff; margin:50px auto; padding:30px 22px; border-radius:12px; box-shadow:0 0 16px #bbb;}
    textarea {width:100%; font-size:1.1em; padding:8px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box;}
    button {background:#2336a0; color:#fff; border:none; border-radius:6px; padding:10px 28px; font-size:1.08em; cursor:pointer;}
    button:disabled {background:#999;}
    .status {margin:14px 0 0 0;}
    label {font-weight:bold; color:#2336a0;}
    input[type="password"] {font-size:1.1em; padding:7px; border-radius:6px; border:1px solid #bbb; box-sizing:border-box;}
    .token-popup-bg {
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.17);z-index:1000;
      display:flex;align-items:center;justify-content:center;
    }
    .token-popup-box {
      background:#fff;padding:26px 22px;border-radius:12px;box-shadow:0 0 22px #aaa;min-width:320px;text-align:center;position:relative;
    }
    .token-popup-box label {color:#2336a0;}
    .token-popup-close {
      position:absolute;right:8px;top:8px;border:none;background:#dc3545;color:#fff;border-radius:50%;
      font-size:1.3em;width:32px;height:32px;cursor:pointer;box-shadow:0 2px 8px rgba(220,53,69,0.3);
      transition:all 0.2s ease;display:flex;align-items:center;justify-content:center;font-weight:bold;z-index:10;
    }
    .token-popup-close:hover {
      background:#c82333;transform:scale(1.05);box-shadow:0 4px 12px rgba(220,53,69,0.4);
    }
    
    @media (max-width:600px) {
      .box {
        margin:20px auto;
        padding:20px 15px;
        max-width:95vw;
        border-radius:8px;
      }
      textarea {
        font-size:1em;
        padding:6px;
        rows:12;
      }
      button {
        padding:8px 20px;
        font-size:1em;
        width:100%;
        margin-bottom:8px;
      }
      .token-popup-box {
        padding:20px 15px;
        min-width:280px;
        max-width:90vw;
        margin:0 20px;
      }
      input[type="password"] {
        font-size:1em;
        padding:6px;
        width:100%;
        margin:10px 0;
      }
      h2 {
        font-size:1.3em;
        margin-bottom:15px;
      }
    }
    
    @media (max-width:400px) {
      .box {
        margin:10px auto;
        padding:15px 10px;
        max-width:98vw;
      }
      textarea {
        font-size:0.9em;
        padding:5px;
      }
      button {
        padding:6px 16px;
        font-size:0.95em;
      }
      .token-popup-box {
        padding:15px 10px;
        min-width:260px;
      }
      h2 {
        font-size:1.2em;
      }
    }
  </style>
</head>
<body>
  <div class="token-popup-bg" id="tokenPopup" style="display:none;">
    <div class="token-popup-box">
      <button class="token-popup-close" onclick="hideTokenPopup()" title="إغلاق">×</button>
      <h3>إدخال التوكن السري</h3>
      <p style="font-size:0.9em;color:#666;margin:10px 0;">يرجى إدخال GitHub Personal Access Token للمستودع</p>
      <input id="tokenInput" type="password" placeholder="GitHub Personal Access Token"><br><br>
      <button onclick="saveToken()">حفظ</button>
      <button onclick="useDefaultToken()" style="background:#666;margin-left:10px;">استخدام التوكن الافتراضي</button>
      <div style="color:#c00;font-size:1em;margin-top:10px;" id="tokenError"></div>
    </div>
  </div>
  <div class="box">
    <h2 style="text-align:center; color:#2336a0;">تعديل ملف خطة التفتيش (plan-data.json)</h2>
    <button onclick="changeToken()" style="float:left;margin-bottom:10px;">تغيير التوكن</button>
    <label>بيانات JSON (يمكنك التعديل هنا):</label>
    <textarea id="json" rows="18"></textarea><br>
    <button onclick="updatePlan()" id="saveBtn">حفظ التعديلات</button>
    <div class="status" id="status"></div>
  </div>

  <div class="box">
    <h2 style="text-align:center; color:#2336a0;">نظام إدارة الملفات</h2>
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 10px;">رفع ملف جديد:</label>
      <input type="file" id="fileUpload" accept=".pdf,.xlsx,.xls,.docx,.doc,.pptx,.ppt,.csv,.txt,.jpg,.jpeg,.png,.gif" style="margin-bottom: 10px;">
      <br>
      <label style="display: block; margin-bottom: 5px;">اختر التصنيف:</label>
      <select id="fileCategory" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc; margin-bottom: 10px;">
        <option value="documents">الوثائق - Documents</option>
        <option value="reports">التقارير - Reports</option>
        <option value="schedules">الجداول - Schedules</option>
        <option value="resources">الموارد - Resources</option>
      </select>
      <br>
      <label style="display: block; margin-bottom: 5px;">وصف الملف (اختياري):</label>
      <input type="text" id="fileDescription" placeholder="وصف مختصر للملف" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; margin-bottom: 10px; box-sizing: border-box;">
      <br>
      <button onclick="uploadFile()" id="uploadBtn" style="background: #28a745;">رفع الملف</button>
    </div>
    
    <div style="border-top: 1px solid #ddd; padding-top: 20px;">
      <h3 style="color: #2336a0;">الملفات المرفوعة:</h3>
      <button onclick="loadFilesList()" style="background: #17a2b8; margin-bottom: 10px;">تحديث قائمة الملفات</button>
      <div id="filesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #f9f9f9;">
        <p style="text-align: center; color: #666;">انقر على "تحديث قائمة الملفات" لعرض الملفات المرفوعة</p>
      </div>
    </div>
    
    <div class="status" id="fileStatus" style="margin-top: 10px;"></div>
  </div>
  <script>
    const repo = "aliabdelaal-adm/Monthly_inspection_plan";
    const path = "plan-data.json";
    let sha = "";

    // ---- Token Management ----
    function getToken() {
      return localStorage.getItem("devToken") || "";
    }
    function setToken(token) {
      localStorage.setItem("devToken", token);
    }
    function removeToken() {
      localStorage.removeItem("devToken");
    }
    function showTokenPopup() {
      document.getElementById("tokenPopup").style.display = "flex";
      document.getElementById("tokenInput").value = "";
      document.getElementById("tokenInput").focus();
      document.getElementById("tokenError").textContent = "";
    }
    function hideTokenPopup() {
      document.getElementById("tokenPopup").style.display = "none";
    }
    function saveToken() {
      const token = document.getElementById("tokenInput").value.trim();
      if (!token) {
        document.getElementById("tokenError").textContent = "يرجى إدخال التوكن السري!";
        return;
      }
      setToken(token);
      hideTokenPopup();
      loadPlan();
    }
    function useDefaultToken() {
      // Use the repository's default token
      const defaultToken = "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";
      setToken(defaultToken);
      hideTokenPopup();
      loadPlan();
    }
    function changeToken() {
      removeToken();
      showTokenPopup();
    }

    // ---- Plan Data Logic ----
    async function loadPlan() {
      const token = getToken();
      if (!token) { showTokenPopup(); return; }
      
      try {
        document.getElementById("status").textContent = "جاري تحميل البيانات...";
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const file = await res.json();
        document.getElementById("json").value = decodeURIComponent(escape(atob(file.content)));
        sha = file.sha;
        document.getElementById("status").textContent = "تم تحميل البيانات. يمكنك التعديل الآن.";
      } catch (error) {
        document.getElementById("status").textContent = "❌ خطأ في تحميل البيانات: " + error.message;
        if (error.message.includes("401") || error.message.includes("403")) {
          removeToken();
          setTimeout(showTokenPopup, 500);
        }
      }
    }

    async function updatePlan() {
      const token = getToken();
      if (!token) { showTokenPopup(); return; }
      let jsonData;
      try {
        jsonData = JSON.parse(document.getElementById("json").value);
      } catch(e) {
        alert("خطأ في تنسيق JSON! راجع الأقواس والفواصل.");
        return;
      }
      
      try {
        document.getElementById("saveBtn").disabled = true;
        document.getElementById("status").textContent = "جاري الحفظ...";
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(jsonData, null, 2))));
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "تحديث خطة التفتيش من لوحة المطور",
            content: content,
            sha: sha
          })
        });
        
        if (res.status === 200 || res.status === 201) {
          document.getElementById("status").textContent = "✅ تم حفظ التعديلات بنجاح!";
          loadPlan(); // reload sha
        } else {
          const err = await res.json().catch(() => ({ message: `HTTP ${res.status}: ${res.statusText}` }));
          document.getElementById("status").textContent = "❌ حدث خطأ: " + (err.message || "تحقق من التوكن أو الصلاحيات.");
          if (res.status === 401 || res.status === 403) {
            removeToken();
            setTimeout(showTokenPopup, 500);
          }
        }
      } catch (error) {
        document.getElementById("status").textContent = "❌ خطأ في الاتصال: " + error.message;
      } finally {
        document.getElementById("saveBtn").disabled = false;
      }
    }

    // ---- File Management Functions ----
    let filesSha = "";
    
    async function uploadFile() {
      const token = getToken();
      if (!token) { showTokenPopup(); return; }
      
      const fileInput = document.getElementById("fileUpload");
      const categorySelect = document.getElementById("fileCategory");
      const descriptionInput = document.getElementById("fileDescription");
      
      if (!fileInput.files[0]) {
        document.getElementById("fileStatus").textContent = "❌ يرجى اختيار ملف أولاً";
        return;
      }
      
      const file = fileInput.files[0];
      const category = categorySelect.value;
      const description = descriptionInput.value || file.name;
      
      // التحقق من حجم الملف (الحد الأقصى 25 MB للـ GitHub)
      const maxSize = 25 * 1024 * 1024; // 25 MB
      if (file.size > maxSize) {
        document.getElementById("fileStatus").textContent = "❌ حجم الملف كبير جداً! يجب أن يكون أقل من 25 MB";
        return;
      }
      
      try {
        document.getElementById("uploadBtn").disabled = true;
        document.getElementById("fileStatus").textContent = "⏳ جاري رفع الملف...";
        
        // قراءة الملف كـ base64
        const reader = new FileReader();
        reader.onload = async function(e) {
          const content = e.target.result.split(',')[1]; // إزالة data:type/format;base64,
          const fileName = file.name;
          const filePath = `files/${category}/${fileName}`;
          
          try {
            // رفع الملف إلى GitHub
            const uploadRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
              method: "PUT",
              headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                message: `رفع ملف جديد: ${fileName}`,
                content: content
              })
            });
            
            if (uploadRes.status === 201) {
              // تحديث ملف files.json
              await updateFilesRegistry(fileName, filePath, category, file.size, description, token);
              document.getElementById("fileStatus").textContent = "✅ تم رفع الملف بنجاح!";
              // إعادة تعيين النموذج
              fileInput.value = '';
              descriptionInput.value = '';
              // تحديث قائمة الملفات
              loadFilesList();
            } else {
              const err = await uploadRes.json().catch(() => ({ message: `HTTP ${uploadRes.status}: ${uploadRes.statusText}` }));
              document.getElementById("fileStatus").textContent = "❌ خطأ في رفع الملف: " + (err.message || "تحقق من التوكن أو الصلاحيات.");
            }
          } catch (error) {
            document.getElementById("fileStatus").textContent = "❌ خطأ في رفع الملف: " + error.message;
          } finally {
            document.getElementById("uploadBtn").disabled = false;
          }
        };
        
        reader.readAsDataURL(file);
        
      } catch (error) {
        document.getElementById("fileStatus").textContent = "❌ خطأ في قراءة الملف: " + error.message;
        document.getElementById("uploadBtn").disabled = false;
      }
    }
    
    async function updateFilesRegistry(fileName, filePath, category, fileSize, description, token) {
      try {
        // تحميل ملف files.json الحالي
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        let filesData = { files: [], categories: [], lastUpdate: new Date().toISOString() };
        let currentSha = "";
        
        if (res.ok) {
          const file = await res.json();
          filesData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
          currentSha = file.sha;
        }
        
        // إضافة الملف الجديد
        const newFile = {
          id: Date.now().toString(),
          name: fileName,
          path: filePath,
          category: category,
          type: fileName.split('.').pop().toLowerCase(),
          size: fileSize,
          uploadDate: new Date().toISOString(),
          description: description,
          uploader: "د. علي عبدالعال",
          visible: true
        };
        
        filesData.files.push(newFile);
        filesData.lastUpdate = new Date().toISOString();
        
        // حفظ ملف files.json المحدث
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(filesData, null, 2))));
        const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: `تحديث سجل الملفات - إضافة ${fileName}`,
            content: content,
            sha: currentSha
          })
        });
        
        if (!updateRes.ok) {
          console.error("خطأ في تحديث سجل الملفات");
        }
        
      } catch (error) {
        console.error("خطأ في تحديث سجل الملفات:", error);
      }
    }
    
    async function loadFilesList() {
      const token = getToken();
      if (!token) { showTokenPopup(); return; }
      
      try {
        document.getElementById("fileStatus").textContent = "⏳ جاري تحميل قائمة الملفات...";
        
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        if (res.ok) {
          const file = await res.json();
          const filesData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
          displayFilesList(filesData.files);
          document.getElementById("fileStatus").textContent = "✅ تم تحميل قائمة الملفات";
        } else {
          document.getElementById("fileStatus").textContent = "❌ خطأ في تحميل قائمة الملفات";
        }
      } catch (error) {
        document.getElementById("fileStatus").textContent = "❌ خطأ في تحميل قائمة الملفات: " + error.message;
      }
    }
    
    function displayFilesList(files) {
      const container = document.getElementById("filesList");
      
      if (!files || files.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">لا توجد ملفات مرفوعة</p>';
        return;
      }
      
      const visibleFiles = files.filter(f => f.visible !== false);
      
      if (visibleFiles.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">لا توجد ملفات مرئية</p>';
        return;
      }
      
      let html = '';
      const categories = {
        documents: 'الوثائق',
        reports: 'التقارير', 
        schedules: 'الجداول',
        resources: 'الموارد'
      };
      
      // تجميع الملفات حسب التصنيف
      const filesByCategory = {};
      visibleFiles.forEach(file => {
        if (!filesByCategory[file.category]) {
          filesByCategory[file.category] = [];
        }
        filesByCategory[file.category].push(file);
      });
      
      // عرض الملفات حسب التصنيف
      Object.keys(filesByCategory).forEach(category => {
        html += `<div style="margin-bottom: 15px;">`;
        html += `<h4 style="color: #2336a0; margin-bottom: 8px;">${categories[category] || category}</h4>`;
        
        filesByCategory[category].forEach(file => {
          const fileSize = formatFileSize(file.size);
          const uploadDate = new Date(file.uploadDate).toLocaleDateString('ar-EG');
          
          html += `
            <div style="padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; background: white;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>${file.name}</strong>
                  <br>
                  <small style="color: #666;">${file.description}</small>
                  <br>
                  <small style="color: #999;">الحجم: ${fileSize} | التاريخ: ${uploadDate}</small>
                </div>
                <div>
                  <button onclick="downloadFile('${file.path}')" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 5px;">تحميل</button>
                  <button onclick="deleteFile('${file.id}', '${file.path}', '${file.name}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">حذف</button>
                </div>
              </div>
            </div>
          `;
        });
        
        html += `</div>`;
      });
      
      container.innerHTML = html;
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    async function downloadFile(filePath) {
      const token = getToken();
      if (!token) { showTokenPopup(); return; }
      
      try {
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        if (res.ok) {
          const file = await res.json();
          const content = atob(file.content);
          const blob = new Blob([content], { type: 'application/octet-stream' });
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = file.name;
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          document.getElementById("fileStatus").textContent = "✅ تم تحميل الملف";
        } else {
          document.getElementById("fileStatus").textContent = "❌ خطأ في تحميل الملف";
        }
      } catch (error) {
        document.getElementById("fileStatus").textContent = "❌ خطأ في تحميل الملف: " + error.message;
      }
    }
    
    async function deleteFile(fileId, filePath, fileName) {
      if (!confirm(`هل أنت متأكد من حذف الملف "${fileName}"؟`)) {
        return;
      }
      
      const token = getToken();
      if (!token) { showTokenPopup(); return; }
      
      try {
        document.getElementById("fileStatus").textContent = "⏳ جاري حذف الملف...";
        
        // حذف الملف من GitHub
        const fileRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        if (fileRes.ok) {
          const file = await fileRes.json();
          const deleteRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
            method: "DELETE",
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              message: `حذف الملف: ${fileName}`,
              sha: file.sha
            })
          });
          
          if (deleteRes.ok) {
            // تحديث ملف files.json
            await removeFromFilesRegistry(fileId, token);
            document.getElementById("fileStatus").textContent = "✅ تم حذف الملف بنجاح";
            loadFilesList();
          } else {
            document.getElementById("fileStatus").textContent = "❌ خطأ في حذف الملف";
          }
        } else {
          document.getElementById("fileStatus").textContent = "❌ الملف غير موجود";
        }
      } catch (error) {
        document.getElementById("fileStatus").textContent = "❌ خطأ في حذف الملف: " + error.message;
      }
    }
    
    async function removeFromFilesRegistry(fileId, token) {
      try {
        // تحميل ملف files.json الحالي
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        
        if (res.ok) {
          const file = await res.json();
          const filesData = JSON.parse(decodeURIComponent(escape(atob(file.content))));
          
          // إزالة الملف من القائمة
          filesData.files = filesData.files.filter(f => f.id !== fileId);
          filesData.lastUpdate = new Date().toISOString();
          
          // حفظ ملف files.json المحدث
          const content = btoa(unescape(encodeURIComponent(JSON.stringify(filesData, null, 2))));
          const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/files.json`, {
            method: "PUT",
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              message: `تحديث سجل الملفات - حذف ملف`,
              content: content,
              sha: file.sha
            })
          });
          
          if (!updateRes.ok) {
            console.error("خطأ في تحديث سجل الملفات");
          }
        }
      } catch (error) {
        console.error("خطأ في تحديث سجل الملفات:", error);
      }
    }

    // ---- On Load ----
    window.onload = function() {
      if (!getToken()) {
        showTokenPopup();
      } else {
        loadPlan();
      }
    };
  </script>
</body>
</html>
