<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Dynamic Audio Persistence Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .info-box {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin: 20px 0;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #fafafa;
            border-radius: 5px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .metrics {
            font-family: monospace;
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            direction: ltr;
            text-align: left;
        }
        .log {
            max-height: 300px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            direction: ltr;
            text-align: left;
        }
        .log-entry {
            padding: 2px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø±: Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„ØµÙˆØª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ</h1>
        <h2>Test: Dynamic Audio Persistence Fix</h2>
        
        <div class="info-box">
            <strong>Ø§Ù„Ù‡Ø¯Ù Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± | Test Objective:</strong><br>
            Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙˆØª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ ÙŠØ³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªÙ‚Ø¯Ù… Ø¹Ø¨Ø± Ø¯ÙˆØ±Ø© 20 Ø¯Ù‚ÙŠÙ‚Ø© Ø­ØªÙ‰ Ø¹Ù†Ø¯ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ showMaintenanceMode() Ø¹Ø¯Ø© Ù…Ø±Ø§Øª<br>
            Verify that dynamic audio continues progressing through the 20-minute cycle even when showMaintenanceMode() is called multiple times
        </div>

        <div class="test-section">
            <h3>ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± | Test Info</h3>
            <p><strong>Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© | Original Problem:</strong><br>
            ÙƒØ§Ù† Ø§Ù„Ù…ØªØºÙŠØ± elapsedSeconds Ù…Ø­Ù„ÙŠÙ‹Ø§ØŒ ÙÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†Ù‡ Ø¥Ù„Ù‰ 0 ÙÙŠ ÙƒÙ„ Ù…Ø±Ø© ÙŠØªÙ… ÙÙŠÙ‡Ø§ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ showMaintenanceMode()<br>
            elapsedSeconds was local, so it reset to 0 every time showMaintenanceMode() was called</p>
            
            <p><strong>Ø§Ù„Ø­Ù„ | Solution:</strong><br>
            Ù†Ù‚Ù„ elapsedSeconds Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù… ÙƒÙ€ maintenanceElapsedSeconds<br>
            Move elapsedSeconds to global scope as maintenanceElapsedSeconds</p>
        </div>

        <div class="test-section">
            <h3>ğŸ® Ø§Ù„ØªØ­ÙƒÙ… | Controls</h3>
            <button onclick="simulateShowMaintenanceMode()">Ù…Ø­Ø§ÙƒØ§Ø© showMaintenanceMode() | Simulate Call</button>
            <button onclick="checkElapsedTime()">ÙØ­Øµ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ | Check Elapsed Time</button>
            <button onclick="resetTest()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† | Reset</button>
            
            <div class="status info" id="status">
                Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± | Ready to test
            </div>
            
            <div class="metrics" id="metrics">
                <div>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ | Elapsed Time: <strong id="elapsedTime">0:00</strong></div>
                <div>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ¯Ø¹Ø§Ø© | Call Count: <strong id="callCount">0</strong></div>
                <div>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠ | Current Volume: <strong id="currentVolume">-</strong></div>
                <div>Ø§Ù„ØªØ±Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ | Current Freq: <strong id="currentFreq">-</strong></div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ Ø§Ù„Ø³Ø¬Ù„ | Log</h3>
            <div class="log" id="log"></div>
        </div>

        <div class="info-box">
            <strong>âœ… Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù†Ø¬Ø§Ø­ | Success Criteria:</strong><br>
            1. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³ØªÙ…Ø± maintenanceElapsedSeconds ÙÙŠ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©<br>
            &nbsp;&nbsp;&nbsp;maintenanceElapsedSeconds should continue increasing even after multiple calls<br>
            2. ÙŠØ¬Ø¨ Ø£Ù„Ø§ ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆÙ‚Øª Ø¥Ù„Ù‰ 0 Ø¹Ù†Ø¯ ÙƒÙ„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡<br>
            &nbsp;&nbsp;&nbsp;Time should NOT reset to 0 on each call<br>
            3. ÙŠØ¬Ø¨ Ø£Ù† ØªØªØºÙŠØ± Ù‚ÙŠÙ… Ø§Ù„ØµÙˆØª ÙˆØ§Ù„ØªØ±Ø¯Ø¯ Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ…Ø±<br>
            &nbsp;&nbsp;&nbsp;Volume and frequency values should continuously change
        </div>
    </div>

    <script>
        // Simulated global variables from index.html
        let maintenanceAudioContext = null;
        let maintenanceGainNode = null;
        let maintenanceFilterNode = null;
        let maintenanceDynamicInterval = null;
        let maintenanceElapsedSeconds = 0; // THIS IS THE FIX - now global!

        let callCount = 0;
        let logEntries = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            logEntries.push(entry);
            
            const logDiv = document.getElementById('log');
            const entryDiv = document.createElement('div');
            entryDiv.className = 'log-entry';
            entryDiv.textContent = entry;
            logDiv.appendChild(entryDiv);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(entry);
        }

        function simulateShowMaintenanceMode() {
            callCount++;
            document.getElementById('callCount').textContent = callCount;
            
            log(`ğŸ”§ Calling showMaintenanceMode() - Call #${callCount}`, 'info');
            
            // Simulate the key parts of showMaintenanceMode()
            const totalDuration = 20 * 60; // 20 minutes in seconds
            
            // Clear any existing interval (this happens in real code)
            if (maintenanceDynamicInterval) {
                clearInterval(maintenanceDynamicInterval);
                log('â¸ï¸  Cleared existing interval');
            }
            
            // IMPORTANT: With the fix, maintenanceElapsedSeconds is NOT reset here
            // It continues from where it was
            
            // Start the interval
            maintenanceDynamicInterval = setInterval(() => {
                maintenanceElapsedSeconds += 1;
                
                if (maintenanceElapsedSeconds >= totalDuration) {
                    maintenanceElapsedSeconds = 0;
                    log('ğŸ”„ Completed 20-minute cycle, resetting to 0');
                }
                
                const progress = maintenanceElapsedSeconds / totalDuration;
                
                // Calculate volume and frequency (same formulas as in index.html)
                const volumeWave = 0.15 + 0.05 * Math.sin(progress * Math.PI * 4);
                const filterFreq = 2000 + 500 * Math.sin(progress * Math.PI * 6);
                
                // Update display
                updateMetrics(maintenanceElapsedSeconds, volumeWave, filterFreq);
                
                log(`ğŸµ Audio variation at ${formatTime(maintenanceElapsedSeconds)} - Volume: ${volumeWave.toFixed(2)}, Filter: ${Math.floor(filterFreq)}Hz`);
            }, 1000); // Update every 1 second
            
            log(`âœ… Interval started. Current elapsed time: ${formatTime(maintenanceElapsedSeconds)}`);
            updateStatus('success', `showMaintenanceMode() called ${callCount} times. Elapsed time continues from ${formatTime(maintenanceElapsedSeconds)}`);
        }

        function checkElapsedTime() {
            const minutes = Math.floor(maintenanceElapsedSeconds / 60);
            const seconds = maintenanceElapsedSeconds % 60;
            const timeStr = `${minutes}:${String(seconds).padStart(2, '0')}`;
            
            log(`â±ï¸  Current elapsed time: ${timeStr} (${maintenanceElapsedSeconds} seconds)`);
            updateStatus('info', `Current elapsed time: ${timeStr}`);
        }

        function resetTest() {
            if (maintenanceDynamicInterval) {
                clearInterval(maintenanceDynamicInterval);
                maintenanceDynamicInterval = null;
            }
            
            maintenanceElapsedSeconds = 0;
            callCount = 0;
            logEntries = [];
            
            document.getElementById('log').innerHTML = '';
            document.getElementById('callCount').textContent = '0';
            document.getElementById('elapsedTime').textContent = '0:00';
            document.getElementById('currentVolume').textContent = '-';
            document.getElementById('currentFreq').textContent = '-';
            
            log('ğŸ”„ Test reset');
            updateStatus('info', 'Test reset. Ready to start again.');
        }

        function updateMetrics(elapsed, volume, freq) {
            document.getElementById('elapsedTime').textContent = formatTime(elapsed);
            document.getElementById('currentVolume').textContent = volume.toFixed(3);
            document.getElementById('currentFreq').textContent = Math.floor(freq) + ' Hz';
        }

        function updateStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${String(secs).padStart(2, '0')}`;
        }

        // Initial log
        log('ğŸš€ Test page loaded. Ready to test dynamic audio persistence fix.');
        log('ğŸ“Œ Key fix: maintenanceElapsedSeconds is now a global variable');
        log('ğŸ“Œ This ensures elapsed time persists across multiple showMaintenanceMode() calls');
    </script>
</body>
</html>
