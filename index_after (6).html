<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>واجهة إدارة خطة التفتيش الشهرية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {font-family:'Cairo',Tahoma,Arial,sans-serif;background:#f7f8fa;margin:0;padding:0;}
        .container {max-width:1100px;margin:40px auto 24px auto;background:#fff;border-radius:18px;box-shadow:0 4px 32px #0002;padding:32px 24px 24px 24px;direction:rtl;}
        .main-title {background:#234093;color:#fff;border-radius:10px;padding:18px 0;text-align:center;font-size:2em;margin-bottom:24px;letter-spacing:1px;}
        .top-bar {display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:18px;gap:1.5rem;}
        .top-bar label,.top-bar .user-type-label {font-size:1.1em;margin-left:8px;}
        .top-bar select,.top-bar button {font-size:1em;border-radius:7px;border:1px solid #ccc;padding:8px 14px;margin-right:8px;}
        .top-bar button {background:#234093;color:#fff;border:none;margin:0 4px;cursor:pointer;transition:0.2s;}
        .top-bar button:hover {background:#1a2c67;}
        .api-token-bar {margin-bottom:18px;text-align:left;direction:ltr;padding:8px 12px;background:#e6eeff;border-radius:10px;display:flex;align-items:center;gap:10px;font-size:1em;}
        .api-token-bar label {font-size:1.06em;color:#234093;margin-left:8px;}
        .api-token-bar input[type="password"],.api-token-bar input[type="text"] {border:1px solid #bbb;border-radius:5px;padding:6px 10px;font-size:1em;width:240px;}
        .api-token-bar button {background:#234093;color:#fff;border:none;border-radius:6px;padding:6px 18px;font-size:1em;cursor:pointer;}
        .api-token-bar .api-token-saved {color:#388e3c;margin-right:8px;}
        .api-token-bar .api-token-warning {color:#d32f2f;margin-right:8px;}
        .admin-panel {margin:32px 0;display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:28px;}
        .admin-section {background:#f3f6fe;border:1px solid #e0e7f7;border-radius:14px;padding:24px 18px 18px 18px;box-shadow:0px 1.5px 6px #23409311;margin-bottom:24px;}
        .admin-section h3 {color:#1a2c67;margin:0 0 18px 0;font-size:1.13em;}
        .add-row-form {display:flex;gap:8px;margin-bottom:18px;align-items:center;}
        .add-row-form input[type="text"] {flex:1;font-size:1em;padding:6px 10px;border-radius:6px;border:1px solid #bbb;}
        .add-row-form button {background:#234093;color:#fff;border:none;padding:6px 14px;border-radius:6px;font-size:1em;cursor:pointer;transition:0.2s;}
        .admin-list {list-style:none;padding:0;margin:0;}
        .admin-list li {display:flex;align-items:center;justify-content:space-between;background:#fff;margin-bottom:7px;border-radius:7px;padding:7px 10px;border:1px solid #e3e6f0;}
        .admin-list .list-actions button {margin-right:5px;font-size:0.97em;padding:4px 12px;border-radius:5px;}
        .edit-btn {background:#efb400;color:#fff;}
        .edit-btn:hover {background:#b28a00;}
        .save-btn {background:#388e3c;color:#fff;}
        .delete-btn {background:#d32f2f;color:#fff;}
        .delete-btn:hover {background:#b71c1c;}
        .goal-section {background:#e5f7ef;border:1px solid #81c6ae;border-radius:14px;padding:24px 18px 18px 18px;box-shadow:0px 1.5px 6px #046a4433;margin-top:30px;}
        .goal-section h3 {color:#046a44;margin:0 0 18px 0;font-size:1.13em;}
        .goal-list {list-style:none;padding:0;margin:0;}
        .goal-list li {display:flex;align-items:center;justify-content:space-between;background:#fff;margin-bottom:7px;border-radius:7px;padding:7px 10px;border:1px solid #b2dfdb;}
        .goal-list .list-actions button {margin-right:5px;font-size:0.97em;padding:4px 12px;border-radius:5px;}
        .goal-edit-btn {background:#009688;color:#fff;}
        .goal-save-btn {background:#388e3c;color:#fff;}
        .goal-delete-btn {background:#d32f2f;color:#fff;}
        .goal-delete-btn:hover {background:#b71c1c;}
        .shops-area-box {background:#e9ebf6;border-radius:10px;padding:18px 10px 10px 10px;margin-bottom:20px;}
        .shops-area-title {font-size:1.07em;font-weight:bold;margin-bottom:5px;}
        .shop-area-tag {background:#234093;color:#fff;border-radius:18px;padding:4px 16px;display:inline-block;margin:2px 4px;}
        .shop-area-tag button {background:#c22;color:#fff;border:none;border-radius:50%;margin-right:4px;font-size:1.1em;cursor:pointer;}
        .distribution-table th,.distribution-table td {text-align:center;padding:7px 6px;}
        .distribution-table th {background:#234093;color:#fff;}
        .distribution-table td button {background:#c22;color:#fff;border:none;border-radius:4px;cursor:pointer;padding:4px 10px;}
        .section-box {background:#f4f6fa;border-radius:14px;margin-bottom:30px;box-shadow:0px 1.5px 6px #23409311;}
        .table-title,.stats-title {color:#c00;font-size:1.15em;font-weight:bold;margin:16px 0 8px 0;}
        table {width:100%;border-collapse:collapse;background:#fff;margin-bottom:10px;}
        th,td {border:1px solid #bbb;padding:12px 6px;text-align:center;vertical-align:middle;font-size:1.09em;}
        th {background:#234093;color:#fff;}
        .shop-btn {background:#e5eaff;color:#234093;border:none;border-radius:7px;padding:6px 16px;cursor:pointer;font-size:1em;transition:0.2s;}
        .shop-btn:hover {background:#b2c5fa;}
        .goals-section {background:#e5f7ef;border:1px solid #81c6ae;border-radius:14px;padding:16px 12px 10px 12px;margin-bottom:15px;}
        .goals-section h3 {color:#046a44;margin:0 0 10px 0;font-size:1.1em;}
        .goals-section ul {margin:0;padding-right:20px;}
        .goals-section li {color:#046a44;margin-bottom:4px;font-size:1.01em;}
        .stats-table {width:100%;border-collapse:collapse;border-radius:8px;background:#fff;margin-bottom:12px;overflow:hidden;}
        .stats-table th,.stats-table td {border:1px solid #234093;padding:10px 6px;text-align:center;font-size:1.05em;}
        .stats-table th {background:#234093;color:#fff;}
        .stats-table tfoot td {background:#e2e6f6;font-weight:bold;}
        .stats-total-cell {color:#c00;font-weight:bold;}
        .copyright {text-align:center;color:#234093;font-weight:bold;margin-top:20px;font-size:1.08em;}
        .modal-overlay {position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.36);display:flex;align-items:center;justify-content:center;z-index:1000;}
        .modal-content {background:#fff;padding:32px 26px 22px 26px;border-radius:18px;box-shadow:0 2px 16px #0002;min-width:260px;max-width:350px;text-align:center;}
        .modal-content button {background:#234093;color:#fff;border:none;padding:8px 22px;border-radius:8px;font-size:1em;cursor:pointer;margin-top:10px;}
        .modal-content label {font-size:1.08em;color:#234093;margin-bottom:16px;display:block;}
        .modal-content input[type="password"] {font-size:1.08em;padding:7px 12px;border:1.5px solid #ccc;border-radius:8px;margin-bottom:14px;text-align:center;}
        .modal-content .error-msg {color:#d32f2f;margin-bottom:8px;}
        @media (max-width:900px){.container{padding:14px 2px 8px 2px;}.main-title{font-size:1.22em;padding:11px 0;}.admin-panel{grid-template-columns:1fr;gap:16px;}.admin-section,.goal-section,.inspect-section,.section-box{padding:13px 4px 13px 4px;}}
    </style>
</head>
<body>
    <div class="container">
        <div class="main-title">خطة التفتيش الشهرية</div>
        <div class="top-bar">
            <div>
                <span class="user-type-label">نوع المستخدم:</span>
                <select id="userTypeSelect" onchange="handleUserTypeChange()">
                    <option value="inspector">مفتش</option>
                    <option value="developer">المطور</option>
                </select>
                <span id="inspectorSelectBox" style="display:inline-block;">
                    <label for="inspectorSelect">اسم المفتش:</label>
                    <select id="inspectorSelect" onchange="renderInspectorPage()"></select>
                </span>
                <button onclick="window.print()">طباعة أو حفظ PDF</button>
            </div>
        </div>
        <div id="apiTokenBar" class="api-token-bar" style="display:none;">
            <label for="apiTokenInput">API Token:</label>
            <input type="password" id="apiTokenInput" placeholder="أدخل التوكين هنا" autocomplete="off" />
            <button type="button" id="saveApiTokenBtn">حفظ التوكين</button>
            <span id="apiTokenSavedMsg" class="api-token-saved" style="display:none;">تم الحفظ ✓</span>
            <button type="button" id="toggleApiTokenInputBtn" style="background:#888;" title="إظهار/إخفاء">👁️</button>
        </div>
        <div id="adminPanel" style="display:none;">
            <!-- زر الحفظ اليدوي الجديد -->
            <button onclick="uploadAllDataToGitHub('حفظ يدوي لجميع البيانات')" style="background:#234093;color:#fff;margin:10px;">💾 حفظ جميع البيانات</button>
            <div class="admin-panel">
                <div class="admin-section">
                    <h3>إدارة أسماء المفتشين</h3>
                    <form class="add-row-form" id="addInspectorForm">
                        <input type="text" id="newInspector" placeholder="اسم المفتش الجديد" required />
                        <button type="submit">إضافة</button>
                    </form>
                    <ul class="admin-list" id="inspectorList"></ul>
                </div>
                <div class="admin-section">
                    <h3>إدارة أسماء المحلات</h3>
                    <form class="add-row-form" id="addShopForm">
                        <input type="text" id="newShop" placeholder="اسم المحل الجديد" required />
                        <button type="submit">إضافة</button>
                    </form>
                    <ul class="admin-list" id="shopList"></ul>
                </div>
                <div class="admin-section">
                    <h3>إدارة أسماء المناطق</h3>
                    <form class="add-row-form" id="addAreaForm">
                        <input type="text" id="newArea" placeholder="اسم المنطقة الجديدة" required />
                        <button type="submit">إضافة</button>
                    </form>
                    <ul class="admin-list" id="areaList"></ul>
                </div>
            </div>
            <div class="goal-section">
                <h3>إدارة أهداف التفتيش</h3>
                <form class="add-row-form" id="addGoalForm">
                    <input type="text" id="newGoal" placeholder="هدف جديد..." required />
                    <button type="submit">إضافة</button>
                </form>
                <ul class="goal-list" id="goalList"></ul>
            </div>
            <div class="admin-section shops-area-box">
                <div class="shops-area-title">إدارة المحلات حسب المنطقة:</div>
                <div id="shopsByAreaList"></div>
                <form class="add-row-form" id="addShopByAreaForm" style="margin-top:8px;">
                    <input type="text" id="newShopByArea" placeholder="اسم محل جديد" required />
                    <select id="areaForShop"></select>
                    <button type="submit">إضافة محل</button>
                </form>
            </div>
            <div class="admin-section shops-area-box">
                <div class="shops-area-title">توزيع المحلات على المفتشين والأيام:</div>
                <table class="distribution-table" style="width:100%;margin-bottom:10px;">
                    <thead>
                        <tr>
                            <th>المفتش</th>
                            <th>اليوم</th>
                            <th>المنطقة</th>
                            <th>المحل</th>
                            <th>حذف</th>
                        </tr>
                    </thead>
                    <tbody id="distributionTableBody"></tbody>
                </table>
                <button onclick="addDistributionRow()" style="margin-bottom: 8px;">إضافة صف</button>
                <button onclick="autoDistributeShops()" style="background:#234093;color:#fff;">توزيع تلقائي</button>
                <br>
                <button onclick="saveDistributionToFile()" style="background:#223;color:#fff;font-size:1.1em;padding:9px 18px;margin-top:12px;">حفظ الخطة (تحميل ملف)</button>
            </div>
        </div>
        <div id="inspectorPage">
            <div class="section-box">
                <div class="table-title">جدول التفتيش</div>
                <table id="inspectionTable">
                    <thead>
                        <tr>
                            <th>اليوم</th>
                            <th>وقت المناوبة</th>
                            <th>المنطقة</th>
                            <th>المحلات</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="section-box">
                <div class="stats-title">احصائيات التفتيش</div>
                <table class="stats-table" id="inspectorStatsTable">
                    <thead>
                        <tr>
                            <th>عدد التفتيشات (كل الشهر)</th>
                            <th>عدد التفتيشات الصباحية</th>
                            <th>عدد التفتيشات المسائية</th>
                            <th>عدد التفتيشات في العطلة (جمعة/سبت/أحد)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="goals-section">
                <h3>أهداف التفتيش هذا الشهر:</h3>
                <ul id="goalsList"></ul>
            </div>
            <div class="copyright">
                جميع الحقوق محفوظة &copy; المطور د. علي عبدالعال
            </div>
        </div>
    </div>
    <div id="shopsModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h4>قائمة المحلات</h4>
            <ul id="shopsList"></ul>
            <button onclick="closeShopsModal()">إغلاق</button>
        </div>
    </div>
    <div id="modalPassword" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <label>من فضلك أدخل الرقم السري للمطور:</label>
            <input type="password" id="passwordInput" maxlength="10" autocomplete="off" />
            <div class="error-msg" id="passwordError" style="display:none;">الرقم السري غير صحيح!</div>
            <button onclick="checkPassword()">دخول</button>
        </div>
    </div>
    <script>
        // إعدادات التوكين
        function showApiTokenBar(show) {document.getElementById('apiTokenBar').style.display = show ? '' : 'none';}
        function getApiToken() {return localStorage.getItem('api_token') || '';}
        function setApiToken(token) {if(token) localStorage.setItem('api_token', token);}
        function handleDeveloperApiTokenBar() {
            showApiTokenBar(true);
            const apiTokenInput = document.getElementById('apiTokenInput');
            const savedToken = getApiToken();
            if(savedToken){
                apiTokenInput.value = savedToken;
                apiTokenInput.type = "password";
                document.getElementById('apiTokenSavedMsg').style.display = '';
            } else {
                apiTokenInput.value = '';
                document.getElementById('apiTokenSavedMsg').style.display = 'none';
            }
        }
        document.addEventListener('DOMContentLoaded', function(){
            document.getElementById('saveApiTokenBtn').onclick = function(){
                const val = document.getElementById('apiTokenInput').value.trim();
                if(val){
                    setApiToken(val);
                    document.getElementById('apiTokenSavedMsg').style.display = '';
                }
            };
            document.getElementById('toggleApiTokenInputBtn').onclick = function(){
                const inp = document.getElementById('apiTokenInput');
                inp.type = (inp.type === "password") ? "text" : "password";
            };
        });

        // البيانات
        let inspectors = [], shops = [], areas = [], goals = [];
        let shopsByArea = {}, distributionRows = [], inspectionData = [];
        const DATA_FILE = "data.json";

        // تحميل البيانات من GitHub عند فتح الموقع
        async function loadAllDataFromGitHub() {
            const repo = "aliabdelaal-adm/Monthly_inspection_plan";
            const branch = "main";
            const path = encodeURIComponent(DATA_FILE);
            try {
                // تعطيل الكاش بإضافة متغير عشوائي
                const res = await fetch(`https://raw.githubusercontent.com/${repo}/${branch}/${path}?t=${Date.now()}`);
                if (res.ok) {
                    const allData = await res.json();
                    inspectors = allData.inspectors || [];
                    shops = allData.shops || [];
                    areas = allData.areas || [];
                    goals = allData.goals || [];
                    shopsByArea = allData.shopsByArea || {};
                    distributionRows = allData.distributionRows || [];
                    inspectionData = allData.inspectionData || [];
                } else {
                    setDefaultData();
                }
            } catch (e) {
                setDefaultData();
            }
            updateInspectorList(); updateShopList(); updateAreaList(); renderGoalList();
            renderShopsByArea(); renderDistributionTable(); fillInspectorsSelect(); renderInspectorPage();
        }
        function setDefaultData() {
            inspectors = ["هاجر","آمنه","آيه","د. فايز المسالمة","د.آمنه بن صرم"];
            shops = ["محل 1", "محل 2", "محل 3", "محل 4","محل 5", "محل 6", "محل 7", "محل 8","محل 9", "محل 10", "محل 11"];
            areas = ["المصفح", "مدينة خليفة", "المنطقة أ", "المنطقة ب", "المنطقة ج", "المنطقة د"];
            goals = ["ضمان سلامة المنتجات","الالتزام بالاشتراطات الصحية"];
            shopsByArea = {};
            inspectionData = [];
            distributionRows = [];
        }
        async function uploadAllDataToGitHub(msg) {
            const allData = {inspectors, shops, areas, goals, shopsByArea, distributionRows, inspectionData};
            const json = JSON.stringify(allData, null, 2);
            await uploadToGitHubFile(json, DATA_FILE, msg || "تحديث جميع بيانات خطة التفتيش");
        }
        // ============== دالة رفع مع معالجة تعارض sha بشكل متكرر ==============
        async function uploadToGitHubFile(fileContent, fileName, commitMsg, retryCount = 0) {
            const repo = "aliabdelaal-adm/Monthly_inspection_plan";
            const branch = "main";
            const path = encodeURIComponent(fileName);
            const apiToken = getApiToken();
            if (!apiToken) {
                alert("يرجى إدخال وحفظ التوكين الخاص بك أولاً.");
                return;
            }
            // دائماً جلب sha الأحدث قبل كل محاولة رفع
            let fileSha = null;
            try {
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`, {
                    headers: { Authorization: "token " + apiToken }
                });
                if (getRes.ok) {
                    const getData = await getRes.json();
                    fileSha = getData.sha;
                }
            } catch {}
            const payload = {
                message: commitMsg || "تحديث تلقائي",
                content: btoa(unescape(encodeURIComponent(fileContent))),
                branch: branch
            };
            if (fileSha) payload.sha = fileSha;
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                method: "PUT",
                headers: {
                    "Authorization": "token " + apiToken,
                    "Accept": "application/vnd.github+json"
                },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                const err = await res.json();
                // معالجة مشكلة sha conflict تلقائياً حتى 2 إعادة فقط
                if (
                    err.message &&
                    err.message.includes("does not match") &&
                    retryCount < 2
                ) {
                    // انتظر نصف ثانية ثم أعد المحاولة (لحل تضارب الرفع المتزامن)
                    await new Promise(r=>setTimeout(r, 500));
                    return uploadToGitHubFile(fileContent, fileName, commitMsg, retryCount + 1);
                } else {
                    alert("فشل الرفع! " + (err.message || res.statusText));
                }
            } else {
                // رسالة نجاح الحفظ
                document.getElementById('apiTokenSavedMsg').textContent = 'تم حفظ ورفع البيانات ✓';
                document.getElementById('apiTokenSavedMsg').style.display = '';
                setTimeout(()=>{document.getElementById('apiTokenSavedMsg').style.display='none';}, 2000);
            }
        }

        // جميع الدوال البرمجية مع رفع تلقائي
        function renderList(list, arr, itemKey, editFunc, saveFunc, deleteFunc) {
            list.innerHTML = "";
            arr.forEach((name, idx) => {
                let li = document.createElement("li");
                li.id = `${itemKey}-item-${idx}`;
                li.innerHTML = `
                    <span class="${itemKey}-name">${name}</span>
                    <span class="list-actions">
                        <button class="edit-btn" onclick="${editFunc}(${idx})">تعديل</button>
                        <button class="delete-btn" onclick="${deleteFunc}(${idx})">حذف</button>
                    </span>
                `;
                list.appendChild(li);
            });
        }
        function updateInspectorList() {
            const list = document.getElementById('inspectorList');
            renderList(list, inspectors, 'inspector', 'startEditInspector', 'saveEditInspector', 'deleteInspector');
            fillInspectorsSelect();
        }
        function addInspector(e) {
            e.preventDefault();
            const val = document.getElementById('newInspector').value.trim();
            if(val && !inspectors.includes(val)) {
                inspectors.push(val);
                updateInspectorList();
                fillInspectorsSelect();
                uploadAllDataToGitHub("إضافة مفتش");
            }
            document.getElementById('newInspector').value = '';
        }
        function startEditInspector(idx) {
            const item = document.getElementById(`inspector-item-${idx}`);
            item.innerHTML = `
                <input type="text" id="editInspectorInput${idx}" value="${inspectors[idx]}" style="flex:1;padding:4px 8px;border-radius:5px;border:1px solid #bbb;">
                <span class="list-actions">
                    <button class="save-btn" onclick="saveEditInspector(${idx})">حفظ</button>
                    <button class="delete-btn" onclick="deleteInspector(${idx})">حذف</button>
                </span>
            `;
            document.getElementById(`editInspectorInput${idx}`).focus();
        }
        function saveEditInspector(idx) {
            const val = document.getElementById(`editInspectorInput${idx}`).value.trim();
            if(val && !inspectors.includes(val)) {
                inspectors[idx] = val;
                updateInspectorList();
                fillInspectorsSelect();
                uploadAllDataToGitHub("تعديل اسم مفتش");
            }
        }
        function deleteInspector(idx) {
            if(confirm("هل تريد حذف هذا المفتش؟")) {
                inspectors.splice(idx,1);
                updateInspectorList();
                fillInspectorsSelect();
                uploadAllDataToGitHub("حذف مفتش");
            }
        }
        function updateShopList() {
            const list = document.getElementById('shopList');
            renderList(list, shops, 'shop', 'startEditShop', 'saveEditShop', 'deleteShop');
        }
        function addShop(e) {
            e.preventDefault();
            const val = document.getElementById('newShop').value.trim();
            if(val && !shops.includes(val)) {
                shops.push(val);
                updateShopList();
                uploadAllDataToGitHub("إضافة محل");
            }
            document.getElementById('newShop').value = '';
        }
        function startEditShop(idx) {
            const item = document.getElementById(`shop-item-${idx}`);
            item.innerHTML = `
                <input type="text" id="editShopInput${idx}" value="${shops[idx]}" style="flex:1;padding:4px 8px;border-radius:5px;border:1px solid #bbb;">
                <span class="list-actions">
                    <button class="save-btn" onclick="saveEditShop(${idx})">حفظ</button>
                    <button class="delete-btn" onclick="deleteShop(${idx})">حذف</button>
                </span>
            `;
            document.getElementById(`editShopInput${idx}`).focus();
        }
        function saveEditShop(idx) {
            const val = document.getElementById(`editShopInput${idx}`).value.trim();
            if(val && !shops.includes(val)) {
                shops[idx] = val;
                updateShopList();
                uploadAllDataToGitHub("تعديل اسم محل");
            }
        }
        function deleteShop(idx) {
            if(confirm("هل تريد حذف هذا المحل؟")) {
                shops.splice(idx,1);
                updateShopList();
                uploadAllDataToGitHub("حذف محل");
            }
        }
        function updateAreaList() {
            const list = document.getElementById('areaList');
            renderList(list, areas, 'area', 'startEditArea', 'saveEditArea', 'deleteArea');
        }
        function addArea(e) {
            e.preventDefault();
            const val = document.getElementById('newArea').value.trim();
            if(val && !areas.includes(val)) {
                areas.push(val);
                updateAreaList();
                uploadAllDataToGitHub("إضافة منطقة");
            }
            document.getElementById('newArea').value = '';
        }
        function startEditArea(idx) {
            const item = document.getElementById(`area-item-${idx}`);
            item.innerHTML = `
                <input type="text" id="editAreaInput${idx}" value="${areas[idx]}" style="flex:1;padding:4px 8px;border-radius:5px;border:1px solid #bbb;">
                <span class="list-actions">
                    <button class="save-btn" onclick="saveEditArea(${idx})">حفظ</button>
                    <button class="delete-btn" onclick="deleteArea(${idx})">حذف</button>
                </span>
            `;
            document.getElementById(`editAreaInput${idx}`).focus();
        }
        function saveEditArea(idx) {
            const val = document.getElementById(`editAreaInput${idx}`).value.trim();
            if(val && !areas.includes(val)) {
                areas[idx] = val;
                updateAreaList();
                uploadAllDataToGitHub("تعديل اسم منطقة");
            }
        }
        function deleteArea(idx) {
            if(confirm("هل تريد حذف هذه المنطقة؟")) {
                areas.splice(idx,1);
                updateAreaList();
                uploadAllDataToGitHub("حذف منطقة");
            }
        }
        function renderGoalList() {
            const list = document.getElementById('goalList');
            list.innerHTML = "";
            goals.forEach((name, idx) => {
                let li = document.createElement("li");
                li.id = `goal-item-${idx}`;
                li.innerHTML = `
                    <span class="goal-name">${name}</span>
                    <span class="list-actions">
                        <button class="goal-edit-btn" onclick="startEditGoal(${idx})">تعديل</button>
                        <button class="goal-delete-btn" onclick="deleteGoal(${idx})">حذف</button>
                    </span>
                `;
                list.appendChild(li);
            });
        }
        function addGoal(e) {
            e.preventDefault();
            const val = document.getElementById('newGoal').value.trim();
            if(val && !goals.includes(val)) {
                goals.push(val);
                renderGoalList();
                uploadAllDataToGitHub("إضافة هدف");
            }
            document.getElementById('newGoal').value = '';
        }
        function startEditGoal(idx) {
            const item = document.getElementById(`goal-item-${idx}`);
            item.innerHTML = `
                <input type="text" id="editGoalInput${idx}" value="${goals[idx]}" style="flex:1;padding:4px 8px;border-radius:5px;border:1px solid #bbb;">
                <span class="list-actions">
                    <button class="goal-save-btn" onclick="saveEditGoal(${idx})">حفظ</button>
                    <button class="goal-delete-btn" onclick="deleteGoal(${idx})">حذف</button>
                </span>
            `;
            document.getElementById(`editGoalInput${idx}`).focus();
        }
        function saveEditGoal(idx) {
            const val = document.getElementById(`editGoalInput${idx}`).value.trim();
            if(val && !goals.includes(val)) {
                goals[idx] = val;
                renderGoalList();
                uploadAllDataToGitHub("تعديل هدف");
            }
        }
        function deleteGoal(idx) {
            if(confirm("هل تريد حذف هذا الهدف؟")) {
                goals.splice(idx,1);
                renderGoalList();
                uploadAllDataToGitHub("حذف هدف");
            }
        }
        function fillShopsByAreaDefault() {
            if (Object.keys(shopsByArea).length === 0) {
                let ai = 0;
                shops.forEach(shop => {
                    let area = areas[ai % areas.length];
                    if (!shopsByArea[area]) shopsByArea[area] = [];
                    shopsByArea[area].push(shop);
                    ai++;
                });
            }
        }
        function renderShopsByArea() {
            fillShopsByAreaDefault();
            const container = document.getElementById('shopsByAreaList');
            container.innerHTML = '';
            for(let area of areas){
                const shopsList = shopsByArea[area] || [];
                let html = `<div style="margin-bottom:5px;"><b>${area}:</b> `;
                shopsList.forEach((shop,idx)=>{
                    html += `<span class="shop-area-tag">
                                ${shop}
                                <button onclick="deleteShopFromArea('${area}',${idx})">&times;</button>
                             </span>`;
                });
                html += '</div>';
                container.innerHTML += html;
            }
            const sel = document.getElementById('areaForShop');
            sel.innerHTML = '';
            areas.forEach(area=>{
                const opt = document.createElement('option');
                opt.value = area;
                opt.textContent = area;
                sel.appendChild(opt);
            });
        }
        function addShopByArea(e) {
            e.preventDefault();
            const shopName = document.getElementById('newShopByArea').value.trim();
            const area = document.getElementById('areaForShop').value;
            if(shopName && area){
                if(!shopsByArea[area]) shopsByArea[area] = [];
                if(!shopsByArea[area].includes(shopName)){
                    shopsByArea[area].push(shopName);
                    if (!shops.includes(shopName)) shops.push(shopName);
                    renderShopsByArea();
                    updateShopList();
                    uploadAllDataToGitHub("إضافة محل لمنطقة");
                }
            }
            document.getElementById('newShopByArea').value = '';
        }
        function deleteShopFromArea(area, idx) {
            if(confirm("حذف هذا المحل من المنطقة؟")){
                const shopName = shopsByArea[area][idx];
                shopsByArea[area].splice(idx,1);
                renderShopsByArea();
                let used = false;
                for (let a in shopsByArea)
                    if (shopsByArea[a].includes(shopName)) used = true;
                if (!used) {
                    const i = shops.indexOf(shopName);
                    if (i > -1) shops.splice(i,1);
                    updateShopList();
                }
                uploadAllDataToGitHub("حذف محل من منطقة");
            }
        }
        let weekendDays = [5, 6, 0];
        function renderDistributionTable() {
            const tbody = document.getElementById('distributionTableBody');
            tbody.innerHTML = '';
            distributionRows.forEach((row, idx) => {
                let inspectorSelect = `<select onchange="distributionRows[${idx}].inspector=this.value; renderDistributionTable(); uploadAllDataToGitHub('تعديل توزيع')">
                    <option value=""></option>
                    ${inspectors.map(inspector =>
                        `<option value="${inspector}" ${row.inspector===inspector?'selected':''}>${inspector}</option>`
                    ).join('')}
                </select>`;
                let areaSelect = `<select onchange="distributionRows[${idx}].area=this.value; distributionRows[${idx}].shop=[]; renderDistributionTable(); uploadAllDataToGitHub('تعديل توزيع')">
                    <option value=""></option>
                    ${areas.map(area =>
                        `<option value="${area}" ${row.area===area?'selected':''}>${area}</option>`
                    ).join('')}
                </select>`;
                let areaShops = (shopsByArea[row.area] || []);
                let shopSelect = `<select multiple size="3" onchange="handleShopMultiSelect(this,${idx})" style="width:100%;">
                    ${areaShops.map(shop =>
                        `<option value="${shop}" ${row.shop && row.shop.includes(shop)?'selected':''}>${shop}</option>`
                    ).join('')}
                </select>`;
                tbody.innerHTML += `
                    <tr>
                        <td>${inspectorSelect}</td>
                        <td><input type="date" value="${row.day||''}" onchange="distributionRows[${idx}].day=this.value; uploadAllDataToGitHub('تعديل توزيع')"></td>
                        <td>${areaSelect}</td>
                        <td>${shopSelect}</td>
                        <td><button onclick="deleteDistributionRow(${idx})">حذف</button></td>
                    </tr>
                `;
            });
        }
        function handleShopMultiSelect(sel, idx) {
            const selected = Array.from(sel.selectedOptions).map(opt=>opt.value);
            distributionRows[idx].shop = selected;
            uploadAllDataToGitHub("تعديل توزيع");
        }
        function addDistributionRow() {
            distributionRows.push({inspector:'', day:'', area:'', shop:[]});
            renderDistributionTable();
            uploadAllDataToGitHub("إضافة توزيع جديد");
        }
        function deleteDistributionRow(idx) {
            distributionRows.splice(idx,1);
            renderDistributionTable();
            uploadAllDataToGitHub("حذف توزيع");
        }
        function autoDistributeShops() {
            distributionRows = [];
            let allShops = [];
            for(let area in shopsByArea){
                shopsByArea[area].forEach(shop=>{
                    allShops.push({area, shop});
                });
            }
            let allInspectors = inspectors.slice();
            if(allInspectors.length === 0 || allShops.length === 0) return alert("يجب إضافة مفتشين ومحلات أولاً");
            let numDays = 7;
            let today = new Date();
            for(let dayIdx=0; dayIdx<numDays; dayIdx++) {
                let dateStr = new Date(today.getFullYear(), today.getMonth(), today.getDate()+dayIdx).toISOString().slice(0,10);
                for(let i=0; i<allShops.length; i++) {
                    let inspector = allInspectors[(i+dayIdx)%allInspectors.length];
                    distributionRows.push({
                        inspector,
                        day: dateStr,
                        area: allShops[i].area,
                        shop: [allShops[i].shop],
                    });
                }
            }
            renderDistributionTable();
            uploadAllDataToGitHub("توزيع تلقائي للمحلات");
        }
        function saveDistributionToFile() {
            let csv = "المفتش,اليوم,المنطقة,المحلات\n";
            distributionRows.forEach(row=>{
                csv += `${row.inspector},${row.day},${row.area},"${(row.shop||[]).join(' - ')}"\n`;
            });
            let blob = new Blob([csv], {type:"text/csv"});
            let a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "جدول_توزيع_المحلات.csv";
            a.click();
        }
        function fillInspectorsSelect() {
            const sel = document.getElementById('inspectorSelect');
            sel.innerHTML = "";
            inspectors.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                sel.appendChild(opt);
            });
        }
        function renderInspectionTable(inspector) {
            const tbody = document.getElementById('inspectionTable').querySelector('tbody');
            tbody.innerHTML = "";
            const rows = inspectionData.filter(item => item.inspector === inspector);
            if(rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4">لا توجد مهام تفتيش لهذا المفتش.</td></tr>`;
                return;
            }
            rows.forEach((row, idx) => {
                const tr = document.createElement('tr');
                const shopsList = row.shops.join('\n');
                tr.innerHTML = `
                    <td>${row.day}</td>
                    <td>${row.shift}</td>
                    <td>${row.area}</td>
                    <td>
                        <div class="shops-list-print">${shopsList}</div>
                    </td>
                `;
                const shopBtn = document.createElement('button');
                shopBtn.className = 'shop-btn';
                shopBtn.textContent = 'عرض المحلات';
                shopBtn.onclick = () => showShopsModal(row.shops);
                tr.cells[3].appendChild(shopBtn);
                tbody.appendChild(tr);
            });
        }
        function showShopsModal(shopsArr) {
            const modal = document.getElementById('shopsModal');
            const list = document.getElementById('shopsList');
            list.innerHTML = "";
            shopsArr.forEach(shop => {
                const li = document.createElement('li');
                li.textContent = shop;
                list.appendChild(li);
            });
            modal.style.display = '';
        }
        function closeShopsModal() {
            document.getElementById('shopsModal').style.display = 'none';
        }
        function renderGoals() {
            const ul = document.getElementById('goalsList');
            ul.innerHTML = "";
            goals.forEach(goal => {
                const li = document.createElement('li');
                li.textContent = goal;
                ul.appendChild(li);
            });
        }
        function renderInspectorStats(inspector) {
            const rows = inspectionData.filter(item => item.inspector === inspector);
            let total = rows.length;
            let morning = rows.filter(r => r.shift === "صباحية").length;
            let evening = rows.filter(r => r.shift === "مسائية").length;
            let weekend = rows.filter(r => {
                const dayOfWeek = new Date(r.day).getDay();
                return weekendDays.includes(dayOfWeek);
            }).length;
            const tbody = document.getElementById('inspectorStatsTable').querySelector('tbody');
            tbody.innerHTML = `
                <tr>
                    <td>${total}</td>
                    <td>${morning}</td>
                    <td>${evening}</td>
                    <td>${weekend}</td>
                </tr>
            `;
        }
        function renderInspectorPage() {
            const inspector = document.getElementById('inspectorSelect').value;
            if (inspector) {
                renderInspectionTable(inspector);
                renderInspectorStats(inspector);
                renderGoals();
            }
        }
        function showPasswordModal() {
            document.getElementById('modalPassword').style.display = '';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
            setTimeout(()=>document.getElementById('passwordInput').focus(), 200);
        }
        function checkPassword() {
            const val = document.getElementById('passwordInput').value;
            if(val === "1983") {
                document.getElementById('modalPassword').style.display = 'none';
                document.getElementById('adminPanel').style.display = '';
                document.getElementById('inspectorPage').style.display = 'none';
                updateInspectorList();
                updateShopList();
                updateAreaList();
                renderGoalList();
                renderShopsByArea();
                renderDistributionTable();
                handleDeveloperApiTokenBar();
            } else {
                document.getElementById('passwordError').style.display = '';
            }
        }
        function handleUserTypeChange() {
            const type = document.getElementById('userTypeSelect').value;
            const inspectorSelectBox = document.getElementById('inspectorSelectBox');
            if(type === 'developer') {
                showPasswordModal();
                inspectorSelectBox.style.display = 'none';
            } else {
                document.getElementById('adminPanel').style.display = 'none';
                document.getElementById('modalPassword').style.display = 'none';
                document.getElementById('inspectorPage').style.display = '';
                inspectorSelectBox.style.display = 'inline-block';
                fillInspectorsSelect();
                renderInspectorPage();
                showApiTokenBar(false);
            }
        }
        document.getElementById('addInspectorForm').onsubmit = addInspector;
        document.getElementById('addShopForm').onsubmit = addShop;
        document.getElementById('addAreaForm').onsubmit = addArea;
        document.getElementById('addGoalForm').onsubmit = addGoal;
        document.getElementById('addShopByAreaForm').onsubmit = addShopByArea;
        document.addEventListener('DOMContentLoaded', ()=>{ loadAllDataFromGitHub(); });
        document.getElementById('passwordInput').addEventListener('keydown', function(e){
            if(e.key === "Enter") checkPassword();
        });
    </script>
</body>
</html>
