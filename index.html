<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>خطة التفتيش الشهرية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Prevention Meta Tags - Hide from Search Engines -->
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex, notranslate">
    <meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="bingbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="yandexbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="slurp" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta name="twitter:card" content="">
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">
    
    <!-- Prevent audio caching and indexing -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="referrer" content="no-referrer">
    <!-- مكتبات التصدير -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Cairo', Arial, sans-serif; background: #f7f9fc; margin:0;}
        .main-container {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 2px 16px #dadce0;
            padding: 36px 18px 24px 18px;
            max-width: 900px;
            min-width:320px;
            margin: 64px auto 0 auto;
            display: flex; flex-direction: column; align-items: center;
        }
        .header-top-bar {
            width:100%;
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom: 8px;
            position: relative;
        }
        .last-update-row {
            color: #666;
            font-size: 0.97em;
            margin-right: 8px;
            margin-top: 0;
            text-align: right;
            direction: ltr;
        }
        .click-container {
            margin-left:8px;
            margin-top:0;
        }
        .click-btn {
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
            padding: 0;
        }
        .click-icon {
            width: 38px;
            height: 38px;
            fill: #2196F3;
            transition: fill 0.2s, transform 0.2s;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }
        .click-btn:hover .click-icon {
            fill: #1976D2;
            transform: scale(1.1);
        }
        .click-btn:active .click-icon {
            transform: scale(0.95);
        }
        
        @keyframes clickPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .horizontal-line {
            width: 100%;
            border: none;
            border-top: 1.5px solid #e0e3ea;
            margin: 16px 0 0 0;
        }
        .title-bar {
            width:100%;
            display:flex;
            justify-content:center;
            align-items:center;
            margin-top: 18px;
            margin-bottom: 24px;
        }
        .main-title-box {
            background:#234085;
            color:#fff;
            padding:28px 0 28px 0;
            border-radius:14px;
            width: 96%;
            max-width: 600px;
            min-height: 56px;
            font-size:2.12em;
            text-align:center;
            font-weight: bold;
            letter-spacing: 1px;
            margin:0 auto;
            box-shadow:0 2px 14px #e0e2f5;
        }
        .login-section, .inspector-select-section {margin: 10px 0 18px 0; width: 100%; display:flex;justify-content:center;align-items:center;gap:10px;}
        select, input[type="text"], input[type="date"], input[type="password"] {padding:7px 16px;font-size:1em;border-radius:6px;border:1px solid #b6b6b6;min-width:130px;max-width:210px;}
        .actions-row {width:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:12px;margin:20px 0 18px;}
        .actions-line {display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap;}
        .actions-line button {padding:10px 28px;border-radius:8px;border:none;cursor:pointer;font-size:1em;}
        .pdf-btn {background:#d63384;color:#fff;}
        .excel-btn {background:#198754;color:#fff;}
        .inspector-report-btn {background:#234085;color:#fff;}
        .monthly-report-btn {background:#ff9800;color:#fff;}
        .plan-table-container {width:100%;margin:18px 0;}
        .plan-table {width:100%;border-collapse:collapse;border-radius:13px;overflow:hidden;box-shadow:0 2px 14px #eee;}
        .plan-table th,.plan-table td {padding:10px 8px;text-align:center;}
        .plan-table th {
            background:#234085;
            color:#fff;
            font-weight:bold;
            font-size:1.12em;
        }
        .plan-table tr:nth-child(even) {background:#f5f7fb;}
        .plan-table td {
            border-bottom:1px solid #d7dcef;
            font-size:1em;
        }
        .dropdown-shops-btn {
            background:#234085;
            color:#fff;
            border:none;
            border-radius:6px;
            padding:6px 18px;
            cursor:pointer;
            font-size:0.98em;
            min-width:90px;
        }
        .shops-dropdown-list {
            display:none;
            position:fixed;
            background:#fff;
            border:1px solid #23408577;
            border-radius:9px;
            margin-top:5px;
            min-width:130px;
            max-height:210px;
            box-shadow:0 2px 14px #eaeaea;
            z-index:1000;
            right:unset;
            left:unset;
            text-align:right;
            overflow-y:auto;
        }
        .shops-dropdown-list ul {
            list-style: none;
            margin:0; padding:7px 5px;
        }
        .shops-dropdown-list ul li {
            padding:3px 0 3px 0;
            border-bottom:1px solid #eee;
            font-size:0.97em;
        }
        .shops-dropdown-list ul li:last-child {border-bottom:none;}
        .shops-dropdown-wrap {position:relative; display:inline-block;}
        .inspector-report-div {margin:16px 0 0 0;background:#f7f9fc;border-radius:10px;padding:18px 12px;width:100%;color:#234085;font-size:1.1em;box-shadow:0 1px 5px #e2e2e2;}
        .modal-overlay {
            display:none; position:fixed;z-index:9999;right:0;left:0;top:0;bottom:0; background:rgba(0,0,0,0.18);align-items:center;justify-content:center;
        }
        .modal-content {
            background:#fff; border-radius:16px; box-shadow:0 2px 16px #23409333;
            padding:32px 18px; margin:50px auto; max-width:95vw; min-width:70vw; position:relative; text-align:center;
        }
        .modal-content button.close-btn {
            position:absolute; left:10px; top:10px; border:none; background:#d32f2f; color:#fff; border-radius:50%; font-size:1.4em;width:38px;height:38px;cursor:pointer;
        }
        .modal-actions {
            margin: 16px 0 0 0;
            display:flex;
            justify-content:center;
            gap:10px;
        }
        .stats-title {color:#134093;font-size:1.18em;text-align:center;margin-bottom:15px;}
        .stats-table {width:100%;border-collapse:collapse;margin-bottom:0;font-size:1.04em;}
        .stats-table th, .stats-table td {border:1px solid #234093;padding:10px 6px;text-align:center;}
        .stats-table th {background:#234093;color:#fff;}
        .stats-table tr:nth-child(even) {background:#f3f5fa;}
        .footer {text-align:center;margin-top:22px;color:#234085;font-size:0.85em;}
        .red-total {
            color: #d32f2f !important;
            font-weight: bold !important;
            background: #fffbe9;
        }
        .pdf-title-arabic {
            font-size: 1.18em;
            text-align: center;
            color: #234085;
            font-weight: bold;
            margin-bottom: 10px;
            width: 100%;
            margin-top: 0;
        }
        .edit-btn, .delete-btn {
            background: #6c757d; color: #fff; border: none; border-radius: 5px; padding: 6px 12px; margin: 2px; cursor: pointer; font-size: 0.95em;
        }
        .edit-btn:hover { background: #495057; }
        .delete-btn { background: #d32f2f; }
        .delete-btn:hover { background: #b71c1c; }
        .dev-section {background:#e9ecef;border-radius:8px;padding:16px 11px;margin:14px 0 14px 0;}
        .dev-section .close-btn {background:#d32f2f;color:#fff;border:none;border-radius:5px;padding:0 13px;font-size:1.1em;cursor:pointer;float:left;}
        #devPasswordForm {margin-bottom:6px;}
        @media (max-width:600px) {
            .main-container {
                padding:10px 2vw 7px 2vw;
                margin: 20px auto 0 auto;
                border-radius: 12px;
                max-width: 100%;
                min-width: unset;
            }
            .main-title-box {
                font-size:1.2em;
                padding:18px 8px;
                margin-bottom: 16px;
            }
            .login-section, .inspector-select-section {
                flex-direction: column;
                gap: 8px;
                margin: 15px 0;
            }
            .login-section label, .inspector-select-section label {
                font-size: 0.95em;
                margin-bottom: 4px;
            }
            select, input[type="text"], input[type="date"], input[type="password"] {
                padding: 8px 12px;
                font-size: 0.95em;
                min-width: 200px;
                max-width: 280px;
                width: 100%;
                box-sizing: border-box;
            }
            .actions-row {
                flex-direction: column;
                gap: 12px;
                margin: 15px 0;
            }
            .actions-line {
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }
            .actions-line button {
                padding: 12px 16px;
                font-size: 0.95em;
                width: 100%;
                box-sizing: border-box;
            }
            .plan-table th, .plan-table td {
                padding:6px 4px;
                font-size:0.85em;
            }
            .dropdown-shops-btn {
                padding:6px 10px;
                font-size:0.85em;
                min-width: 80px;
            }
            .modal-content {
                padding:15px 3vw;
                min-width:unset;
                max-width:95vw;
                margin: 20px auto;
            }
            .stats-table th, .stats-table td {
                padding:6px 3px;
                font-size: 0.85em;
            }
            .edit-btn, .delete-btn {
                padding: 4px 8px;
                margin: 1px;
                font-size: 0.8em;
            }
            .click-icon {
                width: 32px;
                height: 32px;
            }
            .last-update-row {
                font-size: 0.85em;
                margin-right: 4px;
            }
            .footer {
                font-size: 0.8em;
                margin-top: 16px;
            }
        }
        @media (max-width:400px) {
            .main-container {
                padding: 8px 1vw 5px 1vw;
                margin: 10px auto 0 auto;
                border-radius: 8px;
            }
            .main-title-box {
                font-size: 1.1em;
                padding: 14px 6px;
                margin-bottom: 12px;
            }
            .login-section, .inspector-select-section {
                margin: 10px 0;
            }
            select, input[type="text"], input[type="date"], input[type="password"] {
                padding: 6px 10px;
                font-size: 0.9em;
                min-width: 180px;
                max-width: 100%;
            }
            .actions-line button {
                padding: 10px 12px;
                font-size: 0.9em;
            }
            .plan-table th, .plan-table td {
                padding: 4px 2px;
                font-size: 0.8em;
            }
            .dropdown-shops-btn {
                padding: 4px 8px;
                font-size: 0.8em;
            }
            .modal-content {
                padding: 12px 2vw;
                max-width: 98vw;
            }
            .edit-btn, .delete-btn {
                padding: 3px 6px;
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
<div class="main-container">
    <div class="header-top-bar">
        <div class="click-container">
            <button class="click-btn" id="clickBtn" title="صوت النقر">
                <svg class="click-icon" id="clickIcon" viewBox="0 0 24 24">
                  <defs>
                    <linearGradient id="clickGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:1" />
                      <stop offset="50%" style="stop-color:#2196F3;stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#FF9800;stop-opacity:1" />
                    </linearGradient>
                  </defs>
                  <!-- Pointer cursor -->
                  <path d="M9.6 2.4c-.9-.8-2.4-.8-3.3.1l-.4.4c-.8.9-.8 2.4.1 3.3l6.8 6.8c.2.2.5.2.7 0s.2-.5 0-.7L6.7 5.5c-.4-.4-.4-1 0-1.4s1-.4 1.4 0l9.2 9.2c.4.4 1 .4 1.4 0s.4-1 0-1.4L9.6 2.4z" fill="url(#clickGradient)" stroke="#333" stroke-width="0.5"/>
                  <!-- Click circles -->
                  <circle cx="18" cy="6" r="2" fill="url(#clickGradient)" opacity="0.8"/>
                  <circle cx="20" cy="8" r="1.5" fill="url(#clickGradient)" opacity="0.6"/>
                  <circle cx="19" cy="10" r="1" fill="url(#clickGradient)" opacity="0.4"/>
                </svg>
            </button>
 copilot/fix-33a37f1e-1cfe-41c4-ba0a-de1a7cbc931d
        </div>
        <div class="last-update-row" id="lastUpdateRow"></div>
    </div>
    <!-- Click sound will be generated using Web Audio API -->
    </div>
    <hr class="horizontal-line">
    <div class="title-bar">
        <div class="main-title-box">خطة التفتيش الشهرية</div>
    </div>
    <div class="login-section">
        <label for="loginRole">تسجيل الدخول:</label>
        <select id="loginRole">
            <option value="">-- اختر --</option>
            <option value="inspector">مفتش</option>
            <option value="developer">المطور</option>
        </select>
        <input type="password" id="devPassword" placeholder="كلمة سر المطور" style="display:none;">
        <button id="devLoginBtn" style="display:none;background:#198754;color:#fff;border:none;padding:7px 20px;border-radius:6px;font-size:1em;cursor:pointer;">دخول المطور</button>
        <button id="devLogoutBtn" style="display:none;background:#d32f2f;color:#fff;border:none;padding:7px 20px;border-radius:6px;font-size:1em;cursor:pointer;">إغلاق المطور</button>
        <span id="devError" style="color:#d32f2f;margin-right:10px;"></span>
        <div id="refreshStatus" style="color:#28a745;font-size:0.9em;margin-top:5px;display:none;">🔄 جاري تحديث البيانات...</div>
    </div>
    <div class="inspector-select-section">
        <label for="inspectorSelect">اختر المفتش :</label>
        <select id="inspectorSelect">
            <option value="">-- اختر المفتش --</option>
        </select>
    </div>
    <!-- قسم المطور: إضافة/تعديل خطة -->
    <div id="devSection" class="dev-section" style="display:none;">
        <!-- إدارة البيانات الأساسية -->
        <div id="dataManagementSection" style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6;">
            <h3 style="margin:0 0 15px 0;color:#234085;text-align:center;">إدارة البيانات الأساسية</h3>
            <div style="display:flex;gap:15px;justify-content:center;flex-wrap:wrap;">
                <button id="manageInspectorsBtn" class="management-btn" style="background:#17a2b8;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">إدارة المفتشين</button>
                <button id="manageAreasBtn" class="management-btn" style="background:#fd7e14;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">إدارة المناطق</button>
                <button id="manageShopsBtn" class="management-btn" style="background:#20c997;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">إدارة المحلات</button>
            </div>
            <div style="margin-top:15px;padding-top:15px;border-top:1px solid #dee2e6;text-align:center;">
                <button id="exportDataBtn" onclick="saveToExternalFile()" style="background:#dc3545;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:bold;">تصدير البيانات إلى ملف JSON</button>
                <p style="margin:8px 0 0 0;font-size:0.9em;color:#666;">احفظ التغييرات في ملف plan-data.json جديد</p>
            </div>
        </div>

        <form id="addEditForm" style="width:100%;max-width:700px;display:flex;flex-wrap:wrap;gap:12px 20px;align-items:center;justify-content:center;margin-bottom:12px;">
            <!-- مفتش مع إمكانية الإضافة -->
            <div style="position:relative;">
                <select id="formInspector" required style="min-width:150px;">
                    <option value="">اختر مفتش</option>
                </select>
                <input type="text" id="newInspectorInput" placeholder="أو أدخل اسم مفتش جديد" style="display:none;min-width:150px;">
                <button type="button" id="toggleInspectorInput" style="position:absolute;left:-30px;top:0;background:#007bff;color:#fff;border:none;padding:7px 8px;border-radius:4px;cursor:pointer;font-size:0.8em;">+</button>
            </div>
            
            <input type="date" id="formDay" required>
            
            <select id="formShift" required>
                <option value="">وقت المناوبة</option>
                <option value="صباحية">صباحية</option>
                <option value="مسائية">مسائية</option>
            </select>
            
            <!-- منطقة مع إمكانية الإضافة -->
            <div style="position:relative;">
                <select id="formArea" required style="min-width:150px;">
                    <option value="">اختر منطقة</option>
                </select>
                <input type="text" id="newAreaInput" placeholder="أو أدخل منطقة جديدة" style="display:none;min-width:150px;">
                <button type="button" id="toggleAreaInput" style="position:absolute;left:-30px;top:0;background:#007bff;color:#fff;border:none;padding:7px 8px;border-radius:4px;cursor:pointer;font-size:0.8em;">+</button>
            </div>
            
            <!-- محلات مع اختيار متعدد -->
            <div style="position:relative;min-width:200px;">
                <select id="formShops" multiple style="min-height:60px;min-width:200px;" required>
                    <option value="">اختر المحلات</option>
                </select>
                <button type="button" id="addNewShop" style="position:absolute;left:-30px;top:0;background:#007bff;color:#fff;border:none;padding:7px 8px;border-radius:4px;cursor:pointer;font-size:0.8em;">+</button>
                <small style="display:block;margin-top:4px;color:#666;font-size:0.85em;">اضغط Ctrl للاختيار المتعدد</small>
            </div>
            
            <button type="submit" style="background:#198754;color:#fff;border:none;padding:8px 22px;border-radius:7px;font-size:1em;cursor:pointer;">إضافة / تعديل</button>
            <input type="hidden" id="formEditingIndex" value="">
        </form>
    </div>
    <div id="planTableContainer" class="plan-table-container"></div>
    <div class="actions-row">
        <!-- First line: Data refresh, Inspector report, Monthly report -->
        <div class="actions-line">
            <button class="refresh-btn" onclick="loadInspectionData()">تحديث البيانات</button>
            <button class="inspector-report-btn" onclick="showInspectorReport()">تقرير المفتش</button>
            <button class="monthly-report-btn" onclick="showMonthlyReport()">التقرير الشهري</button>
        </div>
        <!-- Second line: Save as PDF, Save as Excel, Print -->
        <div class="actions-line">
            <button class="pdf-btn" onclick="exportTableToPDF()">حفظ كـ PDF</button>
            <button class="excel-btn" onclick="exportTableToExcel()">حفظ كـ Excel</button>
            <button class="print-btn" onclick="printTable()">طباعة</button>
        </div>
    </div>
    <div id="inspectorReportDiv" class="inspector-report-div" style="display:none;"></div>
    <div id="monthlyReportModal" class="modal-overlay">
      <div class="modal-content">
        <button class="close-btn" onclick="closeMonthlyReportModal()">×</button>
        <div class="stats-title">التقرير الشهري</div>
        <div class="modal-actions">
            <button class="pdf-btn" onclick="exportMonthlyReportToPDF()">حفظ التقرير كـ PDF</button>
            <button class="excel-btn" onclick="exportMonthlyReportToExcel()">حفظ التقرير كـ Excel</button>
        </div>
        <div id="monthlyReportContent"></div>
      </div>
    </div>

    <!-- مودال إدارة المفتشين -->
    <div id="inspectorsModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <button class="close-btn" onclick="closeInspectorsModal()">×</button>
        <div class="stats-title">إدارة المفتشين</div>
        <div style="margin-bottom:15px;">
            <input type="text" id="newInspectorName" placeholder="اسم المفتش الجديد" style="padding:8px;border:1px solid #ccc;border-radius:4px;margin-left:10px;">
            <button onclick="addNewInspector()" style="background:#28a745;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">إضافة مفتش</button>
        </div>
        <div id="inspectorsList" style="max-height:300px;overflow-y:auto;"></div>
      </div>
    </div>

    <!-- مودال إدارة المناطق -->
    <div id="areasModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <button class="close-btn" onclick="closeAreasModal()">×</button>
        <div class="stats-title">إدارة المناطق</div>
        <div style="margin-bottom:15px;">
            <input type="text" id="newAreaName" placeholder="اسم المنطقة الجديدة" style="padding:8px;border:1px solid #ccc;border-radius:4px;margin-left:10px;">
            <button onclick="addNewArea()" style="background:#28a745;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">إضافة منطقة</button>
        </div>
        <div id="areasList" style="max-height:300px;overflow-y:auto;"></div>
      </div>
    </div>

    <!-- مودال إدارة المحلات -->
    <div id="shopsModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <button class="close-btn" onclick="closeShopsModal()">×</button>
        <div class="stats-title">إدارة المحلات</div>
        <div style="margin-bottom:15px;">
            <input type="text" id="newShopName" placeholder="اسم المحل الجديد" style="padding:8px;border:1px solid #ccc;border-radius:4px;margin-left:10px;">
            <select id="newShopArea" style="padding:8px;border:1px solid #ccc;border-radius:4px;margin-left:10px;">
                <option value="">اختر المنطقة</option>
            </select>
            <button onclick="addNewShop()" style="background:#28a745;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">إضافة محل</button>
        </div>
        <div id="shopsList" style="max-height:300px;overflow-y:auto;"></div>
      </div>
    </div>
    <div class="footer">
        تم التطوير بواسطة &copy; المطور د. علي عبدالعال
    </div>
</div>
<script>
// بيانات المفتشين من ملف البيانات
let inspectorsData = [
    {id:"insp_1758813880098", name:"د. علي عبدالعال"},
    {id:"insp_1758830925093", name:"د. محمد إسماعيل"},
    {id:"insp_1758830939296", name:"د. محمد سعيد"},
    {id:"insp_1758830950586", name:"د. فايز المسالمة"},
    {id:"insp_1758830963007", name:"د. آيه سلامة"},
    {id:"insp_1758830974747", name:"د. آمنه بن صرم"},
    {id:"insp_1758830985608", name:"د. حصة العلي"},
    {id:"insp_1758830999876", name:"د. حسينة العامري"},
    {id:"insp_1758831014928", name:"د. هاجر الغافري"}
];
let inspectors = inspectorsData.map(i=>i.name);

// بيانات المناطق والمحلات
let areasData = [
    {id:"musaffah", name:"المصفح"},
    {id:"khalifa", name:"مدينة خليفة"},
    {id:"area_a", name:"المنطقة أ"},
    {id:"area_c", name:"المنطقة ج"}
];

let shopsData = [
    {id:"shop1", name:"محل 1", areaId:"musaffah"},
    {id:"shop2", name:"محل 2", areaId:"musaffah"},
    {id:"shop3", name:"محل 3", areaId:"khalifa"},
    {id:"shop4", name:"محل 4", areaId:"khalifa"},
    {id:"shop5", name:"محل 5", areaId:"musaffah"},
    {id:"shop7", name:"محل 7", areaId:"musaffah"},
    {id:"shop8", name:"محل 8", areaId:"area_a"},
    {id:"shop9", name:"محل 9", areaId:"area_a"},
    {id:"shop11", name:"محل 11", areaId:"area_c"}
];

let isDev = false;
let selectedInspector = "";
const DEV_PASSWORD = "1983";
// بيانات افتراضية
let defaultInspectionData = [
    { inspector: "هاجر", day: "2025-09-22", shift: "صباحية", area: "المصفح", shops: ["محل 1", "محل 2"] },
    { inspector: "هاجر", day: "2025-09-28", shift: "مسائية", area: "المصفح", shops: ["محل 5"] },
    { inspector: "آمنه", day: "2025-09-25", shift: "مسائية", area: "مدينة خليفة", shops: ["محل 3", "محل 4"] },
    { inspector: "آيه", day: "2025-09-22", shift: "صباحية", area: "المصفح", shops: ["محل 7"] },
    { inspector: "د. فايز المسالمة", day: "2025-09-21", shift: "صباحية", area: "المنطقة أ", shops: ["محل 8", "محل 9"] },
    { inspector: "د.آمنه بن صرم", day: "2025-09-21", shift: "مسائية", area: "المنطقة ج", shops: ["محل 11"] },
];
let inspectionData = defaultInspectionData.slice();
let lastUpdateTime = null;

// Auto-refresh functionality
function startAutoRefresh() {
    setInterval(async () => {
        try {
            const response = await fetch('./plan-data.json?t=' + Date.now());
            if (response.ok) {
                const data = await response.json();
                if (data.lastUpdate && data.lastUpdate !== lastUpdateTime) {
                    await loadInspectionData();
                    showUpdateMessage('تم تحديث البيانات تلقائياً');
                }
            }
        } catch (error) {
            console.log('Auto-refresh check failed:', error);
        }
    }, 30000); // Check every 30 seconds
}

// Load data from JSON file
async function loadInspectionData() {
    const statusDiv = document.getElementById('refreshStatus');
    try {
        if (statusDiv) {
            statusDiv.style.display = 'block';
        }
        
        const response = await fetch('./plan-data.json?t=' + Date.now());
        if (response.ok) {
            const data = await response.json();
            if (data.inspectionData && Array.isArray(data.inspectionData)) {
                inspectionData = data.inspectionData;
                lastUpdateTime = data.lastUpdate;
                if (data.inspectors && Array.isArray(data.inspectors)) {
                    inspectorsData = data.inspectors;
                    inspectors = inspectorsData.map(i=>i.name);
                }
                if (data.areas && Array.isArray(data.areas)) {
                    areasData = data.areas;
                }
                if (data.shops && Array.isArray(data.shops)) {
                    shopsData = data.shops;
                }
                renderPlanTable();
                fillInspectorsDropdowns();
                fillAreasDropdowns();
                fillShopsDropdowns();
                setLastUpdateDate();
            }
        } else {
            console.warn('Failed to fetch plan data - response not ok:', response.status);
        }
    } catch (error) {
        console.warn('Failed to load plan data, using fallback data:', error);
        // First try to load complete data from localStorage
        const allLocalData = localStorage.getItem('allPlanData');
        if (allLocalData) {
            try {
                const allData = JSON.parse(allLocalData);
                if (allData.inspectionData) inspectionData = allData.inspectionData;
                if (allData.inspectors) {
                    inspectorsData = allData.inspectors;
                    inspectors = inspectorsData.map(i => i.name);
                }
                if (allData.areas) areasData = allData.areas;
                if (allData.shops) shopsData = allData.shops;
                console.log('Loaded complete data from localStorage backup');
            } catch (parseError) {
                console.warn('Failed to parse localStorage data, using individual fallback');
                // Fall back to individual localStorage items
                const localInspectionData = localStorage.getItem('inspectionData');
                if (localInspectionData) {
                    inspectionData = JSON.parse(localInspectionData);
                }
            }
        } else {
            // Fall back to individual localStorage item
            const localInspectionData = localStorage.getItem('inspectionData');
            if (localInspectionData) {
                inspectionData = JSON.parse(localInspectionData);
            }
        }
    } finally {
        // Always ensure dropdowns are populated and table is rendered
        fillInspectorsDropdowns();
        fillAreasDropdowns();
        fillShopsDropdowns();
        renderPlanTable();
        if (statusDiv) {
            setTimeout(() => statusDiv.style.display = 'none', 1000);
        }
    }
}

// تحميل البيانات من plan-data.json
async function loadPlanData() {
    try {
        const response = await fetch('./plan-data.json');
        if (response.ok) {
            const planData = await response.json();
            if (Array.isArray(planData) && planData.length > 0) {
                inspectionData = planData;
                saveInspectionData();
                renderPlanTable();
                setLastUpdateDate();
                console.log('تم تحميل بيانات الخطة من plan-data.json بنجاح');
                return true;
            }
        }
    } catch (error) {
        console.warn('تعذر تحميل plan-data.json، سيتم استخدام البيانات الافتراضية:', error);
    }
    return false;
}

function saveInspectionData() {
    // Save to localStorage as backup
    localStorage.setItem('inspectionData', JSON.stringify(inspectionData));
    setLastUpdateDate();
    
    // Note: File export is now manual only via the "تصدير البيانات إلى ملف JSON" button
    // This prevents excessive downloads on every developer action
}

// Function to save data to external JSON file (for developer mode)
async function saveToExternalFile() {
    try {
        const planData = {
            inspectionData: inspectionData,
            inspectors: inspectorsData,
            areas: areasData,
            shops: shopsData,
            lastUpdate: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(planData, null, 2);
        
        // Method 1: Direct file write (works in local file:// protocol)
        try {
            const response = await fetch('./plan-data.json', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: dataStr
            });
            
            if (response.ok) {
                showUpdateMessage('✅ تم حفظ البيانات في plan-data.json بنجاح!');
                console.log('✅ Data saved directly to plan-data.json:', planData);
                return;
            }
        } catch (fetchError) {
            console.log('Direct file write not available (expected in browser):', fetchError.message);
        }
        
        // Method 2: Use File System Access API (Chrome/Edge)
        if ('showSaveFilePicker' in window) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: 'plan-data.json',
                    types: [{
                        description: 'JSON files',
                        accept: {'application/json': ['.json']},
                    }],
                });
                const writable = await fileHandle.createWritable();
                await writable.write(dataStr);
                await writable.close();
                showUpdateMessage('✅ تم حفظ ملف plan-data.json بنجاح!');
                console.log('✅ Data saved using File System Access API:', planData);
                return;
            } catch (err) {
                if (err.name === 'AbortError') {
                    // User cancelled the file picker - don't proceed with automatic download
                    showUpdateMessage('تم إلغاء عملية الحفظ');
                    console.log('File save cancelled by user');
                    return;
                } else {
                    console.log('File System Access API error:', err);
                    // Continue to Method 3 only if there was a real error (not user cancellation)
                }
            }
        }
        
        // Method 3: Automatic download + helper script (only as last resort)
        // Download the updated plan-data.json file
        const jsonBlob = new Blob([dataStr], {type: 'application/json'});
        const jsonUrl = URL.createObjectURL(jsonBlob);
        
        const jsonLink = document.createElement('a');
        jsonLink.href = jsonUrl;
        jsonLink.download = 'plan-data.json';
        jsonLink.style.display = 'none';
        document.body.appendChild(jsonLink);
        jsonLink.click();
        document.body.removeChild(jsonLink);
        URL.revokeObjectURL(jsonUrl);
        
        // Store the data for potential script access
        localStorage.setItem('latestPlanData', dataStr);
        localStorage.setItem('latestPlanDataTimestamp', new Date().toISOString());
        
        // Create and show detailed instructions only for automatic download
        const instructions = `
📋 تعليمات حفظ البيانات:

الطريقة الأولى (الأسهل):
1. تم تنزيل ملف plan-data.json جديد
2. انسخ الملف المنزل إلى مجلد المشروع (استبدل الملف الموجود)

الطريقة الثانية (استخدام سكريبت Python):
1. افتح سطر الأوامر في مجلد المشروع
2. شغل الأمر: python save_from_browser.py
3. الصق البيانات JSON عندما يطلب منك

الطريقة الثالثة (يدوياً):
1. انسخ البيانات من وحدة التحكم (console)
2. افتح plan-data.json في محرر النصوص
3. استبدل المحتوى والصق البيانات الجديدة
        `;
        
        console.log('📋 تعليمات الحفظ:', instructions);
        console.log('📊 البيانات الجديدة:', dataStr);
        
        showUpdateMessage(`✅ تم تصدير plan-data.json - راجع وحدة التحكم (F12) للتعليمات التفصيلية`);
        
        // Show instructions only if user wants them
        setTimeout(() => {
            if (confirm('تم تصدير البيانات بنجاح!\n\nهل تريد عرض التعليمات التفصيلية؟')) {
                alert(instructions.trim());
            }
        }, 100);
        
    } catch (error) {
        console.error('❌ Failed to save to external file:', error);
        showUpdateMessage('❌ خطأ في التصدير - تم الحفظ محلياً فقط');
    }
}

function showUpdateMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = 'position:fixed;top:20px;right:20px;background:#28a745;color:white;padding:10px 15px;border-radius:5px;z-index:1000;';
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    setTimeout(() => document.body.removeChild(messageDiv), 3000);
}
function setLastUpdateDate() {
    let row = document.getElementById('lastUpdateRow');
    let today = new Date();
    let year = today.getFullYear();
    let month = String(today.getMonth()+1).padStart(2,'0');
    let day = String(today.getDate()).padStart(2,'0');
    let hours = today.getHours();
    let minutes = String(today.getMinutes()).padStart(2,'0');
    let period = hours >= 12 ? 'مساءً' : 'صباحًا';
    let hour12 = hours % 12;
    if(hour12 === 0) hour12 = 12;
    let timeStr = hour12 + ':' + minutes + ' ' + period;
    let dateStr = year+'-'+month+'-'+day;
    row.textContent = "آخر تعديل للبيانات والخطة: " + dateStr + "    " + timeStr;
}
function fillInspectorsDropdowns() {
    // مفتشين لأداة الاختيار
    const selectInspect = document.getElementById('inspectorSelect');
    selectInspect.innerHTML = '<option value="">-- اختر المفتش --</option>';
    inspectorsData.forEach(inspector => {
        selectInspect.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
    });
    // مفتشين في نموذج المطور
    const select2 = document.getElementById('formInspector');
    if (select2) {
        select2.innerHTML = `<option value="">اختر مفتش</option>`;
        inspectorsData.forEach(inspector => {
            select2.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
        });
    }
}
function fillAreasDropdowns() {
    // منطقة في نموذج المطور
    const areaSelect = document.getElementById('formArea');
    if (areaSelect) {
        areaSelect.innerHTML = '<option value="">اختر منطقة</option>';
        areasData.forEach(area => {
            areaSelect.innerHTML += `<option value="${area.name}">${area.name}</option>`;
        });
    }
    
    // منطقة في مودال إضافة محل جديد
    const newShopAreaSelect = document.getElementById('newShopArea');
    if (newShopAreaSelect) {
        newShopAreaSelect.innerHTML = '<option value="">اختر المنطقة</option>';
        areasData.forEach(area => {
            newShopAreaSelect.innerHTML += `<option value="${area.id}">${area.name}</option>`;
        });
    }
}

function fillShopsDropdowns(selectedAreaId = null) {
    const shopsSelect = document.getElementById('formShops');
    if (shopsSelect) {
        shopsSelect.innerHTML = '';
        // Always show all shops, not filtered by area - allow mixing different areas
        let shopsToShow = shopsData;
        
        shopsToShow.forEach(shop => {
            const area = areasData.find(a => a.id === shop.areaId);
            const areaName = area ? area.name : 'غير محدد';
            const option = document.createElement('option');
            option.value = shop.name;
            option.textContent = `${shop.name} (${areaName})`;  // Show area name in option for clarity
            shopsSelect.appendChild(option);
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('clickBtn').addEventListener('click', playClickSound);
    setLastUpdateDate();
    // Removed automatic playback - sound only plays on user touch/click interactions
    loadInspectionData(); // Load data from JSON file - will call fillInspectorsDropdowns() when complete
    startAutoRefresh(); // Start auto-refresh functionality
    
    // Ensure dropdowns are filled on page load
    fillInspectorsDropdowns();
    fillAreasDropdowns();
    fillShopsDropdowns();
    
    // Add event listeners for toggle buttons and management buttons
    
    // Inspector toggle
    document.getElementById('toggleInspectorInput').addEventListener('click', function() {
        const select = document.getElementById('formInspector');
        const input = document.getElementById('newInspectorInput');
        if (select.style.display === 'none') {
            select.style.display = 'inline-block';
            input.style.display = 'none';
            this.textContent = '+';
            this.title = 'إضافة مفتش جديد';
        } else {
            select.style.display = 'none';  
            input.style.display = 'inline-block';
            input.focus();
            this.textContent = '×';
            this.title = 'إلغاء إدخال مفتش جديد';
        }
    });
    
    // Area toggle
    document.getElementById('toggleAreaInput').addEventListener('click', function() {
        const select = document.getElementById('formArea');
        const input = document.getElementById('newAreaInput');
        if (select.style.display === 'none') {
            select.style.display = 'inline-block';
            input.style.display = 'none';
            this.textContent = '+';
            this.title = 'إضافة منطقة جديدة';
        } else {
            select.style.display = 'none';
            input.style.display = 'inline-block';
            input.focus();
            this.textContent = '×';
            this.title = 'إلغاء إدخال منطقة جديدة';
        }
    });
    
    // Area change handler - no longer filters shops, always show all shops for free selection
    document.getElementById('formArea').addEventListener('change', function() {
        // Just refresh the shops dropdown without filtering
        fillShopsDropdowns();
    });
    
    // Management buttons
    document.getElementById('manageInspectorsBtn').addEventListener('click', function() {
        document.getElementById('inspectorsModal').style.display = 'flex';
        displayInspectorsList();
    });
    
    document.getElementById('manageAreasBtn').addEventListener('click', function() {
        document.getElementById('areasModal').style.display = 'flex';
        displayAreasList();
    });
    
    document.getElementById('manageShopsBtn').addEventListener('click', function() {
        document.getElementById('shopsModal').style.display = 'flex';
        displayShopsList();
    });
    
    // Add new shop button  
    document.getElementById('addNewShop').addEventListener('click', function() {
        document.getElementById('shopsModal').style.display = 'flex';
        displayShopsList();
    });
});

// التحكم في تسجيل الدخول وصلاحيات المطور
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById("loginRole").addEventListener("change", function() {
        let role = this.value;
        document.getElementById("devError").innerText = "";
        if(role === "developer") {
            document.getElementById("devPassword").style.display = "inline-block";
            document.getElementById("devLoginBtn").style.display = "inline-block";
            document.getElementById("devLogoutBtn").style.display = "none";
            document.getElementById("devSection").style.display = "none";
            isDev = false;
        } else {
            document.getElementById("devPassword").style.display = "none";
            document.getElementById("devLoginBtn").style.display = "none";
            document.getElementById("devLogoutBtn").style.display = "none";
            document.getElementById("devSection").style.display = "none";
            isDev = false;
            renderPlanTable();
        }
    });
});
document.getElementById("devLoginBtn").onclick = function() {
    let pw = document.getElementById("devPassword").value.trim();
    if (pw === DEV_PASSWORD) {
        isDev = true;
        document.getElementById("devSection").style.display = "block";
        document.getElementById("devLogoutBtn").style.display = "inline-block";
        document.getElementById("devPassword").style.display = "none";
        document.getElementById("devLoginBtn").style.display = "none";
        document.getElementById("devError").innerText = "";
        fillInspectorsDropdowns();
        renderPlanTable();
    } else {
        document.getElementById("devError").innerText = "كلمة السر غير صحيحة!";
    }
}
document.getElementById("devLogoutBtn").onclick = function() {
    isDev = false;
    document.getElementById("devSection").style.display = "none";
    document.getElementById("devLogoutBtn").style.display = "none";
    document.getElementById("devPassword").style.display = "none";
    document.getElementById("devLoginBtn").style.display = "none";
    document.getElementById("loginRole").value = "";
    document.getElementById("devError").innerText = "";
    renderPlanTable();
};

// التغيير على اختيار المفتش
document.getElementById('inspectorSelect').addEventListener('change', function() {
    selectedInspector = this.value;
    renderPlanTable();
    document.getElementById('inspectorReportDiv').style.display = "none";
});

document.getElementById("addEditForm").addEventListener("submit", function(e){
    e.preventDefault();
    if (!isDev) return;
    
    // Get inspector (from dropdown or new input)
    let inspector = document.getElementById("formInspector").value;
    const newInspectorInput = document.getElementById("newInspectorInput");
    if (newInspectorInput.style.display !== 'none' && newInspectorInput.value.trim()) {
        inspector = newInspectorInput.value.trim();
    }
    
    let day = document.getElementById("formDay").value;
    let shift = document.getElementById("formShift").value;
    
    // Get area (from dropdown or new input)
    let area = document.getElementById("formArea").value;
    const newAreaInput = document.getElementById("newAreaInput");
    if (newAreaInput.style.display !== 'none' && newAreaInput.value.trim()) {
        area = newAreaInput.value.trim();
    }
    
    // Get selected shops from multi-select
    const shopsSelect = document.getElementById("formShops");
    let shops = Array.from(shopsSelect.selectedOptions).map(option => option.value);
    
    let editingIdx = document.getElementById("formEditingIndex").value;

    if(!inspector || !day || !shift || !area || shops.length === 0) {
        alert("يرجى تعبئة جميع الحقول!");
        return;
    }
    
    // If new inspector, add to inspectorsData
    if (!inspectorsData.find(insp => insp.name === inspector)) {
        const newId = 'insp_' + Date.now();
        inspectorsData.push({id: newId, name: inspector});
        inspectors = inspectorsData.map(i => i.name);
        fillInspectorsDropdowns();
    }
    
    // If new area, add to areasData
    if (!areasData.find(ar => ar.name === area)) {
        const newId = 'area_' + Date.now();
        areasData.push({id: newId, name: area});
        fillAreasDropdowns();
    }
    
    let newPlan = {inspector, day, shift, area, shops};
    if(editingIdx==="") {
        inspectionData.push(newPlan);
    } else {
        inspectionData[editingIdx] = newPlan;
    }
    saveInspectionData();
    renderPlanTable();
    this.reset();
    document.getElementById("formEditingIndex").value = "";
    
    // Reset toggle states
    resetFormToggles();
});

// --- عرض جدول الخطط مع صلاحيات المطور ---
function renderPlanTable() {
    const container = document.getElementById('planTableContainer');
    let rows = inspectionData;
    // إذا تم اختيار مفتش معيّن
    if(selectedInspector) {
        rows = inspectionData.filter(item => item.inspector === selectedInspector);
    }
    if (rows.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#c00;font-weight:bold;margin:30px 0;">لا توجد أي خطة تفتيش.</div>';
        return;
    }
    let html = `
    <table class="plan-table" id="inspectorPlanTable">
        <thead>
            <tr>
                <th>اسم المفتش</th>
                <th>اليوم</th>
                <th>وقت المناوبة</th>
                <th>المنطقة</th>
                <th>المحلات</th>
                ${isDev?'<th>تعديل/حذف</th>':''}
            </tr>
        </thead>
        <tbody>
    `;
    rows.forEach((row, idx) => {
        let shopsStr = row.shops.map(shop=>`<li>${shop}</li>`).join('');
        let realIdx = inspectionData.indexOf(row);
        html += `
            <tr>
                <td>${row.inspector}</td>
                <td>${row.day}</td>
                <td>${row.shift}</td>
                <td>${row.area}</td>
                <td>
                    <div class="shops-dropdown-wrap" id="shopsDropdownWrap${idx}">
                        <button class="dropdown-shops-btn" onclick="toggleShopsDropdown(event, ${idx})">عرض المحلات</button>
                        <div class="shops-dropdown-list" id="shopsDropdownList${idx}">
                            <ul>
                                ${shopsStr}
                            </ul>
                        </div>
                    </div>
                </td>
                ${isDev?`
                <td>
                    <button class="edit-btn" onclick="editPlan(${realIdx})">تعديل</button>
                    <button class="delete-btn" onclick="deletePlan(${realIdx})">حذف</button>
                </td>
                `:``}
            </tr>
        `;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
}

function editPlan(idx) {
    if (!isDev) return;
    let plan = inspectionData[idx];
    
    // Reset toggles to show dropdowns
    resetFormToggles();
    
    // Set inspector
    document.getElementById("formInspector").value = plan.inspector;
    document.getElementById("formDay").value = plan.day;
    document.getElementById("formShift").value = plan.shift;
    
    // Set area and update shops accordingly
    document.getElementById("formArea").value = plan.area;
    // Always show all shops regardless of area selection
    fillShopsDropdowns();
    
    // Set selected shops in multi-select
    const shopsSelect = document.getElementById("formShops");
    setTimeout(() => {
        for (let option of shopsSelect.options) {
            option.selected = plan.shops.includes(option.value);
        }
    }, 100);
    
    document.getElementById("formEditingIndex").value = idx;
    window.scrollTo({top:0,behavior:'smooth'});
}
function deletePlan(idx) {
    if (!isDev) return;
    if(!confirm("هل تريد حذف هذه الخطة نهائياً؟")) return;
    inspectionData.splice(idx,1);
    saveInspectionData();
    renderPlanTable();
}

// --- المحلات المنسدلة ---
window.toggleShopsDropdown = function(event, idx) {
    event.stopPropagation();
    document.querySelectorAll('.shops-dropdown-list').forEach((el,i)=>{
        if(i!==idx) el.style.display='none';
    });
    let btn = event.target;
    let rect = btn.getBoundingClientRect();
    let list = document.getElementById('shopsDropdownList'+idx);
    list.style.display = 'block';
    let top = rect.bottom + window.scrollY + 2;
    let left = rect.right - list.offsetWidth + window.scrollX;
    if ((top + list.offsetHeight) > (window.innerHeight + window.scrollY)) {
        top = rect.top + window.scrollY - list.offsetHeight - 2;
    }
    list.style.top = top+"px";
    list.style.left = (rect.left + window.scrollX) + "px";
};
document.addEventListener('click', function(e){
    if (![...document.querySelectorAll('.shops-dropdown-wrap *')].includes(e.target)) {
        document.querySelectorAll('.shops-dropdown-list').forEach(el=>el.style.display='none');
    }
});

// --- صوت النقر ---
let lastClickSoundTime = 0;
const CLICK_SOUND_COOLDOWN = 300; // 300ms between clicks to prevent spam

function playClickSound() {
    const currentTime = Date.now();
    // Check cooldown to prevent too frequent sounds
    if (currentTime - lastClickSoundTime < CLICK_SOUND_COOLDOWN) {
        return;
    }
    
    lastClickSoundTime = currentTime;
    
    // Add visual click animation
    const clickIcon = document.getElementById('clickIcon');
    if (clickIcon) {
        clickIcon.style.animation = 'clickPulse 0.2s ease-in-out';
        setTimeout(function() {
            clickIcon.style.animation = '';
        }, 200);
    }
    
    // Generate click sound using Web Audio API
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Create a short, sharp click sound
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        // Connect the oscillator to gain node to speakers
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Configure the click sound
        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // High pitch for click
        
        // Quick attack and decay for sharp click
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01); // Quick attack
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1); // Quick decay
        
        // Start and stop the sound
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1); // Very short duration
        
        console.log('Click sound played');
        
    } catch (error) {
        console.log('Failed to play click sound:', error);
        // Even if sound fails, still show visual feedback
        const clickIcon = document.getElementById('clickIcon');
        if (clickIcon) {
            clickIcon.style.animation = 'clickPulse 0.2s ease-in-out';
            setTimeout(function() {
                clickIcon.style.animation = '';
            }, 200);
        }
    }
}

// --- دوال التصدير والتقارير بالكامل ---
function exportTableToPDF() {
    let table = document.getElementById('inspectorPlanTable');
    if (!table) { alert("لا يوجد جدول للتصدير"); return; }
    let wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '18px';
    wrap.style.width = table.offsetWidth + 'px';
    let titleBox = document.createElement('div');
    titleBox.className = "pdf-title-arabic";
    titleBox.innerText = "خطة التفتيش الشهرية";
    wrap.appendChild(titleBox);
    let tableClone = table.cloneNode(true);
    tableClone.style.marginTop = '10px';
    wrap.appendChild(tableClone);
    document.body.appendChild(wrap);
    html2canvas(wrap, {backgroundColor:'#fff', scale:2}).then(function(canvas) {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:"landscape",unit:"pt",format:"a4"});
        let pageWidth = doc.internal.pageSize.getWidth();
        let imgProps = doc.getImageProperties(imgData);
        let pdfWidth = pageWidth - 80;
        let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'PNG', 40, 35, pdfWidth, pdfHeight);
        doc.save(`خطة_التفتيش.pdf`);
        document.body.removeChild(wrap);
    });
}
function exportTableToExcel() {
    let table = document.getElementById('inspectorPlanTable');
    if (!table) { alert("لا يوجد جدول للتصدير"); return; }
    let ws_data = [];
    for(let r of table.rows) {
        let row = [];
        for(let c of r.cells) row.push(c.textContent);
        ws_data.push(row);
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "الخطة");
    XLSX.writeFile(wb, `خطة_التفتيش.xlsx`);
}
function printTable() {
    let table = document.getElementById('inspectorPlanTable');
    if (!table) { alert("لا يوجد جدول لطباعته"); return; }
    
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    const tableClone = table.cloneNode(true);
    
    // Create the print document
    printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>خطة التفتيش الشهرية - طباعة</title>
            <style>
                body { font-family: 'Cairo', Arial, sans-serif; margin: 20px; }
                .print-title { text-align: center; color: #234085; font-size: 1.5em; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #234093; padding: 8px; text-align: center; }
                th { background: #234093; color: #fff; }
                tr:nth-child(even) { background: #f3f5fa; }
                @media print {
                    body { margin: 0; }
                    .print-title { font-size: 1.2em; }
                }
            </style>
        </head>
        <body>
            <div class="print-title">خطة التفتيش الشهرية</div>
            ${tableClone.outerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    
    // Wait for content to load then print
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 500);
}
function showInspectorReport() {
    let inspectorName = selectedInspector || "";
    if (!inspectorName) { alert("يرجى اختيار مفتش أولاً."); return; }
    const div = document.getElementById('inspectorReportDiv');
    const rows = inspectionData.filter(item => item.inspector === inspectorName);
    let total = rows.length;
    let morning = rows.filter(r => r.shift === "صباحية").length;
    let evening = rows.filter(r => r.shift === "مسائية").length;
    let weekend = rows.filter(r => {
        const dayOfWeek = new Date(r.day).getDay();
        return [5,6,0].includes(dayOfWeek);
    }).length;
    let table = `
    <div class="pdf-title-arabic" id="inspectorReportTitle">تقرير المفتش: ${inspectorName}</div>
    <div class="save-box" style="margin-bottom:8px;">
        <button class="pdf-btn" onclick="exportInspectorReportToPDF()">حفظ التقرير كـ PDF</button>
        <button class="excel-btn" onclick="exportInspectorReportToExcel()">حفظ التقرير كـ Excel</button>
    </div>
    <table class="stats-table" id="inspectorStatsTable">
        <thead>
            <tr>
                <th>عدد التفتيشات</th>
                <th>الصباحية</th>
                <th>المسائية</th>
                <th>العطلة</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>${total}</td>
                <td>${morning}</td>
                <td>${evening}</td>
                <td>${weekend}</td>
            </tr>
        </tbody>
    </table>
    `;
    div.innerHTML = table;
    div.style.display = "block";
}
function exportInspectorReportToPDF() {
    let titleBox = document.getElementById('inspectorReportTitle');
    let table = document.getElementById('inspectorStatsTable');
    if (!table || !titleBox) return;
    let wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '18px';
    wrap.style.width = table.offsetWidth + 'px';
    let titleClone = titleBox.cloneNode(true);
    let tableClone = table.cloneNode(true);
    tableClone.style.marginTop = '10px';
    wrap.appendChild(titleClone);
    wrap.appendChild(tableClone);
    document.body.appendChild(wrap);
    html2canvas(wrap, {backgroundColor:'#fff', scale:2}).then(function(canvas){
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:"p",unit:"pt",format:"a4"});
        let pageWidth = doc.internal.pageSize.getWidth();
        let imgProps = doc.getImageProperties(imgData);
        let pdfWidth = pageWidth - 80;
        let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'PNG', 40, 35, pdfWidth, pdfHeight);
        doc.save(`تقرير_${selectedInspector}.pdf`);
        document.body.removeChild(wrap);
    });
}
function exportInspectorReportToExcel() {
    let table = document.getElementById("inspectorStatsTable");
    if (!table) return;
    let ws_data = [];
    for(let r of table.rows) {
        let row = [];
        for(let c of r.cells) row.push(c.textContent);
        ws_data.push(row);
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "تقرير المفتش");
    XLSX.writeFile(wb, `تقرير_${selectedInspector}.xlsx`);
}
function showMonthlyReport() {
    let allDays = Array.from(new Set(inspectionData.map(r => r.day))).sort();
    let html = `<div class="pdf-title-arabic" id="monthlyReportTitle">التقرير الشهري</div>`;
    html += `<table class="stats-table" id="monthlyStatsTable"><thead><tr>
        <th>المفتش</th>`;
    allDays.forEach(day => html += `<th>${day}</th>`);
    html += `<th>الإجمالي</th><th>الصباحية</th><th>المسائية</th><th>العطلة</th></tr></thead><tbody>`;
    let totals = { total:0, morning:0, evening:0, weekend:0, days: Array(allDays.length).fill(0) };
    inspectors.forEach(inspector => {
        const rows = inspectionData.filter(item => item.inspector === inspector);
        html += `<tr><td>${inspector}</td>`;
        allDays.forEach((day,i) => {
            let count = rows.filter(r=>r.day===day).length;
            html += `<td>${count||''}</td>`;
            totals.days[i] += count;
        });
        let total = rows.length;
        let morning = rows.filter(r=>r.shift==="صباحية").length;
        let evening = rows.filter(r=>r.shift==="مسائية").length;
        let weekend = rows.filter(r=>{
            const dow = new Date(r.day).getDay();
            return [5,6,0].includes(dow);
        }).length;
        html += `<td>${total}</td><td>${morning}</td><td>${evening}</td><td>${weekend}</td></tr>`;
        totals.total += total; totals.morning += morning; totals.evening += evening; totals.weekend += weekend;
    });
    html += `<tr class="red-total">
        <td>الإجمالي</td>`;
    totals.days.forEach(sum=>html+=`<td>${sum}</td>`);
    html += `<td>${totals.total}</td><td>${totals.morning}</td><td>${totals.evening}</td><td>${totals.weekend}</td></tr>`;
    html += `</tbody></table>`;
    document.getElementById('monthlyReportContent').innerHTML = html;
    document.getElementById('monthlyReportModal').style.display = 'flex';
}
function closeMonthlyReportModal() {
    document.getElementById('monthlyReportModal').style.display = 'none';
}
function exportMonthlyReportToPDF() {
    let titleBox = document.getElementById('monthlyReportTitle');
    let table = document.getElementById("monthlyStatsTable");
    if (!table || !titleBox) return;
    let wrap = document.createElement('div');
    wrap.style.background = '#fff';
    wrap.style.padding = '18px';
    wrap.style.width = table.offsetWidth + 'px';
    let titleClone = titleBox.cloneNode(true);
    let tableClone = table.cloneNode(true);
    tableClone.style.marginTop = '10px';
    wrap.appendChild(titleClone);
    wrap.appendChild(tableClone);
    document.body.appendChild(wrap);
    html2canvas(wrap, {backgroundColor:'#fff', scale:2}).then(function(canvas){
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:"landscape",unit:"pt",format:"a4"});
        let pageWidth = doc.internal.pageSize.getWidth();
        let imgProps = doc.getImageProperties(imgData);
        let pdfWidth = pageWidth - 80;
        let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'PNG', 40, 35, pdfWidth, pdfHeight);
        doc.save(`التقرير_الشهري.pdf`);
        document.body.removeChild(wrap);
    });
}
function exportMonthlyReportToExcel() {
    let table = document.getElementById("monthlyStatsTable");
    if (!table) return;
    let ws_data = [];
    for(let r of table.rows) {
        let row = [];
        for(let c of r.cells) row.push(c.textContent);
        ws_data.push(row);
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "التقرير الشهري");
    XLSX.writeFile(wb, `التقرير_الشهري.xlsx`);
}
</script>
   <script>
// --- Toggle Functions for Inspector/Area Input Fields ---
function resetFormToggles() {
    // Reset inspector toggle
    document.getElementById('formInspector').style.display = 'inline-block';
    document.getElementById('newInspectorInput').style.display = 'none';
    document.getElementById('newInspectorInput').value = '';
    
    // Reset area toggle
    document.getElementById('formArea').style.display = 'inline-block';
    document.getElementById('newAreaInput').style.display = 'none';
    document.getElementById('newAreaInput').value = '';
    
    // Update area-based shops
    fillShopsDropdowns();
}

// --- Modal Management Functions ---
function closeInspectorsModal() {
    document.getElementById('inspectorsModal').style.display = 'none';
}

function closeAreasModal() {
    document.getElementById('areasModal').style.display = 'none';
}

function closeShopsModal() {
    document.getElementById('shopsModal').style.display = 'none';
}

function addNewInspector() {
    const nameInput = document.getElementById('newInspectorName');
    const name = nameInput.value.trim();
    if (!name) {
        alert('يرجى إدخال اسم المفتش');
        return;
    }
    
    if (inspectorsData.find(insp => insp.name === name)) {
        alert('هذا المفتش موجود بالفعل');
        return;
    }
    
    const newId = 'insp_' + Date.now();
    inspectorsData.push({id: newId, name: name});
    inspectors = inspectorsData.map(i => i.name);
    
    fillInspectorsDropdowns();
    displayInspectorsList();
    nameInput.value = '';
    saveDataToJSON();
}

function addNewArea() {
    const nameInput = document.getElementById('newAreaName');
    const name = nameInput.value.trim();
    if (!name) {
        alert('يرجى إدخال اسم المنطقة');
        return;
    }
    
    if (areasData.find(area => area.name === name)) {
        alert('هذه المنطقة موجودة بالفعل');
        return;
    }
    
    const newId = 'area_' + Date.now();
    areasData.push({id: newId, name: name});
    
    fillAreasDropdowns();
    displayAreasList();
    nameInput.value = '';
    saveDataToJSON();
}

function addNewShop() {
    const nameInput = document.getElementById('newShopName');
    const areaSelect = document.getElementById('newShopArea');
    const name = nameInput.value.trim();
    const areaId = areaSelect.value;
    
    if (!name || !areaId) {
        alert('يرجى إدخال اسم المحل واختيار المنطقة');
        return;
    }
    
    if (shopsData.find(shop => shop.name === name)) {
        alert('هذا المحل موجود بالفعل');
        return;
    }
    
    const newId = 'shop_' + Date.now();
    shopsData.push({id: newId, name: name, areaId: areaId});
    
    fillShopsDropdowns();
    displayShopsList();
    nameInput.value = '';
    areaSelect.value = '';
    saveDataToJSON();
}

function displayInspectorsList() {
    const container = document.getElementById('inspectorsList');
    let html = '';
    inspectorsData.forEach((inspector, index) => {
        html += `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee;">
                <span>${inspector.name}</span>
                <div style="display:flex;gap:4px;">
                    <button onclick="editInspector(${index})" style="background:#6c757d;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">تعديل</button>
                    <button onclick="deleteInspector(${index})" style="background:#dc3545;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">حذف</button>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function displayAreasList() {
    const container = document.getElementById('areasList');
    let html = '';
    areasData.forEach((area, index) => {
        html += `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee;">
                <span>${area.name}</span>
                <div style="display:flex;gap:4px;">
                    <button onclick="editArea(${index})" style="background:#6c757d;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">تعديل</button>
                    <button onclick="deleteArea(${index})" style="background:#dc3545;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">حذف</button>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function displayShopsList() {
    const container = document.getElementById('shopsList');
    let html = '';
    shopsData.forEach((shop, index) => {
        const area = areasData.find(a => a.id === shop.areaId);
        const areaName = area ? area.name : 'غير محدد';
        html += `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee;">
                <span>${shop.name} - ${areaName}</span>
                <div style="display:flex;gap:4px;">
                    <button onclick="editShop(${index})" style="background:#6c757d;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">تعديل</button>
                    <button onclick="deleteShop(${index})" style="background:#dc3545;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">حذف</button>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function deleteInspector(index) {
    if (confirm('هل أنت متأكد من حذف هذا المفتش؟')) {
        inspectorsData.splice(index, 1);
        inspectors = inspectorsData.map(i => i.name);
        fillInspectorsDropdowns();
        displayInspectorsList();
        saveDataToJSON();
    }
}

function editInspector(index) {
    const inspector = inspectorsData[index];
    const newName = prompt('تعديل اسم المفتش:', inspector.name);
    
    if (newName === null) return; // User cancelled
    
    const newNameTrimmed = newName.trim();
    if (!newNameTrimmed) {
        alert('يرجى إدخال اسم صحيح للمفتش');
        return;
    }
    
    // Check if name already exists (but not for the same inspector)
    const existingInspector = inspectorsData.find((i, idx) => i.name === newNameTrimmed && idx !== index);
    if (existingInspector) {
        alert('هذا المفتش موجود بالفعل');
        return;
    }
    
    // Update inspector data
    inspector.name = newNameTrimmed;
    inspectors = inspectorsData.map(i => i.name); // Update the inspectors array too
    
    fillInspectorsDropdowns();
    displayInspectorsList();
    saveDataToJSON();
}

function deleteArea(index) {
    if (confirm('هل أنت متأكد من حذف هذه المنطقة؟')) {
        areasData.splice(index, 1);
        fillAreasDropdowns();
        displayAreasList();
        saveDataToJSON();
    }
}

function editArea(index) {
    const area = areasData[index];
    const newName = prompt('تعديل اسم المنطقة:', area.name);
    
    if (newName === null) return; // User cancelled
    
    const newNameTrimmed = newName.trim();
    if (!newNameTrimmed) {
        alert('يرجى إدخال اسم صحيح للمنطقة');
        return;
    }
    
    // Check if name already exists (but not for the same area)
    const existingArea = areasData.find((a, i) => a.name === newNameTrimmed && i !== index);
    if (existingArea) {
        alert('هذه المنطقة موجودة بالفعل');
        return;
    }
    
    // Update area data
    area.name = newNameTrimmed;
    
    fillAreasDropdowns();
    displayAreasList();
    saveDataToJSON();
}

function deleteShop(index) {
    if (confirm('هل أنت متأكد من حذف هذا المحل؟')) {
        shopsData.splice(index, 1);
        fillShopsDropdowns();
        displayShopsList();
        saveDataToJSON();
    }
}

function editShop(index) {
    const shop = shopsData[index];
    const area = areasData.find(a => a.id === shop.areaId);
    
    const newName = prompt('تعديل اسم المحل:', shop.name);
    if (newName === null) return; // User cancelled
    
    const newNameTrimmed = newName.trim();
    if (!newNameTrimmed) {
        alert('يرجى إدخال اسم صحيح للمحل');
        return;
    }
    
    // Check if name already exists (but not for the same shop)
    const existingShop = shopsData.find((s, i) => s.name === newNameTrimmed && i !== index);
    if (existingShop) {
        alert('هذا المحل موجود بالفعل');
        return;
    }
    
    // Get new area
    const areaNames = areasData.map(a => a.name);
    const currentAreaName = area ? area.name : 'غير محدد';
    let selectedAreaName = currentAreaName;
    
    // Simple area selection using confirm dialogs (basic approach)
    let areaChoice = confirm(`المنطقة الحالية: ${currentAreaName}\nهل تريد تغيير المنطقة؟`);
    if (areaChoice) {
        let areaOptions = areaNames.join('\n');
        let newAreaName = prompt(`اختر المنطقة الجديدة:\n${areaOptions}`, currentAreaName);
        if (newAreaName !== null) {
            const newArea = areasData.find(a => a.name === newAreaName.trim());
            if (newArea) {
                selectedAreaName = newArea.name;
            } else {
                alert('المنطقة غير موجودة');
                return;
            }
        }
    }
    
    // Update shop data
    shop.name = newNameTrimmed;
    const selectedArea = areasData.find(a => a.name === selectedAreaName);
    if (selectedArea) {
        shop.areaId = selectedArea.id;
    }
    
    fillShopsDropdowns();
    displayShopsList();
    saveDataToJSON();
}

function saveDataToJSON() {
    // Save all data to localStorage as backup
    const allData = {
        inspectionData: inspectionData,
        inspectors: inspectorsData,
        areas: areasData,
        shops: shopsData,
        lastUpdate: new Date().toISOString()
    };
    localStorage.setItem('allPlanData', JSON.stringify(allData));
    
    // In developer mode, also trigger external file save
    if (isDev) {
        // Show a notification that data needs to be saved externally
        showUpdateMessage('تم الحفظ محلياً - استخدم زر "تصدير البيانات" لحفظ التغييرات نهائياً');
        console.log('Data saved to localStorage - developer should export for permanent save');
    } else {
        console.log('Data saved to localStorage');
    }
}

// Call loadInspectionData when the DOM is ready  
// Note: This is already handled in the main DOMContentLoaded event listener above
</script>

<!-- Backup initialization script to ensure functionality works -->
<script>
(function() {
    // Backup inspector data in case main script fails
    if (typeof inspectorsData === 'undefined') {
        window.inspectorsData = [
            {id:"insp_1758813880098", name:"د. علي عبدالعال"},
            {id:"insp_1758830925093", name:"د. محمد إسماعيل"},
            {id:"insp_1758830939296", name:"د. محمد سعيد"},
            {id:"insp_1758830950586", name:"د. فايز المسالمة"},
            {id:"insp_1758830963007", name:"د. آيه سلامة"},
            {id:"insp_1758830974747", name:"د. آمنه بن صرم"},
            {id:"insp_1758830985608", name:"د. حصة العلي"},
            {id:"insp_1758830999876", name:"د. حسينة العامري"},
            {id:"insp_1758831014928", name:"د. هاجر الغافري"}
        ];
        window.inspectors = window.inspectorsData.map(i => i.name);
    }
    
    // Backup function to fill inspector dropdown
    function ensureInspectorDropdownFilled() {
        const inspectorSelect = document.getElementById('inspectorSelect');
        if (inspectorSelect && inspectorSelect.options.length <= 1) {
            inspectorSelect.innerHTML = '<option value="">-- اختر المفتش --</option>';
            window.inspectorsData.forEach(inspector => {
                inspectorSelect.innerHTML += `<option value="${inspector.name}">${inspector.name}</option>`;
            });
        }
    }
    
    // Backup function to ensure developer login functionality
    function ensureDeveloperLoginWorks() {
        const loginRole = document.getElementById('loginRole');
        const devPassword = document.getElementById('devPassword');
        const devLoginBtn = document.getElementById('devLoginBtn');
        
        if (loginRole && !loginRole.onchangeBackup) {
            loginRole.onchangeBackup = true;
            loginRole.addEventListener('change', function() {
                const role = this.value;
                document.getElementById('devError').innerText = '';
                
                if(role === 'developer') {
                    document.getElementById('devPassword').style.display = 'inline-block';
                    document.getElementById('devLoginBtn').style.display = 'inline-block';
                    document.getElementById('devLogoutBtn').style.display = 'none';
                    document.getElementById('devSection').style.display = 'none';
                    window.isDev = false;
                } else {
                    document.getElementById('devPassword').style.display = 'none';
                    document.getElementById('devLoginBtn').style.display = 'none';
                    document.getElementById('devLogoutBtn').style.display = 'none';
                    document.getElementById('devSection').style.display = 'none';
                    window.isDev = false;
                }
            });
        }
        
        if (devLoginBtn && !devLoginBtn.onclickBackup) {
            devLoginBtn.onclickBackup = true;
            devLoginBtn.onclick = function() {
                const pw = document.getElementById('devPassword').value.trim();
                const DEV_PASSWORD = '1983';
                
                if (pw === DEV_PASSWORD) {
                    window.isDev = true;
                    document.getElementById('devSection').style.display = 'block';
                    document.getElementById('devLogoutBtn').style.display = 'inline-block';
                    document.getElementById('devPassword').style.display = 'none';
                    document.getElementById('devLoginBtn').style.display = 'none';
                    document.getElementById('devError').innerText = '';
                } else {
                    document.getElementById('devError').innerText = 'كلمة السر غير صحيحة!';
                }
            };
        }
        
        const devLogoutBtn = document.getElementById('devLogoutBtn');
        if (devLogoutBtn && !devLogoutBtn.onclickBackup) {
            devLogoutBtn.onclickBackup = true;
            devLogoutBtn.onclick = function() {
                window.isDev = false;
                document.getElementById('devSection').style.display = 'none';
                document.getElementById('devLogoutBtn').style.display = 'none';
                document.getElementById('devPassword').style.display = 'none';
                document.getElementById('devLoginBtn').style.display = 'none';
                document.getElementById('loginRole').value = '';
                document.getElementById('devError').innerText = '';
            };
        }
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                ensureInspectorDropdownFilled();
                ensureDeveloperLoginWorks();
            }, 100);
        });
    } else {
        setTimeout(function() {
            ensureInspectorDropdownFilled();
            ensureDeveloperLoginWorks();
        }, 100);
    }
})();
</script> 
</body>
</html>
