<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التخطيط الذكية - Smart Inspection Panel</title>
    
    <!-- SEO Prevention -->
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Cache Prevention -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.95;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            border-bottom: 3px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .tab-button {
            padding: 14px 28px;
            border: 2px solid #667eea;
            border-radius: 10px 10px 0 0;
            background: white;
            color: #667eea;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: none;
        }
        
        .tab-button:hover {
            background: #f0f0ff;
            transform: translateY(-2px);
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1.8em;
            color: #2d3561;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 700;
            color: #2d3561;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102,126,234,0.1);
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102,126,234,0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(17,153,142,0.3);
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(17,153,142,0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(238,9,121,0.3);
        }
        
        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(238,9,121,0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(250,112,154,0.3);
        }
        
        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(250,112,154,0.4);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .message {
            padding: 16px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .message.show {
            display: block;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .data-table th {
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .data-table tbody tr {
            transition: all 0.2s ease;
        }
        
        .data-table tbody tr:hover {
            background: #f5f5f5;
            transform: scale(1.01);
        }
        
        .action-icon {
            cursor: pointer;
            font-size: 1.4em;
            margin: 0 8px;
            transition: transform 0.2s;
        }
        
        .action-icon:hover {
            transform: scale(1.3);
        }
        
        .edit-icon { color: #ffc107; }
        .delete-icon { color: #dc3545; }
        .view-icon { color: #17a2b8; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .stat-card .icon {
            font-size: 3em;
            margin-bottom: 12px;
            color: #667eea;
        }
        
        .stat-card .value {
            font-size: 2.8em;
            font-weight: 900;
            color: #2d3561;
            margin-bottom: 8px;
        }
        
        .stat-card .label {
            font-size: 1.1em;
            color: #666;
            font-weight: 600;
        }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 35px;
            border-radius: 20px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        
        .modal-title {
            font-size: 1.8em;
            font-weight: 700;
            color: #2d3561;
        }
        
        .modal-close {
            background: #f0f0f0;
            border: none;
            font-size: 1.8em;
            color: #999;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background: #dc3545;
            color: white;
            transform: rotate(90deg);
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .back-button:hover {
            background: #667eea;
            color: white;
            transform: translateX(5px);
        }
        
        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-bar input {
            padding-right: 50px;
        }
        
        .search-bar i {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 1.2em;
        }
        
        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .badge-success {
            background: #28a745;
            color: white;
        }
        
        .badge-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .badge-danger {
            background: #dc3545;
            color: white;
        }
        
        .badge-info {
            background: #17a2b8;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .filter-bar {
                flex-direction: column;
            }
            
            .filter-item {
                width: 100%;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🎯 لوحة التخطيط الذكية</h1>
            <div class="subtitle">إدارة متقدمة للمحلات والمناطق مع تحديثات فورية</div>
        </div>
        
        <!-- Back Button -->
        <button class="back-button" onclick="window.location.href='admin-dashboard.html'">
            <i class="fas fa-arrow-right"></i>
            العودة للوحة التحكم
        </button>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('overview')">
                <i class="fas fa-chart-pie"></i> نظرة عامة
            </button>
            <button class="tab-button" onclick="switchTab('shops')">
                <i class="fas fa-store"></i> إدارة المحلات
            </button>
            <button class="tab-button" onclick="switchTab('areas')">
                <i class="fas fa-map-marked-alt"></i> إدارة المناطق
            </button>
            <button class="tab-button" onclick="switchTab('mapping')">
                <i class="fas fa-link"></i> ربط المحلات بالمناطق
            </button>
        </div>
        
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">🏪</div>
                    <div class="value" id="totalShopsCount">0</div>
                    <div class="label">إجمالي المحلات</div>
                </div>
                <div class="stat-card">
                    <div class="icon">🗺️</div>
                    <div class="value" id="totalAreasCount">0</div>
                    <div class="label">إجمالي المناطق</div>
                </div>
                <div class="stat-card">
                    <div class="icon">🔗</div>
                    <div class="value" id="linkedShopsCount">0</div>
                    <div class="label">محلات مربوطة</div>
                </div>
                <div class="stat-card">
                    <div class="icon">⚠️</div>
                    <div class="value" id="unlinkedShopsCount">0</div>
                    <div class="label">محلات غير مربوطة</div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-info-circle"></i>
                    معلومات النظام
                </div>
                <p style="font-size: 1.1em; line-height: 1.8; color: #666;">
                    هذه اللوحة الذكية توفر لك إمكانية:
                </p>
                <ul style="font-size: 1.1em; line-height: 2; color: #666; margin-top: 15px; margin-right: 30px;">
                    <li>✅ إضافة وتعديل وحذف المحلات بسهولة</li>
                    <li>✅ إدارة المناطق بشكل ديناميكي</li>
                    <li>✅ ربط المحلات بالمناطق تلقائياً</li>
                    <li>✅ تحديثات فورية مع قاعدة البيانات</li>
                    <li>✅ فلترة ذكية للبيانات</li>
                    <li>✅ حفظ التغييرات مباشرة في GitHub</li>
                </ul>
            </div>
        </div>
        
        <!-- Shops Management Tab -->
        <div id="shops" class="tab-content">
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-store"></i>
                    إدارة المحلات
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showAddShopModal()">
                        <i class="fas fa-plus"></i>
                        إضافة محل جديد
                    </button>
                    <button class="btn btn-success" onclick="loadShopsData()">
                        <i class="fas fa-sync-alt"></i>
                        تحديث البيانات
                    </button>
                    <button class="btn btn-warning" onclick="saveShopsData()">
                        <i class="fas fa-save"></i>
                        حفظ التغييرات
                    </button>
                </div>
                
                <div class="message" id="shopsMessage"></div>
                
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" class="form-control" id="shopsSearchInput" 
                           placeholder="ابحث عن محل بالاسم أو الرخصة أو المنطقة..." 
                           onkeyup="filterShopsTable()">
                </div>
                
                <div class="filter-bar">
                    <div class="filter-item">
                        <label class="form-label">فلترة حسب المنطقة</label>
                        <select class="form-control" id="shopsAreaFilter" onchange="filterShopsTable()">
                            <option value="">جميع المناطق</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="form-label">فلترة حسب النشاط</label>
                        <select class="form-control" id="shopsActivityFilter" onchange="filterShopsTable()">
                            <option value="">جميع الأنشطة</option>
                        </select>
                    </div>
                </div>
                
                <div id="shopsTableContainer">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
        
        <!-- Areas Management Tab -->
        <div id="areas" class="tab-content">
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-map-marked-alt"></i>
                    إدارة المناطق
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showAddAreaModal()">
                        <i class="fas fa-plus"></i>
                        إضافة منطقة جديدة
                    </button>
                    <button class="btn btn-success" onclick="loadAreasData()">
                        <i class="fas fa-sync-alt"></i>
                        تحديث البيانات
                    </button>
                </div>
                
                <div class="message" id="areasMessage"></div>
                
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" class="form-control" id="areasSearchInput" 
                           placeholder="ابحث عن منطقة..." 
                           onkeyup="filterAreasTable()">
                </div>
                
                <div id="areasTableContainer">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
        
        <!-- Mapping Tab -->
        <div id="mapping" class="tab-content">
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-link"></i>
                    ربط المحلات بالمناطق
                </div>
                
                <div class="message" id="mappingMessage"></div>
                
                <div class="form-group">
                    <label class="form-label">اختر منطقة لعرض المحلات المرتبطة</label>
                    <select class="form-control" id="mappingAreaSelect" onchange="showAreaShops()">
                        <option value="">-- اختر منطقة --</option>
                    </select>
                </div>
                
                <div id="areaShopsContainer" style="display: none;">
                    <h3 style="color: #2d3561; margin: 20px 0;">المحلات المرتبطة بالمنطقة:</h3>
                    <div id="areaShopsList"></div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px;">
                        <h4 style="color: #1565c0; margin-bottom: 15px;">
                            <i class="fas fa-info-circle"></i>
                            معلومات إضافية
                        </h4>
                        <div id="areaStatsContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Shop Modal -->
    <div id="shopModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="shopModalTitle">إضافة محل جديد</h3>
                <button class="modal-close" onclick="closeModal('shopModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editShopKey">
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">اسم المحل (عربي) *</label>
                        <input type="text" class="form-control" id="shopNameAr" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">اسم المحل (إنجليزي)</label>
                        <input type="text" class="form-control" id="shopNameEn">
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">رقم الرخصة *</label>
                        <input type="text" class="form-control" id="shopLicense" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">كود ADM</label>
                        <input type="text" class="form-control" id="shopAdmCode">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">المنطقة / العنوان *</label>
                    <select class="form-control" id="shopArea" required>
                        <option value="">-- اختر منطقة --</option>
                    </select>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">رقم الاتصال</label>
                        <input type="tel" class="form-control" id="shopContact">
                    </div>
                    <div class="form-group">
                        <label class="form-label">النشاط</label>
                        <input type="text" class="form-control" id="shopActivity">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">رابط الموقع (Google Maps)</label>
                    <input type="url" class="form-control" id="shopLocationMap">
                </div>
            </div>
            <div class="action-buttons" style="justify-content: flex-start; padding: 0 35px 25px;">
                <button class="btn btn-success" onclick="saveShop()">
                    <i class="fas fa-save"></i>
                    حفظ
                </button>
                <button class="btn btn-danger" onclick="closeModal('shopModal')">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Area Modal -->
    <div id="areaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="areaModalTitle">إضافة منطقة جديدة</h3>
                <button class="modal-close" onclick="closeModal('areaModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editAreaKey">
                <div class="form-group">
                    <label class="form-label">اسم المنطقة *</label>
                    <input type="text" class="form-control" id="areaName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">الوصف</label>
                    <textarea class="form-control" id="areaDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">الإحداثيات</label>
                    <input type="text" class="form-control" id="areaCoordinates" placeholder="24.xxx, 54.xxx">
                </div>
            </div>
            <div class="action-buttons" style="justify-content: flex-start; padding: 0 35px 25px;">
                <button class="btn btn-success" onclick="saveArea()">
                    <i class="fas fa-save"></i>
                    حفظ
                </button>
                <button class="btn btn-danger" onclick="closeModal('areaModal')">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Global Variables
        let shopsData = {};
        let areasData = [];
        let planData = null;
        const repo = 'aliabdelaal-adm/Monthly_inspection_plan';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
        });
        
        // Switch Tab
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.closest('.tab-button').classList.add('active');
            
            // Load data if needed
            if (tabName === 'shops' && Object.keys(shopsData).length === 0) {
                loadShopsData();
            } else if (tabName === 'areas' && areasData.length === 0) {
                loadAreasData();
            } else if (tabName === 'mapping') {
                loadMappingData();
            }
        }
        
        // Load All Data
        async function loadAllData() {
            try {
                await Promise.all([
                    loadShopsData(),
                    loadPlanData()
                ]);
                updateOverviewStats();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        // Load Shops Data
        async function loadShopsData() {
            showMessage('shopsMessage', 'info', 'جاري تحميل بيانات المحلات...');
            
            try {
                const response = await fetch('shops_details.json?' + new Date().getTime());
                if (!response.ok) {
                    throw new Error('فشل تحميل بيانات المحلات');
                }
                
                shopsData = await response.json();
                displayShopsTable();
                populateFilters();
                updateOverviewStats();
                showMessage('shopsMessage', 'success', '✅ تم تحميل بيانات المحلات بنجاح!');
                
                setTimeout(() => {
                    hideMessage('shopsMessage');
                }, 3000);
            } catch (error) {
                console.error('Error loading shops:', error);
                showMessage('shopsMessage', 'error', '❌ فشل تحميل بيانات المحلات: ' + error.message);
            }
        }
        
        // Load Plan Data
        async function loadPlanData() {
            try {
                const response = await fetch('plan-data.json?' + new Date().getTime());
                if (!response.ok) {
                    throw new Error('فشل تحميل plan-data.json');
                }
                
                planData = await response.json();
                extractAreasFromPlanData();
            } catch (error) {
                console.error('Error loading plan data:', error);
            }
        }
        
        // Extract Areas from Plan Data
        function extractAreasFromPlanData() {
            if (!planData || !planData.inspectionData) return;
            
            const areasSet = new Set();
            planData.inspectionData.forEach(inspection => {
                if (inspection.area) {
                    areasSet.add(inspection.area);
                }
            });
            
            areasData = Array.from(areasSet).sort();
        }
        
        // Display Shops Table
        function displayShopsTable() {
            const container = document.getElementById('shopsTableContainer');
            
            if (Object.keys(shopsData).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-store-slash"></i>
                        <h3>لا توجد محلات</h3>
                        <p>قم بإضافة محلات جديدة للبدء</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>اسم المحل</th>
                            <th>الرخصة</th>
                            <th>المنطقة</th>
                            <th>الاتصال</th>
                            <th>النشاط</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="shopsTableBody">
            `;
            
            for (const [key, shop] of Object.entries(shopsData)) {
                html += `
                    <tr data-shop-key="${escapeHtml(key)}" data-area="${escapeHtml(shop.address || '')}" 
                        data-activity="${escapeHtml(shop.activity || '')}">
                        <td>
                            <strong>${escapeHtml(shop.nameAr || key)}</strong>
                            ${shop.nameEn ? '<br><small>' + escapeHtml(shop.nameEn) + '</small>' : ''}
                        </td>
                        <td>${escapeHtml(shop.licenseNo || '-')}</td>
                        <td>
                            <span class="badge badge-info">${escapeHtml(shop.address || 'غير محدد')}</span>
                        </td>
                        <td>${escapeHtml(shop.contact || '-')}</td>
                        <td>${escapeHtml(shop.activity || '-')}</td>
                        <td>
                            <i class="fas fa-edit action-icon edit-icon" 
                               onclick="editShop('${escapeHtml(key)}')" 
                               title="تعديل"></i>
                            <i class="fas fa-trash action-icon delete-icon" 
                               onclick="deleteShop('${escapeHtml(key)}')" 
                               title="حذف"></i>
                            <i class="fas fa-eye action-icon view-icon" 
                               onclick="viewShop('${escapeHtml(key)}')" 
                               title="عرض"></i>
                        </td>
                    </tr>
                `;
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // Populate Filters
        function populateFilters() {
            // Extract unique areas and activities
            const areas = new Set();
            const activities = new Set();
            
            Object.values(shopsData).forEach(shop => {
                if (shop.address) areas.add(shop.address);
                if (shop.activity) activities.add(shop.activity);
            });
            
            // Populate area filter
            const areaFilter = document.getElementById('shopsAreaFilter');
            const shopArea = document.getElementById('shopArea');
            const mappingAreaSelect = document.getElementById('mappingAreaSelect');
            
            [areaFilter, shopArea, mappingAreaSelect].forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-- اختر منطقة --</option>';
                    Array.from(areas).sort().forEach(area => {
                        const option = document.createElement('option');
                        option.value = area;
                        option.textContent = area;
                        select.appendChild(option);
                    });
                    if (currentValue) select.value = currentValue;
                }
            });
            
            // Populate activity filter
            const activityFilter = document.getElementById('shopsActivityFilter');
            activityFilter.innerHTML = '<option value="">جميع الأنشطة</option>';
            Array.from(activities).sort().forEach(activity => {
                const option = document.createElement('option');
                option.value = activity;
                option.textContent = activity;
                activityFilter.appendChild(option);
            });
        }
        
        // Filter Shops Table
        function filterShopsTable() {
            const searchText = document.getElementById('shopsSearchInput').value.toLowerCase();
            const areaFilter = document.getElementById('shopsAreaFilter').value;
            const activityFilter = document.getElementById('shopsActivityFilter').value;
            
            const rows = document.querySelectorAll('#shopsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const area = row.dataset.area;
                const activity = row.dataset.activity;
                
                const matchesSearch = text.includes(searchText);
                const matchesArea = !areaFilter || area === areaFilter;
                const matchesActivity = !activityFilter || activity === activityFilter;
                
                row.style.display = matchesSearch && matchesArea && matchesActivity ? '' : 'none';
            });
        }
        
        // Show Add Shop Modal
        function showAddShopModal() {
            document.getElementById('shopModalTitle').textContent = 'إضافة محل جديد';
            document.getElementById('editShopKey').value = '';
            document.getElementById('shopNameAr').value = '';
            document.getElementById('shopNameEn').value = '';
            document.getElementById('shopLicense').value = '';
            document.getElementById('shopAdmCode').value = 'ADM' + Date.now().toString().slice(-4);
            document.getElementById('shopArea').value = '';
            document.getElementById('shopContact').value = '';
            document.getElementById('shopActivity').value = '';
            document.getElementById('shopLocationMap').value = '';
            
            populateFilters();
            document.getElementById('shopModal').classList.add('show');
        }
        
        // Edit Shop
        function editShop(shopKey) {
            const shop = shopsData[shopKey];
            if (!shop) return;
            
            document.getElementById('shopModalTitle').textContent = 'تعديل محل';
            document.getElementById('editShopKey').value = shopKey;
            document.getElementById('shopNameAr').value = shop.nameAr || '';
            document.getElementById('shopNameEn').value = shop.nameEn || '';
            document.getElementById('shopLicense').value = shop.licenseNo || '';
            document.getElementById('shopAdmCode').value = shop.admCode || '';
            document.getElementById('shopArea').value = shop.address || '';
            document.getElementById('shopContact').value = shop.contact || '';
            document.getElementById('shopActivity').value = shop.activity || '';
            document.getElementById('shopLocationMap').value = shop.locationMap || '';
            
            populateFilters();
            document.getElementById('shopModal').classList.add('show');
        }
        
        // Save Shop
        function saveShop() {
            const nameAr = document.getElementById('shopNameAr').value.trim();
            const nameEn = document.getElementById('shopNameEn').value.trim();
            const license = document.getElementById('shopLicense').value.trim();
            const admCode = document.getElementById('shopAdmCode').value.trim();
            const area = document.getElementById('shopArea').value.trim();
            const contact = document.getElementById('shopContact').value.trim();
            const activity = document.getElementById('shopActivity').value.trim();
            const locationMap = document.getElementById('shopLocationMap').value.trim();
            
            if (!nameAr) {
                alert('❌ يرجى إدخال اسم المحل بالعربي!');
                return;
            }
            
            if (!license) {
                alert('❌ يرجى إدخال رقم الرخصة!');
                return;
            }
            
            if (!area) {
                alert('❌ يرجى اختيار المنطقة!');
                return;
            }
            
            const editKey = document.getElementById('editShopKey').value;
            const shopKey = editKey || nameAr;
            
            shopsData[shopKey] = {
                nameAr: nameAr,
                nameEn: nameEn,
                licenseNo: license,
                admCode: admCode,
                address: area,
                contact: contact,
                activity: activity,
                locationMap: locationMap
            };
            
            displayShopsTable();
            populateFilters();
            updateOverviewStats();
            closeModal('shopModal');
            
            showMessage('shopsMessage', 'success', 
                `✅ تم ${editKey ? 'تعديل' : 'إضافة'} المحل "${nameAr}" بنجاح! لا تنسى حفظ التغييرات.`);
        }
        
        // Delete Shop
        function deleteShop(shopKey) {
            const shop = shopsData[shopKey];
            if (!shop) return;
            
            if (!confirm(`⚠️ هل أنت متأكد من حذف المحل "${shop.nameAr || shopKey}"؟\n\nهذا الإجراء لا يمكن التراجع عنه!`)) {
                return;
            }
            
            delete shopsData[shopKey];
            displayShopsTable();
            populateFilters();
            updateOverviewStats();
            
            showMessage('shopsMessage', 'success', 
                `✅ تم حذف المحل "${shop.nameAr || shopKey}" بنجاح! لا تنسى حفظ التغييرات.`);
        }
        
        // View Shop
        function viewShop(shopKey) {
            const shop = shopsData[shopKey];
            if (!shop) return;
            
            let details = `📋 معلومات المحل: ${shop.nameAr || shopKey}\n\n`;
            details += `🏷️ الاسم بالعربي: ${shop.nameAr || '-'}\n`;
            details += `🏷️ الاسم بالإنجليزي: ${shop.nameEn || '-'}\n`;
            details += `📜 رقم الرخصة: ${shop.licenseNo || '-'}\n`;
            details += `🔖 كود ADM: ${shop.admCode || '-'}\n`;
            details += `📍 المنطقة: ${shop.address || '-'}\n`;
            details += `📞 الاتصال: ${shop.contact || '-'}\n`;
            details += `🏢 النشاط: ${shop.activity || '-'}\n`;
            if (shop.locationMap) {
                details += `🗺️ الموقع: ${shop.locationMap}\n`;
            }
            
            alert(details);
        }
        
        // Save Shops Data to GitHub
        async function saveShopsData() {
            if (!confirm('هل تريد حفظ جميع التغييرات في GitHub؟')) {
                return;
            }
            
            const token = prompt('أدخل GitHub Token الخاص بك:');
            if (!token) return;
            
            showMessage('shopsMessage', 'info', '⏳ جاري حفظ البيانات في GitHub...');
            
            try {
                // Get current file SHA
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getRes.ok) {
                    throw new Error('فشل الحصول على ملف shops_details.json');
                }
                
                const file = await getRes.json();
                const sha = file.sha;
                
                // Prepare content
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(shopsData, null, 2))));
                
                // Update file
                const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/shops_details.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'تحديث بيانات المحلات من اللوحة الذكية',
                        content: content,
                        sha: sha
                    })
                });
                
                if (!updateRes.ok) {
                    throw new Error('فشل تحديث ملف shops_details.json');
                }
                
                showMessage('shopsMessage', 'success', '✅ تم حفظ البيانات في GitHub بنجاح!');
            } catch (error) {
                console.error('Error saving shops data:', error);
                showMessage('shopsMessage', 'error', '❌ فشل حفظ البيانات: ' + error.message);
            }
        }
        
        // Load Areas Data
        function loadAreasData() {
            showMessage('areasMessage', 'info', 'جاري تحميل بيانات المناطق...');
            extractAreasFromPlanData();
            displayAreasTable();
            showMessage('areasMessage', 'success', '✅ تم تحميل بيانات المناطق بنجاح!');
            
            setTimeout(() => {
                hideMessage('areasMessage');
            }, 3000);
        }
        
        // Display Areas Table
        function displayAreasTable() {
            const container = document.getElementById('areasTableContainer');
            
            if (areasData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-map-marked-slash"></i>
                        <h3>لا توجد مناطق</h3>
                        <p>المناطق يتم استخراجها من بيانات التفتيش</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>اسم المنطقة</th>
                            <th>عدد المحلات</th>
                            <th>عدد التفتيشات</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="areasTableBody">
            `;
            
            areasData.forEach(area => {
                const shopsCount = Object.values(shopsData).filter(shop => shop.address === area).length;
                const inspectionsCount = planData ? 
                    planData.inspectionData.filter(i => i.area === area).length : 0;
                
                html += `
                    <tr data-area="${escapeHtml(area)}">
                        <td><strong>${escapeHtml(area)}</strong></td>
                        <td><span class="badge badge-info">${shopsCount}</span></td>
                        <td><span class="badge badge-success">${inspectionsCount}</span></td>
                        <td>
                            <i class="fas fa-edit action-icon edit-icon" 
                               onclick="editArea('${escapeHtml(area)}')" 
                               title="تعديل"></i>
                            <i class="fas fa-eye action-icon view-icon" 
                               onclick="viewAreaDetails('${escapeHtml(area)}')" 
                               title="عرض"></i>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // Filter Areas Table
        function filterAreasTable() {
            const searchText = document.getElementById('areasSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#areasTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchText) ? '' : 'none';
            });
        }
        
        // Show Add Area Modal
        function showAddAreaModal() {
            document.getElementById('areaModalTitle').textContent = 'إضافة منطقة جديدة';
            document.getElementById('editAreaKey').value = '';
            document.getElementById('areaName').value = '';
            document.getElementById('areaDescription').value = '';
            document.getElementById('areaCoordinates').value = '';
            
            document.getElementById('areaModal').classList.add('show');
        }
        
        // Edit Area
        function editArea(areaName) {
            document.getElementById('areaModalTitle').textContent = 'تعديل منطقة';
            document.getElementById('editAreaKey').value = areaName;
            document.getElementById('areaName').value = areaName;
            document.getElementById('areaDescription').value = '';
            document.getElementById('areaCoordinates').value = '';
            
            document.getElementById('areaModal').classList.add('show');
        }
        
        // Save Area
        function saveArea() {
            const name = document.getElementById('areaName').value.trim();
            
            if (!name) {
                alert('❌ يرجى إدخال اسم المنطقة!');
                return;
            }
            
            const editKey = document.getElementById('editAreaKey').value;
            
            if (editKey && editKey !== name) {
                // Rename area in all shops
                Object.values(shopsData).forEach(shop => {
                    if (shop.address === editKey) {
                        shop.address = name;
                    }
                });
                
                // Remove old area and add new one
                const index = areasData.indexOf(editKey);
                if (index > -1) {
                    areasData[index] = name;
                }
            } else if (!editKey) {
                // Add new area
                if (!areasData.includes(name)) {
                    areasData.push(name);
                    areasData.sort();
                }
            }
            
            displayAreasTable();
            populateFilters();
            updateOverviewStats();
            closeModal('areaModal');
            
            showMessage('areasMessage', 'success', 
                `✅ تم ${editKey ? 'تعديل' : 'إضافة'} المنطقة "${name}" بنجاح!`);
        }
        
        // View Area Details
        function viewAreaDetails(areaName) {
            const shops = Object.entries(shopsData).filter(([key, shop]) => shop.address === areaName);
            const inspections = planData ? 
                planData.inspectionData.filter(i => i.area === areaName) : [];
            
            let details = `📋 معلومات المنطقة: ${areaName}\n\n`;
            details += `🏪 عدد المحلات: ${shops.length}\n`;
            details += `🔍 عدد التفتيشات: ${inspections.length}\n\n`;
            
            if (shops.length > 0) {
                details += `المحلات:\n`;
                shops.forEach(([key, shop], index) => {
                    details += `${index + 1}. ${shop.nameAr || key}\n`;
                });
            }
            
            alert(details);
        }
        
        // Load Mapping Data
        function loadMappingData() {
            populateFilters();
        }
        
        // Show Area Shops
        function showAreaShops() {
            const area = document.getElementById('mappingAreaSelect').value;
            const container = document.getElementById('areaShopsContainer');
            const listContainer = document.getElementById('areaShopsList');
            const statsContainer = document.getElementById('areaStatsContainer');
            
            if (!area) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            // Get shops in this area
            const shops = Object.entries(shopsData).filter(([key, shop]) => shop.address === area);
            
            if (shops.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-store-slash"></i>
                        <p>لا توجد محلات في هذه المنطقة</p>
                    </div>
                `;
            } else {
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">';
                shops.forEach(([key, shop]) => {
                    html += `
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #e0e0e0;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">${escapeHtml(shop.nameAr || key)}</h4>
                            <p><strong>الرخصة:</strong> ${escapeHtml(shop.licenseNo || '-')}</p>
                            <p><strong>الاتصال:</strong> ${escapeHtml(shop.contact || '-')}</p>
                            <p><strong>النشاط:</strong> ${escapeHtml(shop.activity || '-')}</p>
                        </div>
                    `;
                });
                html += '</div>';
                listContainer.innerHTML = html;
            }
            
            // Show stats
            const inspections = planData ? 
                planData.inspectionData.filter(i => i.area === area) : [];
            
            statsContainer.innerHTML = `
                <p><strong>📊 عدد المحلات:</strong> ${shops.length}</p>
                <p><strong>🔍 عدد التفتيشات:</strong> ${inspections.length}</p>
                <p><strong>✅ نسبة التغطية:</strong> ${shops.length > 0 ? '100%' : '0%'}</p>
            `;
        }
        
        // Update Overview Stats
        function updateOverviewStats() {
            const totalShops = Object.keys(shopsData).length;
            const totalAreas = areasData.length;
            const linkedShops = Object.values(shopsData).filter(shop => shop.address).length;
            const unlinkedShops = totalShops - linkedShops;
            
            document.getElementById('totalShopsCount').textContent = totalShops;
            document.getElementById('totalAreasCount').textContent = totalAreas;
            document.getElementById('linkedShopsCount').textContent = linkedShops;
            document.getElementById('unlinkedShopsCount').textContent = unlinkedShops;
        }
        
        // Show Message
        function showMessage(elementId, type, message) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            el.className = `message ${type} show`;
            el.textContent = message;
        }
        
        // Hide Message
        function hideMessage(elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            el.classList.remove('show');
        }
        
        // Close Modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        
        // Escape HTML
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
