<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>خطة التفتيش الشهرية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- مكتبات الحفظ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Cairo', Arial, sans-serif; background: #f7f9fc; margin:0;}
        .main-container {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 2px 16px #dadce0;
            padding: 36px 18px 24px 18px;
            max-width: 900px;
            min-width:320px;
            margin: 64px auto 0 auto;
            display: flex; flex-direction: column; align-items: center;
        }
        .header-top-bar {
            width:100%;
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom: 8px;
            position: relative;
        }
        .last-update-row {
            color: #666;
            font-size: 0.97em;
            margin-right: 8px;
            margin-top: 0;
            text-align: right;
            direction: ltr;
        }
        .bell-container {
            margin-left:8px;
            margin-top:0;
        }
        .bell-btn {
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
            padding: 0;
        }
        .bell-icon {
            width: 38px;
            height: 38px;
            fill: #ffc107;
            transition: fill 0.2s;
        }
        .bell-btn:hover .bell-icon {
            fill: #ff9800;
        }
        .horizontal-line {
            width: 100%;
            border: none;
            border-top: 1.5px solid #e0e3ea;
            margin: 16px 0 0 0;
        }
        .title-bar {
            width:100%;
            display:flex;
            justify-content:center;
            align-items:center;
            margin-top: 18px;
            margin-bottom: 24px;
        }
        .main-title-box {
            background:#234085;
            color:#fff;
            padding:28px 0 28px 0;
            border-radius:14px;
            width: 96%;
            max-width: 600px;
            min-height: 56px;
            font-size:2.12em;
            text-align:center;
            font-weight: bold;
            letter-spacing: 1px;
            margin:0 auto;
            box-shadow:0 2px 14px #e0e2f5;
        }
        .dropdown-section {margin: 10px 0 22px 0; width: 100%; display:flex;justify-content:center;align-items:center;gap:8px;}
        select, input[type="text"] {padding:7px 16px;font-size:1em;border-radius:6px;border:1px solid #b6b6b6;min-width:170px;}
        .actions-row {width:100%;display:flex;justify-content:center;align-items:center;gap:18px;margin:20px 0 18px;}
        .save-box, .report-box {display:flex;gap:12px;}
        .save-box button, .report-box button {padding:10px 28px;border-radius:8px;border:none;cursor:pointer;font-size:1em;}
        .pdf-btn {background:#d63384;color:#fff;}
        .excel-btn {background:#198754;color:#fff;}
        .inspector-report-btn {background:#234085;color:#fff;}
        .monthly-report-btn {background:#ff9800;color:#fff;}
        .plan-table-container {width:100%;margin:18px 0;}
        .plan-table {width:100%;border-collapse:collapse;border-radius:13px;overflow:hidden;box-shadow:0 2px 14px #eee;}
        .plan-table th,.plan-table td {padding:10px 8px;text-align:center;}
        .plan-table th {
            background:#234085;
            color:#fff;
            font-weight:bold;
            font-size:1.12em;
        }
        .plan-table tr:nth-child(even) {background:#f5f7fb;}
        .plan-table td {
            border-bottom:1px solid #d7dcef;
            font-size:1em;
        }
        .dropdown-shops-btn {
            background:#234085;
            color:#fff;
            border:none;
            border-radius:6px;
            padding:6px 18px;
            cursor:pointer;
            font-size:0.98em;
            min-width:90px;
        }
        .shops-dropdown-list {
            display:none;
            position:fixed;
            background:#fff;
            border:1px solid #23408577;
            border-radius:9px;
            margin-top:5px;
            min-width:130px;
            max-height:210px;
            box-shadow:0 2px 14px #eaeaea;
            z-index:1000;
            right:unset;
            left:unset;
            text-align:right;
            overflow-y:auto;
        }
        .shops-dropdown-list ul {
            list-style: none;
            margin:0; padding:7px 5px;
        }
        .shops-dropdown-list ul li {
            padding:3px 0 3px 0;
            border-bottom:1px solid #eee;
            font-size:0.97em;
        }
        .shops-dropdown-list ul li:last-child {border-bottom:none;}
        .shops-dropdown-wrap {position:relative; display:inline-block;}
        .inspector-report-div {margin:16px 0 0 0;background:#f7f9fc;border-radius:10px;padding:18px 12px;width:100%;color:#234085;font-size:1.1em;box-shadow:0 1px 5px #e2e2e2;}
        .modal-overlay {
            display:none; position:fixed;z-index:9999;right:0;left:0;top:0;bottom:0; background:rgba(0,0,0,0.18);align-items:center;justify-content:center;
        }
        .modal-content {
            background:#fff; border-radius:16px; box-shadow:0 2px 16px #23409333;
            padding:32px 18px; margin:50px auto; max-width:95vw; min-width:70vw; position:relative; text-align:center;
        }
        .modal-content button.close-btn {
            position:absolute; left:10px; top:10px; border:none; background:#d32f2f; color:#fff; border-radius:50%; font-size:1.4em;width:38px;height:38px;cursor:pointer;
        }
        .modal-actions {
            margin: 16px 0 0 0;
            display:flex;
            justify-content:center;
            gap:10px;
        }
        .stats-title {color:#134093;font-size:1.18em;text-align:center;margin-bottom:15px;}
        .stats-table {width:100%;border-collapse:collapse;margin-bottom:0;font-size:1.04em;}
        .stats-table th, .stats-table td {border:1px solid #234093;padding:10px 6px;text-align:center;}
        .stats-table th {background:#234093;color:#fff;}
        .stats-table tr:nth-child(even) {background:#f3f5fa;}
        .footer {text-align:center;margin-top:22px;color:#234085;font-size:0.85em;}
        .red-total {
            color: #d32f2f !important;
            font-weight: bold !important;
            background: #fffbe9;
        }
        .pdf-title-arabic {
            font-size: 1.18em;
            text-align: center;
            color: #234085;
            font-weight: bold;
            margin-bottom: 10px;
            width: 100%;
            margin-top: 0;
        }
        @media (max-width:600px) {
            .main-container {padding:10px 1vw 7px 1vw;}
            .main-title-box {font-size:1em;padding:16px 0;}
            .plan-table th, .plan-table td {padding:7px 2px;font-size:0.94em;}
            .dropdown-shops-btn {padding:4px 8px;font-size:0.91em;}
            .modal-content {padding:10px 2vw; min-width:unset; max-width:99vw;}
            .stats-table th, .stats-table td {padding:7px 2px;}
            .actions-row {gap:7px;}
        }
    </style>
</head>
<body>
<div class="main-container">
    <div class="header-top-bar">
        <div class="bell-container">
            <button class="bell-btn" id="bellBtn" title="تنبيه صوتي">
                <svg class="bell-icon" id="bellIcon" viewBox="0 0 24 24">
                  <path d="M12 24c1.3 0 2.4-1 2.5-2.3h-5c.1 1.3 1.2 2.3 2.5 2.3zm7-6v-5c0-3.1-1.6-5.6-4.5-6.3V6c0-.8-.7-1.5-1.5-1.5S11.5 5.2 11.5 6v.7C8.6 7.4 7 9.9 7 13v5l-2 2v1h16v-1l-2-2z"/>
                </svg>
            </button>
            <audio id="birdSound">
              <source src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfa93e3.mp3" type="audio/mp3">
            </audio>
        </div>
        <div class="last-update-row" id="lastUpdateRow"></div>
    </div>
    <hr class="horizontal-line">
    <div class="title-bar">
        <div class="main-title-box">خطة التفتيش الشهرية</div>
    </div>
    <div class="dropdown-section">
        <label for="inspectorSelect">اختر اسم المفتش :</label>
        <select id="inspectorSelect">
            <option value="">-- جاري التحميل --</option>
        </select>
    </div>
    <div id="planTableContainer" class="plan-table-container"></div>
    <div class="actions-row">
        <div class="save-box">
            <button class="pdf-btn" onclick="exportTableToPDF()">حفظ كـ PDF</button>
            <button class="excel-btn" onclick="exportTableToExcel()">حفظ كـ Excel</button>
        </div>
        <div class="report-box">
            <button class="inspector-report-btn" onclick="showInspectorReport()">تقرير المفتش</button>
            <button class="monthly-report-btn" onclick="showMonthlyReport()">التقرير الشهري</button>
        </div>
    </div>
    <div id="inspectorReportDiv" class="inspector-report-div" style="display:none;"></div>
    <div id="monthlyReportModal" class="modal-overlay">
      <div class="modal-content">
        <button class="close-btn" onclick="closeMonthlyReportModal()">×</button>
        <div class="stats-title">التقرير الشهري</div>
        <div class="modal-actions">
            <button class="pdf-btn" onclick="exportMonthlyReportToPDF()">حفظ التقرير كـ PDF</button>
            <button class="excel-btn" onclick="exportMonthlyReportToExcel()">حفظ التقرير كـ Excel</button>
        </div>
        <div id="monthlyReportContent"></div>
      </div>
    </div>
    <div class="footer">
        تم التطوير بواسطة &copy; المطور د. علي عبدالعال
    </div>
</div>
<script>
    // الربط مع خطة التفتيش الشهرية.json على GitHub
    const PLAN_URL = "https://raw.githubusercontent.com/aliabdelaal-adm/Monthly_inspection_plan/main/%D8%AE%D8%B7%D8%A9%20%D8%A7%D9%84%D8%AA%D9%81%D8%AA%D9%8A%D8%B4%20%D8%A7%D9%84%D8%B4%D9%87%D8%B1%D9%8A%D8%A9.json?" + Date.now();
    let planData = null; // البيانات الكاملة للخطة
    let inspectors = []; // أسماء المفتشين
    let inspectionData = []; // جدول التوزيع
    let selectedInspector = null;

    // جلب البيانات من GitHub عند تحميل الصفحة
    function fetchPlanData() {
        fetch(PLAN_URL)
        .then(r => r.json())
        .then(data => {
            planData = data;
            inspectors = Array.isArray(planData.inspectors) ? planData.inspectors : [];
            inspectionData = Array.isArray(planData.distribution) ? planData.distribution : [];
            fillInspectorsDropdown();
            setLastUpdateDate();
        })
        .catch(err => {
            document.getElementById('inspectorSelect').innerHTML = '<option value="">تعذّر تحميل البيانات!</option>';
            document.getElementById('planTableContainer').innerHTML = '<div style="color:#c00;text-align:center;font-weight:bold;margin:25px 0;">تعذّر تحميل بيانات الخطة من GitHub.</div>';
        });
    }

    // تحديث التاريخ تلقائي حسب آخر تحديث (من planData أو من الآن)
    function setLastUpdateDate() {
        let row = document.getElementById('lastUpdateRow');
        if (planData && planData.updated_at) {
            let d = new Date(planData.updated_at);
            let year = d.getFullYear();
            let month = String(d.getMonth()+1).padStart(2,'0');
            let day = String(d.getDate()).padStart(2,'0');
            let hours = d.getHours();
            let minutes = String(d.getMinutes()).padStart(2,'0');
            let period = hours >= 12 ? 'مساءً' : 'صباحًا';
            let hour12 = hours % 12; if (hour12 === 0) hour12 = 12;
            let timeStr = hour12 + ':' + minutes + ' ' + period;
            let dateStr = year+'-'+month+'-'+day;
            row.textContent = "آخر تعديل للخطة: " + dateStr + "    " + timeStr;
        } else {
            // في حال عدم وجود updated_at، استخدم الآن
            let today = new Date();
            let year = today.getFullYear();
            let month = String(today.getMonth()+1).padStart(2,'0');
            let day = String(today.getDate()).padStart(2,'0');
            let hours = today.getHours();
            let minutes = String(today.getMinutes()).padStart(2,'0');
            let period = hours >= 12 ? 'مساءً' : 'صباحًا';
            let hour12 = hours % 12; if (hour12 === 0) hour12 = 12;
            let timeStr = hour12 + ':' + minutes + ' ' + period;
            let dateStr = year+'-'+month+'-'+day;
            row.textContent = "آخر دخول: " + dateStr + "    " + timeStr;
        }
    }

    // تعبئة قائمة المفتشين من البيانات
    function fillInspectorsDropdown() {
        const select = document.getElementById('inspectorSelect');
        select.innerHTML = '<option value="">-- اختر المفتش --</option>';
        inspectors.forEach((name, idx) => {
            select.innerHTML += `<option value="${idx}">${name}</option>`;
        });
    }

    // عند اختيار المفتش
    document.getElementById('inspectorSelect').addEventListener('change', function() {
        let idx = this.value;
        if (idx === "" || !inspectors[idx]) {
            selectedInspector = null;
            document.getElementById('planTableContainer').innerHTML = '';
            document.getElementById('inspectorReportDiv').style.display = "none";
            return;
        }
        selectedInspector = inspectors[idx];
        renderPlanTable(selectedInspector);
        document.getElementById('inspectorReportDiv').style.display = "none";
    });

    // عرض خطة المفتش كجدول
    function renderPlanTable(inspectorName) {
        const container = document.getElementById('planTableContainer');
        if (!inspectorName) { container.innerHTML = ''; selectedInspector = null; return; }
        // تشغيل صوت الطيور عند كل اختيار
        playBirdSoundAuto();
        const rows = inspectionData.filter(item => item.inspector === inspectorName);
        if (rows.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#c00;font-weight:bold;margin:30px 0;">لا توجد خطة تفتيش لهذا المفتش.</div>';
            return;
        }
        let html = `
        <div id="pdfTitleBox" class="pdf-title-arabic">خطة التفتيش الشهرية للمفتش: ${inspectorName}</div>
        <table class="plan-table" id="inspectorPlanTable">
            <thead>
                <tr>
                    <th>اسم المفتش</th>
                    <th>اليوم</th>
                    <th>وقت المناوبة</th>
                    <th>المنطقة</th>
                    <th>المحلات</th>
                </tr>
            </thead>
            <tbody>
        `;
        rows.forEach((row, idx) => {
            html += `
                <tr>
                    <td>${row.inspector}</td>
                    <td>${row.day}</td>
                    <td>${row.shift}</td>
                    <td>${row.area}</td>
                    <td>
                        <div class="shops-dropdown-wrap" id="shopsDropdownWrap${idx}">
                            <button class="dropdown-shops-btn" onclick="toggleShopsDropdown(event, ${idx})">عرض المحلات</button>
                            <div class="shops-dropdown-list" id="shopsDropdownList${idx}">
                                <ul>
                                    ${(row.shops||[]).map(shop=>`<li>${shop}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    // قائمة المحلات المنسدلة
    window.toggleShopsDropdown = function(event, idx) {
        event.stopPropagation();
        document.querySelectorAll('.shops-dropdown-list').forEach((el,i)=>{
            if(i!==idx) el.style.display='none';
        });
        let btn = event.target;
        let rect = btn.getBoundingClientRect();
        let list = document.getElementById('shopsDropdownList'+idx);
        list.style.display = 'block';
        let top = rect.bottom + window.scrollY + 2;
        let left = rect.right - list.offsetWidth + window.scrollX;
        if ((top + list.offsetHeight) > (window.innerHeight + window.scrollY)) {
            top = rect.top + window.scrollY - list.offsetHeight - 2;
        }
        list.style.top = top+"px";
        list.style.left = (rect.left + window.scrollX) + "px";
    };
    document.addEventListener('click', function(e){
        if (![...document.querySelectorAll('.shops-dropdown-wrap *')].includes(e.target)) {
            document.querySelectorAll('.shops-dropdown-list').forEach(el=>el.style.display='none');
        }
    });

    // تشغيل صوت العصافير تلقائي عند عرض خطة المفتش
    function playBirdSoundAuto() {
        let audio = document.getElementById('birdSound');
        audio.currentTime = 0;
        audio.play();
        setTimeout(()=>{ audio.pause(); }, 7000);
    }
    // دعم تشغيل الصوت عند الضغط على الجرس
    document.getElementById('bellBtn').addEventListener('click', playBirdSound);
    function playBirdSound() {
        var audio = document.getElementById('birdSound');
        if (!audio) return;
        audio.currentTime = 0;
        audio.play();
        setTimeout(function(){ audio.pause(); }, 7000);
    }
    // ربط الصوت بأول تفاعل فقط (مرة واحدة فقط)
    function enableBirdSoundOnFirstInteraction() {
        function handler() {
            playBirdSound();
            window.removeEventListener('click', handler, true);
            window.removeEventListener('keydown', handler, true);
            window.removeEventListener('touchstart', handler, true);
            window.removeEventListener('change', handler, true);
        }
        window.addEventListener('click', handler, true);
        window.addEventListener('keydown', handler, true);
        window.addEventListener('touchstart', handler, true);
        window.addEventListener('change', handler, true);
    }
    document.addEventListener('DOMContentLoaded', enableBirdSoundOnFirstInteraction);

    // تصدير خطة المفتش PDF
    function exportTableToPDF() {
        let inspectorName = selectedInspector;
        if (!inspectorName) { alert("يرجى اختيار مفتش أولاً."); return; }
        let titleBox = document.getElementById('pdfTitleBox');
        let table = document.getElementById('inspectorPlanTable');
        if (!table || !titleBox) { alert("لا يوجد جدول للتصدير"); return; }
        let wrap = document.createElement('div');
        wrap.style.background = '#fff';
        wrap.style.padding = '18px';
        wrap.style.width = table.offsetWidth + 'px';
        let titleClone = titleBox.cloneNode(true);
        let tableClone = table.cloneNode(true);
        tableClone.style.marginTop = '10px';
        wrap.appendChild(titleClone);
        wrap.appendChild(tableClone);
        document.body.appendChild(wrap);

        html2canvas(wrap, {backgroundColor:'#fff', scale:2}).then(function(canvas) {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({orientation:"landscape",unit:"pt",format:"a4"});
            let pageWidth = doc.internal.pageSize.getWidth();
            let imgProps = doc.getImageProperties(imgData);
            let pdfWidth = pageWidth - 80;
            let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            doc.addImage(imgData, 'PNG', 40, 35, pdfWidth, pdfHeight);
            doc.save(`خطة_${inspectorName}.pdf`);
            document.body.removeChild(wrap);
        });
    }
    // تصدير خطة المفتش Excel
    function exportTableToExcel() {
        let inspectorName = selectedInspector;
        if (!inspectorName) { alert("يرجى اختيار مفتش أولاً."); return; }
        let rows = inspectionData.filter(item => item.inspector === inspectorName);
        let ws_data = [["اليوم", "وقت المناوبة", "المنطقة", "المحلات"]];
        rows.forEach(row=>{
            ws_data.push([
                row.day,
                row.shift,
                row.area,
                (row.shops||[]).join(", ")
            ]);
        });
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "الخطة");
        XLSX.writeFile(wb, `خطة_${inspectorName}.xlsx`);
    }
    // تقرير المفتش المختار
    function showInspectorReport() {
        let inspectorName = selectedInspector;
        if (!inspectorName) { alert("يرجى اختيار مفتش أولاً."); return; }
        const div = document.getElementById('inspectorReportDiv');
        const rows = inspectionData.filter(item => item.inspector === inspectorName);
        let total = rows.length;
        let morning = rows.filter(r => r.shift === "صباحية").length;
        let evening = rows.filter(r => r.shift === "مسائية").length;
        let weekend = rows.filter(r => {
            const dayOfWeek = new Date(r.day).getDay();
            return [5,6,0].includes(dayOfWeek);
        }).length;
        let table = `
        <div class="pdf-title-arabic" id="inspectorReportTitle">تقرير المفتش: ${inspectorName}</div>
        <div class="save-box" style="margin-bottom:8px;">
            <button class="pdf-btn" onclick="exportInspectorReportToPDF()">حفظ التقرير كـ PDF</button>
            <button class="excel-btn" onclick="exportInspectorReportToExcel()">حفظ التقرير كـ Excel</button>
        </div>
        <table class="stats-table" id="inspectorStatsTable">
            <thead>
                <tr>
                    <th>عدد التفتيشات</th>
                    <th>الصباحية</th>
                    <th>المسائية</th>
                    <th>العطلة</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>${total}</td>
                    <td>${morning}</td>
                    <td>${evening}</td>
                    <td>${weekend}</td>
                </tr>
            </tbody>
        </table>
        `;
        div.innerHTML = table;
        div.style.display = "block";
    }
    // تصدير تقرير المفتش PDF
    function exportInspectorReportToPDF() {
        let inspectorName = selectedInspector;
        if (!inspectorName) return;
        let titleBox = document.getElementById('inspectorReportTitle');
        let table = document.getElementById('inspectorStatsTable');
        if (!table || !titleBox) return;
        let wrap = document.createElement('div');
        wrap.style.background = '#fff';
        wrap.style.padding = '18px';
        wrap.style.width = table.offsetWidth + 'px';
        let titleClone = titleBox.cloneNode(true);
        let tableClone = table.cloneNode(true);
        tableClone.style.marginTop = '10px';
        wrap.appendChild(titleClone);
        wrap.appendChild(tableClone);
        document.body.appendChild(wrap);

        html2canvas(wrap, {backgroundColor:'#fff', scale:2}).then(function(canvas){
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({orientation:"p",unit:"pt",format:"a4"});
            let pageWidth = doc.internal.pageSize.getWidth();
            let imgProps = doc.getImageProperties(imgData);
            let pdfWidth = pageWidth - 80;
            let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            doc.addImage(imgData, 'PNG', 40, 35, pdfWidth, pdfHeight);
            doc.save(`تقرير_${inspectorName}.pdf`);
            document.body.removeChild(wrap);
        });
    }
    // تصدير تقرير المفتش Excel
    function exportInspectorReportToExcel() {
        let inspectorName = selectedInspector;
        if (!inspectorName) return;
        let rows = inspectionData.filter(item => item.inspector === inspectorName);
        let total = rows.length;
        let morning = rows.filter(r => r.shift === "صباحية").length;
        let evening = rows.filter(r => r.shift === "مسائية").length;
        let weekend = rows.filter(r => {
            const dayOfWeek = new Date(r.day).getDay();
            return [5,6,0].includes(dayOfWeek);
        }).length;
        let ws_data = [["عدد التفتيشات", "الصباحية", "المسائية", "العطلة"], [total, morning, evening, weekend]];
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "تقرير المفتش");
        XLSX.writeFile(wb, `تقرير_${inspectorName}.xlsx`);
    }
    // تقرير شهري
    function showMonthlyReport() {
        let allDays = Array.from(new Set(inspectionData.map(r => r.day))).sort();
        let html = `<div class="pdf-title-arabic" id="monthlyReportTitle">التقرير الشهري</div>`;
        html += `<table class="stats-table" id="monthlyStatsTable"><thead><tr>
            <th>المفتش</th>`;
        allDays.forEach(day => html += `<th>${day}</th>`);
        html += `<th>الإجمالي</th><th>الصباحية</th><th>المسائية</th><th>العطلة</th></tr></thead><tbody>`;
        let totals = { total:0, morning:0, evening:0, weekend:0, days: Array(allDays.length).fill(0) };
        inspectors.forEach(inspector => {
            const rows = inspectionData.filter(item => item.inspector === inspector);
            html += `<tr><td>${inspector}</td>`;
            allDays.forEach((day,i) => {
                let count = rows.filter(r=>r.day===day).length;
                html += `<td>${count||''}</td>`;
                totals.days[i] += count;
            });
            let total = rows.length;
            let morning = rows.filter(r=>r.shift==="صباحية").length;
            let evening = rows.filter(r=>r.shift==="مسائية").length;
            let weekend = rows.filter(r=>{
                const dow = new Date(r.day).getDay();
                return [5,6,0].includes(dow);
            }).length;
            html += `<td>${total}</td><td>${morning}</td><td>${evening}</td><td>${weekend}</td></tr>`;
            totals.total += total; totals.morning += morning; totals.evening += evening; totals.weekend += weekend;
        });
        html += `<tr class="red-total">
            <td>الإجمالي</td>`;
        totals.days.forEach(sum=>html+=`<td>${sum}</td>`);
        html += `<td>${totals.total}</td><td>${totals.morning}</td><td>${totals.evening}</td><td>${totals.weekend}</td></tr>`;
        html += `</tbody></table>`;
        document.getElementById('monthlyReportContent').innerHTML = html;
        document.getElementById('monthlyReportModal').style.display = 'flex';
    }
    function closeMonthlyReportModal() {
        document.getElementById('monthlyReportModal').style.display = 'none';
    }
    // تصدير التقرير الشهري PDF
    function exportMonthlyReportToPDF() {
        let titleBox = document.getElementById('monthlyReportTitle');
        let table = document.getElementById("monthlyStatsTable");
        if (!table || !titleBox) return;
        let wrap = document.createElement('div');
        wrap.style.background = '#fff';
        wrap.style.padding = '18px';
        wrap.style.width = table.offsetWidth + 'px';
        let titleClone = titleBox.cloneNode(true);
        let tableClone = table.cloneNode(true);
        tableClone.style.marginTop = '10px';
        wrap.appendChild(titleClone);
        wrap.appendChild(tableClone);
        document.body.appendChild(wrap);

        html2canvas(wrap, {backgroundColor:'#fff', scale:2}).then(function(canvas){
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({orientation:"landscape",unit:"pt",format:"a4"});
            let pageWidth = doc.internal.pageSize.getWidth();
            let imgProps = doc.getImageProperties(imgData);
            let pdfWidth = pageWidth - 80;
            let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            doc.addImage(imgData, 'PNG', 40, 35, pdfWidth, pdfHeight);
            doc.save(`التقرير_الشهري.pdf`);
            document.body.removeChild(wrap);
        });
    }
    // تصدير التقرير الشهري Excel
    function exportMonthlyReportToExcel() {
        let table = document.getElementById("monthlyStatsTable");
        if (!table) return;
        let ws_data = [];
        for(let r of table.rows) {
            let row = [];
            for(let c of r.cells) row.push(c.textContent);
            ws_data.push(row);
        }
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "التقرير الشهري");
        XLSX.writeFile(wb, `التقرير_الشهري.xlsx`);
    }

    // بدء تحميل البيانات عند فتح الصفحة
    document.addEventListener('DOMContentLoaded', fetchPlanData);
</script>
</body>
</html>
